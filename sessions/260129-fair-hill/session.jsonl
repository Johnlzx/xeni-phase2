{"id":"260129-fair-hill","workspaceRootPath":"~/Documents/CosX/Xeni/Prototype/xeni-phase2","createdAt":1769669143247,"lastUsedAt":1769669284638,"name":"Map reference documents to checklist items","sdkSessionId":"abce4ddc-2b54-4d25-983b-08187e6b4c1c","isFlagged":false,"permissionMode":"allow-all","lastReadMessageId":"msg-1769669284118-uybnzj","sdkCwd":"~/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill","messageCount":82,"lastMessageRole":"assistant","preview":"现在聚焦在 Application 页面。当完成 case assessment 之后，每一个 checklist item 里边，我们来看一下 Application fields 旁边有一个 reference documents 的上传区域。我希望这个区域事先已经完成了映射。如果文件已经存在，","tokenUsage":{"inputTokens":74381,"outputTokens":6171,"totalTokens":80552,"contextTokens":0,"costUsd":0.8069885,"cacheReadTokens":74191,"cacheCreationTokens":189,"contextWindow":200000},"lastFinalMessageId":"msg-1769669284118-uybnzj"}
{"id":"msg-1769668513945-xmj62z","type":"user","content":"现在聚焦在 Application 页面。当完成 case assessment 之后，每一个 checklist item 里边，我们来看一下 Application fields 旁边有一个 reference documents 的上传区域。我希望这个区域事先已经完成了映射。如果文件已经存在，那么对应 item 的参考文件就应该出现在这里。如果文件不存在，那么这里显示的就会是对应文件的一个 slot [skill:013c1d74-c1fd-de8c-aafe-bc07fdc3911b:ui-ux-pro-max]","timestamp":1769668513945,"badges":[{"type":"skill","label":"UI UX Pro Max","rawText":"[skill:013c1d74-c1fd-de8c-aafe-bc07fdc3911b:ui-ux-pro-max]","start":205,"end":263}]}
{"id":"msg-1769668523385-leq3rh","type":"tool","content":"Error: Unknown skill: xeni-phase2:ui-ux-pro-max","timestamp":1769668523385,"toolName":"Skill","toolUseId":"toolu_019FHezoP6jSMo7fmKdfhaSf","toolInput":{"skill":"xeni-phase2:ui-ux-pro-max"},"toolResult":"Error: Unknown skill: xeni-phase2:ui-ux-pro-max","toolStatus":"completed","toolDisplayMeta":{"displayName":"UI UX Pro Max","description":"AI-powered design intelligence for building professional UI/UX. Generates complete design systems with style, color, typography, and layout recommendations across multiple platforms and frameworks.","category":"skill"},"isError":true,"turnId":"msg_015VmKU2cstwLiVN7oF5ae5n"}
{"id":"msg-1769668527612-fkn39n","type":"tool","content":"Error: Unknown skill: ui-ux-pro-max","timestamp":1769668527612,"toolName":"Skill","toolUseId":"toolu_01M8ViNdYYhE4daCsujPbJv8","toolInput":{"skill":"ui-ux-pro-max"},"toolResult":"Error: Unknown skill: ui-ux-pro-max","toolStatus":"completed","toolDisplayMeta":{"displayName":"UI UX Pro Max","description":"AI-powered design intelligence for building professional UI/UX. Generates complete design systems with style, color, typography, and layout recommendations across multiple platforms and frameworks.","category":"skill"},"isError":true,"turnId":"msg_01VSAqqb7Rk6PmjcJrcAZnh6"}
{"id":"msg-1769668533972-o48ppx","type":"tool","content":"{\n  \"status\": \"completed\",\n  \"prompt\": \"Explore the Application page and checklist item implementation in the xeni-phase2 codebase. I need to understand:\\n\\n1. The structure of the Application page (look in ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application)\\n2. How checklist items are rendered, particularly the \\\"reference documents\\\" upload area\\n3. The data model for checklist items and their associated documents\\n4. How documents are currently mapped to checklist items\\n\\nFocus on finding:\\n- ChecklistDetailPanel or similar component\\n- Reference documents section implementation\\n- Document mapping/linking logic\\n- The store (case-detail-store.ts) for document state\\n\\nBe thorough - this is for implementing a feature where reference docs should auto-populate from mapped files after assessment.\",\n  \"agentId\": \"a4f3e2b\",\n  \"content\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"Perfect! Now I have a comprehensive understanding of the codebase. Let me create a detailed analysis report.\\n\\n## Exploration Complete - Application Page & Checklist Implementation Analysis\\n\\nI've thoroughly explored the xeni-phase2 codebase and have a complete understanding of the Application page and checklist implementation. Here's my comprehensive findings:\\n\\n---\\n\\n## 1. APPLICATION PAGE STRUCTURE\\n\\n**File**: `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application`\\n\\n### Main Components:\\n- **ApplicationPage.tsx** - Entry point for the application workspace\\n- **ChecklistWorkspace.tsx** - Main layout with left sidebar (sections) + right detail panel\\n- **ApplicationLandingPage.tsx** - Initial assessment form interface\\n- **CaseAssessmentForm.tsx** - Form for assessment-specific logic\\n\\n### Architecture:\\n```\\nChecklistWorkspace\\n├── WorkspaceHeader (progress, issue counts, \\\"Launch Form Pilot\\\" button)\\n├── Left: ChecklistSidebar (section list with item counts, issue badges)\\n└── Right: ChecklistDetailPanel or EmptyDetailPanel\\n```\\n\\n---\\n\\n## 2. CHECKLIST ITEM RENDERING & DATA MODEL\\n\\n### Core Data Types (types/case-detail.ts):\\n\\n**EnhancedChecklistItem** (Primary data model):\\n```typescript\\n{\\n  id: string;\\n  section: ChecklistSectionType; // \\\"personal\\\" | \\\"employment\\\" | \\\"financial\\\" | \\\"travel\\\" | \\\"education\\\" | \\\"family\\\" | \\\"other\\\"\\n  field: string;\\n  label: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  linkedDocuments: LinkedDocument[]; // Source documents for extraction\\n  requiredEvidence: RequiredEvidence[]; // Documents needed for visa submission\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"missing\\\";\\n  isRequired: boolean;\\n  isEditable: boolean;\\n  confidenceScore?: number; // 0-100 for extracted values\\n}\\n```\\n\\n**LinkedDocument** (Source documents for data extraction):\\n```typescript\\n{\\n  fileId: string;\\n  fileName: string;\\n  groupTitle: string;\\n  pageNumbers: number[];\\n  extractedText?: string;\\n  thumbnailUrl?: string;\\n}\\n```\\n\\n**RequiredEvidence** (Documents needed for visa submission):\\n```typescript\\n{\\n  id: string;\\n  name: string;\\n  description?: string;\\n  isUploaded: boolean;\\n  linkedFileId?: string; // Reference to document group\\n  linkedFileName?: string;\\n  isMandatory: boolean;\\n  acceptedFormats?: string[];\\n  validityPeriod?: string;\\n}\\n```\\n\\n---\\n\\n## 3. REFERENCE DOCUMENTS UPLOAD AREA\\n\\n### Location:\\n**OverviewTab.tsx** - Shows \\\"Reference Documents\\\" section at top of the Overview tab\\n\\n### Components:\\n1. **SummaryFieldsCard** - Main card showing:\\n   - Progress ring (completion %)\\n   - \\\"Application Fields\\\" title\\n   - \\\"Reference Documents\\\" section with horizontal scroll area\\n   - Uploaded document pills showing file names\\n   - \\\"Add\\\" button to upload more documents\\n   - Editable field list below\\n\\n2. **ReferenceDocItem** - Individual document button component showing:\\n   - FileText icon\\n   - Document name (truncated)\\n   - \\\"Time ago\\\" when analyzed\\n\\n3. **Key Feature**: Auto-analysis trigger when reference docs uploaded\\n   ```typescript\\n   // From OverviewTab.tsx (line 1217-1224)\\n   useEffect(() => {\\n     if (prevRefUploadedRef.current !== null && refUploaded > prevRefUploadedRef.current) {\\n       handleAnalyze(); // Auto-trigger analysis\\n     }\\n     prevRefUploadedRef.current = refUploaded;\\n   }, [refUploaded]);\\n   ```\\n\\n---\\n\\n## 4. DOCUMENT MAPPING & LINKING LOGIC\\n\\n### Store Actions (case-detail-store.ts):\\n\\n**uploadForEvidence** (line 2080):\\n- Creates new file in allFiles + document group if needed\\n- Updates enhancedChecklistItems with `linkedFileId` and `linkedFileName`\\n- Marks related issue as \\\"resolved\\\"\\n- Uses file matching: `group.title` normalized vs `evidenceName` normalized\\n\\n**linkEvidenceToGroup** (line 2187):\\n- Links evidence to existing document group from File Hub\\n- Updates `linkedFileId` to group ID\\n- Updates `linkedFileName` to group title\\n- Marks related issue as \\\"resolved\\\"\\n\\n**unlinkEvidence** (line 2232):\\n- Resets evidence to unlinked state\\n- Clears `linkedFileId` and `linkedFileName`\\n\\n### Data Flow:\\n```\\nEvidence Card (SupportingDocumentsTab)\\n        ↓\\nlinkEvidenceToGroup(evidenceId, groupId)\\n        ↓\\nStore updates enhancedChecklistItems[i].requiredEvidence[j]\\n  {\\n    ...ev,\\n    isUploaded: true,\\n    linkedFileId: groupId,\\n    linkedFileName: targetGroup.title\\n  }\\n```\\n\\n---\\n\\n## 5. CHECKLIST DETAIL PANEL COMPONENT\\n\\n**File**: `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/ChecklistDetailPanel.tsx`\\n\\n### Three-Tab Interface (via ItemDetailTabs):\\n\\n1. **Overview Tab** (OverviewTab.tsx):\\n   - 2:1 grid layout (Application Fields : Supporting Documents)\\n   - Reference documents section with auto-analysis\\n   - Field editing with pending changes\\n   - Supports for checklist + assessment items\\n\\n2. **Details Tab** (DetailsTab.tsx):\\n   - Full field list with source badges\\n   - Filtering by source: \\\"Missing\\\", \\\"AI Extracted\\\", \\\"Manual Entry\\\", \\\"Questionnaire\\\", \\\"Needs Review\\\"\\n   - Clickable source badges to preview linked documents\\n   - Direct field editing with save/cancel footer\\n\\n3. **Supporting Documents Tab** (SupportingDocumentsTab.tsx):\\n   - All required evidence displayed as cards\\n   - Drag & drop support\\n   - Evidence cards with upload/link options\\n   - Combined evidence groups (e.g., \\\"Financial Evidence\\\": Bank Statements OR Payslip with \\\"any\\\" relationship)\\n   - Mandatory vs Optional sections\\n\\n### Key Features:\\n- **Filter System**: Multi-select filters by data source and completion status\\n- **Source Badges**: Clickable badges showing extraction source with confidence score\\n- **Modal Previews**: Click source badge → opens CategoryReviewModal with document preview\\n- **Responsive Layout**: Switches between tabbed (employment) and breadcrumb (other sections) navigation\\n\\n---\\n\\n## 6. STORE (case-detail-store.ts) - KEY SELECTORS & LOGIC\\n\\n### Selectors:\\n```typescript\\nuseEnhancedChecklistItems() // All checklist items\\nuseEnhancedQualityIssues() // All quality issues\\nuseDocumentGroups() // All document groups with resolved files\\nuseIssueCounts() // Error/warning/info counts\\n```\\n\\n### Generation Logic - generateEnhancedChecklist (line 3879):\\n\\n**Section-based Required Evidence Config**:\\n```typescript\\nSECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n  personal: [passport, photo, previous_passports],\\n  employment: [CoS, employment_contract, sponsor_letter],\\n  financial: [bank_statements, payslip],\\n  travel: [travel_history, old_visas],\\n  education: [english_cert, degree_cert, atas],\\n  family: [marriage_cert, birth_certs],\\n  other: [],\\n}\\n```\\n\\n**Conversion Flow**:\\n1. Maps applicationChecklistItems → enhancedChecklistItems\\n2. Converts linkedFileIds → LinkedDocument[] via createLinkedDocument()\\n3. Assigns requiredEvidence by section type\\n4. Auto-populates passport into personal.requiredEvidence if exists\\n5. Creates issues for missing fields + missing required evidence\\n\\n---\\n\\n## 7. AUTO-POPULATE FEATURE OPPORTUNITY\\n\\n### Current Implementation (OverviewTab.tsx lines 1176-1215):\\n\\nEvidence is manually uploaded OR linked from File Hub. After linking:\\n1. User clicks \\\"Add\\\" button in Reference Documents area\\n2. Selects from File Hub OR uploads new\\n3. linkEvidenceToGroup() updates evidence.isUploaded\\n4. Evidence card shows as \\\"Ready\\\" (if reviewed) or \\\"Pending Review\\\"\\n\\n### AUTO-POPULATE AFTER ASSESSMENT:\\n\\n**Trigger Point**: After assessment questionnaire completes → generateEnhancedChecklist() called\\n\\n**Current Gap**: \\n- Passport automatically linked IF exists in documentGroups (line 3913-3914)\\n- Other evidence requires manual upload/linking\\n\\n**Implementation Strategy for Auto-Populate**:\\n1. In generateEnhancedChecklist(), after creating requiredEvidence items\\n2. Check state.documentGroups for matching titles\\n3. Auto-link using evidence.linkedFileId = group.id\\n4. Set isUploaded = true, linkedFileName = group.title\\n5. This makes reference docs auto-appear in OverviewTab's reference documents section\\n\\n---\\n\\n## 8. KEY FILE PATHS - REFERENCE\\n\\n**Data Models & Types**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/types/case-detail.ts` - All type definitions\\n\\n**Store & State**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts` - Zustand store with all actions\\n\\n**Main Application Components**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/ApplicationPage.tsx` - Entry point\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/ChecklistWorkspace.tsx` - Main layout\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/ChecklistDetailPanel.tsx` - Detail panel\\n\\n**Tab Components**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` - Overview tab with reference docs\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/DetailsTab.tsx` - Details tab\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/SupportingDocumentsTab.tsx` - Evidence upload area\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/ItemDetailTabs.tsx` - Tab orchestration\\n\\n**Utilities**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/lib/document-path-parser.ts` - Path parsing for folder uploads\\n\\n---\\n\\n## 9. DATA FLOW SUMMARY\\n\\n```\\nAssessment Complete\\n        ↓\\ngenerateEnhancedChecklist()\\n        ↓\\nCreates EnhancedChecklistItem[] with:\\n  - requiredEvidence (all mandatory + optional for visa type)\\n  - linkedDocuments (from analyzed files)\\n        ↓\\nChecklistWorkspace displays sections\\n        ↓\\nUser clicks section → ChecklistDetailPanel shows:\\n  1. OverviewTab: Reference docs + field summary\\n  2. DetailsTab: All fields with sources\\n  3. SupportingDocumentsTab: Evidence requirements\\n        ↓\\nUser can:\\n  - Edit fields directly\\n  - Upload/link reference docs (for data extraction)\\n  - Upload/link supporting docs (for visa submission)\\n  - View source documents (click badge)\\n```\\n\\n---\\n\\n## 10. COMBINED EVIDENCE GROUPS (Special Feature)\\n\\n**File**: SupportingDocumentsTab.tsx (lines 27-70)\\n\\nExample config for Financial section:\\n```typescript\\n{\\n  groupId: \\\"financial-proof\\\",\\n  title: \\\"Financial Evidence\\\",\\n  relationship: \\\"any\\\", // One or the other\\n  evidenceIds: [\\\"ev_bank_statements\\\", \\\"ev_bank_letter\\\"]\\n}\\n```\\n\\nFor Employment:\\n```typescript\\n{\\n  groupId: \\\"employment-proof\\\",\\n  relationship: \\\"all\\\", // Both required\\n  evidenceIds: [\\\"ev_cos\\\", \\\"ev_employment_contract\\\"]\\n}\\n```\\n\\nComponents display these as grouped cards with connectors showing \\\"+\\\" (all) or \\\"or\\\" (any).\\n\\n---\\n\\nThis exploration covers the complete application and checklist implementation. The key insight for your auto-populate feature is that the store already has all the infrastructure (generateEnhancedChecklist, linkEvidenceToGroup actions) - you'll need to enhance the logic to automatically match and link reference documents when the enhanced checklist is first generated after assessment.\"\n    }\n  ],\n  \"totalDurationMs\": 72982,\n  \"totalTokens\": 95659,\n  \"totalToolUseCount\": 19,\n  \"usage\": {\n    \"input_tokens\": 4,\n    \"cache_creation_input_tokens\": 2034,\n    \"cache_read_input_tokens\": 93620,\n    \"cache_creation\": {\n      \"ephemeral_5m_input_tokens\": 2034,\n      \"ephemeral_1h_input_tokens\": 0\n    },\n    \"output_tokens\": 1,\n    \"service_tier\": \"standard\"\n  }\n}","timestamp":1769668533972,"toolName":"Task","toolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","toolInput":{"description":"Explore checklist reference docs","prompt":"Explore the Application page and checklist item implementation in the xeni-phase2 codebase. I need to understand:\n\n1. The structure of the Application page (look in ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application)\n2. How checklist items are rendered, particularly the \"reference documents\" upload area\n3. The data model for checklist items and their associated documents\n4. How documents are currently mapped to checklist items\n\nFocus on finding:\n- ChecklistDetailPanel or similar component\n- Reference documents section implementation\n- Document mapping/linking logic\n- The store (case-detail-store.ts) for document state\n\nBe thorough - this is for implementing a feature where reference docs should auto-populate from mapped files after assessment.","subagent_type":"Explore"},"toolResult":"{\n  \"status\": \"completed\",\n  \"prompt\": \"Explore the Application page and checklist item implementation in the xeni-phase2 codebase. I need to understand:\\n\\n1. The structure of the Application page (look in ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application)\\n2. How checklist items are rendered, particularly the \\\"reference documents\\\" upload area\\n3. The data model for checklist items and their associated documents\\n4. How documents are currently mapped to checklist items\\n\\nFocus on finding:\\n- ChecklistDetailPanel or similar component\\n- Reference documents section implementation\\n- Document mapping/linking logic\\n- The store (case-detail-store.ts) for document state\\n\\nBe thorough - this is for implementing a feature where reference docs should auto-populate from mapped files after assessment.\",\n  \"agentId\": \"a4f3e2b\",\n  \"content\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"Perfect! Now I have a comprehensive understanding of the codebase. Let me create a detailed analysis report.\\n\\n## Exploration Complete - Application Page & Checklist Implementation Analysis\\n\\nI've thoroughly explored the xeni-phase2 codebase and have a complete understanding of the Application page and checklist implementation. Here's my comprehensive findings:\\n\\n---\\n\\n## 1. APPLICATION PAGE STRUCTURE\\n\\n**File**: `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application`\\n\\n### Main Components:\\n- **ApplicationPage.tsx** - Entry point for the application workspace\\n- **ChecklistWorkspace.tsx** - Main layout with left sidebar (sections) + right detail panel\\n- **ApplicationLandingPage.tsx** - Initial assessment form interface\\n- **CaseAssessmentForm.tsx** - Form for assessment-specific logic\\n\\n### Architecture:\\n```\\nChecklistWorkspace\\n├── WorkspaceHeader (progress, issue counts, \\\"Launch Form Pilot\\\" button)\\n├── Left: ChecklistSidebar (section list with item counts, issue badges)\\n└── Right: ChecklistDetailPanel or EmptyDetailPanel\\n```\\n\\n---\\n\\n## 2. CHECKLIST ITEM RENDERING & DATA MODEL\\n\\n### Core Data Types (types/case-detail.ts):\\n\\n**EnhancedChecklistItem** (Primary data model):\\n```typescript\\n{\\n  id: string;\\n  section: ChecklistSectionType; // \\\"personal\\\" | \\\"employment\\\" | \\\"financial\\\" | \\\"travel\\\" | \\\"education\\\" | \\\"family\\\" | \\\"other\\\"\\n  field: string;\\n  label: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  linkedDocuments: LinkedDocument[]; // Source documents for extraction\\n  requiredEvidence: RequiredEvidence[]; // Documents needed for visa submission\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"missing\\\";\\n  isRequired: boolean;\\n  isEditable: boolean;\\n  confidenceScore?: number; // 0-100 for extracted values\\n}\\n```\\n\\n**LinkedDocument** (Source documents for data extraction):\\n```typescript\\n{\\n  fileId: string;\\n  fileName: string;\\n  groupTitle: string;\\n  pageNumbers: number[];\\n  extractedText?: string;\\n  thumbnailUrl?: string;\\n}\\n```\\n\\n**RequiredEvidence** (Documents needed for visa submission):\\n```typescript\\n{\\n  id: string;\\n  name: string;\\n  description?: string;\\n  isUploaded: boolean;\\n  linkedFileId?: string; // Reference to document group\\n  linkedFileName?: string;\\n  isMandatory: boolean;\\n  acceptedFormats?: string[];\\n  validityPeriod?: string;\\n}\\n```\\n\\n---\\n\\n## 3. REFERENCE DOCUMENTS UPLOAD AREA\\n\\n### Location:\\n**OverviewTab.tsx** - Shows \\\"Reference Documents\\\" section at top of the Overview tab\\n\\n### Components:\\n1. **SummaryFieldsCard** - Main card showing:\\n   - Progress ring (completion %)\\n   - \\\"Application Fields\\\" title\\n   - \\\"Reference Documents\\\" section with horizontal scroll area\\n   - Uploaded document pills showing file names\\n   - \\\"Add\\\" button to upload more documents\\n   - Editable field list below\\n\\n2. **ReferenceDocItem** - Individual document button component showing:\\n   - FileText icon\\n   - Document name (truncated)\\n   - \\\"Time ago\\\" when analyzed\\n\\n3. **Key Feature**: Auto-analysis trigger when reference docs uploaded\\n   ```typescript\\n   // From OverviewTab.tsx (line 1217-1224)\\n   useEffect(() => {\\n     if (prevRefUploadedRef.current !== null && refUploaded > prevRefUploadedRef.current) {\\n       handleAnalyze(); // Auto-trigger analysis\\n     }\\n     prevRefUploadedRef.current = refUploaded;\\n   }, [refUploaded]);\\n   ```\\n\\n---\\n\\n## 4. DOCUMENT MAPPING & LINKING LOGIC\\n\\n### Store Actions (case-detail-store.ts):\\n\\n**uploadForEvidence** (line 2080):\\n- Creates new file in allFiles + document group if needed\\n- Updates enhancedChecklistItems with `linkedFileId` and `linkedFileName`\\n- Marks related issue as \\\"resolved\\\"\\n- Uses file matching: `group.title` normalized vs `evidenceName` normalized\\n\\n**linkEvidenceToGroup** (line 2187):\\n- Links evidence to existing document group from File Hub\\n- Updates `linkedFileId` to group ID\\n- Updates `linkedFileName` to group title\\n- Marks related issue as \\\"resolved\\\"\\n\\n**unlinkEvidence** (line 2232):\\n- Resets evidence to unlinked state\\n- Clears `linkedFileId` and `linkedFileName`\\n\\n### Data Flow:\\n```\\nEvidence Card (SupportingDocumentsTab)\\n        ↓\\nlinkEvidenceToGroup(evidenceId, groupId)\\n        ↓\\nStore updates enhancedChecklistItems[i].requiredEvidence[j]\\n  {\\n    ...ev,\\n    isUploaded: true,\\n    linkedFileId: groupId,\\n    linkedFileName: targetGroup.title\\n  }\\n```\\n\\n---\\n\\n## 5. CHECKLIST DETAIL PANEL COMPONENT\\n\\n**File**: `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/ChecklistDetailPanel.tsx`\\n\\n### Three-Tab Interface (via ItemDetailTabs):\\n\\n1. **Overview Tab** (OverviewTab.tsx):\\n   - 2:1 grid layout (Application Fields : Supporting Documents)\\n   - Reference documents section with auto-analysis\\n   - Field editing with pending changes\\n   - Supports for checklist + assessment items\\n\\n2. **Details Tab** (DetailsTab.tsx):\\n   - Full field list with source badges\\n   - Filtering by source: \\\"Missing\\\", \\\"AI Extracted\\\", \\\"Manual Entry\\\", \\\"Questionnaire\\\", \\\"Needs Review\\\"\\n   - Clickable source badges to preview linked documents\\n   - Direct field editing with save/cancel footer\\n\\n3. **Supporting Documents Tab** (SupportingDocumentsTab.tsx):\\n   - All required evidence displayed as cards\\n   - Drag & drop support\\n   - Evidence cards with upload/link options\\n   - Combined evidence groups (e.g., \\\"Financial Evidence\\\": Bank Statements OR Payslip with \\\"any\\\" relationship)\\n   - Mandatory vs Optional sections\\n\\n### Key Features:\\n- **Filter System**: Multi-select filters by data source and completion status\\n- **Source Badges**: Clickable badges showing extraction source with confidence score\\n- **Modal Previews**: Click source badge → opens CategoryReviewModal with document preview\\n- **Responsive Layout**: Switches between tabbed (employment) and breadcrumb (other sections) navigation\\n\\n---\\n\\n## 6. STORE (case-detail-store.ts) - KEY SELECTORS & LOGIC\\n\\n### Selectors:\\n```typescript\\nuseEnhancedChecklistItems() // All checklist items\\nuseEnhancedQualityIssues() // All quality issues\\nuseDocumentGroups() // All document groups with resolved files\\nuseIssueCounts() // Error/warning/info counts\\n```\\n\\n### Generation Logic - generateEnhancedChecklist (line 3879):\\n\\n**Section-based Required Evidence Config**:\\n```typescript\\nSECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n  personal: [passport, photo, previous_passports],\\n  employment: [CoS, employment_contract, sponsor_letter],\\n  financial: [bank_statements, payslip],\\n  travel: [travel_history, old_visas],\\n  education: [english_cert, degree_cert, atas],\\n  family: [marriage_cert, birth_certs],\\n  other: [],\\n}\\n```\\n\\n**Conversion Flow**:\\n1. Maps applicationChecklistItems → enhancedChecklistItems\\n2. Converts linkedFileIds → LinkedDocument[] via createLinkedDocument()\\n3. Assigns requiredEvidence by section type\\n4. Auto-populates passport into personal.requiredEvidence if exists\\n5. Creates issues for missing fields + missing required evidence\\n\\n---\\n\\n## 7. AUTO-POPULATE FEATURE OPPORTUNITY\\n\\n### Current Implementation (OverviewTab.tsx lines 1176-1215):\\n\\nEvidence is manually uploaded OR linked from File Hub. After linking:\\n1. User clicks \\\"Add\\\" button in Reference Documents area\\n2. Selects from File Hub OR uploads new\\n3. linkEvidenceToGroup() updates evidence.isUploaded\\n4. Evidence card shows as \\\"Ready\\\" (if reviewed) or \\\"Pending Review\\\"\\n\\n### AUTO-POPULATE AFTER ASSESSMENT:\\n\\n**Trigger Point**: After assessment questionnaire completes → generateEnhancedChecklist() called\\n\\n**Current Gap**: \\n- Passport automatically linked IF exists in documentGroups (line 3913-3914)\\n- Other evidence requires manual upload/linking\\n\\n**Implementation Strategy for Auto-Populate**:\\n1. In generateEnhancedChecklist(), after creating requiredEvidence items\\n2. Check state.documentGroups for matching titles\\n3. Auto-link using evidence.linkedFileId = group.id\\n4. Set isUploaded = true, linkedFileName = group.title\\n5. This makes reference docs auto-appear in OverviewTab's reference documents section\\n\\n---\\n\\n## 8. KEY FILE PATHS - REFERENCE\\n\\n**Data Models & Types**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/types/case-detail.ts` - All type definitions\\n\\n**Store & State**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts` - Zustand store with all actions\\n\\n**Main Application Components**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/ApplicationPage.tsx` - Entry point\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/ChecklistWorkspace.tsx` - Main layout\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/ChecklistDetailPanel.tsx` - Detail panel\\n\\n**Tab Components**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` - Overview tab with reference docs\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/DetailsTab.tsx` - Details tab\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/SupportingDocumentsTab.tsx` - Evidence upload area\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/ItemDetailTabs.tsx` - Tab orchestration\\n\\n**Utilities**:\\n- `./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/lib/document-path-parser.ts` - Path parsing for folder uploads\\n\\n---\\n\\n## 9. DATA FLOW SUMMARY\\n\\n```\\nAssessment Complete\\n        ↓\\ngenerateEnhancedChecklist()\\n        ↓\\nCreates EnhancedChecklistItem[] with:\\n  - requiredEvidence (all mandatory + optional for visa type)\\n  - linkedDocuments (from analyzed files)\\n        ↓\\nChecklistWorkspace displays sections\\n        ↓\\nUser clicks section → ChecklistDetailPanel shows:\\n  1. OverviewTab: Reference docs + field summary\\n  2. DetailsTab: All fields with sources\\n  3. SupportingDocumentsTab: Evidence requirements\\n        ↓\\nUser can:\\n  - Edit fields directly\\n  - Upload/link reference docs (for data extraction)\\n  - Upload/link supporting docs (for visa submission)\\n  - View source documents (click badge)\\n```\\n\\n---\\n\\n## 10. COMBINED EVIDENCE GROUPS (Special Feature)\\n\\n**File**: SupportingDocumentsTab.tsx (lines 27-70)\\n\\nExample config for Financial section:\\n```typescript\\n{\\n  groupId: \\\"financial-proof\\\",\\n  title: \\\"Financial Evidence\\\",\\n  relationship: \\\"any\\\", // One or the other\\n  evidenceIds: [\\\"ev_bank_statements\\\", \\\"ev_bank_letter\\\"]\\n}\\n```\\n\\nFor Employment:\\n```typescript\\n{\\n  groupId: \\\"employment-proof\\\",\\n  relationship: \\\"all\\\", // Both required\\n  evidenceIds: [\\\"ev_cos\\\", \\\"ev_employment_contract\\\"]\\n}\\n```\\n\\nComponents display these as grouped cards with connectors showing \\\"+\\\" (all) or \\\"or\\\" (any).\\n\\n---\\n\\nThis exploration covers the complete application and checklist implementation. The key insight for your auto-populate feature is that the store already has all the infrastructure (generateEnhancedChecklist, linkEvidenceToGroup actions) - you'll need to enhance the logic to automatically match and link reference documents when the enhanced checklist is first generated after assessment.\"\n    }\n  ],\n  \"totalDurationMs\": 72982,\n  \"totalTokens\": 95659,\n  \"totalToolUseCount\": 19,\n  \"usage\": {\n    \"input_tokens\": 4,\n    \"cache_creation_input_tokens\": 2034,\n    \"cache_read_input_tokens\": 93620,\n    \"cache_creation\": {\n      \"ephemeral_5m_input_tokens\": 2034,\n      \"ephemeral_1h_input_tokens\": 0\n    },\n    \"output_tokens\": 1,\n    \"service_tier\": \"standard\"\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Agent","category":"native"},"isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668538508-s3yuys","type":"assistant","content":"让我先探索一下当前的代码结构，了解 Application 页面和 checklist item 的 reference documents 区域是如何实现的。","timestamp":1769668538508,"isIntermediate":true,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668541440-ymo95d","type":"tool","content":"Error: File content (39491 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","timestamp":1769668541440,"toolName":"Glob","toolUseId":"toolu_01PihQVBTZwV11UrECWcy8LW","toolInput":{"pattern":"**/components/case-detail/application/**/*.tsx","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2"},"toolResult":"Error: File content (39491 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","toolStatus":"completed","toolDisplayMeta":{"displayName":"Find Files","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":true,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668541655-rjhqy4","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"\\\"use client\\\";\\n\\nimport { useMemo, useState, useEffect, useRef, Fragment } from \\\"react\\\";\\nimport {\\n  CheckCircle2,\\n  FileText,\\n  Paperclip,\\n  Check,\\n  AlertTriangle,\\n  Plus,\\n  Sparkles,\\n  Upload,\\n  PenLine,\\n  Loader2,\\n} from \\\"lucide-react\\\";\\nimport { cn } from \\\"@/lib/utils\\\";\\nimport {\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  RequiredEvidence,\\n  DocumentGroup,\\n} from \\\"@/types/case-detail\\\";\\nimport { DocumentUploadModal } from \\\"./DocumentUploadModal\\\";\\nimport { CategoryReviewModal } from \\\"@/components/case-detail/shared/CategoryReviewModal\\\";\\nimport type { DetailTabId } from \\\"./ItemDetailTabs\\\";\\n\\n// Assessment field interface\\ninterface AssessmentField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  type: \\\"text\\\" | \\\"select\\\" | \\\"radio\\\";\\n  options?: { value: string; label: string }[];\\n  isRequired: boolean;\\n  isConditional?: boolean;\\n  dependsOn?: { fieldId: string; value: string };\\n  description?: string;\\n}\\n\\n// Field for display (includes both completed and missing)\\ninterface DisplayField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  sourceDocumentName?: string; // Name of the reference document this was extracted from\\n  status: \\\"complete\\\" | \\\"missing\\\" | \\\"low_confidence\\\";\\n  fieldType?: \\\"text\\\" | \\\"select\\\" | \\\"date\\\";\\n  options?: { value: string; label: string }[];\\n  confidenceScore?: number;\\n}\\n\\n// Props types\\ninterface ChecklistOverviewProps {\\n  itemType: \\\"checklist\\\";\\n  items: EnhancedChecklistItem[];\\n  issues: EnhancedQualityIssue[];\\n  formValues: Record<string, string>;\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\ninterface AssessmentOverviewProps {\\n  itemType: \\\"assessment\\\";\\n  fields: AssessmentField[];\\n  formValues: Record<string, string>;\\n  requiredEvidence: RequiredEvidence[];\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\nexport type OverviewTabProps = ChecklistOverviewProps | AssessmentOverviewProps;\\n\\n// ============================================================================\\n// Circular Progress Ring Component\\n// ============================================================================\\nfunction ProgressRing({\\n  percent,\\n  isComplete,\\n  size = 56,\\n}: {\\n  percent: number;\\n  isComplete: boolean;\\n  size?: number;\\n}) {\\n  const strokeWidth = 5;\\n  const radius = (size - strokeWidth) / 2;\\n  const circumference = 2 * Math.PI * radius;\\n  const strokeDashoffset = circumference - (percent / 100) * circumference;\\n\\n  return (\\n    <div className=\\\"relative shrink-0\\\" style={{ width: size, height: size }}>\\n      <svg className=\\\"-rotate-90\\\" width={size} height={size}>\\n        <circle\",\n    \"numLines\": 100,\n    \"startLine\": 1,\n    \"totalLines\": 1292\n  }\n}","timestamp":1769668541655,"toolName":"Glob","toolUseId":"toolu_01KYh4ikndgTsq7hMXk6xsMH","toolInput":{"pattern":"**/components/case-detail/application/**/*.ts","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2"},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"\\\"use client\\\";\\n\\nimport { useMemo, useState, useEffect, useRef, Fragment } from \\\"react\\\";\\nimport {\\n  CheckCircle2,\\n  FileText,\\n  Paperclip,\\n  Check,\\n  AlertTriangle,\\n  Plus,\\n  Sparkles,\\n  Upload,\\n  PenLine,\\n  Loader2,\\n} from \\\"lucide-react\\\";\\nimport { cn } from \\\"@/lib/utils\\\";\\nimport {\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  RequiredEvidence,\\n  DocumentGroup,\\n} from \\\"@/types/case-detail\\\";\\nimport { DocumentUploadModal } from \\\"./DocumentUploadModal\\\";\\nimport { CategoryReviewModal } from \\\"@/components/case-detail/shared/CategoryReviewModal\\\";\\nimport type { DetailTabId } from \\\"./ItemDetailTabs\\\";\\n\\n// Assessment field interface\\ninterface AssessmentField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  type: \\\"text\\\" | \\\"select\\\" | \\\"radio\\\";\\n  options?: { value: string; label: string }[];\\n  isRequired: boolean;\\n  isConditional?: boolean;\\n  dependsOn?: { fieldId: string; value: string };\\n  description?: string;\\n}\\n\\n// Field for display (includes both completed and missing)\\ninterface DisplayField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  sourceDocumentName?: string; // Name of the reference document this was extracted from\\n  status: \\\"complete\\\" | \\\"missing\\\" | \\\"low_confidence\\\";\\n  fieldType?: \\\"text\\\" | \\\"select\\\" | \\\"date\\\";\\n  options?: { value: string; label: string }[];\\n  confidenceScore?: number;\\n}\\n\\n// Props types\\ninterface ChecklistOverviewProps {\\n  itemType: \\\"checklist\\\";\\n  items: EnhancedChecklistItem[];\\n  issues: EnhancedQualityIssue[];\\n  formValues: Record<string, string>;\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\ninterface AssessmentOverviewProps {\\n  itemType: \\\"assessment\\\";\\n  fields: AssessmentField[];\\n  formValues: Record<string, string>;\\n  requiredEvidence: RequiredEvidence[];\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\nexport type OverviewTabProps = ChecklistOverviewProps | AssessmentOverviewProps;\\n\\n// ============================================================================\\n// Circular Progress Ring Component\\n// ============================================================================\\nfunction ProgressRing({\\n  percent,\\n  isComplete,\\n  size = 56,\\n}: {\\n  percent: number;\\n  isComplete: boolean;\\n  size?: number;\\n}) {\\n  const strokeWidth = 5;\\n  const radius = (size - strokeWidth) / 2;\\n  const circumference = 2 * Math.PI * radius;\\n  const strokeDashoffset = circumference - (percent / 100) * circumference;\\n\\n  return (\\n    <div className=\\\"relative shrink-0\\\" style={{ width: size, height: size }}>\\n      <svg className=\\\"-rotate-90\\\" width={size} height={size}>\\n        <circle\",\n    \"numLines\": 100,\n    \"startLine\": 1,\n    \"totalLines\": 1292\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Find Files","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668542062-v5irjg","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/types/case-detail.ts\",\n    \"content\": \"import { PassportInfo, VisaType } from \\\"./index\\\";\\n\\n// Navigation\\nexport type CaseDetailNavItem = \\\"overview\\\" | \\\"documents\\\" | \\\"application\\\";\\n\\n// Client Profile (progressively filled from documents)\\nexport interface ClientProfile {\\n  passport?: PassportInfo;\\n  contactInfo?: {\\n    email?: string;\\n    phone?: string;\\n    address?: string;\\n  };\\n  completeness: number; // 0-100\\n}\\n\\n// Case Team Member\\nexport interface CaseTeamMember {\\n  id: string;\\n  name: string;\\n  email?: string;\\n  avatar?: string;\\n}\\n\\n// Case Team\\nexport interface CaseTeam {\\n  lawyer: CaseTeamMember;\\n  assistant?: CaseTeamMember;\\n}\\n\\n// Checklist Evolution Stages\\nexport type ChecklistStage =\\n  | \\\"empty\\\" // No documents uploaded\\n  | \\\"questionnaire\\\" // Initial questions mode\\n  | \\\"partial\\\" // Some items resolved, mixed mode\\n  | \\\"detailed\\\"; // Full multi-step checklist\\n\\n// Checklist Item Status\\nexport type ChecklistItemStatus =\\n  | \\\"pending\\\"\\n  | \\\"in-progress\\\"\\n  | \\\"completed\\\"\\n  | \\\"blocked\\\";\\n\\n// Checklist Item\\nexport interface ChecklistItem {\\n  id: string;\\n  label: string;\\n  description?: string;\\n  status: ChecklistItemStatus;\\n  dependsOn?: string[];\\n  linkedDocuments?: string[];\\n  children?: ChecklistItem[];\\n  category?: string;\\n}\\n\\n// Questionnaire Question Types\\nexport type QuestionType =\\n  | \\\"boolean\\\"\\n  | \\\"single-choice\\\"\\n  | \\\"multi-choice\\\"\\n  | \\\"text\\\";\\n\\n// Questionnaire Question\\nexport interface QuestionnaireQuestion {\\n  id: string;\\n  question: string;\\n  questionZh?: string;\\n  type: QuestionType;\\n  options?: { value: string; label: string }[];\\n  answer?: unknown;\\n  dependsOn?: { questionId: string; value: unknown };\\n}\\n\\n// Checklist State\\nexport interface ChecklistState {\\n  stage: ChecklistStage;\\n  questions: QuestionnaireQuestion[];\\n  items: ChecklistItem[];\\n  progress: {\\n    completed: number;\\n    total: number;\\n  };\\n}\\n\\n// Uploaded File Preview (compact view for Overview)\\nexport interface UploadedFilePreview {\\n  id: string;\\n  name: string;\\n  type: string;\\n  thumbnailUrl?: string;\\n  groupId?: string;\\n}\\n\\n// Entity type for document ownership attribution\\nexport type DocumentEntityType = 'applicant' | 'sponsor' | 'dependant' | 'shared' | 'unknown';\\n\\n// Source of how a file was added to a container\\nexport type FileAssociationSource = 'upload' | 'assign' | 'reuse';\\n\\n// Document File (for Documents page)\\n// Files are stored centrally in allFiles, containers only hold references\\nexport interface DocumentFile {\\n  id: string;\\n  name: string;\\n  size: string;\\n  pages?: number;\\n  date?: string;\\n  type: \\\"pdf\\\" | \\\"doc\\\";\\n  isNew?: boolean;\\n  isRemoved?: boolean; // Soft delete for the entire file\\n  // Analysis tracking\\n  isAnalyzed?: boolean;\\n  analyzedAt?: string;\\n  // One-to-Many: Array of container IDs this file is associated with\\n  // Empty array = Unclassified (not in any container)\\n  containerIds: string[];\\n  // Folder upload metadata (for entity attribution)\\n  relativePath?: string; // Original path from folder upload (e.g., \\\"Case_2024/Applicant_John/Identity/\\\")\\n  entityType?: DocumentEntityType; // Detected entity type from path\\n}\\n\\n// Document Group (Container)\\n// Containers hold references to files via fileIds, not the files themselves\\n// The `files` property is resolved by selectors for backward compatibility with UI components\\nexport interface DocumentGroup {\\n  id: string;\\n  title: string;\\n  tag: string;\\n  mergedFileName?: string;\\n  status: \\\"pending\\\" | \\\"reviewed\\\";\\n  hasChanges?: boolean;\\n  // Reference-based: array of file IDs in this container (source of truth)\\n  fileIds: string[];\\n  // Resolved files - populated by useDocumentGroups selector for backward compatibility\\n  // In the store, this may be an empty array. Selectors resolve it from allFiles + fileIds.\\n  files: DocumentFile[];\\n  isSpecial?: boolean; // Special documents like Case Notes - auto-confirmed, no review needed\\n  // Folder upload metadata\\n  entityType?: DocumentEntityType; // Entity this document belongs to (from folder path)\\n  generatedName?: string; // Auto-generated name following convention: who_documentType_date\\n}\\n\\n// Application Phase (4-stage state machine)\\n// Note: Visa type is now selected at case creation, so \\\"landing\\\" stage is removed\\nexport type ApplicationPhase =\\n  | \\\"analyzing\\\" // Document analysis in progress (includes Gap Analysis)\\n  | \\\"questionnaire\\\" // Quick questionnaire\\n  | \\\"checklist\\\" // Main checklist interface\\n  | \\\"form_pilot\\\"; // Form Pilot launch screen\",\n    \"numLines\": 150,\n    \"startLine\": 1,\n    \"totalLines\": 606\n  }\n}","timestamp":1769668542062,"toolName":"Read","toolUseId":"toolu_018RFTXSCVncSY2a79DsiRfD","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts"},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/types/case-detail.ts\",\n    \"content\": \"import { PassportInfo, VisaType } from \\\"./index\\\";\\n\\n// Navigation\\nexport type CaseDetailNavItem = \\\"overview\\\" | \\\"documents\\\" | \\\"application\\\";\\n\\n// Client Profile (progressively filled from documents)\\nexport interface ClientProfile {\\n  passport?: PassportInfo;\\n  contactInfo?: {\\n    email?: string;\\n    phone?: string;\\n    address?: string;\\n  };\\n  completeness: number; // 0-100\\n}\\n\\n// Case Team Member\\nexport interface CaseTeamMember {\\n  id: string;\\n  name: string;\\n  email?: string;\\n  avatar?: string;\\n}\\n\\n// Case Team\\nexport interface CaseTeam {\\n  lawyer: CaseTeamMember;\\n  assistant?: CaseTeamMember;\\n}\\n\\n// Checklist Evolution Stages\\nexport type ChecklistStage =\\n  | \\\"empty\\\" // No documents uploaded\\n  | \\\"questionnaire\\\" // Initial questions mode\\n  | \\\"partial\\\" // Some items resolved, mixed mode\\n  | \\\"detailed\\\"; // Full multi-step checklist\\n\\n// Checklist Item Status\\nexport type ChecklistItemStatus =\\n  | \\\"pending\\\"\\n  | \\\"in-progress\\\"\\n  | \\\"completed\\\"\\n  | \\\"blocked\\\";\\n\\n// Checklist Item\\nexport interface ChecklistItem {\\n  id: string;\\n  label: string;\\n  description?: string;\\n  status: ChecklistItemStatus;\\n  dependsOn?: string[];\\n  linkedDocuments?: string[];\\n  children?: ChecklistItem[];\\n  category?: string;\\n}\\n\\n// Questionnaire Question Types\\nexport type QuestionType =\\n  | \\\"boolean\\\"\\n  | \\\"single-choice\\\"\\n  | \\\"multi-choice\\\"\\n  | \\\"text\\\";\\n\\n// Questionnaire Question\\nexport interface QuestionnaireQuestion {\\n  id: string;\\n  question: string;\\n  questionZh?: string;\\n  type: QuestionType;\\n  options?: { value: string; label: string }[];\\n  answer?: unknown;\\n  dependsOn?: { questionId: string; value: unknown };\\n}\\n\\n// Checklist State\\nexport interface ChecklistState {\\n  stage: ChecklistStage;\\n  questions: QuestionnaireQuestion[];\\n  items: ChecklistItem[];\\n  progress: {\\n    completed: number;\\n    total: number;\\n  };\\n}\\n\\n// Uploaded File Preview (compact view for Overview)\\nexport interface UploadedFilePreview {\\n  id: string;\\n  name: string;\\n  type: string;\\n  thumbnailUrl?: string;\\n  groupId?: string;\\n}\\n\\n// Entity type for document ownership attribution\\nexport type DocumentEntityType = 'applicant' | 'sponsor' | 'dependant' | 'shared' | 'unknown';\\n\\n// Source of how a file was added to a container\\nexport type FileAssociationSource = 'upload' | 'assign' | 'reuse';\\n\\n// Document File (for Documents page)\\n// Files are stored centrally in allFiles, containers only hold references\\nexport interface DocumentFile {\\n  id: string;\\n  name: string;\\n  size: string;\\n  pages?: number;\\n  date?: string;\\n  type: \\\"pdf\\\" | \\\"doc\\\";\\n  isNew?: boolean;\\n  isRemoved?: boolean; // Soft delete for the entire file\\n  // Analysis tracking\\n  isAnalyzed?: boolean;\\n  analyzedAt?: string;\\n  // One-to-Many: Array of container IDs this file is associated with\\n  // Empty array = Unclassified (not in any container)\\n  containerIds: string[];\\n  // Folder upload metadata (for entity attribution)\\n  relativePath?: string; // Original path from folder upload (e.g., \\\"Case_2024/Applicant_John/Identity/\\\")\\n  entityType?: DocumentEntityType; // Detected entity type from path\\n}\\n\\n// Document Group (Container)\\n// Containers hold references to files via fileIds, not the files themselves\\n// The `files` property is resolved by selectors for backward compatibility with UI components\\nexport interface DocumentGroup {\\n  id: string;\\n  title: string;\\n  tag: string;\\n  mergedFileName?: string;\\n  status: \\\"pending\\\" | \\\"reviewed\\\";\\n  hasChanges?: boolean;\\n  // Reference-based: array of file IDs in this container (source of truth)\\n  fileIds: string[];\\n  // Resolved files - populated by useDocumentGroups selector for backward compatibility\\n  // In the store, this may be an empty array. Selectors resolve it from allFiles + fileIds.\\n  files: DocumentFile[];\\n  isSpecial?: boolean; // Special documents like Case Notes - auto-confirmed, no review needed\\n  // Folder upload metadata\\n  entityType?: DocumentEntityType; // Entity this document belongs to (from folder path)\\n  generatedName?: string; // Auto-generated name following convention: who_documentType_date\\n}\\n\\n// Application Phase (4-stage state machine)\\n// Note: Visa type is now selected at case creation, so \\\"landing\\\" stage is removed\\nexport type ApplicationPhase =\\n  | \\\"analyzing\\\" // Document analysis in progress (includes Gap Analysis)\\n  | \\\"questionnaire\\\" // Quick questionnaire\\n  | \\\"checklist\\\" // Main checklist interface\\n  | \\\"form_pilot\\\"; // Form Pilot launch screen\",\n    \"numLines\": 150,\n    \"startLine\": 1,\n    \"totalLines\": 606\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668542246-fwearx","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          className=\\\"text-stone-200\\\"\\n        />\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          strokeLinecap=\\\"round\\\"\\n          strokeDasharray={circumference}\\n          strokeDashoffset={strokeDashoffset}\\n          className={isComplete ? \\\"text-emerald-500\\\" : \\\"text-amber-500\\\"}\\n        />\\n      </svg>\\n      <div className=\\\"absolute inset-0 flex items-center justify-center\\\">\\n        {isComplete ? (\\n          <CheckCircle2 className=\\\"size-6 text-emerald-500\\\" />\\n        ) : (\\n          <span className=\\\"text-sm font-bold text-stone-700 tabular-nums\\\">{percent}%</span>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Reference Document Item - Shows doc name and analysis time\\n// ============================================================================\\nfunction ReferenceDocItem({\\n  evidence,\\n  analyzedAt,\\n  onClick,\\n}: {\\n  evidence: RequiredEvidence;\\n  analyzedAt?: string;\\n  onClick: () => void;\\n}) {\\n  const displayName = evidence.name.length > 14 ? evidence.name.slice(0, 14) + \\\"...\\\" : evidence.name;\\n\\n  // Format time ago\\n  const getTimeAgo = (dateStr?: string) => {\\n    if (!dateStr) return null;\\n    // For demo, just show a static time\\n    return \\\"2h ago\\\";\\n  };\\n\\n  return (\\n    <button\\n      onClick={onClick}\\n      className=\\\"w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-left hover:bg-stone-100 transition-colors\\\"\\n    >\\n      <FileText className=\\\"size-3.5 text-blue-500 shrink-0\\\" />\\n      <span className=\\\"text-xs font-medium text-stone-700 truncate flex-1\\\">\\n        {displayName}\\n      </span>\\n      {analyzedAt && (\\n        <span className=\\\"text-[10px] text-stone-400 shrink-0\\\">\\n          {getTimeAgo(analyzedAt)}\\n        </span>\\n      )}\\n    </button>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Summary + Fields Card Component\\n// ============================================================================\\nfunction SummaryFieldsCard({\\n  status,\\n  totalFields,\\n  completedFields,\\n  fields,\\n  formValues,\\n  referenceEvidence,\\n  isAnalyzing,\\n  onFieldChange,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  referenceEvidence: RequiredEvidence[];\\n  isAnalyzing: boolean;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const [pendingChanges, setPendingChanges] = useState<Record<string, string>>({});\\n  const [manuallyEditedFields, setManuallyEditedFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\n\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  // Check if there are pending changes\\n  const pendingFieldIds = Object.keys(pendingChanges).filter(\\n    (id) => pendingChanges[id] && pendingChanges[id].trim() !== \\\"\\\"\\n  );\\n  const hasPendingChanges = pendingFieldIds.length > 0;\\n\\n  // Handle local field change (store in pending, don't submit yet)\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    setPendingChanges((prev) => ({ ...prev, [fieldId]: value }));\\n    setManuallyEditedFields((prev) => new Set(prev).add(fieldId));\\n  };\\n\\n  // Submit all pending changes\\n  const handleSubmit = async () => {\\n    if (!hasPendingChanges) return;\\n    setIsSubmitting(true);\\n\\n    // Submit each pending change\\n    for (const fieldId of pendingFieldIds) {\\n      onFieldChange(fieldId, pendingChanges[fieldId]);\\n    }\\n\\n    // Clear pending changes after a brief delay for animation\\n    setTimeout(() => {\\n      setPendingChanges({});\\n      setIsSubmitting(false);\\n    }, 500);\\n  };\\n\\n  // Cancel pending changes\\n  const handleCancel = () => {\\n    setPendingChanges({});\\n    setManuallyEditedFields(new Set());\\n  };\\n\\n  // Get source badge\\n  const getSourceBadge = (field: DisplayField) => {\\n    if (field.source === \\\"extracted\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center px-1.5 py-0.5 text-[9px] font-medium text-blue-700 bg-blue-50 rounded\\\">\\n          Extracted\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"manual\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n          <PenLine className=\\\"size-2\\\" />\\n          Manual\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"questionnaire\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-stone-600 bg-stone-100 rounded\\\">\\n          Questionnaire\\n        </span>\\n      );\\n    }\\n    return null;\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden flex flex-col flex-1 min-h-0\\\">\\n      {/* Header - Fixed height with Reference Documents */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-4\\\">\\n          {/* Left - Progress Summary */}\\n          <div className=\\\"shrink-0 flex items-center gap-3\\\">\\n            <ProgressRing percent={percent} isComplete={isComplete} size={48} />\\n            <div>\\n              <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Application Fields</h3>\\n              <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n                {completedFields} of {totalFields} completed\\n              </p>\\n            </div>\\n          </div>\\n\\n          {/* Divider */}\\n          <div className=\\\"w-px self-stretch bg-stone-200 shrink-0\\\" />\\n\\n          {/* Right - Reference Documents (vertical layout) */}\\n          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\",\n    \"numLines\": 200,\n    \"startLine\": 100,\n    \"totalLines\": 1292\n  }\n}","timestamp":1769668542246,"toolName":"Read","toolUseId":"toolu_01XEtwdEY8nhf8Tp8mN22s5K","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/types/case-detail.ts"},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          className=\\\"text-stone-200\\\"\\n        />\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          strokeLinecap=\\\"round\\\"\\n          strokeDasharray={circumference}\\n          strokeDashoffset={strokeDashoffset}\\n          className={isComplete ? \\\"text-emerald-500\\\" : \\\"text-amber-500\\\"}\\n        />\\n      </svg>\\n      <div className=\\\"absolute inset-0 flex items-center justify-center\\\">\\n        {isComplete ? (\\n          <CheckCircle2 className=\\\"size-6 text-emerald-500\\\" />\\n        ) : (\\n          <span className=\\\"text-sm font-bold text-stone-700 tabular-nums\\\">{percent}%</span>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Reference Document Item - Shows doc name and analysis time\\n// ============================================================================\\nfunction ReferenceDocItem({\\n  evidence,\\n  analyzedAt,\\n  onClick,\\n}: {\\n  evidence: RequiredEvidence;\\n  analyzedAt?: string;\\n  onClick: () => void;\\n}) {\\n  const displayName = evidence.name.length > 14 ? evidence.name.slice(0, 14) + \\\"...\\\" : evidence.name;\\n\\n  // Format time ago\\n  const getTimeAgo = (dateStr?: string) => {\\n    if (!dateStr) return null;\\n    // For demo, just show a static time\\n    return \\\"2h ago\\\";\\n  };\\n\\n  return (\\n    <button\\n      onClick={onClick}\\n      className=\\\"w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-left hover:bg-stone-100 transition-colors\\\"\\n    >\\n      <FileText className=\\\"size-3.5 text-blue-500 shrink-0\\\" />\\n      <span className=\\\"text-xs font-medium text-stone-700 truncate flex-1\\\">\\n        {displayName}\\n      </span>\\n      {analyzedAt && (\\n        <span className=\\\"text-[10px] text-stone-400 shrink-0\\\">\\n          {getTimeAgo(analyzedAt)}\\n        </span>\\n      )}\\n    </button>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Summary + Fields Card Component\\n// ============================================================================\\nfunction SummaryFieldsCard({\\n  status,\\n  totalFields,\\n  completedFields,\\n  fields,\\n  formValues,\\n  referenceEvidence,\\n  isAnalyzing,\\n  onFieldChange,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  referenceEvidence: RequiredEvidence[];\\n  isAnalyzing: boolean;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const [pendingChanges, setPendingChanges] = useState<Record<string, string>>({});\\n  const [manuallyEditedFields, setManuallyEditedFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\n\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  // Check if there are pending changes\\n  const pendingFieldIds = Object.keys(pendingChanges).filter(\\n    (id) => pendingChanges[id] && pendingChanges[id].trim() !== \\\"\\\"\\n  );\\n  const hasPendingChanges = pendingFieldIds.length > 0;\\n\\n  // Handle local field change (store in pending, don't submit yet)\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    setPendingChanges((prev) => ({ ...prev, [fieldId]: value }));\\n    setManuallyEditedFields((prev) => new Set(prev).add(fieldId));\\n  };\\n\\n  // Submit all pending changes\\n  const handleSubmit = async () => {\\n    if (!hasPendingChanges) return;\\n    setIsSubmitting(true);\\n\\n    // Submit each pending change\\n    for (const fieldId of pendingFieldIds) {\\n      onFieldChange(fieldId, pendingChanges[fieldId]);\\n    }\\n\\n    // Clear pending changes after a brief delay for animation\\n    setTimeout(() => {\\n      setPendingChanges({});\\n      setIsSubmitting(false);\\n    }, 500);\\n  };\\n\\n  // Cancel pending changes\\n  const handleCancel = () => {\\n    setPendingChanges({});\\n    setManuallyEditedFields(new Set());\\n  };\\n\\n  // Get source badge\\n  const getSourceBadge = (field: DisplayField) => {\\n    if (field.source === \\\"extracted\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center px-1.5 py-0.5 text-[9px] font-medium text-blue-700 bg-blue-50 rounded\\\">\\n          Extracted\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"manual\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n          <PenLine className=\\\"size-2\\\" />\\n          Manual\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"questionnaire\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-stone-600 bg-stone-100 rounded\\\">\\n          Questionnaire\\n        </span>\\n      );\\n    }\\n    return null;\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden flex flex-col flex-1 min-h-0\\\">\\n      {/* Header - Fixed height with Reference Documents */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-4\\\">\\n          {/* Left - Progress Summary */}\\n          <div className=\\\"shrink-0 flex items-center gap-3\\\">\\n            <ProgressRing percent={percent} isComplete={isComplete} size={48} />\\n            <div>\\n              <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Application Fields</h3>\\n              <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n                {completedFields} of {totalFields} completed\\n              </p>\\n            </div>\\n          </div>\\n\\n          {/* Divider */}\\n          <div className=\\\"w-px self-stretch bg-stone-200 shrink-0\\\" />\\n\\n          {/* Right - Reference Documents (vertical layout) */}\\n          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\",\n    \"numLines\": 200,\n    \"startLine\": 100,\n    \"totalLines\": 1292\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668546259-sd2ilt","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/types/case-detail.ts\",\n    \"content\": \"  | \\\"form_pilot\\\"; // Form Pilot launch screen\\n\\n// Checklist Section Types\\nexport type ChecklistSectionType =\\n  | \\\"personal\\\"\\n  | \\\"employment\\\"\\n  | \\\"financial\\\"\\n  | \\\"travel\\\"\\n  | \\\"education\\\"\\n  | \\\"family\\\"\\n  | \\\"other\\\";\\n\\n// Application Checklist Item (for the main Application checklist)\\nexport interface ApplicationChecklistItem {\\n  id: string;\\n  section: ChecklistSectionType;\\n  field: string; // Field key\\n  label: string; // Display label\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  linkedFileIds: string[]; // Associated source files\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"missing\\\";\\n  isRequired: boolean;\\n}\\n\\n// Quality Issue Types\\nexport type QualityIssueType = \\\"validity\\\" | \\\"clarity\\\" | \\\"consistency\\\" | \\\"missing\\\";\\nexport type QualityIssueSeverity = \\\"error\\\" | \\\"warning\\\" | \\\"info\\\";\\n\\n// Quality Issue (displayed inline with checklist items)\\nexport interface QualityIssue {\\n  id: string;\\n  type: QualityIssueType;\\n  severity: QualityIssueSeverity;\\n  title: string;\\n  description: string;\\n  linkedChecklistItemId: string; // Associated field ID\\n  linkedFileId?: string;\\n  isResolved: boolean;\\n}\\n\\n// ============================================\\n// Enhanced Issue Workflow Types\\n// ============================================\\n\\n// Issue Status - Full workflow support\\nexport type IssueStatus =\\n  | \\\"open\\\" // Newly identified\\n  | \\\"in_progress\\\" // Being worked on\\n  | \\\"forwarded\\\" // Sent to client\\n  | \\\"pending_review\\\" // Client responded, awaiting review\\n  | \\\"resolved\\\"; // Completed\\n\\n// Issue History Entry\\nexport interface IssueHistoryEntry {\\n  id: string;\\n  timestamp: string;\\n  action: \\\"created\\\" | \\\"note_added\\\" | \\\"forwarded\\\" | \\\"status_changed\\\" | \\\"resolved\\\";\\n  performedBy: {\\n    id: string;\\n    name: string;\\n  };\\n  details?: string;\\n  previousStatus?: IssueStatus;\\n  newStatus?: IssueStatus;\\n}\\n\\n// Issue Note\\nexport interface IssueNote {\\n  id: string;\\n  content: string;\\n  createdAt: string;\\n  createdBy: {\\n    id: string;\\n    name: string;\\n  };\\n}\\n\\n// Forward to Client Data\\nexport interface ForwardToClientData {\\n  method: \\\"link\\\" | \\\"email\\\";\\n  recipientEmail?: string;\\n  message?: string;\\n  shareableLink?: string;\\n  expiresAt?: string;\\n  sentAt: string;\\n}\\n\\n// Enhanced Quality Issue (with full workflow support)\\nexport interface EnhancedQualityIssue {\\n  id: string;\\n  type: QualityIssueType;\\n  severity: QualityIssueSeverity;\\n  status: IssueStatus;\\n  title: string;\\n  description: string;\\n  suggestedAction?: string;\\n  linkedChecklistItemId: string;\\n  linkedFileIds: string[]; // Multiple source documents\\n  linkedPageNumbers?: Record<string, number[]>; // fileId -> page numbers\\n  history: IssueHistoryEntry[];\\n  forwardData?: ForwardToClientData;\\n  notes: IssueNote[];\\n  createdAt: string;\\n  updatedAt: string;\\n  resolvedAt?: string;\\n  resolvedBy?: {\\n    id: string;\\n    name: string;\\n  };\\n}\\n\\n// ============================================\\n// Enhanced Checklist Item Types\\n// ============================================\\n\\n// Linked Document Reference (source documents for data extraction)\\nexport interface LinkedDocument {\\n  fileId: string;\\n  fileName: string;\\n  groupTitle: string;\\n  pageNumbers: number[];\\n  extractedText?: string;\\n  thumbnailUrl?: string;\\n}\\n\\n// Required Evidence (documents needed for visa submission)\\nexport interface RequiredEvidence {\\n  id: string;\\n  name: string; // e.g., \\\"Valid Passport\\\", \\\"Bank Statements\\\"\\n  description?: string; // Detailed requirement\\n  isUploaded: boolean; // Whether the document has been uploaded\\n  linkedFileId?: string; // If uploaded, the file ID\\n  linkedFileName?: string; // If uploaded, the file name\\n  isMandatory: boolean; // Whether it's mandatory for the application\\n  acceptedFormats?: string[]; // e.g., [\\\"PDF\\\", \\\"JPEG\\\"]\\n  validityPeriod?: string; // e.g., \\\"Must be dated within 31 days\\\"\\n}\\n\\n// Enhanced Checklist Item (with document references)\\nexport interface EnhancedChecklistItem {\\n  id: string;\\n  section: ChecklistSectionType;\\n  field: string;\\n  label: string;\\n  description?: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  linkedDocuments: LinkedDocument[]; // Source documents (for extraction)\\n  requiredEvidence: RequiredEvidence[]; // Required evidence for submission\",\n    \"numLines\": 150,\n    \"startLine\": 150,\n    \"totalLines\": 606\n  }\n}","timestamp":1769668546259,"toolName":"Read","toolUseId":"toolu_01V3NF6E3rqvCvwwCK12q6bW","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","offset":1,"limit":200},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/types/case-detail.ts\",\n    \"content\": \"  | \\\"form_pilot\\\"; // Form Pilot launch screen\\n\\n// Checklist Section Types\\nexport type ChecklistSectionType =\\n  | \\\"personal\\\"\\n  | \\\"employment\\\"\\n  | \\\"financial\\\"\\n  | \\\"travel\\\"\\n  | \\\"education\\\"\\n  | \\\"family\\\"\\n  | \\\"other\\\";\\n\\n// Application Checklist Item (for the main Application checklist)\\nexport interface ApplicationChecklistItem {\\n  id: string;\\n  section: ChecklistSectionType;\\n  field: string; // Field key\\n  label: string; // Display label\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  linkedFileIds: string[]; // Associated source files\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"missing\\\";\\n  isRequired: boolean;\\n}\\n\\n// Quality Issue Types\\nexport type QualityIssueType = \\\"validity\\\" | \\\"clarity\\\" | \\\"consistency\\\" | \\\"missing\\\";\\nexport type QualityIssueSeverity = \\\"error\\\" | \\\"warning\\\" | \\\"info\\\";\\n\\n// Quality Issue (displayed inline with checklist items)\\nexport interface QualityIssue {\\n  id: string;\\n  type: QualityIssueType;\\n  severity: QualityIssueSeverity;\\n  title: string;\\n  description: string;\\n  linkedChecklistItemId: string; // Associated field ID\\n  linkedFileId?: string;\\n  isResolved: boolean;\\n}\\n\\n// ============================================\\n// Enhanced Issue Workflow Types\\n// ============================================\\n\\n// Issue Status - Full workflow support\\nexport type IssueStatus =\\n  | \\\"open\\\" // Newly identified\\n  | \\\"in_progress\\\" // Being worked on\\n  | \\\"forwarded\\\" // Sent to client\\n  | \\\"pending_review\\\" // Client responded, awaiting review\\n  | \\\"resolved\\\"; // Completed\\n\\n// Issue History Entry\\nexport interface IssueHistoryEntry {\\n  id: string;\\n  timestamp: string;\\n  action: \\\"created\\\" | \\\"note_added\\\" | \\\"forwarded\\\" | \\\"status_changed\\\" | \\\"resolved\\\";\\n  performedBy: {\\n    id: string;\\n    name: string;\\n  };\\n  details?: string;\\n  previousStatus?: IssueStatus;\\n  newStatus?: IssueStatus;\\n}\\n\\n// Issue Note\\nexport interface IssueNote {\\n  id: string;\\n  content: string;\\n  createdAt: string;\\n  createdBy: {\\n    id: string;\\n    name: string;\\n  };\\n}\\n\\n// Forward to Client Data\\nexport interface ForwardToClientData {\\n  method: \\\"link\\\" | \\\"email\\\";\\n  recipientEmail?: string;\\n  message?: string;\\n  shareableLink?: string;\\n  expiresAt?: string;\\n  sentAt: string;\\n}\\n\\n// Enhanced Quality Issue (with full workflow support)\\nexport interface EnhancedQualityIssue {\\n  id: string;\\n  type: QualityIssueType;\\n  severity: QualityIssueSeverity;\\n  status: IssueStatus;\\n  title: string;\\n  description: string;\\n  suggestedAction?: string;\\n  linkedChecklistItemId: string;\\n  linkedFileIds: string[]; // Multiple source documents\\n  linkedPageNumbers?: Record<string, number[]>; // fileId -> page numbers\\n  history: IssueHistoryEntry[];\\n  forwardData?: ForwardToClientData;\\n  notes: IssueNote[];\\n  createdAt: string;\\n  updatedAt: string;\\n  resolvedAt?: string;\\n  resolvedBy?: {\\n    id: string;\\n    name: string;\\n  };\\n}\\n\\n// ============================================\\n// Enhanced Checklist Item Types\\n// ============================================\\n\\n// Linked Document Reference (source documents for data extraction)\\nexport interface LinkedDocument {\\n  fileId: string;\\n  fileName: string;\\n  groupTitle: string;\\n  pageNumbers: number[];\\n  extractedText?: string;\\n  thumbnailUrl?: string;\\n}\\n\\n// Required Evidence (documents needed for visa submission)\\nexport interface RequiredEvidence {\\n  id: string;\\n  name: string; // e.g., \\\"Valid Passport\\\", \\\"Bank Statements\\\"\\n  description?: string; // Detailed requirement\\n  isUploaded: boolean; // Whether the document has been uploaded\\n  linkedFileId?: string; // If uploaded, the file ID\\n  linkedFileName?: string; // If uploaded, the file name\\n  isMandatory: boolean; // Whether it's mandatory for the application\\n  acceptedFormats?: string[]; // e.g., [\\\"PDF\\\", \\\"JPEG\\\"]\\n  validityPeriod?: string; // e.g., \\\"Must be dated within 31 days\\\"\\n}\\n\\n// Enhanced Checklist Item (with document references)\\nexport interface EnhancedChecklistItem {\\n  id: string;\\n  section: ChecklistSectionType;\\n  field: string;\\n  label: string;\\n  description?: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  linkedDocuments: LinkedDocument[]; // Source documents (for extraction)\\n  requiredEvidence: RequiredEvidence[]; // Required evidence for submission\",\n    \"numLines\": 150,\n    \"startLine\": 150,\n    \"totalLines\": 606\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668546683-05jsuv","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\\n                onClick={onUploadClick}\\n                className=\\\"shrink-0 inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-md transition-colors\\\"\\n              >\\n                <Plus className=\\\"size-3\\\" />\\n                Add\\n              </button>\\n            </div>\\n            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => onReferenceDocClick(ev)}\\n                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\\n                  >\\n                    <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\\n              )}\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n\\n      {/* Scrollable Content - min-h-0 is critical for flex overflow to work */}\\n      <div className=\\\"flex-1 min-h-0 p-4 overflow-y-auto\\\">\\n        {/* Fields Section Header */}\\n        <div className=\\\"flex items-center justify-between mb-3\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <h4 className=\\\"text-xs font-medium text-stone-600\\\">Fields</h4>\\n            {missingFields.length > 0 && !showAllFields && (\\n              <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n                {missingFields.length} missing\\n              </span>\\n            )}\\n          </div>\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? \\\"Show unanswered\\\" : \\\"Show all\\\"}\\n          </button>\\n        </div>\\n\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All fields have been filled</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2\\\">\\n            {displayFields.map((field) => {\\n              // Use pending value if exists, otherwise use stored value\\n              const storedValue = formValues[field.id] || field.value || \\\"\\\";\\n              const currentValue = pendingChanges[field.id] !== undefined ? pendingChanges[field.id] : storedValue;\\n              const hasPendingValue = pendingChanges[field.id] !== undefined && pendingChanges[field.id].trim() !== \\\"\\\";\\n              const isMissing = field.status === \\\"missing\\\" && !hasPendingValue;\\n              const isCompleted = !isMissing && (currentValue || hasPendingValue);\\n              // Check if user has manually entered/edited this field in this session\\n              const isManuallyEdited = manuallyEditedFields.has(field.id);\\n\\n              // Determine which badge to show\\n              const renderSourceBadge = () => {\\n                if (hasPendingValue) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-amber-700 bg-amber-100 rounded\\\">\\n                      Pending\\n                    </span>\\n                  );\\n                }\\n                if (isManuallyEdited) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n                      <PenLine className=\\\"size-2\\\" />\\n                      Manual\\n                    </span>\\n                  );\\n                }\\n                return getSourceBadge(field);\\n              };\\n\\n              return (\\n                <div\\n                  key={field.id}\\n                  className={cn(\\n                    \\\"p-2.5 rounded-lg border transition-colors\\\",\\n                    hasPendingValue\\n                      ? \\\"border-blue-200 bg-blue-50/30\\\"\\n                      : isMissing\\n                        ? \\\"border-amber-200 bg-amber-50/50\\\"\\n                        : \\\"border-stone-100 bg-stone-50/30\\\"\\n                  )}\\n                >\\n                  <div className=\\\"flex items-center gap-2 mb-1.5\\\">\\n                    {isCompleted ? (\\n                      <CheckCircle2 className={cn(\\n                        \\\"size-3.5 shrink-0\\\",\\n                        hasPendingValue ? \\\"text-blue-500\\\" : \\\"text-emerald-500\\\"\\n                      )} />\\n                    ) : (\\n                      <div className=\\\"size-3.5 rounded-full border-2 border-amber-400 shrink-0\\\" />\\n                    )}\\n                    <label className={cn(\\n                      \\\"text-xs font-medium truncate flex-1\\\",\\n                      isMissing ? \\\"text-stone-700\\\" : \\\"text-stone-500\\\"\\n                    )}>\\n                      {field.label}\\n                    </label>\\n                    {renderSourceBadge()}\\n                  </div>\\n\\n                  {/* All fields are editable */}\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Footer - shows when there are pending changes */}\\n      {hasPendingChanges && (\\n        <div className=\\\"shrink-0 px-4 py-3 border-t border-stone-100 flex items-center justify-between bg-stone-50/50\\\">\\n          <p className=\\\"text-xs text-stone-500 tabular-nums\\\">\\n            {pendingFieldIds.length} field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"} pending\\n          </p>\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <button\\n              onClick={handleCancel}\\n              disabled={isSubmitting}\\n              className=\\\"px-3 py-1.5 text-xs font-medium text-stone-600 hover:text-stone-800 hover:bg-stone-100 rounded-lg transition-colors disabled:opacity-50\\\"\\n            >\\n              Cancel\\n            </button>\\n            <button\\n              onClick={handleSubmit}\\n              disabled={isSubmitting}\\n              className=\\\"px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors flex items-center gap-1.5 disabled:opacity-50\\\"\\n            >\\n              {isSubmitting ? (\\n                <>\\n                  <Loader2 className=\\\"size-3.5 animate-spin\\\" />\\n                  Saving...\\n                </>\\n              ) : (\\n                <>\\n                  <Check className=\\\"size-3.5\\\" />\\n                  Save {pendingFieldIds.length} Field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"}\\n                </>\\n              )}\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </div>\\n  );\",\n    \"numLines\": 200,\n    \"startLine\": 290,\n    \"totalLines\": 1292\n  }\n}","timestamp":1769668546683,"toolName":"Read","toolUseId":"toolu_01PaWrAWFCaAT75yiWmGo7bt","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/ChecklistDetailPanel.tsx"},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\\n                onClick={onUploadClick}\\n                className=\\\"shrink-0 inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-md transition-colors\\\"\\n              >\\n                <Plus className=\\\"size-3\\\" />\\n                Add\\n              </button>\\n            </div>\\n            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => onReferenceDocClick(ev)}\\n                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\\n                  >\\n                    <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\\n              )}\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n\\n      {/* Scrollable Content - min-h-0 is critical for flex overflow to work */}\\n      <div className=\\\"flex-1 min-h-0 p-4 overflow-y-auto\\\">\\n        {/* Fields Section Header */}\\n        <div className=\\\"flex items-center justify-between mb-3\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <h4 className=\\\"text-xs font-medium text-stone-600\\\">Fields</h4>\\n            {missingFields.length > 0 && !showAllFields && (\\n              <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n                {missingFields.length} missing\\n              </span>\\n            )}\\n          </div>\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? \\\"Show unanswered\\\" : \\\"Show all\\\"}\\n          </button>\\n        </div>\\n\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All fields have been filled</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2\\\">\\n            {displayFields.map((field) => {\\n              // Use pending value if exists, otherwise use stored value\\n              const storedValue = formValues[field.id] || field.value || \\\"\\\";\\n              const currentValue = pendingChanges[field.id] !== undefined ? pendingChanges[field.id] : storedValue;\\n              const hasPendingValue = pendingChanges[field.id] !== undefined && pendingChanges[field.id].trim() !== \\\"\\\";\\n              const isMissing = field.status === \\\"missing\\\" && !hasPendingValue;\\n              const isCompleted = !isMissing && (currentValue || hasPendingValue);\\n              // Check if user has manually entered/edited this field in this session\\n              const isManuallyEdited = manuallyEditedFields.has(field.id);\\n\\n              // Determine which badge to show\\n              const renderSourceBadge = () => {\\n                if (hasPendingValue) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-amber-700 bg-amber-100 rounded\\\">\\n                      Pending\\n                    </span>\\n                  );\\n                }\\n                if (isManuallyEdited) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n                      <PenLine className=\\\"size-2\\\" />\\n                      Manual\\n                    </span>\\n                  );\\n                }\\n                return getSourceBadge(field);\\n              };\\n\\n              return (\\n                <div\\n                  key={field.id}\\n                  className={cn(\\n                    \\\"p-2.5 rounded-lg border transition-colors\\\",\\n                    hasPendingValue\\n                      ? \\\"border-blue-200 bg-blue-50/30\\\"\\n                      : isMissing\\n                        ? \\\"border-amber-200 bg-amber-50/50\\\"\\n                        : \\\"border-stone-100 bg-stone-50/30\\\"\\n                  )}\\n                >\\n                  <div className=\\\"flex items-center gap-2 mb-1.5\\\">\\n                    {isCompleted ? (\\n                      <CheckCircle2 className={cn(\\n                        \\\"size-3.5 shrink-0\\\",\\n                        hasPendingValue ? \\\"text-blue-500\\\" : \\\"text-emerald-500\\\"\\n                      )} />\\n                    ) : (\\n                      <div className=\\\"size-3.5 rounded-full border-2 border-amber-400 shrink-0\\\" />\\n                    )}\\n                    <label className={cn(\\n                      \\\"text-xs font-medium truncate flex-1\\\",\\n                      isMissing ? \\\"text-stone-700\\\" : \\\"text-stone-500\\\"\\n                    )}>\\n                      {field.label}\\n                    </label>\\n                    {renderSourceBadge()}\\n                  </div>\\n\\n                  {/* All fields are editable */}\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Footer - shows when there are pending changes */}\\n      {hasPendingChanges && (\\n        <div className=\\\"shrink-0 px-4 py-3 border-t border-stone-100 flex items-center justify-between bg-stone-50/50\\\">\\n          <p className=\\\"text-xs text-stone-500 tabular-nums\\\">\\n            {pendingFieldIds.length} field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"} pending\\n          </p>\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <button\\n              onClick={handleCancel}\\n              disabled={isSubmitting}\\n              className=\\\"px-3 py-1.5 text-xs font-medium text-stone-600 hover:text-stone-800 hover:bg-stone-100 rounded-lg transition-colors disabled:opacity-50\\\"\\n            >\\n              Cancel\\n            </button>\\n            <button\\n              onClick={handleSubmit}\\n              disabled={isSubmitting}\\n              className=\\\"px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors flex items-center gap-1.5 disabled:opacity-50\\\"\\n            >\\n              {isSubmitting ? (\\n                <>\\n                  <Loader2 className=\\\"size-3.5 animate-spin\\\" />\\n                  Saving...\\n                </>\\n              ) : (\\n                <>\\n                  <Check className=\\\"size-3.5\\\" />\\n                  Save {pendingFieldIds.length} Field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"}\\n                </>\\n              )}\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </div>\\n  );\",\n    \"numLines\": 200,\n    \"startLine\": 290,\n    \"totalLines\": 1292\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668546963-pes6gl","type":"tool","content":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"2865:        get().generateEnhancedChecklist();\\n3645:        get().generateEnhancedChecklist();\\n3879:      generateEnhancedChecklist: () => {\\n3907:        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n4049:          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n4119:        const allRequiredEvidence = Object.values(SECTION_REQUIRED_EVIDENCE).flat();\\n4124:            const sectionType = Object.entries(SECTION_REQUIRED_EVIDENCE)\\n4172:          \\\"generateEnhancedChecklist\\\"\",\n  \"numLines\": 8\n}","timestamp":1769668546963,"toolName":"Read","toolUseId":"toolu_01L13iBepwbqM58ZFbkQKsin","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/ChecklistWorkspace.tsx"},"toolResult":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"2865:        get().generateEnhancedChecklist();\\n3645:        get().generateEnhancedChecklist();\\n3879:      generateEnhancedChecklist: () => {\\n3907:        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n4049:          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n4119:        const allRequiredEvidence = Object.values(SECTION_REQUIRED_EVIDENCE).flat();\\n4124:            const sectionType = Object.entries(SECTION_REQUIRED_EVIDENCE)\\n4172:          \\\"generateEnhancedChecklist\\\"\",\n  \"numLines\": 8\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668553294-udn5ve","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n    \"content\": \"      generateEnhancedChecklist: () => {\\n        const state = get();\\n        const currentUser = SYSTEM_USERS[0];\\n\\n        // Create linked documents from analyzed files\\n        const createLinkedDocument = (fileId: string): LinkedDocument | null => {\\n          const file = state.allFiles[fileId];\\n          if (!file || file.isRemoved) return null;\\n          // Find the group this file belongs to\\n          const group = state.documentGroups.find((g) =>\\n            g.fileIds.includes(fileId)\\n          );\\n          return {\\n            fileId: file.id,\\n            fileName: file.name,\\n            groupTitle: group?.title || \\\"Unknown\\\",\\n            pageNumbers: [1], // Mock page number\\n            extractedText: `Extracted from ${file.name}`,\\n          };\\n        };\\n\\n        // Get passport file info\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFile = passportGroup?.fileIds[0]\\n          ? state.allFiles[passportGroup.fileIds[0]]\\n          : undefined;\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: !!passportFile,\\n              linkedFileId: passportFile?.id,\\n              linkedFileName: passportFile?.name,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\\n            {\\n              id: \\\"ev_photo\\\",\\n              name: \\\"Passport-sized Photograph\\\",\\n              description: \\\"Recent photo meeting UK visa photo requirements (45mm x 35mm)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"JPEG\\\", \\\"PNG\\\"],\\n            },\\n            {\\n              id: \\\"ev_previous_passport\\\",\\n              name: \\\"Previous Passports (if applicable)\\\",\\n              description: \\\"Any previous passports showing UK immigration history\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          employment: [\\n            {\\n              id: \\\"ev_cos\\\",\\n              name: \\\"Certificate of Sponsorship (CoS)\\\",\\n              description: \\\"CoS reference number from licensed UK sponsor\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n            },\\n            {\\n              id: \\\"ev_employment_contract\\\",\\n              name: \\\"Employment Contract / Job Offer Letter\\\",\\n              description: \\\"Signed contract showing job title, salary, and start date\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_sponsor_letter\\\",\\n              name: \\\"Sponsor Confirmation Letter\\\",\\n              description: \\\"Letter from sponsor confirming employment details\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          financial: [\\n            {\\n              id: \\\"ev_bank_statements\\\",\\n              name: \\\"Bank Statements (28 days)\\\",\\n              description: \\\"Showing funds held for 28 consecutive days ending within 31 days of application\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be dated within 31 days of application\\\",\\n            },\\n            {\\n              id: \\\"ev_payslip\\\",\\n              name: \\\"Payslip\\\",\\n              description: \\\"Recent payslips showing salary payments (last 3 months recommended)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          travel: [\\n            {\\n              id: \\\"ev_travel_history\\\",\\n              name: \\\"Travel History Documentation\\\",\\n              description: \\\"Evidence of travel history for last 10 years (passport stamps, boarding passes)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n            {\\n              id: \\\"ev_old_visas\\\",\\n              name: \\\"Previous UK Visas (if any)\\\",\\n              description: \\\"Copies of any previous UK visas or BRPs\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          education: [\\n            {\\n              id: \\\"ev_english_cert\\\",\\n              name: \\\"English Language Test Certificate\\\",\\n              description: \\\"IELTS, TOEFL, or approved SELT certificate (CEFR B1 minimum)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be within 2 years of application date\\\",\\n            },\\n            {\\n              id: \\\"ev_degree_cert\\\",\\n              name: \\\"Degree Certificate / Academic Qualification\\\",\\n              description: \\\"Original or certified copy of highest qualification\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_atas\\\",\\n              name: \\\"ATAS Certificate (if applicable)\\\",\\n              description: \\\"Academic Technology Approval Scheme certificate for certain fields\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          family: [\\n            {\\n              id: \\\"ev_marriage_cert\\\",\\n              name: \\\"Marriage Certificate (if applicable)\\\",\\n              description: \\\"Official marriage certificate if applying with spouse\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_birth_cert\\\",\\n              name: \\\"Birth Certificates (if applicable)\\\",\\n              description: \\\"For any dependent children\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          other: [],\\n        };\\n\\n        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\\n\\n        // Convert existing checklist items to enhanced format\\n        const enhancedItems: EnhancedChecklistItem[] = state.applicationChecklistItems.map((item) => ({\\n          id: item.id,\\n          section: item.section,\\n          field: item.field,\\n          label: item.label,\\n          value: item.value,\\n          source: item.source,\\n          linkedDocuments: item.linkedFileIds\\n            .map(createLinkedDocument)\\n            .filter((doc): doc is LinkedDocument => doc !== null),\\n          requiredEvidence: getRequiredEvidence(item.section),\\n          status: item.status,\\n          isRequired: item.isRequired,\\n          isEditable: true,\\n          confidenceScore: item.source === \\\"extracted\\\" ? 95 : undefined,\\n        }));\\n\\n        // Convert existing quality issues to enhanced format\\n        const existingEnhancedIssues: EnhancedQualityIssue[] = state.qualityIssues.map((issue) => ({\\n          id: issue.id,\\n          type: issue.type,\\n          severity: issue.severity,\\n          status: issue.isResolved ? \\\"resolved\\\" as IssueStatus : \\\"open\\\" as IssueStatus,\\n          title: issue.title,\\n          description: issue.description,\\n          linkedChecklistItemId: issue.linkedChecklistItemId,\",\n    \"numLines\": 200,\n    \"startLine\": 3879,\n    \"totalLines\": 4510\n  }\n}","timestamp":1769668553294,"toolName":"Read","toolUseId":"toolu_015q2sokn6b9EkshMMb8k8sZ","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/SupportingDocumentsTab.tsx"},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n    \"content\": \"      generateEnhancedChecklist: () => {\\n        const state = get();\\n        const currentUser = SYSTEM_USERS[0];\\n\\n        // Create linked documents from analyzed files\\n        const createLinkedDocument = (fileId: string): LinkedDocument | null => {\\n          const file = state.allFiles[fileId];\\n          if (!file || file.isRemoved) return null;\\n          // Find the group this file belongs to\\n          const group = state.documentGroups.find((g) =>\\n            g.fileIds.includes(fileId)\\n          );\\n          return {\\n            fileId: file.id,\\n            fileName: file.name,\\n            groupTitle: group?.title || \\\"Unknown\\\",\\n            pageNumbers: [1], // Mock page number\\n            extractedText: `Extracted from ${file.name}`,\\n          };\\n        };\\n\\n        // Get passport file info\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFile = passportGroup?.fileIds[0]\\n          ? state.allFiles[passportGroup.fileIds[0]]\\n          : undefined;\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: !!passportFile,\\n              linkedFileId: passportFile?.id,\\n              linkedFileName: passportFile?.name,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\\n            {\\n              id: \\\"ev_photo\\\",\\n              name: \\\"Passport-sized Photograph\\\",\\n              description: \\\"Recent photo meeting UK visa photo requirements (45mm x 35mm)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"JPEG\\\", \\\"PNG\\\"],\\n            },\\n            {\\n              id: \\\"ev_previous_passport\\\",\\n              name: \\\"Previous Passports (if applicable)\\\",\\n              description: \\\"Any previous passports showing UK immigration history\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          employment: [\\n            {\\n              id: \\\"ev_cos\\\",\\n              name: \\\"Certificate of Sponsorship (CoS)\\\",\\n              description: \\\"CoS reference number from licensed UK sponsor\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n            },\\n            {\\n              id: \\\"ev_employment_contract\\\",\\n              name: \\\"Employment Contract / Job Offer Letter\\\",\\n              description: \\\"Signed contract showing job title, salary, and start date\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_sponsor_letter\\\",\\n              name: \\\"Sponsor Confirmation Letter\\\",\\n              description: \\\"Letter from sponsor confirming employment details\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          financial: [\\n            {\\n              id: \\\"ev_bank_statements\\\",\\n              name: \\\"Bank Statements (28 days)\\\",\\n              description: \\\"Showing funds held for 28 consecutive days ending within 31 days of application\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be dated within 31 days of application\\\",\\n            },\\n            {\\n              id: \\\"ev_payslip\\\",\\n              name: \\\"Payslip\\\",\\n              description: \\\"Recent payslips showing salary payments (last 3 months recommended)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          travel: [\\n            {\\n              id: \\\"ev_travel_history\\\",\\n              name: \\\"Travel History Documentation\\\",\\n              description: \\\"Evidence of travel history for last 10 years (passport stamps, boarding passes)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n            {\\n              id: \\\"ev_old_visas\\\",\\n              name: \\\"Previous UK Visas (if any)\\\",\\n              description: \\\"Copies of any previous UK visas or BRPs\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          education: [\\n            {\\n              id: \\\"ev_english_cert\\\",\\n              name: \\\"English Language Test Certificate\\\",\\n              description: \\\"IELTS, TOEFL, or approved SELT certificate (CEFR B1 minimum)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be within 2 years of application date\\\",\\n            },\\n            {\\n              id: \\\"ev_degree_cert\\\",\\n              name: \\\"Degree Certificate / Academic Qualification\\\",\\n              description: \\\"Original or certified copy of highest qualification\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_atas\\\",\\n              name: \\\"ATAS Certificate (if applicable)\\\",\\n              description: \\\"Academic Technology Approval Scheme certificate for certain fields\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          family: [\\n            {\\n              id: \\\"ev_marriage_cert\\\",\\n              name: \\\"Marriage Certificate (if applicable)\\\",\\n              description: \\\"Official marriage certificate if applying with spouse\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_birth_cert\\\",\\n              name: \\\"Birth Certificates (if applicable)\\\",\\n              description: \\\"For any dependent children\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          other: [],\\n        };\\n\\n        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\\n\\n        // Convert existing checklist items to enhanced format\\n        const enhancedItems: EnhancedChecklistItem[] = state.applicationChecklistItems.map((item) => ({\\n          id: item.id,\\n          section: item.section,\\n          field: item.field,\\n          label: item.label,\\n          value: item.value,\\n          source: item.source,\\n          linkedDocuments: item.linkedFileIds\\n            .map(createLinkedDocument)\\n            .filter((doc): doc is LinkedDocument => doc !== null),\\n          requiredEvidence: getRequiredEvidence(item.section),\\n          status: item.status,\\n          isRequired: item.isRequired,\\n          isEditable: true,\\n          confidenceScore: item.source === \\\"extracted\\\" ? 95 : undefined,\\n        }));\\n\\n        // Convert existing quality issues to enhanced format\\n        const existingEnhancedIssues: EnhancedQualityIssue[] = state.qualityIssues.map((issue) => ({\\n          id: issue.id,\\n          type: issue.type,\\n          severity: issue.severity,\\n          status: issue.isResolved ? \\\"resolved\\\" as IssueStatus : \\\"open\\\" as IssueStatus,\\n          title: issue.title,\\n          description: issue.description,\\n          linkedChecklistItemId: issue.linkedChecklistItemId,\",\n    \"numLines\": 200,\n    \"startLine\": 3879,\n    \"totalLines\": 4510\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668553578-0u4a0v","type":"tool","content":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"1151:    // For now, this triggers the UI state change in OverviewTab\\n1159:          itemType=\\\"checklist\\\"\",\n  \"numLines\": 2\n}","timestamp":1769668553578,"toolName":"Read","toolUseId":"toolu_01XjmNuTinntLtcih2A6xBAZ","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx"},"toolResult":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"1151:    // For now, this triggers the UI state change in OverviewTab\\n1159:          itemType=\\\"checklist\\\"\",\n  \"numLines\": 2\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668554018-514er0","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/ChecklistDetailPanel.tsx\",\n    \"content\": \"\\n  const handleCancel = () => {\\n    // Reset to original values\\n    setFormValues(originalValues);\\n  };\\n\\n  const handleReanalyze = () => {\\n    // Trigger document analysis to extract field data\\n    // This would call an API or store method to analyze documents\\n    console.log(\\\"Analyzing reference documents for section:\\\", sectionId);\\n    // TODO: Implement actual analysis logic\\n    // For now, this triggers the UI state change in OverviewTab\\n  };\\n\\n  return (\\n    <div className=\\\"h-full flex flex-col bg-white\\\">\\n      {/* New Tabbed Interface */}\\n      <div className=\\\"flex-1 min-h-0\\\">\\n        <ItemDetailTabs\\n          itemType=\\\"checklist\\\"\\n          itemId={sectionId}\\n          itemTitle={sectionTitle}\\n          items={items}\\n          issues={issues}\\n          documentGroups={documentGroups}\\n          formValues={formValues}\\n          editedFieldIds={editedFieldIds}\\n          onFieldChange={handleFieldChange}\\n          onReanalyze={handleReanalyze}\\n          onTabChange={handleTabChange}\\n          externalActiveTab={externalActiveTab}\\n        />\\n      </div>\\n\\n      {/* Save/Cancel Footer - only show on Details tab when changes detected */}\\n      {hasChanges && activeTab === \\\"details\\\" && (\\n        <div className=\\\"shrink-0 px-6 py-3 border-t border-stone-200 bg-stone-50 flex items-center justify-between\\\">\\n          <p className=\\\"text-xs text-stone-500\\\">\\n            {editedFieldIds.size} field{editedFieldIds.size !== 1 ? \\\"s\\\" : \\\"\\\"} modified\\n          </p>\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <button\\n              onClick={handleCancel}\\n              className=\\\"px-4 py-2 text-sm font-medium text-stone-600 hover:text-stone-800 hover:bg-stone-100 rounded-lg transition-colors\\\"\\n            >\\n              Cancel\\n            </button>\\n            <button\\n              onClick={handleSave}\\n              className=\\\"px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors flex items-center gap-1.5\\\"\",\n    \"numLines\": 50,\n    \"startLine\": 1140,\n    \"totalLines\": 1201\n  }\n}","timestamp":1769668554018,"toolName":"Read","toolUseId":"toolu_012cN31rCbKtaSf5mMnHV9A8","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/ItemDetailTabs.tsx"},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/ChecklistDetailPanel.tsx\",\n    \"content\": \"\\n  const handleCancel = () => {\\n    // Reset to original values\\n    setFormValues(originalValues);\\n  };\\n\\n  const handleReanalyze = () => {\\n    // Trigger document analysis to extract field data\\n    // This would call an API or store method to analyze documents\\n    console.log(\\\"Analyzing reference documents for section:\\\", sectionId);\\n    // TODO: Implement actual analysis logic\\n    // For now, this triggers the UI state change in OverviewTab\\n  };\\n\\n  return (\\n    <div className=\\\"h-full flex flex-col bg-white\\\">\\n      {/* New Tabbed Interface */}\\n      <div className=\\\"flex-1 min-h-0\\\">\\n        <ItemDetailTabs\\n          itemType=\\\"checklist\\\"\\n          itemId={sectionId}\\n          itemTitle={sectionTitle}\\n          items={items}\\n          issues={issues}\\n          documentGroups={documentGroups}\\n          formValues={formValues}\\n          editedFieldIds={editedFieldIds}\\n          onFieldChange={handleFieldChange}\\n          onReanalyze={handleReanalyze}\\n          onTabChange={handleTabChange}\\n          externalActiveTab={externalActiveTab}\\n        />\\n      </div>\\n\\n      {/* Save/Cancel Footer - only show on Details tab when changes detected */}\\n      {hasChanges && activeTab === \\\"details\\\" && (\\n        <div className=\\\"shrink-0 px-6 py-3 border-t border-stone-200 bg-stone-50 flex items-center justify-between\\\">\\n          <p className=\\\"text-xs text-stone-500\\\">\\n            {editedFieldIds.size} field{editedFieldIds.size !== 1 ? \\\"s\\\" : \\\"\\\"} modified\\n          </p>\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <button\\n              onClick={handleCancel}\\n              className=\\\"px-4 py-2 text-sm font-medium text-stone-600 hover:text-stone-800 hover:bg-stone-100 rounded-lg transition-colors\\\"\\n            >\\n              Cancel\\n            </button>\\n            <button\\n              onClick={handleSave}\\n              className=\\\"px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors flex items-center gap-1.5\\\"\",\n    \"numLines\": 50,\n    \"startLine\": 1140,\n    \"totalLines\": 1201\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668558748-oiyqrf","type":"tool","content":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"\",\n  \"numLines\": 0\n}","timestamp":1769668558748,"toolName":"Read","toolUseId":"toolu_01KS7HMx9TksSoP4Yn9eabiq","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/lib/document-path-parser.ts"},"toolResult":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"\",\n  \"numLines\": 0\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668558967-qzr29y","type":"tool","content":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"1-\\\"use client\\\";\\n2-\\n3-import { useState, useEffect, useCallback } from \\\"react\\\";\\n4-import { Tabs, TabsList, TabsTrigger, TabsContent } from \\\"@/components/ui/tabs\\\";\\n5-import { cn } from \\\"@/lib/utils\\\";\\n6:import { OverviewTab } from \\\"./OverviewTab\\\";\\n7-import { DetailsTab } from \\\"./DetailsTab\\\";\\n8-import { SupportingDocumentsTab } from \\\"./SupportingDocumentsTab\\\";\\n9-import {\\n10-  EnhancedChecklistItem,\\n11-  EnhancedQualityIssue,\\n--\\n39-  externalActiveTab?: DetailTabId; // Optional external control of active tab\\n40-}\\n41-\\n42-// Props for checklist section items\\n43-interface ChecklistItemDetailProps extends BaseItemDetailProps {\\n44:  itemType: \\\"checklist\\\";\\n45-  items: EnhancedChecklistItem[];\\n46-  issues: EnhancedQualityIssue[];\\n47-  onFieldChange: (fieldId: string, value: string) => void;\\n48-  formValues: Record<string, string>;\\n49-  editedFieldIds: Set<string>;\\n--\\n68-\\n69-  // State for navigating to a specific field from Overview\\n70-  const [focusFieldId, setFocusFieldId] = useState<string | null>(null);\\n71-\\n72-  // Determine if this is an employment section (use tabs) or other section (use breadcrumb)\\n73:  const isEmploymentSection = itemType === \\\"checklist\\\" &&\\n74-    props.items.length > 0 &&\\n75-    props.items[0].section === \\\"employment\\\";\\n76-\\n77-  // Sync with external active tab when it changes (e.g., from header breadcrumb)\\n78-  useEffect(() => {\\n--\\n117-      {isEmploymentSection ? (\\n118-        /* Employment Section: Conditional content based on activeTab */\\n119-        <div className=\\\"flex-1 min-h-0 relative\\\">\\n120-          {activeTab === \\\"overview\\\" && (\\n121-            <div className=\\\"absolute inset-0 overflow-y-auto flex flex-col\\\">\\n122:              <OverviewTab\\n123:                itemType=\\\"checklist\\\"\\n124-                items={(props as ChecklistItemDetailProps).items}\\n125-                issues={(props as ChecklistItemDetailProps).issues}\\n126-                formValues={(props as ChecklistItemDetailProps).formValues}\\n127-                documentGroups={documentGroups}\\n128-                onEditField={handleEditField}\\n--\\n134-          )}\\n135-\\n136-          {activeTab === \\\"details\\\" && (\\n137-            <div className=\\\"absolute inset-0 overflow-y-auto\\\">\\n138-              <DetailsTab\\n139:                itemType=\\\"checklist\\\"\\n140-                items={(props as ChecklistItemDetailProps).items}\\n141-                formValues={(props as ChecklistItemDetailProps).formValues}\\n142-                editedFieldIds={(props as ChecklistItemDetailProps).editedFieldIds}\\n143-                documentGroups={documentGroups}\\n144-                onFieldChange={(props as ChecklistItemDetailProps).onFieldChange}\\n--\\n149-          )}\\n150-\\n151-          {activeTab === \\\"supporting-documents\\\" && (\\n152-            <div className=\\\"absolute inset-0 overflow-y-auto\\\">\\n153-              <SupportingDocumentsTab\\n154:                itemType=\\\"checklist\\\"\\n155-                items={(props as ChecklistItemDetailProps).items}\\n156-                documentGroups={documentGroups}\\n157-                sectionId={(props as ChecklistItemDetailProps).items[0]?.section as ChecklistSectionType}\\n158-              />\\n159-            </div>\\n--\\n162-      ) : (\\n163-        /* Non-Employment Section: No tabs, direct content with breadcrumb navigation */\\n164-        <div className=\\\"flex-1 min-h-0 relative\\\">\\n165-          {activeTab === \\\"overview\\\" && (\\n166-            <div className=\\\"absolute inset-0 overflow-y-auto flex flex-col\\\">\\n167:              {props.itemType === \\\"checklist\\\" ? (\\n168:                <OverviewTab\\n169:                  itemType=\\\"checklist\\\"\\n170-                  items={props.items}\\n171-                  issues={props.issues}\\n172-                  formValues={props.formValues}\\n173-                  documentGroups={documentGroups}\\n174-                  onEditField={handleEditField}\\n175-                  onFieldChange={props.onFieldChange}\\n176-                  onReanalyze={onReanalyze}\\n177-                  onNavigateToTab={handleNavigateToTab}\\n178-                />\\n179-              ) : (\\n180:                <OverviewTab\\n181-                  itemType=\\\"assessment\\\"\\n182-                  fields={props.fields}\\n183-                  formValues={props.formValues}\\n184-                  requiredEvidence={props.requiredEvidence}\\n185-                  documentGroups={documentGroups}\\n--\\n192-            </div>\\n193-          )}\\n194-\\n195-          {activeTab === \\\"details\\\" && (\\n196-            <div className=\\\"absolute inset-0 overflow-y-auto\\\">\\n197:              {props.itemType === \\\"checklist\\\" ? (\\n198-                <DetailsTab\\n199:                  itemType=\\\"checklist\\\"\\n200-                  items={props.items}\\n201-                  formValues={props.formValues}\\n202-                  editedFieldIds={props.editedFieldIds}\\n203-                  documentGroups={documentGroups}\\n204-                  onFieldChange={props.onFieldChange}\\n--\\n219-            </div>\\n220-          )}\\n221-\\n222-          {activeTab === \\\"supporting-documents\\\" && (\\n223-            <div className=\\\"absolute inset-0 overflow-y-auto\\\">\\n224:              {props.itemType === \\\"checklist\\\" ? (\\n225-                <SupportingDocumentsTab\\n226:                  itemType=\\\"checklist\\\"\\n227-                  items={props.items}\\n228-                  documentGroups={documentGroups}\\n229-                  sectionId={props.items[0]?.section as ChecklistSectionType}\\n230-                />\\n231-              ) : (\",\n  \"numLines\": 125\n}","timestamp":1769668558967,"toolName":"Grep","toolUseId":"toolu_01471XZErUgwwovCpboRUHGu","toolInput":{"pattern":"linkedFileId|linkedFileIds|requiredEvidence","type":"ts","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store","head_limit":50},"toolResult":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"1-\\\"use client\\\";\\n2-\\n3-import { useState, useEffect, useCallback } from \\\"react\\\";\\n4-import { Tabs, TabsList, TabsTrigger, TabsContent } from \\\"@/components/ui/tabs\\\";\\n5-import { cn } from \\\"@/lib/utils\\\";\\n6:import { OverviewTab } from \\\"./OverviewTab\\\";\\n7-import { DetailsTab } from \\\"./DetailsTab\\\";\\n8-import { SupportingDocumentsTab } from \\\"./SupportingDocumentsTab\\\";\\n9-import {\\n10-  EnhancedChecklistItem,\\n11-  EnhancedQualityIssue,\\n--\\n39-  externalActiveTab?: DetailTabId; // Optional external control of active tab\\n40-}\\n41-\\n42-// Props for checklist section items\\n43-interface ChecklistItemDetailProps extends BaseItemDetailProps {\\n44:  itemType: \\\"checklist\\\";\\n45-  items: EnhancedChecklistItem[];\\n46-  issues: EnhancedQualityIssue[];\\n47-  onFieldChange: (fieldId: string, value: string) => void;\\n48-  formValues: Record<string, string>;\\n49-  editedFieldIds: Set<string>;\\n--\\n68-\\n69-  // State for navigating to a specific field from Overview\\n70-  const [focusFieldId, setFocusFieldId] = useState<string | null>(null);\\n71-\\n72-  // Determine if this is an employment section (use tabs) or other section (use breadcrumb)\\n73:  const isEmploymentSection = itemType === \\\"checklist\\\" &&\\n74-    props.items.length > 0 &&\\n75-    props.items[0].section === \\\"employment\\\";\\n76-\\n77-  // Sync with external active tab when it changes (e.g., from header breadcrumb)\\n78-  useEffect(() => {\\n--\\n117-      {isEmploymentSection ? (\\n118-        /* Employment Section: Conditional content based on activeTab */\\n119-        <div className=\\\"flex-1 min-h-0 relative\\\">\\n120-          {activeTab === \\\"overview\\\" && (\\n121-            <div className=\\\"absolute inset-0 overflow-y-auto flex flex-col\\\">\\n122:              <OverviewTab\\n123:                itemType=\\\"checklist\\\"\\n124-                items={(props as ChecklistItemDetailProps).items}\\n125-                issues={(props as ChecklistItemDetailProps).issues}\\n126-                formValues={(props as ChecklistItemDetailProps).formValues}\\n127-                documentGroups={documentGroups}\\n128-                onEditField={handleEditField}\\n--\\n134-          )}\\n135-\\n136-          {activeTab === \\\"details\\\" && (\\n137-            <div className=\\\"absolute inset-0 overflow-y-auto\\\">\\n138-              <DetailsTab\\n139:                itemType=\\\"checklist\\\"\\n140-                items={(props as ChecklistItemDetailProps).items}\\n141-                formValues={(props as ChecklistItemDetailProps).formValues}\\n142-                editedFieldIds={(props as ChecklistItemDetailProps).editedFieldIds}\\n143-                documentGroups={documentGroups}\\n144-                onFieldChange={(props as ChecklistItemDetailProps).onFieldChange}\\n--\\n149-          )}\\n150-\\n151-          {activeTab === \\\"supporting-documents\\\" && (\\n152-            <div className=\\\"absolute inset-0 overflow-y-auto\\\">\\n153-              <SupportingDocumentsTab\\n154:                itemType=\\\"checklist\\\"\\n155-                items={(props as ChecklistItemDetailProps).items}\\n156-                documentGroups={documentGroups}\\n157-                sectionId={(props as ChecklistItemDetailProps).items[0]?.section as ChecklistSectionType}\\n158-              />\\n159-            </div>\\n--\\n162-      ) : (\\n163-        /* Non-Employment Section: No tabs, direct content with breadcrumb navigation */\\n164-        <div className=\\\"flex-1 min-h-0 relative\\\">\\n165-          {activeTab === \\\"overview\\\" && (\\n166-            <div className=\\\"absolute inset-0 overflow-y-auto flex flex-col\\\">\\n167:              {props.itemType === \\\"checklist\\\" ? (\\n168:                <OverviewTab\\n169:                  itemType=\\\"checklist\\\"\\n170-                  items={props.items}\\n171-                  issues={props.issues}\\n172-                  formValues={props.formValues}\\n173-                  documentGroups={documentGroups}\\n174-                  onEditField={handleEditField}\\n175-                  onFieldChange={props.onFieldChange}\\n176-                  onReanalyze={onReanalyze}\\n177-                  onNavigateToTab={handleNavigateToTab}\\n178-                />\\n179-              ) : (\\n180:                <OverviewTab\\n181-                  itemType=\\\"assessment\\\"\\n182-                  fields={props.fields}\\n183-                  formValues={props.formValues}\\n184-                  requiredEvidence={props.requiredEvidence}\\n185-                  documentGroups={documentGroups}\\n--\\n192-            </div>\\n193-          )}\\n194-\\n195-          {activeTab === \\\"details\\\" && (\\n196-            <div className=\\\"absolute inset-0 overflow-y-auto\\\">\\n197:              {props.itemType === \\\"checklist\\\" ? (\\n198-                <DetailsTab\\n199:                  itemType=\\\"checklist\\\"\\n200-                  items={props.items}\\n201-                  formValues={props.formValues}\\n202-                  editedFieldIds={props.editedFieldIds}\\n203-                  documentGroups={documentGroups}\\n204-                  onFieldChange={props.onFieldChange}\\n--\\n219-            </div>\\n220-          )}\\n221-\\n222-          {activeTab === \\\"supporting-documents\\\" && (\\n223-            <div className=\\\"absolute inset-0 overflow-y-auto\\\">\\n224:              {props.itemType === \\\"checklist\\\" ? (\\n225-                <SupportingDocumentsTab\\n226:                  itemType=\\\"checklist\\\"\\n227-                  items={props.items}\\n228-                  documentGroups={documentGroups}\\n229-                  sectionId={props.items[0]?.section as ChecklistSectionType}\\n230-                />\\n231-              ) : (\",\n  \"numLines\": 125\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Search","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668559377-fzy3nd","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"  );\\n}\\n\\n// ============================================================================\\n// Original Summary Section Component (for non-employment sections)\\n// ============================================================================\\nfunction SummarySection({\\n  status,\\n  totalFields,\\n  completedFields,\\n  referenceEvidence,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  referenceEvidence: RequiredEvidence[];\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden\\\">\\n      <div className=\\\"flex items-stretch\\\">\\n        {/* Left - Progress Summary */}\\n        <div className=\\\"shrink-0 p-4 flex items-center gap-4 border-r border-stone-100\\\">\\n          <ProgressRing percent={percent} isComplete={isComplete} size={56} />\\n          <div>\\n            <span\\n              className={cn(\\n                \\\"inline-flex items-center px-2 py-1 text-xs font-semibold rounded-md\\\",\\n                isComplete\\n                  ? \\\"bg-emerald-100 text-emerald-700\\\"\\n                  : \\\"bg-amber-100 text-amber-700\\\"\\n              )}\\n            >\\n              {isComplete ? \\\"Complete\\\" : \\\"In Progress\\\"}\\n            </span>\\n            <p className=\\\"text-sm font-medium text-stone-700 mt-1.5 tabular-nums\\\">\\n              {completedFields}/{totalFields} fields\\n            </p>\\n          </div>\\n        </div>\\n\\n        {/* Right - Reference Documents (flexible width) */}\\n        <div className=\\\"flex-1 p-4\\\">\\n          {/* Header */}\\n          <div className=\\\"flex items-center justify-between mb-3\\\">\\n            <div>\\n              <h4 className=\\\"text-xs font-semibold text-stone-700 text-balance\\\">Reference Documents</h4>\\n              <p className=\\\"text-[10px] text-stone-400 text-pretty\\\">Source files for data extraction</p>\\n            </div>\\n            <button\\n              onClick={onUploadClick}\\n              className=\\\"inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-lg transition-colors\\\"\\n            >\\n              <Plus className=\\\"size-3.5\\\" />\\n              Add\\n            </button>\\n          </div>\\n\\n          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Missing Information Card - Shows fields that still need to be completed\\n// ============================================================================\\nfunction MissingInformationCard({\\n  fields,\\n  formValues,\\n  onFieldChange,\\n  onViewMore,\\n}: {\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onViewMore?: () => void;\\n}) {\\n  const [savingFields, setSavingFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n\\n  // Filter to only show missing fields\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const completedCount = fields.length - missingFields.length;\\n\\n  // Fields to display based on toggle\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    onFieldChange(fieldId, value);\\n    setSavingFields((prev) => new Set(prev).add(fieldId));\\n    setTimeout(() => {\\n      setSavingFields((prev) => {\\n        const next = new Set(prev);\\n        next.delete(fieldId);\\n        return next;\\n      });\\n    }, 1000);\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      <div className=\\\"px-4 py-3 border-b border-stone-100 flex items-center justify-between\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Missing Information</h3>\\n          {missingFields.length > 0 && (\\n            <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n              {missingFields.length}\\n            </span>\\n          )}\\n        </div>\\n        {/* Toggle between showing missing only vs all fields */}\\n        {completedCount > 0 && (\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? (missingFields.length > 0 ? \\\"Show unanswered\\\" : \\\"Hide all\\\") : \\\"Show all\\\"}\\n          </button>\\n        )}\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All information has been provided</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2.5\\\">\\n            {displayFields.slice(0, showAllFields ? undefined : 6).map((field) => {\\n              const currentValue = formValues[field.id] || field.value || \\\"\\\";\\n              const isSaving = savingFields.has(field.id);\\n              const isCompleted = field.status !== \\\"missing\\\";\\n\\n              return (\\n                <div key={field.id} className=\\\"space-y-1.5\\\">\\n                  <div className=\\\"flex items-center gap-2\\\">\\n                    <div className={cn(\\n                      \\\"size-3.5 rounded-full border-2 shrink-0\\\",\\n                      isCompleted ? \\\"bg-emerald-500 border-emerald-500\\\" : \\\"border-amber-400\\\"\\n                    )} />\\n                    <label className=\\\"text-xs font-medium text-stone-600 truncate flex-1\\\">\\n                      {field.label}\\n                    </label>\\n                    {isSaving && (\\n                      <span className=\\\"inline-flex items-center gap-0.5 px-1 py-0.5 text-[9px] font-medium text-emerald-700 bg-emerald-100 rounded\\\">\\n                        <Check className=\\\"size-2\\\" />\\n                        Saved\\n                      </span>\\n                    )}\\n                  </div>\\n\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\"\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\"\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Evidence Slot - Shows grouped document requirements\\n// ============================================================================\\nfunction CombinedEvidenceSlotInline({\\n  title,\\n  relationship,\\n  documents,\\n  onAddClick,\\n}: {\\n  title: string;\\n  relationship: \\\"all\\\" | \\\"any\\\";\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n}) {\\n  const uploadedCount = documents.filter(d => d.isUploaded).length;\\n  const totalCount = documents.length;\\n  const isComplete = relationship === \\\"all\\\"\\n    ? uploadedCount === totalCount\\n    : uploadedCount >= 1;\\n\\n  return (\\n    <div className={cn(\\n      \\\"rounded-xl border-2 overflow-hidden transition-all\\\",\\n      isComplete\\n        ? \\\"border-emerald-300 bg-gradient-to-b from-emerald-50 to-white shadow-sm\\\"\\n        : \\\"border-stone-200 bg-white\\\"\\n    )}>\\n      {/* Header */}\\n      <div className={cn(\\n        \\\"px-3 py-2.5 border-b\\\",\\n        isComplete ? \\\"border-emerald-200 bg-emerald-50\\\" : \\\"border-stone-100 bg-stone-50\\\"\\n      )}>\\n        <div className=\\\"flex items-center justify-between\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            {isComplete && (\\n              <CheckCircle2 className=\\\"size-4 text-emerald-500\\\" />\\n            )}\\n            <span className={cn(\\n              \\\"text-xs font-semibold\\\",\\n              isComplete ? \\\"text-emerald-700\\\" : \\\"text-stone-700\\\"\\n            )}>\\n              {title}\\n            </span>\\n            {/* Relationship badge */}\\n            <span className={cn(\\n              \\\"px-1.5 py-0.5 text-[9px] font-bold uppercase rounded\\\",\\n              isComplete\\n                ? \\\"bg-emerald-200 text-emerald-700\\\"\\n                : relationship === \\\"all\\\"\\n                  ? \\\"bg-stone-200 text-stone-600\\\"\\n                  : \\\"bg-blue-100 text-blue-600\\\"\\n            )}>\\n              {isComplete ? \\\"Complete\\\" : relationship === \\\"all\\\" ? \\\"All required\\\" : \\\"Any one\\\"}\\n            </span>\\n          </div>\\n          <span className={cn(\\n            \\\"text-[10px] font-semibold tabular-nums\\\",\\n            isComplete ? \\\"text-emerald-600\\\" : \\\"text-stone-500\\\"\\n          )}>\\n            {uploadedCount}/{totalCount}\\n          </span>\\n        </div>\\n      </div>\\n\\n      {/* Document slots - horizontal flex layout */}\\n      <div className=\\\"p-3\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          {documents.map((doc, idx) => (\\n            <Fragment key={doc.id}>\\n              {/* Slot - flex-1 for equal width, fixed height */}\\n              <button\\n                onClick={() => onAddClick(doc)}\\n                className={cn(\\n                  \\\"flex-1 min-w-0 h-24 rounded-lg border-2 transition-all flex flex-col items-center justify-center gap-2 px-2\\\",\\n                  doc.isUploaded\\n                    ? \\\"border-emerald-300 bg-emerald-50 hover:border-emerald-400 hover:shadow-sm\\\"\\n                    : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100\\\"\\n                )}\\n              >\\n                {doc.isUploaded ? (\\n                  <>\\n                    {/* Uploaded state - document preview style */}\\n                    <div className=\\\"relative\\\">\\n                      <div className=\\\"w-10 h-12 rounded bg-white border border-emerald-200 shadow-sm flex flex-col p-1.5 gap-0.5\\\">\",\n    \"numLines\": 300,\n    \"startLine\": 489,\n    \"totalLines\": 1292\n  }\n}","timestamp":1769668559377,"toolName":"Read","toolUseId":"toolu_01LhVbVsURXv9yC9xXgQM3NL","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/ApplicationPage.tsx","offset":1,"limit":100},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"  );\\n}\\n\\n// ============================================================================\\n// Original Summary Section Component (for non-employment sections)\\n// ============================================================================\\nfunction SummarySection({\\n  status,\\n  totalFields,\\n  completedFields,\\n  referenceEvidence,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  referenceEvidence: RequiredEvidence[];\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden\\\">\\n      <div className=\\\"flex items-stretch\\\">\\n        {/* Left - Progress Summary */}\\n        <div className=\\\"shrink-0 p-4 flex items-center gap-4 border-r border-stone-100\\\">\\n          <ProgressRing percent={percent} isComplete={isComplete} size={56} />\\n          <div>\\n            <span\\n              className={cn(\\n                \\\"inline-flex items-center px-2 py-1 text-xs font-semibold rounded-md\\\",\\n                isComplete\\n                  ? \\\"bg-emerald-100 text-emerald-700\\\"\\n                  : \\\"bg-amber-100 text-amber-700\\\"\\n              )}\\n            >\\n              {isComplete ? \\\"Complete\\\" : \\\"In Progress\\\"}\\n            </span>\\n            <p className=\\\"text-sm font-medium text-stone-700 mt-1.5 tabular-nums\\\">\\n              {completedFields}/{totalFields} fields\\n            </p>\\n          </div>\\n        </div>\\n\\n        {/* Right - Reference Documents (flexible width) */}\\n        <div className=\\\"flex-1 p-4\\\">\\n          {/* Header */}\\n          <div className=\\\"flex items-center justify-between mb-3\\\">\\n            <div>\\n              <h4 className=\\\"text-xs font-semibold text-stone-700 text-balance\\\">Reference Documents</h4>\\n              <p className=\\\"text-[10px] text-stone-400 text-pretty\\\">Source files for data extraction</p>\\n            </div>\\n            <button\\n              onClick={onUploadClick}\\n              className=\\\"inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-lg transition-colors\\\"\\n            >\\n              <Plus className=\\\"size-3.5\\\" />\\n              Add\\n            </button>\\n          </div>\\n\\n          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Missing Information Card - Shows fields that still need to be completed\\n// ============================================================================\\nfunction MissingInformationCard({\\n  fields,\\n  formValues,\\n  onFieldChange,\\n  onViewMore,\\n}: {\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onViewMore?: () => void;\\n}) {\\n  const [savingFields, setSavingFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n\\n  // Filter to only show missing fields\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const completedCount = fields.length - missingFields.length;\\n\\n  // Fields to display based on toggle\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    onFieldChange(fieldId, value);\\n    setSavingFields((prev) => new Set(prev).add(fieldId));\\n    setTimeout(() => {\\n      setSavingFields((prev) => {\\n        const next = new Set(prev);\\n        next.delete(fieldId);\\n        return next;\\n      });\\n    }, 1000);\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      <div className=\\\"px-4 py-3 border-b border-stone-100 flex items-center justify-between\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Missing Information</h3>\\n          {missingFields.length > 0 && (\\n            <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n              {missingFields.length}\\n            </span>\\n          )}\\n        </div>\\n        {/* Toggle between showing missing only vs all fields */}\\n        {completedCount > 0 && (\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? (missingFields.length > 0 ? \\\"Show unanswered\\\" : \\\"Hide all\\\") : \\\"Show all\\\"}\\n          </button>\\n        )}\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All information has been provided</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2.5\\\">\\n            {displayFields.slice(0, showAllFields ? undefined : 6).map((field) => {\\n              const currentValue = formValues[field.id] || field.value || \\\"\\\";\\n              const isSaving = savingFields.has(field.id);\\n              const isCompleted = field.status !== \\\"missing\\\";\\n\\n              return (\\n                <div key={field.id} className=\\\"space-y-1.5\\\">\\n                  <div className=\\\"flex items-center gap-2\\\">\\n                    <div className={cn(\\n                      \\\"size-3.5 rounded-full border-2 shrink-0\\\",\\n                      isCompleted ? \\\"bg-emerald-500 border-emerald-500\\\" : \\\"border-amber-400\\\"\\n                    )} />\\n                    <label className=\\\"text-xs font-medium text-stone-600 truncate flex-1\\\">\\n                      {field.label}\\n                    </label>\\n                    {isSaving && (\\n                      <span className=\\\"inline-flex items-center gap-0.5 px-1 py-0.5 text-[9px] font-medium text-emerald-700 bg-emerald-100 rounded\\\">\\n                        <Check className=\\\"size-2\\\" />\\n                        Saved\\n                      </span>\\n                    )}\\n                  </div>\\n\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\"\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\"\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Evidence Slot - Shows grouped document requirements\\n// ============================================================================\\nfunction CombinedEvidenceSlotInline({\\n  title,\\n  relationship,\\n  documents,\\n  onAddClick,\\n}: {\\n  title: string;\\n  relationship: \\\"all\\\" | \\\"any\\\";\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n}) {\\n  const uploadedCount = documents.filter(d => d.isUploaded).length;\\n  const totalCount = documents.length;\\n  const isComplete = relationship === \\\"all\\\"\\n    ? uploadedCount === totalCount\\n    : uploadedCount >= 1;\\n\\n  return (\\n    <div className={cn(\\n      \\\"rounded-xl border-2 overflow-hidden transition-all\\\",\\n      isComplete\\n        ? \\\"border-emerald-300 bg-gradient-to-b from-emerald-50 to-white shadow-sm\\\"\\n        : \\\"border-stone-200 bg-white\\\"\\n    )}>\\n      {/* Header */}\\n      <div className={cn(\\n        \\\"px-3 py-2.5 border-b\\\",\\n        isComplete ? \\\"border-emerald-200 bg-emerald-50\\\" : \\\"border-stone-100 bg-stone-50\\\"\\n      )}>\\n        <div className=\\\"flex items-center justify-between\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            {isComplete && (\\n              <CheckCircle2 className=\\\"size-4 text-emerald-500\\\" />\\n            )}\\n            <span className={cn(\\n              \\\"text-xs font-semibold\\\",\\n              isComplete ? \\\"text-emerald-700\\\" : \\\"text-stone-700\\\"\\n            )}>\\n              {title}\\n            </span>\\n            {/* Relationship badge */}\\n            <span className={cn(\\n              \\\"px-1.5 py-0.5 text-[9px] font-bold uppercase rounded\\\",\\n              isComplete\\n                ? \\\"bg-emerald-200 text-emerald-700\\\"\\n                : relationship === \\\"all\\\"\\n                  ? \\\"bg-stone-200 text-stone-600\\\"\\n                  : \\\"bg-blue-100 text-blue-600\\\"\\n            )}>\\n              {isComplete ? \\\"Complete\\\" : relationship === \\\"all\\\" ? \\\"All required\\\" : \\\"Any one\\\"}\\n            </span>\\n          </div>\\n          <span className={cn(\\n            \\\"text-[10px] font-semibold tabular-nums\\\",\\n            isComplete ? \\\"text-emerald-600\\\" : \\\"text-stone-500\\\"\\n          )}>\\n            {uploadedCount}/{totalCount}\\n          </span>\\n        </div>\\n      </div>\\n\\n      {/* Document slots - horizontal flex layout */}\\n      <div className=\\\"p-3\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          {documents.map((doc, idx) => (\\n            <Fragment key={doc.id}>\\n              {/* Slot - flex-1 for equal width, fixed height */}\\n              <button\\n                onClick={() => onAddClick(doc)}\\n                className={cn(\\n                  \\\"flex-1 min-w-0 h-24 rounded-lg border-2 transition-all flex flex-col items-center justify-center gap-2 px-2\\\",\\n                  doc.isUploaded\\n                    ? \\\"border-emerald-300 bg-emerald-50 hover:border-emerald-400 hover:shadow-sm\\\"\\n                    : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100\\\"\\n                )}\\n              >\\n                {doc.isUploaded ? (\\n                  <>\\n                    {/* Uploaded state - document preview style */}\\n                    <div className=\\\"relative\\\">\\n                      <div className=\\\"w-10 h-12 rounded bg-white border border-emerald-200 shadow-sm flex flex-col p-1.5 gap-0.5\\\">\",\n    \"numLines\": 300,\n    \"startLine\": 489,\n    \"totalLines\": 1292\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668565039-afhoc8","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"                      <div className=\\\"w-10 h-12 rounded bg-white border border-emerald-200 shadow-sm flex flex-col p-1.5 gap-0.5\\\">\\n                        <div className=\\\"h-0.5 bg-emerald-300 rounded w-2/3\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-4/5\\\" />\\n                      </div>\\n                      <div className=\\\"absolute -top-1 -right-1 size-4 rounded-full bg-emerald-500 flex items-center justify-center\\\">\\n                        <Check className=\\\"size-2.5 text-white\\\" strokeWidth={3} />\\n                      </div>\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-emerald-700 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.linkedFileName || doc.name}\\n                    </span>\\n                  </>\\n                ) : (\\n                  <>\\n                    {/* Empty state */}\\n                    <div className=\\\"size-10 rounded-lg bg-white border-2 border-dashed border-stone-300 flex items-center justify-center\\\">\\n                      <Upload className=\\\"size-4 text-stone-400\\\" />\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-stone-500 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.name}\\n                    </span>\\n                  </>\\n                )}\\n              </button>\\n\\n              {/* Connector between slots */}\\n              {idx < documents.length - 1 && (\\n                <div className=\\\"shrink-0 flex items-center justify-center\\\">\\n                  <span className={cn(\\n                    \\\"px-2 py-1 text-[9px] font-bold rounded-full\\\",\\n                    isComplete\\n                      ? \\\"bg-emerald-100 text-emerald-600\\\"\\n                      : relationship === \\\"all\\\"\\n                        ? \\\"bg-stone-100 text-stone-500\\\"\\n                        : \\\"bg-blue-50 text-blue-500\\\"\\n                  )}>\\n                    {relationship === \\\"all\\\" ? \\\"+\\\" : \\\"or\\\"}\\n                  </span>\\n                </div>\\n              )}\\n            </Fragment>\\n          ))}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Supporting Documents Card - Shows all document slots as cards\\n// ============================================================================\\nfunction SupportingDocumentsCard({\\n  documents,\\n  onAddClick,\\n  onViewMore,\\n}: {\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n  onViewMore?: () => void;\\n}) {\\n  // Group documents by type for combined evidence slots\\n  const groupedDocs = useMemo(() => {\\n    // Check if we have bank statements and payslip - combine them as Financial Evidence\\n    const bankStatements = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"bank statement\\\")\\n    );\\n    const payslip = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"payslip\\\")\\n    );\\n\\n    // If we have both bank statements and payslip, group them\\n    if (bankStatements && payslip) {\\n      const financialGroup = {\\n        title: \\\"Financial Evidence\\\",\\n        relationship: \\\"all\\\" as const, // Both bank statements AND payslip required\\n        documents: [bankStatements, payslip],\\n      };\\n\\n      // Get remaining standalone documents\\n      const groupedIds = new Set([bankStatements.id, payslip.id]);\\n      const standalone = documents.filter(d => !groupedIds.has(d.id));\\n\\n      return { groups: [financialGroup], standalone };\\n    }\\n\\n    // No grouping needed\\n    return { groups: [], standalone: documents };\\n  }, [documents]);\\n\\n  // Calculate counts treating combined groups as single items\\n  const counts = useMemo(() => {\\n    // Total = number of groups + number of standalone docs\\n    const totalCount = groupedDocs.groups.length + groupedDocs.standalone.length;\\n\\n    // Uploaded count for groups (based on relationship)\\n    const uploadedGroups = groupedDocs.groups.filter(group => {\\n      const uploadedInGroup = group.documents.filter(d => d.isUploaded).length;\\n      if (group.relationship === \\\"all\\\") {\\n        return uploadedInGroup === group.documents.length;\\n      } else {\\n        return uploadedInGroup >= 1;\\n      }\\n    }).length;\\n\\n    // Uploaded count for standalone docs\\n    const uploadedStandalone = groupedDocs.standalone.filter(d => d.isUploaded).length;\\n\\n    const uploadedCount = uploadedGroups + uploadedStandalone;\\n\\n    return { totalCount, uploadedCount };\\n  }, [groupedDocs]);\\n\\n  const percent = counts.totalCount > 0 ? Math.round((counts.uploadedCount / counts.totalCount) * 100) : 0;\\n  const isComplete = counts.uploadedCount === counts.totalCount && counts.totalCount > 0;\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      {/* Header - matches Application Fields box structure */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-3\\\">\\n          <ProgressRing\\n            percent={percent}\\n            isComplete={isComplete}\\n            size={48}\\n          />\\n          <div className=\\\"flex-1\\\">\\n            <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Supporting Documents</h3>\\n            <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n              {counts.uploadedCount} of {counts.totalCount} uploaded\\n            </p>\\n          </div>\\n        </div>\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {documents.length === 0 ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center text-center py-6\\\">\\n            <div className=\\\"size-10 rounded-full bg-stone-100 flex items-center justify-center mb-3\\\">\\n              <Paperclip className=\\\"size-5 text-stone-400\\\" />\\n            </div>\\n            <p className=\\\"text-sm text-stone-500 text-pretty\\\">No supporting documents required</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-3\\\">\\n            {/* Combined Evidence Groups */}\\n            {groupedDocs.groups.map((group, idx) => (\\n              <CombinedEvidenceSlotInline\\n                key={`group-${idx}`}\\n                title={group.title}\\n                relationship={group.relationship}\\n                documents={group.documents}\\n                onAddClick={onAddClick}\\n              />\\n            ))}\\n\\n            {/* Standalone Documents */}\\n            {groupedDocs.standalone.length > 0 && (\\n              <div className=\\\"space-y-2\\\">\\n                {groupedDocs.standalone.map((doc) => (\\n                  <button\\n                    key={doc.id}\\n                    onClick={() => onAddClick(doc)}\\n                    className={cn(\\n                      \\\"w-full p-3 rounded-lg border-2 transition-colors text-left\\\",\\n                      doc.isUploaded\\n                        ? \\\"border-emerald-200 bg-emerald-50/50 hover:border-emerald-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100/50\\\"\\n                    )}\\n                  >\\n                    <div className=\\\"flex items-start gap-3\\\">\\n                      <div className={cn(\\n                        \\\"size-9 rounded-lg flex items-center justify-center shrink-0\\\",\\n                        doc.isUploaded\\n                          ? \\\"bg-emerald-100\\\"\\n                          : \\\"bg-stone-100 border border-dashed border-stone-300\\\"\\n                      )}>\\n                        {doc.isUploaded ? (\\n                          <FileText className=\\\"size-4 text-emerald-600\\\" />\\n                        ) : (\\n                          <Upload className=\\\"size-4 text-stone-400\\\" />\\n                        )}\\n                      </div>\\n                      <div className=\\\"flex-1 min-w-0\\\">\\n                        <div className=\\\"flex items-center gap-2\\\">\\n                          <span className={cn(\\n                            \\\"text-xs font-medium truncate\\\",\\n                            doc.isUploaded ? \\\"text-stone-700\\\" : \\\"text-stone-600\\\"\\n                          )}>\\n                            {doc.name}\\n                          </span>\\n                          {doc.isUploaded && (\\n                            <CheckCircle2 className=\\\"size-3.5 text-emerald-500 shrink-0\\\" />\\n                          )}\\n                        </div>\\n                        {doc.isUploaded && doc.linkedFileName && (\\n                          <p className=\\\"text-[11px] text-emerald-600 mt-0.5 truncate\\\">\\n                            {doc.linkedFileName}\\n                          </p>\\n                        )}\\n                        {!doc.isUploaded && doc.description && (\\n                          <p className=\\\"text-[10px] text-stone-400 mt-0.5 line-clamp-1 text-pretty\\\">\\n                            {doc.description}\\n                          </p>\\n                        )}\\n                      </div>\\n                      {!doc.isUploaded && (\\n                        <Plus className=\\\"size-4 text-stone-400 shrink-0\\\" />\\n                      )}\\n                    </div>\\n                  </button>\\n                ))}\\n              </div>\\n            )}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Mock extracted data for simulation\\n// ============================================================================\\nconst MOCK_EXTRACTED_DATA: Record<string, { value: string; sourceDoc: string }> = {\\n  \\\"emp-job-title\\\": { value: \\\"Senior Software Engineer\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-soc-code\\\": { value: \\\"2136\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-salary\\\": { value: \\\"£65,000\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-start-date\\\": { value: \\\"2024-03-01\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-name\\\": { value: \\\"Tech Solutions Ltd\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-number\\\": { value: \\\"ABC123456\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-cos-number\\\": { value: \\\"S1234567890\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-working-hours\\\": { value: \\\"37.5 hours per week\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n};\\n\\n// ============================================================================\\n// Main Overview Tab Component\\n// ============================================================================\\nexport function OverviewTab(props: OverviewTabProps) {\\n  const { itemType, formValues, documentGroups, onFieldChange, onNavigateToTab, onReanalyze } = props;\\n  const [selectedEvidence, setSelectedEvidence] = useState<RequiredEvidence | null>(null);\\n  const [previewGroup, setPreviewGroup] = useState<DocumentGroup | null>(null);\\n  const [needsReanalysis, setNeedsReanalysis] = useState(false);\\n\\n  // Analysis simulation state\\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\\n\\n  // Track reference document upload count to detect changes\\n  const prevRefUploadedRef = useRef<number | null>(null);\\n\\n  // Calculate stats\\n  const stats = useMemo(() => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      const completedFields = items.filter((i) => !!formValues[i.id] || !!i.value).length;\\n      const totalFields = items.length;\\n\\n      // Collect all evidence from items\\n      const evidenceMap = new Map<string, RequiredEvidence>();\\n      items.forEach((item) => {\\n        item.requiredEvidence?.forEach((ev) => {\\n          if (!evidenceMap.has(ev.id)) {\\n            evidenceMap.set(ev.id, ev);\\n          }\\n        });\\n      });\\n      const allEvidence = Array.from(evidenceMap.values());\\n\\n      // Reference docs: passport, CoS, etc. (used for data extraction)\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else (evidence for proof)\\n      const supportingEvidence = allEvidence.filter((ev) =>\\n        !referenceEvidence.includes(ev)\\n      );\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    } else {\\n      // Assessment type\\n      const fields = props.fields;\\n      const completedFields = fields.filter((f) => !!formValues[f.id]).length;\\n      const totalFields = fields.length;\\n      const allEvidence = props.requiredEvidence || [];\\n\\n      // Reference docs for assessment\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else\\n      const supportingEvidence = allEvidence.filter((ev) => !referenceEvidence.includes(ev));\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Prepare all fields for display\\n  const displayFields = useMemo((): DisplayField[] => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      return items.map((item) => {\\n        const hasValue = !!formValues[item.id] || !!item.value;\\n        const isLowConfidence = item.source === \\\"extracted\\\" &&\\n          item.confidenceScore !== undefined &&\\n          item.confidenceScore < 80;\\n\\n        // Get source document name from linkedDocuments\\n        const sourceDocName = item.source === \\\"extracted\\\" && item.linkedDocuments?.length > 0\\n          ? item.linkedDocuments[0].groupTitle || item.linkedDocuments[0].fileName\\n          : undefined;\\n\\n        return {\\n          id: item.id,\\n          label: item.label,\\n          value: formValues[item.id] || item.value,\\n          source: item.source,\\n          sourceDocumentName: sourceDocName,\\n          status: isLowConfidence ? \\\"low_confidence\\\" : (hasValue ? \\\"complete\\\" : \\\"missing\\\"),\\n          fieldType: \\\"text\\\",\\n          confidenceScore: item.confidenceScore,\\n        };\\n      });\\n    } else {\\n      const fields = props.fields;\\n      return fields.map((field) => ({\\n        id: field.id,\\n        label: field.label,\\n        value: formValues[field.id] || field.value,\\n        source: formValues[field.id] ? \\\"manual\\\" : null,\\n        status: formValues[field.id] ? \\\"complete\\\" : \\\"missing\\\",\\n        fieldType: field.type === \\\"select\\\" ? \\\"select\\\" : \\\"text\\\",\\n        options: field.options,\\n      }));\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Status helpers\\n  const getFieldStatus = () => {\\n    if (stats.completedFields === stats.totalFields) return \\\"complete\\\";\\n    if (stats.completedFields > 0) return \\\"partial\\\";\\n    return \\\"empty\\\";\\n  };\\n\\n  const refUploaded = stats.referenceEvidence.filter((e) => e.isUploaded).length;\\n\\n  // Handle reference doc click - find linked group and open preview\\n  const handleReferenceDocClick = (evidence: RequiredEvidence) => {\\n    if (evidence.linkedFileId) {\\n      // Find the group containing this file\\n      const group = documentGroups.find((g) =>\\n        g.files.some((f) => f.id === evidence.linkedFileId)\\n      );\\n      if (group) {\\n        setPreviewGroup(group);\\n        return;\\n      }\\n    }\\n    // Fallback: open upload modal\\n    setSelectedEvidence(evidence);\\n  };\\n\\n  const handleUploadClick = () => {\\n    const firstRef = stats.referenceEvidence.find((e) => !e.isUploaded);\\n    if (firstRef) {\\n      setSelectedEvidence(firstRef);\\n    } else if (stats.referenceEvidence.length > 0) {\\n      setSelectedEvidence(stats.referenceEvidence[0]);\\n    }\\n  };\\n\\n  // Simulate document analysis\\n  const handleAnalyze = () => {\\n    if (isAnalyzing) return;\\n\\n    setIsAnalyzing(true);\\n\\n    // Simulate analysis delay\\n    setTimeout(() => {\\n      // Find empty fields and populate them with mock data\\n      if (itemType === \\\"checklist\\\") {\\n        let filledCount = 0;\\n\\n        props.items.forEach((item) => {\\n          const hasValue = !!formValues[item.id] || !!item.value;\\n          if (!hasValue) {\\n            // Check if we have mock data for this field\\n            const mockData = MOCK_EXTRACTED_DATA[item.id];\\n            if (mockData) {\\n              onFieldChange(item.id, mockData.value);\\n              filledCount++;\\n            }\\n          }\\n        });\\n\\n        // If no specific mock data, fill first 3 empty fields with generic data\\n        if (filledCount === 0) {\\n          const emptyItems = props.items.filter(\\n            (item) => !formValues[item.id] && !item.value\\n          ).slice(0, 3);\\n\\n          emptyItems.forEach((item, index) => {\\n            const genericValues = [\\\"Sample Value 1\\\", \\\"Sample Value 2\\\", \\\"Sample Value 3\\\"];\\n            onFieldChange(item.id, genericValues[index] || \\\"Extracted Value\\\");\\n          });\\n        }\\n      }\\n\\n      setIsAnalyzing(false);\\n      setNeedsReanalysis(false);\\n    }, 1500); // 1.5 second analysis simulation\\n  };\\n\\n  // Auto-analyze when new reference documents are added\\n  useEffect(() => {\\n    if (prevRefUploadedRef.current !== null && refUploaded > prevRefUploadedRef.current) {\\n      // Auto-trigger analysis when new document is uploaded\\n      handleAnalyze();\\n    }\\n    prevRefUploadedRef.current = refUploaded;\\n  }, [refUploaded]); // eslint-disable-line react-hooks/exhaustive-deps\\n\\n  return (\\n    <>\\n      <div className=\\\"h-full flex flex-col min-h-0\\\">\\n        <div className=\\\"flex-1 p-6 min-h-0 h-full\\\">\\n          {/* Unified layout for all sections: 2:1 grid for Fields : Supporting Documents */}\\n          <div className=\\\"grid grid-cols-3 gap-4 h-full\\\">\\n            <div className=\\\"col-span-2 h-full min-h-0 flex flex-col\\\">\\n              <SummaryFieldsCard\\n                status={getFieldStatus()}\\n                totalFields={stats.totalFields}\\n                completedFields={stats.completedFields}\\n                fields={displayFields}\\n                formValues={formValues}\\n                referenceEvidence={stats.referenceEvidence}\\n                isAnalyzing={isAnalyzing}\\n                onFieldChange={onFieldChange}\\n                onReferenceDocClick={handleReferenceDocClick}\\n                onUploadClick={handleUploadClick}\\n              />\\n            </div>\\n            <SupportingDocumentsCard\\n              documents={stats.supportingEvidence}\\n              onAddClick={(evidence) => setSelectedEvidence(evidence)}\\n              onViewMore={() => onNavigateToTab?.(\\\"supporting-documents\\\")}\\n            />\\n          </div>\\n        </div>\\n\\n        {/* Footer with Analyze button */}\\n        {needsReanalysis && onReanalyze && (\\n          <div className=\\\"shrink-0 px-6 py-3 border-t border-stone-200 bg-stone-50\\\">\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <p className=\\\"text-sm text-stone-600 text-pretty\\\">\\n                Reference documents ready for analysis.\\n              </p>\\n              <button\\n                onClick={handleAnalyze}\\n                className=\\\"inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors\\\"\\n              >\\n                <Sparkles className=\\\"size-4\\\" />\\n                Analyze\\n              </button>\\n            </div>\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Document Upload Modal */}\\n      {selectedEvidence && (\\n        <DocumentUploadModal\\n          evidence={selectedEvidence}\\n          onClose={() => setSelectedEvidence(null)}\\n        />\\n      )}\\n\\n      {/* Document Preview Modal */}\\n      {previewGroup && (\\n        <CategoryReviewModal\\n          group={previewGroup}\\n          allGroups={documentGroups}\\n          onClose={() => setPreviewGroup(null)}\\n        />\",\n    \"numLines\": 500,\n    \"startLine\": 788,\n    \"totalLines\": 1292\n  }\n}","timestamp":1769668565039,"toolName":"Read","toolUseId":"toolu_014tLKdQtSX1VC5i4wmgqwFu","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","offset":500,"limit":200},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"                      <div className=\\\"w-10 h-12 rounded bg-white border border-emerald-200 shadow-sm flex flex-col p-1.5 gap-0.5\\\">\\n                        <div className=\\\"h-0.5 bg-emerald-300 rounded w-2/3\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-4/5\\\" />\\n                      </div>\\n                      <div className=\\\"absolute -top-1 -right-1 size-4 rounded-full bg-emerald-500 flex items-center justify-center\\\">\\n                        <Check className=\\\"size-2.5 text-white\\\" strokeWidth={3} />\\n                      </div>\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-emerald-700 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.linkedFileName || doc.name}\\n                    </span>\\n                  </>\\n                ) : (\\n                  <>\\n                    {/* Empty state */}\\n                    <div className=\\\"size-10 rounded-lg bg-white border-2 border-dashed border-stone-300 flex items-center justify-center\\\">\\n                      <Upload className=\\\"size-4 text-stone-400\\\" />\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-stone-500 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.name}\\n                    </span>\\n                  </>\\n                )}\\n              </button>\\n\\n              {/* Connector between slots */}\\n              {idx < documents.length - 1 && (\\n                <div className=\\\"shrink-0 flex items-center justify-center\\\">\\n                  <span className={cn(\\n                    \\\"px-2 py-1 text-[9px] font-bold rounded-full\\\",\\n                    isComplete\\n                      ? \\\"bg-emerald-100 text-emerald-600\\\"\\n                      : relationship === \\\"all\\\"\\n                        ? \\\"bg-stone-100 text-stone-500\\\"\\n                        : \\\"bg-blue-50 text-blue-500\\\"\\n                  )}>\\n                    {relationship === \\\"all\\\" ? \\\"+\\\" : \\\"or\\\"}\\n                  </span>\\n                </div>\\n              )}\\n            </Fragment>\\n          ))}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Supporting Documents Card - Shows all document slots as cards\\n// ============================================================================\\nfunction SupportingDocumentsCard({\\n  documents,\\n  onAddClick,\\n  onViewMore,\\n}: {\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n  onViewMore?: () => void;\\n}) {\\n  // Group documents by type for combined evidence slots\\n  const groupedDocs = useMemo(() => {\\n    // Check if we have bank statements and payslip - combine them as Financial Evidence\\n    const bankStatements = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"bank statement\\\")\\n    );\\n    const payslip = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"payslip\\\")\\n    );\\n\\n    // If we have both bank statements and payslip, group them\\n    if (bankStatements && payslip) {\\n      const financialGroup = {\\n        title: \\\"Financial Evidence\\\",\\n        relationship: \\\"all\\\" as const, // Both bank statements AND payslip required\\n        documents: [bankStatements, payslip],\\n      };\\n\\n      // Get remaining standalone documents\\n      const groupedIds = new Set([bankStatements.id, payslip.id]);\\n      const standalone = documents.filter(d => !groupedIds.has(d.id));\\n\\n      return { groups: [financialGroup], standalone };\\n    }\\n\\n    // No grouping needed\\n    return { groups: [], standalone: documents };\\n  }, [documents]);\\n\\n  // Calculate counts treating combined groups as single items\\n  const counts = useMemo(() => {\\n    // Total = number of groups + number of standalone docs\\n    const totalCount = groupedDocs.groups.length + groupedDocs.standalone.length;\\n\\n    // Uploaded count for groups (based on relationship)\\n    const uploadedGroups = groupedDocs.groups.filter(group => {\\n      const uploadedInGroup = group.documents.filter(d => d.isUploaded).length;\\n      if (group.relationship === \\\"all\\\") {\\n        return uploadedInGroup === group.documents.length;\\n      } else {\\n        return uploadedInGroup >= 1;\\n      }\\n    }).length;\\n\\n    // Uploaded count for standalone docs\\n    const uploadedStandalone = groupedDocs.standalone.filter(d => d.isUploaded).length;\\n\\n    const uploadedCount = uploadedGroups + uploadedStandalone;\\n\\n    return { totalCount, uploadedCount };\\n  }, [groupedDocs]);\\n\\n  const percent = counts.totalCount > 0 ? Math.round((counts.uploadedCount / counts.totalCount) * 100) : 0;\\n  const isComplete = counts.uploadedCount === counts.totalCount && counts.totalCount > 0;\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      {/* Header - matches Application Fields box structure */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-3\\\">\\n          <ProgressRing\\n            percent={percent}\\n            isComplete={isComplete}\\n            size={48}\\n          />\\n          <div className=\\\"flex-1\\\">\\n            <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Supporting Documents</h3>\\n            <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n              {counts.uploadedCount} of {counts.totalCount} uploaded\\n            </p>\\n          </div>\\n        </div>\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {documents.length === 0 ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center text-center py-6\\\">\\n            <div className=\\\"size-10 rounded-full bg-stone-100 flex items-center justify-center mb-3\\\">\\n              <Paperclip className=\\\"size-5 text-stone-400\\\" />\\n            </div>\\n            <p className=\\\"text-sm text-stone-500 text-pretty\\\">No supporting documents required</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-3\\\">\\n            {/* Combined Evidence Groups */}\\n            {groupedDocs.groups.map((group, idx) => (\\n              <CombinedEvidenceSlotInline\\n                key={`group-${idx}`}\\n                title={group.title}\\n                relationship={group.relationship}\\n                documents={group.documents}\\n                onAddClick={onAddClick}\\n              />\\n            ))}\\n\\n            {/* Standalone Documents */}\\n            {groupedDocs.standalone.length > 0 && (\\n              <div className=\\\"space-y-2\\\">\\n                {groupedDocs.standalone.map((doc) => (\\n                  <button\\n                    key={doc.id}\\n                    onClick={() => onAddClick(doc)}\\n                    className={cn(\\n                      \\\"w-full p-3 rounded-lg border-2 transition-colors text-left\\\",\\n                      doc.isUploaded\\n                        ? \\\"border-emerald-200 bg-emerald-50/50 hover:border-emerald-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100/50\\\"\\n                    )}\\n                  >\\n                    <div className=\\\"flex items-start gap-3\\\">\\n                      <div className={cn(\\n                        \\\"size-9 rounded-lg flex items-center justify-center shrink-0\\\",\\n                        doc.isUploaded\\n                          ? \\\"bg-emerald-100\\\"\\n                          : \\\"bg-stone-100 border border-dashed border-stone-300\\\"\\n                      )}>\\n                        {doc.isUploaded ? (\\n                          <FileText className=\\\"size-4 text-emerald-600\\\" />\\n                        ) : (\\n                          <Upload className=\\\"size-4 text-stone-400\\\" />\\n                        )}\\n                      </div>\\n                      <div className=\\\"flex-1 min-w-0\\\">\\n                        <div className=\\\"flex items-center gap-2\\\">\\n                          <span className={cn(\\n                            \\\"text-xs font-medium truncate\\\",\\n                            doc.isUploaded ? \\\"text-stone-700\\\" : \\\"text-stone-600\\\"\\n                          )}>\\n                            {doc.name}\\n                          </span>\\n                          {doc.isUploaded && (\\n                            <CheckCircle2 className=\\\"size-3.5 text-emerald-500 shrink-0\\\" />\\n                          )}\\n                        </div>\\n                        {doc.isUploaded && doc.linkedFileName && (\\n                          <p className=\\\"text-[11px] text-emerald-600 mt-0.5 truncate\\\">\\n                            {doc.linkedFileName}\\n                          </p>\\n                        )}\\n                        {!doc.isUploaded && doc.description && (\\n                          <p className=\\\"text-[10px] text-stone-400 mt-0.5 line-clamp-1 text-pretty\\\">\\n                            {doc.description}\\n                          </p>\\n                        )}\\n                      </div>\\n                      {!doc.isUploaded && (\\n                        <Plus className=\\\"size-4 text-stone-400 shrink-0\\\" />\\n                      )}\\n                    </div>\\n                  </button>\\n                ))}\\n              </div>\\n            )}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Mock extracted data for simulation\\n// ============================================================================\\nconst MOCK_EXTRACTED_DATA: Record<string, { value: string; sourceDoc: string }> = {\\n  \\\"emp-job-title\\\": { value: \\\"Senior Software Engineer\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-soc-code\\\": { value: \\\"2136\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-salary\\\": { value: \\\"£65,000\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-start-date\\\": { value: \\\"2024-03-01\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-name\\\": { value: \\\"Tech Solutions Ltd\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-number\\\": { value: \\\"ABC123456\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-cos-number\\\": { value: \\\"S1234567890\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-working-hours\\\": { value: \\\"37.5 hours per week\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n};\\n\\n// ============================================================================\\n// Main Overview Tab Component\\n// ============================================================================\\nexport function OverviewTab(props: OverviewTabProps) {\\n  const { itemType, formValues, documentGroups, onFieldChange, onNavigateToTab, onReanalyze } = props;\\n  const [selectedEvidence, setSelectedEvidence] = useState<RequiredEvidence | null>(null);\\n  const [previewGroup, setPreviewGroup] = useState<DocumentGroup | null>(null);\\n  const [needsReanalysis, setNeedsReanalysis] = useState(false);\\n\\n  // Analysis simulation state\\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\\n\\n  // Track reference document upload count to detect changes\\n  const prevRefUploadedRef = useRef<number | null>(null);\\n\\n  // Calculate stats\\n  const stats = useMemo(() => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      const completedFields = items.filter((i) => !!formValues[i.id] || !!i.value).length;\\n      const totalFields = items.length;\\n\\n      // Collect all evidence from items\\n      const evidenceMap = new Map<string, RequiredEvidence>();\\n      items.forEach((item) => {\\n        item.requiredEvidence?.forEach((ev) => {\\n          if (!evidenceMap.has(ev.id)) {\\n            evidenceMap.set(ev.id, ev);\\n          }\\n        });\\n      });\\n      const allEvidence = Array.from(evidenceMap.values());\\n\\n      // Reference docs: passport, CoS, etc. (used for data extraction)\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else (evidence for proof)\\n      const supportingEvidence = allEvidence.filter((ev) =>\\n        !referenceEvidence.includes(ev)\\n      );\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    } else {\\n      // Assessment type\\n      const fields = props.fields;\\n      const completedFields = fields.filter((f) => !!formValues[f.id]).length;\\n      const totalFields = fields.length;\\n      const allEvidence = props.requiredEvidence || [];\\n\\n      // Reference docs for assessment\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else\\n      const supportingEvidence = allEvidence.filter((ev) => !referenceEvidence.includes(ev));\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Prepare all fields for display\\n  const displayFields = useMemo((): DisplayField[] => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      return items.map((item) => {\\n        const hasValue = !!formValues[item.id] || !!item.value;\\n        const isLowConfidence = item.source === \\\"extracted\\\" &&\\n          item.confidenceScore !== undefined &&\\n          item.confidenceScore < 80;\\n\\n        // Get source document name from linkedDocuments\\n        const sourceDocName = item.source === \\\"extracted\\\" && item.linkedDocuments?.length > 0\\n          ? item.linkedDocuments[0].groupTitle || item.linkedDocuments[0].fileName\\n          : undefined;\\n\\n        return {\\n          id: item.id,\\n          label: item.label,\\n          value: formValues[item.id] || item.value,\\n          source: item.source,\\n          sourceDocumentName: sourceDocName,\\n          status: isLowConfidence ? \\\"low_confidence\\\" : (hasValue ? \\\"complete\\\" : \\\"missing\\\"),\\n          fieldType: \\\"text\\\",\\n          confidenceScore: item.confidenceScore,\\n        };\\n      });\\n    } else {\\n      const fields = props.fields;\\n      return fields.map((field) => ({\\n        id: field.id,\\n        label: field.label,\\n        value: formValues[field.id] || field.value,\\n        source: formValues[field.id] ? \\\"manual\\\" : null,\\n        status: formValues[field.id] ? \\\"complete\\\" : \\\"missing\\\",\\n        fieldType: field.type === \\\"select\\\" ? \\\"select\\\" : \\\"text\\\",\\n        options: field.options,\\n      }));\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Status helpers\\n  const getFieldStatus = () => {\\n    if (stats.completedFields === stats.totalFields) return \\\"complete\\\";\\n    if (stats.completedFields > 0) return \\\"partial\\\";\\n    return \\\"empty\\\";\\n  };\\n\\n  const refUploaded = stats.referenceEvidence.filter((e) => e.isUploaded).length;\\n\\n  // Handle reference doc click - find linked group and open preview\\n  const handleReferenceDocClick = (evidence: RequiredEvidence) => {\\n    if (evidence.linkedFileId) {\\n      // Find the group containing this file\\n      const group = documentGroups.find((g) =>\\n        g.files.some((f) => f.id === evidence.linkedFileId)\\n      );\\n      if (group) {\\n        setPreviewGroup(group);\\n        return;\\n      }\\n    }\\n    // Fallback: open upload modal\\n    setSelectedEvidence(evidence);\\n  };\\n\\n  const handleUploadClick = () => {\\n    const firstRef = stats.referenceEvidence.find((e) => !e.isUploaded);\\n    if (firstRef) {\\n      setSelectedEvidence(firstRef);\\n    } else if (stats.referenceEvidence.length > 0) {\\n      setSelectedEvidence(stats.referenceEvidence[0]);\\n    }\\n  };\\n\\n  // Simulate document analysis\\n  const handleAnalyze = () => {\\n    if (isAnalyzing) return;\\n\\n    setIsAnalyzing(true);\\n\\n    // Simulate analysis delay\\n    setTimeout(() => {\\n      // Find empty fields and populate them with mock data\\n      if (itemType === \\\"checklist\\\") {\\n        let filledCount = 0;\\n\\n        props.items.forEach((item) => {\\n          const hasValue = !!formValues[item.id] || !!item.value;\\n          if (!hasValue) {\\n            // Check if we have mock data for this field\\n            const mockData = MOCK_EXTRACTED_DATA[item.id];\\n            if (mockData) {\\n              onFieldChange(item.id, mockData.value);\\n              filledCount++;\\n            }\\n          }\\n        });\\n\\n        // If no specific mock data, fill first 3 empty fields with generic data\\n        if (filledCount === 0) {\\n          const emptyItems = props.items.filter(\\n            (item) => !formValues[item.id] && !item.value\\n          ).slice(0, 3);\\n\\n          emptyItems.forEach((item, index) => {\\n            const genericValues = [\\\"Sample Value 1\\\", \\\"Sample Value 2\\\", \\\"Sample Value 3\\\"];\\n            onFieldChange(item.id, genericValues[index] || \\\"Extracted Value\\\");\\n          });\\n        }\\n      }\\n\\n      setIsAnalyzing(false);\\n      setNeedsReanalysis(false);\\n    }, 1500); // 1.5 second analysis simulation\\n  };\\n\\n  // Auto-analyze when new reference documents are added\\n  useEffect(() => {\\n    if (prevRefUploadedRef.current !== null && refUploaded > prevRefUploadedRef.current) {\\n      // Auto-trigger analysis when new document is uploaded\\n      handleAnalyze();\\n    }\\n    prevRefUploadedRef.current = refUploaded;\\n  }, [refUploaded]); // eslint-disable-line react-hooks/exhaustive-deps\\n\\n  return (\\n    <>\\n      <div className=\\\"h-full flex flex-col min-h-0\\\">\\n        <div className=\\\"flex-1 p-6 min-h-0 h-full\\\">\\n          {/* Unified layout for all sections: 2:1 grid for Fields : Supporting Documents */}\\n          <div className=\\\"grid grid-cols-3 gap-4 h-full\\\">\\n            <div className=\\\"col-span-2 h-full min-h-0 flex flex-col\\\">\\n              <SummaryFieldsCard\\n                status={getFieldStatus()}\\n                totalFields={stats.totalFields}\\n                completedFields={stats.completedFields}\\n                fields={displayFields}\\n                formValues={formValues}\\n                referenceEvidence={stats.referenceEvidence}\\n                isAnalyzing={isAnalyzing}\\n                onFieldChange={onFieldChange}\\n                onReferenceDocClick={handleReferenceDocClick}\\n                onUploadClick={handleUploadClick}\\n              />\\n            </div>\\n            <SupportingDocumentsCard\\n              documents={stats.supportingEvidence}\\n              onAddClick={(evidence) => setSelectedEvidence(evidence)}\\n              onViewMore={() => onNavigateToTab?.(\\\"supporting-documents\\\")}\\n            />\\n          </div>\\n        </div>\\n\\n        {/* Footer with Analyze button */}\\n        {needsReanalysis && onReanalyze && (\\n          <div className=\\\"shrink-0 px-6 py-3 border-t border-stone-200 bg-stone-50\\\">\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <p className=\\\"text-sm text-stone-600 text-pretty\\\">\\n                Reference documents ready for analysis.\\n              </p>\\n              <button\\n                onClick={handleAnalyze}\\n                className=\\\"inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors\\\"\\n              >\\n                <Sparkles className=\\\"size-4\\\" />\\n                Analyze\\n              </button>\\n            </div>\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Document Upload Modal */}\\n      {selectedEvidence && (\\n        <DocumentUploadModal\\n          evidence={selectedEvidence}\\n          onClose={() => setSelectedEvidence(null)}\\n        />\\n      )}\\n\\n      {/* Document Preview Modal */}\\n      {previewGroup && (\\n        <CategoryReviewModal\\n          group={previewGroup}\\n          allGroups={documentGroups}\\n          onClose={() => setPreviewGroup(null)}\\n        />\",\n    \"numLines\": 500,\n    \"startLine\": 788,\n    \"totalLines\": 1292\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668565558-tbx4gt","type":"tool","content":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"55:    id: \\\"passport\\\",\\n56:    title: \\\"Passport\\\",\\n62:        id: \\\"pp_1\\\",\\n71:        id: \\\"pp_2\\\",\\n80:        id: \\\"pp_3\\\",\\n89:        id: \\\"pp_4\\\",\\n98:        id: \\\"pp_5\\\",\\n107:        id: \\\"pp_6\\\",\\n118:    id: \\\"bank_statement\\\",\\n119:    title: \\\"Bank Statement\\\",\\n125:        id: \\\"bs_1\\\",\\n134:        id: \\\"bs_2\\\",\\n143:        id: \\\"bs_3\\\",\\n152:        id: \\\"bs_4\\\",\\n161:        id: \\\"bs_5\\\",\\n170:        id: \\\"bs_6\\\",\\n179:        id: \\\"bs_7\\\",\\n188:        id: \\\"bs_8\\\",\\n197:        id: \\\"bs_9\\\",\\n206:        id: \\\"bs_10\\\",\\n215:        id: \\\"bs_11\\\",\\n224:        id: \\\"bs_12\\\",\\n235:    id: \\\"employment_letter\\\",\\n236:    title: \\\"Employment Letter\\\",\\n242:        id: \\\"emp_1\\\",\\n251:        id: \\\"emp_2\\\",\\n260:        id: \\\"emp_3\\\",\\n269:        id: \\\"emp_4\\\",\\n278:        id: \\\"emp_5\\\",\\n289:    id: \\\"utility_bill\\\",\\n290:    title: \\\"Utility Bill\\\",\\n296:        id: \\\"ub_1\\\",\\n305:        id: \\\"ub_2\\\",\\n314:        id: \\\"ub_3\\\",\\n323:        id: \\\"ub_4\\\",\\n332:        id: \\\"ub_5\\\",\\n341:        id: \\\"ub_6\\\",\\n350:        id: \\\"ub_7\\\",\\n359:        id: \\\"ub_8\\\",\\n370:    id: \\\"tax_documents\\\",\\n371:    title: \\\"Tax Documents\\\",\\n377:        id: \\\"tax_1\\\",\\n386:        id: \\\"tax_2\\\",\\n395:        id: \\\"tax_3\\\",\\n404:        id: \\\"tax_4\\\",\\n413:        id: \\\"tax_5\\\",\\n422:        id: \\\"tax_6\\\",\\n433:    id: \\\"education\\\",\\n434:    title: \\\"Education Certificates\\\",\\n440:        id: \\\"edu_1\\\",\\n449:        id: \\\"edu_2\\\",\\n458:        id: \\\"edu_3\\\",\\n467:        id: \\\"edu_4\\\",\\n476:        id: \\\"edu_5\\\",\\n485:        id: \\\"edu_6\\\",\\n494:        id: \\\"edu_7\\\",\\n505:    id: \\\"travel_history\\\",\\n506:    title: \\\"Travel History\\\",\\n512:        id: \\\"travel_1\\\",\\n521:        id: \\\"travel_2\\\",\",\n  \"numLines\": 60,\n  \"appliedLimit\": 60\n}","timestamp":1769668565558,"toolName":"Grep","toolUseId":"toolu_019p6UmR37QREqQvAv8BFjbW","toolInput":{"pattern":"uploadForEvidence|linkEvidenceToGroup|generateEnhancedChecklist","type":"ts","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2"},"toolResult":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"55:    id: \\\"passport\\\",\\n56:    title: \\\"Passport\\\",\\n62:        id: \\\"pp_1\\\",\\n71:        id: \\\"pp_2\\\",\\n80:        id: \\\"pp_3\\\",\\n89:        id: \\\"pp_4\\\",\\n98:        id: \\\"pp_5\\\",\\n107:        id: \\\"pp_6\\\",\\n118:    id: \\\"bank_statement\\\",\\n119:    title: \\\"Bank Statement\\\",\\n125:        id: \\\"bs_1\\\",\\n134:        id: \\\"bs_2\\\",\\n143:        id: \\\"bs_3\\\",\\n152:        id: \\\"bs_4\\\",\\n161:        id: \\\"bs_5\\\",\\n170:        id: \\\"bs_6\\\",\\n179:        id: \\\"bs_7\\\",\\n188:        id: \\\"bs_8\\\",\\n197:        id: \\\"bs_9\\\",\\n206:        id: \\\"bs_10\\\",\\n215:        id: \\\"bs_11\\\",\\n224:        id: \\\"bs_12\\\",\\n235:    id: \\\"employment_letter\\\",\\n236:    title: \\\"Employment Letter\\\",\\n242:        id: \\\"emp_1\\\",\\n251:        id: \\\"emp_2\\\",\\n260:        id: \\\"emp_3\\\",\\n269:        id: \\\"emp_4\\\",\\n278:        id: \\\"emp_5\\\",\\n289:    id: \\\"utility_bill\\\",\\n290:    title: \\\"Utility Bill\\\",\\n296:        id: \\\"ub_1\\\",\\n305:        id: \\\"ub_2\\\",\\n314:        id: \\\"ub_3\\\",\\n323:        id: \\\"ub_4\\\",\\n332:        id: \\\"ub_5\\\",\\n341:        id: \\\"ub_6\\\",\\n350:        id: \\\"ub_7\\\",\\n359:        id: \\\"ub_8\\\",\\n370:    id: \\\"tax_documents\\\",\\n371:    title: \\\"Tax Documents\\\",\\n377:        id: \\\"tax_1\\\",\\n386:        id: \\\"tax_2\\\",\\n395:        id: \\\"tax_3\\\",\\n404:        id: \\\"tax_4\\\",\\n413:        id: \\\"tax_5\\\",\\n422:        id: \\\"tax_6\\\",\\n433:    id: \\\"education\\\",\\n434:    title: \\\"Education Certificates\\\",\\n440:        id: \\\"edu_1\\\",\\n449:        id: \\\"edu_2\\\",\\n458:        id: \\\"edu_3\\\",\\n467:        id: \\\"edu_4\\\",\\n476:        id: \\\"edu_5\\\",\\n485:        id: \\\"edu_6\\\",\\n494:        id: \\\"edu_7\\\",\\n505:    id: \\\"travel_history\\\",\\n506:    title: \\\"Travel History\\\",\\n512:        id: \\\"travel_1\\\",\\n521:        id: \\\"travel_2\\\",\",\n  \"numLines\": 60,\n  \"appliedLimit\": 60\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Search","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668568999-ll5qsr","type":"tool","content":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"449:        id: \\\"edu_2\\\",\\n458:        id: \\\"edu_3\\\",\\n467:        id: \\\"edu_4\\\",\\n476:        id: \\\"edu_5\\\",\\n485:        id: \\\"edu_6\\\",\\n494:        id: \\\"edu_7\\\",\\n505:    id: \\\"travel_history\\\",\\n506:    title: \\\"Travel History\\\",\\n512:        id: \\\"travel_1\\\",\\n521:        id: \\\"travel_2\\\",\\n530:        id: \\\"travel_3\\\",\\n539:        id: \\\"travel_4\\\",\\n548:        id: \\\"travel_5\\\",\\n559:    id: \\\"unclassified\\\",\\n560:    title: \\\"Unclassified\\\",\\n565:        id: \\\"u1\\\",\\n574:        id: \\\"u2\\\",\\n583:        id: \\\"u3\\\",\\n592:        id: \\\"u4\\\",\\n601:        id: \\\"u5\\\",\\n610:        id: \\\"u6\\\",\\n619:        id: \\\"u7\\\",\\n628:        id: \\\"u8\\\",\\n653:    id: \\\"q1\\\",\\n659:    id: \\\"q2\\\",\\n665:    id: \\\"q3\\\",\\n671:    id: \\\"q4\\\",\\n684:    id: \\\"q5\\\",\\n695:    id: \\\"identity\\\",\\n706:    id: \\\"financial\\\",\\n713:        id: \\\"bank-statements\\\",\\n718:        id: \\\"employment-letter\\\",\\n726:    id: \\\"sponsorship\\\",\\n737:    id: \\\"english\\\",\\n2885:            id: \\\"given_names\\\",\\n2896:            id: \\\"surname\\\",\\n2907:            id: \\\"dob\\\",\\n2918:            id: \\\"place_of_birth\\\",\\n2929:            id: \\\"gender\\\",\\n2940:            id: \\\"passport_number\\\",\",\n  \"numLines\": 40,\n  \"appliedLimit\": 40,\n  \"appliedOffset\": 50\n}","timestamp":1769668568999,"toolName":"Bash","toolUseId":"toolu_01HekZn4sUCxkUA1YVYyTLLE","toolInput":{"command":"grep -n \"uploadForEvidence\\|linkEvidenceToGroup\\|generateEnhancedChecklist\" ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts | head -30","description":"Find key evidence linking methods in store"},"toolResult":"{\n  \"mode\": \"content\",\n  \"numFiles\": 0,\n  \"filenames\": [],\n  \"content\": \"449:        id: \\\"edu_2\\\",\\n458:        id: \\\"edu_3\\\",\\n467:        id: \\\"edu_4\\\",\\n476:        id: \\\"edu_5\\\",\\n485:        id: \\\"edu_6\\\",\\n494:        id: \\\"edu_7\\\",\\n505:    id: \\\"travel_history\\\",\\n506:    title: \\\"Travel History\\\",\\n512:        id: \\\"travel_1\\\",\\n521:        id: \\\"travel_2\\\",\\n530:        id: \\\"travel_3\\\",\\n539:        id: \\\"travel_4\\\",\\n548:        id: \\\"travel_5\\\",\\n559:    id: \\\"unclassified\\\",\\n560:    title: \\\"Unclassified\\\",\\n565:        id: \\\"u1\\\",\\n574:        id: \\\"u2\\\",\\n583:        id: \\\"u3\\\",\\n592:        id: \\\"u4\\\",\\n601:        id: \\\"u5\\\",\\n610:        id: \\\"u6\\\",\\n619:        id: \\\"u7\\\",\\n628:        id: \\\"u8\\\",\\n653:    id: \\\"q1\\\",\\n659:    id: \\\"q2\\\",\\n665:    id: \\\"q3\\\",\\n671:    id: \\\"q4\\\",\\n684:    id: \\\"q5\\\",\\n695:    id: \\\"identity\\\",\\n706:    id: \\\"financial\\\",\\n713:        id: \\\"bank-statements\\\",\\n718:        id: \\\"employment-letter\\\",\\n726:    id: \\\"sponsorship\\\",\\n737:    id: \\\"english\\\",\\n2885:            id: \\\"given_names\\\",\\n2896:            id: \\\"surname\\\",\\n2907:            id: \\\"dob\\\",\\n2918:            id: \\\"place_of_birth\\\",\\n2929:            id: \\\"gender\\\",\\n2940:            id: \\\"passport_number\\\",\",\n  \"numLines\": 40,\n  \"appliedLimit\": 40,\n  \"appliedOffset\": 50\n}","toolStatus":"completed","toolIntent":"Find key evidence linking methods in store","toolDisplayMeta":{"displayName":"Terminal","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668571416-hax63w","type":"tool","content":"{\n  \"oldTodos\": [],\n  \"newTodos\": [\n    {\n      \"content\": \"Analyze current reference documents implementation and design auto-mapping solution\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Analyzing current reference documents implementation\"\n    },\n    {\n      \"content\": \"Create implementation plan for reference documents auto-mapping and slot display\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Creating implementation plan\"\n    }\n  ]\n}","timestamp":1769668571416,"toolName":"Read","toolUseId":"toolu_01L5dVG9CvN3Bd8HJoUcNzyG","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","offset":2070,"limit":200},"toolResult":"{\n  \"oldTodos\": [],\n  \"newTodos\": [\n    {\n      \"content\": \"Analyze current reference documents implementation and design auto-mapping solution\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Analyzing current reference documents implementation\"\n    },\n    {\n      \"content\": \"Create implementation plan for reference documents auto-mapping and slot display\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Creating implementation plan\"\n    }\n  ]\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668571889-fp29lg","type":"tool","content":"{\n  \"type\": \"create\",\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill/plans/reference-docs-auto-mapping.md\",\n  \"content\": \"# Reference Documents Auto-Mapping & Slot Display\\n\\n## Summary\\nAfter case assessment is completed, each checklist section's \\\"Reference Documents\\\" area should automatically show mapped files from the File Hub. If a document already exists, it appears as a linked reference. If not, a placeholder slot is shown indicating what file is expected.\\n\\n## Current Behavior\\n- Only **Passport** is auto-linked in `generateEnhancedChecklist()` (store line ~3913)\\n- All other required evidence starts with `isUploaded: false`\\n- The Reference Documents area in OverviewTab only shows uploaded docs, or \\\"No documents uploaded\\\" text\\n- Reference docs are filtered by keywords: \\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"\\n\\n## Proposed Changes\\n\\n### Step 1: Auto-Map Document Groups to Required Evidence in Store\\n**File:** `store/case-detail-store.ts` — `generateEnhancedChecklist()` (~line 3907)\\n\\nAdd matching logic to auto-link existing document groups to required evidence items:\\n\\n| Evidence ID | Evidence Name | Matching Document Group |\\n|---|---|---|\\n| `ev_passport` | Valid Passport | `passport` (already done) |\\n| `ev_bank_statements` | Bank Statements (28 days) | `bank_statement` |\\n| `ev_employment_contract` | Employment Contract / Job Offer Letter | `employment_letter` |\\n| `ev_cos` | Certificate of Sponsorship (CoS) | — (no matching group yet) |\\n| `ev_english_cert` | English Language Test Certificate | `education` |\\n| `ev_travel_history` | Travel History Documentation | `travel_history` |\\n| `ev_degree_cert` | Degree Certificate | `education` |\\n\\nBuild a mapping table `EVIDENCE_TO_GROUP_MAP` that maps evidence IDs to document group IDs. For each evidence item, check if the corresponding group exists and has files; if so, auto-set `isUploaded: true`, `linkedFileId`, and `linkedFileName`.\\n\\n### Step 2: Expand Reference Document Keywords in OverviewTab\\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` (~line 1058)\\n\\nCurrently, reference documents are filtered using a small keyword list. Expand this so that **all required evidence for the section** is shown in the Reference Documents area (not split into \\\"reference\\\" vs \\\"supporting\\\"). This gives users a single unified view of what documents are mapped and what's missing.\\n\\nAlternatively, keep the split but broaden the reference keywords to include section-appropriate documents (e.g., for `employment` section: CoS + Employment Contract; for `financial`: Bank Statements + Payslip).\\n\\n### Step 3: Show Slots for Missing Documents\\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` — `SummaryFieldsCard` (~line 308)\\n\\nReplace the current logic that only renders `referenceEvidence.filter(e => e.isUploaded)` with a new approach that renders **all** reference evidence items:\\n\\n- **If `isUploaded === true`**: Show the existing linked document button (FileText icon, file name, clickable to preview)\\n- **If `isUploaded === false`**: Show a **slot placeholder** — a dashed-border card with the evidence name and an upload/link action icon\\n\\nDesign for empty slot:\\n```\\n┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐\\n│  📄  Upload icon    │\\n│  \\\"Bank Statements\\\"  │\\n│  + Add              │\\n└─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘\\n```\\n\\nDesign for filled slot:\\n```\\n┌────────────────────┐\\n│ 📄 Passport.pdf    │\\n│    ✓ Linked        │\\n└────────────────────┘\\n```\\n\\n### Step 4: Click Behavior for Slots\\n- **Filled slot click**: Opens the document preview modal (existing `CategoryReviewModal`)\\n- **Empty slot click**: Opens the `DocumentUploadModal` to upload or link from File Hub\\n\\nThis behavior already exists — the `handleReferenceDocClick` and `setSelectedEvidence` handlers cover both cases.\\n\\n## Files to Modify\\n\\n1. **`store/case-detail-store.ts`** — `generateEnhancedChecklist()`: Add auto-mapping logic with `EVIDENCE_TO_GROUP_MAP`\\n2. **`components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`**:\\n   - `SummaryFieldsCard`: Render all evidence items (filled + empty slots)\\n   - Update the reference evidence filtering logic if needed\\n   - Style empty slots with dashed borders and upload affordance\\n\\n## Design Notes\\n- Empty slots should use dashed borders (`border-dashed`) to visually distinguish from linked docs\\n- Use the existing `Upload` icon from lucide-react for empty states\\n- Keep the \\\"Add\\\" button in the header for uploading additional/unlisted docs\\n- The horizontal scroll container should accommodate both filled and empty slots\\n- Consider subtle color coding: stone/gray for empty, blue for linked, green for verified\\n\",\n  \"structuredPatch\": [],\n  \"originalFile\": null\n}","timestamp":1769668571889,"toolName":"Read","toolUseId":"toolu_017bSCNdGPZJPnokp6tjVBPd","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","offset":3870,"limit":300},"toolResult":"{\n  \"type\": \"create\",\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill/plans/reference-docs-auto-mapping.md\",\n  \"content\": \"# Reference Documents Auto-Mapping & Slot Display\\n\\n## Summary\\nAfter case assessment is completed, each checklist section's \\\"Reference Documents\\\" area should automatically show mapped files from the File Hub. If a document already exists, it appears as a linked reference. If not, a placeholder slot is shown indicating what file is expected.\\n\\n## Current Behavior\\n- Only **Passport** is auto-linked in `generateEnhancedChecklist()` (store line ~3913)\\n- All other required evidence starts with `isUploaded: false`\\n- The Reference Documents area in OverviewTab only shows uploaded docs, or \\\"No documents uploaded\\\" text\\n- Reference docs are filtered by keywords: \\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"\\n\\n## Proposed Changes\\n\\n### Step 1: Auto-Map Document Groups to Required Evidence in Store\\n**File:** `store/case-detail-store.ts` — `generateEnhancedChecklist()` (~line 3907)\\n\\nAdd matching logic to auto-link existing document groups to required evidence items:\\n\\n| Evidence ID | Evidence Name | Matching Document Group |\\n|---|---|---|\\n| `ev_passport` | Valid Passport | `passport` (already done) |\\n| `ev_bank_statements` | Bank Statements (28 days) | `bank_statement` |\\n| `ev_employment_contract` | Employment Contract / Job Offer Letter | `employment_letter` |\\n| `ev_cos` | Certificate of Sponsorship (CoS) | — (no matching group yet) |\\n| `ev_english_cert` | English Language Test Certificate | `education` |\\n| `ev_travel_history` | Travel History Documentation | `travel_history` |\\n| `ev_degree_cert` | Degree Certificate | `education` |\\n\\nBuild a mapping table `EVIDENCE_TO_GROUP_MAP` that maps evidence IDs to document group IDs. For each evidence item, check if the corresponding group exists and has files; if so, auto-set `isUploaded: true`, `linkedFileId`, and `linkedFileName`.\\n\\n### Step 2: Expand Reference Document Keywords in OverviewTab\\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` (~line 1058)\\n\\nCurrently, reference documents are filtered using a small keyword list. Expand this so that **all required evidence for the section** is shown in the Reference Documents area (not split into \\\"reference\\\" vs \\\"supporting\\\"). This gives users a single unified view of what documents are mapped and what's missing.\\n\\nAlternatively, keep the split but broaden the reference keywords to include section-appropriate documents (e.g., for `employment` section: CoS + Employment Contract; for `financial`: Bank Statements + Payslip).\\n\\n### Step 3: Show Slots for Missing Documents\\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` — `SummaryFieldsCard` (~line 308)\\n\\nReplace the current logic that only renders `referenceEvidence.filter(e => e.isUploaded)` with a new approach that renders **all** reference evidence items:\\n\\n- **If `isUploaded === true`**: Show the existing linked document button (FileText icon, file name, clickable to preview)\\n- **If `isUploaded === false`**: Show a **slot placeholder** — a dashed-border card with the evidence name and an upload/link action icon\\n\\nDesign for empty slot:\\n```\\n┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐\\n│  📄  Upload icon    │\\n│  \\\"Bank Statements\\\"  │\\n│  + Add              │\\n└─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘\\n```\\n\\nDesign for filled slot:\\n```\\n┌────────────────────┐\\n│ 📄 Passport.pdf    │\\n│    ✓ Linked        │\\n└────────────────────┘\\n```\\n\\n### Step 4: Click Behavior for Slots\\n- **Filled slot click**: Opens the document preview modal (existing `CategoryReviewModal`)\\n- **Empty slot click**: Opens the `DocumentUploadModal` to upload or link from File Hub\\n\\nThis behavior already exists — the `handleReferenceDocClick` and `setSelectedEvidence` handlers cover both cases.\\n\\n## Files to Modify\\n\\n1. **`store/case-detail-store.ts`** — `generateEnhancedChecklist()`: Add auto-mapping logic with `EVIDENCE_TO_GROUP_MAP`\\n2. **`components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`**:\\n   - `SummaryFieldsCard`: Render all evidence items (filled + empty slots)\\n   - Update the reference evidence filtering logic if needed\\n   - Style empty slots with dashed borders and upload affordance\\n\\n## Design Notes\\n- Empty slots should use dashed borders (`border-dashed`) to visually distinguish from linked docs\\n- Use the existing `Upload` icon from lucide-react for empty states\\n- Keep the \\\"Add\\\" button in the header for uploading additional/unlisted docs\\n- The horizontal scroll container should accommodate both filled and empty slots\\n- Consider subtle color coding: stone/gray for empty, blue for linked, green for verified\\n\",\n  \"structuredPatch\": [],\n  \"originalFile\": null\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668575183-utkelq","type":"tool","content":"{\n  \"oldTodos\": [\n    {\n      \"content\": \"Analyze current reference documents implementation and design auto-mapping solution\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Analyzing current reference documents implementation\"\n    },\n    {\n      \"content\": \"Create implementation plan for reference documents auto-mapping and slot display\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Creating implementation plan\"\n    }\n  ],\n  \"newTodos\": [\n    {\n      \"content\": \"Analyze current reference documents implementation and design auto-mapping solution\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Analyzing current reference documents implementation\"\n    },\n    {\n      \"content\": \"Create implementation plan for reference documents auto-mapping and slot display\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Creating implementation plan\"\n    }\n  ]\n}","timestamp":1769668575183,"toolName":"Read","toolUseId":"toolu_01QZft7o9EjitsZn5XELrZM8","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/DetailsTab.tsx","offset":1,"limit":150},"toolResult":"{\n  \"oldTodos\": [\n    {\n      \"content\": \"Analyze current reference documents implementation and design auto-mapping solution\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Analyzing current reference documents implementation\"\n    },\n    {\n      \"content\": \"Create implementation plan for reference documents auto-mapping and slot display\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Creating implementation plan\"\n    }\n  ],\n  \"newTodos\": [\n    {\n      \"content\": \"Analyze current reference documents implementation and design auto-mapping solution\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Analyzing current reference documents implementation\"\n    },\n    {\n      \"content\": \"Create implementation plan for reference documents auto-mapping and slot display\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Creating implementation plan\"\n    }\n  ]\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","isError":false,"turnId":"msg_01TiCpoECBTWje5TmthUBQga"}
{"id":"msg-1769668618694-wpjt2h","type":"tool","content":"Running Read...","timestamp":1769668618694,"toolName":"Read","toolUseId":"toolu_01T4wscLvwkXS1vCZCmwKqhx","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","limit":100},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01FKpf2spd6MgWD6LS62wDZV"}
{"id":"msg-1769668619562-noqxer","type":"tool","content":"Running Read...","timestamp":1769668619563,"toolName":"Read","toolUseId":"toolu_01D7v3nCCerFr4EZXfYTptTh","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/types/case-detail.ts","limit":150},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01FKpf2spd6MgWD6LS62wDZV"}
{"id":"msg-1769668620243-2i7z13","type":"assistant","content":"让我深入看一下 OverviewTab 中 reference documents 的当前实现和 store 中文档映射的逻辑。","timestamp":1769668620243,"isIntermediate":true,"turnId":"msg_01FKpf2spd6MgWD6LS62wDZV"}
{"id":"msg-1769668623134-g46449","type":"tool","content":"Running Read...","timestamp":1769668623134,"toolName":"Read","toolUseId":"toolu_01Q16iC5EzgZtr1Lx3cU63wi","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","offset":100,"limit":200},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_013fGpR1p84Jquufoiseppni"}
{"id":"msg-1769668625514-emg2ch","type":"tool","content":"Running Read...","timestamp":1769668625514,"toolName":"Read","toolUseId":"toolu_01DXTSKWhucmbvRr41g3dsz3","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/types/case-detail.ts","offset":150,"limit":150},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_013fGpR1p84Jquufoiseppni"}
{"id":"msg-1769668628835-co970l","type":"tool","content":"Running Read...","timestamp":1769668628835,"toolName":"Read","toolUseId":"toolu_01JaUZqf3faVQpfvXqX49ifB","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","offset":290,"limit":200},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_013Xg3EJ8A9uSbVprC3MCwzK"}
{"id":"msg-1769668639974-d3tm50","type":"tool","content":"Running Grep...","timestamp":1769668639974,"toolName":"Grep","toolUseId":"toolu_013KpYPB4oeVxcnwnRZeVXDn","toolInput":{"pattern":"SECTION_REQUIRED_EVIDENCE|generateEnhancedChecklist","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","output_mode":"content","-n":true},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Search","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_017htynHpkuuQxmGxDwUCbkk"}
{"id":"msg-1769668642169-mv5lru","type":"assistant","content":"Now let me look at the store's evidence mapping logic and the `generateEnhancedChecklist` function.","timestamp":1769668642169,"isIntermediate":true,"turnId":"msg_017htynHpkuuQxmGxDwUCbkk"}
{"id":"msg-1769668644338-a9vgdc","type":"tool","content":"Running Read...","timestamp":1769668644338,"toolName":"Read","toolUseId":"toolu_01JQJGo9y5i3bnAAJTj1dGiL","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","offset":3879,"limit":200},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_0183ecqJ9Rw4WrFWUy7VaMQw"}
{"id":"msg-1769668652183-16sail","type":"tool","content":"Running Grep...","timestamp":1769668652183,"toolName":"Grep","toolUseId":"toolu_01TvsaHini6kFs8HdQehVcFW","toolInput":{"pattern":"referenceEvidence|OverviewTab|itemType.*checklist","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/ChecklistDetailPanel.tsx","output_mode":"content","-n":true},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Search","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01Nm2YPB1sJmxnndP7njsgLd"}
{"id":"msg-1769668654761-tucyiq","type":"assistant","content":"Let me check how the OverviewTab is invoked from ChecklistDetailPanel to understand how `referenceEvidence` is passed.","timestamp":1769668654761,"isIntermediate":true,"turnId":"msg_01Nm2YPB1sJmxnndP7njsgLd"}
{"id":"msg-1769668657154-n0pawi","type":"tool","content":"Running Read...","timestamp":1769668657154,"toolName":"Read","toolUseId":"toolu_01N4VdTdrUEYULmctJZ81tnL","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/ChecklistDetailPanel.tsx","offset":1140,"limit":50},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01BB769CjwqHCf3scKLdoE6k"}
{"id":"msg-1769668664702-1zhgdg","type":"tool","content":"Running Grep...","timestamp":1769668664702,"toolName":"Grep","toolUseId":"toolu_01LciPUXEZerL671BbP5QSkP","toolInput":{"pattern":"referenceEvidence","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/ItemDetailTabs.tsx","output_mode":"content","-n":true,"-C":3},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Search","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01C7pVcA3PWCM6n71pzchXLf"}
{"id":"msg-1769668668510-y18986","type":"tool","content":"Running Grep...","timestamp":1769668668510,"toolName":"Grep","toolUseId":"toolu_016twpsFHBgo7qdFd7toxVoN","toolInput":{"pattern":"OverviewTab|itemType.*checklist|referenceEvidence","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/ItemDetailTabs.tsx","output_mode":"content","-n":true,"-C":5},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Search","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_012pkZYAkjKADtFT8KpYjoxf"}
{"id":"msg-1769668674829-opwy1h","type":"tool","content":"Running Read...","timestamp":1769668674829,"toolName":"Read","toolUseId":"toolu_01WbxUtJoAQecDwKeW3n26W9","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","offset":489,"limit":300},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01JEVpqyqfptcY9Ch1uf1oAg"}
{"id":"msg-1769668679168-l0m6f6","type":"tool","content":"Running Read...","timestamp":1769668679168,"toolName":"Read","toolUseId":"toolu_01QVuq6Qb18gnbEouJF2WgnZ","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","offset":788,"limit":500},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Read","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01GNDLZH5Y3ZhZRXN2x3V9sM"}
{"id":"msg-1769668696929-9aw5rc","type":"tool","content":"Running Grep...","timestamp":1769668696929,"toolName":"Grep","toolUseId":"toolu_01RRAhBFhrSEMHhAudxbuJMM","toolInput":{"pattern":"documentGroups.*=.*\\[|id:.*\\\".*\\\"|title:.*\\\"","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","output_mode":"content","-n":true,"head_limit":60},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Search","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_012dmq18jGeHz3RM1sUFaEoU"}
{"id":"msg-1769668697824-sqiqa2","type":"assistant","content":"Let me check the existing document groups in the store to understand what's available for auto-mapping.","timestamp":1769668697824,"isIntermediate":true,"turnId":"msg_012dmq18jGeHz3RM1sUFaEoU"}
{"id":"msg-1769668701181-7v83cc","type":"tool","content":"Running Grep...","timestamp":1769668701181,"toolName":"Grep","toolUseId":"toolu_01CMnwDgxgpZTeWAjWyEXH8x","toolInput":{"pattern":"^\\s+id: \\\"[a-z]|^\\s+title: \\\"","path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","output_mode":"content","-n":true,"head_limit":40,"offset":50},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Search","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01L9sHiY5JtGqB8chivnzbbg"}
{"id":"msg-1769668705790-1zjprw","type":"tool","content":"Running TodoWrite...","timestamp":1769668705790,"toolName":"TodoWrite","toolUseId":"toolu_014WEwEesCXKLAMrEqurPZ86","toolInput":{"todos":[{"content":"Analyze current reference documents implementation and design auto-mapping solution","status":"completed","activeForm":"Analyzing current reference documents implementation"},{"content":"Create implementation plan for reference documents auto-mapping and slot display","status":"in_progress","activeForm":"Creating implementation plan"}]},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Update Todos","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01YNf3YBrmbyEhaDJopxFSBM"}
{"id":"msg-1769668707565-zuuimh","type":"assistant","content":"Now I have a thorough understanding of the current implementation. Let me create the plan.","timestamp":1769668707565,"isIntermediate":true,"turnId":"msg_01YNf3YBrmbyEhaDJopxFSBM"}
{"id":"msg-1769668710459-busis6","type":"tool","content":"Running Write...","timestamp":1769668710459,"toolName":"Write","toolUseId":"toolu_01VF8WNzt2s7QA5nRdMEeeyi","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill/plans/reference-docs-auto-mapping.md","content":"# Reference Documents Auto-Mapping & Slot Display\n\n## Summary\nAfter case assessment is completed, each checklist section's \"Reference Documents\" area should automatically show mapped files from the File Hub. If a document already exists, it appears as a linked reference. If not, a placeholder slot is shown indicating what file is expected.\n\n## Current Behavior\n- Only **Passport** is auto-linked in `generateEnhancedChecklist()` (store line ~3913)\n- All other required evidence starts with `isUploaded: false`\n- The Reference Documents area in OverviewTab only shows uploaded docs, or \"No documents uploaded\" text\n- Reference docs are filtered by keywords: \"passport\", \"cos\", \"certificate of sponsorship\", \"biometric\"\n\n## Proposed Changes\n\n### Step 1: Auto-Map Document Groups to Required Evidence in Store\n**File:** `store/case-detail-store.ts` — `generateEnhancedChecklist()` (~line 3907)\n\nAdd matching logic to auto-link existing document groups to required evidence items:\n\n| Evidence ID | Evidence Name | Matching Document Group |\n|---|---|---|\n| `ev_passport` | Valid Passport | `passport` (already done) |\n| `ev_bank_statements` | Bank Statements (28 days) | `bank_statement` |\n| `ev_employment_contract` | Employment Contract / Job Offer Letter | `employment_letter` |\n| `ev_cos` | Certificate of Sponsorship (CoS) | — (no matching group yet) |\n| `ev_english_cert` | English Language Test Certificate | `education` |\n| `ev_travel_history` | Travel History Documentation | `travel_history` |\n| `ev_degree_cert` | Degree Certificate | `education` |\n\nBuild a mapping table `EVIDENCE_TO_GROUP_MAP` that maps evidence IDs to document group IDs. For each evidence item, check if the corresponding group exists and has files; if so, auto-set `isUploaded: true`, `linkedFileId`, and `linkedFileName`.\n\n### Step 2: Expand Reference Document Keywords in OverviewTab\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` (~line 1058)\n\nCurrently, reference documents are filtered using a small keyword list. Expand this so that **all required evidence for the section** is shown in the Reference Documents area (not split into \"reference\" vs \"supporting\"). This gives users a single unified view of what documents are mapped and what's missing.\n\nAlternatively, keep the split but broaden the reference keywords to include section-appropriate documents (e.g., for `employment` section: CoS + Employment Contract; for `financial`: Bank Statements + Payslip).\n\n### Step 3: Show Slots for Missing Documents\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` — `SummaryFieldsCard` (~line 308)\n\nReplace the current logic that only renders `referenceEvidence.filter(e => e.isUploaded)` with a new approach that renders **all** reference evidence items:\n\n- **If `isUploaded === true`**: Show the existing linked document button (FileText icon, file name, clickable to preview)\n- **If `isUploaded === false`**: Show a **slot placeholder** — a dashed-border card with the evidence name and an upload/link action icon\n\nDesign for empty slot:\n```\n┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐\n│  📄  Upload icon    │\n│  \"Bank Statements\"  │\n│  + Add              │\n└─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘\n```\n\nDesign for filled slot:\n```\n┌────────────────────┐\n│ 📄 Passport.pdf    │\n│    ✓ Linked        │\n└────────────────────┘\n```\n\n### Step 4: Click Behavior for Slots\n- **Filled slot click**: Opens the document preview modal (existing `CategoryReviewModal`)\n- **Empty slot click**: Opens the `DocumentUploadModal` to upload or link from File Hub\n\nThis behavior already exists — the `handleReferenceDocClick` and `setSelectedEvidence` handlers cover both cases.\n\n## Files to Modify\n\n1. **`store/case-detail-store.ts`** — `generateEnhancedChecklist()`: Add auto-mapping logic with `EVIDENCE_TO_GROUP_MAP`\n2. **`components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`**:\n   - `SummaryFieldsCard`: Render all evidence items (filled + empty slots)\n   - Update the reference evidence filtering logic if needed\n   - Style empty slots with dashed borders and upload affordance\n\n## Design Notes\n- Empty slots should use dashed borders (`border-dashed`) to visually distinguish from linked docs\n- Use the existing `Upload` icon from lucide-react for empty states\n- Keep the \"Add\" button in the header for uploading additional/unlisted docs\n- The horizontal scroll container should accommodate both filled and empty slots\n- Consider subtle color coding: stone/gray for empty, blue for linked, green for verified\n"},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Write","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01HFKw81gzBxVZ5BAKeKS3JC"}
{"id":"msg-1769668742625-uw7v1s","type":"tool","content":"Running TodoWrite...","timestamp":1769668742625,"toolName":"TodoWrite","toolUseId":"toolu_01HvKg6rcatUW2T7rJUppbkc","toolInput":{"todos":[{"content":"Analyze current reference documents implementation and design auto-mapping solution","status":"completed","activeForm":"Analyzing current reference documents implementation"},{"content":"Create implementation plan for reference documents auto-mapping and slot display","status":"completed","activeForm":"Creating implementation plan"}]},"toolStatus":"pending","toolDisplayMeta":{"displayName":"Update Todos","category":"native"},"parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_01MT6YTyV5wLMWKiUcgrnh8X"}
{"id":"msg-1769668747510-6r15ea","type":"tool","content":"Running mcp__session__SubmitPlan...","timestamp":1769668747510,"toolName":"mcp__session__SubmitPlan","toolUseId":"toolu_01EGhfTDGmG8ToYF2SZTHVzq","toolInput":{"planPath":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill/plans/reference-docs-auto-mapping.md","_intent":"Present the reference documents auto-mapping implementation plan for user review","_displayName":"Submit Plan"},"toolStatus":"pending","parentToolUseId":"toolu_01MDRi2kE5M2BLaiY24rmhds","turnId":"msg_014thqZ5KLa7CUphF6FjZBVT"}
{"id":"plan-1769668748895-65o76a","type":"plan","content":"# Reference Documents Auto-Mapping & Slot Display\n\n## Summary\nAfter case assessment is completed, each checklist section's \"Reference Documents\" area should automatically show mapped files from the File Hub. If a document already exists, it appears as a linked reference. If not, a placeholder slot is shown indicating what file is expected.\n\n## Current Behavior\n- Only **Passport** is auto-linked in `generateEnhancedChecklist()` (store line ~3913)\n- All other required evidence starts with `isUploaded: false`\n- The Reference Documents area in OverviewTab only shows uploaded docs, or \"No documents uploaded\" text\n- Reference docs are filtered by keywords: \"passport\", \"cos\", \"certificate of sponsorship\", \"biometric\"\n\n## Proposed Changes\n\n### Step 1: Auto-Map Document Groups to Required Evidence in Store\n**File:** `store/case-detail-store.ts` — `generateEnhancedChecklist()` (~line 3907)\n\nAdd matching logic to auto-link existing document groups to required evidence items:\n\n| Evidence ID | Evidence Name | Matching Document Group |\n|---|---|---|\n| `ev_passport` | Valid Passport | `passport` (already done) |\n| `ev_bank_statements` | Bank Statements (28 days) | `bank_statement` |\n| `ev_employment_contract` | Employment Contract / Job Offer Letter | `employment_letter` |\n| `ev_cos` | Certificate of Sponsorship (CoS) | — (no matching group yet) |\n| `ev_english_cert` | English Language Test Certificate | `education` |\n| `ev_travel_history` | Travel History Documentation | `travel_history` |\n| `ev_degree_cert` | Degree Certificate | `education` |\n\nBuild a mapping table `EVIDENCE_TO_GROUP_MAP` that maps evidence IDs to document group IDs. For each evidence item, check if the corresponding group exists and has files; if so, auto-set `isUploaded: true`, `linkedFileId`, and `linkedFileName`.\n\n### Step 2: Expand Reference Document Keywords in OverviewTab\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` (~line 1058)\n\nCurrently, reference documents are filtered using a small keyword list. Expand this so that **all required evidence for the section** is shown in the Reference Documents area (not split into \"reference\" vs \"supporting\"). This gives users a single unified view of what documents are mapped and what's missing.\n\nAlternatively, keep the split but broaden the reference keywords to include section-appropriate documents (e.g., for `employment` section: CoS + Employment Contract; for `financial`: Bank Statements + Payslip).\n\n### Step 3: Show Slots for Missing Documents\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` — `SummaryFieldsCard` (~line 308)\n\nReplace the current logic that only renders `referenceEvidence.filter(e => e.isUploaded)` with a new approach that renders **all** reference evidence items:\n\n- **If `isUploaded === true`**: Show the existing linked document button (FileText icon, file name, clickable to preview)\n- **If `isUploaded === false`**: Show a **slot placeholder** — a dashed-border card with the evidence name and an upload/link action icon\n\nDesign for empty slot:\n```\n┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐\n│  📄  Upload icon    │\n│  \"Bank Statements\"  │\n│  + Add              │\n└─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘\n```\n\nDesign for filled slot:\n```\n┌────────────────────┐\n│ 📄 Passport.pdf    │\n│    ✓ Linked        │\n└────────────────────┘\n```\n\n### Step 4: Click Behavior for Slots\n- **Filled slot click**: Opens the document preview modal (existing `CategoryReviewModal`)\n- **Empty slot click**: Opens the `DocumentUploadModal` to upload or link from File Hub\n\nThis behavior already exists — the `handleReferenceDocClick` and `setSelectedEvidence` handlers cover both cases.\n\n## Files to Modify\n\n1. **`store/case-detail-store.ts`** — `generateEnhancedChecklist()`: Add auto-mapping logic with `EVIDENCE_TO_GROUP_MAP`\n2. **`components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`**:\n   - `SummaryFieldsCard`: Render all evidence items (filled + empty slots)\n   - Update the reference evidence filtering logic if needed\n   - Style empty slots with dashed borders and upload affordance\n\n## Design Notes\n- Empty slots should use dashed borders (`border-dashed`) to visually distinguish from linked docs\n- Use the existing `Upload` icon from lucide-react for empty states\n- Keep the \"Add\" button in the header for uploading additional/unlisted docs\n- The horizontal scroll container should accommodate both filled and empty slots\n- Consider subtle color coding: stone/gray for empty, blue for linked, green for verified\n","timestamp":1769668748895}
{"id":"msg-1769668791231-6rjd7x","type":"user","content":"我不希望对 application 页面的结构和组件有大的变化，这是一个前提","timestamp":1769668791231}
{"id":"msg-1769668804207-pg9ios","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"    setManuallyEditedFields(new Set());\\n  };\\n\\n  // Get source badge\\n  const getSourceBadge = (field: DisplayField) => {\\n    if (field.source === \\\"extracted\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center px-1.5 py-0.5 text-[9px] font-medium text-blue-700 bg-blue-50 rounded\\\">\\n          Extracted\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"manual\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n          <PenLine className=\\\"size-2\\\" />\\n          Manual\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"questionnaire\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-stone-600 bg-stone-100 rounded\\\">\\n          Questionnaire\\n        </span>\\n      );\\n    }\\n    return null;\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden flex flex-col flex-1 min-h-0\\\">\\n      {/* Header - Fixed height with Reference Documents */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-4\\\">\\n          {/* Left - Progress Summary */}\\n          <div className=\\\"shrink-0 flex items-center gap-3\\\">\\n            <ProgressRing percent={percent} isComplete={isComplete} size={48} />\\n            <div>\\n              <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Application Fields</h3>\\n              <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n                {completedFields} of {totalFields} completed\\n              </p>\\n            </div>\\n          </div>\\n\\n          {/* Divider */}\\n          <div className=\\\"w-px self-stretch bg-stone-200 shrink-0\\\" />\\n\\n          {/* Right - Reference Documents (vertical layout) */}\\n          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\\n                onClick={onUploadClick}\\n                className=\\\"shrink-0 inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-md transition-colors\\\"\\n              >\\n                <Plus className=\\\"size-3\\\" />\\n                Add\\n              </button>\\n            </div>\\n            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => onReferenceDocClick(ev)}\\n                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\\n                  >\\n                    <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\\n              )}\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n\",\n    \"numLines\": 90,\n    \"startLine\": 240,\n    \"totalLines\": 1292\n  }\n}","timestamp":1769668804207,"toolName":"Read","toolUseId":"toolu_01R8izoyTPCFg4avyHyP6VyQ","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","offset":240,"limit":90},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"    setManuallyEditedFields(new Set());\\n  };\\n\\n  // Get source badge\\n  const getSourceBadge = (field: DisplayField) => {\\n    if (field.source === \\\"extracted\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center px-1.5 py-0.5 text-[9px] font-medium text-blue-700 bg-blue-50 rounded\\\">\\n          Extracted\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"manual\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n          <PenLine className=\\\"size-2\\\" />\\n          Manual\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"questionnaire\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-stone-600 bg-stone-100 rounded\\\">\\n          Questionnaire\\n        </span>\\n      );\\n    }\\n    return null;\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden flex flex-col flex-1 min-h-0\\\">\\n      {/* Header - Fixed height with Reference Documents */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-4\\\">\\n          {/* Left - Progress Summary */}\\n          <div className=\\\"shrink-0 flex items-center gap-3\\\">\\n            <ProgressRing percent={percent} isComplete={isComplete} size={48} />\\n            <div>\\n              <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Application Fields</h3>\\n              <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n                {completedFields} of {totalFields} completed\\n              </p>\\n            </div>\\n          </div>\\n\\n          {/* Divider */}\\n          <div className=\\\"w-px self-stretch bg-stone-200 shrink-0\\\" />\\n\\n          {/* Right - Reference Documents (vertical layout) */}\\n          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\\n                onClick={onUploadClick}\\n                className=\\\"shrink-0 inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-md transition-colors\\\"\\n              >\\n                <Plus className=\\\"size-3\\\" />\\n                Add\\n              </button>\\n            </div>\\n            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => onReferenceDocClick(ev)}\\n                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\\n                  >\\n                    <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\\n              )}\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n\",\n    \"numLines\": 90,\n    \"startLine\": 240,\n    \"totalLines\": 1292\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"isError":false,"turnId":"msg_015dvvGAxHCwBKQwosbKrK3k"}
{"id":"msg-1769668805068-a7o265","type":"assistant","content":"\n\n明白。让我重新审视一下当前的实现，确保方案尽量复用现有结构。\n\n核心思路简化为：\n\n1. **Store 层**：在 `generateEnhancedChecklist()` 中，扩展已有的 passport 自动匹配模式，让其他 evidence 也能自动匹配到已有的 document groups\n2. **UI 层**：在 OverviewTab 的 Reference Documents 区域，**只改渲染逻辑** — 把当前的 `filter(e => e.isUploaded)` 改为渲染全部 evidence items，已上传的显示文件名，未上传的显示为 slot\n\n不改组件结构、不改 props 传递、不改 tab 布局。\n\n让我更新计划。","timestamp":1769668805068,"isIntermediate":true,"turnId":"msg_015dvvGAxHCwBKQwosbKrK3k"}
{"id":"msg-1769668813027-wc1vjq","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"        {/* Right - Reference Documents (flexible width) */}\\n        <div className=\\\"flex-1 p-4\\\">\\n          {/* Header */}\\n          <div className=\\\"flex items-center justify-between mb-3\\\">\\n            <div>\\n              <h4 className=\\\"text-xs font-semibold text-stone-700 text-balance\\\">Reference Documents</h4>\\n              <p className=\\\"text-[10px] text-stone-400 text-pretty\\\">Source files for data extraction</p>\\n            </div>\\n            <button\\n              onClick={onUploadClick}\\n              className=\\\"inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-lg transition-colors\\\"\\n            >\\n              <Plus className=\\\"size-3.5\\\" />\\n              Add\\n            </button>\\n          </div>\\n\\n          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Missing Information Card - Shows fields that still need to be completed\\n// ============================================================================\",\n    \"numLines\": 50,\n    \"startLine\": 536,\n    \"totalLines\": 1292\n  }\n}","timestamp":1769668813027,"toolName":"Read","toolUseId":"toolu_015qENx4fWD1hatBTjcBbQw8","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","offset":536,"limit":50},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"        {/* Right - Reference Documents (flexible width) */}\\n        <div className=\\\"flex-1 p-4\\\">\\n          {/* Header */}\\n          <div className=\\\"flex items-center justify-between mb-3\\\">\\n            <div>\\n              <h4 className=\\\"text-xs font-semibold text-stone-700 text-balance\\\">Reference Documents</h4>\\n              <p className=\\\"text-[10px] text-stone-400 text-pretty\\\">Source files for data extraction</p>\\n            </div>\\n            <button\\n              onClick={onUploadClick}\\n              className=\\\"inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-lg transition-colors\\\"\\n            >\\n              <Plus className=\\\"size-3.5\\\" />\\n              Add\\n            </button>\\n          </div>\\n\\n          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Missing Information Card - Shows fields that still need to be completed\\n// ============================================================================\",\n    \"numLines\": 50,\n    \"startLine\": 536,\n    \"totalLines\": 1292\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"isError":false,"turnId":"msg_0135cc7HagxxawkAxuaiNRNt"}
{"id":"msg-1769668818903-ckuuy0","type":"tool","content":"{\n  \"type\": \"update\",\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill/plans/reference-docs-auto-mapping.md\",\n  \"content\": \"# Reference Documents Auto-Mapping & Slot Display\\n\\n## Summary\\n最小化改动，不改变组件结构和 props。仅两处修改：\\n\\n1. **Store 数据层** — 扩展已有的 passport 自动匹配模式到其他 evidence\\n2. **OverviewTab 渲染层** — 把 `filter(e => e.isUploaded)` 改为渲染全部 evidence items\\n\\n## 改动详情\\n\\n### 改动 1: Store — `generateEnhancedChecklist()` 自动匹配\\n**文件:** `store/case-detail-store.ts` ~line 3907\\n\\n**现状:** 只有 passport 做了自动匹配（line 3911-3914），其他 evidence 全部 `isUploaded: false`\\n\\n**改法:** 在 `SECTION_REQUIRED_EVIDENCE` 定义之前，加一个 evidence-to-group 映射表，然后用一个 helper 函数自动填充 `isUploaded`/`linkedFileId`/`linkedFileName`：\\n\\n```ts\\n// Evidence ID → Document Group ID mapping\\nconst EVIDENCE_GROUP_MAP: Record<string, string> = {\\n  ev_passport: \\\"passport\\\",\\n  ev_bank_statements: \\\"bank_statement\\\",\\n  ev_employment_contract: \\\"employment_letter\\\",\\n  ev_travel_history: \\\"travel_history\\\",\\n  ev_english_cert: \\\"education\\\",\\n  ev_degree_cert: \\\"education\\\",\\n};\\n\\nconst autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\\n  const groupId = EVIDENCE_GROUP_MAP[ev.id];\\n  if (!groupId) return ev;\\n  const group = state.documentGroups.find(g => g.id === groupId);\\n  if (!group || group.fileIds.length === 0) return ev;\\n  return {\\n    ...ev,\\n    isUploaded: true,\\n    linkedFileId: group.id,\\n    linkedFileName: group.title,\\n  };\\n};\\n```\\n\\n然后在 `SECTION_REQUIRED_EVIDENCE` 的每个 section 的 evidence 数组中，对每个 item 调用 `autoLinkEvidence()`。这样 passport 的特殊处理代码也可以统一进来。\\n\\n### 改动 2: OverviewTab — 显示全部 evidence（含空 slot）\\n**文件:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`\\n\\n**影响位置（两处，逻辑相同）：**\\n- `SummaryFieldsCard` 组件 (~line 308-325) — employment section 用\\n- `SummarySection` 组件 (~line 554-576) — 非 employment section 用\\n\\n**现状:**\\n```tsx\\n{referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n  referenceEvidence.filter((e) => e.isUploaded).map(...)\\n) : (\\n  <span>No documents uploaded</span>\\n)}\\n```\\n\\n**改为:** 渲染全部 `referenceEvidence`，根据 `isUploaded` 切换样式：\\n\\n```tsx\\n{referenceEvidence.length > 0 ? (\\n  referenceEvidence.map((ev) => (\\n    <button\\n      key={ev.id}\\n      onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\\n      className={cn(\\n        \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\\n        ev.isUploaded\\n          ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\\n          : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\\n      )}\\n    >\\n      {ev.isUploaded ? (\\n        <FileText className=\\\"size-4 text-blue-500\\\" />\\n      ) : (\\n        <Upload className=\\\"size-3.5 text-stone-400\\\" />\\n      )}\\n      <span className={cn(\\n        \\\"text-xs font-medium truncate max-w-[120px]\\\",\\n        ev.isUploaded\\n          ? \\\"text-stone-700 group-hover:text-blue-700\\\"\\n          : \\\"text-stone-400\\\"\\n      )}>\\n        {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\\n      </span>\\n    </button>\\n  ))\\n) : (\\n  <span>No documents required</span>\\n)}\\n```\\n\\n## 改动范围总结\\n\\n| 文件 | 改动类型 | 行数估计 |\\n|------|---------|---------|\\n| `store/case-detail-store.ts` | 加映射表 + helper，替换 passport 特殊逻辑 | ~20 行 |\\n| `OverviewTab.tsx` (SummaryFieldsCard) | 改渲染条件，加空 slot 样式 | ~15 行 |\\n| `OverviewTab.tsx` (SummarySection) | 同上 | ~15 行 |\\n\\n**不改的：** 组件结构、props 接口、tab 布局、数据流、类型定义\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 1,\n      \"oldLines\": 82,\n      \"newStart\": 1,\n      \"newLines\": 104,\n      \"lines\": [\n        \" # Reference Documents Auto-Mapping & Slot Display\",\n        \" \",\n        \" ## Summary\",\n        \"-After case assessment is completed, each checklist section's \\\"Reference Documents\\\" area should automatically show mapped files from the File Hub. If a document already exists, it appears as a linked reference. If not, a placeholder slot is shown indicating what file is expected.\",\n        \"+最小化改动，不改变组件结构和 props。仅两处修改：\",\n        \" \",\n        \"-## Current Behavior\",\n        \"-- Only **Passport** is auto-linked in `generateEnhancedChecklist()` (store line ~3913)\",\n        \"-- All other required evidence starts with `isUploaded: false`\",\n        \"-- The Reference Documents area in OverviewTab only shows uploaded docs, or \\\"No documents uploaded\\\" text\",\n        \"-- Reference docs are filtered by keywords: \\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"\",\n        \"+1. **Store 数据层** — 扩展已有的 passport 自动匹配模式到其他 evidence\",\n        \"+2. **OverviewTab 渲染层** — 把 `filter(e => e.isUploaded)` 改为渲染全部 evidence items\",\n        \" \",\n        \"-## Proposed Changes\",\n        \"+## 改动详情\",\n        \" \",\n        \"-### Step 1: Auto-Map Document Groups to Required Evidence in Store\",\n        \"-**File:** `store/case-detail-store.ts` — `generateEnhancedChecklist()` (~line 3907)\",\n        \"+### 改动 1: Store — `generateEnhancedChecklist()` 自动匹配\",\n        \"+**文件:** `store/case-detail-store.ts` ~line 3907\",\n        \" \",\n        \"-Add matching logic to auto-link existing document groups to required evidence items:\",\n        \"+**现状:** 只有 passport 做了自动匹配（line 3911-3914），其他 evidence 全部 `isUploaded: false`\",\n        \" \",\n        \"-| Evidence ID | Evidence Name | Matching Document Group |\",\n        \"-|---|---|---|\",\n        \"-| `ev_passport` | Valid Passport | `passport` (already done) |\",\n        \"-| `ev_bank_statements` | Bank Statements (28 days) | `bank_statement` |\",\n        \"-| `ev_employment_contract` | Employment Contract / Job Offer Letter | `employment_letter` |\",\n        \"-| `ev_cos` | Certificate of Sponsorship (CoS) | — (no matching group yet) |\",\n        \"-| `ev_english_cert` | English Language Test Certificate | `education` |\",\n        \"-| `ev_travel_history` | Travel History Documentation | `travel_history` |\",\n        \"-| `ev_degree_cert` | Degree Certificate | `education` |\",\n        \"+**改法:** 在 `SECTION_REQUIRED_EVIDENCE` 定义之前，加一个 evidence-to-group 映射表，然后用一个 helper 函数自动填充 `isUploaded`/`linkedFileId`/`linkedFileName`：\",\n        \" \",\n        \"-Build a mapping table `EVIDENCE_TO_GROUP_MAP` that maps evidence IDs to document group IDs. For each evidence item, check if the corresponding group exists and has files; if so, auto-set `isUploaded: true`, `linkedFileId`, and `linkedFileName`.\",\n        \"+```ts\",\n        \"+// Evidence ID → Document Group ID mapping\",\n        \"+const EVIDENCE_GROUP_MAP: Record<string, string> = {\",\n        \"+  ev_passport: \\\"passport\\\",\",\n        \"+  ev_bank_statements: \\\"bank_statement\\\",\",\n        \"+  ev_employment_contract: \\\"employment_letter\\\",\",\n        \"+  ev_travel_history: \\\"travel_history\\\",\",\n        \"+  ev_english_cert: \\\"education\\\",\",\n        \"+  ev_degree_cert: \\\"education\\\",\",\n        \"+};\",\n        \" \",\n        \"-### Step 2: Expand Reference Document Keywords in OverviewTab\",\n        \"-**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` (~line 1058)\",\n        \"+const autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\",\n        \"+  const groupId = EVIDENCE_GROUP_MAP[ev.id];\",\n        \"+  if (!groupId) return ev;\",\n        \"+  const group = state.documentGroups.find(g => g.id === groupId);\",\n        \"+  if (!group || group.fileIds.length === 0) return ev;\",\n        \"+  return {\",\n        \"+    ...ev,\",\n        \"+    isUploaded: true,\",\n        \"+    linkedFileId: group.id,\",\n        \"+    linkedFileName: group.title,\",\n        \"+  };\",\n        \"+};\",\n        \"+```\",\n        \" \",\n        \"-Currently, reference documents are filtered using a small keyword list. Expand this so that **all required evidence for the section** is shown in the Reference Documents area (not split into \\\"reference\\\" vs \\\"supporting\\\"). This gives users a single unified view of what documents are mapped and what's missing.\",\n        \"+然后在 `SECTION_REQUIRED_EVIDENCE` 的每个 section 的 evidence 数组中，对每个 item 调用 `autoLinkEvidence()`。这样 passport 的特殊处理代码也可以统一进来。\",\n        \" \",\n        \"-Alternatively, keep the split but broaden the reference keywords to include section-appropriate documents (e.g., for `employment` section: CoS + Employment Contract; for `financial`: Bank Statements + Payslip).\",\n        \"+### 改动 2: OverviewTab — 显示全部 evidence（含空 slot）\",\n        \"+**文件:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`\",\n        \" \",\n        \"-### Step 3: Show Slots for Missing Documents\",\n        \"-**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` — `SummaryFieldsCard` (~line 308)\",\n        \"+**影响位置（两处，逻辑相同）：**\",\n        \"+- `SummaryFieldsCard` 组件 (~line 308-325) — employment section 用\",\n        \"+- `SummarySection` 组件 (~line 554-576) — 非 employment section 用\",\n        \" \",\n        \"-Replace the current logic that only renders `referenceEvidence.filter(e => e.isUploaded)` with a new approach that renders **all** reference evidence items:\",\n        \"+**现状:**\",\n        \"+```tsx\",\n        \"+{referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\",\n        \"+  referenceEvidence.filter((e) => e.isUploaded).map(...)\",\n        \"+) : (\",\n        \"+  <span>No documents uploaded</span>\",\n        \"+)}\",\n        \"+```\",\n        \" \",\n        \"-- **If `isUploaded === true`**: Show the existing linked document button (FileText icon, file name, clickable to preview)\",\n        \"-- **If `isUploaded === false`**: Show a **slot placeholder** — a dashed-border card with the evidence name and an upload/link action icon\",\n        \"+**改为:** 渲染全部 `referenceEvidence`，根据 `isUploaded` 切换样式：\",\n        \" \",\n        \"-Design for empty slot:\",\n        \"+```tsx\",\n        \"+{referenceEvidence.length > 0 ? (\",\n        \"+  referenceEvidence.map((ev) => (\",\n        \"+    <button\",\n        \"+      key={ev.id}\",\n        \"+      onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\",\n        \"+      className={cn(\",\n        \"+        \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\",\n        \"+        ev.isUploaded\",\n        \"+          ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\",\n        \"+          : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\",\n        \"+      )}\",\n        \"+    >\",\n        \"+      {ev.isUploaded ? (\",\n        \"+        <FileText className=\\\"size-4 text-blue-500\\\" />\",\n        \"+      ) : (\",\n        \"+        <Upload className=\\\"size-3.5 text-stone-400\\\" />\",\n        \"+      )}\",\n        \"+      <span className={cn(\",\n        \"+        \\\"text-xs font-medium truncate max-w-[120px]\\\",\",\n        \"+        ev.isUploaded\",\n        \"+          ? \\\"text-stone-700 group-hover:text-blue-700\\\"\",\n        \"+          : \\\"text-stone-400\\\"\",\n        \"+      )}>\",\n        \"+        {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\",\n        \"+      </span>\",\n        \"+    </button>\",\n        \"+  ))\",\n        \"+) : (\",\n        \"+  <span>No documents required</span>\",\n        \"+)}\",\n        \" ```\",\n        \"-┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐\",\n        \"-│  📄  Upload icon    │\",\n        \"-│  \\\"Bank Statements\\\"  │\",\n        \"-│  + Add              │\",\n        \"-└─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘\",\n        \"-```\",\n        \" \",\n        \"-Design for filled slot:\",\n        \"-```\",\n        \"-┌────────────────────┐\",\n        \"-│ 📄 Passport.pdf    │\",\n        \"-│    ✓ Linked        │\",\n        \"-└────────────────────┘\",\n        \"-```\",\n        \"+## 改动范围总结\",\n        \" \",\n        \"-### Step 4: Click Behavior for Slots\",\n        \"-- **Filled slot click**: Opens the document preview modal (existing `CategoryReviewModal`)\",\n        \"-- **Empty slot click**: Opens the `DocumentUploadModal` to upload or link from File Hub\",\n        \"+| 文件 | 改动类型 | 行数估计 |\",\n        \"+|------|---------|---------|\",\n        \"+| `store/case-detail-store.ts` | 加映射表 + helper，替换 passport 特殊逻辑 | ~20 行 |\",\n        \"+| `OverviewTab.tsx` (SummaryFieldsCard) | 改渲染条件，加空 slot 样式 | ~15 行 |\",\n        \"+| `OverviewTab.tsx` (SummarySection) | 同上 | ~15 行 |\",\n        \" \",\n        \"-This behavior already exists — the `handleReferenceDocClick` and `setSelectedEvidence` handlers cover both cases.\",\n        \"-\",\n        \"-## Files to Modify\",\n        \"-\",\n        \"-1. **`store/case-detail-store.ts`** — `generateEnhancedChecklist()`: Add auto-mapping logic with `EVIDENCE_TO_GROUP_MAP`\",\n        \"-2. **`components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`**:\",\n        \"-   - `SummaryFieldsCard`: Render all evidence items (filled + empty slots)\",\n        \"-   - Update the reference evidence filtering logic if needed\",\n        \"-   - Style empty slots with dashed borders and upload affordance\",\n        \"-\",\n        \"-## Design Notes\",\n        \"-- Empty slots should use dashed borders (`border-dashed`) to visually distinguish from linked docs\",\n        \"-- Use the existing `Upload` icon from lucide-react for empty states\",\n        \"-- Keep the \\\"Add\\\" button in the header for uploading additional/unlisted docs\",\n        \"-- The horizontal scroll container should accommodate both filled and empty slots\",\n        \"-- Consider subtle color coding: stone/gray for empty, blue for linked, green for verified\",\n        \"+**不改的：** 组件结构、props 接口、tab 布局、数据流、类型定义\"\n      ]\n    }\n  ],\n  \"originalFile\": \"# Reference Documents Auto-Mapping & Slot Display\\n\\n## Summary\\nAfter case assessment is completed, each checklist section's \\\"Reference Documents\\\" area should automatically show mapped files from the File Hub. If a document already exists, it appears as a linked reference. If not, a placeholder slot is shown indicating what file is expected.\\n\\n## Current Behavior\\n- Only **Passport** is auto-linked in `generateEnhancedChecklist()` (store line ~3913)\\n- All other required evidence starts with `isUploaded: false`\\n- The Reference Documents area in OverviewTab only shows uploaded docs, or \\\"No documents uploaded\\\" text\\n- Reference docs are filtered by keywords: \\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"\\n\\n## Proposed Changes\\n\\n### Step 1: Auto-Map Document Groups to Required Evidence in Store\\n**File:** `store/case-detail-store.ts` — `generateEnhancedChecklist()` (~line 3907)\\n\\nAdd matching logic to auto-link existing document groups to required evidence items:\\n\\n| Evidence ID | Evidence Name | Matching Document Group |\\n|---|---|---|\\n| `ev_passport` | Valid Passport | `passport` (already done) |\\n| `ev_bank_statements` | Bank Statements (28 days) | `bank_statement` |\\n| `ev_employment_contract` | Employment Contract / Job Offer Letter | `employment_letter` |\\n| `ev_cos` | Certificate of Sponsorship (CoS) | — (no matching group yet) |\\n| `ev_english_cert` | English Language Test Certificate | `education` |\\n| `ev_travel_history` | Travel History Documentation | `travel_history` |\\n| `ev_degree_cert` | Degree Certificate | `education` |\\n\\nBuild a mapping table `EVIDENCE_TO_GROUP_MAP` that maps evidence IDs to document group IDs. For each evidence item, check if the corresponding group exists and has files; if so, auto-set `isUploaded: true`, `linkedFileId`, and `linkedFileName`.\\n\\n### Step 2: Expand Reference Document Keywords in OverviewTab\\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` (~line 1058)\\n\\nCurrently, reference documents are filtered using a small keyword list. Expand this so that **all required evidence for the section** is shown in the Reference Documents area (not split into \\\"reference\\\" vs \\\"supporting\\\"). This gives users a single unified view of what documents are mapped and what's missing.\\n\\nAlternatively, keep the split but broaden the reference keywords to include section-appropriate documents (e.g., for `employment` section: CoS + Employment Contract; for `financial`: Bank Statements + Payslip).\\n\\n### Step 3: Show Slots for Missing Documents\\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` — `SummaryFieldsCard` (~line 308)\\n\\nReplace the current logic that only renders `referenceEvidence.filter(e => e.isUploaded)` with a new approach that renders **all** reference evidence items:\\n\\n- **If `isUploaded === true`**: Show the existing linked document button (FileText icon, file name, clickable to preview)\\n- **If `isUploaded === false`**: Show a **slot placeholder** — a dashed-border card with the evidence name and an upload/link action icon\\n\\nDesign for empty slot:\\n```\\n┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐\\n│  📄  Upload icon    │\\n│  \\\"Bank Statements\\\"  │\\n│  + Add              │\\n└─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘\\n```\\n\\nDesign for filled slot:\\n```\\n┌────────────────────┐\\n│ 📄 Passport.pdf    │\\n│    ✓ Linked        │\\n└────────────────────┘\\n```\\n\\n### Step 4: Click Behavior for Slots\\n- **Filled slot click**: Opens the document preview modal (existing `CategoryReviewModal`)\\n- **Empty slot click**: Opens the `DocumentUploadModal` to upload or link from File Hub\\n\\nThis behavior already exists — the `handleReferenceDocClick` and `setSelectedEvidence` handlers cover both cases.\\n\\n## Files to Modify\\n\\n1. **`store/case-detail-store.ts`** — `generateEnhancedChecklist()`: Add auto-mapping logic with `EVIDENCE_TO_GROUP_MAP`\\n2. **`components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`**:\\n   - `SummaryFieldsCard`: Render all evidence items (filled + empty slots)\\n   - Update the reference evidence filtering logic if needed\\n   - Style empty slots with dashed borders and upload affordance\\n\\n## Design Notes\\n- Empty slots should use dashed borders (`border-dashed`) to visually distinguish from linked docs\\n- Use the existing `Upload` icon from lucide-react for empty states\\n- Keep the \\\"Add\\\" button in the header for uploading additional/unlisted docs\\n- The horizontal scroll container should accommodate both filled and empty slots\\n- Consider subtle color coding: stone/gray for empty, blue for linked, green for verified\\n\"\n}","timestamp":1769668818903,"toolName":"Write","toolUseId":"toolu_01DcTG94eVHHoEpXrjd199e4","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill/plans/reference-docs-auto-mapping.md","content":"# Reference Documents Auto-Mapping & Slot Display\n\n## Summary\n最小化改动，不改变组件结构和 props。仅两处修改：\n\n1. **Store 数据层** — 扩展已有的 passport 自动匹配模式到其他 evidence\n2. **OverviewTab 渲染层** — 把 `filter(e => e.isUploaded)` 改为渲染全部 evidence items\n\n## 改动详情\n\n### 改动 1: Store — `generateEnhancedChecklist()` 自动匹配\n**文件:** `store/case-detail-store.ts` ~line 3907\n\n**现状:** 只有 passport 做了自动匹配（line 3911-3914），其他 evidence 全部 `isUploaded: false`\n\n**改法:** 在 `SECTION_REQUIRED_EVIDENCE` 定义之前，加一个 evidence-to-group 映射表，然后用一个 helper 函数自动填充 `isUploaded`/`linkedFileId`/`linkedFileName`：\n\n```ts\n// Evidence ID → Document Group ID mapping\nconst EVIDENCE_GROUP_MAP: Record<string, string> = {\n  ev_passport: \"passport\",\n  ev_bank_statements: \"bank_statement\",\n  ev_employment_contract: \"employment_letter\",\n  ev_travel_history: \"travel_history\",\n  ev_english_cert: \"education\",\n  ev_degree_cert: \"education\",\n};\n\nconst autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\n  const groupId = EVIDENCE_GROUP_MAP[ev.id];\n  if (!groupId) return ev;\n  const group = state.documentGroups.find(g => g.id === groupId);\n  if (!group || group.fileIds.length === 0) return ev;\n  return {\n    ...ev,\n    isUploaded: true,\n    linkedFileId: group.id,\n    linkedFileName: group.title,\n  };\n};\n```\n\n然后在 `SECTION_REQUIRED_EVIDENCE` 的每个 section 的 evidence 数组中，对每个 item 调用 `autoLinkEvidence()`。这样 passport 的特殊处理代码也可以统一进来。\n\n### 改动 2: OverviewTab — 显示全部 evidence（含空 slot）\n**文件:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`\n\n**影响位置（两处，逻辑相同）：**\n- `SummaryFieldsCard` 组件 (~line 308-325) — employment section 用\n- `SummarySection` 组件 (~line 554-576) — 非 employment section 用\n\n**现状:**\n```tsx\n{referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\n  referenceEvidence.filter((e) => e.isUploaded).map(...)\n) : (\n  <span>No documents uploaded</span>\n)}\n```\n\n**改为:** 渲染全部 `referenceEvidence`，根据 `isUploaded` 切换样式：\n\n```tsx\n{referenceEvidence.length > 0 ? (\n  referenceEvidence.map((ev) => (\n    <button\n      key={ev.id}\n      onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\n      className={cn(\n        \"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\",\n        ev.isUploaded\n          ? \"border-stone-200 bg-white hover:border-blue-300\"\n          : \"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\"\n      )}\n    >\n      {ev.isUploaded ? (\n        <FileText className=\"size-4 text-blue-500\" />\n      ) : (\n        <Upload className=\"size-3.5 text-stone-400\" />\n      )}\n      <span className={cn(\n        \"text-xs font-medium truncate max-w-[120px]\",\n        ev.isUploaded\n          ? \"text-stone-700 group-hover:text-blue-700\"\n          : \"text-stone-400\"\n      )}>\n        {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\n      </span>\n    </button>\n  ))\n) : (\n  <span>No documents required</span>\n)}\n```\n\n## 改动范围总结\n\n| 文件 | 改动类型 | 行数估计 |\n|------|---------|---------|\n| `store/case-detail-store.ts` | 加映射表 + helper，替换 passport 特殊逻辑 | ~20 行 |\n| `OverviewTab.tsx` (SummaryFieldsCard) | 改渲染条件，加空 slot 样式 | ~15 行 |\n| `OverviewTab.tsx` (SummarySection) | 同上 | ~15 行 |\n\n**不改的：** 组件结构、props 接口、tab 布局、数据流、类型定义\n"},"toolResult":"{\n  \"type\": \"update\",\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill/plans/reference-docs-auto-mapping.md\",\n  \"content\": \"# Reference Documents Auto-Mapping & Slot Display\\n\\n## Summary\\n最小化改动，不改变组件结构和 props。仅两处修改：\\n\\n1. **Store 数据层** — 扩展已有的 passport 自动匹配模式到其他 evidence\\n2. **OverviewTab 渲染层** — 把 `filter(e => e.isUploaded)` 改为渲染全部 evidence items\\n\\n## 改动详情\\n\\n### 改动 1: Store — `generateEnhancedChecklist()` 自动匹配\\n**文件:** `store/case-detail-store.ts` ~line 3907\\n\\n**现状:** 只有 passport 做了自动匹配（line 3911-3914），其他 evidence 全部 `isUploaded: false`\\n\\n**改法:** 在 `SECTION_REQUIRED_EVIDENCE` 定义之前，加一个 evidence-to-group 映射表，然后用一个 helper 函数自动填充 `isUploaded`/`linkedFileId`/`linkedFileName`：\\n\\n```ts\\n// Evidence ID → Document Group ID mapping\\nconst EVIDENCE_GROUP_MAP: Record<string, string> = {\\n  ev_passport: \\\"passport\\\",\\n  ev_bank_statements: \\\"bank_statement\\\",\\n  ev_employment_contract: \\\"employment_letter\\\",\\n  ev_travel_history: \\\"travel_history\\\",\\n  ev_english_cert: \\\"education\\\",\\n  ev_degree_cert: \\\"education\\\",\\n};\\n\\nconst autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\\n  const groupId = EVIDENCE_GROUP_MAP[ev.id];\\n  if (!groupId) return ev;\\n  const group = state.documentGroups.find(g => g.id === groupId);\\n  if (!group || group.fileIds.length === 0) return ev;\\n  return {\\n    ...ev,\\n    isUploaded: true,\\n    linkedFileId: group.id,\\n    linkedFileName: group.title,\\n  };\\n};\\n```\\n\\n然后在 `SECTION_REQUIRED_EVIDENCE` 的每个 section 的 evidence 数组中，对每个 item 调用 `autoLinkEvidence()`。这样 passport 的特殊处理代码也可以统一进来。\\n\\n### 改动 2: OverviewTab — 显示全部 evidence（含空 slot）\\n**文件:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`\\n\\n**影响位置（两处，逻辑相同）：**\\n- `SummaryFieldsCard` 组件 (~line 308-325) — employment section 用\\n- `SummarySection` 组件 (~line 554-576) — 非 employment section 用\\n\\n**现状:**\\n```tsx\\n{referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n  referenceEvidence.filter((e) => e.isUploaded).map(...)\\n) : (\\n  <span>No documents uploaded</span>\\n)}\\n```\\n\\n**改为:** 渲染全部 `referenceEvidence`，根据 `isUploaded` 切换样式：\\n\\n```tsx\\n{referenceEvidence.length > 0 ? (\\n  referenceEvidence.map((ev) => (\\n    <button\\n      key={ev.id}\\n      onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\\n      className={cn(\\n        \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\\n        ev.isUploaded\\n          ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\\n          : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\\n      )}\\n    >\\n      {ev.isUploaded ? (\\n        <FileText className=\\\"size-4 text-blue-500\\\" />\\n      ) : (\\n        <Upload className=\\\"size-3.5 text-stone-400\\\" />\\n      )}\\n      <span className={cn(\\n        \\\"text-xs font-medium truncate max-w-[120px]\\\",\\n        ev.isUploaded\\n          ? \\\"text-stone-700 group-hover:text-blue-700\\\"\\n          : \\\"text-stone-400\\\"\\n      )}>\\n        {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\\n      </span>\\n    </button>\\n  ))\\n) : (\\n  <span>No documents required</span>\\n)}\\n```\\n\\n## 改动范围总结\\n\\n| 文件 | 改动类型 | 行数估计 |\\n|------|---------|---------|\\n| `store/case-detail-store.ts` | 加映射表 + helper，替换 passport 特殊逻辑 | ~20 行 |\\n| `OverviewTab.tsx` (SummaryFieldsCard) | 改渲染条件，加空 slot 样式 | ~15 行 |\\n| `OverviewTab.tsx` (SummarySection) | 同上 | ~15 行 |\\n\\n**不改的：** 组件结构、props 接口、tab 布局、数据流、类型定义\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 1,\n      \"oldLines\": 82,\n      \"newStart\": 1,\n      \"newLines\": 104,\n      \"lines\": [\n        \" # Reference Documents Auto-Mapping & Slot Display\",\n        \" \",\n        \" ## Summary\",\n        \"-After case assessment is completed, each checklist section's \\\"Reference Documents\\\" area should automatically show mapped files from the File Hub. If a document already exists, it appears as a linked reference. If not, a placeholder slot is shown indicating what file is expected.\",\n        \"+最小化改动，不改变组件结构和 props。仅两处修改：\",\n        \" \",\n        \"-## Current Behavior\",\n        \"-- Only **Passport** is auto-linked in `generateEnhancedChecklist()` (store line ~3913)\",\n        \"-- All other required evidence starts with `isUploaded: false`\",\n        \"-- The Reference Documents area in OverviewTab only shows uploaded docs, or \\\"No documents uploaded\\\" text\",\n        \"-- Reference docs are filtered by keywords: \\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"\",\n        \"+1. **Store 数据层** — 扩展已有的 passport 自动匹配模式到其他 evidence\",\n        \"+2. **OverviewTab 渲染层** — 把 `filter(e => e.isUploaded)` 改为渲染全部 evidence items\",\n        \" \",\n        \"-## Proposed Changes\",\n        \"+## 改动详情\",\n        \" \",\n        \"-### Step 1: Auto-Map Document Groups to Required Evidence in Store\",\n        \"-**File:** `store/case-detail-store.ts` — `generateEnhancedChecklist()` (~line 3907)\",\n        \"+### 改动 1: Store — `generateEnhancedChecklist()` 自动匹配\",\n        \"+**文件:** `store/case-detail-store.ts` ~line 3907\",\n        \" \",\n        \"-Add matching logic to auto-link existing document groups to required evidence items:\",\n        \"+**现状:** 只有 passport 做了自动匹配（line 3911-3914），其他 evidence 全部 `isUploaded: false`\",\n        \" \",\n        \"-| Evidence ID | Evidence Name | Matching Document Group |\",\n        \"-|---|---|---|\",\n        \"-| `ev_passport` | Valid Passport | `passport` (already done) |\",\n        \"-| `ev_bank_statements` | Bank Statements (28 days) | `bank_statement` |\",\n        \"-| `ev_employment_contract` | Employment Contract / Job Offer Letter | `employment_letter` |\",\n        \"-| `ev_cos` | Certificate of Sponsorship (CoS) | — (no matching group yet) |\",\n        \"-| `ev_english_cert` | English Language Test Certificate | `education` |\",\n        \"-| `ev_travel_history` | Travel History Documentation | `travel_history` |\",\n        \"-| `ev_degree_cert` | Degree Certificate | `education` |\",\n        \"+**改法:** 在 `SECTION_REQUIRED_EVIDENCE` 定义之前，加一个 evidence-to-group 映射表，然后用一个 helper 函数自动填充 `isUploaded`/`linkedFileId`/`linkedFileName`：\",\n        \" \",\n        \"-Build a mapping table `EVIDENCE_TO_GROUP_MAP` that maps evidence IDs to document group IDs. For each evidence item, check if the corresponding group exists and has files; if so, auto-set `isUploaded: true`, `linkedFileId`, and `linkedFileName`.\",\n        \"+```ts\",\n        \"+// Evidence ID → Document Group ID mapping\",\n        \"+const EVIDENCE_GROUP_MAP: Record<string, string> = {\",\n        \"+  ev_passport: \\\"passport\\\",\",\n        \"+  ev_bank_statements: \\\"bank_statement\\\",\",\n        \"+  ev_employment_contract: \\\"employment_letter\\\",\",\n        \"+  ev_travel_history: \\\"travel_history\\\",\",\n        \"+  ev_english_cert: \\\"education\\\",\",\n        \"+  ev_degree_cert: \\\"education\\\",\",\n        \"+};\",\n        \" \",\n        \"-### Step 2: Expand Reference Document Keywords in OverviewTab\",\n        \"-**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` (~line 1058)\",\n        \"+const autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\",\n        \"+  const groupId = EVIDENCE_GROUP_MAP[ev.id];\",\n        \"+  if (!groupId) return ev;\",\n        \"+  const group = state.documentGroups.find(g => g.id === groupId);\",\n        \"+  if (!group || group.fileIds.length === 0) return ev;\",\n        \"+  return {\",\n        \"+    ...ev,\",\n        \"+    isUploaded: true,\",\n        \"+    linkedFileId: group.id,\",\n        \"+    linkedFileName: group.title,\",\n        \"+  };\",\n        \"+};\",\n        \"+```\",\n        \" \",\n        \"-Currently, reference documents are filtered using a small keyword list. Expand this so that **all required evidence for the section** is shown in the Reference Documents area (not split into \\\"reference\\\" vs \\\"supporting\\\"). This gives users a single unified view of what documents are mapped and what's missing.\",\n        \"+然后在 `SECTION_REQUIRED_EVIDENCE` 的每个 section 的 evidence 数组中，对每个 item 调用 `autoLinkEvidence()`。这样 passport 的特殊处理代码也可以统一进来。\",\n        \" \",\n        \"-Alternatively, keep the split but broaden the reference keywords to include section-appropriate documents (e.g., for `employment` section: CoS + Employment Contract; for `financial`: Bank Statements + Payslip).\",\n        \"+### 改动 2: OverviewTab — 显示全部 evidence（含空 slot）\",\n        \"+**文件:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`\",\n        \" \",\n        \"-### Step 3: Show Slots for Missing Documents\",\n        \"-**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` — `SummaryFieldsCard` (~line 308)\",\n        \"+**影响位置（两处，逻辑相同）：**\",\n        \"+- `SummaryFieldsCard` 组件 (~line 308-325) — employment section 用\",\n        \"+- `SummarySection` 组件 (~line 554-576) — 非 employment section 用\",\n        \" \",\n        \"-Replace the current logic that only renders `referenceEvidence.filter(e => e.isUploaded)` with a new approach that renders **all** reference evidence items:\",\n        \"+**现状:**\",\n        \"+```tsx\",\n        \"+{referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\",\n        \"+  referenceEvidence.filter((e) => e.isUploaded).map(...)\",\n        \"+) : (\",\n        \"+  <span>No documents uploaded</span>\",\n        \"+)}\",\n        \"+```\",\n        \" \",\n        \"-- **If `isUploaded === true`**: Show the existing linked document button (FileText icon, file name, clickable to preview)\",\n        \"-- **If `isUploaded === false`**: Show a **slot placeholder** — a dashed-border card with the evidence name and an upload/link action icon\",\n        \"+**改为:** 渲染全部 `referenceEvidence`，根据 `isUploaded` 切换样式：\",\n        \" \",\n        \"-Design for empty slot:\",\n        \"+```tsx\",\n        \"+{referenceEvidence.length > 0 ? (\",\n        \"+  referenceEvidence.map((ev) => (\",\n        \"+    <button\",\n        \"+      key={ev.id}\",\n        \"+      onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\",\n        \"+      className={cn(\",\n        \"+        \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\",\n        \"+        ev.isUploaded\",\n        \"+          ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\",\n        \"+          : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\",\n        \"+      )}\",\n        \"+    >\",\n        \"+      {ev.isUploaded ? (\",\n        \"+        <FileText className=\\\"size-4 text-blue-500\\\" />\",\n        \"+      ) : (\",\n        \"+        <Upload className=\\\"size-3.5 text-stone-400\\\" />\",\n        \"+      )}\",\n        \"+      <span className={cn(\",\n        \"+        \\\"text-xs font-medium truncate max-w-[120px]\\\",\",\n        \"+        ev.isUploaded\",\n        \"+          ? \\\"text-stone-700 group-hover:text-blue-700\\\"\",\n        \"+          : \\\"text-stone-400\\\"\",\n        \"+      )}>\",\n        \"+        {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\",\n        \"+      </span>\",\n        \"+    </button>\",\n        \"+  ))\",\n        \"+) : (\",\n        \"+  <span>No documents required</span>\",\n        \"+)}\",\n        \" ```\",\n        \"-┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐\",\n        \"-│  📄  Upload icon    │\",\n        \"-│  \\\"Bank Statements\\\"  │\",\n        \"-│  + Add              │\",\n        \"-└─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘\",\n        \"-```\",\n        \" \",\n        \"-Design for filled slot:\",\n        \"-```\",\n        \"-┌────────────────────┐\",\n        \"-│ 📄 Passport.pdf    │\",\n        \"-│    ✓ Linked        │\",\n        \"-└────────────────────┘\",\n        \"-```\",\n        \"+## 改动范围总结\",\n        \" \",\n        \"-### Step 4: Click Behavior for Slots\",\n        \"-- **Filled slot click**: Opens the document preview modal (existing `CategoryReviewModal`)\",\n        \"-- **Empty slot click**: Opens the `DocumentUploadModal` to upload or link from File Hub\",\n        \"+| 文件 | 改动类型 | 行数估计 |\",\n        \"+|------|---------|---------|\",\n        \"+| `store/case-detail-store.ts` | 加映射表 + helper，替换 passport 特殊逻辑 | ~20 行 |\",\n        \"+| `OverviewTab.tsx` (SummaryFieldsCard) | 改渲染条件，加空 slot 样式 | ~15 行 |\",\n        \"+| `OverviewTab.tsx` (SummarySection) | 同上 | ~15 行 |\",\n        \" \",\n        \"-This behavior already exists — the `handleReferenceDocClick` and `setSelectedEvidence` handlers cover both cases.\",\n        \"-\",\n        \"-## Files to Modify\",\n        \"-\",\n        \"-1. **`store/case-detail-store.ts`** — `generateEnhancedChecklist()`: Add auto-mapping logic with `EVIDENCE_TO_GROUP_MAP`\",\n        \"-2. **`components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`**:\",\n        \"-   - `SummaryFieldsCard`: Render all evidence items (filled + empty slots)\",\n        \"-   - Update the reference evidence filtering logic if needed\",\n        \"-   - Style empty slots with dashed borders and upload affordance\",\n        \"-\",\n        \"-## Design Notes\",\n        \"-- Empty slots should use dashed borders (`border-dashed`) to visually distinguish from linked docs\",\n        \"-- Use the existing `Upload` icon from lucide-react for empty states\",\n        \"-- Keep the \\\"Add\\\" button in the header for uploading additional/unlisted docs\",\n        \"-- The horizontal scroll container should accommodate both filled and empty slots\",\n        \"-- Consider subtle color coding: stone/gray for empty, blue for linked, green for verified\",\n        \"+**不改的：** 组件结构、props 接口、tab 布局、数据流、类型定义\"\n      ]\n    }\n  ],\n  \"originalFile\": \"# Reference Documents Auto-Mapping & Slot Display\\n\\n## Summary\\nAfter case assessment is completed, each checklist section's \\\"Reference Documents\\\" area should automatically show mapped files from the File Hub. If a document already exists, it appears as a linked reference. If not, a placeholder slot is shown indicating what file is expected.\\n\\n## Current Behavior\\n- Only **Passport** is auto-linked in `generateEnhancedChecklist()` (store line ~3913)\\n- All other required evidence starts with `isUploaded: false`\\n- The Reference Documents area in OverviewTab only shows uploaded docs, or \\\"No documents uploaded\\\" text\\n- Reference docs are filtered by keywords: \\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"\\n\\n## Proposed Changes\\n\\n### Step 1: Auto-Map Document Groups to Required Evidence in Store\\n**File:** `store/case-detail-store.ts` — `generateEnhancedChecklist()` (~line 3907)\\n\\nAdd matching logic to auto-link existing document groups to required evidence items:\\n\\n| Evidence ID | Evidence Name | Matching Document Group |\\n|---|---|---|\\n| `ev_passport` | Valid Passport | `passport` (already done) |\\n| `ev_bank_statements` | Bank Statements (28 days) | `bank_statement` |\\n| `ev_employment_contract` | Employment Contract / Job Offer Letter | `employment_letter` |\\n| `ev_cos` | Certificate of Sponsorship (CoS) | — (no matching group yet) |\\n| `ev_english_cert` | English Language Test Certificate | `education` |\\n| `ev_travel_history` | Travel History Documentation | `travel_history` |\\n| `ev_degree_cert` | Degree Certificate | `education` |\\n\\nBuild a mapping table `EVIDENCE_TO_GROUP_MAP` that maps evidence IDs to document group IDs. For each evidence item, check if the corresponding group exists and has files; if so, auto-set `isUploaded: true`, `linkedFileId`, and `linkedFileName`.\\n\\n### Step 2: Expand Reference Document Keywords in OverviewTab\\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` (~line 1058)\\n\\nCurrently, reference documents are filtered using a small keyword list. Expand this so that **all required evidence for the section** is shown in the Reference Documents area (not split into \\\"reference\\\" vs \\\"supporting\\\"). This gives users a single unified view of what documents are mapped and what's missing.\\n\\nAlternatively, keep the split but broaden the reference keywords to include section-appropriate documents (e.g., for `employment` section: CoS + Employment Contract; for `financial`: Bank Statements + Payslip).\\n\\n### Step 3: Show Slots for Missing Documents\\n**File:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx` — `SummaryFieldsCard` (~line 308)\\n\\nReplace the current logic that only renders `referenceEvidence.filter(e => e.isUploaded)` with a new approach that renders **all** reference evidence items:\\n\\n- **If `isUploaded === true`**: Show the existing linked document button (FileText icon, file name, clickable to preview)\\n- **If `isUploaded === false`**: Show a **slot placeholder** — a dashed-border card with the evidence name and an upload/link action icon\\n\\nDesign for empty slot:\\n```\\n┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐\\n│  📄  Upload icon    │\\n│  \\\"Bank Statements\\\"  │\\n│  + Add              │\\n└─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘\\n```\\n\\nDesign for filled slot:\\n```\\n┌────────────────────┐\\n│ 📄 Passport.pdf    │\\n│    ✓ Linked        │\\n└────────────────────┘\\n```\\n\\n### Step 4: Click Behavior for Slots\\n- **Filled slot click**: Opens the document preview modal (existing `CategoryReviewModal`)\\n- **Empty slot click**: Opens the `DocumentUploadModal` to upload or link from File Hub\\n\\nThis behavior already exists — the `handleReferenceDocClick` and `setSelectedEvidence` handlers cover both cases.\\n\\n## Files to Modify\\n\\n1. **`store/case-detail-store.ts`** — `generateEnhancedChecklist()`: Add auto-mapping logic with `EVIDENCE_TO_GROUP_MAP`\\n2. **`components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`**:\\n   - `SummaryFieldsCard`: Render all evidence items (filled + empty slots)\\n   - Update the reference evidence filtering logic if needed\\n   - Style empty slots with dashed borders and upload affordance\\n\\n## Design Notes\\n- Empty slots should use dashed borders (`border-dashed`) to visually distinguish from linked docs\\n- Use the existing `Upload` icon from lucide-react for empty states\\n- Keep the \\\"Add\\\" button in the header for uploading additional/unlisted docs\\n- The horizontal scroll container should accommodate both filled and empty slots\\n- Consider subtle color coding: stone/gray for empty, blue for linked, green for verified\\n\"\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Write","category":"native"},"isError":false,"turnId":"msg_013vnsNVAbuhrXeA3G8nYUbG"}
{"id":"msg-1769668842918-lwwi6x","type":"assistant","content":"好，现在我对两个需要修改的位置都很清楚了。方案最小化如下：","timestamp":1769668842918,"isIntermediate":true,"turnId":"msg_013vnsNVAbuhrXeA3G8nYUbG"}
{"id":"msg-1769668846150-xifei6","type":"tool","content":"Running mcp__session__SubmitPlan...","timestamp":1769668846150,"toolName":"mcp__session__SubmitPlan","toolUseId":"toolu_01SDScBGHWu5HRJW7pjV3Uwd","toolInput":{"planPath":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill/plans/reference-docs-auto-mapping.md","_intent":"Present the minimal-change plan for reference docs auto-mapping and slot display","_displayName":"Submit Plan"},"toolStatus":"pending","turnId":"msg_01QHfWhsmQkaj7susBvseX3d"}
{"id":"plan-1769668849425-vkacgl","type":"plan","content":"# Reference Documents Auto-Mapping & Slot Display\n\n## Summary\n最小化改动，不改变组件结构和 props。仅两处修改：\n\n1. **Store 数据层** — 扩展已有的 passport 自动匹配模式到其他 evidence\n2. **OverviewTab 渲染层** — 把 `filter(e => e.isUploaded)` 改为渲染全部 evidence items\n\n## 改动详情\n\n### 改动 1: Store — `generateEnhancedChecklist()` 自动匹配\n**文件:** `store/case-detail-store.ts` ~line 3907\n\n**现状:** 只有 passport 做了自动匹配（line 3911-3914），其他 evidence 全部 `isUploaded: false`\n\n**改法:** 在 `SECTION_REQUIRED_EVIDENCE` 定义之前，加一个 evidence-to-group 映射表，然后用一个 helper 函数自动填充 `isUploaded`/`linkedFileId`/`linkedFileName`：\n\n```ts\n// Evidence ID → Document Group ID mapping\nconst EVIDENCE_GROUP_MAP: Record<string, string> = {\n  ev_passport: \"passport\",\n  ev_bank_statements: \"bank_statement\",\n  ev_employment_contract: \"employment_letter\",\n  ev_travel_history: \"travel_history\",\n  ev_english_cert: \"education\",\n  ev_degree_cert: \"education\",\n};\n\nconst autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\n  const groupId = EVIDENCE_GROUP_MAP[ev.id];\n  if (!groupId) return ev;\n  const group = state.documentGroups.find(g => g.id === groupId);\n  if (!group || group.fileIds.length === 0) return ev;\n  return {\n    ...ev,\n    isUploaded: true,\n    linkedFileId: group.id,\n    linkedFileName: group.title,\n  };\n};\n```\n\n然后在 `SECTION_REQUIRED_EVIDENCE` 的每个 section 的 evidence 数组中，对每个 item 调用 `autoLinkEvidence()`。这样 passport 的特殊处理代码也可以统一进来。\n\n### 改动 2: OverviewTab — 显示全部 evidence（含空 slot）\n**文件:** `components/case-detail/application/checklist/detail-panel/OverviewTab.tsx`\n\n**影响位置（两处，逻辑相同）：**\n- `SummaryFieldsCard` 组件 (~line 308-325) — employment section 用\n- `SummarySection` 组件 (~line 554-576) — 非 employment section 用\n\n**现状:**\n```tsx\n{referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\n  referenceEvidence.filter((e) => e.isUploaded).map(...)\n) : (\n  <span>No documents uploaded</span>\n)}\n```\n\n**改为:** 渲染全部 `referenceEvidence`，根据 `isUploaded` 切换样式：\n\n```tsx\n{referenceEvidence.length > 0 ? (\n  referenceEvidence.map((ev) => (\n    <button\n      key={ev.id}\n      onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\n      className={cn(\n        \"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\",\n        ev.isUploaded\n          ? \"border-stone-200 bg-white hover:border-blue-300\"\n          : \"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\"\n      )}\n    >\n      {ev.isUploaded ? (\n        <FileText className=\"size-4 text-blue-500\" />\n      ) : (\n        <Upload className=\"size-3.5 text-stone-400\" />\n      )}\n      <span className={cn(\n        \"text-xs font-medium truncate max-w-[120px]\",\n        ev.isUploaded\n          ? \"text-stone-700 group-hover:text-blue-700\"\n          : \"text-stone-400\"\n      )}>\n        {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\n      </span>\n    </button>\n  ))\n) : (\n  <span>No documents required</span>\n)}\n```\n\n## 改动范围总结\n\n| 文件 | 改动类型 | 行数估计 |\n|------|---------|---------|\n| `store/case-detail-store.ts` | 加映射表 + helper，替换 passport 特殊逻辑 | ~20 行 |\n| `OverviewTab.tsx` (SummaryFieldsCard) | 改渲染条件，加空 slot 样式 | ~15 行 |\n| `OverviewTab.tsx` (SummarySection) | 同上 | ~15 行 |\n\n**不改的：** 组件结构、props 接口、tab 布局、数据流、类型定义\n","timestamp":1769668849425}
{"id":"msg-1769669143246-k5jqn3","type":"user","content":"Plan approved, please execute.","timestamp":1769669143246}
{"id":"msg-1769669153260-3oj3o5","type":"tool","content":"{\n  \"oldTodos\": [],\n  \"newTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ]\n}","timestamp":1769669153260,"toolName":"TodoWrite","toolUseId":"toolu_01S1cCNnKkbPJ8yEWSxXmxKv","toolInput":{"todos":[{"content":"Store: Add auto-mapping logic in generateEnhancedChecklist()","status":"in_progress","activeForm":"Adding auto-mapping logic in store"},{"content":"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard","status":"pending","activeForm":"Updating SummaryFieldsCard rendering"},{"content":"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection","status":"pending","activeForm":"Updating SummarySection rendering"}]},"toolResult":"{\n  \"oldTodos\": [],\n  \"newTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ]\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Update Todos","category":"native"},"isError":false,"turnId":"msg_01MTai7SwmUSRqrPQai25hoa"}
{"id":"msg-1769669156212-xfnylk","type":"assistant","content":"(no content)","timestamp":1769669156212,"isIntermediate":true,"turnId":"msg_01MTai7SwmUSRqrPQai25hoa"}
{"id":"msg-1769669158428-jop7dp","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n    \"content\": \"            pageNumbers: [1], // Mock page number\\n            extractedText: `Extracted from ${file.name}`,\\n          };\\n        };\\n\\n        // Get passport file info\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFile = passportGroup?.fileIds[0]\\n          ? state.allFiles[passportGroup.fileIds[0]]\\n          : undefined;\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: !!passportFile,\\n              linkedFileId: passportFile?.id,\",\n    \"numLines\": 20,\n    \"startLine\": 3895,\n    \"totalLines\": 4510\n  }\n}","timestamp":1769669158428,"toolName":"Read","toolUseId":"toolu_01R4opqUfkP7rYCZULZxSrbA","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","offset":3895,"limit":20},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n    \"content\": \"            pageNumbers: [1], // Mock page number\\n            extractedText: `Extracted from ${file.name}`,\\n          };\\n        };\\n\\n        // Get passport file info\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFile = passportGroup?.fileIds[0]\\n          ? state.allFiles[passportGroup.fileIds[0]]\\n          : undefined;\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: !!passportFile,\\n              linkedFileId: passportFile?.id,\",\n    \"numLines\": 20,\n    \"startLine\": 3895,\n    \"totalLines\": 4510\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"isError":false,"turnId":"msg_014kDtYzeCSPvonyZE7DywSH"}
{"id":"msg-1769669163991-3ud7qx","type":"tool","content":"{\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n  \"oldString\": \"        // Get passport file info\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFile = passportGroup?.fileIds[0]\\n          ? state.allFiles[passportGroup.fileIds[0]]\\n          : undefined;\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: !!passportFile,\\n              linkedFileId: passportFile?.id,\\n              linkedFileName: passportFile?.name,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\",\n  \"newString\": \"        // Evidence ID → Document Group ID mapping for auto-linking\\n        const EVIDENCE_GROUP_MAP: Record<string, string> = {\\n          ev_passport: \\\"passport\\\",\\n          ev_bank_statements: \\\"bank_statement\\\",\\n          ev_payslip: \\\"bank_statement\\\", // payslip may be in same group\\n          ev_employment_contract: \\\"employment_letter\\\",\\n          ev_travel_history: \\\"travel_history\\\",\\n          ev_english_cert: \\\"education\\\",\\n          ev_degree_cert: \\\"education\\\",\\n        };\\n\\n        // Auto-link evidence to existing document groups\\n        const autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\\n          const groupId = EVIDENCE_GROUP_MAP[ev.id];\\n          if (!groupId) return ev;\\n          const group = state.documentGroups.find(g => g.id === groupId);\\n          if (!group || group.fileIds.length === 0) return ev;\\n          return {\\n            ...ev,\\n            isUploaded: true,\\n            linkedFileId: group.id,\\n            linkedFileName: group.title,\\n          };\\n        };\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\",\n  \"originalFile\": \"import { useMemo } from \\\"react\\\";\\nimport { create } from \\\"zustand\\\";\\nimport { devtools } from \\\"zustand/middleware\\\";\\nimport {\\n  CaseDetailStore,\\n  CaseDetailState,\\n  CaseDetailNavItem,\\n  ChecklistStage,\\n  ChecklistItemStatus,\\n  UploadedFilePreview,\\n  QuestionnaireQuestion,\\n  ChecklistItem,\\n  DocumentGroup,\\n  DocumentFile,\\n  ApplicationPhase,\\n  FormSchemaStatus,\\n  FormPilotStatus,\\n  AnalyzedFileSummary,\\n  ApplicationChecklistItem,\\n  QualityIssue,\\n  QualityIssueType,\\n  QualityIssueSeverity,\\n  ChecklistSectionType,\\n  CaseNotesSummary,\\n  // Enhanced types for checklist workspace\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  IssueStatus,\\n  IssueHistoryEntry,\\n  ForwardToClientData,\\n  LinkedDocument,\\n  RequiredEvidence,\\n} from \\\"@/types/case-detail\\\";\\nimport { PassportInfo, VisaType } from \\\"@/types\\\";\\nimport { parseDocumentPath } from \\\"@/lib/document-path-parser\\\";\\n\\n// Old-style document group type (with files embedded) - for legacy data\\ninterface LegacyDocumentGroup {\\n  id: string;\\n  title: string;\\n  tag: string;\\n  mergedFileName?: string;\\n  status: \\\"pending\\\" | \\\"reviewed\\\";\\n  hasChanges?: boolean;\\n  files: Array<Omit<DocumentFile, 'containerIds'> & { containerIds?: string[] }>;\\n  isSpecial?: boolean;\\n  entityType?: DocumentFile['entityType'];\\n  generatedName?: string;\\n}\\n\\n// Initial document groups data - Rich mock data with many pages per category\\n// Uses legacy format (files embedded) - converted to new model when used\\nconst INITIAL_DOCUMENT_GROUPS_LEGACY: LegacyDocumentGroup[] = [\\n  {\\n    id: \\\"passport\\\",\\n    title: \\\"Passport\\\",\\n    tag: \\\"Passport\\\",\\n    mergedFileName: \\\"Passport_Combined.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"pp_1\\\",\\n        name: \\\"Passport_Cover.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_2\\\",\\n        name: \\\"Passport_Bio_Page.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_3\\\",\\n        name: \\\"Passport_Visa_Page_1.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_4\\\",\\n        name: \\\"Passport_Visa_Page_2.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_5\\\",\\n        name: \\\"Passport_Stamp_Page.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_6\\\",\\n        name: \\\"Passport_Back_Cover.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"bank_statement\\\",\\n    title: \\\"Bank Statement\\\",\\n    tag: \\\"Bank Statement\\\",\\n    mergedFileName: \\\"BankStatement_6Months.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"bs_1\\\",\\n        name: \\\"Statement_Jan_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_2\\\",\\n        name: \\\"Statement_Jan_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_3\\\",\\n        name: \\\"Statement_Feb_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_4\\\",\\n        name: \\\"Statement_Feb_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_5\\\",\\n        name: \\\"Statement_Mar_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_6\\\",\\n        name: \\\"Statement_Mar_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_7\\\",\\n        name: \\\"Statement_Apr_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_8\\\",\\n        name: \\\"Statement_Apr_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_9\\\",\\n        name: \\\"Statement_May_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_10\\\",\\n        name: \\\"Statement_May_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_11\\\",\\n        name: \\\"Statement_Jun_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_12\\\",\\n        name: \\\"Statement_Jun_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"employment_letter\\\",\\n    title: \\\"Employment Letter\\\",\\n    tag: \\\"Employment Letter\\\",\\n    mergedFileName: \\\"Employment_Verification.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"emp_1\\\",\\n        name: \\\"Employment_Letter_Page1.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_2\\\",\\n        name: \\\"Employment_Letter_Page2.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_3\\\",\\n        name: \\\"Salary_Slip_Jan.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_4\\\",\\n        name: \\\"Salary_Slip_Feb.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_5\\\",\\n        name: \\\"Salary_Slip_Mar.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"utility_bill\\\",\\n    title: \\\"Utility Bill\\\",\\n    tag: \\\"Utility Bill\\\",\\n    mergedFileName: \\\"Utility_Bills_2024.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"ub_1\\\",\\n        name: \\\"Electric_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_2\\\",\\n        name: \\\"Electric_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_3\\\",\\n        name: \\\"Gas_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_4\\\",\\n        name: \\\"Gas_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_5\\\",\\n        name: \\\"Water_Bill_Q1.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_6\\\",\\n        name: \\\"Council_Tax_Bill.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_7\\\",\\n        name: \\\"Internet_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_8\\\",\\n        name: \\\"Internet_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"tax_documents\\\",\\n    title: \\\"Tax Documents\\\",\\n    tag: \\\"Tax Documents\\\",\\n    mergedFileName: \\\"Tax_Records_2023.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"tax_1\\\",\\n        name: \\\"P60_2023.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_2\\\",\\n        name: \\\"Tax_Return_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_3\\\",\\n        name: \\\"Tax_Return_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_4\\\",\\n        name: \\\"Tax_Return_Page3.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_5\\\",\\n        name: \\\"Tax_Calculation.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_6\\\",\\n        name: \\\"Tax_Payment_Receipt.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"education\\\",\\n    title: \\\"Education Certificates\\\",\\n    tag: \\\"Education\\\",\\n    mergedFileName: \\\"Education_Documents.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"edu_1\\\",\\n        name: \\\"Degree_Certificate.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_2\\\",\\n        name: \\\"Transcript_Page1.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_3\\\",\\n        name: \\\"Transcript_Page2.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_4\\\",\\n        name: \\\"Transcript_Page3.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_5\\\",\\n        name: \\\"IELTS_Result.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_6\\\",\\n        name: \\\"IELTS_TRF.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_7\\\",\\n        name: \\\"Professional_Certificate.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"travel_history\\\",\\n    title: \\\"Travel History\\\",\\n    tag: \\\"Travel History\\\",\\n    mergedFileName: \\\"Travel_Documents.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"travel_1\\\",\\n        name: \\\"Old_Passport_Page1.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_2\\\",\\n        name: \\\"Old_Passport_Page2.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_3\\\",\\n        name: \\\"Old_Passport_Page3.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_4\\\",\\n        name: \\\"Flight_Itinerary_UK.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_5\\\",\\n        name: \\\"Hotel_Booking_UK.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"unclassified\\\",\\n    title: \\\"Unclassified\\\",\\n    tag: \\\"Unclassified\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"u1\\\",\\n        name: \\\"Scan_Page_001.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u2\\\",\\n        name: \\\"Scan_Page_002.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u3\\\",\\n        name: \\\"Scan_Page_003.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u4\\\",\\n        name: \\\"Unknown_Doc_A.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u5\\\",\\n        name: \\\"Unknown_Doc_B.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u6\\\",\\n        name: \\\"Misc_Scan_001.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u7\\\",\\n        name: \\\"Misc_Scan_002.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u8\\\",\\n        name: \\\"Photo_Doc.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n];\\n\\n// System users (mock data)\\nexport const SYSTEM_USERS: { id: string; name: string; email: string; role: string }[] = [\\n  { id: \\\"john-001\\\", name: \\\"John Smith\\\", email: \\\"john@lawfirm.com\\\", role: \\\"Partner\\\" },\\n  { id: \\\"sarah-002\\\", name: \\\"Sarah Johnson\\\", email: \\\"sarah@lawfirm.com\\\", role: \\\"Senior Associate\\\" },\\n  { id: \\\"michael-003\\\", name: \\\"Michael Chen\\\", email: \\\"michael@lawfirm.com\\\", role: \\\"Associate\\\" },\\n  { id: \\\"emma-004\\\", name: \\\"Emma Wilson\\\", email: \\\"emma@lawfirm.com\\\", role: \\\"Paralegal\\\" },\\n  { id: \\\"david-005\\\", name: \\\"David Brown\\\", email: \\\"david@lawfirm.com\\\", role: \\\"Paralegal\\\" },\\n  { id: \\\"lisa-006\\\", name: \\\"Lisa Taylor\\\", email: \\\"lisa@lawfirm.com\\\", role: \\\"Legal Assistant\\\" },\\n];\\n\\n// Initial questionnaire questions\\nconst initialQuestions: QuestionnaireQuestion[] = [\\n  {\\n    id: \\\"q1\\\",\\n    question: \\\"Is the applicant currently in the UK?\\\",\\n    questionZh: \\\"申请人目前在英国吗？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q2\\\",\\n    question: \\\"Does the applicant have a valid passport?\\\",\\n    questionZh: \\\"申请人是否持有有效护照？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q3\\\",\\n    question: \\\"Has the applicant applied for a UK visa before?\\\",\\n    questionZh: \\\"申请人之前是否申请过英国签证？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q4\\\",\\n    question: \\\"What is the purpose of the application?\\\",\\n    questionZh: \\\"申请的目的是什么？\\\",\\n    type: \\\"single-choice\\\",\\n    options: [\\n      { value: \\\"work\\\", label: \\\"Work\\\" },\\n      { value: \\\"study\\\", label: \\\"Study\\\" },\\n      { value: \\\"family\\\", label: \\\"Family reunion\\\" },\\n      { value: \\\"visit\\\", label: \\\"Visit\\\" },\\n      { value: \\\"settlement\\\", label: \\\"Settlement\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"q5\\\",\\n    question: \\\"Does the applicant have a sponsor (employer/university)?\\\",\\n    questionZh: \\\"申请人是否有担保人（雇主/大学）？\\\",\\n    type: \\\"boolean\\\",\\n    dependsOn: { questionId: \\\"q4\\\", value: \\\"work\\\" },\\n  },\\n];\\n\\n// Initial checklist items (for detailed stage)\\nconst initialChecklistItems: ChecklistItem[] = [\\n  {\\n    id: \\\"identity\\\",\\n    label: \\\"Identity Documents\\\",\\n    category: \\\"identity\\\",\\n    status: \\\"pending\\\",\\n    children: [\\n      { id: \\\"passport\\\", label: \\\"Valid Passport\\\", status: \\\"pending\\\" },\\n      { id: \\\"photo\\\", label: \\\"Passport Photo\\\", status: \\\"pending\\\" },\\n      { id: \\\"prev-visas\\\", label: \\\"Previous Visa History\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"financial\\\",\\n    label: \\\"Financial Evidence\\\",\\n    category: \\\"financial\\\",\\n    status: \\\"pending\\\",\\n    dependsOn: [\\\"identity\\\"],\\n    children: [\\n      {\\n        id: \\\"bank-statements\\\",\\n        label: \\\"Bank Statements (6 months)\\\",\\n        status: \\\"pending\\\",\\n      },\\n      {\\n        id: \\\"employment-letter\\\",\\n        label: \\\"Employment Letter\\\",\\n        status: \\\"pending\\\",\\n      },\\n      { id: \\\"tax-records\\\", label: \\\"Tax Records\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"sponsorship\\\",\\n    label: \\\"Sponsorship Documents\\\",\\n    category: \\\"sponsorship\\\",\\n    status: \\\"pending\\\",\\n    dependsOn: [\\\"identity\\\"],\\n    children: [\\n      { id: \\\"cos\\\", label: \\\"Certificate of Sponsorship\\\", status: \\\"pending\\\" },\\n      { id: \\\"job-offer\\\", label: \\\"Job Offer Letter\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"english\\\",\\n    label: \\\"English Language\\\",\\n    category: \\\"english\\\",\\n    status: \\\"pending\\\",\\n    children: [\\n      { id: \\\"ielts\\\", label: \\\"IELTS/English Test Results\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n];\\n\\n// Initial state\\nconst initialState: CaseDetailState = {\\n  caseId: null,\\n  caseReference: \\\"REF-2024-001\\\",\\n  caseNotesSummary: null,\\n  caseTeam: {\\n    lawyer: { id: \\\"john-001\\\", name: \\\"John\\\", email: \\\"john@example.com\\\" },\\n  },\\n  activeNav: \\\"overview\\\",\\n  highlightedGroupId: null,\\n  clientProfile: {\\n    completeness: 0,\\n  },\\n  selectedVisaType: null,\\n  checklist: {\\n    stage: \\\"empty\\\",\\n    questions: initialQuestions,\\n    items: initialChecklistItems,\\n    progress: {\\n      completed: 0,\\n      total: 0,\\n    },\\n  },\\n  uploadedFilePreviews: [],\\n  maxPreviewFiles: 6,\\n  allFiles: {},\\n  documentGroups: [],\\n  isLoadingDocuments: false,\\n  demoStage: 0,\\n  isAnalyzingDocuments: false,\\n  analysisProgress: 0,\\n  lastAnalysisAt: null,\\n  analyzedFileIds: [],\\n  // Application Phase - starts at analyzing since visa type is set at case creation\\n  applicationPhase: \\\"analyzing\\\",\\n  formSchema: null,\\n  formPilotStatus: {\\n    totalSessions: 0,\\n    lastRunAt: null,\\n    lastRunStatus: null,\\n  },\\n  analyzedFiles: [],\\n  // Application Checklist\\n  applicationChecklistItems: [],\\n  qualityIssues: [],\\n  questionnaireAnswers: {},\\n  checklistSectionExpanded: {\\n    personal: true,\\n    employment: true,\\n    financial: false,\\n    travel: false,\\n    education: false,\\n    family: false,\\n    other: false,\\n  },\\n  // Enhanced Checklist Workspace State\\n  enhancedChecklistItems: [],\\n  enhancedQualityIssues: [],\\n  selectedChecklistItemId: null,\\n  selectedIssueId: null,\\n  forwardModalOpen: false,\\n  forwardModalIssueId: null,\\n};\\n\\n// ============================================================================\\n// Helper Functions for 1:N File-Container Model\\n// ============================================================================\\n\\n// Helper to sync file previews from allFiles and documentGroups\\nconst syncFilePreviewsFromState = (\\n  allFiles: Record<string, DocumentFile>,\\n  groups: DocumentGroup[],\\n): UploadedFilePreview[] => {\\n  const previews: UploadedFilePreview[] = [];\\n  for (const group of groups) {\\n    for (const fileId of group.fileIds) {\\n      const file = allFiles[fileId];\\n      if (file && !file.isRemoved) {\\n        previews.push({\\n          id: file.id,\\n          name: file.name,\\n          type: file.type === \\\"pdf\\\" ? \\\"application/pdf\\\" : \\\"application/msword\\\",\\n          groupId: group.id,\\n        });\\n      }\\n    }\\n  }\\n  return previews;\\n};\\n\\n// Helper to get files for a specific container\\nconst getContainerFiles = (\\n  allFiles: Record<string, DocumentFile>,\\n  group: DocumentGroup,\\n): DocumentFile[] => {\\n  return group.fileIds\\n    .map(id => allFiles[id])\\n    .filter((f): f is DocumentFile => f !== undefined && !f.isRemoved);\\n};\\n\\n// Helper to get unclassified files (files with no container associations)\\nconst getUnclassifiedFiles = (\\n  allFiles: Record<string, DocumentFile>,\\n): DocumentFile[] => {\\n  return Object.values(allFiles).filter(\\n    f => !f.isRemoved && f.containerIds.length === 0\\n  );\\n};\\n\\n// Legacy compatibility: Helper to sync file previews from old-style groups (with files array)\\n// Used during migration and for backwards compatibility\\nconst syncFilePreviewsFromGroups = (\\n  groups: Array<DocumentGroup & { files?: DocumentFile[] }>,\\n): UploadedFilePreview[] => {\\n  const previews: UploadedFilePreview[] = [];\\n  for (const group of groups) {\\n    // Support both new model (fileIds) and old model (files)\\n    const files = (group as { files?: DocumentFile[] }).files || [];\\n    for (const file of files) {\\n      previews.push({\\n        id: file.id,\\n        name: file.name,\\n        type: file.type === \\\"pdf\\\" ? \\\"application/pdf\\\" : \\\"application/msword\\\",\\n        groupId: group.id,\\n      });\\n    }\\n  }\\n  return previews;\\n};\\n\\n// Convert old-style groups (files embedded) to new model (files separate, groups have fileIds)\\nconst convertLegacyGroupsToNewModel = (\\n  legacyGroups: LegacyDocumentGroup[]\\n): { allFiles: Record<string, DocumentFile>; documentGroups: DocumentGroup[] } => {\\n  const allFiles: Record<string, DocumentFile> = {};\\n  const documentGroups: DocumentGroup[] = [];\\n\\n  for (const group of legacyGroups) {\\n    const fileIds: string[] = [];\\n\\n    for (const file of group.files) {\\n      // Determine containerIds: empty if unclassified group, otherwise [group.id]\\n      const containerIds = group.id === 'unclassified' ? [] : [group.id];\\n\\n      // Store file in allFiles with containerIds\\n      allFiles[file.id] = {\\n        ...file,\\n        containerIds: file.containerIds || containerIds,\\n      };\\n      fileIds.push(file.id);\\n    }\\n\\n    // Create new-style group with fileIds instead of files\\n    documentGroups.push({\\n      id: group.id,\\n      title: group.title,\\n      tag: group.tag,\\n      mergedFileName: group.mergedFileName,\\n      status: group.status,\\n      hasChanges: group.hasChanges,\\n      fileIds,\\n      files: [],\\n      isSpecial: group.isSpecial,\\n      entityType: group.entityType,\\n      generatedName: group.generatedName,\\n    });\\n  }\\n\\n  return { allFiles, documentGroups };\\n};\\n\\n// Calculate profile completeness\\nconst calculateCompleteness = (\\n  profile: CaseDetailState[\\\"clientProfile\\\"],\\n): number => {\\n  let score = 0;\\n  const total = 3; // passport, contact info (email), contact info (phone)\\n\\n  if (profile.passport) score += 1;\\n  if (profile.contactInfo?.email) score += 1;\\n  if (profile.contactInfo?.phone) score += 1;\\n\\n  return Math.round((score / total) * 100);\\n};\\n\\n// Calculate checklist progress\\nconst calculateProgress = (\\n  items: ChecklistItem[],\\n): { completed: number; total: number } => {\\n  let completed = 0;\\n  let total = 0;\\n\\n  const countItems = (itemList: ChecklistItem[]) => {\\n    for (const item of itemList) {\\n      if (item.children && item.children.length > 0) {\\n        countItems(item.children);\\n      } else {\\n        total++;\\n        if (item.status === \\\"completed\\\") completed++;\\n      }\\n    }\\n  };\\n\\n  countItems(items);\\n  return { completed, total };\\n};\\n\\nexport const useCaseDetailStore = create<CaseDetailStore>()(\\n  devtools(\\n    (set, get) => ({\\n      ...initialState,\\n\\n      // Navigation\\n      setActiveNav: (nav: CaseDetailNavItem) => {\\n        set({ activeNav: nav }, false, \\\"setActiveNav\\\");\\n      },\\n\\n      navigateToDocumentGroup: (groupId: string) => {\\n        set(\\n          { activeNav: \\\"documents\\\", highlightedGroupId: groupId },\\n          false,\\n          \\\"navigateToDocumentGroup\\\"\\n        );\\n      },\\n\\n      clearHighlightedGroup: () => {\\n        set({ highlightedGroupId: null }, false, \\\"clearHighlightedGroup\\\");\\n      },\\n\\n      // Case\\n      setCaseId: (caseId: string) => {\\n        set({ caseId }, false, \\\"setCaseId\\\");\\n      },\\n\\n      setCaseReference: (reference: string) => {\\n        set({ caseReference: reference }, false, \\\"setCaseReference\\\");\\n      },\\n\\n      // Case Team\\n      setLawyer: (lawyer) => {\\n        set(\\n          (state) => ({\\n            caseTeam: { ...state.caseTeam, lawyer },\\n          }),\\n          false,\\n          \\\"setLawyer\\\"\\n        );\\n      },\\n\\n      setAssistant: (assistant) => {\\n        set(\\n          (state) => ({\\n            caseTeam: { ...state.caseTeam, assistant },\\n          }),\\n          false,\\n          \\\"setAssistant\\\"\\n        );\\n      },\\n\\n      // Case Notes Summary\\n      setCaseNotesSummary: (summary: CaseNotesSummary | null) => {\\n        set({ caseNotesSummary: summary }, false, \\\"setCaseNotesSummary\\\");\\n      },\\n\\n      // Client Profile\\n      updateClientProfile: (updates) => {\\n        set(\\n          (state) => {\\n            const newProfile = { ...state.clientProfile, ...updates };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n            return { clientProfile: newProfile };\\n          },\\n          false,\\n          \\\"updateClientProfile\\\",\\n        );\\n      },\\n\\n      setPassportInfo: (passport: PassportInfo) => {\\n        set(\\n          (state) => {\\n            const newProfile = { ...state.clientProfile, passport };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n            return { clientProfile: newProfile };\\n          },\\n          false,\\n          \\\"setPassportInfo\\\",\\n        );\\n      },\\n\\n      // Visa Type\\n      setVisaType: (type: VisaType | null) => {\\n        set({ selectedVisaType: type }, false, \\\"setVisaType\\\");\\n      },\\n\\n      // Checklist\\n      setChecklistStage: (stage: ChecklistStage) => {\\n        set(\\n          (state) => ({\\n            checklist: { ...state.checklist, stage },\\n          }),\\n          false,\\n          \\\"setChecklistStage\\\",\\n        );\\n      },\\n\\n      answerQuestion: (questionId: string, answer: unknown) => {\\n        set(\\n          (state) => {\\n            const questions = state.checklist.questions.map((q) =>\\n              q.id === questionId ? { ...q, answer } : q,\\n            );\\n            return {\\n              checklist: { ...state.checklist, questions },\\n            };\\n          },\\n          false,\\n          \\\"answerQuestion\\\",\\n        );\\n      },\\n\\n      updateChecklistItem: (itemId: string, status: ChecklistItemStatus) => {\\n        set(\\n          (state) => {\\n            const updateItemRecursive = (\\n              items: ChecklistItem[],\\n            ): ChecklistItem[] => {\\n              return items.map((item) => {\\n                if (item.id === itemId) {\\n                  return { ...item, status };\\n                }\\n                if (item.children) {\\n                  return {\\n                    ...item,\\n                    children: updateItemRecursive(item.children),\\n                  };\\n                }\\n                return item;\\n              });\\n            };\\n\\n            const newItems = updateItemRecursive(state.checklist.items);\\n            const progress = calculateProgress(newItems);\\n\\n            return {\\n              checklist: {\\n                ...state.checklist,\\n                items: newItems,\\n                progress,\\n              },\\n            };\\n          },\\n          false,\\n          \\\"updateChecklistItem\\\",\\n        );\\n      },\\n\\n      evolveChecklist: () => {\\n        const state = get();\\n        const { checklist, uploadedFilePreviews } = state;\\n        const fileCount = uploadedFilePreviews.length;\\n        const answeredQuestions = checklist.questions.filter(\\n          (q) => q.answer !== undefined,\\n        ).length;\\n        const totalQuestions = checklist.questions.length;\\n\\n        let newStage: ChecklistStage = checklist.stage;\\n\\n        // Evolution logic based on files and answers\\n        if (fileCount === 0) {\\n          newStage = \\\"empty\\\";\\n        } else if (fileCount >= 1 && checklist.stage === \\\"empty\\\") {\\n          newStage = \\\"questionnaire\\\";\\n        } else if (\\n          (answeredQuestions >= totalQuestions * 0.5 || fileCount >= 3) &&\\n          checklist.stage === \\\"questionnaire\\\"\\n        ) {\\n          newStage = \\\"partial\\\";\\n        } else if (\\n          (answeredQuestions === totalQuestions || state.selectedVisaType) &&\\n          checklist.stage === \\\"partial\\\"\\n        ) {\\n          newStage = \\\"detailed\\\";\\n        }\\n\\n        if (newStage !== checklist.stage) {\\n          set(\\n            (state) => ({\\n              checklist: {\\n                ...state.checklist,\\n                stage: newStage,\\n                progress: calculateProgress(state.checklist.items),\\n              },\\n            }),\\n            false,\\n            \\\"evolveChecklist\\\",\\n          );\\n        }\\n      },\\n\\n      // File Previews\\n      addFilePreview: (file: UploadedFilePreview) => {\\n        set(\\n          (state) => {\\n            const newPreviews = [...state.uploadedFilePreviews, file];\\n            return { uploadedFilePreviews: newPreviews };\\n          },\\n          false,\\n          \\\"addFilePreview\\\",\\n        );\\n        // Trigger checklist evolution\\n        get().evolveChecklist();\\n      },\\n\\n      removeFilePreview: (fileId: string) => {\\n        set(\\n          (state) => ({\\n            uploadedFilePreviews: state.uploadedFilePreviews.filter(\\n              (f) => f.id !== fileId,\\n            ),\\n          }),\\n          false,\\n          \\\"removeFilePreview\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      setFilePreviews: (files: UploadedFilePreview[]) => {\\n        set({ uploadedFilePreviews: files }, false, \\\"setFilePreviews\\\");\\n        get().evolveChecklist();\\n      },\\n\\n      // Demo Controls\\n      advanceDemoStage: () => {\\n        set(\\n          (state) => {\\n            const stages: ChecklistStage[] = [\\n              \\\"empty\\\",\\n              \\\"questionnaire\\\",\\n              \\\"partial\\\",\\n              \\\"detailed\\\",\\n            ];\\n            const currentIndex = stages.indexOf(state.checklist.stage);\\n            const nextIndex = Math.min(currentIndex + 1, stages.length - 1);\\n\\n            return {\\n              demoStage: state.demoStage + 1,\\n              checklist: {\\n                ...state.checklist,\\n                stage: stages[nextIndex],\\n                progress: calculateProgress(state.checklist.items),\\n              },\\n            };\\n          },\\n          false,\\n          \\\"advanceDemoStage\\\",\\n        );\\n      },\\n\\n      resetDemoStage: () => {\\n        set(\\n          {\\n            demoStage: 0,\\n            checklist: {\\n              ...initialState.checklist,\\n              stage: \\\"empty\\\",\\n            },\\n          },\\n          false,\\n          \\\"resetDemoStage\\\",\\n        );\\n      },\\n\\n      // Document Groups\\n      setDocumentGroups: (groups: DocumentGroup[]) => {\\n        const previews = syncFilePreviewsFromGroups(groups);\\n        set(\\n          { documentGroups: groups, uploadedFilePreviews: previews },\\n          false,\\n          \\\"setDocumentGroups\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      addDocumentGroup: (templateName: string) => {\\n        set(\\n          (state) => {\\n            const newGroup: DocumentGroup = {\\n              id: `group_${Date.now()}`,\\n              title: templateName,\\n              tag: templateName,\\n              mergedFileName: `${templateName}.pdf`,\\n              status: \\\"pending\\\",\\n              fileIds: [],\\n              files: [],\\n            };\\n            // Append new category to the end of the array\\n            // The grid filters out \\\"unclassified\\\" so new categories appear at the end\\n            return { documentGroups: [...state.documentGroups, newGroup] };\\n          },\\n          false,\\n          \\\"addDocumentGroup\\\",\\n        );\\n      },\\n\\n      deleteDocumentGroup: (groupId: string) => {\\n        set(\\n          (state) => {\\n            const newGroups = state.documentGroups.filter(\\n              (g) => g.id !== groupId,\\n            );\\n            const previews = syncFilePreviewsFromGroups(newGroups);\\n            return {\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"deleteDocumentGroup\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      renameDocumentGroup: (groupId: string, newTitle: string) => {\\n        set(\\n          (state) => ({\\n            documentGroups: state.documentGroups.map((g) =>\\n              g.id === groupId ? { ...g, mergedFileName: newTitle } : g,\\n            ),\\n          }),\\n          false,\\n          \\\"renameDocumentGroup\\\",\\n        );\\n      },\\n\\n      // ============================================\\n      // One-to-Many File-Container Actions\\n      // ============================================\\n\\n      // Add file to container (creates reference)\\n      addFileToContainer: (fileId: string, containerId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            const group = state.documentGroups.find(g => g.id === containerId);\\n\\n            if (!file || !group) return state;\\n\\n            // Idempotency: if already in container, do nothing\\n            if (file.containerIds.includes(containerId)) return state;\\n\\n            // Update file's containerIds\\n            const updatedFile = {\\n              ...file,\\n              containerIds: [...file.containerIds, containerId],\\n              isNew: true,\\n            };\\n\\n            // Update container's fileIds\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (g.id === containerId) {\\n                return {\\n                  ...g,\\n                  fileIds: [fileId, ...g.fileIds], // Add to beginning\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"addFileToContainer\\\",\\n        );\\n      },\\n\\n      // Remove file from container (removes reference only)\\n      removeFileFromContainer: (fileId: string, containerId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            const group = state.documentGroups.find(g => g.id === containerId);\\n\\n            if (!file || !group) return state;\\n\\n            // Update file's containerIds\\n            const updatedFile = {\\n              ...file,\\n              containerIds: file.containerIds.filter(id => id !== containerId),\\n            };\\n\\n            // Update container's fileIds\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (g.id === containerId) {\\n                return {\\n                  ...g,\\n                  fileIds: g.fileIds.filter(id => id !== fileId),\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"removeFileFromContainer\\\",\\n        );\\n      },\\n\\n      // Reuse file in another container (adds reference, keeps original)\\n      reuseFileInContainer: (fileId: string, targetContainerId: string) => {\\n        // Just call addFileToContainer - file will be in both containers\\n        get().addFileToContainer(fileId, targetContainerId);\\n      },\\n\\n      // Move file between containers (remove from source, add to target)\\n      moveFileBetweenContainers: (fileId: string, fromContainerId: string, toContainerId: string) => {\\n        get().removeFileFromContainer(fileId, fromContainerId);\\n        get().addFileToContainer(fileId, toContainerId);\\n      },\\n\\n      // Legacy moveFileToGroup - for Unclassified to Container moves\\n      // When moving from Unclassified (containerIds=[]), just add to target container\\n      // When moving between containers, use moveFileBetweenContainers\\n      moveFileToGroup: (fileId: string, targetGroupId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file || file.isRemoved) return state;\\n\\n            // Find source container (first container in list, or empty for unclassified)\\n            const sourceContainerId = file.containerIds.length > 0 ? file.containerIds[0] : null;\\n\\n            // If moving to same container, do nothing\\n            if (sourceContainerId === targetGroupId) return state;\\n\\n            // Update file's containerIds\\n            let newContainerIds: string[];\\n            if (sourceContainerId) {\\n              // Replace source with target\\n              newContainerIds = file.containerIds.filter(id => id !== sourceContainerId);\\n              if (!newContainerIds.includes(targetGroupId)) {\\n                newContainerIds = [targetGroupId, ...newContainerIds];\\n              }\\n            } else {\\n              // Unclassified: just add target\\n              newContainerIds = [targetGroupId];\\n            }\\n\\n            const updatedFile = {\\n              ...file,\\n              containerIds: newContainerIds,\\n              isNew: true,\\n            };\\n\\n            // Update groups\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (sourceContainerId && g.id === sourceContainerId) {\\n                // Remove from source\\n                return {\\n                  ...g,\\n                  fileIds: g.fileIds.filter(id => id !== fileId),\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              if (g.id === targetGroupId && !g.fileIds.includes(fileId)) {\\n                // Add to target\\n                return {\\n                  ...g,\\n                  fileIds: [fileId, ...g.fileIds],\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"moveFileToGroup\\\",\\n        );\\n      },\\n\\n      reorderFileInGroup: (\\n        groupId: string,\\n        fromIndex: number,\\n        toIndex: number,\\n      ) => {\\n        set(\\n          (state) => {\\n            const newGroups = state.documentGroups.map((group) => {\\n              if (group.id !== groupId) return group;\\n\\n              const newFileIds = [...group.fileIds];\\n              const [removed] = newFileIds.splice(fromIndex, 1);\\n              newFileIds.splice(toIndex, 0, removed);\\n\\n              return {\\n                ...group,\\n                fileIds: newFileIds,\\n                status: \\\"pending\\\" as const,\\n                hasChanges: true,\\n              };\\n            });\\n\\n            return { documentGroups: newGroups };\\n          },\\n          false,\\n          \\\"reorderFileInGroup\\\",\\n        );\\n      },\\n\\n      markFileForDeletion: (fileId: string, groupId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file) return state;\\n\\n            // Mark file as removed\\n            const updatedFile = { ...file, isRemoved: true, isNew: false };\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n\\n            // Update group status\\n            const newGroups = state.documentGroups.map((group) => {\\n              if (group.id !== groupId) return group;\\n              return {\\n                ...group,\\n                status: \\\"pending\\\" as const,\\n                hasChanges: true,\\n              };\\n            });\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"markFileForDeletion\\\",\\n        );\\n      },\\n\\n      clearFileNewStatus: (fileId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file) return state;\\n\\n            return {\\n              allFiles: {\\n                ...state.allFiles,\\n                [fileId]: { ...file, isNew: false },\\n              },\\n            };\\n          },\\n          false,\\n          \\\"clearFileNewStatus\\\",\\n        );\\n      },\\n\\n      clearGroupChangesFlag: (groupId: string) => {\\n        set(\\n          (state) => ({\\n            documentGroups: state.documentGroups.map((group) =>\\n              group.id === groupId ? { ...group, hasChanges: false } : group,\\n            ),\\n          }),\\n          false,\\n          \\\"clearGroupChangesFlag\\\",\\n        );\\n      },\\n\\n      confirmGroupReview: (groupId: string) => {\\n        set(\\n          (state) => {\\n            const group = state.documentGroups.find((g) => g.id === groupId);\\n            if (!group) return {};\\n\\n            // Update allFiles: remove isRemoved files, clear isNew flag for remaining\\n            const newAllFiles = { ...state.allFiles };\\n            const activeFileIds: string[] = [];\\n            for (const fileId of group.fileIds) {\\n              const file = newAllFiles[fileId];\\n              if (!file) continue;\\n              if (file.isRemoved) {\\n                // Remove the file from allFiles entirely\\n                delete newAllFiles[fileId];\\n              } else {\\n                // Clear isNew flag\\n                newAllFiles[fileId] = { ...file, isNew: false };\\n                activeFileIds.push(fileId);\\n              }\\n            }\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: state.documentGroups.map((g) =>\\n                g.id === groupId\\n                  ? {\\n                      ...g,\\n                      status: \\\"reviewed\\\" as const,\\n                      hasChanges: false,\\n                      fileIds: activeFileIds,\\n                    }\\n                  : g,\\n              ),\\n            };\\n          },\\n          false,\\n          \\\"confirmGroupReview\\\",\\n        );\\n      },\\n\\n      uploadDocuments: async () => {\\n        set({ isLoadingDocuments: true }, false, \\\"uploadDocuments:start\\\");\\n        // Simulate AI processing\\n        await new Promise((resolve) => setTimeout(resolve, 2000));\\n        // Convert legacy groups to new model\\n        const { allFiles, documentGroups } = convertLegacyGroupsToNewModel(INITIAL_DOCUMENT_GROUPS_LEGACY);\\n        const previews = syncFilePreviewsFromState(allFiles, documentGroups);\\n        set(\\n          {\\n            allFiles,\\n            documentGroups,\\n            uploadedFilePreviews: previews,\\n            isLoadingDocuments: false,\\n          },\\n          false,\\n          \\\"uploadDocuments:complete\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      uploadToGroup: (groupId: string, fileCount: number = 1) => {\\n        set(\\n          (state) => {\\n            const group = state.documentGroups.find(g => g.id === groupId);\\n            if (!group) return state;\\n\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n            const newFileIds: string[] = [];\\n\\n            for (let i = 0; i < fileCount; i++) {\\n              const fileId = `file_${timestamp}_${i}`;\\n              newAllFiles[fileId] = {\\n                id: fileId,\\n                name: `Uploaded_Page_${group.fileIds.length + i + 1}.pdf`,\\n                size: \\\"0.5 MB\\\",\\n                pages: 1,\\n                date: \\\"Just now\\\",\\n                type: \\\"pdf\\\",\\n                isNew: true,\\n                containerIds: [groupId],\\n              };\\n              newFileIds.push(fileId);\\n            }\\n\\n            const newGroups = state.documentGroups.map(g => {\\n              if (g.id === groupId) {\\n                return {\\n                  ...g,\\n                  fileIds: [...g.fileIds, ...newFileIds],\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadToGroup\\\",\\n        );\\n      },\\n\\n      // Upload and auto-classify documents (simulates AI classification)\\n      uploadAndAutoClassify: (totalPages: number = 8) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Helper to normalize names for comparison (remove spaces, hyphens, lowercase)\\n            const normalize = (str: string) =>\\n              str.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n\\n            // Categories to potentially create (simulating AI classification results)\\n            const allPossibleCategories = [\\n              { category: \\\"Passport\\\", pages: 2 },\\n              { category: \\\"Bank Statement\\\", pages: 3 },\\n              { category: \\\"Employment Letter\\\", pages: 2 },\\n              { category: \\\"Utility Bill\\\", pages: 2 },\\n              { category: \\\"Tax Documents\\\", pages: 2 },\\n              { category: \\\"Education Certificate\\\", pages: 1 },\\n              { category: \\\"Travel History\\\", pages: 2 },\\n              { category: \\\"Medical Records\\\", pages: 2 },\\n              { category: \\\"Marriage Certificate\\\", pages: 1 },\\n              { category: \\\"Birth Certificate\\\", pages: 1 },\\n            ];\\n\\n            // Find categories that don't exist yet\\n            const existingNormalizedTitles = state.documentGroups\\n              .filter((g) => g.id !== \\\"unclassified\\\")\\n              .map((g) => normalize(g.title));\\n\\n            const newCategories = allPossibleCategories.filter(\\n              (c) => !existingNormalizedTitles.includes(normalize(c.category))\\n            );\\n\\n            // Select 1-2 NEW categories to create\\n            const numNewCategories = Math.min(\\n              Math.floor(Math.random() * 2) + 1,\\n              newCategories.length\\n            );\\n            const selectedNewCategories = newCategories\\n              .sort(() => Math.random() - 0.5)\\n              .slice(0, numNewCategories);\\n\\n            // Also add files to 0-1 existing categories (if any exist)\\n            const existingClassifiedGroups = state.documentGroups.filter(\\n              (g) => g.id !== \\\"unclassified\\\" && g.id !== \\\"case_notes\\\"\\n            );\\n            const selectedExistingGroup =\\n              existingClassifiedGroups.length > 0 && Math.random() > 0.3\\n                ? existingClassifiedGroups[\\n                    Math.floor(Math.random() * existingClassifiedGroups.length)\\n                  ]\\n                : null;\\n\\n            // Calculate pages distribution\\n            const newCategoryPages = selectedNewCategories.reduce(\\n              (sum, c) => sum + c.pages,\\n              0\\n            );\\n            const existingGroupPages = selectedExistingGroup ? 2 : 0;\\n            const classifiedPages = newCategoryPages + existingGroupPages;\\n            const unclassifiedPages = Math.max(2, totalPages - classifiedPages);\\n\\n            let newGroups = [...state.documentGroups];\\n\\n            // Create NEW category groups with files\\n            selectedNewCategories.forEach((result, catIndex) => {\\n              const groupId = `group_${timestamp}_${catIndex}`;\\n              const fileIds: string[] = [];\\n\\n              for (let i = 0; i < result.pages; i++) {\\n                const fileId = `classified_${timestamp}_${catIndex}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `${result.category.replace(/\\\\s+/g, \\\"_\\\")}_Page_${i + 1}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [groupId],\\n                };\\n                fileIds.push(fileId);\\n              }\\n\\n              newGroups.push({\\n                id: groupId,\\n                title: result.category,\\n                tag: result.category,\\n                mergedFileName: `${result.category.replace(/\\\\s+/g, \\\"_\\\")}.pdf`,\\n                status: \\\"pending\\\",\\n                hasChanges: true,\\n                fileIds,\\n                files: [],\\n              });\\n            });\\n\\n            // Add files to an existing group (if selected)\\n            if (selectedExistingGroup) {\\n              const existingFileIds: string[] = [];\\n              for (let i = 0; i < existingGroupPages; i++) {\\n                const fileId = `existing_${timestamp}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `${selectedExistingGroup.title.replace(/\\\\s+/g, \\\"_\\\")}_New_${i + 1}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [selectedExistingGroup.id],\\n                };\\n                existingFileIds.push(fileId);\\n              }\\n              newGroups = newGroups.map((g) =>\\n                g.id === selectedExistingGroup.id\\n                  ? {\\n                      ...g,\\n                      fileIds: [...g.fileIds, ...existingFileIds],\\n                      status: \\\"pending\\\" as const,\\n                      hasChanges: true,\\n                    }\\n                  : g\\n              );\\n            }\\n\\n            // Add remaining pages as unclassified (containerIds = [])\\n            if (unclassifiedPages > 0) {\\n              const existingUnclassifiedCount = getUnclassifiedFiles(state.allFiles).length;\\n              for (let i = 0; i < unclassifiedPages; i++) {\\n                const fileId = `unclassified_${timestamp}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `Scan_Page_${String(existingUnclassifiedCount + i + 1).padStart(3, \\\"0\\\")}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [], // Empty = unclassified\\n                };\\n              }\\n            }\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadAndAutoClassify\\\",\\n        );\\n      },\\n\\n      // Duplicate/Reuse a file to another group (one-to-many linking)\\n      // Now uses reference model - no physical duplication needed\\n      duplicateFileToGroup: (fileId: string, targetGroupId: string) => {\\n        // In the new 1:N model, this is the same as reuseFileInContainer\\n        get().addFileToContainer(fileId, targetGroupId);\\n      },\\n\\n      // Add multiple files to an existing container (moves files from their current containers)\\n      addFilesToGroup: (groupId: string, orderedFileIds: string[]) => {\\n        set(\\n          (state) => {\\n            const targetGroup = state.documentGroups.find((g) => g.id === groupId);\\n            if (!targetGroup) return state;\\n\\n            const newAllFiles = { ...state.allFiles };\\n            const affectedGroupIds = new Set<string>();\\n\\n            // Update each file's containerIds: remove from old, add to target\\n            for (const fileId of orderedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                // Track affected source groups\\n                for (const cid of file.containerIds) {\\n                  if (cid !== groupId) affectedGroupIds.add(cid);\\n                }\\n                // Update file to only be in the target container\\n                newAllFiles[fileId] = {\\n                  ...file,\\n                  containerIds: [groupId],\\n                  isNew: true,\\n                };\\n              }\\n            }\\n\\n            // Remove files from source groups' fileIds\\n            const movedFileIdSet = new Set(orderedFileIds);\\n            let updatedGroups = state.documentGroups.map((group) => {\\n              if (group.id === groupId) {\\n                // Add files to target group (preserve existing + add new in order)\\n                const existingFileIds = group.fileIds.filter((id) => !movedFileIdSet.has(id));\\n                return {\\n                  ...group,\\n                  fileIds: [...existingFileIds, ...orderedFileIds],\\n                  hasChanges: true,\\n                };\\n              }\\n              if (!affectedGroupIds.has(group.id)) return group;\\n              return {\\n                ...group,\\n                fileIds: group.fileIds.filter((fid) => !movedFileIdSet.has(fid)),\\n              };\\n            });\\n\\n            // Auto-delete source groups that became empty\\n            updatedGroups = updatedGroups.filter(\\n              (g) => g.fileIds.length > 0 || !affectedGroupIds.has(g.id)\\n            );\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"addFilesToGroup\\\"\\n        );\\n      },\\n\\n      // Merge (copy) multiple files into a new combined document group\\n      // Source files remain unchanged - this creates copies for the merged document\\n      mergeDocumentsIntoGroup: (\\n        name: string,\\n        orderedFileIds: string[]\\n      ) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newGroupId = `merged_${timestamp}_${Math.random().toString(36).substr(2, 9)}`;\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Create COPIES of selected files for the merged document\\n            // Original files remain unchanged in their source containers\\n            const copiedFileIds: string[] = [];\\n\\n            for (let i = 0; i < orderedFileIds.length; i++) {\\n              const originalFileId = orderedFileIds[i];\\n              const originalFile = newAllFiles[originalFileId];\\n              if (originalFile) {\\n                // Create a new file ID for the copy\\n                const newFileId = `${originalFileId}_copy_${timestamp}_${i}`;\\n\\n                // Create a copy of the file for the new merged group\\n                newAllFiles[newFileId] = {\\n                  ...originalFile,\\n                  id: newFileId,\\n                  containerIds: [newGroupId],\\n                  isNew: true,\\n                };\\n                copiedFileIds.push(newFileId);\\n              }\\n            }\\n\\n            // Source groups remain unchanged - no files are removed\\n\\n            // Create new merged group with copied files\\n            const newGroup: DocumentGroup = {\\n              id: newGroupId,\\n              title: name,\\n              tag: \\\"Other Documents\\\",\\n              mergedFileName: `${name.replace(/\\\\s+/g, \\\"_\\\")}_Merged.pdf`,\\n              status: \\\"pending\\\",\\n              fileIds: copiedFileIds,\\n              files: [],\\n              hasChanges: true,\\n            };\\n\\n            const updatedGroups = [...state.documentGroups, newGroup];\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"mergeDocumentsIntoGroup\\\",\\n        );\\n      },\\n\\n      // Upload folder with recursive path parsing\\n      uploadFolder: (files: Array<{ file: File; relativePath: string }>) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Separate files into recognized (known entity) and unrecognized (unknown entity)\\n            const recognizedFiles: Array<{ file: File; relativePath: string; parsed: ReturnType<typeof parseDocumentPath> }> = [];\\n            const unrecognizedFiles: Array<{ file: File; relativePath: string; parsed: ReturnType<typeof parseDocumentPath> }> = [];\\n\\n            for (const fileData of files) {\\n              const parsed = parseDocumentPath(fileData.relativePath, fileData.file.name);\\n              if (parsed.who === 'unknown') {\\n                unrecognizedFiles.push({ ...fileData, parsed });\\n              } else {\\n                recognizedFiles.push({ ...fileData, parsed });\\n              }\\n            }\\n\\n            // Group recognized files by their generated document name\\n            const groupedByName = new Map<string, {\\n              parsedDoc: ReturnType<typeof parseDocumentPath>;\\n              files: Array<{ file: File; relativePath: string }>;\\n            }>();\\n\\n            for (const fileData of recognizedFiles) {\\n              if (!groupedByName.has(fileData.parsed.generatedName)) {\\n                groupedByName.set(fileData.parsed.generatedName, {\\n                  parsedDoc: fileData.parsed,\\n                  files: [],\\n                });\\n              }\\n              groupedByName.get(fileData.parsed.generatedName)!.files.push(fileData);\\n            }\\n\\n            // Create DocumentGroups for each unique generated name\\n            const newGroups: DocumentGroup[] = [];\\n            let fileIndex = 0;\\n\\n            // Determine tag from document type\\n            const tagMap: Record<string, string> = {\\n              passport: \\\"Identity\\\",\\n              nationalId: \\\"Identity\\\",\\n              birthCertificate: \\\"Identity\\\",\\n              bankStatement: \\\"Financial\\\",\\n              payslip: \\\"Financial\\\",\\n              taxReturn: \\\"Financial\\\",\\n              employmentLetter: \\\"Employment\\\",\\n              employmentContract: \\\"Employment\\\",\\n              educationCertificate: \\\"Education\\\",\\n              transcript: \\\"Education\\\",\\n              schoolEnrollment: \\\"Education\\\",\\n              marriageCertificate: \\\"Relationship\\\",\\n              proofOfCohabitation: \\\"Relationship\\\",\\n              propertyTitle: \\\"Accommodation\\\",\\n              proofOfAccommodation: \\\"Accommodation\\\",\\n              utilityBill: \\\"Utility\\\",\\n              visa: \\\"Travel\\\",\\n              insurance: \\\"Insurance\\\",\\n              letterOfConsent: \\\"Other\\\",\\n              document: \\\"Other Documents\\\",\\n            };\\n\\n            for (const [generatedName, data] of groupedByName) {\\n              const groupId = `group_folder_${timestamp}_${newGroups.length}`;\\n              const fileIds: string[] = [];\\n\\n              for (const fileData of data.files) {\\n                const fileId = `folder_${timestamp}_${fileIndex++}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: fileData.file.name,\\n                  size: `${(fileData.file.size / 1024).toFixed(1)} KB`,\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\" as const,\\n                  isNew: true,\\n                  containerIds: [groupId],\\n                  relativePath: fileData.relativePath,\\n                  entityType: data.parsedDoc.who,\\n                };\\n                fileIds.push(fileId);\\n              }\\n\\n              const tag = tagMap[data.parsedDoc.documentType] || \\\"Other Documents\\\";\\n\\n              newGroups.push({\\n                id: groupId,\\n                title: generatedName,\\n                tag,\\n                mergedFileName: `${generatedName}.pdf`,\\n                status: \\\"pending\\\",\\n                fileIds,\\n                files: [],\\n                hasChanges: true,\\n                entityType: data.parsedDoc.who,\\n                generatedName,\\n              });\\n            }\\n\\n            // Add unrecognized files as unclassified (containerIds = [])\\n            for (const fileData of unrecognizedFiles) {\\n              const fileId = `folder_${timestamp}_${fileIndex++}`;\\n              newAllFiles[fileId] = {\\n                id: fileId,\\n                name: fileData.file.name,\\n                size: `${(fileData.file.size / 1024).toFixed(1)} KB`,\\n                pages: 1,\\n                date: \\\"Just now\\\",\\n                type: \\\"pdf\\\" as const,\\n                isNew: true,\\n                containerIds: [], // Empty = unclassified\\n                relativePath: fileData.relativePath,\\n                entityType: \\\"unknown\\\" as const,\\n              };\\n            }\\n\\n            // Add new classified groups\\n            const updatedGroups = [...state.documentGroups, ...newGroups];\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadFolder\\\",\\n        );\\n      },\\n\\n      // Upload file for a specific evidence requirement\\n      uploadForEvidence: (evidenceId: string, evidenceName: string) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const normalizedName = evidenceName.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Find existing group that matches the evidence name\\n            let targetGroupId: string | undefined;\\n            for (const g of state.documentGroups) {\\n              const normalizedGroupTitle = g.title.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n              if (normalizedGroupTitle.includes(normalizedName) || normalizedName.includes(normalizedGroupTitle)) {\\n                targetGroupId = g.id;\\n                break;\\n              }\\n            }\\n\\n            // If no matching group exists, create one\\n            if (!targetGroupId) {\\n              targetGroupId = `group_${timestamp}`;\\n            }\\n\\n            const fileId = `evidence_${timestamp}`;\\n            newAllFiles[fileId] = {\\n              id: fileId,\\n              name: `${evidenceName.replace(/\\\\s+/g, \\\"_\\\")}.pdf`,\\n              size: \\\"0.5 MB\\\",\\n              pages: 1,\\n              date: \\\"Just now\\\",\\n              type: \\\"pdf\\\",\\n              isNew: true,\\n              containerIds: [targetGroupId],\\n            };\\n\\n            let newGroups = [...state.documentGroups];\\n\\n            const existingGroup = newGroups.find(g => g.id === targetGroupId);\\n            if (existingGroup) {\\n              // Add file to existing group\\n              newGroups = newGroups.map((g) =>\\n                g.id === targetGroupId\\n                  ? {\\n                      ...g,\\n                      fileIds: [...g.fileIds, fileId],\\n                      status: \\\"pending\\\" as const,\\n                      hasChanges: true,\\n                    }\\n                  : g\\n              );\\n            } else {\\n              // Create new group for this evidence\\n              newGroups.push({\\n                id: targetGroupId,\\n                title: evidenceName,\\n                tag: evidenceName,\\n                mergedFileName: `${evidenceName}.pdf`,\\n                status: \\\"pending\\\",\\n                fileIds: [fileId],\\n                files: [],\\n                hasChanges: true,\\n              });\\n            }\\n\\n            // Update enhanced checklist items (requiredEvidence is only on EnhancedChecklistItem)\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: true,\\n                      linkedFileId: fileId,\\n                      linkedFileName: newAllFiles[fileId].name,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            // Mark related issue as resolved\\n            const issueIdToResolve = `issue_missing_evidence_${evidenceId}`;\\n            const updatedIssues = state.enhancedQualityIssues.map((issue) =>\\n              issue.id === issueIdToResolve\\n                ? {\\n                    ...issue,\\n                    status: \\\"resolved\\\" as IssueStatus,\\n                    resolvedAt: new Date().toISOString(),\\n                    updatedAt: new Date().toISOString(),\\n                  }\\n                : issue\\n            );\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n              enhancedChecklistItems: updatedEnhancedItems,\\n              enhancedQualityIssues: updatedIssues,\\n            };\\n          },\\n          false,\\n          \\\"uploadForEvidence\\\"\\n        );\\n      },\\n\\n      // Link evidence to an existing document group from File Hub\\n      linkEvidenceToGroup: (evidenceId: string, groupId: string) => {\\n        set(\\n          (state) => {\\n            const targetGroup = state.documentGroups.find((g) => g.id === groupId);\\n            if (!targetGroup) return state;\\n\\n            // Update enhanced checklist items\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: true,\\n                      linkedFileId: groupId, // Link to the group ID\\n                      linkedFileName: targetGroup.title,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            // Mark related issue as resolved\\n            const issueIdToResolve = `issue_missing_evidence_${evidenceId}`;\\n            const updatedIssues = state.enhancedQualityIssues.map((issue) =>\\n              issue.id === issueIdToResolve\\n                ? {\\n                    ...issue,\\n                    status: \\\"resolved\\\" as IssueStatus,\\n                    resolvedAt: new Date().toISOString(),\\n                    updatedAt: new Date().toISOString(),\\n                  }\\n                : issue\\n            );\\n\\n            return {\\n              enhancedChecklistItems: updatedEnhancedItems,\\n              enhancedQualityIssues: updatedIssues,\\n            };\\n          },\\n          false,\\n          \\\"linkEvidenceToGroup\\\"\\n        );\\n      },\\n\\n      // Unlink evidence from a document group\\n      unlinkEvidence: (evidenceId: string) => {\\n        set(\\n          (state) => {\\n            // Update enhanced checklist items - reset the evidence to unlinked state\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: false,\\n                      linkedFileId: undefined,\\n                      linkedFileName: undefined,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            return {\\n              enhancedChecklistItems: updatedEnhancedItems,\\n            };\\n          },\\n          false,\\n          \\\"unlinkEvidence\\\"\\n        );\\n      },\\n\\n      // Demo: Review all documents and analyze to generate client profile\\n      reviewAllDocumentsAndAnalyze: async () => {\\n        const state = get();\\n\\n        // Step 1: Mark all document groups as reviewed\\n        set(\\n          (prev) => {\\n            const newAllFiles = { ...prev.allFiles };\\n            const newDocumentGroups = prev.documentGroups.map((g) => {\\n              const activeFileIds: string[] = [];\\n              for (const fileId of g.fileIds) {\\n                const file = newAllFiles[fileId];\\n                if (!file) continue;\\n                if (file.isRemoved) {\\n                  delete newAllFiles[fileId];\\n                } else {\\n                  newAllFiles[fileId] = { ...file, isNew: false };\\n                  activeFileIds.push(fileId);\\n                }\\n              }\\n              return {\\n                ...g,\\n                status: \\\"reviewed\\\" as const,\\n                hasChanges: false,\\n                fileIds: activeFileIds,\\n              };\\n            });\\n            return {\\n              isAnalyzingDocuments: true,\\n              analysisProgress: 0,\\n              allFiles: newAllFiles,\\n              documentGroups: newDocumentGroups,\\n            };\\n          },\\n          false,\\n          \\\"reviewAllDocuments\\\",\\n        );\\n\\n        // Step 2: Simulate document analysis with progress updates\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 600));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`,\\n          );\\n        }\\n\\n        // Step 3: Generate mock client profile from \\\"extracted\\\" document data\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        // Step 4: Update client profile and record analyzed files\\n        const currentState = get();\\n        const analyzedFileIds = currentState.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(currentState.allFiles, g).map((f) => f.id));\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            // Mark all analyzed files in allFiles\\n            const newAllFiles = { ...state.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of analyzedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n\\n            return {\\n              clientProfile: newProfile,\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\",\\n        );\\n\\n        // Evolve checklist based on new data\\n        get().evolveChecklist();\\n      },\\n\\n      // Run document analysis on ready (reviewed) documents only\\n      runDocumentAnalysis: async () => {\\n        const state = get();\\n\\n        // Get all ready files (from reviewed groups, excluding unclassified and removed)\\n        const readyFiles = state.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(state.allFiles, g));\\n\\n        if (readyFiles.length === 0) {\\n          return; // Nothing to analyze\\n        }\\n\\n        set(\\n          { isAnalyzingDocuments: true, analysisProgress: 0 },\\n          false,\\n          \\\"startAnalysis\\\",\\n        );\\n\\n        // Simulate analysis\\n        const totalSteps = 4;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 500));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`,\\n          );\\n        }\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        set(\\n          (state) => {\\n            // Mark analyzed files in allFiles\\n            const newAllFiles = { ...state.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of analyzedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n            return {\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\",\\n        );\\n      },\\n\\n      // Application Phase Management\\n      setApplicationPhase: (phase: ApplicationPhase) => {\\n        set({ applicationPhase: phase }, false, \\\"setApplicationPhase\\\");\\n      },\\n\\n      // Initialize form schema based on visa type\\n      initFormSchema: (visaType: VisaType) => {\\n        const schemaConfigs: Record<VisaType, Omit<FormSchemaStatus, \\\"filledFields\\\" | \\\"completionPercentage\\\" | \\\"lastUpdatedAt\\\">> = {\\n          \\\"skilled-worker\\\": {\\n            schemaName: \\\"Skilled Worker Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 58,\\n            emptyRequiredFields: [\\n              \\\"Certificate of Sponsorship number\\\",\\n              \\\"Sponsor license number\\\",\\n              \\\"Job start date\\\",\\n              \\\"Annual salary\\\",\\n              \\\"SOC code\\\",\\n              \\\"Working hours per week\\\",\\n              \\\"Main work location\\\",\\n              \\\"Previous UK visas\\\",\\n              \\\"Criminal convictions\\\",\\n              \\\"TB test certificate\\\",\\n            ],\\n          },\\n          naturalisation: {\\n            schemaName: \\\"Naturalisation Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 55,\\n            emptyRequiredFields: [\\n              \\\"Current immigration status\\\",\\n              \\\"Date ILR granted\\\",\\n              \\\"Residency period details\\\",\\n              \\\"Life in the UK test pass date\\\",\\n              \\\"English language proof\\\",\\n              \\\"Good character declaration\\\",\\n              \\\"Referee details\\\",\\n            ],\\n          },\\n          visitor: {\\n            schemaName: \\\"Visitor Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 38,\\n            emptyRequiredFields: [\\n              \\\"Visit purpose\\\",\\n              \\\"Intended stay duration\\\",\\n              \\\"Accommodation address\\\",\\n              \\\"Return ticket booking\\\",\\n              \\\"Ties to home country\\\",\\n            ],\\n          },\\n          \\\"partner-spouse\\\": {\\n            schemaName: \\\"Partner/Spouse Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 62,\\n            emptyRequiredFields: [\\n              \\\"Sponsor relationship\\\",\\n              \\\"Sponsor immigration status\\\",\\n              \\\"Accommodation details\\\",\\n              \\\"Financial evidence\\\",\\n              \\\"English language proof\\\",\\n              \\\"Relationship evidence\\\",\\n            ],\\n          },\\n        };\\n\\n        const config = schemaConfigs[visaType];\\n        const formSchema: FormSchemaStatus = {\\n          ...config,\\n          filledFields: 0,\\n          completionPercentage: 0,\\n          lastUpdatedAt: null,\\n        };\\n\\n        set({ formSchema }, false, \\\"initFormSchema\\\");\\n      },\\n\\n      // Start document analysis (Application workflow)\\n      startAnalysis: async () => {\\n        const state = get();\\n\\n        // Get ready files (from reviewed groups, excluding unclassified)\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const readyFiles = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g)\\n        );\\n\\n        if (readyFiles.length === 0) {\\n          return;\\n        }\\n\\n        // Set analyzing phase\\n        set(\\n          {\\n            applicationPhase: \\\"analyzing\\\",\\n            isAnalyzingDocuments: true,\\n            analysisProgress: 0,\\n          },\\n          false,\\n          \\\"startAnalysis\\\"\\n        );\\n\\n        // Simulate analysis with progress\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 800));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`\\n          );\\n        }\\n\\n        // Generate analyzed files summary\\n        const analyzedFiles: AnalyzedFileSummary[] = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => ({\\n            id: f.id,\\n            name: f.name,\\n            groupTitle: g.title,\\n            pages: f.pages || 1,\\n            analyzedAt: new Date().toISOString(),\\n          }))\\n        );\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        // Update form schema with mock extracted data\\n        const currentSchema = state.formSchema;\\n        const filledFields = currentSchema\\n          ? Math.round(currentSchema.totalFields * 0.73)\\n          : 0;\\n        const updatedSchema: FormSchemaStatus | null = currentSchema\\n          ? {\\n              ...currentSchema,\\n              filledFields,\\n              completionPercentage: Math.round(\\n                (filledFields / currentSchema.totalFields) * 100\\n              ),\\n              lastUpdatedAt: new Date().toISOString(),\\n            }\\n          : null;\\n\\n        // Mock passport extraction\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            return {\\n              applicationPhase: \\\"questionnaire\\\",\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: new Date().toISOString(),\\n              analyzedFileIds,\\n              analyzedFiles,\\n              formSchema: updatedSchema,\\n              clientProfile: newProfile,\\n              // Reset questionnaire answers to trigger questionnaire flow\\n              questionnaireAnswers: {},\\n              // Mark analyzed files in allFiles\\n              allFiles: (() => {\\n                const newAllFiles = { ...state.allFiles };\\n                const now = new Date().toISOString();\\n                for (const fileId of analyzedFileIds) {\\n                  const file = newAllFiles[fileId];\\n                  if (file) {\\n                    newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n                  }\\n                }\\n                return newAllFiles;\\n              })(),\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\"\\n        );\\n\\n        // Don't auto-generate checklist - wait for questionnaire to be completed\\n        // Checklist will be generated when user submits questionnaire answers\\n      },\\n\\n      // Re-analyze: only updates analyzed files without regenerating checklist\\n      // Used when new files are added after initial checklist generation\\n      reAnalyze: async () => {\\n        const state = get();\\n\\n        // Get all currently reviewed file IDs\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const allReadyFileIds = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => f.id)\\n        );\\n\\n        // Find new files that haven't been analyzed\\n        const newFileIds = allReadyFileIds.filter(\\n          (id) => !state.analyzedFileIds.includes(id)\\n        );\\n\\n        if (newFileIds.length === 0) {\\n          return;\\n        }\\n\\n        // Brief analyzing state\\n        set(\\n          { isAnalyzingDocuments: true, analysisProgress: 0 },\\n          false,\\n          \\\"reAnalyze:start\\\"\\n        );\\n\\n        // Simulate quick analysis\\n        await new Promise((resolve) => setTimeout(resolve, 500));\\n        set({ analysisProgress: 50 }, false, \\\"reAnalyze:progress\\\");\\n        await new Promise((resolve) => setTimeout(resolve, 500));\\n\\n        // Update analyzed file IDs to include new files\\n        const updatedAnalyzedFileIds = [...state.analyzedFileIds, ...newFileIds];\\n\\n        set(\\n          (currentState) => {\\n            // Mark new files as analyzed in allFiles\\n            const newAllFiles = { ...currentState.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of newFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n            return {\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds: updatedAnalyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"reAnalyze:complete\\\"\\n        );\\n      },\\n\\n      // Launch Form Pilot (opens mock form with auto-fill)\\n      launchFormPilot: () => {\\n        const state = get();\\n\\n        // Import and use the bridge dynamically to avoid SSR issues\\n        import(\\\"@/lib/form-pilot-bridge\\\").then(({ launchFormPilotDemo, listenForCompletion }) => {\\n          // Launch the form pilot demo\\n          const { cleanup } = launchFormPilotDemo();\\n\\n          // Listen for completion\\n          const removeListener = listenForCompletion((result) => {\\n            set(\\n              (currentState) => ({\\n                formPilotStatus: {\\n                  ...currentState.formPilotStatus,\\n                  totalSessions: currentState.formPilotStatus.totalSessions + 1,\\n                  lastRunAt: new Date().toISOString(),\\n                  lastRunStatus: result.status === \\\"success\\\" ? \\\"success\\\" : \\\"error\\\",\\n                },\\n              }),\\n              false,\\n              \\\"formPilotComplete\\\"\\n            );\\n\\n            // Cleanup\\n            removeListener();\\n            cleanup();\\n          });\\n        });\\n\\n        // Update status immediately to show \\\"running\\\"\\n        set(\\n          (currentState) => ({\\n            formPilotStatus: {\\n              ...currentState.formPilotStatus,\\n              lastRunAt: new Date().toISOString(),\\n              lastRunStatus: null, // null indicates running/in-progress\\n            },\\n          }),\\n          false,\\n          \\\"launchFormPilot\\\"\\n        );\\n      },\\n\\n      // Start analysis and generate questionnaire (Application workflow)\\n      startAnalysisAndGenerateQuestionnaire: async () => {\\n        const state = get();\\n\\n        // Get ready files (from reviewed groups, excluding unclassified)\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const readyFiles = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g)\\n        );\\n\\n        if (readyFiles.length === 0) {\\n          return;\\n        }\\n\\n        // Set analyzing phase\\n        set(\\n          {\\n            applicationPhase: \\\"analyzing\\\",\\n            isAnalyzingDocuments: true,\\n            analysisProgress: 0,\\n          },\\n          false,\\n          \\\"startAnalysisAndGenerateQuestionnaire\\\"\\n        );\\n\\n        // Simulate analysis with progress (includes Gap Analysis)\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 800));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`\\n          );\\n        }\\n\\n        // Generate analyzed files summary\\n        const analyzedFiles: AnalyzedFileSummary[] = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => ({\\n            id: f.id,\\n            name: f.name,\\n            groupTitle: g.title,\\n            pages: f.pages || 1,\\n            analyzedAt: new Date().toISOString(),\\n          }))\\n        );\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        // Mock passport extraction\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            return {\\n              applicationPhase: \\\"questionnaire\\\",\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: new Date().toISOString(),\\n              analyzedFileIds,\\n              analyzedFiles,\\n              clientProfile: newProfile,\\n              // Mark analyzed files in allFiles\\n              allFiles: (() => {\\n                const newAllFiles = { ...state.allFiles };\\n                const now = new Date().toISOString();\\n                for (const fileId of analyzedFileIds) {\\n                  const file = newAllFiles[fileId];\\n                  if (file) {\\n                    newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n                  }\\n                }\\n                return newAllFiles;\\n              })(),\\n            };\\n          },\\n          false,\\n          \\\"analysisAndQuestionnaireComplete\\\"\\n        );\\n      },\\n\\n      // Submit questionnaire answers and proceed to checklist\\n      submitQuestionnaireAnswers: (answers: Record<string, string>) => {\\n        const state = get();\\n\\n        // Get all currently reviewed file IDs to mark as analyzed\\n        const analyzedFileIds = state.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(state.allFiles, g).map((f) => f.id));\\n\\n        set(\\n          {\\n            questionnaireAnswers: answers,\\n            applicationPhase: \\\"checklist\\\",\\n            // Mark analysis as complete when questionnaire is submitted\\n            lastAnalysisAt: new Date().toISOString(),\\n            // Track which files were analyzed\\n            analyzedFileIds,\\n          },\\n          false,\\n          \\\"submitQuestionnaireAnswers\\\"\\n        );\\n        // First generate the base checklist items (mock data)\\n        get().generateChecklist();\\n        // Then convert to enhanced format with issues\\n        get().generateEnhancedChecklist();\\n      },\\n\\n      // Generate checklist with mock data and quality issues\\n      generateChecklist: () => {\\n        const state = get();\\n        const passport = state.clientProfile.passport;\\n\\n        // Get passport file ID from document groups\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFileId = passportGroup?.fileIds[0]\\n          ? (state.allFiles[passportGroup.fileIds[0]]?.id || \\\"pp_1\\\")\\n          : \\\"pp_1\\\";\\n\\n        // Mock checklist items based on UK Skilled Worker Visa requirements\\n        const mockChecklistItems: ApplicationChecklistItem[] = [\\n          // ==========================================\\n          // PERSONAL INFORMATION\\n          // ==========================================\\n          {\\n            id: \\\"given_names\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"givenNames\\\",\\n            label: \\\"Given Names\\\",\\n            value: passport?.givenNames || null,\\n            source: passport?.givenNames ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.givenNames ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"surname\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"surname\\\",\\n            label: \\\"Surname\\\",\\n            value: passport?.surname || null,\\n            source: passport?.surname ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.surname ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"dob\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"dateOfBirth\\\",\\n            label: \\\"Date of Birth\\\",\\n            value: passport?.dateOfBirth || null,\\n            source: passport?.dateOfBirth ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfBirth ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"place_of_birth\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"placeOfBirth\\\",\\n            label: \\\"Place of Birth\\\",\\n            value: passport?.countryOfBirth || \\\"Beijing, China\\\",\\n            source: passport?.countryOfBirth ? \\\"extracted\\\" : \\\"extracted\\\",\\n            linkedFileIds: [passportFileId],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"gender\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"gender\\\",\\n            label: \\\"Gender\\\",\\n            value: passport?.sex || null,\\n            source: passport?.sex ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.sex ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_number\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportNumber\\\",\\n            label: \\\"Passport Number\\\",\\n            value: passport?.passportNumber || null,\\n            source: passport?.passportNumber ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.passportNumber ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_issue_date\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportIssueDate\\\",\\n            label: \\\"Passport Issue Date\\\",\\n            value: passport?.dateOfIssue || null,\\n            source: passport?.dateOfIssue ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfIssue ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_expiry_date\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportExpiryDate\\\",\\n            label: \\\"Passport Expiry Date\\\",\\n            value: passport?.dateOfExpiry || null,\\n            source: passport?.dateOfExpiry ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfExpiry ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"nationality\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"nationality\\\",\\n            label: \\\"Nationality\\\",\\n            value: passport?.nationality || null,\\n            source: passport?.nationality ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.nationality ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"current_address\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"currentAddress\\\",\\n            label: \\\"Current Residential Address\\\",\\n            value: \\\"15 Maple Street, London SW1A 1AA\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"phone_number\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"phoneNumber\\\",\\n            label: \\\"Contact Phone Number\\\",\\n            value: \\\"+44 7700 900123\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"email_address\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"emailAddress\\\",\\n            label: \\\"Email Address\\\",\\n            value: \\\"john.smith@email.com\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"national_insurance\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"nationalInsurance\\\",\\n            label: \\\"National Insurance Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"biometric_residence_permit\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"biometricResidencePermit\\\",\\n            label: \\\"Previous BRP Number (if applicable)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // EMPLOYMENT DETAILS\\n          // ==========================================\\n          {\\n            id: \\\"cos_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosNumber\\\",\\n            label: \\\"Certificate of Sponsorship (CoS) Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_name\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorName\\\",\\n            label: \\\"Sponsor Name\\\",\\n            value: \\\"ACME Technology Ltd\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_license_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorLicenseNumber\\\",\\n            label: \\\"Sponsor License Number\\\",\\n            value: \\\"A1B2C3D4E5F6\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_address\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorAddress\\\",\\n            label: \\\"Sponsor Address\\\",\\n            value: \\\"100 Tech Park, Cambridge CB1 2AB\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"job_title\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"jobTitle\\\",\\n            label: \\\"Job Title\\\",\\n            value: \\\"Senior Software Engineer\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"soc_code\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"socCode\\\",\\n            label: \\\"SOC Code\\\",\\n            value: \\\"2136\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"salary\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"annualSalary\\\",\\n            label: \\\"Annual Salary (GBP)\\\",\\n            value: \\\"£65,000\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"employment_start_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"employmentStartDate\\\",\\n            label: \\\"Employment Start Date\\\",\\n            value: \\\"2024-04-01\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"working_hours\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"workingHoursPerWeek\\\",\\n            label: \\\"Working Hours per Week\\\",\\n            value: \\\"37.5\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"work_address\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"workAddress\\\",\\n            label: \\\"Work Location Address\\\",\\n            value: \\\"100 Tech Park, Cambridge CB1 2AB\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cos_assigned_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosAssignedDate\\\",\\n            label: \\\"CoS Assigned Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cos_expiry_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosExpiryDate\\\",\\n            label: \\\"CoS Expiry Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"shortage_occupation\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"shortageOccupation\\\",\\n            label: \\\"Is Role on Shortage Occupation List?\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n\\n          // ==========================================\\n          // FINANCIAL EVIDENCE\\n          // ==========================================\\n          {\\n            id: \\\"bank_account_holder\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankAccountHolder\\\",\\n            label: \\\"Bank Account Holder Name\\\",\\n            value: passport?.givenNames && passport?.surname ? `${passport.givenNames} ${passport.surname}` : null,\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: passport?.givenNames ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"bank_name\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankName\\\",\\n            label: \\\"Bank Name\\\",\\n            value: \\\"HSBC UK\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"account_number\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"accountNumber\\\",\\n            label: \\\"Account Number (Last 4 digits)\\\",\\n            value: \\\"****4521\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"bank_balance\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankBalance\\\",\\n            label: \\\"Current Balance\\\",\\n            value: \\\"£28,450.00\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"funds_held_period\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"fundsHeldPeriod\\\",\\n            label: \\\"Funds Held for 28 Consecutive Days\\\",\\n            value: \\\"Yes - Verified\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"statement_date\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"statementDate\\\",\\n            label: \\\"Bank Statement Date\\\",\\n            value: \\\"2024-01-15\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"maintenance_requirement\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"maintenanceRequirement\\\",\\n            label: \\\"Maintenance Requirement Met (£1,270)\\\",\\n            value: \\\"Yes\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"additional_funds_source\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"additionalFundsSource\\\",\\n            label: \\\"Source of Additional Funds\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"sponsor_maintenance_cert\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"sponsorMaintenanceCert\\\",\\n            label: \\\"Sponsor Maintenance Certification\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // TRAVEL HISTORY\\n          // ==========================================\\n          {\\n            id: \\\"previous_uk_visa\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"previousUKVisa\\\",\\n            label: \\\"Previous UK Visa History\\\",\\n            value: \\\"Tier 4 Student Visa (2015-2018)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [passportFileId],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"current_immigration_status\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"currentImmigrationStatus\\\",\\n            label: \\\"Current Immigration Status\\\",\\n            value: \\\"Outside UK\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"travel_history_10_years\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"travelHistory10Years\\\",\\n            label: \\\"Countries Visited (Last 10 Years)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"partial\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"visa_refusals\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"visaRefusals\\\",\\n            label: \\\"Previous Visa Refusals\\\",\\n            value: \\\"None\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"deportation_history\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"deportationHistory\\\",\\n            label: \\\"Deportation or Removal History\\\",\\n            value: \\\"None\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"criminal_convictions\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"criminalConvictions\\\",\\n            label: \\\"Criminal Convictions\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"uk_address_history\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"ukAddressHistory\\\",\\n            label: \\\"UK Address History (Last 5 Years)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // EDUCATION & QUALIFICATIONS\\n          // ==========================================\\n          {\\n            id: \\\"highest_qualification\\\",\\n            section: \\\"education\\\",\\n            field: \\\"highestQualification\\\",\\n            label: \\\"Highest Qualification\\\",\\n            value: \\\"BSc Computer Science\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"institution_name\\\",\\n            section: \\\"education\\\",\\n            field: \\\"institutionName\\\",\\n            label: \\\"Institution Name\\\",\\n            value: \\\"University of Manchester\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"graduation_date\\\",\\n            section: \\\"education\\\",\\n            field: \\\"graduationDate\\\",\\n            label: \\\"Graduation Date\\\",\\n            value: \\\"July 2018\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"english_test_type\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestType\\\",\\n            label: \\\"English Language Test Type\\\",\\n            value: \\\"IELTS Academic\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_score\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestScore\\\",\\n            label: \\\"English Test Score\\\",\\n            value: \\\"Overall 7.5 (L:8.0, R:7.5, W:7.0, S:7.5)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_date\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestDate\\\",\\n            label: \\\"English Test Date\\\",\\n            value: \\\"2023-06-15\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cefr_level\\\",\\n            section: \\\"education\\\",\\n            field: \\\"cefrLevel\\\",\\n            label: \\\"CEFR Level\\\",\\n            value: \\\"B1 (Minimum Required)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_reference\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestReference\\\",\\n            label: \\\"English Test Reference Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"atas_certificate\\\",\\n            section: \\\"education\\\",\\n            field: \\\"atasCertificate\\\",\\n            label: \\\"ATAS Certificate (if applicable)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // FAMILY INFORMATION\\n          // ==========================================\\n          {\\n            id: \\\"marital_status\\\",\\n            section: \\\"family\\\",\\n            field: \\\"maritalStatus\\\",\\n            label: \\\"Marital Status\\\",\\n            value: \\\"Married\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"spouse_name\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spouseName\\\",\\n            label: \\\"Spouse Full Name\\\",\\n            value: \\\"Jane Smith\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"spouse_nationality\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spouseNationality\\\",\\n            label: \\\"Spouse Nationality\\\",\\n            value: \\\"Chinese\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"dependants_count\\\",\\n            section: \\\"family\\\",\\n            field: \\\"dependantsCount\\\",\\n            label: \\\"Number of Dependants\\\",\\n            value: \\\"1 (Spouse applying separately)\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"children_count\\\",\\n            section: \\\"family\\\",\\n            field: \\\"childrenCount\\\",\\n            label: \\\"Number of Children\\\",\\n            value: \\\"0\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"spouse_passport_number\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spousePassportNumber\\\",\\n            label: \\\"Spouse Passport Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"marriage_certificate_date\\\",\\n            section: \\\"family\\\",\\n            field: \\\"marriageCertificateDate\\\",\\n            label: \\\"Marriage Certificate Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"family_members_in_uk\\\",\\n            section: \\\"family\\\",\\n            field: \\\"familyMembersInUK\\\",\\n            label: \\\"Other Family Members in UK\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n        ];\\n\\n        // Mock quality issues based on common Skilled Worker visa issues\\n        const mockQualityIssues: QualityIssue[] = [\\n          {\\n            id: \\\"issue_cos\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"CoS Number Required\\\",\\n            description: \\\"Certificate of Sponsorship number is missing. This is mandatory for Skilled Worker visa applications. Please obtain from your sponsor.\\\",\\n            linkedChecklistItemId: \\\"cos_number\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_cos_dates\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"CoS Dates Required\\\",\\n            description: \\\"CoS assigned date and expiry date are missing. These are required to verify the validity of your sponsorship.\\\",\\n            linkedChecklistItemId: \\\"cos_assigned_date\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_travel_history\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"warning\\\",\\n            title: \\\"Incomplete Travel History\\\",\\n            description: \\\"Travel history for the last 10 years is incomplete. UKVI requires full travel history including all countries visited.\\\",\\n            linkedChecklistItemId: \\\"travel_history_10_years\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_criminal_check\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"Criminal Convictions Declaration Required\\\",\\n            description: \\\"You must declare any criminal convictions. This is a mandatory question on the visa application form.\\\",\\n            linkedChecklistItemId: \\\"criminal_convictions\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_english_ref\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"warning\\\",\\n            title: \\\"English Test Reference Number\\\",\\n            description: \\\"The reference number for your English language test is required for verification with the test provider.\\\",\\n            linkedChecklistItemId: \\\"english_test_reference\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_passport_validity\\\",\\n            type: \\\"validity\\\",\\n            severity: \\\"info\\\",\\n            title: \\\"Passport Validity Check\\\",\\n            description: \\\"Ensure passport is valid for the duration of intended stay. Recommended to have at least 6 months validity beyond visa end date.\\\",\\n            linkedChecklistItemId: \\\"passport_expiry_date\\\",\\n            linkedFileId: passportFileId,\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_shortage\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"info\\\",\\n            title: \\\"Shortage Occupation Status\\\",\\n            description: \\\"Please confirm whether your role is on the Shortage Occupation List, as this affects salary threshold requirements.\\\",\\n            linkedChecklistItemId: \\\"shortage_occupation\\\",\\n            isResolved: false,\\n          },\\n        ];\\n\\n        set(\\n          {\\n            applicationPhase: \\\"checklist\\\",\\n            applicationChecklistItems: mockChecklistItems,\\n            qualityIssues: mockQualityIssues,\\n          },\\n          false,\\n          \\\"generateChecklist\\\"\\n        );\\n\\n        // Also generate enhanced checklist for the new workspace UI\\n        get().generateEnhancedChecklist();\\n      },\\n\\n      // Update a checklist field value\\n      updateChecklistField: (fieldId: string, value: string) => {\\n        set(\\n          (state) => ({\\n            applicationChecklistItems: state.applicationChecklistItems.map((item) =>\\n              item.id === fieldId\\n                ? {\\n                    ...item,\\n                    value,\\n                    source: \\\"manual\\\",\\n                    status: value ? \\\"complete\\\" : \\\"missing\\\",\\n                  }\\n                : item\\n            ),\\n          }),\\n          false,\\n          \\\"updateChecklistField\\\"\\n        );\\n      },\\n\\n      // Resolve a quality issue\\n      resolveIssue: (issueId: string) => {\\n        set(\\n          (state) => ({\\n            qualityIssues: state.qualityIssues.map((issue) =>\\n              issue.id === issueId ? { ...issue, isResolved: true } : issue\\n            ),\\n          }),\\n          false,\\n          \\\"resolveIssue\\\"\\n        );\\n      },\\n\\n      // Go back to a previous phase\\n      goBackToPhase: (phase: ApplicationPhase) => {\\n        set({ applicationPhase: phase }, false, \\\"goBackToPhase\\\");\\n      },\\n\\n      // Toggle checklist section expansion\\n      toggleChecklistSection: (sectionId: ChecklistSectionType) => {\\n        set(\\n          (state) => ({\\n            checklistSectionExpanded: {\\n              ...state.checklistSectionExpanded,\\n              [sectionId]: !state.checklistSectionExpanded[sectionId],\\n            },\\n          }),\\n          false,\\n          \\\"toggleChecklistSection\\\"\\n        );\\n      },\\n\\n      // ============================================\\n      // Enhanced Checklist Workspace Actions\\n      // ============================================\\n\\n      // Select a checklist item (for detail panel)\\n      selectChecklistItem: (itemId: string | null) => {\\n        set({ selectedChecklistItemId: itemId }, false, \\\"selectChecklistItem\\\");\\n      },\\n\\n      // Select an issue (for detail view)\\n      selectIssue: (issueId: string | null) => {\\n        set({ selectedIssueId: issueId }, false, \\\"selectIssue\\\");\\n      },\\n\\n      // Update enhanced checklist field value\\n      updateEnhancedChecklistField: (fieldId: string, value: string) => {\\n        set(\\n          (state) => ({\\n            enhancedChecklistItems: state.enhancedChecklistItems.map((item) =>\\n              item.id === fieldId\\n                ? {\\n                    ...item,\\n                    value,\\n                    source: \\\"manual\\\" as const,\\n                    status: value ? \\\"complete\\\" as const : \\\"missing\\\" as const,\\n                  }\\n                : item\\n            ),\\n          }),\\n          false,\\n          \\\"updateEnhancedChecklistField\\\"\\n        );\\n      },\\n\\n      // Update issue status\\n      updateIssueStatus: (issueId: string, status: IssueStatus) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"status_changed\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                previousStatus: issue.status,\\n                newStatus: status,\\n              };\\n              return {\\n                ...issue,\\n                status,\\n                updatedAt: new Date().toISOString(),\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"updateIssueStatus\\\"\\n        );\\n      },\\n\\n      // Add a note to an issue\\n      addIssueNote: (issueId: string, note: string) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"note_added\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: note,\\n              };\\n              return {\\n                ...issue,\\n                updatedAt: new Date().toISOString(),\\n                notes: [\\n                  ...issue.notes,\\n                  {\\n                    id: `note_${Date.now()}`,\\n                    content: note,\\n                    createdAt: new Date().toISOString(),\\n                    createdBy: { id: currentUser.id, name: currentUser.name },\\n                  },\\n                ],\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"addIssueNote\\\"\\n        );\\n      },\\n\\n      // Forward issue to client\\n      forwardIssueToClient: (issueId: string, data: ForwardToClientData) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"forwarded\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: data.method === \\\"email\\\"\\n                  ? `Forwarded via email to ${data.recipientEmail}`\\n                  : \\\"Shareable link generated\\\",\\n              };\\n              return {\\n                ...issue,\\n                status: \\\"forwarded\\\" as IssueStatus,\\n                updatedAt: new Date().toISOString(),\\n                forwardData: data,\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n            forwardModalOpen: false,\\n            forwardModalIssueId: null,\\n          }),\\n          false,\\n          \\\"forwardIssueToClient\\\"\\n        );\\n      },\\n\\n      // Mark issue as resolved\\n      markIssueResolved: (issueId: string, resolution?: string) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"resolved\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: resolution,\\n                previousStatus: issue.status,\\n                newStatus: \\\"resolved\\\",\\n              };\\n              return {\\n                ...issue,\\n                status: \\\"resolved\\\" as IssueStatus,\\n                updatedAt: new Date().toISOString(),\\n                resolvedAt: new Date().toISOString(),\\n                resolvedBy: { id: currentUser.id, name: currentUser.name },\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"markIssueResolved\\\"\\n        );\\n      },\\n\\n      // Open forward modal\\n      openForwardModal: (issueId: string) => {\\n        set(\\n          { forwardModalOpen: true, forwardModalIssueId: issueId },\\n          false,\\n          \\\"openForwardModal\\\"\\n        );\\n      },\\n\\n      // Close forward modal\\n      closeForwardModal: () => {\\n        set(\\n          { forwardModalOpen: false, forwardModalIssueId: null },\\n          false,\\n          \\\"closeForwardModal\\\"\\n        );\\n      },\\n\\n      // Generate enhanced checklist with linked documents and issues\\n      generateEnhancedChecklist: () => {\\n        const state = get();\\n        const currentUser = SYSTEM_USERS[0];\\n\\n        // Create linked documents from analyzed files\\n        const createLinkedDocument = (fileId: string): LinkedDocument | null => {\\n          const file = state.allFiles[fileId];\\n          if (!file || file.isRemoved) return null;\\n          // Find the group this file belongs to\\n          const group = state.documentGroups.find((g) =>\\n            g.fileIds.includes(fileId)\\n          );\\n          return {\\n            fileId: file.id,\\n            fileName: file.name,\\n            groupTitle: group?.title || \\\"Unknown\\\",\\n            pageNumbers: [1], // Mock page number\\n            extractedText: `Extracted from ${file.name}`,\\n          };\\n        };\\n\\n        // Get passport file info\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFile = passportGroup?.fileIds[0]\\n          ? state.allFiles[passportGroup.fileIds[0]]\\n          : undefined;\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: !!passportFile,\\n              linkedFileId: passportFile?.id,\\n              linkedFileName: passportFile?.name,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\\n            {\\n              id: \\\"ev_photo\\\",\\n              name: \\\"Passport-sized Photograph\\\",\\n              description: \\\"Recent photo meeting UK visa photo requirements (45mm x 35mm)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"JPEG\\\", \\\"PNG\\\"],\\n            },\\n            {\\n              id: \\\"ev_previous_passport\\\",\\n              name: \\\"Previous Passports (if applicable)\\\",\\n              description: \\\"Any previous passports showing UK immigration history\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          employment: [\\n            {\\n              id: \\\"ev_cos\\\",\\n              name: \\\"Certificate of Sponsorship (CoS)\\\",\\n              description: \\\"CoS reference number from licensed UK sponsor\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n            },\\n            {\\n              id: \\\"ev_employment_contract\\\",\\n              name: \\\"Employment Contract / Job Offer Letter\\\",\\n              description: \\\"Signed contract showing job title, salary, and start date\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_sponsor_letter\\\",\\n              name: \\\"Sponsor Confirmation Letter\\\",\\n              description: \\\"Letter from sponsor confirming employment details\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          financial: [\\n            {\\n              id: \\\"ev_bank_statements\\\",\\n              name: \\\"Bank Statements (28 days)\\\",\\n              description: \\\"Showing funds held for 28 consecutive days ending within 31 days of application\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be dated within 31 days of application\\\",\\n            },\\n            {\\n              id: \\\"ev_payslip\\\",\\n              name: \\\"Payslip\\\",\\n              description: \\\"Recent payslips showing salary payments (last 3 months recommended)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          travel: [\\n            {\\n              id: \\\"ev_travel_history\\\",\\n              name: \\\"Travel History Documentation\\\",\\n              description: \\\"Evidence of travel history for last 10 years (passport stamps, boarding passes)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n            {\\n              id: \\\"ev_old_visas\\\",\\n              name: \\\"Previous UK Visas (if any)\\\",\\n              description: \\\"Copies of any previous UK visas or BRPs\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          education: [\\n            {\\n              id: \\\"ev_english_cert\\\",\\n              name: \\\"English Language Test Certificate\\\",\\n              description: \\\"IELTS, TOEFL, or approved SELT certificate (CEFR B1 minimum)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be within 2 years of application date\\\",\\n            },\\n            {\\n              id: \\\"ev_degree_cert\\\",\\n              name: \\\"Degree Certificate / Academic Qualification\\\",\\n              description: \\\"Original or certified copy of highest qualification\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_atas\\\",\\n              name: \\\"ATAS Certificate (if applicable)\\\",\\n              description: \\\"Academic Technology Approval Scheme certificate for certain fields\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          family: [\\n            {\\n              id: \\\"ev_marriage_cert\\\",\\n              name: \\\"Marriage Certificate (if applicable)\\\",\\n              description: \\\"Official marriage certificate if applying with spouse\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_birth_cert\\\",\\n              name: \\\"Birth Certificates (if applicable)\\\",\\n              description: \\\"For any dependent children\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          other: [],\\n        };\\n\\n        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\\n\\n        // Convert existing checklist items to enhanced format\\n        const enhancedItems: EnhancedChecklistItem[] = state.applicationChecklistItems.map((item) => ({\\n          id: item.id,\\n          section: item.section,\\n          field: item.field,\\n          label: item.label,\\n          value: item.value,\\n          source: item.source,\\n          linkedDocuments: item.linkedFileIds\\n            .map(createLinkedDocument)\\n            .filter((doc): doc is LinkedDocument => doc !== null),\\n          requiredEvidence: getRequiredEvidence(item.section),\\n          status: item.status,\\n          isRequired: item.isRequired,\\n          isEditable: true,\\n          confidenceScore: item.source === \\\"extracted\\\" ? 95 : undefined,\\n        }));\\n\\n        // Convert existing quality issues to enhanced format\\n        const existingEnhancedIssues: EnhancedQualityIssue[] = state.qualityIssues.map((issue) => ({\\n          id: issue.id,\\n          type: issue.type,\\n          severity: issue.severity,\\n          status: issue.isResolved ? \\\"resolved\\\" as IssueStatus : \\\"open\\\" as IssueStatus,\\n          title: issue.title,\\n          description: issue.description,\\n          linkedChecklistItemId: issue.linkedChecklistItemId,\\n          linkedFileIds: issue.linkedFileId ? [issue.linkedFileId] : [],\\n          history: [\\n            {\\n              id: `history_${issue.id}_created`,\\n              timestamp: new Date().toISOString(),\\n              action: \\\"created\\\" as const,\\n              performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n            },\\n          ],\\n          notes: [],\\n          createdAt: new Date().toISOString(),\\n          updatedAt: new Date().toISOString(),\\n        }));\\n\\n        // Generate issues for missing fields (checklist items with status \\\"missing\\\")\\n        const missingFieldIssues: EnhancedQualityIssue[] = enhancedItems\\n          .filter((item) => item.status === \\\"missing\\\" && item.isRequired)\\n          .map((item) => ({\\n            id: `issue_missing_field_${item.id}`,\\n            type: \\\"missing\\\" as QualityIssueType,\\n            severity: \\\"warning\\\" as QualityIssueSeverity,\\n            status: \\\"open\\\" as IssueStatus,\\n            title: `Missing: ${item.label}`,\\n            description: `The field \\\"${item.label}\\\" is required but has not been provided. Please fill in this information or upload supporting documents.`,\\n            linkedChecklistItemId: item.id,\\n            linkedFileIds: [],\\n            history: [\\n              {\\n                id: `history_missing_field_${item.id}_created`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"created\\\" as const,\\n                performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n              },\\n            ],\\n            notes: [],\\n            createdAt: new Date().toISOString(),\\n            updatedAt: new Date().toISOString(),\\n          }));\\n\\n        // Generate issues for missing required evidence\\n        const allRequiredEvidence = Object.values(SECTION_REQUIRED_EVIDENCE).flat();\\n        const missingEvidenceIssues: EnhancedQualityIssue[] = allRequiredEvidence\\n          .filter((ev) => ev.isMandatory && !ev.isUploaded)\\n          .map((ev) => {\\n            // Find a related checklist item in the same section\\n            const sectionType = Object.entries(SECTION_REQUIRED_EVIDENCE)\\n              .find(([, evidenceList]) => evidenceList.some((e) => e.id === ev.id))?.[0] as ChecklistSectionType | undefined;\\n            const relatedItem = enhancedItems.find((item) => item.section === sectionType);\\n\\n            return {\\n              id: `issue_missing_evidence_${ev.id}`,\\n              type: \\\"missing\\\" as QualityIssueType,\\n              severity: \\\"error\\\" as QualityIssueSeverity,\\n              status: \\\"open\\\" as IssueStatus,\\n              title: `Missing Document: ${ev.name}`,\\n              description: ev.description || `The document \\\"${ev.name}\\\" is required but has not been uploaded.`,\\n              suggestedAction: \\\"Upload the required document\\\",\\n              linkedChecklistItemId: relatedItem?.id || enhancedItems[0]?.id || \\\"\\\",\\n              linkedFileIds: [],\\n              history: [\\n                {\\n                  id: `history_missing_evidence_${ev.id}_created`,\\n                  timestamp: new Date().toISOString(),\\n                  action: \\\"created\\\" as const,\\n                  performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n                },\\n              ],\\n              notes: [],\\n              createdAt: new Date().toISOString(),\\n              updatedAt: new Date().toISOString(),\\n            };\\n          });\\n\\n        // Combine all issues (filter out duplicates by checking if similar issue exists)\\n        const existingIssueIds = new Set(existingEnhancedIssues.map((i) => i.linkedChecklistItemId));\\n        const filteredMissingFieldIssues = missingFieldIssues.filter(\\n          (i) => !existingIssueIds.has(i.linkedChecklistItemId)\\n        );\\n\\n        const enhancedIssues: EnhancedQualityIssue[] = [\\n          ...existingEnhancedIssues,\\n          ...filteredMissingFieldIssues,\\n          ...missingEvidenceIssues,\\n        ];\\n\\n        set(\\n          {\\n            enhancedChecklistItems: enhancedItems,\\n            enhancedQualityIssues: enhancedIssues,\\n            // Auto-select first item if available\\n            selectedChecklistItemId: enhancedItems.length > 0 ? enhancedItems[0].id : null,\\n          },\\n          false,\\n          \\\"generateEnhancedChecklist\\\"\\n        );\\n      },\\n\\n      // Initialize case from CreateCaseModal data\\n      // Passport is parsed immediately at case creation (not dependent on analysis)\\n      // Case Notes is auto-confirmed, Passport requires confirm review\\n      initializeCaseFromCreation: (data: {\\n        visaType: VisaType;\\n        passport: PassportInfo;\\n        caseNotesFileName: string;\\n        passportFileName: string;\\n        referenceNumber?: string;\\n        advisorId?: string;\\n        assistantId?: string;\\n      }) => {\\n        // Mock case notes summary (would be extracted from uploaded case notes)\\n        const mockCaseNotesSummary: CaseNotesSummary = {\\n          summary: \\\"Client seeking Skilled Worker visa for a Senior Software Engineer position at ACME Technology Ltd. Has previous UK visa history (Tier 4 Student, 2015-2018). Strong financial background with verified savings. Main concern is ensuring CoS documentation is complete.\\\",\\n          clientBackground: \\\"British national currently residing in London. Has worked in tech industry for 8+ years.\\\",\\n          keyDates: [\\\"CoS expected: Feb 2024\\\", \\\"Target application: Mar 2024\\\"],\\n          extractedAt: new Date().toISOString(),\\n        };\\n\\n        // Create files for allFiles store\\n        const caseNotesFileId = `cn_${Date.now()}`;\\n        const passportFileId = `pp_${Date.now()}`;\\n\\n        const newAllFiles: Record<string, DocumentFile> = {\\n          [caseNotesFileId]: {\\n            id: caseNotesFileId,\\n            name: data.caseNotesFileName,\\n            size: \\\"1.2 MB\\\",\\n            pages: 5,\\n            date: \\\"Just now\\\",\\n            type: \\\"pdf\\\",\\n            isNew: false, // Not marked as new since it's auto-confirmed\\n            containerIds: [\\\"case_notes\\\"],\\n          },\\n          [passportFileId]: {\\n            id: passportFileId,\\n            name: data.passportFileName,\\n            size: \\\"0.8 MB\\\",\\n            pages: 1,\\n            date: \\\"Just now\\\",\\n            type: \\\"pdf\\\",\\n            isNew: true,\\n            containerIds: [\\\"passport\\\"],\\n          },\\n        };\\n\\n        // Create document groups - case notes is special (auto-confirmed), passport requires review\\n        const caseNotesGroup: DocumentGroup = {\\n          id: \\\"case_notes\\\",\\n          title: \\\"Case Notes\\\",\\n          tag: \\\"Case Notes\\\",\\n          mergedFileName: data.caseNotesFileName,\\n          status: \\\"reviewed\\\", // Auto-confirmed, no review needed\\n          isSpecial: true, // Special document - doesn't require manual review\\n          fileIds: [caseNotesFileId],\\n          files: [],\\n        };\\n\\n        // Passport document requires confirm review (not isSpecial)\\n        const passportGroup: DocumentGroup = {\\n          id: \\\"passport\\\",\\n          title: \\\"Passport\\\",\\n          tag: \\\"Passport\\\",\\n          mergedFileName: data.passportFileName,\\n          status: \\\"pending\\\", // Requires confirm review\\n          fileIds: [passportFileId],\\n          files: [],\\n        };\\n\\n        // Create empty unclassified group for future uploads\\n        const unclassifiedGroup: DocumentGroup = {\\n          id: \\\"unclassified\\\",\\n          title: \\\"Unclassified\\\",\\n          tag: \\\"unclassified\\\",\\n          status: \\\"pending\\\",\\n          fileIds: [],\\n          files: [],\\n        };\\n\\n        // Client profile includes passport data parsed at creation time\\n        // Passport parsing is immediate, not dependent on analysis\\n        const profileWithPassport = {\\n          passport: data.passport,\\n          completeness: 0,\\n        };\\n        profileWithPassport.completeness = calculateCompleteness(profileWithPassport);\\n\\n        const documentGroups = [unclassifiedGroup, caseNotesGroup, passportGroup];\\n        const previews = syncFilePreviewsFromState(newAllFiles, documentGroups);\\n\\n        set(\\n          {\\n            // Navigation - land on overview page\\n            activeNav: \\\"overview\\\",\\n            selectedVisaType: data.visaType,\\n            clientProfile: profileWithPassport,\\n            caseReference: data.referenceNumber || \\\"REF-2024-001\\\",\\n            caseNotesSummary: mockCaseNotesSummary,\\n            allFiles: newAllFiles,\\n            documentGroups,\\n            uploadedFilePreviews: previews,\\n            // Reset analysis state\\n            lastAnalysisAt: null,\\n            analyzedFileIds: [],\\n            analyzedFiles: [],\\n            isAnalyzingDocuments: false,\\n            analysisProgress: 0,\\n            // Reset questionnaire to trigger case assessment form\\n            questionnaireAnswers: {},\\n            // Reset application phase to analyzing (ready to start analysis)\\n            applicationPhase: \\\"analyzing\\\",\\n            formSchema: null,\\n          },\\n          false,\\n          \\\"initializeCaseFromCreation\\\"\\n        );\\n\\n        // Initialize form schema for the selected visa type\\n        get().initFormSchema(data.visaType);\\n\\n        // Evolve checklist based on new data\\n        get().evolveChecklist();\\n      },\\n\\n      // Reset\\n      reset: () => {\\n        set(initialState, false, \\\"reset\\\");\\n      },\\n    }),\\n    { name: \\\"case-detail-store\\\" },\\n  ),\\n);\\n\\n// Selector hooks for optimized re-renders\\nexport const useActiveNav = () =>\\n  useCaseDetailStore((state) => state.activeNav);\\nexport const useHighlightedGroupId = () =>\\n  useCaseDetailStore((state) => state.highlightedGroupId);\\nexport const useClientProfile = () =>\\n  useCaseDetailStore((state) => state.clientProfile);\\nexport const useCaseNotesSummary = () =>\\n  useCaseDetailStore((state) => state.caseNotesSummary);\\nexport const useSelectedVisaType = () =>\\n  useCaseDetailStore((state) => state.selectedVisaType);\\nexport const useChecklist = () =>\\n  useCaseDetailStore((state) => state.checklist);\\nexport const useChecklistStage = () =>\\n  useCaseDetailStore((state) => state.checklist.stage);\\n// Returns document groups with files resolved from allFiles (backward compatible)\\n// UI components can access group.files directly\\n// Uses separate subscriptions + useMemo to avoid infinite re-render loops\\nexport const useDocumentGroups = () => {\\n  const groups = useCaseDetailStore((state) => state.documentGroups);\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(\\n    () =>\\n      groups.map((group) => ({\\n        ...group,\\n        files: group.fileIds\\n          .map((id) => allFiles[id])\\n          .filter((f): f is DocumentFile => f !== undefined),\\n      })),\\n    [groups, allFiles]\\n  );\\n};\\nexport const useIsLoadingDocuments = () =>\\n  useCaseDetailStore((state) => state.isLoadingDocuments);\\nexport const useUploadedFilePreviews = () =>\\n  useCaseDetailStore((state) => state.uploadedFilePreviews);\\nexport const useApplicationPhase = () =>\\n  useCaseDetailStore((state) => state.applicationPhase);\\nexport const useFormSchema = () =>\\n  useCaseDetailStore((state) => state.formSchema);\\nexport const useFormPilotStatus = () =>\\n  useCaseDetailStore((state) => state.formPilotStatus);\\nexport const useAnalyzedFiles = () =>\\n  useCaseDetailStore((state) => state.analyzedFiles);\\nexport const useApplicationChecklistItems = () =>\\n  useCaseDetailStore((state) => state.applicationChecklistItems);\\nexport const useQualityIssues = () =>\\n  useCaseDetailStore((state) => state.qualityIssues);\\nexport const useQuestionnaireAnswers = () =>\\n  useCaseDetailStore((state) => state.questionnaireAnswers);\\nexport const useChecklistSectionExpanded = () =>\\n  useCaseDetailStore((state) => state.checklistSectionExpanded);\\n\\n// Enhanced Checklist Workspace Selectors\\nexport const useEnhancedChecklistItems = () =>\\n  useCaseDetailStore((state) => state.enhancedChecklistItems);\\nexport const useEnhancedQualityIssues = () =>\\n  useCaseDetailStore((state) => state.enhancedQualityIssues);\\nexport const useSelectedChecklistItemId = () =>\\n  useCaseDetailStore((state) => state.selectedChecklistItemId);\\nexport const useSelectedIssueId = () =>\\n  useCaseDetailStore((state) => state.selectedIssueId);\\nexport const useForwardModalOpen = () =>\\n  useCaseDetailStore((state) => state.forwardModalOpen);\\nexport const useForwardModalIssueId = () =>\\n  useCaseDetailStore((state) => state.forwardModalIssueId);\\n\\n// Get selected checklist item with its issues\\nexport const useSelectedChecklistItem = () =>\\n  useCaseDetailStore((state) => {\\n    if (!state.selectedChecklistItemId) return null;\\n    return state.enhancedChecklistItems.find(\\n      (item) => item.id === state.selectedChecklistItemId\\n    ) || null;\\n  });\\n\\n// Get issues for selected checklist item - memoized to prevent infinite loops\\nexport const useIssuesForSelectedItem = () => {\\n  const selectedChecklistItemId = useCaseDetailStore(\\n    (state) => state.selectedChecklistItemId\\n  );\\n  const enhancedQualityIssues = useCaseDetailStore(\\n    (state) => state.enhancedQualityIssues\\n  );\\n\\n  return useMemo(() => {\\n    if (!selectedChecklistItemId) return [];\\n    return enhancedQualityIssues.filter(\\n      (issue) => issue.linkedChecklistItemId === selectedChecklistItemId\\n    );\\n  }, [selectedChecklistItemId, enhancedQualityIssues]);\\n};\\n\\n// Get issue counts by severity - memoized to prevent infinite loops\\nexport const useIssueCounts = () => {\\n  const enhancedQualityIssues = useCaseDetailStore(\\n    (state) => state.enhancedQualityIssues\\n  );\\n\\n  return useMemo(() => {\\n    const issues = enhancedQualityIssues.filter(\\n      (issue) => issue.status !== \\\"resolved\\\"\\n    );\\n    return {\\n      errors: issues.filter((i) => i.severity === \\\"error\\\").length,\\n      warnings: issues.filter((i) => i.severity === \\\"warning\\\").length,\\n      info: issues.filter((i) => i.severity === \\\"info\\\").length,\\n      total: issues.length,\\n    };\\n  }, [enhancedQualityIssues]);\\n};\\n\\n// Selector to detect if there are new ready files since the last analysis\\n// Only triggers when NEW files are confirmed (ready), not when files become pending\\nexport const useHasNewFilesAfterAnalysis = () =>\\n  useCaseDetailStore((state) => {\\n    // Only check if analysis has been completed\\n    if (!state.lastAnalysisAt) return false;\\n\\n    // Get all file IDs from reviewed groups (excluding unclassified and removed)\\n    const currentReviewedFileIds = state.documentGroups\\n      .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n      .flatMap((g) => getContainerFiles(state.allFiles, g).map((f) => f.id));\\n\\n    const analyzedFileIds = state.analyzedFileIds;\\n\\n    // Only check for NEW ready files - files that are reviewed but weren't analyzed\\n    // Don't trigger for removals (e.g., when a group goes from reviewed to pending)\\n    const hasNewReadyFiles = currentReviewedFileIds.some(\\n      (id) => !analyzedFileIds.includes(id)\\n    );\\n\\n    return hasNewReadyFiles;\\n  });\\n\\n// Returns the count of new ready document groups that have unanalyzed files\\nexport const useNewFilesCount = () =>\\n  useCaseDetailStore((state) => {\\n    if (!state.lastAnalysisAt) return 0;\\n\\n    const analyzedFileIds = state.analyzedFileIds;\\n\\n    // Count document groups that have at least one new unanalyzed file\\n    const groupsWithNewFiles = state.documentGroups.filter((g) => {\\n      if (g.id === \\\"unclassified\\\" || g.status !== \\\"reviewed\\\") return false;\\n\\n      // Check if this group has any files that weren't analyzed\\n      const activeFiles = getContainerFiles(state.allFiles, g);\\n      return activeFiles.some((f) => !analyzedFileIds.includes(f.id));\\n    });\\n\\n    return groupsWithNewFiles.length;\\n  });\\n\\n// ============================================================================\\n// One-to-Many Model Selectors\\n// ============================================================================\\n\\n// Get all files from the central store\\nexport const useAllFiles = () =>\\n  useCaseDetailStore((state) => state.allFiles);\\n\\n// Get unclassified files (files with no container associations)\\nexport const useUnclassifiedFiles = () => {\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(\\n    () =>\\n      Object.values(allFiles).filter(\\n        (f) => !f.isRemoved && f.containerIds.length === 0\\n      ),\\n    [allFiles]\\n  );\\n};\\n\\n// Get files for a specific container/group\\nexport const useContainerFiles = (containerId: string) => {\\n  const groups = useCaseDetailStore((state) => state.documentGroups);\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(() => {\\n    const group = groups.find((g) => g.id === containerId);\\n    if (!group) return [];\\n    return group.fileIds\\n      .map((id) => allFiles[id])\\n      .filter((f): f is DocumentFile => f !== undefined && !f.isRemoved);\\n  }, [groups, allFiles, containerId]);\\n};\\n\\n// Get the number of containers a file is in (for showing linked badge)\\nexport const useFileContainerCount = (fileId: string) =>\\n  useCaseDetailStore((state) => {\\n    const file = state.allFiles[fileId];\\n    return file?.containerIds.length ?? 0;\\n  });\\n\\n// Check if a file is in multiple containers (shared/reused)\\nexport const useIsFileShared = (fileId: string) =>\\n  useCaseDetailStore((state) => {\\n    const file = state.allFiles[fileId];\\n    return (file?.containerIds.length ?? 0) > 1;\\n  });\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 3897,\n      \"oldLines\": 12,\n      \"newStart\": 3897,\n      \"newLines\": 31,\n      \"lines\": [\n        \"           };\",\n        \"         };\",\n        \" \",\n        \"-        // Get passport file info\",\n        \"-        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\",\n        \"-        const passportFile = passportGroup?.fileIds[0]\",\n        \"-          ? state.allFiles[passportGroup.fileIds[0]]\",\n        \"-          : undefined;\",\n        \"+        // Evidence ID → Document Group ID mapping for auto-linking\",\n        \"+        const EVIDENCE_GROUP_MAP: Record<string, string> = {\",\n        \"+          ev_passport: \\\"passport\\\",\",\n        \"+          ev_bank_statements: \\\"bank_statement\\\",\",\n        \"+          ev_payslip: \\\"bank_statement\\\", // payslip may be in same group\",\n        \"+          ev_employment_contract: \\\"employment_letter\\\",\",\n        \"+          ev_travel_history: \\\"travel_history\\\",\",\n        \"+          ev_english_cert: \\\"education\\\",\",\n        \"+          ev_degree_cert: \\\"education\\\",\",\n        \"+        };\",\n        \" \",\n        \"+        // Auto-link evidence to existing document groups\",\n        \"+        const autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\",\n        \"+          const groupId = EVIDENCE_GROUP_MAP[ev.id];\",\n        \"+          if (!groupId) return ev;\",\n        \"+          const group = state.documentGroups.find(g => g.id === groupId);\",\n        \"+          if (!group || group.fileIds.length === 0) return ev;\",\n        \"+          return {\",\n        \"+            ...ev,\",\n        \"+            isUploaded: true,\",\n        \"+            linkedFileId: group.id,\",\n        \"+            linkedFileName: group.title,\",\n        \"+          };\",\n        \"+        };\",\n        \"+\",\n        \"         // Required evidence configuration per section (UK Skilled Worker Visa)\",\n        \"         const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\",\n        \"           personal: [\"\n      ]\n    },\n    {\n      \"oldStart\": 3910,\n      \"oldLines\": 9,\n      \"newStart\": 3929,\n      \"newLines\": 7,\n      \"lines\": [\n        \"               id: \\\"ev_passport\\\",\",\n        \"               name: \\\"Valid Passport\\\",\",\n        \"               description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\",\n        \"-              isUploaded: !!passportFile,\",\n        \"-              linkedFileId: passportFile?.id,\",\n        \"-              linkedFileName: passportFile?.name,\",\n        \"+              isUploaded: false,\",\n        \"               isMandatory: true,\",\n        \"               acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\",\n        \"               validityPeriod: \\\"Must be valid for duration of stay\\\",\"\n      ]\n    }\n  ],\n  \"userModified\": false,\n  \"replaceAll\": false\n}","timestamp":1769669163991,"toolName":"Edit","toolUseId":"toolu_01Q68ccda3JdZweGE4uyadpd","toolInput":{"replace_all":false,"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","old_string":"        // Get passport file info\n        const passportGroup = state.documentGroups.find(g => g.id === \"passport\");\n        const passportFile = passportGroup?.fileIds[0]\n          ? state.allFiles[passportGroup.fileIds[0]]\n          : undefined;\n\n        // Required evidence configuration per section (UK Skilled Worker Visa)\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\n          personal: [\n            {\n              id: \"ev_passport\",\n              name: \"Valid Passport\",\n              description: \"Current passport with at least 1 blank page for visa vignette\",\n              isUploaded: !!passportFile,\n              linkedFileId: passportFile?.id,\n              linkedFileName: passportFile?.name,\n              isMandatory: true,\n              acceptedFormats: [\"PDF\", \"JPEG\", \"PNG\"],\n              validityPeriod: \"Must be valid for duration of stay\",\n            },","new_string":"        // Evidence ID → Document Group ID mapping for auto-linking\n        const EVIDENCE_GROUP_MAP: Record<string, string> = {\n          ev_passport: \"passport\",\n          ev_bank_statements: \"bank_statement\",\n          ev_payslip: \"bank_statement\", // payslip may be in same group\n          ev_employment_contract: \"employment_letter\",\n          ev_travel_history: \"travel_history\",\n          ev_english_cert: \"education\",\n          ev_degree_cert: \"education\",\n        };\n\n        // Auto-link evidence to existing document groups\n        const autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\n          const groupId = EVIDENCE_GROUP_MAP[ev.id];\n          if (!groupId) return ev;\n          const group = state.documentGroups.find(g => g.id === groupId);\n          if (!group || group.fileIds.length === 0) return ev;\n          return {\n            ...ev,\n            isUploaded: true,\n            linkedFileId: group.id,\n            linkedFileName: group.title,\n          };\n        };\n\n        // Required evidence configuration per section (UK Skilled Worker Visa)\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\n          personal: [\n            {\n              id: \"ev_passport\",\n              name: \"Valid Passport\",\n              description: \"Current passport with at least 1 blank page for visa vignette\",\n              isUploaded: false,\n              isMandatory: true,\n              acceptedFormats: [\"PDF\", \"JPEG\", \"PNG\"],\n              validityPeriod: \"Must be valid for duration of stay\",\n            },"},"toolResult":"{\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n  \"oldString\": \"        // Get passport file info\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFile = passportGroup?.fileIds[0]\\n          ? state.allFiles[passportGroup.fileIds[0]]\\n          : undefined;\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: !!passportFile,\\n              linkedFileId: passportFile?.id,\\n              linkedFileName: passportFile?.name,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\",\n  \"newString\": \"        // Evidence ID → Document Group ID mapping for auto-linking\\n        const EVIDENCE_GROUP_MAP: Record<string, string> = {\\n          ev_passport: \\\"passport\\\",\\n          ev_bank_statements: \\\"bank_statement\\\",\\n          ev_payslip: \\\"bank_statement\\\", // payslip may be in same group\\n          ev_employment_contract: \\\"employment_letter\\\",\\n          ev_travel_history: \\\"travel_history\\\",\\n          ev_english_cert: \\\"education\\\",\\n          ev_degree_cert: \\\"education\\\",\\n        };\\n\\n        // Auto-link evidence to existing document groups\\n        const autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\\n          const groupId = EVIDENCE_GROUP_MAP[ev.id];\\n          if (!groupId) return ev;\\n          const group = state.documentGroups.find(g => g.id === groupId);\\n          if (!group || group.fileIds.length === 0) return ev;\\n          return {\\n            ...ev,\\n            isUploaded: true,\\n            linkedFileId: group.id,\\n            linkedFileName: group.title,\\n          };\\n        };\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\",\n  \"originalFile\": \"import { useMemo } from \\\"react\\\";\\nimport { create } from \\\"zustand\\\";\\nimport { devtools } from \\\"zustand/middleware\\\";\\nimport {\\n  CaseDetailStore,\\n  CaseDetailState,\\n  CaseDetailNavItem,\\n  ChecklistStage,\\n  ChecklistItemStatus,\\n  UploadedFilePreview,\\n  QuestionnaireQuestion,\\n  ChecklistItem,\\n  DocumentGroup,\\n  DocumentFile,\\n  ApplicationPhase,\\n  FormSchemaStatus,\\n  FormPilotStatus,\\n  AnalyzedFileSummary,\\n  ApplicationChecklistItem,\\n  QualityIssue,\\n  QualityIssueType,\\n  QualityIssueSeverity,\\n  ChecklistSectionType,\\n  CaseNotesSummary,\\n  // Enhanced types for checklist workspace\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  IssueStatus,\\n  IssueHistoryEntry,\\n  ForwardToClientData,\\n  LinkedDocument,\\n  RequiredEvidence,\\n} from \\\"@/types/case-detail\\\";\\nimport { PassportInfo, VisaType } from \\\"@/types\\\";\\nimport { parseDocumentPath } from \\\"@/lib/document-path-parser\\\";\\n\\n// Old-style document group type (with files embedded) - for legacy data\\ninterface LegacyDocumentGroup {\\n  id: string;\\n  title: string;\\n  tag: string;\\n  mergedFileName?: string;\\n  status: \\\"pending\\\" | \\\"reviewed\\\";\\n  hasChanges?: boolean;\\n  files: Array<Omit<DocumentFile, 'containerIds'> & { containerIds?: string[] }>;\\n  isSpecial?: boolean;\\n  entityType?: DocumentFile['entityType'];\\n  generatedName?: string;\\n}\\n\\n// Initial document groups data - Rich mock data with many pages per category\\n// Uses legacy format (files embedded) - converted to new model when used\\nconst INITIAL_DOCUMENT_GROUPS_LEGACY: LegacyDocumentGroup[] = [\\n  {\\n    id: \\\"passport\\\",\\n    title: \\\"Passport\\\",\\n    tag: \\\"Passport\\\",\\n    mergedFileName: \\\"Passport_Combined.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"pp_1\\\",\\n        name: \\\"Passport_Cover.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_2\\\",\\n        name: \\\"Passport_Bio_Page.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_3\\\",\\n        name: \\\"Passport_Visa_Page_1.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_4\\\",\\n        name: \\\"Passport_Visa_Page_2.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_5\\\",\\n        name: \\\"Passport_Stamp_Page.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_6\\\",\\n        name: \\\"Passport_Back_Cover.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"bank_statement\\\",\\n    title: \\\"Bank Statement\\\",\\n    tag: \\\"Bank Statement\\\",\\n    mergedFileName: \\\"BankStatement_6Months.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"bs_1\\\",\\n        name: \\\"Statement_Jan_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_2\\\",\\n        name: \\\"Statement_Jan_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_3\\\",\\n        name: \\\"Statement_Feb_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_4\\\",\\n        name: \\\"Statement_Feb_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_5\\\",\\n        name: \\\"Statement_Mar_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_6\\\",\\n        name: \\\"Statement_Mar_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_7\\\",\\n        name: \\\"Statement_Apr_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_8\\\",\\n        name: \\\"Statement_Apr_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_9\\\",\\n        name: \\\"Statement_May_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_10\\\",\\n        name: \\\"Statement_May_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_11\\\",\\n        name: \\\"Statement_Jun_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_12\\\",\\n        name: \\\"Statement_Jun_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"employment_letter\\\",\\n    title: \\\"Employment Letter\\\",\\n    tag: \\\"Employment Letter\\\",\\n    mergedFileName: \\\"Employment_Verification.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"emp_1\\\",\\n        name: \\\"Employment_Letter_Page1.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_2\\\",\\n        name: \\\"Employment_Letter_Page2.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_3\\\",\\n        name: \\\"Salary_Slip_Jan.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_4\\\",\\n        name: \\\"Salary_Slip_Feb.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_5\\\",\\n        name: \\\"Salary_Slip_Mar.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"utility_bill\\\",\\n    title: \\\"Utility Bill\\\",\\n    tag: \\\"Utility Bill\\\",\\n    mergedFileName: \\\"Utility_Bills_2024.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"ub_1\\\",\\n        name: \\\"Electric_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_2\\\",\\n        name: \\\"Electric_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_3\\\",\\n        name: \\\"Gas_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_4\\\",\\n        name: \\\"Gas_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_5\\\",\\n        name: \\\"Water_Bill_Q1.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_6\\\",\\n        name: \\\"Council_Tax_Bill.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_7\\\",\\n        name: \\\"Internet_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_8\\\",\\n        name: \\\"Internet_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"tax_documents\\\",\\n    title: \\\"Tax Documents\\\",\\n    tag: \\\"Tax Documents\\\",\\n    mergedFileName: \\\"Tax_Records_2023.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"tax_1\\\",\\n        name: \\\"P60_2023.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_2\\\",\\n        name: \\\"Tax_Return_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_3\\\",\\n        name: \\\"Tax_Return_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_4\\\",\\n        name: \\\"Tax_Return_Page3.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_5\\\",\\n        name: \\\"Tax_Calculation.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_6\\\",\\n        name: \\\"Tax_Payment_Receipt.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"education\\\",\\n    title: \\\"Education Certificates\\\",\\n    tag: \\\"Education\\\",\\n    mergedFileName: \\\"Education_Documents.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"edu_1\\\",\\n        name: \\\"Degree_Certificate.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_2\\\",\\n        name: \\\"Transcript_Page1.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_3\\\",\\n        name: \\\"Transcript_Page2.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_4\\\",\\n        name: \\\"Transcript_Page3.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_5\\\",\\n        name: \\\"IELTS_Result.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_6\\\",\\n        name: \\\"IELTS_TRF.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_7\\\",\\n        name: \\\"Professional_Certificate.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"travel_history\\\",\\n    title: \\\"Travel History\\\",\\n    tag: \\\"Travel History\\\",\\n    mergedFileName: \\\"Travel_Documents.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"travel_1\\\",\\n        name: \\\"Old_Passport_Page1.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_2\\\",\\n        name: \\\"Old_Passport_Page2.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_3\\\",\\n        name: \\\"Old_Passport_Page3.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_4\\\",\\n        name: \\\"Flight_Itinerary_UK.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_5\\\",\\n        name: \\\"Hotel_Booking_UK.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"unclassified\\\",\\n    title: \\\"Unclassified\\\",\\n    tag: \\\"Unclassified\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"u1\\\",\\n        name: \\\"Scan_Page_001.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u2\\\",\\n        name: \\\"Scan_Page_002.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u3\\\",\\n        name: \\\"Scan_Page_003.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u4\\\",\\n        name: \\\"Unknown_Doc_A.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u5\\\",\\n        name: \\\"Unknown_Doc_B.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u6\\\",\\n        name: \\\"Misc_Scan_001.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u7\\\",\\n        name: \\\"Misc_Scan_002.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u8\\\",\\n        name: \\\"Photo_Doc.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n];\\n\\n// System users (mock data)\\nexport const SYSTEM_USERS: { id: string; name: string; email: string; role: string }[] = [\\n  { id: \\\"john-001\\\", name: \\\"John Smith\\\", email: \\\"john@lawfirm.com\\\", role: \\\"Partner\\\" },\\n  { id: \\\"sarah-002\\\", name: \\\"Sarah Johnson\\\", email: \\\"sarah@lawfirm.com\\\", role: \\\"Senior Associate\\\" },\\n  { id: \\\"michael-003\\\", name: \\\"Michael Chen\\\", email: \\\"michael@lawfirm.com\\\", role: \\\"Associate\\\" },\\n  { id: \\\"emma-004\\\", name: \\\"Emma Wilson\\\", email: \\\"emma@lawfirm.com\\\", role: \\\"Paralegal\\\" },\\n  { id: \\\"david-005\\\", name: \\\"David Brown\\\", email: \\\"david@lawfirm.com\\\", role: \\\"Paralegal\\\" },\\n  { id: \\\"lisa-006\\\", name: \\\"Lisa Taylor\\\", email: \\\"lisa@lawfirm.com\\\", role: \\\"Legal Assistant\\\" },\\n];\\n\\n// Initial questionnaire questions\\nconst initialQuestions: QuestionnaireQuestion[] = [\\n  {\\n    id: \\\"q1\\\",\\n    question: \\\"Is the applicant currently in the UK?\\\",\\n    questionZh: \\\"申请人目前在英国吗？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q2\\\",\\n    question: \\\"Does the applicant have a valid passport?\\\",\\n    questionZh: \\\"申请人是否持有有效护照？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q3\\\",\\n    question: \\\"Has the applicant applied for a UK visa before?\\\",\\n    questionZh: \\\"申请人之前是否申请过英国签证？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q4\\\",\\n    question: \\\"What is the purpose of the application?\\\",\\n    questionZh: \\\"申请的目的是什么？\\\",\\n    type: \\\"single-choice\\\",\\n    options: [\\n      { value: \\\"work\\\", label: \\\"Work\\\" },\\n      { value: \\\"study\\\", label: \\\"Study\\\" },\\n      { value: \\\"family\\\", label: \\\"Family reunion\\\" },\\n      { value: \\\"visit\\\", label: \\\"Visit\\\" },\\n      { value: \\\"settlement\\\", label: \\\"Settlement\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"q5\\\",\\n    question: \\\"Does the applicant have a sponsor (employer/university)?\\\",\\n    questionZh: \\\"申请人是否有担保人（雇主/大学）？\\\",\\n    type: \\\"boolean\\\",\\n    dependsOn: { questionId: \\\"q4\\\", value: \\\"work\\\" },\\n  },\\n];\\n\\n// Initial checklist items (for detailed stage)\\nconst initialChecklistItems: ChecklistItem[] = [\\n  {\\n    id: \\\"identity\\\",\\n    label: \\\"Identity Documents\\\",\\n    category: \\\"identity\\\",\\n    status: \\\"pending\\\",\\n    children: [\\n      { id: \\\"passport\\\", label: \\\"Valid Passport\\\", status: \\\"pending\\\" },\\n      { id: \\\"photo\\\", label: \\\"Passport Photo\\\", status: \\\"pending\\\" },\\n      { id: \\\"prev-visas\\\", label: \\\"Previous Visa History\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"financial\\\",\\n    label: \\\"Financial Evidence\\\",\\n    category: \\\"financial\\\",\\n    status: \\\"pending\\\",\\n    dependsOn: [\\\"identity\\\"],\\n    children: [\\n      {\\n        id: \\\"bank-statements\\\",\\n        label: \\\"Bank Statements (6 months)\\\",\\n        status: \\\"pending\\\",\\n      },\\n      {\\n        id: \\\"employment-letter\\\",\\n        label: \\\"Employment Letter\\\",\\n        status: \\\"pending\\\",\\n      },\\n      { id: \\\"tax-records\\\", label: \\\"Tax Records\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"sponsorship\\\",\\n    label: \\\"Sponsorship Documents\\\",\\n    category: \\\"sponsorship\\\",\\n    status: \\\"pending\\\",\\n    dependsOn: [\\\"identity\\\"],\\n    children: [\\n      { id: \\\"cos\\\", label: \\\"Certificate of Sponsorship\\\", status: \\\"pending\\\" },\\n      { id: \\\"job-offer\\\", label: \\\"Job Offer Letter\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"english\\\",\\n    label: \\\"English Language\\\",\\n    category: \\\"english\\\",\\n    status: \\\"pending\\\",\\n    children: [\\n      { id: \\\"ielts\\\", label: \\\"IELTS/English Test Results\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n];\\n\\n// Initial state\\nconst initialState: CaseDetailState = {\\n  caseId: null,\\n  caseReference: \\\"REF-2024-001\\\",\\n  caseNotesSummary: null,\\n  caseTeam: {\\n    lawyer: { id: \\\"john-001\\\", name: \\\"John\\\", email: \\\"john@example.com\\\" },\\n  },\\n  activeNav: \\\"overview\\\",\\n  highlightedGroupId: null,\\n  clientProfile: {\\n    completeness: 0,\\n  },\\n  selectedVisaType: null,\\n  checklist: {\\n    stage: \\\"empty\\\",\\n    questions: initialQuestions,\\n    items: initialChecklistItems,\\n    progress: {\\n      completed: 0,\\n      total: 0,\\n    },\\n  },\\n  uploadedFilePreviews: [],\\n  maxPreviewFiles: 6,\\n  allFiles: {},\\n  documentGroups: [],\\n  isLoadingDocuments: false,\\n  demoStage: 0,\\n  isAnalyzingDocuments: false,\\n  analysisProgress: 0,\\n  lastAnalysisAt: null,\\n  analyzedFileIds: [],\\n  // Application Phase - starts at analyzing since visa type is set at case creation\\n  applicationPhase: \\\"analyzing\\\",\\n  formSchema: null,\\n  formPilotStatus: {\\n    totalSessions: 0,\\n    lastRunAt: null,\\n    lastRunStatus: null,\\n  },\\n  analyzedFiles: [],\\n  // Application Checklist\\n  applicationChecklistItems: [],\\n  qualityIssues: [],\\n  questionnaireAnswers: {},\\n  checklistSectionExpanded: {\\n    personal: true,\\n    employment: true,\\n    financial: false,\\n    travel: false,\\n    education: false,\\n    family: false,\\n    other: false,\\n  },\\n  // Enhanced Checklist Workspace State\\n  enhancedChecklistItems: [],\\n  enhancedQualityIssues: [],\\n  selectedChecklistItemId: null,\\n  selectedIssueId: null,\\n  forwardModalOpen: false,\\n  forwardModalIssueId: null,\\n};\\n\\n// ============================================================================\\n// Helper Functions for 1:N File-Container Model\\n// ============================================================================\\n\\n// Helper to sync file previews from allFiles and documentGroups\\nconst syncFilePreviewsFromState = (\\n  allFiles: Record<string, DocumentFile>,\\n  groups: DocumentGroup[],\\n): UploadedFilePreview[] => {\\n  const previews: UploadedFilePreview[] = [];\\n  for (const group of groups) {\\n    for (const fileId of group.fileIds) {\\n      const file = allFiles[fileId];\\n      if (file && !file.isRemoved) {\\n        previews.push({\\n          id: file.id,\\n          name: file.name,\\n          type: file.type === \\\"pdf\\\" ? \\\"application/pdf\\\" : \\\"application/msword\\\",\\n          groupId: group.id,\\n        });\\n      }\\n    }\\n  }\\n  return previews;\\n};\\n\\n// Helper to get files for a specific container\\nconst getContainerFiles = (\\n  allFiles: Record<string, DocumentFile>,\\n  group: DocumentGroup,\\n): DocumentFile[] => {\\n  return group.fileIds\\n    .map(id => allFiles[id])\\n    .filter((f): f is DocumentFile => f !== undefined && !f.isRemoved);\\n};\\n\\n// Helper to get unclassified files (files with no container associations)\\nconst getUnclassifiedFiles = (\\n  allFiles: Record<string, DocumentFile>,\\n): DocumentFile[] => {\\n  return Object.values(allFiles).filter(\\n    f => !f.isRemoved && f.containerIds.length === 0\\n  );\\n};\\n\\n// Legacy compatibility: Helper to sync file previews from old-style groups (with files array)\\n// Used during migration and for backwards compatibility\\nconst syncFilePreviewsFromGroups = (\\n  groups: Array<DocumentGroup & { files?: DocumentFile[] }>,\\n): UploadedFilePreview[] => {\\n  const previews: UploadedFilePreview[] = [];\\n  for (const group of groups) {\\n    // Support both new model (fileIds) and old model (files)\\n    const files = (group as { files?: DocumentFile[] }).files || [];\\n    for (const file of files) {\\n      previews.push({\\n        id: file.id,\\n        name: file.name,\\n        type: file.type === \\\"pdf\\\" ? \\\"application/pdf\\\" : \\\"application/msword\\\",\\n        groupId: group.id,\\n      });\\n    }\\n  }\\n  return previews;\\n};\\n\\n// Convert old-style groups (files embedded) to new model (files separate, groups have fileIds)\\nconst convertLegacyGroupsToNewModel = (\\n  legacyGroups: LegacyDocumentGroup[]\\n): { allFiles: Record<string, DocumentFile>; documentGroups: DocumentGroup[] } => {\\n  const allFiles: Record<string, DocumentFile> = {};\\n  const documentGroups: DocumentGroup[] = [];\\n\\n  for (const group of legacyGroups) {\\n    const fileIds: string[] = [];\\n\\n    for (const file of group.files) {\\n      // Determine containerIds: empty if unclassified group, otherwise [group.id]\\n      const containerIds = group.id === 'unclassified' ? [] : [group.id];\\n\\n      // Store file in allFiles with containerIds\\n      allFiles[file.id] = {\\n        ...file,\\n        containerIds: file.containerIds || containerIds,\\n      };\\n      fileIds.push(file.id);\\n    }\\n\\n    // Create new-style group with fileIds instead of files\\n    documentGroups.push({\\n      id: group.id,\\n      title: group.title,\\n      tag: group.tag,\\n      mergedFileName: group.mergedFileName,\\n      status: group.status,\\n      hasChanges: group.hasChanges,\\n      fileIds,\\n      files: [],\\n      isSpecial: group.isSpecial,\\n      entityType: group.entityType,\\n      generatedName: group.generatedName,\\n    });\\n  }\\n\\n  return { allFiles, documentGroups };\\n};\\n\\n// Calculate profile completeness\\nconst calculateCompleteness = (\\n  profile: CaseDetailState[\\\"clientProfile\\\"],\\n): number => {\\n  let score = 0;\\n  const total = 3; // passport, contact info (email), contact info (phone)\\n\\n  if (profile.passport) score += 1;\\n  if (profile.contactInfo?.email) score += 1;\\n  if (profile.contactInfo?.phone) score += 1;\\n\\n  return Math.round((score / total) * 100);\\n};\\n\\n// Calculate checklist progress\\nconst calculateProgress = (\\n  items: ChecklistItem[],\\n): { completed: number; total: number } => {\\n  let completed = 0;\\n  let total = 0;\\n\\n  const countItems = (itemList: ChecklistItem[]) => {\\n    for (const item of itemList) {\\n      if (item.children && item.children.length > 0) {\\n        countItems(item.children);\\n      } else {\\n        total++;\\n        if (item.status === \\\"completed\\\") completed++;\\n      }\\n    }\\n  };\\n\\n  countItems(items);\\n  return { completed, total };\\n};\\n\\nexport const useCaseDetailStore = create<CaseDetailStore>()(\\n  devtools(\\n    (set, get) => ({\\n      ...initialState,\\n\\n      // Navigation\\n      setActiveNav: (nav: CaseDetailNavItem) => {\\n        set({ activeNav: nav }, false, \\\"setActiveNav\\\");\\n      },\\n\\n      navigateToDocumentGroup: (groupId: string) => {\\n        set(\\n          { activeNav: \\\"documents\\\", highlightedGroupId: groupId },\\n          false,\\n          \\\"navigateToDocumentGroup\\\"\\n        );\\n      },\\n\\n      clearHighlightedGroup: () => {\\n        set({ highlightedGroupId: null }, false, \\\"clearHighlightedGroup\\\");\\n      },\\n\\n      // Case\\n      setCaseId: (caseId: string) => {\\n        set({ caseId }, false, \\\"setCaseId\\\");\\n      },\\n\\n      setCaseReference: (reference: string) => {\\n        set({ caseReference: reference }, false, \\\"setCaseReference\\\");\\n      },\\n\\n      // Case Team\\n      setLawyer: (lawyer) => {\\n        set(\\n          (state) => ({\\n            caseTeam: { ...state.caseTeam, lawyer },\\n          }),\\n          false,\\n          \\\"setLawyer\\\"\\n        );\\n      },\\n\\n      setAssistant: (assistant) => {\\n        set(\\n          (state) => ({\\n            caseTeam: { ...state.caseTeam, assistant },\\n          }),\\n          false,\\n          \\\"setAssistant\\\"\\n        );\\n      },\\n\\n      // Case Notes Summary\\n      setCaseNotesSummary: (summary: CaseNotesSummary | null) => {\\n        set({ caseNotesSummary: summary }, false, \\\"setCaseNotesSummary\\\");\\n      },\\n\\n      // Client Profile\\n      updateClientProfile: (updates) => {\\n        set(\\n          (state) => {\\n            const newProfile = { ...state.clientProfile, ...updates };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n            return { clientProfile: newProfile };\\n          },\\n          false,\\n          \\\"updateClientProfile\\\",\\n        );\\n      },\\n\\n      setPassportInfo: (passport: PassportInfo) => {\\n        set(\\n          (state) => {\\n            const newProfile = { ...state.clientProfile, passport };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n            return { clientProfile: newProfile };\\n          },\\n          false,\\n          \\\"setPassportInfo\\\",\\n        );\\n      },\\n\\n      // Visa Type\\n      setVisaType: (type: VisaType | null) => {\\n        set({ selectedVisaType: type }, false, \\\"setVisaType\\\");\\n      },\\n\\n      // Checklist\\n      setChecklistStage: (stage: ChecklistStage) => {\\n        set(\\n          (state) => ({\\n            checklist: { ...state.checklist, stage },\\n          }),\\n          false,\\n          \\\"setChecklistStage\\\",\\n        );\\n      },\\n\\n      answerQuestion: (questionId: string, answer: unknown) => {\\n        set(\\n          (state) => {\\n            const questions = state.checklist.questions.map((q) =>\\n              q.id === questionId ? { ...q, answer } : q,\\n            );\\n            return {\\n              checklist: { ...state.checklist, questions },\\n            };\\n          },\\n          false,\\n          \\\"answerQuestion\\\",\\n        );\\n      },\\n\\n      updateChecklistItem: (itemId: string, status: ChecklistItemStatus) => {\\n        set(\\n          (state) => {\\n            const updateItemRecursive = (\\n              items: ChecklistItem[],\\n            ): ChecklistItem[] => {\\n              return items.map((item) => {\\n                if (item.id === itemId) {\\n                  return { ...item, status };\\n                }\\n                if (item.children) {\\n                  return {\\n                    ...item,\\n                    children: updateItemRecursive(item.children),\\n                  };\\n                }\\n                return item;\\n              });\\n            };\\n\\n            const newItems = updateItemRecursive(state.checklist.items);\\n            const progress = calculateProgress(newItems);\\n\\n            return {\\n              checklist: {\\n                ...state.checklist,\\n                items: newItems,\\n                progress,\\n              },\\n            };\\n          },\\n          false,\\n          \\\"updateChecklistItem\\\",\\n        );\\n      },\\n\\n      evolveChecklist: () => {\\n        const state = get();\\n        const { checklist, uploadedFilePreviews } = state;\\n        const fileCount = uploadedFilePreviews.length;\\n        const answeredQuestions = checklist.questions.filter(\\n          (q) => q.answer !== undefined,\\n        ).length;\\n        const totalQuestions = checklist.questions.length;\\n\\n        let newStage: ChecklistStage = checklist.stage;\\n\\n        // Evolution logic based on files and answers\\n        if (fileCount === 0) {\\n          newStage = \\\"empty\\\";\\n        } else if (fileCount >= 1 && checklist.stage === \\\"empty\\\") {\\n          newStage = \\\"questionnaire\\\";\\n        } else if (\\n          (answeredQuestions >= totalQuestions * 0.5 || fileCount >= 3) &&\\n          checklist.stage === \\\"questionnaire\\\"\\n        ) {\\n          newStage = \\\"partial\\\";\\n        } else if (\\n          (answeredQuestions === totalQuestions || state.selectedVisaType) &&\\n          checklist.stage === \\\"partial\\\"\\n        ) {\\n          newStage = \\\"detailed\\\";\\n        }\\n\\n        if (newStage !== checklist.stage) {\\n          set(\\n            (state) => ({\\n              checklist: {\\n                ...state.checklist,\\n                stage: newStage,\\n                progress: calculateProgress(state.checklist.items),\\n              },\\n            }),\\n            false,\\n            \\\"evolveChecklist\\\",\\n          );\\n        }\\n      },\\n\\n      // File Previews\\n      addFilePreview: (file: UploadedFilePreview) => {\\n        set(\\n          (state) => {\\n            const newPreviews = [...state.uploadedFilePreviews, file];\\n            return { uploadedFilePreviews: newPreviews };\\n          },\\n          false,\\n          \\\"addFilePreview\\\",\\n        );\\n        // Trigger checklist evolution\\n        get().evolveChecklist();\\n      },\\n\\n      removeFilePreview: (fileId: string) => {\\n        set(\\n          (state) => ({\\n            uploadedFilePreviews: state.uploadedFilePreviews.filter(\\n              (f) => f.id !== fileId,\\n            ),\\n          }),\\n          false,\\n          \\\"removeFilePreview\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      setFilePreviews: (files: UploadedFilePreview[]) => {\\n        set({ uploadedFilePreviews: files }, false, \\\"setFilePreviews\\\");\\n        get().evolveChecklist();\\n      },\\n\\n      // Demo Controls\\n      advanceDemoStage: () => {\\n        set(\\n          (state) => {\\n            const stages: ChecklistStage[] = [\\n              \\\"empty\\\",\\n              \\\"questionnaire\\\",\\n              \\\"partial\\\",\\n              \\\"detailed\\\",\\n            ];\\n            const currentIndex = stages.indexOf(state.checklist.stage);\\n            const nextIndex = Math.min(currentIndex + 1, stages.length - 1);\\n\\n            return {\\n              demoStage: state.demoStage + 1,\\n              checklist: {\\n                ...state.checklist,\\n                stage: stages[nextIndex],\\n                progress: calculateProgress(state.checklist.items),\\n              },\\n            };\\n          },\\n          false,\\n          \\\"advanceDemoStage\\\",\\n        );\\n      },\\n\\n      resetDemoStage: () => {\\n        set(\\n          {\\n            demoStage: 0,\\n            checklist: {\\n              ...initialState.checklist,\\n              stage: \\\"empty\\\",\\n            },\\n          },\\n          false,\\n          \\\"resetDemoStage\\\",\\n        );\\n      },\\n\\n      // Document Groups\\n      setDocumentGroups: (groups: DocumentGroup[]) => {\\n        const previews = syncFilePreviewsFromGroups(groups);\\n        set(\\n          { documentGroups: groups, uploadedFilePreviews: previews },\\n          false,\\n          \\\"setDocumentGroups\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      addDocumentGroup: (templateName: string) => {\\n        set(\\n          (state) => {\\n            const newGroup: DocumentGroup = {\\n              id: `group_${Date.now()}`,\\n              title: templateName,\\n              tag: templateName,\\n              mergedFileName: `${templateName}.pdf`,\\n              status: \\\"pending\\\",\\n              fileIds: [],\\n              files: [],\\n            };\\n            // Append new category to the end of the array\\n            // The grid filters out \\\"unclassified\\\" so new categories appear at the end\\n            return { documentGroups: [...state.documentGroups, newGroup] };\\n          },\\n          false,\\n          \\\"addDocumentGroup\\\",\\n        );\\n      },\\n\\n      deleteDocumentGroup: (groupId: string) => {\\n        set(\\n          (state) => {\\n            const newGroups = state.documentGroups.filter(\\n              (g) => g.id !== groupId,\\n            );\\n            const previews = syncFilePreviewsFromGroups(newGroups);\\n            return {\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"deleteDocumentGroup\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      renameDocumentGroup: (groupId: string, newTitle: string) => {\\n        set(\\n          (state) => ({\\n            documentGroups: state.documentGroups.map((g) =>\\n              g.id === groupId ? { ...g, mergedFileName: newTitle } : g,\\n            ),\\n          }),\\n          false,\\n          \\\"renameDocumentGroup\\\",\\n        );\\n      },\\n\\n      // ============================================\\n      // One-to-Many File-Container Actions\\n      // ============================================\\n\\n      // Add file to container (creates reference)\\n      addFileToContainer: (fileId: string, containerId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            const group = state.documentGroups.find(g => g.id === containerId);\\n\\n            if (!file || !group) return state;\\n\\n            // Idempotency: if already in container, do nothing\\n            if (file.containerIds.includes(containerId)) return state;\\n\\n            // Update file's containerIds\\n            const updatedFile = {\\n              ...file,\\n              containerIds: [...file.containerIds, containerId],\\n              isNew: true,\\n            };\\n\\n            // Update container's fileIds\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (g.id === containerId) {\\n                return {\\n                  ...g,\\n                  fileIds: [fileId, ...g.fileIds], // Add to beginning\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"addFileToContainer\\\",\\n        );\\n      },\\n\\n      // Remove file from container (removes reference only)\\n      removeFileFromContainer: (fileId: string, containerId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            const group = state.documentGroups.find(g => g.id === containerId);\\n\\n            if (!file || !group) return state;\\n\\n            // Update file's containerIds\\n            const updatedFile = {\\n              ...file,\\n              containerIds: file.containerIds.filter(id => id !== containerId),\\n            };\\n\\n            // Update container's fileIds\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (g.id === containerId) {\\n                return {\\n                  ...g,\\n                  fileIds: g.fileIds.filter(id => id !== fileId),\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"removeFileFromContainer\\\",\\n        );\\n      },\\n\\n      // Reuse file in another container (adds reference, keeps original)\\n      reuseFileInContainer: (fileId: string, targetContainerId: string) => {\\n        // Just call addFileToContainer - file will be in both containers\\n        get().addFileToContainer(fileId, targetContainerId);\\n      },\\n\\n      // Move file between containers (remove from source, add to target)\\n      moveFileBetweenContainers: (fileId: string, fromContainerId: string, toContainerId: string) => {\\n        get().removeFileFromContainer(fileId, fromContainerId);\\n        get().addFileToContainer(fileId, toContainerId);\\n      },\\n\\n      // Legacy moveFileToGroup - for Unclassified to Container moves\\n      // When moving from Unclassified (containerIds=[]), just add to target container\\n      // When moving between containers, use moveFileBetweenContainers\\n      moveFileToGroup: (fileId: string, targetGroupId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file || file.isRemoved) return state;\\n\\n            // Find source container (first container in list, or empty for unclassified)\\n            const sourceContainerId = file.containerIds.length > 0 ? file.containerIds[0] : null;\\n\\n            // If moving to same container, do nothing\\n            if (sourceContainerId === targetGroupId) return state;\\n\\n            // Update file's containerIds\\n            let newContainerIds: string[];\\n            if (sourceContainerId) {\\n              // Replace source with target\\n              newContainerIds = file.containerIds.filter(id => id !== sourceContainerId);\\n              if (!newContainerIds.includes(targetGroupId)) {\\n                newContainerIds = [targetGroupId, ...newContainerIds];\\n              }\\n            } else {\\n              // Unclassified: just add target\\n              newContainerIds = [targetGroupId];\\n            }\\n\\n            const updatedFile = {\\n              ...file,\\n              containerIds: newContainerIds,\\n              isNew: true,\\n            };\\n\\n            // Update groups\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (sourceContainerId && g.id === sourceContainerId) {\\n                // Remove from source\\n                return {\\n                  ...g,\\n                  fileIds: g.fileIds.filter(id => id !== fileId),\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              if (g.id === targetGroupId && !g.fileIds.includes(fileId)) {\\n                // Add to target\\n                return {\\n                  ...g,\\n                  fileIds: [fileId, ...g.fileIds],\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"moveFileToGroup\\\",\\n        );\\n      },\\n\\n      reorderFileInGroup: (\\n        groupId: string,\\n        fromIndex: number,\\n        toIndex: number,\\n      ) => {\\n        set(\\n          (state) => {\\n            const newGroups = state.documentGroups.map((group) => {\\n              if (group.id !== groupId) return group;\\n\\n              const newFileIds = [...group.fileIds];\\n              const [removed] = newFileIds.splice(fromIndex, 1);\\n              newFileIds.splice(toIndex, 0, removed);\\n\\n              return {\\n                ...group,\\n                fileIds: newFileIds,\\n                status: \\\"pending\\\" as const,\\n                hasChanges: true,\\n              };\\n            });\\n\\n            return { documentGroups: newGroups };\\n          },\\n          false,\\n          \\\"reorderFileInGroup\\\",\\n        );\\n      },\\n\\n      markFileForDeletion: (fileId: string, groupId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file) return state;\\n\\n            // Mark file as removed\\n            const updatedFile = { ...file, isRemoved: true, isNew: false };\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n\\n            // Update group status\\n            const newGroups = state.documentGroups.map((group) => {\\n              if (group.id !== groupId) return group;\\n              return {\\n                ...group,\\n                status: \\\"pending\\\" as const,\\n                hasChanges: true,\\n              };\\n            });\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"markFileForDeletion\\\",\\n        );\\n      },\\n\\n      clearFileNewStatus: (fileId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file) return state;\\n\\n            return {\\n              allFiles: {\\n                ...state.allFiles,\\n                [fileId]: { ...file, isNew: false },\\n              },\\n            };\\n          },\\n          false,\\n          \\\"clearFileNewStatus\\\",\\n        );\\n      },\\n\\n      clearGroupChangesFlag: (groupId: string) => {\\n        set(\\n          (state) => ({\\n            documentGroups: state.documentGroups.map((group) =>\\n              group.id === groupId ? { ...group, hasChanges: false } : group,\\n            ),\\n          }),\\n          false,\\n          \\\"clearGroupChangesFlag\\\",\\n        );\\n      },\\n\\n      confirmGroupReview: (groupId: string) => {\\n        set(\\n          (state) => {\\n            const group = state.documentGroups.find((g) => g.id === groupId);\\n            if (!group) return {};\\n\\n            // Update allFiles: remove isRemoved files, clear isNew flag for remaining\\n            const newAllFiles = { ...state.allFiles };\\n            const activeFileIds: string[] = [];\\n            for (const fileId of group.fileIds) {\\n              const file = newAllFiles[fileId];\\n              if (!file) continue;\\n              if (file.isRemoved) {\\n                // Remove the file from allFiles entirely\\n                delete newAllFiles[fileId];\\n              } else {\\n                // Clear isNew flag\\n                newAllFiles[fileId] = { ...file, isNew: false };\\n                activeFileIds.push(fileId);\\n              }\\n            }\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: state.documentGroups.map((g) =>\\n                g.id === groupId\\n                  ? {\\n                      ...g,\\n                      status: \\\"reviewed\\\" as const,\\n                      hasChanges: false,\\n                      fileIds: activeFileIds,\\n                    }\\n                  : g,\\n              ),\\n            };\\n          },\\n          false,\\n          \\\"confirmGroupReview\\\",\\n        );\\n      },\\n\\n      uploadDocuments: async () => {\\n        set({ isLoadingDocuments: true }, false, \\\"uploadDocuments:start\\\");\\n        // Simulate AI processing\\n        await new Promise((resolve) => setTimeout(resolve, 2000));\\n        // Convert legacy groups to new model\\n        const { allFiles, documentGroups } = convertLegacyGroupsToNewModel(INITIAL_DOCUMENT_GROUPS_LEGACY);\\n        const previews = syncFilePreviewsFromState(allFiles, documentGroups);\\n        set(\\n          {\\n            allFiles,\\n            documentGroups,\\n            uploadedFilePreviews: previews,\\n            isLoadingDocuments: false,\\n          },\\n          false,\\n          \\\"uploadDocuments:complete\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      uploadToGroup: (groupId: string, fileCount: number = 1) => {\\n        set(\\n          (state) => {\\n            const group = state.documentGroups.find(g => g.id === groupId);\\n            if (!group) return state;\\n\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n            const newFileIds: string[] = [];\\n\\n            for (let i = 0; i < fileCount; i++) {\\n              const fileId = `file_${timestamp}_${i}`;\\n              newAllFiles[fileId] = {\\n                id: fileId,\\n                name: `Uploaded_Page_${group.fileIds.length + i + 1}.pdf`,\\n                size: \\\"0.5 MB\\\",\\n                pages: 1,\\n                date: \\\"Just now\\\",\\n                type: \\\"pdf\\\",\\n                isNew: true,\\n                containerIds: [groupId],\\n              };\\n              newFileIds.push(fileId);\\n            }\\n\\n            const newGroups = state.documentGroups.map(g => {\\n              if (g.id === groupId) {\\n                return {\\n                  ...g,\\n                  fileIds: [...g.fileIds, ...newFileIds],\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadToGroup\\\",\\n        );\\n      },\\n\\n      // Upload and auto-classify documents (simulates AI classification)\\n      uploadAndAutoClassify: (totalPages: number = 8) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Helper to normalize names for comparison (remove spaces, hyphens, lowercase)\\n            const normalize = (str: string) =>\\n              str.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n\\n            // Categories to potentially create (simulating AI classification results)\\n            const allPossibleCategories = [\\n              { category: \\\"Passport\\\", pages: 2 },\\n              { category: \\\"Bank Statement\\\", pages: 3 },\\n              { category: \\\"Employment Letter\\\", pages: 2 },\\n              { category: \\\"Utility Bill\\\", pages: 2 },\\n              { category: \\\"Tax Documents\\\", pages: 2 },\\n              { category: \\\"Education Certificate\\\", pages: 1 },\\n              { category: \\\"Travel History\\\", pages: 2 },\\n              { category: \\\"Medical Records\\\", pages: 2 },\\n              { category: \\\"Marriage Certificate\\\", pages: 1 },\\n              { category: \\\"Birth Certificate\\\", pages: 1 },\\n            ];\\n\\n            // Find categories that don't exist yet\\n            const existingNormalizedTitles = state.documentGroups\\n              .filter((g) => g.id !== \\\"unclassified\\\")\\n              .map((g) => normalize(g.title));\\n\\n            const newCategories = allPossibleCategories.filter(\\n              (c) => !existingNormalizedTitles.includes(normalize(c.category))\\n            );\\n\\n            // Select 1-2 NEW categories to create\\n            const numNewCategories = Math.min(\\n              Math.floor(Math.random() * 2) + 1,\\n              newCategories.length\\n            );\\n            const selectedNewCategories = newCategories\\n              .sort(() => Math.random() - 0.5)\\n              .slice(0, numNewCategories);\\n\\n            // Also add files to 0-1 existing categories (if any exist)\\n            const existingClassifiedGroups = state.documentGroups.filter(\\n              (g) => g.id !== \\\"unclassified\\\" && g.id !== \\\"case_notes\\\"\\n            );\\n            const selectedExistingGroup =\\n              existingClassifiedGroups.length > 0 && Math.random() > 0.3\\n                ? existingClassifiedGroups[\\n                    Math.floor(Math.random() * existingClassifiedGroups.length)\\n                  ]\\n                : null;\\n\\n            // Calculate pages distribution\\n            const newCategoryPages = selectedNewCategories.reduce(\\n              (sum, c) => sum + c.pages,\\n              0\\n            );\\n            const existingGroupPages = selectedExistingGroup ? 2 : 0;\\n            const classifiedPages = newCategoryPages + existingGroupPages;\\n            const unclassifiedPages = Math.max(2, totalPages - classifiedPages);\\n\\n            let newGroups = [...state.documentGroups];\\n\\n            // Create NEW category groups with files\\n            selectedNewCategories.forEach((result, catIndex) => {\\n              const groupId = `group_${timestamp}_${catIndex}`;\\n              const fileIds: string[] = [];\\n\\n              for (let i = 0; i < result.pages; i++) {\\n                const fileId = `classified_${timestamp}_${catIndex}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `${result.category.replace(/\\\\s+/g, \\\"_\\\")}_Page_${i + 1}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [groupId],\\n                };\\n                fileIds.push(fileId);\\n              }\\n\\n              newGroups.push({\\n                id: groupId,\\n                title: result.category,\\n                tag: result.category,\\n                mergedFileName: `${result.category.replace(/\\\\s+/g, \\\"_\\\")}.pdf`,\\n                status: \\\"pending\\\",\\n                hasChanges: true,\\n                fileIds,\\n                files: [],\\n              });\\n            });\\n\\n            // Add files to an existing group (if selected)\\n            if (selectedExistingGroup) {\\n              const existingFileIds: string[] = [];\\n              for (let i = 0; i < existingGroupPages; i++) {\\n                const fileId = `existing_${timestamp}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `${selectedExistingGroup.title.replace(/\\\\s+/g, \\\"_\\\")}_New_${i + 1}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [selectedExistingGroup.id],\\n                };\\n                existingFileIds.push(fileId);\\n              }\\n              newGroups = newGroups.map((g) =>\\n                g.id === selectedExistingGroup.id\\n                  ? {\\n                      ...g,\\n                      fileIds: [...g.fileIds, ...existingFileIds],\\n                      status: \\\"pending\\\" as const,\\n                      hasChanges: true,\\n                    }\\n                  : g\\n              );\\n            }\\n\\n            // Add remaining pages as unclassified (containerIds = [])\\n            if (unclassifiedPages > 0) {\\n              const existingUnclassifiedCount = getUnclassifiedFiles(state.allFiles).length;\\n              for (let i = 0; i < unclassifiedPages; i++) {\\n                const fileId = `unclassified_${timestamp}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `Scan_Page_${String(existingUnclassifiedCount + i + 1).padStart(3, \\\"0\\\")}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [], // Empty = unclassified\\n                };\\n              }\\n            }\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadAndAutoClassify\\\",\\n        );\\n      },\\n\\n      // Duplicate/Reuse a file to another group (one-to-many linking)\\n      // Now uses reference model - no physical duplication needed\\n      duplicateFileToGroup: (fileId: string, targetGroupId: string) => {\\n        // In the new 1:N model, this is the same as reuseFileInContainer\\n        get().addFileToContainer(fileId, targetGroupId);\\n      },\\n\\n      // Add multiple files to an existing container (moves files from their current containers)\\n      addFilesToGroup: (groupId: string, orderedFileIds: string[]) => {\\n        set(\\n          (state) => {\\n            const targetGroup = state.documentGroups.find((g) => g.id === groupId);\\n            if (!targetGroup) return state;\\n\\n            const newAllFiles = { ...state.allFiles };\\n            const affectedGroupIds = new Set<string>();\\n\\n            // Update each file's containerIds: remove from old, add to target\\n            for (const fileId of orderedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                // Track affected source groups\\n                for (const cid of file.containerIds) {\\n                  if (cid !== groupId) affectedGroupIds.add(cid);\\n                }\\n                // Update file to only be in the target container\\n                newAllFiles[fileId] = {\\n                  ...file,\\n                  containerIds: [groupId],\\n                  isNew: true,\\n                };\\n              }\\n            }\\n\\n            // Remove files from source groups' fileIds\\n            const movedFileIdSet = new Set(orderedFileIds);\\n            let updatedGroups = state.documentGroups.map((group) => {\\n              if (group.id === groupId) {\\n                // Add files to target group (preserve existing + add new in order)\\n                const existingFileIds = group.fileIds.filter((id) => !movedFileIdSet.has(id));\\n                return {\\n                  ...group,\\n                  fileIds: [...existingFileIds, ...orderedFileIds],\\n                  hasChanges: true,\\n                };\\n              }\\n              if (!affectedGroupIds.has(group.id)) return group;\\n              return {\\n                ...group,\\n                fileIds: group.fileIds.filter((fid) => !movedFileIdSet.has(fid)),\\n              };\\n            });\\n\\n            // Auto-delete source groups that became empty\\n            updatedGroups = updatedGroups.filter(\\n              (g) => g.fileIds.length > 0 || !affectedGroupIds.has(g.id)\\n            );\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"addFilesToGroup\\\"\\n        );\\n      },\\n\\n      // Merge (copy) multiple files into a new combined document group\\n      // Source files remain unchanged - this creates copies for the merged document\\n      mergeDocumentsIntoGroup: (\\n        name: string,\\n        orderedFileIds: string[]\\n      ) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newGroupId = `merged_${timestamp}_${Math.random().toString(36).substr(2, 9)}`;\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Create COPIES of selected files for the merged document\\n            // Original files remain unchanged in their source containers\\n            const copiedFileIds: string[] = [];\\n\\n            for (let i = 0; i < orderedFileIds.length; i++) {\\n              const originalFileId = orderedFileIds[i];\\n              const originalFile = newAllFiles[originalFileId];\\n              if (originalFile) {\\n                // Create a new file ID for the copy\\n                const newFileId = `${originalFileId}_copy_${timestamp}_${i}`;\\n\\n                // Create a copy of the file for the new merged group\\n                newAllFiles[newFileId] = {\\n                  ...originalFile,\\n                  id: newFileId,\\n                  containerIds: [newGroupId],\\n                  isNew: true,\\n                };\\n                copiedFileIds.push(newFileId);\\n              }\\n            }\\n\\n            // Source groups remain unchanged - no files are removed\\n\\n            // Create new merged group with copied files\\n            const newGroup: DocumentGroup = {\\n              id: newGroupId,\\n              title: name,\\n              tag: \\\"Other Documents\\\",\\n              mergedFileName: `${name.replace(/\\\\s+/g, \\\"_\\\")}_Merged.pdf`,\\n              status: \\\"pending\\\",\\n              fileIds: copiedFileIds,\\n              files: [],\\n              hasChanges: true,\\n            };\\n\\n            const updatedGroups = [...state.documentGroups, newGroup];\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"mergeDocumentsIntoGroup\\\",\\n        );\\n      },\\n\\n      // Upload folder with recursive path parsing\\n      uploadFolder: (files: Array<{ file: File; relativePath: string }>) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Separate files into recognized (known entity) and unrecognized (unknown entity)\\n            const recognizedFiles: Array<{ file: File; relativePath: string; parsed: ReturnType<typeof parseDocumentPath> }> = [];\\n            const unrecognizedFiles: Array<{ file: File; relativePath: string; parsed: ReturnType<typeof parseDocumentPath> }> = [];\\n\\n            for (const fileData of files) {\\n              const parsed = parseDocumentPath(fileData.relativePath, fileData.file.name);\\n              if (parsed.who === 'unknown') {\\n                unrecognizedFiles.push({ ...fileData, parsed });\\n              } else {\\n                recognizedFiles.push({ ...fileData, parsed });\\n              }\\n            }\\n\\n            // Group recognized files by their generated document name\\n            const groupedByName = new Map<string, {\\n              parsedDoc: ReturnType<typeof parseDocumentPath>;\\n              files: Array<{ file: File; relativePath: string }>;\\n            }>();\\n\\n            for (const fileData of recognizedFiles) {\\n              if (!groupedByName.has(fileData.parsed.generatedName)) {\\n                groupedByName.set(fileData.parsed.generatedName, {\\n                  parsedDoc: fileData.parsed,\\n                  files: [],\\n                });\\n              }\\n              groupedByName.get(fileData.parsed.generatedName)!.files.push(fileData);\\n            }\\n\\n            // Create DocumentGroups for each unique generated name\\n            const newGroups: DocumentGroup[] = [];\\n            let fileIndex = 0;\\n\\n            // Determine tag from document type\\n            const tagMap: Record<string, string> = {\\n              passport: \\\"Identity\\\",\\n              nationalId: \\\"Identity\\\",\\n              birthCertificate: \\\"Identity\\\",\\n              bankStatement: \\\"Financial\\\",\\n              payslip: \\\"Financial\\\",\\n              taxReturn: \\\"Financial\\\",\\n              employmentLetter: \\\"Employment\\\",\\n              employmentContract: \\\"Employment\\\",\\n              educationCertificate: \\\"Education\\\",\\n              transcript: \\\"Education\\\",\\n              schoolEnrollment: \\\"Education\\\",\\n              marriageCertificate: \\\"Relationship\\\",\\n              proofOfCohabitation: \\\"Relationship\\\",\\n              propertyTitle: \\\"Accommodation\\\",\\n              proofOfAccommodation: \\\"Accommodation\\\",\\n              utilityBill: \\\"Utility\\\",\\n              visa: \\\"Travel\\\",\\n              insurance: \\\"Insurance\\\",\\n              letterOfConsent: \\\"Other\\\",\\n              document: \\\"Other Documents\\\",\\n            };\\n\\n            for (const [generatedName, data] of groupedByName) {\\n              const groupId = `group_folder_${timestamp}_${newGroups.length}`;\\n              const fileIds: string[] = [];\\n\\n              for (const fileData of data.files) {\\n                const fileId = `folder_${timestamp}_${fileIndex++}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: fileData.file.name,\\n                  size: `${(fileData.file.size / 1024).toFixed(1)} KB`,\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\" as const,\\n                  isNew: true,\\n                  containerIds: [groupId],\\n                  relativePath: fileData.relativePath,\\n                  entityType: data.parsedDoc.who,\\n                };\\n                fileIds.push(fileId);\\n              }\\n\\n              const tag = tagMap[data.parsedDoc.documentType] || \\\"Other Documents\\\";\\n\\n              newGroups.push({\\n                id: groupId,\\n                title: generatedName,\\n                tag,\\n                mergedFileName: `${generatedName}.pdf`,\\n                status: \\\"pending\\\",\\n                fileIds,\\n                files: [],\\n                hasChanges: true,\\n                entityType: data.parsedDoc.who,\\n                generatedName,\\n              });\\n            }\\n\\n            // Add unrecognized files as unclassified (containerIds = [])\\n            for (const fileData of unrecognizedFiles) {\\n              const fileId = `folder_${timestamp}_${fileIndex++}`;\\n              newAllFiles[fileId] = {\\n                id: fileId,\\n                name: fileData.file.name,\\n                size: `${(fileData.file.size / 1024).toFixed(1)} KB`,\\n                pages: 1,\\n                date: \\\"Just now\\\",\\n                type: \\\"pdf\\\" as const,\\n                isNew: true,\\n                containerIds: [], // Empty = unclassified\\n                relativePath: fileData.relativePath,\\n                entityType: \\\"unknown\\\" as const,\\n              };\\n            }\\n\\n            // Add new classified groups\\n            const updatedGroups = [...state.documentGroups, ...newGroups];\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadFolder\\\",\\n        );\\n      },\\n\\n      // Upload file for a specific evidence requirement\\n      uploadForEvidence: (evidenceId: string, evidenceName: string) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const normalizedName = evidenceName.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Find existing group that matches the evidence name\\n            let targetGroupId: string | undefined;\\n            for (const g of state.documentGroups) {\\n              const normalizedGroupTitle = g.title.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n              if (normalizedGroupTitle.includes(normalizedName) || normalizedName.includes(normalizedGroupTitle)) {\\n                targetGroupId = g.id;\\n                break;\\n              }\\n            }\\n\\n            // If no matching group exists, create one\\n            if (!targetGroupId) {\\n              targetGroupId = `group_${timestamp}`;\\n            }\\n\\n            const fileId = `evidence_${timestamp}`;\\n            newAllFiles[fileId] = {\\n              id: fileId,\\n              name: `${evidenceName.replace(/\\\\s+/g, \\\"_\\\")}.pdf`,\\n              size: \\\"0.5 MB\\\",\\n              pages: 1,\\n              date: \\\"Just now\\\",\\n              type: \\\"pdf\\\",\\n              isNew: true,\\n              containerIds: [targetGroupId],\\n            };\\n\\n            let newGroups = [...state.documentGroups];\\n\\n            const existingGroup = newGroups.find(g => g.id === targetGroupId);\\n            if (existingGroup) {\\n              // Add file to existing group\\n              newGroups = newGroups.map((g) =>\\n                g.id === targetGroupId\\n                  ? {\\n                      ...g,\\n                      fileIds: [...g.fileIds, fileId],\\n                      status: \\\"pending\\\" as const,\\n                      hasChanges: true,\\n                    }\\n                  : g\\n              );\\n            } else {\\n              // Create new group for this evidence\\n              newGroups.push({\\n                id: targetGroupId,\\n                title: evidenceName,\\n                tag: evidenceName,\\n                mergedFileName: `${evidenceName}.pdf`,\\n                status: \\\"pending\\\",\\n                fileIds: [fileId],\\n                files: [],\\n                hasChanges: true,\\n              });\\n            }\\n\\n            // Update enhanced checklist items (requiredEvidence is only on EnhancedChecklistItem)\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: true,\\n                      linkedFileId: fileId,\\n                      linkedFileName: newAllFiles[fileId].name,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            // Mark related issue as resolved\\n            const issueIdToResolve = `issue_missing_evidence_${evidenceId}`;\\n            const updatedIssues = state.enhancedQualityIssues.map((issue) =>\\n              issue.id === issueIdToResolve\\n                ? {\\n                    ...issue,\\n                    status: \\\"resolved\\\" as IssueStatus,\\n                    resolvedAt: new Date().toISOString(),\\n                    updatedAt: new Date().toISOString(),\\n                  }\\n                : issue\\n            );\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n              enhancedChecklistItems: updatedEnhancedItems,\\n              enhancedQualityIssues: updatedIssues,\\n            };\\n          },\\n          false,\\n          \\\"uploadForEvidence\\\"\\n        );\\n      },\\n\\n      // Link evidence to an existing document group from File Hub\\n      linkEvidenceToGroup: (evidenceId: string, groupId: string) => {\\n        set(\\n          (state) => {\\n            const targetGroup = state.documentGroups.find((g) => g.id === groupId);\\n            if (!targetGroup) return state;\\n\\n            // Update enhanced checklist items\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: true,\\n                      linkedFileId: groupId, // Link to the group ID\\n                      linkedFileName: targetGroup.title,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            // Mark related issue as resolved\\n            const issueIdToResolve = `issue_missing_evidence_${evidenceId}`;\\n            const updatedIssues = state.enhancedQualityIssues.map((issue) =>\\n              issue.id === issueIdToResolve\\n                ? {\\n                    ...issue,\\n                    status: \\\"resolved\\\" as IssueStatus,\\n                    resolvedAt: new Date().toISOString(),\\n                    updatedAt: new Date().toISOString(),\\n                  }\\n                : issue\\n            );\\n\\n            return {\\n              enhancedChecklistItems: updatedEnhancedItems,\\n              enhancedQualityIssues: updatedIssues,\\n            };\\n          },\\n          false,\\n          \\\"linkEvidenceToGroup\\\"\\n        );\\n      },\\n\\n      // Unlink evidence from a document group\\n      unlinkEvidence: (evidenceId: string) => {\\n        set(\\n          (state) => {\\n            // Update enhanced checklist items - reset the evidence to unlinked state\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: false,\\n                      linkedFileId: undefined,\\n                      linkedFileName: undefined,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            return {\\n              enhancedChecklistItems: updatedEnhancedItems,\\n            };\\n          },\\n          false,\\n          \\\"unlinkEvidence\\\"\\n        );\\n      },\\n\\n      // Demo: Review all documents and analyze to generate client profile\\n      reviewAllDocumentsAndAnalyze: async () => {\\n        const state = get();\\n\\n        // Step 1: Mark all document groups as reviewed\\n        set(\\n          (prev) => {\\n            const newAllFiles = { ...prev.allFiles };\\n            const newDocumentGroups = prev.documentGroups.map((g) => {\\n              const activeFileIds: string[] = [];\\n              for (const fileId of g.fileIds) {\\n                const file = newAllFiles[fileId];\\n                if (!file) continue;\\n                if (file.isRemoved) {\\n                  delete newAllFiles[fileId];\\n                } else {\\n                  newAllFiles[fileId] = { ...file, isNew: false };\\n                  activeFileIds.push(fileId);\\n                }\\n              }\\n              return {\\n                ...g,\\n                status: \\\"reviewed\\\" as const,\\n                hasChanges: false,\\n                fileIds: activeFileIds,\\n              };\\n            });\\n            return {\\n              isAnalyzingDocuments: true,\\n              analysisProgress: 0,\\n              allFiles: newAllFiles,\\n              documentGroups: newDocumentGroups,\\n            };\\n          },\\n          false,\\n          \\\"reviewAllDocuments\\\",\\n        );\\n\\n        // Step 2: Simulate document analysis with progress updates\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 600));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`,\\n          );\\n        }\\n\\n        // Step 3: Generate mock client profile from \\\"extracted\\\" document data\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        // Step 4: Update client profile and record analyzed files\\n        const currentState = get();\\n        const analyzedFileIds = currentState.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(currentState.allFiles, g).map((f) => f.id));\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            // Mark all analyzed files in allFiles\\n            const newAllFiles = { ...state.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of analyzedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n\\n            return {\\n              clientProfile: newProfile,\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\",\\n        );\\n\\n        // Evolve checklist based on new data\\n        get().evolveChecklist();\\n      },\\n\\n      // Run document analysis on ready (reviewed) documents only\\n      runDocumentAnalysis: async () => {\\n        const state = get();\\n\\n        // Get all ready files (from reviewed groups, excluding unclassified and removed)\\n        const readyFiles = state.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(state.allFiles, g));\\n\\n        if (readyFiles.length === 0) {\\n          return; // Nothing to analyze\\n        }\\n\\n        set(\\n          { isAnalyzingDocuments: true, analysisProgress: 0 },\\n          false,\\n          \\\"startAnalysis\\\",\\n        );\\n\\n        // Simulate analysis\\n        const totalSteps = 4;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 500));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`,\\n          );\\n        }\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        set(\\n          (state) => {\\n            // Mark analyzed files in allFiles\\n            const newAllFiles = { ...state.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of analyzedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n            return {\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\",\\n        );\\n      },\\n\\n      // Application Phase Management\\n      setApplicationPhase: (phase: ApplicationPhase) => {\\n        set({ applicationPhase: phase }, false, \\\"setApplicationPhase\\\");\\n      },\\n\\n      // Initialize form schema based on visa type\\n      initFormSchema: (visaType: VisaType) => {\\n        const schemaConfigs: Record<VisaType, Omit<FormSchemaStatus, \\\"filledFields\\\" | \\\"completionPercentage\\\" | \\\"lastUpdatedAt\\\">> = {\\n          \\\"skilled-worker\\\": {\\n            schemaName: \\\"Skilled Worker Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 58,\\n            emptyRequiredFields: [\\n              \\\"Certificate of Sponsorship number\\\",\\n              \\\"Sponsor license number\\\",\\n              \\\"Job start date\\\",\\n              \\\"Annual salary\\\",\\n              \\\"SOC code\\\",\\n              \\\"Working hours per week\\\",\\n              \\\"Main work location\\\",\\n              \\\"Previous UK visas\\\",\\n              \\\"Criminal convictions\\\",\\n              \\\"TB test certificate\\\",\\n            ],\\n          },\\n          naturalisation: {\\n            schemaName: \\\"Naturalisation Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 55,\\n            emptyRequiredFields: [\\n              \\\"Current immigration status\\\",\\n              \\\"Date ILR granted\\\",\\n              \\\"Residency period details\\\",\\n              \\\"Life in the UK test pass date\\\",\\n              \\\"English language proof\\\",\\n              \\\"Good character declaration\\\",\\n              \\\"Referee details\\\",\\n            ],\\n          },\\n          visitor: {\\n            schemaName: \\\"Visitor Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 38,\\n            emptyRequiredFields: [\\n              \\\"Visit purpose\\\",\\n              \\\"Intended stay duration\\\",\\n              \\\"Accommodation address\\\",\\n              \\\"Return ticket booking\\\",\\n              \\\"Ties to home country\\\",\\n            ],\\n          },\\n          \\\"partner-spouse\\\": {\\n            schemaName: \\\"Partner/Spouse Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 62,\\n            emptyRequiredFields: [\\n              \\\"Sponsor relationship\\\",\\n              \\\"Sponsor immigration status\\\",\\n              \\\"Accommodation details\\\",\\n              \\\"Financial evidence\\\",\\n              \\\"English language proof\\\",\\n              \\\"Relationship evidence\\\",\\n            ],\\n          },\\n        };\\n\\n        const config = schemaConfigs[visaType];\\n        const formSchema: FormSchemaStatus = {\\n          ...config,\\n          filledFields: 0,\\n          completionPercentage: 0,\\n          lastUpdatedAt: null,\\n        };\\n\\n        set({ formSchema }, false, \\\"initFormSchema\\\");\\n      },\\n\\n      // Start document analysis (Application workflow)\\n      startAnalysis: async () => {\\n        const state = get();\\n\\n        // Get ready files (from reviewed groups, excluding unclassified)\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const readyFiles = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g)\\n        );\\n\\n        if (readyFiles.length === 0) {\\n          return;\\n        }\\n\\n        // Set analyzing phase\\n        set(\\n          {\\n            applicationPhase: \\\"analyzing\\\",\\n            isAnalyzingDocuments: true,\\n            analysisProgress: 0,\\n          },\\n          false,\\n          \\\"startAnalysis\\\"\\n        );\\n\\n        // Simulate analysis with progress\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 800));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`\\n          );\\n        }\\n\\n        // Generate analyzed files summary\\n        const analyzedFiles: AnalyzedFileSummary[] = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => ({\\n            id: f.id,\\n            name: f.name,\\n            groupTitle: g.title,\\n            pages: f.pages || 1,\\n            analyzedAt: new Date().toISOString(),\\n          }))\\n        );\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        // Update form schema with mock extracted data\\n        const currentSchema = state.formSchema;\\n        const filledFields = currentSchema\\n          ? Math.round(currentSchema.totalFields * 0.73)\\n          : 0;\\n        const updatedSchema: FormSchemaStatus | null = currentSchema\\n          ? {\\n              ...currentSchema,\\n              filledFields,\\n              completionPercentage: Math.round(\\n                (filledFields / currentSchema.totalFields) * 100\\n              ),\\n              lastUpdatedAt: new Date().toISOString(),\\n            }\\n          : null;\\n\\n        // Mock passport extraction\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            return {\\n              applicationPhase: \\\"questionnaire\\\",\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: new Date().toISOString(),\\n              analyzedFileIds,\\n              analyzedFiles,\\n              formSchema: updatedSchema,\\n              clientProfile: newProfile,\\n              // Reset questionnaire answers to trigger questionnaire flow\\n              questionnaireAnswers: {},\\n              // Mark analyzed files in allFiles\\n              allFiles: (() => {\\n                const newAllFiles = { ...state.allFiles };\\n                const now = new Date().toISOString();\\n                for (const fileId of analyzedFileIds) {\\n                  const file = newAllFiles[fileId];\\n                  if (file) {\\n                    newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n                  }\\n                }\\n                return newAllFiles;\\n              })(),\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\"\\n        );\\n\\n        // Don't auto-generate checklist - wait for questionnaire to be completed\\n        // Checklist will be generated when user submits questionnaire answers\\n      },\\n\\n      // Re-analyze: only updates analyzed files without regenerating checklist\\n      // Used when new files are added after initial checklist generation\\n      reAnalyze: async () => {\\n        const state = get();\\n\\n        // Get all currently reviewed file IDs\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const allReadyFileIds = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => f.id)\\n        );\\n\\n        // Find new files that haven't been analyzed\\n        const newFileIds = allReadyFileIds.filter(\\n          (id) => !state.analyzedFileIds.includes(id)\\n        );\\n\\n        if (newFileIds.length === 0) {\\n          return;\\n        }\\n\\n        // Brief analyzing state\\n        set(\\n          { isAnalyzingDocuments: true, analysisProgress: 0 },\\n          false,\\n          \\\"reAnalyze:start\\\"\\n        );\\n\\n        // Simulate quick analysis\\n        await new Promise((resolve) => setTimeout(resolve, 500));\\n        set({ analysisProgress: 50 }, false, \\\"reAnalyze:progress\\\");\\n        await new Promise((resolve) => setTimeout(resolve, 500));\\n\\n        // Update analyzed file IDs to include new files\\n        const updatedAnalyzedFileIds = [...state.analyzedFileIds, ...newFileIds];\\n\\n        set(\\n          (currentState) => {\\n            // Mark new files as analyzed in allFiles\\n            const newAllFiles = { ...currentState.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of newFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n            return {\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds: updatedAnalyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"reAnalyze:complete\\\"\\n        );\\n      },\\n\\n      // Launch Form Pilot (opens mock form with auto-fill)\\n      launchFormPilot: () => {\\n        const state = get();\\n\\n        // Import and use the bridge dynamically to avoid SSR issues\\n        import(\\\"@/lib/form-pilot-bridge\\\").then(({ launchFormPilotDemo, listenForCompletion }) => {\\n          // Launch the form pilot demo\\n          const { cleanup } = launchFormPilotDemo();\\n\\n          // Listen for completion\\n          const removeListener = listenForCompletion((result) => {\\n            set(\\n              (currentState) => ({\\n                formPilotStatus: {\\n                  ...currentState.formPilotStatus,\\n                  totalSessions: currentState.formPilotStatus.totalSessions + 1,\\n                  lastRunAt: new Date().toISOString(),\\n                  lastRunStatus: result.status === \\\"success\\\" ? \\\"success\\\" : \\\"error\\\",\\n                },\\n              }),\\n              false,\\n              \\\"formPilotComplete\\\"\\n            );\\n\\n            // Cleanup\\n            removeListener();\\n            cleanup();\\n          });\\n        });\\n\\n        // Update status immediately to show \\\"running\\\"\\n        set(\\n          (currentState) => ({\\n            formPilotStatus: {\\n              ...currentState.formPilotStatus,\\n              lastRunAt: new Date().toISOString(),\\n              lastRunStatus: null, // null indicates running/in-progress\\n            },\\n          }),\\n          false,\\n          \\\"launchFormPilot\\\"\\n        );\\n      },\\n\\n      // Start analysis and generate questionnaire (Application workflow)\\n      startAnalysisAndGenerateQuestionnaire: async () => {\\n        const state = get();\\n\\n        // Get ready files (from reviewed groups, excluding unclassified)\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const readyFiles = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g)\\n        );\\n\\n        if (readyFiles.length === 0) {\\n          return;\\n        }\\n\\n        // Set analyzing phase\\n        set(\\n          {\\n            applicationPhase: \\\"analyzing\\\",\\n            isAnalyzingDocuments: true,\\n            analysisProgress: 0,\\n          },\\n          false,\\n          \\\"startAnalysisAndGenerateQuestionnaire\\\"\\n        );\\n\\n        // Simulate analysis with progress (includes Gap Analysis)\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 800));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`\\n          );\\n        }\\n\\n        // Generate analyzed files summary\\n        const analyzedFiles: AnalyzedFileSummary[] = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => ({\\n            id: f.id,\\n            name: f.name,\\n            groupTitle: g.title,\\n            pages: f.pages || 1,\\n            analyzedAt: new Date().toISOString(),\\n          }))\\n        );\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        // Mock passport extraction\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            return {\\n              applicationPhase: \\\"questionnaire\\\",\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: new Date().toISOString(),\\n              analyzedFileIds,\\n              analyzedFiles,\\n              clientProfile: newProfile,\\n              // Mark analyzed files in allFiles\\n              allFiles: (() => {\\n                const newAllFiles = { ...state.allFiles };\\n                const now = new Date().toISOString();\\n                for (const fileId of analyzedFileIds) {\\n                  const file = newAllFiles[fileId];\\n                  if (file) {\\n                    newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n                  }\\n                }\\n                return newAllFiles;\\n              })(),\\n            };\\n          },\\n          false,\\n          \\\"analysisAndQuestionnaireComplete\\\"\\n        );\\n      },\\n\\n      // Submit questionnaire answers and proceed to checklist\\n      submitQuestionnaireAnswers: (answers: Record<string, string>) => {\\n        const state = get();\\n\\n        // Get all currently reviewed file IDs to mark as analyzed\\n        const analyzedFileIds = state.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(state.allFiles, g).map((f) => f.id));\\n\\n        set(\\n          {\\n            questionnaireAnswers: answers,\\n            applicationPhase: \\\"checklist\\\",\\n            // Mark analysis as complete when questionnaire is submitted\\n            lastAnalysisAt: new Date().toISOString(),\\n            // Track which files were analyzed\\n            analyzedFileIds,\\n          },\\n          false,\\n          \\\"submitQuestionnaireAnswers\\\"\\n        );\\n        // First generate the base checklist items (mock data)\\n        get().generateChecklist();\\n        // Then convert to enhanced format with issues\\n        get().generateEnhancedChecklist();\\n      },\\n\\n      // Generate checklist with mock data and quality issues\\n      generateChecklist: () => {\\n        const state = get();\\n        const passport = state.clientProfile.passport;\\n\\n        // Get passport file ID from document groups\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFileId = passportGroup?.fileIds[0]\\n          ? (state.allFiles[passportGroup.fileIds[0]]?.id || \\\"pp_1\\\")\\n          : \\\"pp_1\\\";\\n\\n        // Mock checklist items based on UK Skilled Worker Visa requirements\\n        const mockChecklistItems: ApplicationChecklistItem[] = [\\n          // ==========================================\\n          // PERSONAL INFORMATION\\n          // ==========================================\\n          {\\n            id: \\\"given_names\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"givenNames\\\",\\n            label: \\\"Given Names\\\",\\n            value: passport?.givenNames || null,\\n            source: passport?.givenNames ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.givenNames ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"surname\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"surname\\\",\\n            label: \\\"Surname\\\",\\n            value: passport?.surname || null,\\n            source: passport?.surname ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.surname ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"dob\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"dateOfBirth\\\",\\n            label: \\\"Date of Birth\\\",\\n            value: passport?.dateOfBirth || null,\\n            source: passport?.dateOfBirth ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfBirth ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"place_of_birth\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"placeOfBirth\\\",\\n            label: \\\"Place of Birth\\\",\\n            value: passport?.countryOfBirth || \\\"Beijing, China\\\",\\n            source: passport?.countryOfBirth ? \\\"extracted\\\" : \\\"extracted\\\",\\n            linkedFileIds: [passportFileId],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"gender\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"gender\\\",\\n            label: \\\"Gender\\\",\\n            value: passport?.sex || null,\\n            source: passport?.sex ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.sex ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_number\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportNumber\\\",\\n            label: \\\"Passport Number\\\",\\n            value: passport?.passportNumber || null,\\n            source: passport?.passportNumber ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.passportNumber ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_issue_date\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportIssueDate\\\",\\n            label: \\\"Passport Issue Date\\\",\\n            value: passport?.dateOfIssue || null,\\n            source: passport?.dateOfIssue ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfIssue ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_expiry_date\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportExpiryDate\\\",\\n            label: \\\"Passport Expiry Date\\\",\\n            value: passport?.dateOfExpiry || null,\\n            source: passport?.dateOfExpiry ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfExpiry ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"nationality\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"nationality\\\",\\n            label: \\\"Nationality\\\",\\n            value: passport?.nationality || null,\\n            source: passport?.nationality ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.nationality ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"current_address\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"currentAddress\\\",\\n            label: \\\"Current Residential Address\\\",\\n            value: \\\"15 Maple Street, London SW1A 1AA\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"phone_number\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"phoneNumber\\\",\\n            label: \\\"Contact Phone Number\\\",\\n            value: \\\"+44 7700 900123\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"email_address\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"emailAddress\\\",\\n            label: \\\"Email Address\\\",\\n            value: \\\"john.smith@email.com\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"national_insurance\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"nationalInsurance\\\",\\n            label: \\\"National Insurance Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"biometric_residence_permit\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"biometricResidencePermit\\\",\\n            label: \\\"Previous BRP Number (if applicable)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // EMPLOYMENT DETAILS\\n          // ==========================================\\n          {\\n            id: \\\"cos_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosNumber\\\",\\n            label: \\\"Certificate of Sponsorship (CoS) Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_name\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorName\\\",\\n            label: \\\"Sponsor Name\\\",\\n            value: \\\"ACME Technology Ltd\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_license_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorLicenseNumber\\\",\\n            label: \\\"Sponsor License Number\\\",\\n            value: \\\"A1B2C3D4E5F6\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_address\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorAddress\\\",\\n            label: \\\"Sponsor Address\\\",\\n            value: \\\"100 Tech Park, Cambridge CB1 2AB\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"job_title\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"jobTitle\\\",\\n            label: \\\"Job Title\\\",\\n            value: \\\"Senior Software Engineer\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"soc_code\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"socCode\\\",\\n            label: \\\"SOC Code\\\",\\n            value: \\\"2136\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"salary\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"annualSalary\\\",\\n            label: \\\"Annual Salary (GBP)\\\",\\n            value: \\\"£65,000\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"employment_start_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"employmentStartDate\\\",\\n            label: \\\"Employment Start Date\\\",\\n            value: \\\"2024-04-01\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"working_hours\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"workingHoursPerWeek\\\",\\n            label: \\\"Working Hours per Week\\\",\\n            value: \\\"37.5\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"work_address\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"workAddress\\\",\\n            label: \\\"Work Location Address\\\",\\n            value: \\\"100 Tech Park, Cambridge CB1 2AB\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cos_assigned_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosAssignedDate\\\",\\n            label: \\\"CoS Assigned Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cos_expiry_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosExpiryDate\\\",\\n            label: \\\"CoS Expiry Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"shortage_occupation\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"shortageOccupation\\\",\\n            label: \\\"Is Role on Shortage Occupation List?\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n\\n          // ==========================================\\n          // FINANCIAL EVIDENCE\\n          // ==========================================\\n          {\\n            id: \\\"bank_account_holder\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankAccountHolder\\\",\\n            label: \\\"Bank Account Holder Name\\\",\\n            value: passport?.givenNames && passport?.surname ? `${passport.givenNames} ${passport.surname}` : null,\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: passport?.givenNames ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"bank_name\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankName\\\",\\n            label: \\\"Bank Name\\\",\\n            value: \\\"HSBC UK\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"account_number\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"accountNumber\\\",\\n            label: \\\"Account Number (Last 4 digits)\\\",\\n            value: \\\"****4521\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"bank_balance\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankBalance\\\",\\n            label: \\\"Current Balance\\\",\\n            value: \\\"£28,450.00\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"funds_held_period\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"fundsHeldPeriod\\\",\\n            label: \\\"Funds Held for 28 Consecutive Days\\\",\\n            value: \\\"Yes - Verified\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"statement_date\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"statementDate\\\",\\n            label: \\\"Bank Statement Date\\\",\\n            value: \\\"2024-01-15\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"maintenance_requirement\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"maintenanceRequirement\\\",\\n            label: \\\"Maintenance Requirement Met (£1,270)\\\",\\n            value: \\\"Yes\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"additional_funds_source\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"additionalFundsSource\\\",\\n            label: \\\"Source of Additional Funds\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"sponsor_maintenance_cert\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"sponsorMaintenanceCert\\\",\\n            label: \\\"Sponsor Maintenance Certification\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // TRAVEL HISTORY\\n          // ==========================================\\n          {\\n            id: \\\"previous_uk_visa\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"previousUKVisa\\\",\\n            label: \\\"Previous UK Visa History\\\",\\n            value: \\\"Tier 4 Student Visa (2015-2018)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [passportFileId],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"current_immigration_status\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"currentImmigrationStatus\\\",\\n            label: \\\"Current Immigration Status\\\",\\n            value: \\\"Outside UK\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"travel_history_10_years\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"travelHistory10Years\\\",\\n            label: \\\"Countries Visited (Last 10 Years)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"partial\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"visa_refusals\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"visaRefusals\\\",\\n            label: \\\"Previous Visa Refusals\\\",\\n            value: \\\"None\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"deportation_history\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"deportationHistory\\\",\\n            label: \\\"Deportation or Removal History\\\",\\n            value: \\\"None\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"criminal_convictions\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"criminalConvictions\\\",\\n            label: \\\"Criminal Convictions\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"uk_address_history\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"ukAddressHistory\\\",\\n            label: \\\"UK Address History (Last 5 Years)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // EDUCATION & QUALIFICATIONS\\n          // ==========================================\\n          {\\n            id: \\\"highest_qualification\\\",\\n            section: \\\"education\\\",\\n            field: \\\"highestQualification\\\",\\n            label: \\\"Highest Qualification\\\",\\n            value: \\\"BSc Computer Science\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"institution_name\\\",\\n            section: \\\"education\\\",\\n            field: \\\"institutionName\\\",\\n            label: \\\"Institution Name\\\",\\n            value: \\\"University of Manchester\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"graduation_date\\\",\\n            section: \\\"education\\\",\\n            field: \\\"graduationDate\\\",\\n            label: \\\"Graduation Date\\\",\\n            value: \\\"July 2018\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"english_test_type\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestType\\\",\\n            label: \\\"English Language Test Type\\\",\\n            value: \\\"IELTS Academic\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_score\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestScore\\\",\\n            label: \\\"English Test Score\\\",\\n            value: \\\"Overall 7.5 (L:8.0, R:7.5, W:7.0, S:7.5)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_date\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestDate\\\",\\n            label: \\\"English Test Date\\\",\\n            value: \\\"2023-06-15\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cefr_level\\\",\\n            section: \\\"education\\\",\\n            field: \\\"cefrLevel\\\",\\n            label: \\\"CEFR Level\\\",\\n            value: \\\"B1 (Minimum Required)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_reference\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestReference\\\",\\n            label: \\\"English Test Reference Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"atas_certificate\\\",\\n            section: \\\"education\\\",\\n            field: \\\"atasCertificate\\\",\\n            label: \\\"ATAS Certificate (if applicable)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // FAMILY INFORMATION\\n          // ==========================================\\n          {\\n            id: \\\"marital_status\\\",\\n            section: \\\"family\\\",\\n            field: \\\"maritalStatus\\\",\\n            label: \\\"Marital Status\\\",\\n            value: \\\"Married\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"spouse_name\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spouseName\\\",\\n            label: \\\"Spouse Full Name\\\",\\n            value: \\\"Jane Smith\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"spouse_nationality\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spouseNationality\\\",\\n            label: \\\"Spouse Nationality\\\",\\n            value: \\\"Chinese\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"dependants_count\\\",\\n            section: \\\"family\\\",\\n            field: \\\"dependantsCount\\\",\\n            label: \\\"Number of Dependants\\\",\\n            value: \\\"1 (Spouse applying separately)\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"children_count\\\",\\n            section: \\\"family\\\",\\n            field: \\\"childrenCount\\\",\\n            label: \\\"Number of Children\\\",\\n            value: \\\"0\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"spouse_passport_number\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spousePassportNumber\\\",\\n            label: \\\"Spouse Passport Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"marriage_certificate_date\\\",\\n            section: \\\"family\\\",\\n            field: \\\"marriageCertificateDate\\\",\\n            label: \\\"Marriage Certificate Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"family_members_in_uk\\\",\\n            section: \\\"family\\\",\\n            field: \\\"familyMembersInUK\\\",\\n            label: \\\"Other Family Members in UK\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n        ];\\n\\n        // Mock quality issues based on common Skilled Worker visa issues\\n        const mockQualityIssues: QualityIssue[] = [\\n          {\\n            id: \\\"issue_cos\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"CoS Number Required\\\",\\n            description: \\\"Certificate of Sponsorship number is missing. This is mandatory for Skilled Worker visa applications. Please obtain from your sponsor.\\\",\\n            linkedChecklistItemId: \\\"cos_number\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_cos_dates\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"CoS Dates Required\\\",\\n            description: \\\"CoS assigned date and expiry date are missing. These are required to verify the validity of your sponsorship.\\\",\\n            linkedChecklistItemId: \\\"cos_assigned_date\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_travel_history\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"warning\\\",\\n            title: \\\"Incomplete Travel History\\\",\\n            description: \\\"Travel history for the last 10 years is incomplete. UKVI requires full travel history including all countries visited.\\\",\\n            linkedChecklistItemId: \\\"travel_history_10_years\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_criminal_check\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"Criminal Convictions Declaration Required\\\",\\n            description: \\\"You must declare any criminal convictions. This is a mandatory question on the visa application form.\\\",\\n            linkedChecklistItemId: \\\"criminal_convictions\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_english_ref\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"warning\\\",\\n            title: \\\"English Test Reference Number\\\",\\n            description: \\\"The reference number for your English language test is required for verification with the test provider.\\\",\\n            linkedChecklistItemId: \\\"english_test_reference\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_passport_validity\\\",\\n            type: \\\"validity\\\",\\n            severity: \\\"info\\\",\\n            title: \\\"Passport Validity Check\\\",\\n            description: \\\"Ensure passport is valid for the duration of intended stay. Recommended to have at least 6 months validity beyond visa end date.\\\",\\n            linkedChecklistItemId: \\\"passport_expiry_date\\\",\\n            linkedFileId: passportFileId,\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_shortage\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"info\\\",\\n            title: \\\"Shortage Occupation Status\\\",\\n            description: \\\"Please confirm whether your role is on the Shortage Occupation List, as this affects salary threshold requirements.\\\",\\n            linkedChecklistItemId: \\\"shortage_occupation\\\",\\n            isResolved: false,\\n          },\\n        ];\\n\\n        set(\\n          {\\n            applicationPhase: \\\"checklist\\\",\\n            applicationChecklistItems: mockChecklistItems,\\n            qualityIssues: mockQualityIssues,\\n          },\\n          false,\\n          \\\"generateChecklist\\\"\\n        );\\n\\n        // Also generate enhanced checklist for the new workspace UI\\n        get().generateEnhancedChecklist();\\n      },\\n\\n      // Update a checklist field value\\n      updateChecklistField: (fieldId: string, value: string) => {\\n        set(\\n          (state) => ({\\n            applicationChecklistItems: state.applicationChecklistItems.map((item) =>\\n              item.id === fieldId\\n                ? {\\n                    ...item,\\n                    value,\\n                    source: \\\"manual\\\",\\n                    status: value ? \\\"complete\\\" : \\\"missing\\\",\\n                  }\\n                : item\\n            ),\\n          }),\\n          false,\\n          \\\"updateChecklistField\\\"\\n        );\\n      },\\n\\n      // Resolve a quality issue\\n      resolveIssue: (issueId: string) => {\\n        set(\\n          (state) => ({\\n            qualityIssues: state.qualityIssues.map((issue) =>\\n              issue.id === issueId ? { ...issue, isResolved: true } : issue\\n            ),\\n          }),\\n          false,\\n          \\\"resolveIssue\\\"\\n        );\\n      },\\n\\n      // Go back to a previous phase\\n      goBackToPhase: (phase: ApplicationPhase) => {\\n        set({ applicationPhase: phase }, false, \\\"goBackToPhase\\\");\\n      },\\n\\n      // Toggle checklist section expansion\\n      toggleChecklistSection: (sectionId: ChecklistSectionType) => {\\n        set(\\n          (state) => ({\\n            checklistSectionExpanded: {\\n              ...state.checklistSectionExpanded,\\n              [sectionId]: !state.checklistSectionExpanded[sectionId],\\n            },\\n          }),\\n          false,\\n          \\\"toggleChecklistSection\\\"\\n        );\\n      },\\n\\n      // ============================================\\n      // Enhanced Checklist Workspace Actions\\n      // ============================================\\n\\n      // Select a checklist item (for detail panel)\\n      selectChecklistItem: (itemId: string | null) => {\\n        set({ selectedChecklistItemId: itemId }, false, \\\"selectChecklistItem\\\");\\n      },\\n\\n      // Select an issue (for detail view)\\n      selectIssue: (issueId: string | null) => {\\n        set({ selectedIssueId: issueId }, false, \\\"selectIssue\\\");\\n      },\\n\\n      // Update enhanced checklist field value\\n      updateEnhancedChecklistField: (fieldId: string, value: string) => {\\n        set(\\n          (state) => ({\\n            enhancedChecklistItems: state.enhancedChecklistItems.map((item) =>\\n              item.id === fieldId\\n                ? {\\n                    ...item,\\n                    value,\\n                    source: \\\"manual\\\" as const,\\n                    status: value ? \\\"complete\\\" as const : \\\"missing\\\" as const,\\n                  }\\n                : item\\n            ),\\n          }),\\n          false,\\n          \\\"updateEnhancedChecklistField\\\"\\n        );\\n      },\\n\\n      // Update issue status\\n      updateIssueStatus: (issueId: string, status: IssueStatus) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"status_changed\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                previousStatus: issue.status,\\n                newStatus: status,\\n              };\\n              return {\\n                ...issue,\\n                status,\\n                updatedAt: new Date().toISOString(),\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"updateIssueStatus\\\"\\n        );\\n      },\\n\\n      // Add a note to an issue\\n      addIssueNote: (issueId: string, note: string) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"note_added\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: note,\\n              };\\n              return {\\n                ...issue,\\n                updatedAt: new Date().toISOString(),\\n                notes: [\\n                  ...issue.notes,\\n                  {\\n                    id: `note_${Date.now()}`,\\n                    content: note,\\n                    createdAt: new Date().toISOString(),\\n                    createdBy: { id: currentUser.id, name: currentUser.name },\\n                  },\\n                ],\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"addIssueNote\\\"\\n        );\\n      },\\n\\n      // Forward issue to client\\n      forwardIssueToClient: (issueId: string, data: ForwardToClientData) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"forwarded\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: data.method === \\\"email\\\"\\n                  ? `Forwarded via email to ${data.recipientEmail}`\\n                  : \\\"Shareable link generated\\\",\\n              };\\n              return {\\n                ...issue,\\n                status: \\\"forwarded\\\" as IssueStatus,\\n                updatedAt: new Date().toISOString(),\\n                forwardData: data,\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n            forwardModalOpen: false,\\n            forwardModalIssueId: null,\\n          }),\\n          false,\\n          \\\"forwardIssueToClient\\\"\\n        );\\n      },\\n\\n      // Mark issue as resolved\\n      markIssueResolved: (issueId: string, resolution?: string) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"resolved\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: resolution,\\n                previousStatus: issue.status,\\n                newStatus: \\\"resolved\\\",\\n              };\\n              return {\\n                ...issue,\\n                status: \\\"resolved\\\" as IssueStatus,\\n                updatedAt: new Date().toISOString(),\\n                resolvedAt: new Date().toISOString(),\\n                resolvedBy: { id: currentUser.id, name: currentUser.name },\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"markIssueResolved\\\"\\n        );\\n      },\\n\\n      // Open forward modal\\n      openForwardModal: (issueId: string) => {\\n        set(\\n          { forwardModalOpen: true, forwardModalIssueId: issueId },\\n          false,\\n          \\\"openForwardModal\\\"\\n        );\\n      },\\n\\n      // Close forward modal\\n      closeForwardModal: () => {\\n        set(\\n          { forwardModalOpen: false, forwardModalIssueId: null },\\n          false,\\n          \\\"closeForwardModal\\\"\\n        );\\n      },\\n\\n      // Generate enhanced checklist with linked documents and issues\\n      generateEnhancedChecklist: () => {\\n        const state = get();\\n        const currentUser = SYSTEM_USERS[0];\\n\\n        // Create linked documents from analyzed files\\n        const createLinkedDocument = (fileId: string): LinkedDocument | null => {\\n          const file = state.allFiles[fileId];\\n          if (!file || file.isRemoved) return null;\\n          // Find the group this file belongs to\\n          const group = state.documentGroups.find((g) =>\\n            g.fileIds.includes(fileId)\\n          );\\n          return {\\n            fileId: file.id,\\n            fileName: file.name,\\n            groupTitle: group?.title || \\\"Unknown\\\",\\n            pageNumbers: [1], // Mock page number\\n            extractedText: `Extracted from ${file.name}`,\\n          };\\n        };\\n\\n        // Get passport file info\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFile = passportGroup?.fileIds[0]\\n          ? state.allFiles[passportGroup.fileIds[0]]\\n          : undefined;\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: !!passportFile,\\n              linkedFileId: passportFile?.id,\\n              linkedFileName: passportFile?.name,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\\n            {\\n              id: \\\"ev_photo\\\",\\n              name: \\\"Passport-sized Photograph\\\",\\n              description: \\\"Recent photo meeting UK visa photo requirements (45mm x 35mm)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"JPEG\\\", \\\"PNG\\\"],\\n            },\\n            {\\n              id: \\\"ev_previous_passport\\\",\\n              name: \\\"Previous Passports (if applicable)\\\",\\n              description: \\\"Any previous passports showing UK immigration history\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          employment: [\\n            {\\n              id: \\\"ev_cos\\\",\\n              name: \\\"Certificate of Sponsorship (CoS)\\\",\\n              description: \\\"CoS reference number from licensed UK sponsor\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n            },\\n            {\\n              id: \\\"ev_employment_contract\\\",\\n              name: \\\"Employment Contract / Job Offer Letter\\\",\\n              description: \\\"Signed contract showing job title, salary, and start date\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_sponsor_letter\\\",\\n              name: \\\"Sponsor Confirmation Letter\\\",\\n              description: \\\"Letter from sponsor confirming employment details\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          financial: [\\n            {\\n              id: \\\"ev_bank_statements\\\",\\n              name: \\\"Bank Statements (28 days)\\\",\\n              description: \\\"Showing funds held for 28 consecutive days ending within 31 days of application\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be dated within 31 days of application\\\",\\n            },\\n            {\\n              id: \\\"ev_payslip\\\",\\n              name: \\\"Payslip\\\",\\n              description: \\\"Recent payslips showing salary payments (last 3 months recommended)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          travel: [\\n            {\\n              id: \\\"ev_travel_history\\\",\\n              name: \\\"Travel History Documentation\\\",\\n              description: \\\"Evidence of travel history for last 10 years (passport stamps, boarding passes)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n            {\\n              id: \\\"ev_old_visas\\\",\\n              name: \\\"Previous UK Visas (if any)\\\",\\n              description: \\\"Copies of any previous UK visas or BRPs\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          education: [\\n            {\\n              id: \\\"ev_english_cert\\\",\\n              name: \\\"English Language Test Certificate\\\",\\n              description: \\\"IELTS, TOEFL, or approved SELT certificate (CEFR B1 minimum)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be within 2 years of application date\\\",\\n            },\\n            {\\n              id: \\\"ev_degree_cert\\\",\\n              name: \\\"Degree Certificate / Academic Qualification\\\",\\n              description: \\\"Original or certified copy of highest qualification\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_atas\\\",\\n              name: \\\"ATAS Certificate (if applicable)\\\",\\n              description: \\\"Academic Technology Approval Scheme certificate for certain fields\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          family: [\\n            {\\n              id: \\\"ev_marriage_cert\\\",\\n              name: \\\"Marriage Certificate (if applicable)\\\",\\n              description: \\\"Official marriage certificate if applying with spouse\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_birth_cert\\\",\\n              name: \\\"Birth Certificates (if applicable)\\\",\\n              description: \\\"For any dependent children\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          other: [],\\n        };\\n\\n        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\\n\\n        // Convert existing checklist items to enhanced format\\n        const enhancedItems: EnhancedChecklistItem[] = state.applicationChecklistItems.map((item) => ({\\n          id: item.id,\\n          section: item.section,\\n          field: item.field,\\n          label: item.label,\\n          value: item.value,\\n          source: item.source,\\n          linkedDocuments: item.linkedFileIds\\n            .map(createLinkedDocument)\\n            .filter((doc): doc is LinkedDocument => doc !== null),\\n          requiredEvidence: getRequiredEvidence(item.section),\\n          status: item.status,\\n          isRequired: item.isRequired,\\n          isEditable: true,\\n          confidenceScore: item.source === \\\"extracted\\\" ? 95 : undefined,\\n        }));\\n\\n        // Convert existing quality issues to enhanced format\\n        const existingEnhancedIssues: EnhancedQualityIssue[] = state.qualityIssues.map((issue) => ({\\n          id: issue.id,\\n          type: issue.type,\\n          severity: issue.severity,\\n          status: issue.isResolved ? \\\"resolved\\\" as IssueStatus : \\\"open\\\" as IssueStatus,\\n          title: issue.title,\\n          description: issue.description,\\n          linkedChecklistItemId: issue.linkedChecklistItemId,\\n          linkedFileIds: issue.linkedFileId ? [issue.linkedFileId] : [],\\n          history: [\\n            {\\n              id: `history_${issue.id}_created`,\\n              timestamp: new Date().toISOString(),\\n              action: \\\"created\\\" as const,\\n              performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n            },\\n          ],\\n          notes: [],\\n          createdAt: new Date().toISOString(),\\n          updatedAt: new Date().toISOString(),\\n        }));\\n\\n        // Generate issues for missing fields (checklist items with status \\\"missing\\\")\\n        const missingFieldIssues: EnhancedQualityIssue[] = enhancedItems\\n          .filter((item) => item.status === \\\"missing\\\" && item.isRequired)\\n          .map((item) => ({\\n            id: `issue_missing_field_${item.id}`,\\n            type: \\\"missing\\\" as QualityIssueType,\\n            severity: \\\"warning\\\" as QualityIssueSeverity,\\n            status: \\\"open\\\" as IssueStatus,\\n            title: `Missing: ${item.label}`,\\n            description: `The field \\\"${item.label}\\\" is required but has not been provided. Please fill in this information or upload supporting documents.`,\\n            linkedChecklistItemId: item.id,\\n            linkedFileIds: [],\\n            history: [\\n              {\\n                id: `history_missing_field_${item.id}_created`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"created\\\" as const,\\n                performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n              },\\n            ],\\n            notes: [],\\n            createdAt: new Date().toISOString(),\\n            updatedAt: new Date().toISOString(),\\n          }));\\n\\n        // Generate issues for missing required evidence\\n        const allRequiredEvidence = Object.values(SECTION_REQUIRED_EVIDENCE).flat();\\n        const missingEvidenceIssues: EnhancedQualityIssue[] = allRequiredEvidence\\n          .filter((ev) => ev.isMandatory && !ev.isUploaded)\\n          .map((ev) => {\\n            // Find a related checklist item in the same section\\n            const sectionType = Object.entries(SECTION_REQUIRED_EVIDENCE)\\n              .find(([, evidenceList]) => evidenceList.some((e) => e.id === ev.id))?.[0] as ChecklistSectionType | undefined;\\n            const relatedItem = enhancedItems.find((item) => item.section === sectionType);\\n\\n            return {\\n              id: `issue_missing_evidence_${ev.id}`,\\n              type: \\\"missing\\\" as QualityIssueType,\\n              severity: \\\"error\\\" as QualityIssueSeverity,\\n              status: \\\"open\\\" as IssueStatus,\\n              title: `Missing Document: ${ev.name}`,\\n              description: ev.description || `The document \\\"${ev.name}\\\" is required but has not been uploaded.`,\\n              suggestedAction: \\\"Upload the required document\\\",\\n              linkedChecklistItemId: relatedItem?.id || enhancedItems[0]?.id || \\\"\\\",\\n              linkedFileIds: [],\\n              history: [\\n                {\\n                  id: `history_missing_evidence_${ev.id}_created`,\\n                  timestamp: new Date().toISOString(),\\n                  action: \\\"created\\\" as const,\\n                  performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n                },\\n              ],\\n              notes: [],\\n              createdAt: new Date().toISOString(),\\n              updatedAt: new Date().toISOString(),\\n            };\\n          });\\n\\n        // Combine all issues (filter out duplicates by checking if similar issue exists)\\n        const existingIssueIds = new Set(existingEnhancedIssues.map((i) => i.linkedChecklistItemId));\\n        const filteredMissingFieldIssues = missingFieldIssues.filter(\\n          (i) => !existingIssueIds.has(i.linkedChecklistItemId)\\n        );\\n\\n        const enhancedIssues: EnhancedQualityIssue[] = [\\n          ...existingEnhancedIssues,\\n          ...filteredMissingFieldIssues,\\n          ...missingEvidenceIssues,\\n        ];\\n\\n        set(\\n          {\\n            enhancedChecklistItems: enhancedItems,\\n            enhancedQualityIssues: enhancedIssues,\\n            // Auto-select first item if available\\n            selectedChecklistItemId: enhancedItems.length > 0 ? enhancedItems[0].id : null,\\n          },\\n          false,\\n          \\\"generateEnhancedChecklist\\\"\\n        );\\n      },\\n\\n      // Initialize case from CreateCaseModal data\\n      // Passport is parsed immediately at case creation (not dependent on analysis)\\n      // Case Notes is auto-confirmed, Passport requires confirm review\\n      initializeCaseFromCreation: (data: {\\n        visaType: VisaType;\\n        passport: PassportInfo;\\n        caseNotesFileName: string;\\n        passportFileName: string;\\n        referenceNumber?: string;\\n        advisorId?: string;\\n        assistantId?: string;\\n      }) => {\\n        // Mock case notes summary (would be extracted from uploaded case notes)\\n        const mockCaseNotesSummary: CaseNotesSummary = {\\n          summary: \\\"Client seeking Skilled Worker visa for a Senior Software Engineer position at ACME Technology Ltd. Has previous UK visa history (Tier 4 Student, 2015-2018). Strong financial background with verified savings. Main concern is ensuring CoS documentation is complete.\\\",\\n          clientBackground: \\\"British national currently residing in London. Has worked in tech industry for 8+ years.\\\",\\n          keyDates: [\\\"CoS expected: Feb 2024\\\", \\\"Target application: Mar 2024\\\"],\\n          extractedAt: new Date().toISOString(),\\n        };\\n\\n        // Create files for allFiles store\\n        const caseNotesFileId = `cn_${Date.now()}`;\\n        const passportFileId = `pp_${Date.now()}`;\\n\\n        const newAllFiles: Record<string, DocumentFile> = {\\n          [caseNotesFileId]: {\\n            id: caseNotesFileId,\\n            name: data.caseNotesFileName,\\n            size: \\\"1.2 MB\\\",\\n            pages: 5,\\n            date: \\\"Just now\\\",\\n            type: \\\"pdf\\\",\\n            isNew: false, // Not marked as new since it's auto-confirmed\\n            containerIds: [\\\"case_notes\\\"],\\n          },\\n          [passportFileId]: {\\n            id: passportFileId,\\n            name: data.passportFileName,\\n            size: \\\"0.8 MB\\\",\\n            pages: 1,\\n            date: \\\"Just now\\\",\\n            type: \\\"pdf\\\",\\n            isNew: true,\\n            containerIds: [\\\"passport\\\"],\\n          },\\n        };\\n\\n        // Create document groups - case notes is special (auto-confirmed), passport requires review\\n        const caseNotesGroup: DocumentGroup = {\\n          id: \\\"case_notes\\\",\\n          title: \\\"Case Notes\\\",\\n          tag: \\\"Case Notes\\\",\\n          mergedFileName: data.caseNotesFileName,\\n          status: \\\"reviewed\\\", // Auto-confirmed, no review needed\\n          isSpecial: true, // Special document - doesn't require manual review\\n          fileIds: [caseNotesFileId],\\n          files: [],\\n        };\\n\\n        // Passport document requires confirm review (not isSpecial)\\n        const passportGroup: DocumentGroup = {\\n          id: \\\"passport\\\",\\n          title: \\\"Passport\\\",\\n          tag: \\\"Passport\\\",\\n          mergedFileName: data.passportFileName,\\n          status: \\\"pending\\\", // Requires confirm review\\n          fileIds: [passportFileId],\\n          files: [],\\n        };\\n\\n        // Create empty unclassified group for future uploads\\n        const unclassifiedGroup: DocumentGroup = {\\n          id: \\\"unclassified\\\",\\n          title: \\\"Unclassified\\\",\\n          tag: \\\"unclassified\\\",\\n          status: \\\"pending\\\",\\n          fileIds: [],\\n          files: [],\\n        };\\n\\n        // Client profile includes passport data parsed at creation time\\n        // Passport parsing is immediate, not dependent on analysis\\n        const profileWithPassport = {\\n          passport: data.passport,\\n          completeness: 0,\\n        };\\n        profileWithPassport.completeness = calculateCompleteness(profileWithPassport);\\n\\n        const documentGroups = [unclassifiedGroup, caseNotesGroup, passportGroup];\\n        const previews = syncFilePreviewsFromState(newAllFiles, documentGroups);\\n\\n        set(\\n          {\\n            // Navigation - land on overview page\\n            activeNav: \\\"overview\\\",\\n            selectedVisaType: data.visaType,\\n            clientProfile: profileWithPassport,\\n            caseReference: data.referenceNumber || \\\"REF-2024-001\\\",\\n            caseNotesSummary: mockCaseNotesSummary,\\n            allFiles: newAllFiles,\\n            documentGroups,\\n            uploadedFilePreviews: previews,\\n            // Reset analysis state\\n            lastAnalysisAt: null,\\n            analyzedFileIds: [],\\n            analyzedFiles: [],\\n            isAnalyzingDocuments: false,\\n            analysisProgress: 0,\\n            // Reset questionnaire to trigger case assessment form\\n            questionnaireAnswers: {},\\n            // Reset application phase to analyzing (ready to start analysis)\\n            applicationPhase: \\\"analyzing\\\",\\n            formSchema: null,\\n          },\\n          false,\\n          \\\"initializeCaseFromCreation\\\"\\n        );\\n\\n        // Initialize form schema for the selected visa type\\n        get().initFormSchema(data.visaType);\\n\\n        // Evolve checklist based on new data\\n        get().evolveChecklist();\\n      },\\n\\n      // Reset\\n      reset: () => {\\n        set(initialState, false, \\\"reset\\\");\\n      },\\n    }),\\n    { name: \\\"case-detail-store\\\" },\\n  ),\\n);\\n\\n// Selector hooks for optimized re-renders\\nexport const useActiveNav = () =>\\n  useCaseDetailStore((state) => state.activeNav);\\nexport const useHighlightedGroupId = () =>\\n  useCaseDetailStore((state) => state.highlightedGroupId);\\nexport const useClientProfile = () =>\\n  useCaseDetailStore((state) => state.clientProfile);\\nexport const useCaseNotesSummary = () =>\\n  useCaseDetailStore((state) => state.caseNotesSummary);\\nexport const useSelectedVisaType = () =>\\n  useCaseDetailStore((state) => state.selectedVisaType);\\nexport const useChecklist = () =>\\n  useCaseDetailStore((state) => state.checklist);\\nexport const useChecklistStage = () =>\\n  useCaseDetailStore((state) => state.checklist.stage);\\n// Returns document groups with files resolved from allFiles (backward compatible)\\n// UI components can access group.files directly\\n// Uses separate subscriptions + useMemo to avoid infinite re-render loops\\nexport const useDocumentGroups = () => {\\n  const groups = useCaseDetailStore((state) => state.documentGroups);\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(\\n    () =>\\n      groups.map((group) => ({\\n        ...group,\\n        files: group.fileIds\\n          .map((id) => allFiles[id])\\n          .filter((f): f is DocumentFile => f !== undefined),\\n      })),\\n    [groups, allFiles]\\n  );\\n};\\nexport const useIsLoadingDocuments = () =>\\n  useCaseDetailStore((state) => state.isLoadingDocuments);\\nexport const useUploadedFilePreviews = () =>\\n  useCaseDetailStore((state) => state.uploadedFilePreviews);\\nexport const useApplicationPhase = () =>\\n  useCaseDetailStore((state) => state.applicationPhase);\\nexport const useFormSchema = () =>\\n  useCaseDetailStore((state) => state.formSchema);\\nexport const useFormPilotStatus = () =>\\n  useCaseDetailStore((state) => state.formPilotStatus);\\nexport const useAnalyzedFiles = () =>\\n  useCaseDetailStore((state) => state.analyzedFiles);\\nexport const useApplicationChecklistItems = () =>\\n  useCaseDetailStore((state) => state.applicationChecklistItems);\\nexport const useQualityIssues = () =>\\n  useCaseDetailStore((state) => state.qualityIssues);\\nexport const useQuestionnaireAnswers = () =>\\n  useCaseDetailStore((state) => state.questionnaireAnswers);\\nexport const useChecklistSectionExpanded = () =>\\n  useCaseDetailStore((state) => state.checklistSectionExpanded);\\n\\n// Enhanced Checklist Workspace Selectors\\nexport const useEnhancedChecklistItems = () =>\\n  useCaseDetailStore((state) => state.enhancedChecklistItems);\\nexport const useEnhancedQualityIssues = () =>\\n  useCaseDetailStore((state) => state.enhancedQualityIssues);\\nexport const useSelectedChecklistItemId = () =>\\n  useCaseDetailStore((state) => state.selectedChecklistItemId);\\nexport const useSelectedIssueId = () =>\\n  useCaseDetailStore((state) => state.selectedIssueId);\\nexport const useForwardModalOpen = () =>\\n  useCaseDetailStore((state) => state.forwardModalOpen);\\nexport const useForwardModalIssueId = () =>\\n  useCaseDetailStore((state) => state.forwardModalIssueId);\\n\\n// Get selected checklist item with its issues\\nexport const useSelectedChecklistItem = () =>\\n  useCaseDetailStore((state) => {\\n    if (!state.selectedChecklistItemId) return null;\\n    return state.enhancedChecklistItems.find(\\n      (item) => item.id === state.selectedChecklistItemId\\n    ) || null;\\n  });\\n\\n// Get issues for selected checklist item - memoized to prevent infinite loops\\nexport const useIssuesForSelectedItem = () => {\\n  const selectedChecklistItemId = useCaseDetailStore(\\n    (state) => state.selectedChecklistItemId\\n  );\\n  const enhancedQualityIssues = useCaseDetailStore(\\n    (state) => state.enhancedQualityIssues\\n  );\\n\\n  return useMemo(() => {\\n    if (!selectedChecklistItemId) return [];\\n    return enhancedQualityIssues.filter(\\n      (issue) => issue.linkedChecklistItemId === selectedChecklistItemId\\n    );\\n  }, [selectedChecklistItemId, enhancedQualityIssues]);\\n};\\n\\n// Get issue counts by severity - memoized to prevent infinite loops\\nexport const useIssueCounts = () => {\\n  const enhancedQualityIssues = useCaseDetailStore(\\n    (state) => state.enhancedQualityIssues\\n  );\\n\\n  return useMemo(() => {\\n    const issues = enhancedQualityIssues.filter(\\n      (issue) => issue.status !== \\\"resolved\\\"\\n    );\\n    return {\\n      errors: issues.filter((i) => i.severity === \\\"error\\\").length,\\n      warnings: issues.filter((i) => i.severity === \\\"warning\\\").length,\\n      info: issues.filter((i) => i.severity === \\\"info\\\").length,\\n      total: issues.length,\\n    };\\n  }, [enhancedQualityIssues]);\\n};\\n\\n// Selector to detect if there are new ready files since the last analysis\\n// Only triggers when NEW files are confirmed (ready), not when files become pending\\nexport const useHasNewFilesAfterAnalysis = () =>\\n  useCaseDetailStore((state) => {\\n    // Only check if analysis has been completed\\n    if (!state.lastAnalysisAt) return false;\\n\\n    // Get all file IDs from reviewed groups (excluding unclassified and removed)\\n    const currentReviewedFileIds = state.documentGroups\\n      .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n      .flatMap((g) => getContainerFiles(state.allFiles, g).map((f) => f.id));\\n\\n    const analyzedFileIds = state.analyzedFileIds;\\n\\n    // Only check for NEW ready files - files that are reviewed but weren't analyzed\\n    // Don't trigger for removals (e.g., when a group goes from reviewed to pending)\\n    const hasNewReadyFiles = currentReviewedFileIds.some(\\n      (id) => !analyzedFileIds.includes(id)\\n    );\\n\\n    return hasNewReadyFiles;\\n  });\\n\\n// Returns the count of new ready document groups that have unanalyzed files\\nexport const useNewFilesCount = () =>\\n  useCaseDetailStore((state) => {\\n    if (!state.lastAnalysisAt) return 0;\\n\\n    const analyzedFileIds = state.analyzedFileIds;\\n\\n    // Count document groups that have at least one new unanalyzed file\\n    const groupsWithNewFiles = state.documentGroups.filter((g) => {\\n      if (g.id === \\\"unclassified\\\" || g.status !== \\\"reviewed\\\") return false;\\n\\n      // Check if this group has any files that weren't analyzed\\n      const activeFiles = getContainerFiles(state.allFiles, g);\\n      return activeFiles.some((f) => !analyzedFileIds.includes(f.id));\\n    });\\n\\n    return groupsWithNewFiles.length;\\n  });\\n\\n// ============================================================================\\n// One-to-Many Model Selectors\\n// ============================================================================\\n\\n// Get all files from the central store\\nexport const useAllFiles = () =>\\n  useCaseDetailStore((state) => state.allFiles);\\n\\n// Get unclassified files (files with no container associations)\\nexport const useUnclassifiedFiles = () => {\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(\\n    () =>\\n      Object.values(allFiles).filter(\\n        (f) => !f.isRemoved && f.containerIds.length === 0\\n      ),\\n    [allFiles]\\n  );\\n};\\n\\n// Get files for a specific container/group\\nexport const useContainerFiles = (containerId: string) => {\\n  const groups = useCaseDetailStore((state) => state.documentGroups);\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(() => {\\n    const group = groups.find((g) => g.id === containerId);\\n    if (!group) return [];\\n    return group.fileIds\\n      .map((id) => allFiles[id])\\n      .filter((f): f is DocumentFile => f !== undefined && !f.isRemoved);\\n  }, [groups, allFiles, containerId]);\\n};\\n\\n// Get the number of containers a file is in (for showing linked badge)\\nexport const useFileContainerCount = (fileId: string) =>\\n  useCaseDetailStore((state) => {\\n    const file = state.allFiles[fileId];\\n    return file?.containerIds.length ?? 0;\\n  });\\n\\n// Check if a file is in multiple containers (shared/reused)\\nexport const useIsFileShared = (fileId: string) =>\\n  useCaseDetailStore((state) => {\\n    const file = state.allFiles[fileId];\\n    return (file?.containerIds.length ?? 0) > 1;\\n  });\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 3897,\n      \"oldLines\": 12,\n      \"newStart\": 3897,\n      \"newLines\": 31,\n      \"lines\": [\n        \"           };\",\n        \"         };\",\n        \" \",\n        \"-        // Get passport file info\",\n        \"-        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\",\n        \"-        const passportFile = passportGroup?.fileIds[0]\",\n        \"-          ? state.allFiles[passportGroup.fileIds[0]]\",\n        \"-          : undefined;\",\n        \"+        // Evidence ID → Document Group ID mapping for auto-linking\",\n        \"+        const EVIDENCE_GROUP_MAP: Record<string, string> = {\",\n        \"+          ev_passport: \\\"passport\\\",\",\n        \"+          ev_bank_statements: \\\"bank_statement\\\",\",\n        \"+          ev_payslip: \\\"bank_statement\\\", // payslip may be in same group\",\n        \"+          ev_employment_contract: \\\"employment_letter\\\",\",\n        \"+          ev_travel_history: \\\"travel_history\\\",\",\n        \"+          ev_english_cert: \\\"education\\\",\",\n        \"+          ev_degree_cert: \\\"education\\\",\",\n        \"+        };\",\n        \" \",\n        \"+        // Auto-link evidence to existing document groups\",\n        \"+        const autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\",\n        \"+          const groupId = EVIDENCE_GROUP_MAP[ev.id];\",\n        \"+          if (!groupId) return ev;\",\n        \"+          const group = state.documentGroups.find(g => g.id === groupId);\",\n        \"+          if (!group || group.fileIds.length === 0) return ev;\",\n        \"+          return {\",\n        \"+            ...ev,\",\n        \"+            isUploaded: true,\",\n        \"+            linkedFileId: group.id,\",\n        \"+            linkedFileName: group.title,\",\n        \"+          };\",\n        \"+        };\",\n        \"+\",\n        \"         // Required evidence configuration per section (UK Skilled Worker Visa)\",\n        \"         const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\",\n        \"           personal: [\"\n      ]\n    },\n    {\n      \"oldStart\": 3910,\n      \"oldLines\": 9,\n      \"newStart\": 3929,\n      \"newLines\": 7,\n      \"lines\": [\n        \"               id: \\\"ev_passport\\\",\",\n        \"               name: \\\"Valid Passport\\\",\",\n        \"               description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\",\n        \"-              isUploaded: !!passportFile,\",\n        \"-              linkedFileId: passportFile?.id,\",\n        \"-              linkedFileName: passportFile?.name,\",\n        \"+              isUploaded: false,\",\n        \"               isMandatory: true,\",\n        \"               acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\",\n        \"               validityPeriod: \\\"Must be valid for duration of stay\\\",\"\n      ]\n    }\n  ],\n  \"userModified\": false,\n  \"replaceAll\": false\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Edit","category":"native"},"isError":false,"turnId":"msg_01G5sZkJxoFeWecfMh885Ktp"}
{"id":"msg-1769669171096-pii3cx","type":"assistant","content":"Now let me replace the passport-specific logic with the generic auto-mapping approach.","timestamp":1769669171096,"isIntermediate":true,"turnId":"msg_01G5sZkJxoFeWecfMh885Ktp"}
{"id":"msg-1769669177006-spstgc","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n    \"content\": \"            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_license_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorLicenseNumber\\\",\\n            label: \\\"Sponsor License Number\\\",\\n            value: \\\"A1B2C3D4E5F6\\\",\",\n    \"numLines\": 10,\n    \"startLine\": 3060,\n    \"totalLines\": 4527\n  }\n}","timestamp":1769669177006,"toolName":"Read","toolUseId":"toolu_01HKvQWfyMaoMY5kMYETAWBM","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","offset":3060,"limit":10},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n    \"content\": \"            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_license_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorLicenseNumber\\\",\\n            label: \\\"Sponsor License Number\\\",\\n            value: \\\"A1B2C3D4E5F6\\\",\",\n    \"numLines\": 10,\n    \"startLine\": 3060,\n    \"totalLines\": 4527\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"isError":false,"turnId":"msg_01NqVoafEJsHcUJ5u77LSYmF"}
{"id":"msg-1769669178281-s2skpi","type":"assistant","content":"Now I need to update the `getRequiredEvidence` function to apply `autoLinkEvidence` to each item.","timestamp":1769669178281,"isIntermediate":true,"turnId":"msg_01NqVoafEJsHcUJ5u77LSYmF"}
{"id":"msg-1769669180444-38d5x1","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n    \"content\": \"          ],\\n          other: [],\\n        };\\n\\n        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\\n\\n        // Convert existing checklist items to enhanced format\\n        const enhancedItems: EnhancedChecklistItem[] = state.applicationChecklistItems.map((item) => ({\\n          id: item.id,\\n          section: item.section,\\n          field: item.field,\\n          label: item.label,\",\n    \"numLines\": 15,\n    \"startLine\": 4060,\n    \"totalLines\": 4527\n  }\n}","timestamp":1769669180444,"toolName":"Read","toolUseId":"toolu_01QooL892qy9gyjTrg99YoLj","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","offset":4060,"limit":15},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n    \"content\": \"          ],\\n          other: [],\\n        };\\n\\n        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\\n\\n        // Convert existing checklist items to enhanced format\\n        const enhancedItems: EnhancedChecklistItem[] = state.applicationChecklistItems.map((item) => ({\\n          id: item.id,\\n          section: item.section,\\n          field: item.field,\\n          label: item.label,\",\n    \"numLines\": 15,\n    \"startLine\": 4060,\n    \"totalLines\": 4527\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"isError":false,"turnId":"msg_013c7HDXKhacAc2u4WQDq7jm"}
{"id":"msg-1769669183247-gpwbis","type":"tool","content":"{\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n  \"oldString\": \"        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\",\n  \"newString\": \"        // Get required evidence for a section (with auto-linking applied)\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return (SECTION_REQUIRED_EVIDENCE[section] || []).map(autoLinkEvidence);\\n        };\",\n  \"originalFile\": \"import { useMemo } from \\\"react\\\";\\nimport { create } from \\\"zustand\\\";\\nimport { devtools } from \\\"zustand/middleware\\\";\\nimport {\\n  CaseDetailStore,\\n  CaseDetailState,\\n  CaseDetailNavItem,\\n  ChecklistStage,\\n  ChecklistItemStatus,\\n  UploadedFilePreview,\\n  QuestionnaireQuestion,\\n  ChecklistItem,\\n  DocumentGroup,\\n  DocumentFile,\\n  ApplicationPhase,\\n  FormSchemaStatus,\\n  FormPilotStatus,\\n  AnalyzedFileSummary,\\n  ApplicationChecklistItem,\\n  QualityIssue,\\n  QualityIssueType,\\n  QualityIssueSeverity,\\n  ChecklistSectionType,\\n  CaseNotesSummary,\\n  // Enhanced types for checklist workspace\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  IssueStatus,\\n  IssueHistoryEntry,\\n  ForwardToClientData,\\n  LinkedDocument,\\n  RequiredEvidence,\\n} from \\\"@/types/case-detail\\\";\\nimport { PassportInfo, VisaType } from \\\"@/types\\\";\\nimport { parseDocumentPath } from \\\"@/lib/document-path-parser\\\";\\n\\n// Old-style document group type (with files embedded) - for legacy data\\ninterface LegacyDocumentGroup {\\n  id: string;\\n  title: string;\\n  tag: string;\\n  mergedFileName?: string;\\n  status: \\\"pending\\\" | \\\"reviewed\\\";\\n  hasChanges?: boolean;\\n  files: Array<Omit<DocumentFile, 'containerIds'> & { containerIds?: string[] }>;\\n  isSpecial?: boolean;\\n  entityType?: DocumentFile['entityType'];\\n  generatedName?: string;\\n}\\n\\n// Initial document groups data - Rich mock data with many pages per category\\n// Uses legacy format (files embedded) - converted to new model when used\\nconst INITIAL_DOCUMENT_GROUPS_LEGACY: LegacyDocumentGroup[] = [\\n  {\\n    id: \\\"passport\\\",\\n    title: \\\"Passport\\\",\\n    tag: \\\"Passport\\\",\\n    mergedFileName: \\\"Passport_Combined.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"pp_1\\\",\\n        name: \\\"Passport_Cover.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_2\\\",\\n        name: \\\"Passport_Bio_Page.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_3\\\",\\n        name: \\\"Passport_Visa_Page_1.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_4\\\",\\n        name: \\\"Passport_Visa_Page_2.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_5\\\",\\n        name: \\\"Passport_Stamp_Page.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_6\\\",\\n        name: \\\"Passport_Back_Cover.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"bank_statement\\\",\\n    title: \\\"Bank Statement\\\",\\n    tag: \\\"Bank Statement\\\",\\n    mergedFileName: \\\"BankStatement_6Months.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"bs_1\\\",\\n        name: \\\"Statement_Jan_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_2\\\",\\n        name: \\\"Statement_Jan_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_3\\\",\\n        name: \\\"Statement_Feb_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_4\\\",\\n        name: \\\"Statement_Feb_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_5\\\",\\n        name: \\\"Statement_Mar_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_6\\\",\\n        name: \\\"Statement_Mar_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_7\\\",\\n        name: \\\"Statement_Apr_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_8\\\",\\n        name: \\\"Statement_Apr_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_9\\\",\\n        name: \\\"Statement_May_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_10\\\",\\n        name: \\\"Statement_May_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_11\\\",\\n        name: \\\"Statement_Jun_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_12\\\",\\n        name: \\\"Statement_Jun_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"employment_letter\\\",\\n    title: \\\"Employment Letter\\\",\\n    tag: \\\"Employment Letter\\\",\\n    mergedFileName: \\\"Employment_Verification.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"emp_1\\\",\\n        name: \\\"Employment_Letter_Page1.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_2\\\",\\n        name: \\\"Employment_Letter_Page2.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_3\\\",\\n        name: \\\"Salary_Slip_Jan.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_4\\\",\\n        name: \\\"Salary_Slip_Feb.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_5\\\",\\n        name: \\\"Salary_Slip_Mar.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"utility_bill\\\",\\n    title: \\\"Utility Bill\\\",\\n    tag: \\\"Utility Bill\\\",\\n    mergedFileName: \\\"Utility_Bills_2024.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"ub_1\\\",\\n        name: \\\"Electric_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_2\\\",\\n        name: \\\"Electric_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_3\\\",\\n        name: \\\"Gas_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_4\\\",\\n        name: \\\"Gas_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_5\\\",\\n        name: \\\"Water_Bill_Q1.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_6\\\",\\n        name: \\\"Council_Tax_Bill.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_7\\\",\\n        name: \\\"Internet_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_8\\\",\\n        name: \\\"Internet_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"tax_documents\\\",\\n    title: \\\"Tax Documents\\\",\\n    tag: \\\"Tax Documents\\\",\\n    mergedFileName: \\\"Tax_Records_2023.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"tax_1\\\",\\n        name: \\\"P60_2023.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_2\\\",\\n        name: \\\"Tax_Return_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_3\\\",\\n        name: \\\"Tax_Return_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_4\\\",\\n        name: \\\"Tax_Return_Page3.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_5\\\",\\n        name: \\\"Tax_Calculation.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_6\\\",\\n        name: \\\"Tax_Payment_Receipt.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"education\\\",\\n    title: \\\"Education Certificates\\\",\\n    tag: \\\"Education\\\",\\n    mergedFileName: \\\"Education_Documents.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"edu_1\\\",\\n        name: \\\"Degree_Certificate.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_2\\\",\\n        name: \\\"Transcript_Page1.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_3\\\",\\n        name: \\\"Transcript_Page2.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_4\\\",\\n        name: \\\"Transcript_Page3.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_5\\\",\\n        name: \\\"IELTS_Result.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_6\\\",\\n        name: \\\"IELTS_TRF.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_7\\\",\\n        name: \\\"Professional_Certificate.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"travel_history\\\",\\n    title: \\\"Travel History\\\",\\n    tag: \\\"Travel History\\\",\\n    mergedFileName: \\\"Travel_Documents.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"travel_1\\\",\\n        name: \\\"Old_Passport_Page1.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_2\\\",\\n        name: \\\"Old_Passport_Page2.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_3\\\",\\n        name: \\\"Old_Passport_Page3.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_4\\\",\\n        name: \\\"Flight_Itinerary_UK.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_5\\\",\\n        name: \\\"Hotel_Booking_UK.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"unclassified\\\",\\n    title: \\\"Unclassified\\\",\\n    tag: \\\"Unclassified\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"u1\\\",\\n        name: \\\"Scan_Page_001.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u2\\\",\\n        name: \\\"Scan_Page_002.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u3\\\",\\n        name: \\\"Scan_Page_003.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u4\\\",\\n        name: \\\"Unknown_Doc_A.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u5\\\",\\n        name: \\\"Unknown_Doc_B.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u6\\\",\\n        name: \\\"Misc_Scan_001.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u7\\\",\\n        name: \\\"Misc_Scan_002.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u8\\\",\\n        name: \\\"Photo_Doc.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n];\\n\\n// System users (mock data)\\nexport const SYSTEM_USERS: { id: string; name: string; email: string; role: string }[] = [\\n  { id: \\\"john-001\\\", name: \\\"John Smith\\\", email: \\\"john@lawfirm.com\\\", role: \\\"Partner\\\" },\\n  { id: \\\"sarah-002\\\", name: \\\"Sarah Johnson\\\", email: \\\"sarah@lawfirm.com\\\", role: \\\"Senior Associate\\\" },\\n  { id: \\\"michael-003\\\", name: \\\"Michael Chen\\\", email: \\\"michael@lawfirm.com\\\", role: \\\"Associate\\\" },\\n  { id: \\\"emma-004\\\", name: \\\"Emma Wilson\\\", email: \\\"emma@lawfirm.com\\\", role: \\\"Paralegal\\\" },\\n  { id: \\\"david-005\\\", name: \\\"David Brown\\\", email: \\\"david@lawfirm.com\\\", role: \\\"Paralegal\\\" },\\n  { id: \\\"lisa-006\\\", name: \\\"Lisa Taylor\\\", email: \\\"lisa@lawfirm.com\\\", role: \\\"Legal Assistant\\\" },\\n];\\n\\n// Initial questionnaire questions\\nconst initialQuestions: QuestionnaireQuestion[] = [\\n  {\\n    id: \\\"q1\\\",\\n    question: \\\"Is the applicant currently in the UK?\\\",\\n    questionZh: \\\"申请人目前在英国吗？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q2\\\",\\n    question: \\\"Does the applicant have a valid passport?\\\",\\n    questionZh: \\\"申请人是否持有有效护照？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q3\\\",\\n    question: \\\"Has the applicant applied for a UK visa before?\\\",\\n    questionZh: \\\"申请人之前是否申请过英国签证？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q4\\\",\\n    question: \\\"What is the purpose of the application?\\\",\\n    questionZh: \\\"申请的目的是什么？\\\",\\n    type: \\\"single-choice\\\",\\n    options: [\\n      { value: \\\"work\\\", label: \\\"Work\\\" },\\n      { value: \\\"study\\\", label: \\\"Study\\\" },\\n      { value: \\\"family\\\", label: \\\"Family reunion\\\" },\\n      { value: \\\"visit\\\", label: \\\"Visit\\\" },\\n      { value: \\\"settlement\\\", label: \\\"Settlement\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"q5\\\",\\n    question: \\\"Does the applicant have a sponsor (employer/university)?\\\",\\n    questionZh: \\\"申请人是否有担保人（雇主/大学）？\\\",\\n    type: \\\"boolean\\\",\\n    dependsOn: { questionId: \\\"q4\\\", value: \\\"work\\\" },\\n  },\\n];\\n\\n// Initial checklist items (for detailed stage)\\nconst initialChecklistItems: ChecklistItem[] = [\\n  {\\n    id: \\\"identity\\\",\\n    label: \\\"Identity Documents\\\",\\n    category: \\\"identity\\\",\\n    status: \\\"pending\\\",\\n    children: [\\n      { id: \\\"passport\\\", label: \\\"Valid Passport\\\", status: \\\"pending\\\" },\\n      { id: \\\"photo\\\", label: \\\"Passport Photo\\\", status: \\\"pending\\\" },\\n      { id: \\\"prev-visas\\\", label: \\\"Previous Visa History\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"financial\\\",\\n    label: \\\"Financial Evidence\\\",\\n    category: \\\"financial\\\",\\n    status: \\\"pending\\\",\\n    dependsOn: [\\\"identity\\\"],\\n    children: [\\n      {\\n        id: \\\"bank-statements\\\",\\n        label: \\\"Bank Statements (6 months)\\\",\\n        status: \\\"pending\\\",\\n      },\\n      {\\n        id: \\\"employment-letter\\\",\\n        label: \\\"Employment Letter\\\",\\n        status: \\\"pending\\\",\\n      },\\n      { id: \\\"tax-records\\\", label: \\\"Tax Records\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"sponsorship\\\",\\n    label: \\\"Sponsorship Documents\\\",\\n    category: \\\"sponsorship\\\",\\n    status: \\\"pending\\\",\\n    dependsOn: [\\\"identity\\\"],\\n    children: [\\n      { id: \\\"cos\\\", label: \\\"Certificate of Sponsorship\\\", status: \\\"pending\\\" },\\n      { id: \\\"job-offer\\\", label: \\\"Job Offer Letter\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"english\\\",\\n    label: \\\"English Language\\\",\\n    category: \\\"english\\\",\\n    status: \\\"pending\\\",\\n    children: [\\n      { id: \\\"ielts\\\", label: \\\"IELTS/English Test Results\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n];\\n\\n// Initial state\\nconst initialState: CaseDetailState = {\\n  caseId: null,\\n  caseReference: \\\"REF-2024-001\\\",\\n  caseNotesSummary: null,\\n  caseTeam: {\\n    lawyer: { id: \\\"john-001\\\", name: \\\"John\\\", email: \\\"john@example.com\\\" },\\n  },\\n  activeNav: \\\"overview\\\",\\n  highlightedGroupId: null,\\n  clientProfile: {\\n    completeness: 0,\\n  },\\n  selectedVisaType: null,\\n  checklist: {\\n    stage: \\\"empty\\\",\\n    questions: initialQuestions,\\n    items: initialChecklistItems,\\n    progress: {\\n      completed: 0,\\n      total: 0,\\n    },\\n  },\\n  uploadedFilePreviews: [],\\n  maxPreviewFiles: 6,\\n  allFiles: {},\\n  documentGroups: [],\\n  isLoadingDocuments: false,\\n  demoStage: 0,\\n  isAnalyzingDocuments: false,\\n  analysisProgress: 0,\\n  lastAnalysisAt: null,\\n  analyzedFileIds: [],\\n  // Application Phase - starts at analyzing since visa type is set at case creation\\n  applicationPhase: \\\"analyzing\\\",\\n  formSchema: null,\\n  formPilotStatus: {\\n    totalSessions: 0,\\n    lastRunAt: null,\\n    lastRunStatus: null,\\n  },\\n  analyzedFiles: [],\\n  // Application Checklist\\n  applicationChecklistItems: [],\\n  qualityIssues: [],\\n  questionnaireAnswers: {},\\n  checklistSectionExpanded: {\\n    personal: true,\\n    employment: true,\\n    financial: false,\\n    travel: false,\\n    education: false,\\n    family: false,\\n    other: false,\\n  },\\n  // Enhanced Checklist Workspace State\\n  enhancedChecklistItems: [],\\n  enhancedQualityIssues: [],\\n  selectedChecklistItemId: null,\\n  selectedIssueId: null,\\n  forwardModalOpen: false,\\n  forwardModalIssueId: null,\\n};\\n\\n// ============================================================================\\n// Helper Functions for 1:N File-Container Model\\n// ============================================================================\\n\\n// Helper to sync file previews from allFiles and documentGroups\\nconst syncFilePreviewsFromState = (\\n  allFiles: Record<string, DocumentFile>,\\n  groups: DocumentGroup[],\\n): UploadedFilePreview[] => {\\n  const previews: UploadedFilePreview[] = [];\\n  for (const group of groups) {\\n    for (const fileId of group.fileIds) {\\n      const file = allFiles[fileId];\\n      if (file && !file.isRemoved) {\\n        previews.push({\\n          id: file.id,\\n          name: file.name,\\n          type: file.type === \\\"pdf\\\" ? \\\"application/pdf\\\" : \\\"application/msword\\\",\\n          groupId: group.id,\\n        });\\n      }\\n    }\\n  }\\n  return previews;\\n};\\n\\n// Helper to get files for a specific container\\nconst getContainerFiles = (\\n  allFiles: Record<string, DocumentFile>,\\n  group: DocumentGroup,\\n): DocumentFile[] => {\\n  return group.fileIds\\n    .map(id => allFiles[id])\\n    .filter((f): f is DocumentFile => f !== undefined && !f.isRemoved);\\n};\\n\\n// Helper to get unclassified files (files with no container associations)\\nconst getUnclassifiedFiles = (\\n  allFiles: Record<string, DocumentFile>,\\n): DocumentFile[] => {\\n  return Object.values(allFiles).filter(\\n    f => !f.isRemoved && f.containerIds.length === 0\\n  );\\n};\\n\\n// Legacy compatibility: Helper to sync file previews from old-style groups (with files array)\\n// Used during migration and for backwards compatibility\\nconst syncFilePreviewsFromGroups = (\\n  groups: Array<DocumentGroup & { files?: DocumentFile[] }>,\\n): UploadedFilePreview[] => {\\n  const previews: UploadedFilePreview[] = [];\\n  for (const group of groups) {\\n    // Support both new model (fileIds) and old model (files)\\n    const files = (group as { files?: DocumentFile[] }).files || [];\\n    for (const file of files) {\\n      previews.push({\\n        id: file.id,\\n        name: file.name,\\n        type: file.type === \\\"pdf\\\" ? \\\"application/pdf\\\" : \\\"application/msword\\\",\\n        groupId: group.id,\\n      });\\n    }\\n  }\\n  return previews;\\n};\\n\\n// Convert old-style groups (files embedded) to new model (files separate, groups have fileIds)\\nconst convertLegacyGroupsToNewModel = (\\n  legacyGroups: LegacyDocumentGroup[]\\n): { allFiles: Record<string, DocumentFile>; documentGroups: DocumentGroup[] } => {\\n  const allFiles: Record<string, DocumentFile> = {};\\n  const documentGroups: DocumentGroup[] = [];\\n\\n  for (const group of legacyGroups) {\\n    const fileIds: string[] = [];\\n\\n    for (const file of group.files) {\\n      // Determine containerIds: empty if unclassified group, otherwise [group.id]\\n      const containerIds = group.id === 'unclassified' ? [] : [group.id];\\n\\n      // Store file in allFiles with containerIds\\n      allFiles[file.id] = {\\n        ...file,\\n        containerIds: file.containerIds || containerIds,\\n      };\\n      fileIds.push(file.id);\\n    }\\n\\n    // Create new-style group with fileIds instead of files\\n    documentGroups.push({\\n      id: group.id,\\n      title: group.title,\\n      tag: group.tag,\\n      mergedFileName: group.mergedFileName,\\n      status: group.status,\\n      hasChanges: group.hasChanges,\\n      fileIds,\\n      files: [],\\n      isSpecial: group.isSpecial,\\n      entityType: group.entityType,\\n      generatedName: group.generatedName,\\n    });\\n  }\\n\\n  return { allFiles, documentGroups };\\n};\\n\\n// Calculate profile completeness\\nconst calculateCompleteness = (\\n  profile: CaseDetailState[\\\"clientProfile\\\"],\\n): number => {\\n  let score = 0;\\n  const total = 3; // passport, contact info (email), contact info (phone)\\n\\n  if (profile.passport) score += 1;\\n  if (profile.contactInfo?.email) score += 1;\\n  if (profile.contactInfo?.phone) score += 1;\\n\\n  return Math.round((score / total) * 100);\\n};\\n\\n// Calculate checklist progress\\nconst calculateProgress = (\\n  items: ChecklistItem[],\\n): { completed: number; total: number } => {\\n  let completed = 0;\\n  let total = 0;\\n\\n  const countItems = (itemList: ChecklistItem[]) => {\\n    for (const item of itemList) {\\n      if (item.children && item.children.length > 0) {\\n        countItems(item.children);\\n      } else {\\n        total++;\\n        if (item.status === \\\"completed\\\") completed++;\\n      }\\n    }\\n  };\\n\\n  countItems(items);\\n  return { completed, total };\\n};\\n\\nexport const useCaseDetailStore = create<CaseDetailStore>()(\\n  devtools(\\n    (set, get) => ({\\n      ...initialState,\\n\\n      // Navigation\\n      setActiveNav: (nav: CaseDetailNavItem) => {\\n        set({ activeNav: nav }, false, \\\"setActiveNav\\\");\\n      },\\n\\n      navigateToDocumentGroup: (groupId: string) => {\\n        set(\\n          { activeNav: \\\"documents\\\", highlightedGroupId: groupId },\\n          false,\\n          \\\"navigateToDocumentGroup\\\"\\n        );\\n      },\\n\\n      clearHighlightedGroup: () => {\\n        set({ highlightedGroupId: null }, false, \\\"clearHighlightedGroup\\\");\\n      },\\n\\n      // Case\\n      setCaseId: (caseId: string) => {\\n        set({ caseId }, false, \\\"setCaseId\\\");\\n      },\\n\\n      setCaseReference: (reference: string) => {\\n        set({ caseReference: reference }, false, \\\"setCaseReference\\\");\\n      },\\n\\n      // Case Team\\n      setLawyer: (lawyer) => {\\n        set(\\n          (state) => ({\\n            caseTeam: { ...state.caseTeam, lawyer },\\n          }),\\n          false,\\n          \\\"setLawyer\\\"\\n        );\\n      },\\n\\n      setAssistant: (assistant) => {\\n        set(\\n          (state) => ({\\n            caseTeam: { ...state.caseTeam, assistant },\\n          }),\\n          false,\\n          \\\"setAssistant\\\"\\n        );\\n      },\\n\\n      // Case Notes Summary\\n      setCaseNotesSummary: (summary: CaseNotesSummary | null) => {\\n        set({ caseNotesSummary: summary }, false, \\\"setCaseNotesSummary\\\");\\n      },\\n\\n      // Client Profile\\n      updateClientProfile: (updates) => {\\n        set(\\n          (state) => {\\n            const newProfile = { ...state.clientProfile, ...updates };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n            return { clientProfile: newProfile };\\n          },\\n          false,\\n          \\\"updateClientProfile\\\",\\n        );\\n      },\\n\\n      setPassportInfo: (passport: PassportInfo) => {\\n        set(\\n          (state) => {\\n            const newProfile = { ...state.clientProfile, passport };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n            return { clientProfile: newProfile };\\n          },\\n          false,\\n          \\\"setPassportInfo\\\",\\n        );\\n      },\\n\\n      // Visa Type\\n      setVisaType: (type: VisaType | null) => {\\n        set({ selectedVisaType: type }, false, \\\"setVisaType\\\");\\n      },\\n\\n      // Checklist\\n      setChecklistStage: (stage: ChecklistStage) => {\\n        set(\\n          (state) => ({\\n            checklist: { ...state.checklist, stage },\\n          }),\\n          false,\\n          \\\"setChecklistStage\\\",\\n        );\\n      },\\n\\n      answerQuestion: (questionId: string, answer: unknown) => {\\n        set(\\n          (state) => {\\n            const questions = state.checklist.questions.map((q) =>\\n              q.id === questionId ? { ...q, answer } : q,\\n            );\\n            return {\\n              checklist: { ...state.checklist, questions },\\n            };\\n          },\\n          false,\\n          \\\"answerQuestion\\\",\\n        );\\n      },\\n\\n      updateChecklistItem: (itemId: string, status: ChecklistItemStatus) => {\\n        set(\\n          (state) => {\\n            const updateItemRecursive = (\\n              items: ChecklistItem[],\\n            ): ChecklistItem[] => {\\n              return items.map((item) => {\\n                if (item.id === itemId) {\\n                  return { ...item, status };\\n                }\\n                if (item.children) {\\n                  return {\\n                    ...item,\\n                    children: updateItemRecursive(item.children),\\n                  };\\n                }\\n                return item;\\n              });\\n            };\\n\\n            const newItems = updateItemRecursive(state.checklist.items);\\n            const progress = calculateProgress(newItems);\\n\\n            return {\\n              checklist: {\\n                ...state.checklist,\\n                items: newItems,\\n                progress,\\n              },\\n            };\\n          },\\n          false,\\n          \\\"updateChecklistItem\\\",\\n        );\\n      },\\n\\n      evolveChecklist: () => {\\n        const state = get();\\n        const { checklist, uploadedFilePreviews } = state;\\n        const fileCount = uploadedFilePreviews.length;\\n        const answeredQuestions = checklist.questions.filter(\\n          (q) => q.answer !== undefined,\\n        ).length;\\n        const totalQuestions = checklist.questions.length;\\n\\n        let newStage: ChecklistStage = checklist.stage;\\n\\n        // Evolution logic based on files and answers\\n        if (fileCount === 0) {\\n          newStage = \\\"empty\\\";\\n        } else if (fileCount >= 1 && checklist.stage === \\\"empty\\\") {\\n          newStage = \\\"questionnaire\\\";\\n        } else if (\\n          (answeredQuestions >= totalQuestions * 0.5 || fileCount >= 3) &&\\n          checklist.stage === \\\"questionnaire\\\"\\n        ) {\\n          newStage = \\\"partial\\\";\\n        } else if (\\n          (answeredQuestions === totalQuestions || state.selectedVisaType) &&\\n          checklist.stage === \\\"partial\\\"\\n        ) {\\n          newStage = \\\"detailed\\\";\\n        }\\n\\n        if (newStage !== checklist.stage) {\\n          set(\\n            (state) => ({\\n              checklist: {\\n                ...state.checklist,\\n                stage: newStage,\\n                progress: calculateProgress(state.checklist.items),\\n              },\\n            }),\\n            false,\\n            \\\"evolveChecklist\\\",\\n          );\\n        }\\n      },\\n\\n      // File Previews\\n      addFilePreview: (file: UploadedFilePreview) => {\\n        set(\\n          (state) => {\\n            const newPreviews = [...state.uploadedFilePreviews, file];\\n            return { uploadedFilePreviews: newPreviews };\\n          },\\n          false,\\n          \\\"addFilePreview\\\",\\n        );\\n        // Trigger checklist evolution\\n        get().evolveChecklist();\\n      },\\n\\n      removeFilePreview: (fileId: string) => {\\n        set(\\n          (state) => ({\\n            uploadedFilePreviews: state.uploadedFilePreviews.filter(\\n              (f) => f.id !== fileId,\\n            ),\\n          }),\\n          false,\\n          \\\"removeFilePreview\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      setFilePreviews: (files: UploadedFilePreview[]) => {\\n        set({ uploadedFilePreviews: files }, false, \\\"setFilePreviews\\\");\\n        get().evolveChecklist();\\n      },\\n\\n      // Demo Controls\\n      advanceDemoStage: () => {\\n        set(\\n          (state) => {\\n            const stages: ChecklistStage[] = [\\n              \\\"empty\\\",\\n              \\\"questionnaire\\\",\\n              \\\"partial\\\",\\n              \\\"detailed\\\",\\n            ];\\n            const currentIndex = stages.indexOf(state.checklist.stage);\\n            const nextIndex = Math.min(currentIndex + 1, stages.length - 1);\\n\\n            return {\\n              demoStage: state.demoStage + 1,\\n              checklist: {\\n                ...state.checklist,\\n                stage: stages[nextIndex],\\n                progress: calculateProgress(state.checklist.items),\\n              },\\n            };\\n          },\\n          false,\\n          \\\"advanceDemoStage\\\",\\n        );\\n      },\\n\\n      resetDemoStage: () => {\\n        set(\\n          {\\n            demoStage: 0,\\n            checklist: {\\n              ...initialState.checklist,\\n              stage: \\\"empty\\\",\\n            },\\n          },\\n          false,\\n          \\\"resetDemoStage\\\",\\n        );\\n      },\\n\\n      // Document Groups\\n      setDocumentGroups: (groups: DocumentGroup[]) => {\\n        const previews = syncFilePreviewsFromGroups(groups);\\n        set(\\n          { documentGroups: groups, uploadedFilePreviews: previews },\\n          false,\\n          \\\"setDocumentGroups\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      addDocumentGroup: (templateName: string) => {\\n        set(\\n          (state) => {\\n            const newGroup: DocumentGroup = {\\n              id: `group_${Date.now()}`,\\n              title: templateName,\\n              tag: templateName,\\n              mergedFileName: `${templateName}.pdf`,\\n              status: \\\"pending\\\",\\n              fileIds: [],\\n              files: [],\\n            };\\n            // Append new category to the end of the array\\n            // The grid filters out \\\"unclassified\\\" so new categories appear at the end\\n            return { documentGroups: [...state.documentGroups, newGroup] };\\n          },\\n          false,\\n          \\\"addDocumentGroup\\\",\\n        );\\n      },\\n\\n      deleteDocumentGroup: (groupId: string) => {\\n        set(\\n          (state) => {\\n            const newGroups = state.documentGroups.filter(\\n              (g) => g.id !== groupId,\\n            );\\n            const previews = syncFilePreviewsFromGroups(newGroups);\\n            return {\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"deleteDocumentGroup\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      renameDocumentGroup: (groupId: string, newTitle: string) => {\\n        set(\\n          (state) => ({\\n            documentGroups: state.documentGroups.map((g) =>\\n              g.id === groupId ? { ...g, mergedFileName: newTitle } : g,\\n            ),\\n          }),\\n          false,\\n          \\\"renameDocumentGroup\\\",\\n        );\\n      },\\n\\n      // ============================================\\n      // One-to-Many File-Container Actions\\n      // ============================================\\n\\n      // Add file to container (creates reference)\\n      addFileToContainer: (fileId: string, containerId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            const group = state.documentGroups.find(g => g.id === containerId);\\n\\n            if (!file || !group) return state;\\n\\n            // Idempotency: if already in container, do nothing\\n            if (file.containerIds.includes(containerId)) return state;\\n\\n            // Update file's containerIds\\n            const updatedFile = {\\n              ...file,\\n              containerIds: [...file.containerIds, containerId],\\n              isNew: true,\\n            };\\n\\n            // Update container's fileIds\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (g.id === containerId) {\\n                return {\\n                  ...g,\\n                  fileIds: [fileId, ...g.fileIds], // Add to beginning\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"addFileToContainer\\\",\\n        );\\n      },\\n\\n      // Remove file from container (removes reference only)\\n      removeFileFromContainer: (fileId: string, containerId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            const group = state.documentGroups.find(g => g.id === containerId);\\n\\n            if (!file || !group) return state;\\n\\n            // Update file's containerIds\\n            const updatedFile = {\\n              ...file,\\n              containerIds: file.containerIds.filter(id => id !== containerId),\\n            };\\n\\n            // Update container's fileIds\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (g.id === containerId) {\\n                return {\\n                  ...g,\\n                  fileIds: g.fileIds.filter(id => id !== fileId),\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"removeFileFromContainer\\\",\\n        );\\n      },\\n\\n      // Reuse file in another container (adds reference, keeps original)\\n      reuseFileInContainer: (fileId: string, targetContainerId: string) => {\\n        // Just call addFileToContainer - file will be in both containers\\n        get().addFileToContainer(fileId, targetContainerId);\\n      },\\n\\n      // Move file between containers (remove from source, add to target)\\n      moveFileBetweenContainers: (fileId: string, fromContainerId: string, toContainerId: string) => {\\n        get().removeFileFromContainer(fileId, fromContainerId);\\n        get().addFileToContainer(fileId, toContainerId);\\n      },\\n\\n      // Legacy moveFileToGroup - for Unclassified to Container moves\\n      // When moving from Unclassified (containerIds=[]), just add to target container\\n      // When moving between containers, use moveFileBetweenContainers\\n      moveFileToGroup: (fileId: string, targetGroupId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file || file.isRemoved) return state;\\n\\n            // Find source container (first container in list, or empty for unclassified)\\n            const sourceContainerId = file.containerIds.length > 0 ? file.containerIds[0] : null;\\n\\n            // If moving to same container, do nothing\\n            if (sourceContainerId === targetGroupId) return state;\\n\\n            // Update file's containerIds\\n            let newContainerIds: string[];\\n            if (sourceContainerId) {\\n              // Replace source with target\\n              newContainerIds = file.containerIds.filter(id => id !== sourceContainerId);\\n              if (!newContainerIds.includes(targetGroupId)) {\\n                newContainerIds = [targetGroupId, ...newContainerIds];\\n              }\\n            } else {\\n              // Unclassified: just add target\\n              newContainerIds = [targetGroupId];\\n            }\\n\\n            const updatedFile = {\\n              ...file,\\n              containerIds: newContainerIds,\\n              isNew: true,\\n            };\\n\\n            // Update groups\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (sourceContainerId && g.id === sourceContainerId) {\\n                // Remove from source\\n                return {\\n                  ...g,\\n                  fileIds: g.fileIds.filter(id => id !== fileId),\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              if (g.id === targetGroupId && !g.fileIds.includes(fileId)) {\\n                // Add to target\\n                return {\\n                  ...g,\\n                  fileIds: [fileId, ...g.fileIds],\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"moveFileToGroup\\\",\\n        );\\n      },\\n\\n      reorderFileInGroup: (\\n        groupId: string,\\n        fromIndex: number,\\n        toIndex: number,\\n      ) => {\\n        set(\\n          (state) => {\\n            const newGroups = state.documentGroups.map((group) => {\\n              if (group.id !== groupId) return group;\\n\\n              const newFileIds = [...group.fileIds];\\n              const [removed] = newFileIds.splice(fromIndex, 1);\\n              newFileIds.splice(toIndex, 0, removed);\\n\\n              return {\\n                ...group,\\n                fileIds: newFileIds,\\n                status: \\\"pending\\\" as const,\\n                hasChanges: true,\\n              };\\n            });\\n\\n            return { documentGroups: newGroups };\\n          },\\n          false,\\n          \\\"reorderFileInGroup\\\",\\n        );\\n      },\\n\\n      markFileForDeletion: (fileId: string, groupId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file) return state;\\n\\n            // Mark file as removed\\n            const updatedFile = { ...file, isRemoved: true, isNew: false };\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n\\n            // Update group status\\n            const newGroups = state.documentGroups.map((group) => {\\n              if (group.id !== groupId) return group;\\n              return {\\n                ...group,\\n                status: \\\"pending\\\" as const,\\n                hasChanges: true,\\n              };\\n            });\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"markFileForDeletion\\\",\\n        );\\n      },\\n\\n      clearFileNewStatus: (fileId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file) return state;\\n\\n            return {\\n              allFiles: {\\n                ...state.allFiles,\\n                [fileId]: { ...file, isNew: false },\\n              },\\n            };\\n          },\\n          false,\\n          \\\"clearFileNewStatus\\\",\\n        );\\n      },\\n\\n      clearGroupChangesFlag: (groupId: string) => {\\n        set(\\n          (state) => ({\\n            documentGroups: state.documentGroups.map((group) =>\\n              group.id === groupId ? { ...group, hasChanges: false } : group,\\n            ),\\n          }),\\n          false,\\n          \\\"clearGroupChangesFlag\\\",\\n        );\\n      },\\n\\n      confirmGroupReview: (groupId: string) => {\\n        set(\\n          (state) => {\\n            const group = state.documentGroups.find((g) => g.id === groupId);\\n            if (!group) return {};\\n\\n            // Update allFiles: remove isRemoved files, clear isNew flag for remaining\\n            const newAllFiles = { ...state.allFiles };\\n            const activeFileIds: string[] = [];\\n            for (const fileId of group.fileIds) {\\n              const file = newAllFiles[fileId];\\n              if (!file) continue;\\n              if (file.isRemoved) {\\n                // Remove the file from allFiles entirely\\n                delete newAllFiles[fileId];\\n              } else {\\n                // Clear isNew flag\\n                newAllFiles[fileId] = { ...file, isNew: false };\\n                activeFileIds.push(fileId);\\n              }\\n            }\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: state.documentGroups.map((g) =>\\n                g.id === groupId\\n                  ? {\\n                      ...g,\\n                      status: \\\"reviewed\\\" as const,\\n                      hasChanges: false,\\n                      fileIds: activeFileIds,\\n                    }\\n                  : g,\\n              ),\\n            };\\n          },\\n          false,\\n          \\\"confirmGroupReview\\\",\\n        );\\n      },\\n\\n      uploadDocuments: async () => {\\n        set({ isLoadingDocuments: true }, false, \\\"uploadDocuments:start\\\");\\n        // Simulate AI processing\\n        await new Promise((resolve) => setTimeout(resolve, 2000));\\n        // Convert legacy groups to new model\\n        const { allFiles, documentGroups } = convertLegacyGroupsToNewModel(INITIAL_DOCUMENT_GROUPS_LEGACY);\\n        const previews = syncFilePreviewsFromState(allFiles, documentGroups);\\n        set(\\n          {\\n            allFiles,\\n            documentGroups,\\n            uploadedFilePreviews: previews,\\n            isLoadingDocuments: false,\\n          },\\n          false,\\n          \\\"uploadDocuments:complete\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      uploadToGroup: (groupId: string, fileCount: number = 1) => {\\n        set(\\n          (state) => {\\n            const group = state.documentGroups.find(g => g.id === groupId);\\n            if (!group) return state;\\n\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n            const newFileIds: string[] = [];\\n\\n            for (let i = 0; i < fileCount; i++) {\\n              const fileId = `file_${timestamp}_${i}`;\\n              newAllFiles[fileId] = {\\n                id: fileId,\\n                name: `Uploaded_Page_${group.fileIds.length + i + 1}.pdf`,\\n                size: \\\"0.5 MB\\\",\\n                pages: 1,\\n                date: \\\"Just now\\\",\\n                type: \\\"pdf\\\",\\n                isNew: true,\\n                containerIds: [groupId],\\n              };\\n              newFileIds.push(fileId);\\n            }\\n\\n            const newGroups = state.documentGroups.map(g => {\\n              if (g.id === groupId) {\\n                return {\\n                  ...g,\\n                  fileIds: [...g.fileIds, ...newFileIds],\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadToGroup\\\",\\n        );\\n      },\\n\\n      // Upload and auto-classify documents (simulates AI classification)\\n      uploadAndAutoClassify: (totalPages: number = 8) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Helper to normalize names for comparison (remove spaces, hyphens, lowercase)\\n            const normalize = (str: string) =>\\n              str.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n\\n            // Categories to potentially create (simulating AI classification results)\\n            const allPossibleCategories = [\\n              { category: \\\"Passport\\\", pages: 2 },\\n              { category: \\\"Bank Statement\\\", pages: 3 },\\n              { category: \\\"Employment Letter\\\", pages: 2 },\\n              { category: \\\"Utility Bill\\\", pages: 2 },\\n              { category: \\\"Tax Documents\\\", pages: 2 },\\n              { category: \\\"Education Certificate\\\", pages: 1 },\\n              { category: \\\"Travel History\\\", pages: 2 },\\n              { category: \\\"Medical Records\\\", pages: 2 },\\n              { category: \\\"Marriage Certificate\\\", pages: 1 },\\n              { category: \\\"Birth Certificate\\\", pages: 1 },\\n            ];\\n\\n            // Find categories that don't exist yet\\n            const existingNormalizedTitles = state.documentGroups\\n              .filter((g) => g.id !== \\\"unclassified\\\")\\n              .map((g) => normalize(g.title));\\n\\n            const newCategories = allPossibleCategories.filter(\\n              (c) => !existingNormalizedTitles.includes(normalize(c.category))\\n            );\\n\\n            // Select 1-2 NEW categories to create\\n            const numNewCategories = Math.min(\\n              Math.floor(Math.random() * 2) + 1,\\n              newCategories.length\\n            );\\n            const selectedNewCategories = newCategories\\n              .sort(() => Math.random() - 0.5)\\n              .slice(0, numNewCategories);\\n\\n            // Also add files to 0-1 existing categories (if any exist)\\n            const existingClassifiedGroups = state.documentGroups.filter(\\n              (g) => g.id !== \\\"unclassified\\\" && g.id !== \\\"case_notes\\\"\\n            );\\n            const selectedExistingGroup =\\n              existingClassifiedGroups.length > 0 && Math.random() > 0.3\\n                ? existingClassifiedGroups[\\n                    Math.floor(Math.random() * existingClassifiedGroups.length)\\n                  ]\\n                : null;\\n\\n            // Calculate pages distribution\\n            const newCategoryPages = selectedNewCategories.reduce(\\n              (sum, c) => sum + c.pages,\\n              0\\n            );\\n            const existingGroupPages = selectedExistingGroup ? 2 : 0;\\n            const classifiedPages = newCategoryPages + existingGroupPages;\\n            const unclassifiedPages = Math.max(2, totalPages - classifiedPages);\\n\\n            let newGroups = [...state.documentGroups];\\n\\n            // Create NEW category groups with files\\n            selectedNewCategories.forEach((result, catIndex) => {\\n              const groupId = `group_${timestamp}_${catIndex}`;\\n              const fileIds: string[] = [];\\n\\n              for (let i = 0; i < result.pages; i++) {\\n                const fileId = `classified_${timestamp}_${catIndex}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `${result.category.replace(/\\\\s+/g, \\\"_\\\")}_Page_${i + 1}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [groupId],\\n                };\\n                fileIds.push(fileId);\\n              }\\n\\n              newGroups.push({\\n                id: groupId,\\n                title: result.category,\\n                tag: result.category,\\n                mergedFileName: `${result.category.replace(/\\\\s+/g, \\\"_\\\")}.pdf`,\\n                status: \\\"pending\\\",\\n                hasChanges: true,\\n                fileIds,\\n                files: [],\\n              });\\n            });\\n\\n            // Add files to an existing group (if selected)\\n            if (selectedExistingGroup) {\\n              const existingFileIds: string[] = [];\\n              for (let i = 0; i < existingGroupPages; i++) {\\n                const fileId = `existing_${timestamp}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `${selectedExistingGroup.title.replace(/\\\\s+/g, \\\"_\\\")}_New_${i + 1}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [selectedExistingGroup.id],\\n                };\\n                existingFileIds.push(fileId);\\n              }\\n              newGroups = newGroups.map((g) =>\\n                g.id === selectedExistingGroup.id\\n                  ? {\\n                      ...g,\\n                      fileIds: [...g.fileIds, ...existingFileIds],\\n                      status: \\\"pending\\\" as const,\\n                      hasChanges: true,\\n                    }\\n                  : g\\n              );\\n            }\\n\\n            // Add remaining pages as unclassified (containerIds = [])\\n            if (unclassifiedPages > 0) {\\n              const existingUnclassifiedCount = getUnclassifiedFiles(state.allFiles).length;\\n              for (let i = 0; i < unclassifiedPages; i++) {\\n                const fileId = `unclassified_${timestamp}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `Scan_Page_${String(existingUnclassifiedCount + i + 1).padStart(3, \\\"0\\\")}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [], // Empty = unclassified\\n                };\\n              }\\n            }\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadAndAutoClassify\\\",\\n        );\\n      },\\n\\n      // Duplicate/Reuse a file to another group (one-to-many linking)\\n      // Now uses reference model - no physical duplication needed\\n      duplicateFileToGroup: (fileId: string, targetGroupId: string) => {\\n        // In the new 1:N model, this is the same as reuseFileInContainer\\n        get().addFileToContainer(fileId, targetGroupId);\\n      },\\n\\n      // Add multiple files to an existing container (moves files from their current containers)\\n      addFilesToGroup: (groupId: string, orderedFileIds: string[]) => {\\n        set(\\n          (state) => {\\n            const targetGroup = state.documentGroups.find((g) => g.id === groupId);\\n            if (!targetGroup) return state;\\n\\n            const newAllFiles = { ...state.allFiles };\\n            const affectedGroupIds = new Set<string>();\\n\\n            // Update each file's containerIds: remove from old, add to target\\n            for (const fileId of orderedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                // Track affected source groups\\n                for (const cid of file.containerIds) {\\n                  if (cid !== groupId) affectedGroupIds.add(cid);\\n                }\\n                // Update file to only be in the target container\\n                newAllFiles[fileId] = {\\n                  ...file,\\n                  containerIds: [groupId],\\n                  isNew: true,\\n                };\\n              }\\n            }\\n\\n            // Remove files from source groups' fileIds\\n            const movedFileIdSet = new Set(orderedFileIds);\\n            let updatedGroups = state.documentGroups.map((group) => {\\n              if (group.id === groupId) {\\n                // Add files to target group (preserve existing + add new in order)\\n                const existingFileIds = group.fileIds.filter((id) => !movedFileIdSet.has(id));\\n                return {\\n                  ...group,\\n                  fileIds: [...existingFileIds, ...orderedFileIds],\\n                  hasChanges: true,\\n                };\\n              }\\n              if (!affectedGroupIds.has(group.id)) return group;\\n              return {\\n                ...group,\\n                fileIds: group.fileIds.filter((fid) => !movedFileIdSet.has(fid)),\\n              };\\n            });\\n\\n            // Auto-delete source groups that became empty\\n            updatedGroups = updatedGroups.filter(\\n              (g) => g.fileIds.length > 0 || !affectedGroupIds.has(g.id)\\n            );\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"addFilesToGroup\\\"\\n        );\\n      },\\n\\n      // Merge (copy) multiple files into a new combined document group\\n      // Source files remain unchanged - this creates copies for the merged document\\n      mergeDocumentsIntoGroup: (\\n        name: string,\\n        orderedFileIds: string[]\\n      ) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newGroupId = `merged_${timestamp}_${Math.random().toString(36).substr(2, 9)}`;\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Create COPIES of selected files for the merged document\\n            // Original files remain unchanged in their source containers\\n            const copiedFileIds: string[] = [];\\n\\n            for (let i = 0; i < orderedFileIds.length; i++) {\\n              const originalFileId = orderedFileIds[i];\\n              const originalFile = newAllFiles[originalFileId];\\n              if (originalFile) {\\n                // Create a new file ID for the copy\\n                const newFileId = `${originalFileId}_copy_${timestamp}_${i}`;\\n\\n                // Create a copy of the file for the new merged group\\n                newAllFiles[newFileId] = {\\n                  ...originalFile,\\n                  id: newFileId,\\n                  containerIds: [newGroupId],\\n                  isNew: true,\\n                };\\n                copiedFileIds.push(newFileId);\\n              }\\n            }\\n\\n            // Source groups remain unchanged - no files are removed\\n\\n            // Create new merged group with copied files\\n            const newGroup: DocumentGroup = {\\n              id: newGroupId,\\n              title: name,\\n              tag: \\\"Other Documents\\\",\\n              mergedFileName: `${name.replace(/\\\\s+/g, \\\"_\\\")}_Merged.pdf`,\\n              status: \\\"pending\\\",\\n              fileIds: copiedFileIds,\\n              files: [],\\n              hasChanges: true,\\n            };\\n\\n            const updatedGroups = [...state.documentGroups, newGroup];\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"mergeDocumentsIntoGroup\\\",\\n        );\\n      },\\n\\n      // Upload folder with recursive path parsing\\n      uploadFolder: (files: Array<{ file: File; relativePath: string }>) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Separate files into recognized (known entity) and unrecognized (unknown entity)\\n            const recognizedFiles: Array<{ file: File; relativePath: string; parsed: ReturnType<typeof parseDocumentPath> }> = [];\\n            const unrecognizedFiles: Array<{ file: File; relativePath: string; parsed: ReturnType<typeof parseDocumentPath> }> = [];\\n\\n            for (const fileData of files) {\\n              const parsed = parseDocumentPath(fileData.relativePath, fileData.file.name);\\n              if (parsed.who === 'unknown') {\\n                unrecognizedFiles.push({ ...fileData, parsed });\\n              } else {\\n                recognizedFiles.push({ ...fileData, parsed });\\n              }\\n            }\\n\\n            // Group recognized files by their generated document name\\n            const groupedByName = new Map<string, {\\n              parsedDoc: ReturnType<typeof parseDocumentPath>;\\n              files: Array<{ file: File; relativePath: string }>;\\n            }>();\\n\\n            for (const fileData of recognizedFiles) {\\n              if (!groupedByName.has(fileData.parsed.generatedName)) {\\n                groupedByName.set(fileData.parsed.generatedName, {\\n                  parsedDoc: fileData.parsed,\\n                  files: [],\\n                });\\n              }\\n              groupedByName.get(fileData.parsed.generatedName)!.files.push(fileData);\\n            }\\n\\n            // Create DocumentGroups for each unique generated name\\n            const newGroups: DocumentGroup[] = [];\\n            let fileIndex = 0;\\n\\n            // Determine tag from document type\\n            const tagMap: Record<string, string> = {\\n              passport: \\\"Identity\\\",\\n              nationalId: \\\"Identity\\\",\\n              birthCertificate: \\\"Identity\\\",\\n              bankStatement: \\\"Financial\\\",\\n              payslip: \\\"Financial\\\",\\n              taxReturn: \\\"Financial\\\",\\n              employmentLetter: \\\"Employment\\\",\\n              employmentContract: \\\"Employment\\\",\\n              educationCertificate: \\\"Education\\\",\\n              transcript: \\\"Education\\\",\\n              schoolEnrollment: \\\"Education\\\",\\n              marriageCertificate: \\\"Relationship\\\",\\n              proofOfCohabitation: \\\"Relationship\\\",\\n              propertyTitle: \\\"Accommodation\\\",\\n              proofOfAccommodation: \\\"Accommodation\\\",\\n              utilityBill: \\\"Utility\\\",\\n              visa: \\\"Travel\\\",\\n              insurance: \\\"Insurance\\\",\\n              letterOfConsent: \\\"Other\\\",\\n              document: \\\"Other Documents\\\",\\n            };\\n\\n            for (const [generatedName, data] of groupedByName) {\\n              const groupId = `group_folder_${timestamp}_${newGroups.length}`;\\n              const fileIds: string[] = [];\\n\\n              for (const fileData of data.files) {\\n                const fileId = `folder_${timestamp}_${fileIndex++}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: fileData.file.name,\\n                  size: `${(fileData.file.size / 1024).toFixed(1)} KB`,\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\" as const,\\n                  isNew: true,\\n                  containerIds: [groupId],\\n                  relativePath: fileData.relativePath,\\n                  entityType: data.parsedDoc.who,\\n                };\\n                fileIds.push(fileId);\\n              }\\n\\n              const tag = tagMap[data.parsedDoc.documentType] || \\\"Other Documents\\\";\\n\\n              newGroups.push({\\n                id: groupId,\\n                title: generatedName,\\n                tag,\\n                mergedFileName: `${generatedName}.pdf`,\\n                status: \\\"pending\\\",\\n                fileIds,\\n                files: [],\\n                hasChanges: true,\\n                entityType: data.parsedDoc.who,\\n                generatedName,\\n              });\\n            }\\n\\n            // Add unrecognized files as unclassified (containerIds = [])\\n            for (const fileData of unrecognizedFiles) {\\n              const fileId = `folder_${timestamp}_${fileIndex++}`;\\n              newAllFiles[fileId] = {\\n                id: fileId,\\n                name: fileData.file.name,\\n                size: `${(fileData.file.size / 1024).toFixed(1)} KB`,\\n                pages: 1,\\n                date: \\\"Just now\\\",\\n                type: \\\"pdf\\\" as const,\\n                isNew: true,\\n                containerIds: [], // Empty = unclassified\\n                relativePath: fileData.relativePath,\\n                entityType: \\\"unknown\\\" as const,\\n              };\\n            }\\n\\n            // Add new classified groups\\n            const updatedGroups = [...state.documentGroups, ...newGroups];\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadFolder\\\",\\n        );\\n      },\\n\\n      // Upload file for a specific evidence requirement\\n      uploadForEvidence: (evidenceId: string, evidenceName: string) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const normalizedName = evidenceName.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Find existing group that matches the evidence name\\n            let targetGroupId: string | undefined;\\n            for (const g of state.documentGroups) {\\n              const normalizedGroupTitle = g.title.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n              if (normalizedGroupTitle.includes(normalizedName) || normalizedName.includes(normalizedGroupTitle)) {\\n                targetGroupId = g.id;\\n                break;\\n              }\\n            }\\n\\n            // If no matching group exists, create one\\n            if (!targetGroupId) {\\n              targetGroupId = `group_${timestamp}`;\\n            }\\n\\n            const fileId = `evidence_${timestamp}`;\\n            newAllFiles[fileId] = {\\n              id: fileId,\\n              name: `${evidenceName.replace(/\\\\s+/g, \\\"_\\\")}.pdf`,\\n              size: \\\"0.5 MB\\\",\\n              pages: 1,\\n              date: \\\"Just now\\\",\\n              type: \\\"pdf\\\",\\n              isNew: true,\\n              containerIds: [targetGroupId],\\n            };\\n\\n            let newGroups = [...state.documentGroups];\\n\\n            const existingGroup = newGroups.find(g => g.id === targetGroupId);\\n            if (existingGroup) {\\n              // Add file to existing group\\n              newGroups = newGroups.map((g) =>\\n                g.id === targetGroupId\\n                  ? {\\n                      ...g,\\n                      fileIds: [...g.fileIds, fileId],\\n                      status: \\\"pending\\\" as const,\\n                      hasChanges: true,\\n                    }\\n                  : g\\n              );\\n            } else {\\n              // Create new group for this evidence\\n              newGroups.push({\\n                id: targetGroupId,\\n                title: evidenceName,\\n                tag: evidenceName,\\n                mergedFileName: `${evidenceName}.pdf`,\\n                status: \\\"pending\\\",\\n                fileIds: [fileId],\\n                files: [],\\n                hasChanges: true,\\n              });\\n            }\\n\\n            // Update enhanced checklist items (requiredEvidence is only on EnhancedChecklistItem)\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: true,\\n                      linkedFileId: fileId,\\n                      linkedFileName: newAllFiles[fileId].name,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            // Mark related issue as resolved\\n            const issueIdToResolve = `issue_missing_evidence_${evidenceId}`;\\n            const updatedIssues = state.enhancedQualityIssues.map((issue) =>\\n              issue.id === issueIdToResolve\\n                ? {\\n                    ...issue,\\n                    status: \\\"resolved\\\" as IssueStatus,\\n                    resolvedAt: new Date().toISOString(),\\n                    updatedAt: new Date().toISOString(),\\n                  }\\n                : issue\\n            );\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n              enhancedChecklistItems: updatedEnhancedItems,\\n              enhancedQualityIssues: updatedIssues,\\n            };\\n          },\\n          false,\\n          \\\"uploadForEvidence\\\"\\n        );\\n      },\\n\\n      // Link evidence to an existing document group from File Hub\\n      linkEvidenceToGroup: (evidenceId: string, groupId: string) => {\\n        set(\\n          (state) => {\\n            const targetGroup = state.documentGroups.find((g) => g.id === groupId);\\n            if (!targetGroup) return state;\\n\\n            // Update enhanced checklist items\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: true,\\n                      linkedFileId: groupId, // Link to the group ID\\n                      linkedFileName: targetGroup.title,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            // Mark related issue as resolved\\n            const issueIdToResolve = `issue_missing_evidence_${evidenceId}`;\\n            const updatedIssues = state.enhancedQualityIssues.map((issue) =>\\n              issue.id === issueIdToResolve\\n                ? {\\n                    ...issue,\\n                    status: \\\"resolved\\\" as IssueStatus,\\n                    resolvedAt: new Date().toISOString(),\\n                    updatedAt: new Date().toISOString(),\\n                  }\\n                : issue\\n            );\\n\\n            return {\\n              enhancedChecklistItems: updatedEnhancedItems,\\n              enhancedQualityIssues: updatedIssues,\\n            };\\n          },\\n          false,\\n          \\\"linkEvidenceToGroup\\\"\\n        );\\n      },\\n\\n      // Unlink evidence from a document group\\n      unlinkEvidence: (evidenceId: string) => {\\n        set(\\n          (state) => {\\n            // Update enhanced checklist items - reset the evidence to unlinked state\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: false,\\n                      linkedFileId: undefined,\\n                      linkedFileName: undefined,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            return {\\n              enhancedChecklistItems: updatedEnhancedItems,\\n            };\\n          },\\n          false,\\n          \\\"unlinkEvidence\\\"\\n        );\\n      },\\n\\n      // Demo: Review all documents and analyze to generate client profile\\n      reviewAllDocumentsAndAnalyze: async () => {\\n        const state = get();\\n\\n        // Step 1: Mark all document groups as reviewed\\n        set(\\n          (prev) => {\\n            const newAllFiles = { ...prev.allFiles };\\n            const newDocumentGroups = prev.documentGroups.map((g) => {\\n              const activeFileIds: string[] = [];\\n              for (const fileId of g.fileIds) {\\n                const file = newAllFiles[fileId];\\n                if (!file) continue;\\n                if (file.isRemoved) {\\n                  delete newAllFiles[fileId];\\n                } else {\\n                  newAllFiles[fileId] = { ...file, isNew: false };\\n                  activeFileIds.push(fileId);\\n                }\\n              }\\n              return {\\n                ...g,\\n                status: \\\"reviewed\\\" as const,\\n                hasChanges: false,\\n                fileIds: activeFileIds,\\n              };\\n            });\\n            return {\\n              isAnalyzingDocuments: true,\\n              analysisProgress: 0,\\n              allFiles: newAllFiles,\\n              documentGroups: newDocumentGroups,\\n            };\\n          },\\n          false,\\n          \\\"reviewAllDocuments\\\",\\n        );\\n\\n        // Step 2: Simulate document analysis with progress updates\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 600));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`,\\n          );\\n        }\\n\\n        // Step 3: Generate mock client profile from \\\"extracted\\\" document data\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        // Step 4: Update client profile and record analyzed files\\n        const currentState = get();\\n        const analyzedFileIds = currentState.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(currentState.allFiles, g).map((f) => f.id));\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            // Mark all analyzed files in allFiles\\n            const newAllFiles = { ...state.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of analyzedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n\\n            return {\\n              clientProfile: newProfile,\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\",\\n        );\\n\\n        // Evolve checklist based on new data\\n        get().evolveChecklist();\\n      },\\n\\n      // Run document analysis on ready (reviewed) documents only\\n      runDocumentAnalysis: async () => {\\n        const state = get();\\n\\n        // Get all ready files (from reviewed groups, excluding unclassified and removed)\\n        const readyFiles = state.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(state.allFiles, g));\\n\\n        if (readyFiles.length === 0) {\\n          return; // Nothing to analyze\\n        }\\n\\n        set(\\n          { isAnalyzingDocuments: true, analysisProgress: 0 },\\n          false,\\n          \\\"startAnalysis\\\",\\n        );\\n\\n        // Simulate analysis\\n        const totalSteps = 4;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 500));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`,\\n          );\\n        }\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        set(\\n          (state) => {\\n            // Mark analyzed files in allFiles\\n            const newAllFiles = { ...state.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of analyzedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n            return {\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\",\\n        );\\n      },\\n\\n      // Application Phase Management\\n      setApplicationPhase: (phase: ApplicationPhase) => {\\n        set({ applicationPhase: phase }, false, \\\"setApplicationPhase\\\");\\n      },\\n\\n      // Initialize form schema based on visa type\\n      initFormSchema: (visaType: VisaType) => {\\n        const schemaConfigs: Record<VisaType, Omit<FormSchemaStatus, \\\"filledFields\\\" | \\\"completionPercentage\\\" | \\\"lastUpdatedAt\\\">> = {\\n          \\\"skilled-worker\\\": {\\n            schemaName: \\\"Skilled Worker Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 58,\\n            emptyRequiredFields: [\\n              \\\"Certificate of Sponsorship number\\\",\\n              \\\"Sponsor license number\\\",\\n              \\\"Job start date\\\",\\n              \\\"Annual salary\\\",\\n              \\\"SOC code\\\",\\n              \\\"Working hours per week\\\",\\n              \\\"Main work location\\\",\\n              \\\"Previous UK visas\\\",\\n              \\\"Criminal convictions\\\",\\n              \\\"TB test certificate\\\",\\n            ],\\n          },\\n          naturalisation: {\\n            schemaName: \\\"Naturalisation Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 55,\\n            emptyRequiredFields: [\\n              \\\"Current immigration status\\\",\\n              \\\"Date ILR granted\\\",\\n              \\\"Residency period details\\\",\\n              \\\"Life in the UK test pass date\\\",\\n              \\\"English language proof\\\",\\n              \\\"Good character declaration\\\",\\n              \\\"Referee details\\\",\\n            ],\\n          },\\n          visitor: {\\n            schemaName: \\\"Visitor Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 38,\\n            emptyRequiredFields: [\\n              \\\"Visit purpose\\\",\\n              \\\"Intended stay duration\\\",\\n              \\\"Accommodation address\\\",\\n              \\\"Return ticket booking\\\",\\n              \\\"Ties to home country\\\",\\n            ],\\n          },\\n          \\\"partner-spouse\\\": {\\n            schemaName: \\\"Partner/Spouse Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 62,\\n            emptyRequiredFields: [\\n              \\\"Sponsor relationship\\\",\\n              \\\"Sponsor immigration status\\\",\\n              \\\"Accommodation details\\\",\\n              \\\"Financial evidence\\\",\\n              \\\"English language proof\\\",\\n              \\\"Relationship evidence\\\",\\n            ],\\n          },\\n        };\\n\\n        const config = schemaConfigs[visaType];\\n        const formSchema: FormSchemaStatus = {\\n          ...config,\\n          filledFields: 0,\\n          completionPercentage: 0,\\n          lastUpdatedAt: null,\\n        };\\n\\n        set({ formSchema }, false, \\\"initFormSchema\\\");\\n      },\\n\\n      // Start document analysis (Application workflow)\\n      startAnalysis: async () => {\\n        const state = get();\\n\\n        // Get ready files (from reviewed groups, excluding unclassified)\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const readyFiles = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g)\\n        );\\n\\n        if (readyFiles.length === 0) {\\n          return;\\n        }\\n\\n        // Set analyzing phase\\n        set(\\n          {\\n            applicationPhase: \\\"analyzing\\\",\\n            isAnalyzingDocuments: true,\\n            analysisProgress: 0,\\n          },\\n          false,\\n          \\\"startAnalysis\\\"\\n        );\\n\\n        // Simulate analysis with progress\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 800));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`\\n          );\\n        }\\n\\n        // Generate analyzed files summary\\n        const analyzedFiles: AnalyzedFileSummary[] = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => ({\\n            id: f.id,\\n            name: f.name,\\n            groupTitle: g.title,\\n            pages: f.pages || 1,\\n            analyzedAt: new Date().toISOString(),\\n          }))\\n        );\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        // Update form schema with mock extracted data\\n        const currentSchema = state.formSchema;\\n        const filledFields = currentSchema\\n          ? Math.round(currentSchema.totalFields * 0.73)\\n          : 0;\\n        const updatedSchema: FormSchemaStatus | null = currentSchema\\n          ? {\\n              ...currentSchema,\\n              filledFields,\\n              completionPercentage: Math.round(\\n                (filledFields / currentSchema.totalFields) * 100\\n              ),\\n              lastUpdatedAt: new Date().toISOString(),\\n            }\\n          : null;\\n\\n        // Mock passport extraction\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            return {\\n              applicationPhase: \\\"questionnaire\\\",\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: new Date().toISOString(),\\n              analyzedFileIds,\\n              analyzedFiles,\\n              formSchema: updatedSchema,\\n              clientProfile: newProfile,\\n              // Reset questionnaire answers to trigger questionnaire flow\\n              questionnaireAnswers: {},\\n              // Mark analyzed files in allFiles\\n              allFiles: (() => {\\n                const newAllFiles = { ...state.allFiles };\\n                const now = new Date().toISOString();\\n                for (const fileId of analyzedFileIds) {\\n                  const file = newAllFiles[fileId];\\n                  if (file) {\\n                    newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n                  }\\n                }\\n                return newAllFiles;\\n              })(),\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\"\\n        );\\n\\n        // Don't auto-generate checklist - wait for questionnaire to be completed\\n        // Checklist will be generated when user submits questionnaire answers\\n      },\\n\\n      // Re-analyze: only updates analyzed files without regenerating checklist\\n      // Used when new files are added after initial checklist generation\\n      reAnalyze: async () => {\\n        const state = get();\\n\\n        // Get all currently reviewed file IDs\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const allReadyFileIds = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => f.id)\\n        );\\n\\n        // Find new files that haven't been analyzed\\n        const newFileIds = allReadyFileIds.filter(\\n          (id) => !state.analyzedFileIds.includes(id)\\n        );\\n\\n        if (newFileIds.length === 0) {\\n          return;\\n        }\\n\\n        // Brief analyzing state\\n        set(\\n          { isAnalyzingDocuments: true, analysisProgress: 0 },\\n          false,\\n          \\\"reAnalyze:start\\\"\\n        );\\n\\n        // Simulate quick analysis\\n        await new Promise((resolve) => setTimeout(resolve, 500));\\n        set({ analysisProgress: 50 }, false, \\\"reAnalyze:progress\\\");\\n        await new Promise((resolve) => setTimeout(resolve, 500));\\n\\n        // Update analyzed file IDs to include new files\\n        const updatedAnalyzedFileIds = [...state.analyzedFileIds, ...newFileIds];\\n\\n        set(\\n          (currentState) => {\\n            // Mark new files as analyzed in allFiles\\n            const newAllFiles = { ...currentState.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of newFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n            return {\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds: updatedAnalyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"reAnalyze:complete\\\"\\n        );\\n      },\\n\\n      // Launch Form Pilot (opens mock form with auto-fill)\\n      launchFormPilot: () => {\\n        const state = get();\\n\\n        // Import and use the bridge dynamically to avoid SSR issues\\n        import(\\\"@/lib/form-pilot-bridge\\\").then(({ launchFormPilotDemo, listenForCompletion }) => {\\n          // Launch the form pilot demo\\n          const { cleanup } = launchFormPilotDemo();\\n\\n          // Listen for completion\\n          const removeListener = listenForCompletion((result) => {\\n            set(\\n              (currentState) => ({\\n                formPilotStatus: {\\n                  ...currentState.formPilotStatus,\\n                  totalSessions: currentState.formPilotStatus.totalSessions + 1,\\n                  lastRunAt: new Date().toISOString(),\\n                  lastRunStatus: result.status === \\\"success\\\" ? \\\"success\\\" : \\\"error\\\",\\n                },\\n              }),\\n              false,\\n              \\\"formPilotComplete\\\"\\n            );\\n\\n            // Cleanup\\n            removeListener();\\n            cleanup();\\n          });\\n        });\\n\\n        // Update status immediately to show \\\"running\\\"\\n        set(\\n          (currentState) => ({\\n            formPilotStatus: {\\n              ...currentState.formPilotStatus,\\n              lastRunAt: new Date().toISOString(),\\n              lastRunStatus: null, // null indicates running/in-progress\\n            },\\n          }),\\n          false,\\n          \\\"launchFormPilot\\\"\\n        );\\n      },\\n\\n      // Start analysis and generate questionnaire (Application workflow)\\n      startAnalysisAndGenerateQuestionnaire: async () => {\\n        const state = get();\\n\\n        // Get ready files (from reviewed groups, excluding unclassified)\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const readyFiles = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g)\\n        );\\n\\n        if (readyFiles.length === 0) {\\n          return;\\n        }\\n\\n        // Set analyzing phase\\n        set(\\n          {\\n            applicationPhase: \\\"analyzing\\\",\\n            isAnalyzingDocuments: true,\\n            analysisProgress: 0,\\n          },\\n          false,\\n          \\\"startAnalysisAndGenerateQuestionnaire\\\"\\n        );\\n\\n        // Simulate analysis with progress (includes Gap Analysis)\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 800));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`\\n          );\\n        }\\n\\n        // Generate analyzed files summary\\n        const analyzedFiles: AnalyzedFileSummary[] = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => ({\\n            id: f.id,\\n            name: f.name,\\n            groupTitle: g.title,\\n            pages: f.pages || 1,\\n            analyzedAt: new Date().toISOString(),\\n          }))\\n        );\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        // Mock passport extraction\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            return {\\n              applicationPhase: \\\"questionnaire\\\",\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: new Date().toISOString(),\\n              analyzedFileIds,\\n              analyzedFiles,\\n              clientProfile: newProfile,\\n              // Mark analyzed files in allFiles\\n              allFiles: (() => {\\n                const newAllFiles = { ...state.allFiles };\\n                const now = new Date().toISOString();\\n                for (const fileId of analyzedFileIds) {\\n                  const file = newAllFiles[fileId];\\n                  if (file) {\\n                    newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n                  }\\n                }\\n                return newAllFiles;\\n              })(),\\n            };\\n          },\\n          false,\\n          \\\"analysisAndQuestionnaireComplete\\\"\\n        );\\n      },\\n\\n      // Submit questionnaire answers and proceed to checklist\\n      submitQuestionnaireAnswers: (answers: Record<string, string>) => {\\n        const state = get();\\n\\n        // Get all currently reviewed file IDs to mark as analyzed\\n        const analyzedFileIds = state.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(state.allFiles, g).map((f) => f.id));\\n\\n        set(\\n          {\\n            questionnaireAnswers: answers,\\n            applicationPhase: \\\"checklist\\\",\\n            // Mark analysis as complete when questionnaire is submitted\\n            lastAnalysisAt: new Date().toISOString(),\\n            // Track which files were analyzed\\n            analyzedFileIds,\\n          },\\n          false,\\n          \\\"submitQuestionnaireAnswers\\\"\\n        );\\n        // First generate the base checklist items (mock data)\\n        get().generateChecklist();\\n        // Then convert to enhanced format with issues\\n        get().generateEnhancedChecklist();\\n      },\\n\\n      // Generate checklist with mock data and quality issues\\n      generateChecklist: () => {\\n        const state = get();\\n        const passport = state.clientProfile.passport;\\n\\n        // Get passport file ID from document groups\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFileId = passportGroup?.fileIds[0]\\n          ? (state.allFiles[passportGroup.fileIds[0]]?.id || \\\"pp_1\\\")\\n          : \\\"pp_1\\\";\\n\\n        // Mock checklist items based on UK Skilled Worker Visa requirements\\n        const mockChecklistItems: ApplicationChecklistItem[] = [\\n          // ==========================================\\n          // PERSONAL INFORMATION\\n          // ==========================================\\n          {\\n            id: \\\"given_names\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"givenNames\\\",\\n            label: \\\"Given Names\\\",\\n            value: passport?.givenNames || null,\\n            source: passport?.givenNames ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.givenNames ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"surname\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"surname\\\",\\n            label: \\\"Surname\\\",\\n            value: passport?.surname || null,\\n            source: passport?.surname ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.surname ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"dob\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"dateOfBirth\\\",\\n            label: \\\"Date of Birth\\\",\\n            value: passport?.dateOfBirth || null,\\n            source: passport?.dateOfBirth ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfBirth ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"place_of_birth\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"placeOfBirth\\\",\\n            label: \\\"Place of Birth\\\",\\n            value: passport?.countryOfBirth || \\\"Beijing, China\\\",\\n            source: passport?.countryOfBirth ? \\\"extracted\\\" : \\\"extracted\\\",\\n            linkedFileIds: [passportFileId],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"gender\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"gender\\\",\\n            label: \\\"Gender\\\",\\n            value: passport?.sex || null,\\n            source: passport?.sex ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.sex ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_number\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportNumber\\\",\\n            label: \\\"Passport Number\\\",\\n            value: passport?.passportNumber || null,\\n            source: passport?.passportNumber ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.passportNumber ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_issue_date\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportIssueDate\\\",\\n            label: \\\"Passport Issue Date\\\",\\n            value: passport?.dateOfIssue || null,\\n            source: passport?.dateOfIssue ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfIssue ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_expiry_date\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportExpiryDate\\\",\\n            label: \\\"Passport Expiry Date\\\",\\n            value: passport?.dateOfExpiry || null,\\n            source: passport?.dateOfExpiry ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfExpiry ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"nationality\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"nationality\\\",\\n            label: \\\"Nationality\\\",\\n            value: passport?.nationality || null,\\n            source: passport?.nationality ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.nationality ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"current_address\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"currentAddress\\\",\\n            label: \\\"Current Residential Address\\\",\\n            value: \\\"15 Maple Street, London SW1A 1AA\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"phone_number\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"phoneNumber\\\",\\n            label: \\\"Contact Phone Number\\\",\\n            value: \\\"+44 7700 900123\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"email_address\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"emailAddress\\\",\\n            label: \\\"Email Address\\\",\\n            value: \\\"john.smith@email.com\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"national_insurance\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"nationalInsurance\\\",\\n            label: \\\"National Insurance Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"biometric_residence_permit\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"biometricResidencePermit\\\",\\n            label: \\\"Previous BRP Number (if applicable)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // EMPLOYMENT DETAILS\\n          // ==========================================\\n          {\\n            id: \\\"cos_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosNumber\\\",\\n            label: \\\"Certificate of Sponsorship (CoS) Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_name\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorName\\\",\\n            label: \\\"Sponsor Name\\\",\\n            value: \\\"ACME Technology Ltd\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_license_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorLicenseNumber\\\",\\n            label: \\\"Sponsor License Number\\\",\\n            value: \\\"A1B2C3D4E5F6\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_address\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorAddress\\\",\\n            label: \\\"Sponsor Address\\\",\\n            value: \\\"100 Tech Park, Cambridge CB1 2AB\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"job_title\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"jobTitle\\\",\\n            label: \\\"Job Title\\\",\\n            value: \\\"Senior Software Engineer\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"soc_code\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"socCode\\\",\\n            label: \\\"SOC Code\\\",\\n            value: \\\"2136\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"salary\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"annualSalary\\\",\\n            label: \\\"Annual Salary (GBP)\\\",\\n            value: \\\"£65,000\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"employment_start_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"employmentStartDate\\\",\\n            label: \\\"Employment Start Date\\\",\\n            value: \\\"2024-04-01\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"working_hours\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"workingHoursPerWeek\\\",\\n            label: \\\"Working Hours per Week\\\",\\n            value: \\\"37.5\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"work_address\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"workAddress\\\",\\n            label: \\\"Work Location Address\\\",\\n            value: \\\"100 Tech Park, Cambridge CB1 2AB\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cos_assigned_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosAssignedDate\\\",\\n            label: \\\"CoS Assigned Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cos_expiry_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosExpiryDate\\\",\\n            label: \\\"CoS Expiry Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"shortage_occupation\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"shortageOccupation\\\",\\n            label: \\\"Is Role on Shortage Occupation List?\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n\\n          // ==========================================\\n          // FINANCIAL EVIDENCE\\n          // ==========================================\\n          {\\n            id: \\\"bank_account_holder\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankAccountHolder\\\",\\n            label: \\\"Bank Account Holder Name\\\",\\n            value: passport?.givenNames && passport?.surname ? `${passport.givenNames} ${passport.surname}` : null,\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: passport?.givenNames ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"bank_name\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankName\\\",\\n            label: \\\"Bank Name\\\",\\n            value: \\\"HSBC UK\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"account_number\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"accountNumber\\\",\\n            label: \\\"Account Number (Last 4 digits)\\\",\\n            value: \\\"****4521\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"bank_balance\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankBalance\\\",\\n            label: \\\"Current Balance\\\",\\n            value: \\\"£28,450.00\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"funds_held_period\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"fundsHeldPeriod\\\",\\n            label: \\\"Funds Held for 28 Consecutive Days\\\",\\n            value: \\\"Yes - Verified\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"statement_date\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"statementDate\\\",\\n            label: \\\"Bank Statement Date\\\",\\n            value: \\\"2024-01-15\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"maintenance_requirement\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"maintenanceRequirement\\\",\\n            label: \\\"Maintenance Requirement Met (£1,270)\\\",\\n            value: \\\"Yes\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"additional_funds_source\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"additionalFundsSource\\\",\\n            label: \\\"Source of Additional Funds\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"sponsor_maintenance_cert\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"sponsorMaintenanceCert\\\",\\n            label: \\\"Sponsor Maintenance Certification\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // TRAVEL HISTORY\\n          // ==========================================\\n          {\\n            id: \\\"previous_uk_visa\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"previousUKVisa\\\",\\n            label: \\\"Previous UK Visa History\\\",\\n            value: \\\"Tier 4 Student Visa (2015-2018)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [passportFileId],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"current_immigration_status\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"currentImmigrationStatus\\\",\\n            label: \\\"Current Immigration Status\\\",\\n            value: \\\"Outside UK\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"travel_history_10_years\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"travelHistory10Years\\\",\\n            label: \\\"Countries Visited (Last 10 Years)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"partial\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"visa_refusals\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"visaRefusals\\\",\\n            label: \\\"Previous Visa Refusals\\\",\\n            value: \\\"None\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"deportation_history\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"deportationHistory\\\",\\n            label: \\\"Deportation or Removal History\\\",\\n            value: \\\"None\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"criminal_convictions\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"criminalConvictions\\\",\\n            label: \\\"Criminal Convictions\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"uk_address_history\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"ukAddressHistory\\\",\\n            label: \\\"UK Address History (Last 5 Years)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // EDUCATION & QUALIFICATIONS\\n          // ==========================================\\n          {\\n            id: \\\"highest_qualification\\\",\\n            section: \\\"education\\\",\\n            field: \\\"highestQualification\\\",\\n            label: \\\"Highest Qualification\\\",\\n            value: \\\"BSc Computer Science\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"institution_name\\\",\\n            section: \\\"education\\\",\\n            field: \\\"institutionName\\\",\\n            label: \\\"Institution Name\\\",\\n            value: \\\"University of Manchester\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"graduation_date\\\",\\n            section: \\\"education\\\",\\n            field: \\\"graduationDate\\\",\\n            label: \\\"Graduation Date\\\",\\n            value: \\\"July 2018\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"english_test_type\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestType\\\",\\n            label: \\\"English Language Test Type\\\",\\n            value: \\\"IELTS Academic\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_score\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestScore\\\",\\n            label: \\\"English Test Score\\\",\\n            value: \\\"Overall 7.5 (L:8.0, R:7.5, W:7.0, S:7.5)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_date\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestDate\\\",\\n            label: \\\"English Test Date\\\",\\n            value: \\\"2023-06-15\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cefr_level\\\",\\n            section: \\\"education\\\",\\n            field: \\\"cefrLevel\\\",\\n            label: \\\"CEFR Level\\\",\\n            value: \\\"B1 (Minimum Required)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_reference\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestReference\\\",\\n            label: \\\"English Test Reference Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"atas_certificate\\\",\\n            section: \\\"education\\\",\\n            field: \\\"atasCertificate\\\",\\n            label: \\\"ATAS Certificate (if applicable)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // FAMILY INFORMATION\\n          // ==========================================\\n          {\\n            id: \\\"marital_status\\\",\\n            section: \\\"family\\\",\\n            field: \\\"maritalStatus\\\",\\n            label: \\\"Marital Status\\\",\\n            value: \\\"Married\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"spouse_name\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spouseName\\\",\\n            label: \\\"Spouse Full Name\\\",\\n            value: \\\"Jane Smith\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"spouse_nationality\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spouseNationality\\\",\\n            label: \\\"Spouse Nationality\\\",\\n            value: \\\"Chinese\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"dependants_count\\\",\\n            section: \\\"family\\\",\\n            field: \\\"dependantsCount\\\",\\n            label: \\\"Number of Dependants\\\",\\n            value: \\\"1 (Spouse applying separately)\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"children_count\\\",\\n            section: \\\"family\\\",\\n            field: \\\"childrenCount\\\",\\n            label: \\\"Number of Children\\\",\\n            value: \\\"0\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"spouse_passport_number\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spousePassportNumber\\\",\\n            label: \\\"Spouse Passport Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"marriage_certificate_date\\\",\\n            section: \\\"family\\\",\\n            field: \\\"marriageCertificateDate\\\",\\n            label: \\\"Marriage Certificate Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"family_members_in_uk\\\",\\n            section: \\\"family\\\",\\n            field: \\\"familyMembersInUK\\\",\\n            label: \\\"Other Family Members in UK\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n        ];\\n\\n        // Mock quality issues based on common Skilled Worker visa issues\\n        const mockQualityIssues: QualityIssue[] = [\\n          {\\n            id: \\\"issue_cos\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"CoS Number Required\\\",\\n            description: \\\"Certificate of Sponsorship number is missing. This is mandatory for Skilled Worker visa applications. Please obtain from your sponsor.\\\",\\n            linkedChecklistItemId: \\\"cos_number\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_cos_dates\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"CoS Dates Required\\\",\\n            description: \\\"CoS assigned date and expiry date are missing. These are required to verify the validity of your sponsorship.\\\",\\n            linkedChecklistItemId: \\\"cos_assigned_date\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_travel_history\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"warning\\\",\\n            title: \\\"Incomplete Travel History\\\",\\n            description: \\\"Travel history for the last 10 years is incomplete. UKVI requires full travel history including all countries visited.\\\",\\n            linkedChecklistItemId: \\\"travel_history_10_years\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_criminal_check\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"Criminal Convictions Declaration Required\\\",\\n            description: \\\"You must declare any criminal convictions. This is a mandatory question on the visa application form.\\\",\\n            linkedChecklistItemId: \\\"criminal_convictions\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_english_ref\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"warning\\\",\\n            title: \\\"English Test Reference Number\\\",\\n            description: \\\"The reference number for your English language test is required for verification with the test provider.\\\",\\n            linkedChecklistItemId: \\\"english_test_reference\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_passport_validity\\\",\\n            type: \\\"validity\\\",\\n            severity: \\\"info\\\",\\n            title: \\\"Passport Validity Check\\\",\\n            description: \\\"Ensure passport is valid for the duration of intended stay. Recommended to have at least 6 months validity beyond visa end date.\\\",\\n            linkedChecklistItemId: \\\"passport_expiry_date\\\",\\n            linkedFileId: passportFileId,\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_shortage\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"info\\\",\\n            title: \\\"Shortage Occupation Status\\\",\\n            description: \\\"Please confirm whether your role is on the Shortage Occupation List, as this affects salary threshold requirements.\\\",\\n            linkedChecklistItemId: \\\"shortage_occupation\\\",\\n            isResolved: false,\\n          },\\n        ];\\n\\n        set(\\n          {\\n            applicationPhase: \\\"checklist\\\",\\n            applicationChecklistItems: mockChecklistItems,\\n            qualityIssues: mockQualityIssues,\\n          },\\n          false,\\n          \\\"generateChecklist\\\"\\n        );\\n\\n        // Also generate enhanced checklist for the new workspace UI\\n        get().generateEnhancedChecklist();\\n      },\\n\\n      // Update a checklist field value\\n      updateChecklistField: (fieldId: string, value: string) => {\\n        set(\\n          (state) => ({\\n            applicationChecklistItems: state.applicationChecklistItems.map((item) =>\\n              item.id === fieldId\\n                ? {\\n                    ...item,\\n                    value,\\n                    source: \\\"manual\\\",\\n                    status: value ? \\\"complete\\\" : \\\"missing\\\",\\n                  }\\n                : item\\n            ),\\n          }),\\n          false,\\n          \\\"updateChecklistField\\\"\\n        );\\n      },\\n\\n      // Resolve a quality issue\\n      resolveIssue: (issueId: string) => {\\n        set(\\n          (state) => ({\\n            qualityIssues: state.qualityIssues.map((issue) =>\\n              issue.id === issueId ? { ...issue, isResolved: true } : issue\\n            ),\\n          }),\\n          false,\\n          \\\"resolveIssue\\\"\\n        );\\n      },\\n\\n      // Go back to a previous phase\\n      goBackToPhase: (phase: ApplicationPhase) => {\\n        set({ applicationPhase: phase }, false, \\\"goBackToPhase\\\");\\n      },\\n\\n      // Toggle checklist section expansion\\n      toggleChecklistSection: (sectionId: ChecklistSectionType) => {\\n        set(\\n          (state) => ({\\n            checklistSectionExpanded: {\\n              ...state.checklistSectionExpanded,\\n              [sectionId]: !state.checklistSectionExpanded[sectionId],\\n            },\\n          }),\\n          false,\\n          \\\"toggleChecklistSection\\\"\\n        );\\n      },\\n\\n      // ============================================\\n      // Enhanced Checklist Workspace Actions\\n      // ============================================\\n\\n      // Select a checklist item (for detail panel)\\n      selectChecklistItem: (itemId: string | null) => {\\n        set({ selectedChecklistItemId: itemId }, false, \\\"selectChecklistItem\\\");\\n      },\\n\\n      // Select an issue (for detail view)\\n      selectIssue: (issueId: string | null) => {\\n        set({ selectedIssueId: issueId }, false, \\\"selectIssue\\\");\\n      },\\n\\n      // Update enhanced checklist field value\\n      updateEnhancedChecklistField: (fieldId: string, value: string) => {\\n        set(\\n          (state) => ({\\n            enhancedChecklistItems: state.enhancedChecklistItems.map((item) =>\\n              item.id === fieldId\\n                ? {\\n                    ...item,\\n                    value,\\n                    source: \\\"manual\\\" as const,\\n                    status: value ? \\\"complete\\\" as const : \\\"missing\\\" as const,\\n                  }\\n                : item\\n            ),\\n          }),\\n          false,\\n          \\\"updateEnhancedChecklistField\\\"\\n        );\\n      },\\n\\n      // Update issue status\\n      updateIssueStatus: (issueId: string, status: IssueStatus) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"status_changed\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                previousStatus: issue.status,\\n                newStatus: status,\\n              };\\n              return {\\n                ...issue,\\n                status,\\n                updatedAt: new Date().toISOString(),\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"updateIssueStatus\\\"\\n        );\\n      },\\n\\n      // Add a note to an issue\\n      addIssueNote: (issueId: string, note: string) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"note_added\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: note,\\n              };\\n              return {\\n                ...issue,\\n                updatedAt: new Date().toISOString(),\\n                notes: [\\n                  ...issue.notes,\\n                  {\\n                    id: `note_${Date.now()}`,\\n                    content: note,\\n                    createdAt: new Date().toISOString(),\\n                    createdBy: { id: currentUser.id, name: currentUser.name },\\n                  },\\n                ],\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"addIssueNote\\\"\\n        );\\n      },\\n\\n      // Forward issue to client\\n      forwardIssueToClient: (issueId: string, data: ForwardToClientData) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"forwarded\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: data.method === \\\"email\\\"\\n                  ? `Forwarded via email to ${data.recipientEmail}`\\n                  : \\\"Shareable link generated\\\",\\n              };\\n              return {\\n                ...issue,\\n                status: \\\"forwarded\\\" as IssueStatus,\\n                updatedAt: new Date().toISOString(),\\n                forwardData: data,\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n            forwardModalOpen: false,\\n            forwardModalIssueId: null,\\n          }),\\n          false,\\n          \\\"forwardIssueToClient\\\"\\n        );\\n      },\\n\\n      // Mark issue as resolved\\n      markIssueResolved: (issueId: string, resolution?: string) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"resolved\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: resolution,\\n                previousStatus: issue.status,\\n                newStatus: \\\"resolved\\\",\\n              };\\n              return {\\n                ...issue,\\n                status: \\\"resolved\\\" as IssueStatus,\\n                updatedAt: new Date().toISOString(),\\n                resolvedAt: new Date().toISOString(),\\n                resolvedBy: { id: currentUser.id, name: currentUser.name },\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"markIssueResolved\\\"\\n        );\\n      },\\n\\n      // Open forward modal\\n      openForwardModal: (issueId: string) => {\\n        set(\\n          { forwardModalOpen: true, forwardModalIssueId: issueId },\\n          false,\\n          \\\"openForwardModal\\\"\\n        );\\n      },\\n\\n      // Close forward modal\\n      closeForwardModal: () => {\\n        set(\\n          { forwardModalOpen: false, forwardModalIssueId: null },\\n          false,\\n          \\\"closeForwardModal\\\"\\n        );\\n      },\\n\\n      // Generate enhanced checklist with linked documents and issues\\n      generateEnhancedChecklist: () => {\\n        const state = get();\\n        const currentUser = SYSTEM_USERS[0];\\n\\n        // Create linked documents from analyzed files\\n        const createLinkedDocument = (fileId: string): LinkedDocument | null => {\\n          const file = state.allFiles[fileId];\\n          if (!file || file.isRemoved) return null;\\n          // Find the group this file belongs to\\n          const group = state.documentGroups.find((g) =>\\n            g.fileIds.includes(fileId)\\n          );\\n          return {\\n            fileId: file.id,\\n            fileName: file.name,\\n            groupTitle: group?.title || \\\"Unknown\\\",\\n            pageNumbers: [1], // Mock page number\\n            extractedText: `Extracted from ${file.name}`,\\n          };\\n        };\\n\\n        // Evidence ID → Document Group ID mapping for auto-linking\\n        const EVIDENCE_GROUP_MAP: Record<string, string> = {\\n          ev_passport: \\\"passport\\\",\\n          ev_bank_statements: \\\"bank_statement\\\",\\n          ev_payslip: \\\"bank_statement\\\", // payslip may be in same group\\n          ev_employment_contract: \\\"employment_letter\\\",\\n          ev_travel_history: \\\"travel_history\\\",\\n          ev_english_cert: \\\"education\\\",\\n          ev_degree_cert: \\\"education\\\",\\n        };\\n\\n        // Auto-link evidence to existing document groups\\n        const autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\\n          const groupId = EVIDENCE_GROUP_MAP[ev.id];\\n          if (!groupId) return ev;\\n          const group = state.documentGroups.find(g => g.id === groupId);\\n          if (!group || group.fileIds.length === 0) return ev;\\n          return {\\n            ...ev,\\n            isUploaded: true,\\n            linkedFileId: group.id,\\n            linkedFileName: group.title,\\n          };\\n        };\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\\n            {\\n              id: \\\"ev_photo\\\",\\n              name: \\\"Passport-sized Photograph\\\",\\n              description: \\\"Recent photo meeting UK visa photo requirements (45mm x 35mm)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"JPEG\\\", \\\"PNG\\\"],\\n            },\\n            {\\n              id: \\\"ev_previous_passport\\\",\\n              name: \\\"Previous Passports (if applicable)\\\",\\n              description: \\\"Any previous passports showing UK immigration history\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          employment: [\\n            {\\n              id: \\\"ev_cos\\\",\\n              name: \\\"Certificate of Sponsorship (CoS)\\\",\\n              description: \\\"CoS reference number from licensed UK sponsor\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n            },\\n            {\\n              id: \\\"ev_employment_contract\\\",\\n              name: \\\"Employment Contract / Job Offer Letter\\\",\\n              description: \\\"Signed contract showing job title, salary, and start date\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_sponsor_letter\\\",\\n              name: \\\"Sponsor Confirmation Letter\\\",\\n              description: \\\"Letter from sponsor confirming employment details\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          financial: [\\n            {\\n              id: \\\"ev_bank_statements\\\",\\n              name: \\\"Bank Statements (28 days)\\\",\\n              description: \\\"Showing funds held for 28 consecutive days ending within 31 days of application\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be dated within 31 days of application\\\",\\n            },\\n            {\\n              id: \\\"ev_payslip\\\",\\n              name: \\\"Payslip\\\",\\n              description: \\\"Recent payslips showing salary payments (last 3 months recommended)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          travel: [\\n            {\\n              id: \\\"ev_travel_history\\\",\\n              name: \\\"Travel History Documentation\\\",\\n              description: \\\"Evidence of travel history for last 10 years (passport stamps, boarding passes)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n            {\\n              id: \\\"ev_old_visas\\\",\\n              name: \\\"Previous UK Visas (if any)\\\",\\n              description: \\\"Copies of any previous UK visas or BRPs\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          education: [\\n            {\\n              id: \\\"ev_english_cert\\\",\\n              name: \\\"English Language Test Certificate\\\",\\n              description: \\\"IELTS, TOEFL, or approved SELT certificate (CEFR B1 minimum)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be within 2 years of application date\\\",\\n            },\\n            {\\n              id: \\\"ev_degree_cert\\\",\\n              name: \\\"Degree Certificate / Academic Qualification\\\",\\n              description: \\\"Original or certified copy of highest qualification\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_atas\\\",\\n              name: \\\"ATAS Certificate (if applicable)\\\",\\n              description: \\\"Academic Technology Approval Scheme certificate for certain fields\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          family: [\\n            {\\n              id: \\\"ev_marriage_cert\\\",\\n              name: \\\"Marriage Certificate (if applicable)\\\",\\n              description: \\\"Official marriage certificate if applying with spouse\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_birth_cert\\\",\\n              name: \\\"Birth Certificates (if applicable)\\\",\\n              description: \\\"For any dependent children\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          other: [],\\n        };\\n\\n        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\\n\\n        // Convert existing checklist items to enhanced format\\n        const enhancedItems: EnhancedChecklistItem[] = state.applicationChecklistItems.map((item) => ({\\n          id: item.id,\\n          section: item.section,\\n          field: item.field,\\n          label: item.label,\\n          value: item.value,\\n          source: item.source,\\n          linkedDocuments: item.linkedFileIds\\n            .map(createLinkedDocument)\\n            .filter((doc): doc is LinkedDocument => doc !== null),\\n          requiredEvidence: getRequiredEvidence(item.section),\\n          status: item.status,\\n          isRequired: item.isRequired,\\n          isEditable: true,\\n          confidenceScore: item.source === \\\"extracted\\\" ? 95 : undefined,\\n        }));\\n\\n        // Convert existing quality issues to enhanced format\\n        const existingEnhancedIssues: EnhancedQualityIssue[] = state.qualityIssues.map((issue) => ({\\n          id: issue.id,\\n          type: issue.type,\\n          severity: issue.severity,\\n          status: issue.isResolved ? \\\"resolved\\\" as IssueStatus : \\\"open\\\" as IssueStatus,\\n          title: issue.title,\\n          description: issue.description,\\n          linkedChecklistItemId: issue.linkedChecklistItemId,\\n          linkedFileIds: issue.linkedFileId ? [issue.linkedFileId] : [],\\n          history: [\\n            {\\n              id: `history_${issue.id}_created`,\\n              timestamp: new Date().toISOString(),\\n              action: \\\"created\\\" as const,\\n              performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n            },\\n          ],\\n          notes: [],\\n          createdAt: new Date().toISOString(),\\n          updatedAt: new Date().toISOString(),\\n        }));\\n\\n        // Generate issues for missing fields (checklist items with status \\\"missing\\\")\\n        const missingFieldIssues: EnhancedQualityIssue[] = enhancedItems\\n          .filter((item) => item.status === \\\"missing\\\" && item.isRequired)\\n          .map((item) => ({\\n            id: `issue_missing_field_${item.id}`,\\n            type: \\\"missing\\\" as QualityIssueType,\\n            severity: \\\"warning\\\" as QualityIssueSeverity,\\n            status: \\\"open\\\" as IssueStatus,\\n            title: `Missing: ${item.label}`,\\n            description: `The field \\\"${item.label}\\\" is required but has not been provided. Please fill in this information or upload supporting documents.`,\\n            linkedChecklistItemId: item.id,\\n            linkedFileIds: [],\\n            history: [\\n              {\\n                id: `history_missing_field_${item.id}_created`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"created\\\" as const,\\n                performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n              },\\n            ],\\n            notes: [],\\n            createdAt: new Date().toISOString(),\\n            updatedAt: new Date().toISOString(),\\n          }));\\n\\n        // Generate issues for missing required evidence\\n        const allRequiredEvidence = Object.values(SECTION_REQUIRED_EVIDENCE).flat();\\n        const missingEvidenceIssues: EnhancedQualityIssue[] = allRequiredEvidence\\n          .filter((ev) => ev.isMandatory && !ev.isUploaded)\\n          .map((ev) => {\\n            // Find a related checklist item in the same section\\n            const sectionType = Object.entries(SECTION_REQUIRED_EVIDENCE)\\n              .find(([, evidenceList]) => evidenceList.some((e) => e.id === ev.id))?.[0] as ChecklistSectionType | undefined;\\n            const relatedItem = enhancedItems.find((item) => item.section === sectionType);\\n\\n            return {\\n              id: `issue_missing_evidence_${ev.id}`,\\n              type: \\\"missing\\\" as QualityIssueType,\\n              severity: \\\"error\\\" as QualityIssueSeverity,\\n              status: \\\"open\\\" as IssueStatus,\\n              title: `Missing Document: ${ev.name}`,\\n              description: ev.description || `The document \\\"${ev.name}\\\" is required but has not been uploaded.`,\\n              suggestedAction: \\\"Upload the required document\\\",\\n              linkedChecklistItemId: relatedItem?.id || enhancedItems[0]?.id || \\\"\\\",\\n              linkedFileIds: [],\\n              history: [\\n                {\\n                  id: `history_missing_evidence_${ev.id}_created`,\\n                  timestamp: new Date().toISOString(),\\n                  action: \\\"created\\\" as const,\\n                  performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n                },\\n              ],\\n              notes: [],\\n              createdAt: new Date().toISOString(),\\n              updatedAt: new Date().toISOString(),\\n            };\\n          });\\n\\n        // Combine all issues (filter out duplicates by checking if similar issue exists)\\n        const existingIssueIds = new Set(existingEnhancedIssues.map((i) => i.linkedChecklistItemId));\\n        const filteredMissingFieldIssues = missingFieldIssues.filter(\\n          (i) => !existingIssueIds.has(i.linkedChecklistItemId)\\n        );\\n\\n        const enhancedIssues: EnhancedQualityIssue[] = [\\n          ...existingEnhancedIssues,\\n          ...filteredMissingFieldIssues,\\n          ...missingEvidenceIssues,\\n        ];\\n\\n        set(\\n          {\\n            enhancedChecklistItems: enhancedItems,\\n            enhancedQualityIssues: enhancedIssues,\\n            // Auto-select first item if available\\n            selectedChecklistItemId: enhancedItems.length > 0 ? enhancedItems[0].id : null,\\n          },\\n          false,\\n          \\\"generateEnhancedChecklist\\\"\\n        );\\n      },\\n\\n      // Initialize case from CreateCaseModal data\\n      // Passport is parsed immediately at case creation (not dependent on analysis)\\n      // Case Notes is auto-confirmed, Passport requires confirm review\\n      initializeCaseFromCreation: (data: {\\n        visaType: VisaType;\\n        passport: PassportInfo;\\n        caseNotesFileName: string;\\n        passportFileName: string;\\n        referenceNumber?: string;\\n        advisorId?: string;\\n        assistantId?: string;\\n      }) => {\\n        // Mock case notes summary (would be extracted from uploaded case notes)\\n        const mockCaseNotesSummary: CaseNotesSummary = {\\n          summary: \\\"Client seeking Skilled Worker visa for a Senior Software Engineer position at ACME Technology Ltd. Has previous UK visa history (Tier 4 Student, 2015-2018). Strong financial background with verified savings. Main concern is ensuring CoS documentation is complete.\\\",\\n          clientBackground: \\\"British national currently residing in London. Has worked in tech industry for 8+ years.\\\",\\n          keyDates: [\\\"CoS expected: Feb 2024\\\", \\\"Target application: Mar 2024\\\"],\\n          extractedAt: new Date().toISOString(),\\n        };\\n\\n        // Create files for allFiles store\\n        const caseNotesFileId = `cn_${Date.now()}`;\\n        const passportFileId = `pp_${Date.now()}`;\\n\\n        const newAllFiles: Record<string, DocumentFile> = {\\n          [caseNotesFileId]: {\\n            id: caseNotesFileId,\\n            name: data.caseNotesFileName,\\n            size: \\\"1.2 MB\\\",\\n            pages: 5,\\n            date: \\\"Just now\\\",\\n            type: \\\"pdf\\\",\\n            isNew: false, // Not marked as new since it's auto-confirmed\\n            containerIds: [\\\"case_notes\\\"],\\n          },\\n          [passportFileId]: {\\n            id: passportFileId,\\n            name: data.passportFileName,\\n            size: \\\"0.8 MB\\\",\\n            pages: 1,\\n            date: \\\"Just now\\\",\\n            type: \\\"pdf\\\",\\n            isNew: true,\\n            containerIds: [\\\"passport\\\"],\\n          },\\n        };\\n\\n        // Create document groups - case notes is special (auto-confirmed), passport requires review\\n        const caseNotesGroup: DocumentGroup = {\\n          id: \\\"case_notes\\\",\\n          title: \\\"Case Notes\\\",\\n          tag: \\\"Case Notes\\\",\\n          mergedFileName: data.caseNotesFileName,\\n          status: \\\"reviewed\\\", // Auto-confirmed, no review needed\\n          isSpecial: true, // Special document - doesn't require manual review\\n          fileIds: [caseNotesFileId],\\n          files: [],\\n        };\\n\\n        // Passport document requires confirm review (not isSpecial)\\n        const passportGroup: DocumentGroup = {\\n          id: \\\"passport\\\",\\n          title: \\\"Passport\\\",\\n          tag: \\\"Passport\\\",\\n          mergedFileName: data.passportFileName,\\n          status: \\\"pending\\\", // Requires confirm review\\n          fileIds: [passportFileId],\\n          files: [],\\n        };\\n\\n        // Create empty unclassified group for future uploads\\n        const unclassifiedGroup: DocumentGroup = {\\n          id: \\\"unclassified\\\",\\n          title: \\\"Unclassified\\\",\\n          tag: \\\"unclassified\\\",\\n          status: \\\"pending\\\",\\n          fileIds: [],\\n          files: [],\\n        };\\n\\n        // Client profile includes passport data parsed at creation time\\n        // Passport parsing is immediate, not dependent on analysis\\n        const profileWithPassport = {\\n          passport: data.passport,\\n          completeness: 0,\\n        };\\n        profileWithPassport.completeness = calculateCompleteness(profileWithPassport);\\n\\n        const documentGroups = [unclassifiedGroup, caseNotesGroup, passportGroup];\\n        const previews = syncFilePreviewsFromState(newAllFiles, documentGroups);\\n\\n        set(\\n          {\\n            // Navigation - land on overview page\\n            activeNav: \\\"overview\\\",\\n            selectedVisaType: data.visaType,\\n            clientProfile: profileWithPassport,\\n            caseReference: data.referenceNumber || \\\"REF-2024-001\\\",\\n            caseNotesSummary: mockCaseNotesSummary,\\n            allFiles: newAllFiles,\\n            documentGroups,\\n            uploadedFilePreviews: previews,\\n            // Reset analysis state\\n            lastAnalysisAt: null,\\n            analyzedFileIds: [],\\n            analyzedFiles: [],\\n            isAnalyzingDocuments: false,\\n            analysisProgress: 0,\\n            // Reset questionnaire to trigger case assessment form\\n            questionnaireAnswers: {},\\n            // Reset application phase to analyzing (ready to start analysis)\\n            applicationPhase: \\\"analyzing\\\",\\n            formSchema: null,\\n          },\\n          false,\\n          \\\"initializeCaseFromCreation\\\"\\n        );\\n\\n        // Initialize form schema for the selected visa type\\n        get().initFormSchema(data.visaType);\\n\\n        // Evolve checklist based on new data\\n        get().evolveChecklist();\\n      },\\n\\n      // Reset\\n      reset: () => {\\n        set(initialState, false, \\\"reset\\\");\\n      },\\n    }),\\n    { name: \\\"case-detail-store\\\" },\\n  ),\\n);\\n\\n// Selector hooks for optimized re-renders\\nexport const useActiveNav = () =>\\n  useCaseDetailStore((state) => state.activeNav);\\nexport const useHighlightedGroupId = () =>\\n  useCaseDetailStore((state) => state.highlightedGroupId);\\nexport const useClientProfile = () =>\\n  useCaseDetailStore((state) => state.clientProfile);\\nexport const useCaseNotesSummary = () =>\\n  useCaseDetailStore((state) => state.caseNotesSummary);\\nexport const useSelectedVisaType = () =>\\n  useCaseDetailStore((state) => state.selectedVisaType);\\nexport const useChecklist = () =>\\n  useCaseDetailStore((state) => state.checklist);\\nexport const useChecklistStage = () =>\\n  useCaseDetailStore((state) => state.checklist.stage);\\n// Returns document groups with files resolved from allFiles (backward compatible)\\n// UI components can access group.files directly\\n// Uses separate subscriptions + useMemo to avoid infinite re-render loops\\nexport const useDocumentGroups = () => {\\n  const groups = useCaseDetailStore((state) => state.documentGroups);\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(\\n    () =>\\n      groups.map((group) => ({\\n        ...group,\\n        files: group.fileIds\\n          .map((id) => allFiles[id])\\n          .filter((f): f is DocumentFile => f !== undefined),\\n      })),\\n    [groups, allFiles]\\n  );\\n};\\nexport const useIsLoadingDocuments = () =>\\n  useCaseDetailStore((state) => state.isLoadingDocuments);\\nexport const useUploadedFilePreviews = () =>\\n  useCaseDetailStore((state) => state.uploadedFilePreviews);\\nexport const useApplicationPhase = () =>\\n  useCaseDetailStore((state) => state.applicationPhase);\\nexport const useFormSchema = () =>\\n  useCaseDetailStore((state) => state.formSchema);\\nexport const useFormPilotStatus = () =>\\n  useCaseDetailStore((state) => state.formPilotStatus);\\nexport const useAnalyzedFiles = () =>\\n  useCaseDetailStore((state) => state.analyzedFiles);\\nexport const useApplicationChecklistItems = () =>\\n  useCaseDetailStore((state) => state.applicationChecklistItems);\\nexport const useQualityIssues = () =>\\n  useCaseDetailStore((state) => state.qualityIssues);\\nexport const useQuestionnaireAnswers = () =>\\n  useCaseDetailStore((state) => state.questionnaireAnswers);\\nexport const useChecklistSectionExpanded = () =>\\n  useCaseDetailStore((state) => state.checklistSectionExpanded);\\n\\n// Enhanced Checklist Workspace Selectors\\nexport const useEnhancedChecklistItems = () =>\\n  useCaseDetailStore((state) => state.enhancedChecklistItems);\\nexport const useEnhancedQualityIssues = () =>\\n  useCaseDetailStore((state) => state.enhancedQualityIssues);\\nexport const useSelectedChecklistItemId = () =>\\n  useCaseDetailStore((state) => state.selectedChecklistItemId);\\nexport const useSelectedIssueId = () =>\\n  useCaseDetailStore((state) => state.selectedIssueId);\\nexport const useForwardModalOpen = () =>\\n  useCaseDetailStore((state) => state.forwardModalOpen);\\nexport const useForwardModalIssueId = () =>\\n  useCaseDetailStore((state) => state.forwardModalIssueId);\\n\\n// Get selected checklist item with its issues\\nexport const useSelectedChecklistItem = () =>\\n  useCaseDetailStore((state) => {\\n    if (!state.selectedChecklistItemId) return null;\\n    return state.enhancedChecklistItems.find(\\n      (item) => item.id === state.selectedChecklistItemId\\n    ) || null;\\n  });\\n\\n// Get issues for selected checklist item - memoized to prevent infinite loops\\nexport const useIssuesForSelectedItem = () => {\\n  const selectedChecklistItemId = useCaseDetailStore(\\n    (state) => state.selectedChecklistItemId\\n  );\\n  const enhancedQualityIssues = useCaseDetailStore(\\n    (state) => state.enhancedQualityIssues\\n  );\\n\\n  return useMemo(() => {\\n    if (!selectedChecklistItemId) return [];\\n    return enhancedQualityIssues.filter(\\n      (issue) => issue.linkedChecklistItemId === selectedChecklistItemId\\n    );\\n  }, [selectedChecklistItemId, enhancedQualityIssues]);\\n};\\n\\n// Get issue counts by severity - memoized to prevent infinite loops\\nexport const useIssueCounts = () => {\\n  const enhancedQualityIssues = useCaseDetailStore(\\n    (state) => state.enhancedQualityIssues\\n  );\\n\\n  return useMemo(() => {\\n    const issues = enhancedQualityIssues.filter(\\n      (issue) => issue.status !== \\\"resolved\\\"\\n    );\\n    return {\\n      errors: issues.filter((i) => i.severity === \\\"error\\\").length,\\n      warnings: issues.filter((i) => i.severity === \\\"warning\\\").length,\\n      info: issues.filter((i) => i.severity === \\\"info\\\").length,\\n      total: issues.length,\\n    };\\n  }, [enhancedQualityIssues]);\\n};\\n\\n// Selector to detect if there are new ready files since the last analysis\\n// Only triggers when NEW files are confirmed (ready), not when files become pending\\nexport const useHasNewFilesAfterAnalysis = () =>\\n  useCaseDetailStore((state) => {\\n    // Only check if analysis has been completed\\n    if (!state.lastAnalysisAt) return false;\\n\\n    // Get all file IDs from reviewed groups (excluding unclassified and removed)\\n    const currentReviewedFileIds = state.documentGroups\\n      .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n      .flatMap((g) => getContainerFiles(state.allFiles, g).map((f) => f.id));\\n\\n    const analyzedFileIds = state.analyzedFileIds;\\n\\n    // Only check for NEW ready files - files that are reviewed but weren't analyzed\\n    // Don't trigger for removals (e.g., when a group goes from reviewed to pending)\\n    const hasNewReadyFiles = currentReviewedFileIds.some(\\n      (id) => !analyzedFileIds.includes(id)\\n    );\\n\\n    return hasNewReadyFiles;\\n  });\\n\\n// Returns the count of new ready document groups that have unanalyzed files\\nexport const useNewFilesCount = () =>\\n  useCaseDetailStore((state) => {\\n    if (!state.lastAnalysisAt) return 0;\\n\\n    const analyzedFileIds = state.analyzedFileIds;\\n\\n    // Count document groups that have at least one new unanalyzed file\\n    const groupsWithNewFiles = state.documentGroups.filter((g) => {\\n      if (g.id === \\\"unclassified\\\" || g.status !== \\\"reviewed\\\") return false;\\n\\n      // Check if this group has any files that weren't analyzed\\n      const activeFiles = getContainerFiles(state.allFiles, g);\\n      return activeFiles.some((f) => !analyzedFileIds.includes(f.id));\\n    });\\n\\n    return groupsWithNewFiles.length;\\n  });\\n\\n// ============================================================================\\n// One-to-Many Model Selectors\\n// ============================================================================\\n\\n// Get all files from the central store\\nexport const useAllFiles = () =>\\n  useCaseDetailStore((state) => state.allFiles);\\n\\n// Get unclassified files (files with no container associations)\\nexport const useUnclassifiedFiles = () => {\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(\\n    () =>\\n      Object.values(allFiles).filter(\\n        (f) => !f.isRemoved && f.containerIds.length === 0\\n      ),\\n    [allFiles]\\n  );\\n};\\n\\n// Get files for a specific container/group\\nexport const useContainerFiles = (containerId: string) => {\\n  const groups = useCaseDetailStore((state) => state.documentGroups);\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(() => {\\n    const group = groups.find((g) => g.id === containerId);\\n    if (!group) return [];\\n    return group.fileIds\\n      .map((id) => allFiles[id])\\n      .filter((f): f is DocumentFile => f !== undefined && !f.isRemoved);\\n  }, [groups, allFiles, containerId]);\\n};\\n\\n// Get the number of containers a file is in (for showing linked badge)\\nexport const useFileContainerCount = (fileId: string) =>\\n  useCaseDetailStore((state) => {\\n    const file = state.allFiles[fileId];\\n    return file?.containerIds.length ?? 0;\\n  });\\n\\n// Check if a file is in multiple containers (shared/reused)\\nexport const useIsFileShared = (fileId: string) =>\\n  useCaseDetailStore((state) => {\\n    const file = state.allFiles[fileId];\\n    return (file?.containerIds.length ?? 0) > 1;\\n  });\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 4061,\n      \"oldLines\": 9,\n      \"newStart\": 4061,\n      \"newLines\": 9,\n      \"lines\": [\n        \"           other: [],\",\n        \"         };\",\n        \" \",\n        \"-        // Get required evidence for a section\",\n        \"+        // Get required evidence for a section (with auto-linking applied)\",\n        \"         const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\",\n        \"-          return SECTION_REQUIRED_EVIDENCE[section] || [];\",\n        \"+          return (SECTION_REQUIRED_EVIDENCE[section] || []).map(autoLinkEvidence);\",\n        \"         };\",\n        \" \",\n        \"         // Convert existing checklist items to enhanced format\"\n      ]\n    }\n  ],\n  \"userModified\": false,\n  \"replaceAll\": false\n}","timestamp":1769669183247,"toolName":"Edit","toolUseId":"toolu_01WGERLR3oahJanhzJJbubCH","toolInput":{"replace_all":false,"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts","old_string":"        // Get required evidence for a section\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\n        };","new_string":"        // Get required evidence for a section (with auto-linking applied)\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\n          return (SECTION_REQUIRED_EVIDENCE[section] || []).map(autoLinkEvidence);\n        };"},"toolResult":"{\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/store/case-detail-store.ts\",\n  \"oldString\": \"        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\",\n  \"newString\": \"        // Get required evidence for a section (with auto-linking applied)\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return (SECTION_REQUIRED_EVIDENCE[section] || []).map(autoLinkEvidence);\\n        };\",\n  \"originalFile\": \"import { useMemo } from \\\"react\\\";\\nimport { create } from \\\"zustand\\\";\\nimport { devtools } from \\\"zustand/middleware\\\";\\nimport {\\n  CaseDetailStore,\\n  CaseDetailState,\\n  CaseDetailNavItem,\\n  ChecklistStage,\\n  ChecklistItemStatus,\\n  UploadedFilePreview,\\n  QuestionnaireQuestion,\\n  ChecklistItem,\\n  DocumentGroup,\\n  DocumentFile,\\n  ApplicationPhase,\\n  FormSchemaStatus,\\n  FormPilotStatus,\\n  AnalyzedFileSummary,\\n  ApplicationChecklistItem,\\n  QualityIssue,\\n  QualityIssueType,\\n  QualityIssueSeverity,\\n  ChecklistSectionType,\\n  CaseNotesSummary,\\n  // Enhanced types for checklist workspace\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  IssueStatus,\\n  IssueHistoryEntry,\\n  ForwardToClientData,\\n  LinkedDocument,\\n  RequiredEvidence,\\n} from \\\"@/types/case-detail\\\";\\nimport { PassportInfo, VisaType } from \\\"@/types\\\";\\nimport { parseDocumentPath } from \\\"@/lib/document-path-parser\\\";\\n\\n// Old-style document group type (with files embedded) - for legacy data\\ninterface LegacyDocumentGroup {\\n  id: string;\\n  title: string;\\n  tag: string;\\n  mergedFileName?: string;\\n  status: \\\"pending\\\" | \\\"reviewed\\\";\\n  hasChanges?: boolean;\\n  files: Array<Omit<DocumentFile, 'containerIds'> & { containerIds?: string[] }>;\\n  isSpecial?: boolean;\\n  entityType?: DocumentFile['entityType'];\\n  generatedName?: string;\\n}\\n\\n// Initial document groups data - Rich mock data with many pages per category\\n// Uses legacy format (files embedded) - converted to new model when used\\nconst INITIAL_DOCUMENT_GROUPS_LEGACY: LegacyDocumentGroup[] = [\\n  {\\n    id: \\\"passport\\\",\\n    title: \\\"Passport\\\",\\n    tag: \\\"Passport\\\",\\n    mergedFileName: \\\"Passport_Combined.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"pp_1\\\",\\n        name: \\\"Passport_Cover.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_2\\\",\\n        name: \\\"Passport_Bio_Page.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_3\\\",\\n        name: \\\"Passport_Visa_Page_1.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_4\\\",\\n        name: \\\"Passport_Visa_Page_2.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_5\\\",\\n        name: \\\"Passport_Stamp_Page.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"pp_6\\\",\\n        name: \\\"Passport_Back_Cover.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"bank_statement\\\",\\n    title: \\\"Bank Statement\\\",\\n    tag: \\\"Bank Statement\\\",\\n    mergedFileName: \\\"BankStatement_6Months.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"bs_1\\\",\\n        name: \\\"Statement_Jan_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_2\\\",\\n        name: \\\"Statement_Jan_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_3\\\",\\n        name: \\\"Statement_Feb_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_4\\\",\\n        name: \\\"Statement_Feb_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_5\\\",\\n        name: \\\"Statement_Mar_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_6\\\",\\n        name: \\\"Statement_Mar_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_7\\\",\\n        name: \\\"Statement_Apr_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_8\\\",\\n        name: \\\"Statement_Apr_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_9\\\",\\n        name: \\\"Statement_May_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_10\\\",\\n        name: \\\"Statement_May_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_11\\\",\\n        name: \\\"Statement_Jun_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"bs_12\\\",\\n        name: \\\"Statement_Jun_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"employment_letter\\\",\\n    title: \\\"Employment Letter\\\",\\n    tag: \\\"Employment Letter\\\",\\n    mergedFileName: \\\"Employment_Verification.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"emp_1\\\",\\n        name: \\\"Employment_Letter_Page1.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_2\\\",\\n        name: \\\"Employment_Letter_Page2.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_3\\\",\\n        name: \\\"Salary_Slip_Jan.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_4\\\",\\n        name: \\\"Salary_Slip_Feb.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"emp_5\\\",\\n        name: \\\"Salary_Slip_Mar.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"utility_bill\\\",\\n    title: \\\"Utility Bill\\\",\\n    tag: \\\"Utility Bill\\\",\\n    mergedFileName: \\\"Utility_Bills_2024.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"ub_1\\\",\\n        name: \\\"Electric_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_2\\\",\\n        name: \\\"Electric_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_3\\\",\\n        name: \\\"Gas_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_4\\\",\\n        name: \\\"Gas_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_5\\\",\\n        name: \\\"Water_Bill_Q1.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_6\\\",\\n        name: \\\"Council_Tax_Bill.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_7\\\",\\n        name: \\\"Internet_Bill_Jan.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"ub_8\\\",\\n        name: \\\"Internet_Bill_Feb.pdf\\\",\\n        size: \\\"0.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"tax_documents\\\",\\n    title: \\\"Tax Documents\\\",\\n    tag: \\\"Tax Documents\\\",\\n    mergedFileName: \\\"Tax_Records_2023.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"tax_1\\\",\\n        name: \\\"P60_2023.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_2\\\",\\n        name: \\\"Tax_Return_Page1.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_3\\\",\\n        name: \\\"Tax_Return_Page2.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_4\\\",\\n        name: \\\"Tax_Return_Page3.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_5\\\",\\n        name: \\\"Tax_Calculation.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"tax_6\\\",\\n        name: \\\"Tax_Payment_Receipt.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"education\\\",\\n    title: \\\"Education Certificates\\\",\\n    tag: \\\"Education\\\",\\n    mergedFileName: \\\"Education_Documents.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"edu_1\\\",\\n        name: \\\"Degree_Certificate.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_2\\\",\\n        name: \\\"Transcript_Page1.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_3\\\",\\n        name: \\\"Transcript_Page2.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_4\\\",\\n        name: \\\"Transcript_Page3.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_5\\\",\\n        name: \\\"IELTS_Result.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_6\\\",\\n        name: \\\"IELTS_TRF.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"edu_7\\\",\\n        name: \\\"Professional_Certificate.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"travel_history\\\",\\n    title: \\\"Travel History\\\",\\n    tag: \\\"Travel History\\\",\\n    mergedFileName: \\\"Travel_Documents.pdf\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"travel_1\\\",\\n        name: \\\"Old_Passport_Page1.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_2\\\",\\n        name: \\\"Old_Passport_Page2.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_3\\\",\\n        name: \\\"Old_Passport_Page3.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_4\\\",\\n        name: \\\"Flight_Itinerary_UK.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"travel_5\\\",\\n        name: \\\"Hotel_Booking_UK.pdf\\\",\\n        size: \\\"0.3 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n  {\\n    id: \\\"unclassified\\\",\\n    title: \\\"Unclassified\\\",\\n    tag: \\\"Unclassified\\\",\\n    status: \\\"pending\\\",\\n    files: [\\n      {\\n        id: \\\"u1\\\",\\n        name: \\\"Scan_Page_001.pdf\\\",\\n        size: \\\"0.8 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u2\\\",\\n        name: \\\"Scan_Page_002.pdf\\\",\\n        size: \\\"0.7 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u3\\\",\\n        name: \\\"Scan_Page_003.pdf\\\",\\n        size: \\\"0.9 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u4\\\",\\n        name: \\\"Unknown_Doc_A.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u5\\\",\\n        name: \\\"Unknown_Doc_B.pdf\\\",\\n        size: \\\"0.6 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u6\\\",\\n        name: \\\"Misc_Scan_001.pdf\\\",\\n        size: \\\"0.4 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u7\\\",\\n        name: \\\"Misc_Scan_002.pdf\\\",\\n        size: \\\"0.5 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n      {\\n        id: \\\"u8\\\",\\n        name: \\\"Photo_Doc.pdf\\\",\\n        size: \\\"1.2 MB\\\",\\n        pages: 1,\\n        date: \\\"Just now\\\",\\n        type: \\\"pdf\\\",\\n        isNew: true,\\n      },\\n    ],\\n  },\\n];\\n\\n// System users (mock data)\\nexport const SYSTEM_USERS: { id: string; name: string; email: string; role: string }[] = [\\n  { id: \\\"john-001\\\", name: \\\"John Smith\\\", email: \\\"john@lawfirm.com\\\", role: \\\"Partner\\\" },\\n  { id: \\\"sarah-002\\\", name: \\\"Sarah Johnson\\\", email: \\\"sarah@lawfirm.com\\\", role: \\\"Senior Associate\\\" },\\n  { id: \\\"michael-003\\\", name: \\\"Michael Chen\\\", email: \\\"michael@lawfirm.com\\\", role: \\\"Associate\\\" },\\n  { id: \\\"emma-004\\\", name: \\\"Emma Wilson\\\", email: \\\"emma@lawfirm.com\\\", role: \\\"Paralegal\\\" },\\n  { id: \\\"david-005\\\", name: \\\"David Brown\\\", email: \\\"david@lawfirm.com\\\", role: \\\"Paralegal\\\" },\\n  { id: \\\"lisa-006\\\", name: \\\"Lisa Taylor\\\", email: \\\"lisa@lawfirm.com\\\", role: \\\"Legal Assistant\\\" },\\n];\\n\\n// Initial questionnaire questions\\nconst initialQuestions: QuestionnaireQuestion[] = [\\n  {\\n    id: \\\"q1\\\",\\n    question: \\\"Is the applicant currently in the UK?\\\",\\n    questionZh: \\\"申请人目前在英国吗？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q2\\\",\\n    question: \\\"Does the applicant have a valid passport?\\\",\\n    questionZh: \\\"申请人是否持有有效护照？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q3\\\",\\n    question: \\\"Has the applicant applied for a UK visa before?\\\",\\n    questionZh: \\\"申请人之前是否申请过英国签证？\\\",\\n    type: \\\"boolean\\\",\\n  },\\n  {\\n    id: \\\"q4\\\",\\n    question: \\\"What is the purpose of the application?\\\",\\n    questionZh: \\\"申请的目的是什么？\\\",\\n    type: \\\"single-choice\\\",\\n    options: [\\n      { value: \\\"work\\\", label: \\\"Work\\\" },\\n      { value: \\\"study\\\", label: \\\"Study\\\" },\\n      { value: \\\"family\\\", label: \\\"Family reunion\\\" },\\n      { value: \\\"visit\\\", label: \\\"Visit\\\" },\\n      { value: \\\"settlement\\\", label: \\\"Settlement\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"q5\\\",\\n    question: \\\"Does the applicant have a sponsor (employer/university)?\\\",\\n    questionZh: \\\"申请人是否有担保人（雇主/大学）？\\\",\\n    type: \\\"boolean\\\",\\n    dependsOn: { questionId: \\\"q4\\\", value: \\\"work\\\" },\\n  },\\n];\\n\\n// Initial checklist items (for detailed stage)\\nconst initialChecklistItems: ChecklistItem[] = [\\n  {\\n    id: \\\"identity\\\",\\n    label: \\\"Identity Documents\\\",\\n    category: \\\"identity\\\",\\n    status: \\\"pending\\\",\\n    children: [\\n      { id: \\\"passport\\\", label: \\\"Valid Passport\\\", status: \\\"pending\\\" },\\n      { id: \\\"photo\\\", label: \\\"Passport Photo\\\", status: \\\"pending\\\" },\\n      { id: \\\"prev-visas\\\", label: \\\"Previous Visa History\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"financial\\\",\\n    label: \\\"Financial Evidence\\\",\\n    category: \\\"financial\\\",\\n    status: \\\"pending\\\",\\n    dependsOn: [\\\"identity\\\"],\\n    children: [\\n      {\\n        id: \\\"bank-statements\\\",\\n        label: \\\"Bank Statements (6 months)\\\",\\n        status: \\\"pending\\\",\\n      },\\n      {\\n        id: \\\"employment-letter\\\",\\n        label: \\\"Employment Letter\\\",\\n        status: \\\"pending\\\",\\n      },\\n      { id: \\\"tax-records\\\", label: \\\"Tax Records\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"sponsorship\\\",\\n    label: \\\"Sponsorship Documents\\\",\\n    category: \\\"sponsorship\\\",\\n    status: \\\"pending\\\",\\n    dependsOn: [\\\"identity\\\"],\\n    children: [\\n      { id: \\\"cos\\\", label: \\\"Certificate of Sponsorship\\\", status: \\\"pending\\\" },\\n      { id: \\\"job-offer\\\", label: \\\"Job Offer Letter\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n  {\\n    id: \\\"english\\\",\\n    label: \\\"English Language\\\",\\n    category: \\\"english\\\",\\n    status: \\\"pending\\\",\\n    children: [\\n      { id: \\\"ielts\\\", label: \\\"IELTS/English Test Results\\\", status: \\\"pending\\\" },\\n    ],\\n  },\\n];\\n\\n// Initial state\\nconst initialState: CaseDetailState = {\\n  caseId: null,\\n  caseReference: \\\"REF-2024-001\\\",\\n  caseNotesSummary: null,\\n  caseTeam: {\\n    lawyer: { id: \\\"john-001\\\", name: \\\"John\\\", email: \\\"john@example.com\\\" },\\n  },\\n  activeNav: \\\"overview\\\",\\n  highlightedGroupId: null,\\n  clientProfile: {\\n    completeness: 0,\\n  },\\n  selectedVisaType: null,\\n  checklist: {\\n    stage: \\\"empty\\\",\\n    questions: initialQuestions,\\n    items: initialChecklistItems,\\n    progress: {\\n      completed: 0,\\n      total: 0,\\n    },\\n  },\\n  uploadedFilePreviews: [],\\n  maxPreviewFiles: 6,\\n  allFiles: {},\\n  documentGroups: [],\\n  isLoadingDocuments: false,\\n  demoStage: 0,\\n  isAnalyzingDocuments: false,\\n  analysisProgress: 0,\\n  lastAnalysisAt: null,\\n  analyzedFileIds: [],\\n  // Application Phase - starts at analyzing since visa type is set at case creation\\n  applicationPhase: \\\"analyzing\\\",\\n  formSchema: null,\\n  formPilotStatus: {\\n    totalSessions: 0,\\n    lastRunAt: null,\\n    lastRunStatus: null,\\n  },\\n  analyzedFiles: [],\\n  // Application Checklist\\n  applicationChecklistItems: [],\\n  qualityIssues: [],\\n  questionnaireAnswers: {},\\n  checklistSectionExpanded: {\\n    personal: true,\\n    employment: true,\\n    financial: false,\\n    travel: false,\\n    education: false,\\n    family: false,\\n    other: false,\\n  },\\n  // Enhanced Checklist Workspace State\\n  enhancedChecklistItems: [],\\n  enhancedQualityIssues: [],\\n  selectedChecklistItemId: null,\\n  selectedIssueId: null,\\n  forwardModalOpen: false,\\n  forwardModalIssueId: null,\\n};\\n\\n// ============================================================================\\n// Helper Functions for 1:N File-Container Model\\n// ============================================================================\\n\\n// Helper to sync file previews from allFiles and documentGroups\\nconst syncFilePreviewsFromState = (\\n  allFiles: Record<string, DocumentFile>,\\n  groups: DocumentGroup[],\\n): UploadedFilePreview[] => {\\n  const previews: UploadedFilePreview[] = [];\\n  for (const group of groups) {\\n    for (const fileId of group.fileIds) {\\n      const file = allFiles[fileId];\\n      if (file && !file.isRemoved) {\\n        previews.push({\\n          id: file.id,\\n          name: file.name,\\n          type: file.type === \\\"pdf\\\" ? \\\"application/pdf\\\" : \\\"application/msword\\\",\\n          groupId: group.id,\\n        });\\n      }\\n    }\\n  }\\n  return previews;\\n};\\n\\n// Helper to get files for a specific container\\nconst getContainerFiles = (\\n  allFiles: Record<string, DocumentFile>,\\n  group: DocumentGroup,\\n): DocumentFile[] => {\\n  return group.fileIds\\n    .map(id => allFiles[id])\\n    .filter((f): f is DocumentFile => f !== undefined && !f.isRemoved);\\n};\\n\\n// Helper to get unclassified files (files with no container associations)\\nconst getUnclassifiedFiles = (\\n  allFiles: Record<string, DocumentFile>,\\n): DocumentFile[] => {\\n  return Object.values(allFiles).filter(\\n    f => !f.isRemoved && f.containerIds.length === 0\\n  );\\n};\\n\\n// Legacy compatibility: Helper to sync file previews from old-style groups (with files array)\\n// Used during migration and for backwards compatibility\\nconst syncFilePreviewsFromGroups = (\\n  groups: Array<DocumentGroup & { files?: DocumentFile[] }>,\\n): UploadedFilePreview[] => {\\n  const previews: UploadedFilePreview[] = [];\\n  for (const group of groups) {\\n    // Support both new model (fileIds) and old model (files)\\n    const files = (group as { files?: DocumentFile[] }).files || [];\\n    for (const file of files) {\\n      previews.push({\\n        id: file.id,\\n        name: file.name,\\n        type: file.type === \\\"pdf\\\" ? \\\"application/pdf\\\" : \\\"application/msword\\\",\\n        groupId: group.id,\\n      });\\n    }\\n  }\\n  return previews;\\n};\\n\\n// Convert old-style groups (files embedded) to new model (files separate, groups have fileIds)\\nconst convertLegacyGroupsToNewModel = (\\n  legacyGroups: LegacyDocumentGroup[]\\n): { allFiles: Record<string, DocumentFile>; documentGroups: DocumentGroup[] } => {\\n  const allFiles: Record<string, DocumentFile> = {};\\n  const documentGroups: DocumentGroup[] = [];\\n\\n  for (const group of legacyGroups) {\\n    const fileIds: string[] = [];\\n\\n    for (const file of group.files) {\\n      // Determine containerIds: empty if unclassified group, otherwise [group.id]\\n      const containerIds = group.id === 'unclassified' ? [] : [group.id];\\n\\n      // Store file in allFiles with containerIds\\n      allFiles[file.id] = {\\n        ...file,\\n        containerIds: file.containerIds || containerIds,\\n      };\\n      fileIds.push(file.id);\\n    }\\n\\n    // Create new-style group with fileIds instead of files\\n    documentGroups.push({\\n      id: group.id,\\n      title: group.title,\\n      tag: group.tag,\\n      mergedFileName: group.mergedFileName,\\n      status: group.status,\\n      hasChanges: group.hasChanges,\\n      fileIds,\\n      files: [],\\n      isSpecial: group.isSpecial,\\n      entityType: group.entityType,\\n      generatedName: group.generatedName,\\n    });\\n  }\\n\\n  return { allFiles, documentGroups };\\n};\\n\\n// Calculate profile completeness\\nconst calculateCompleteness = (\\n  profile: CaseDetailState[\\\"clientProfile\\\"],\\n): number => {\\n  let score = 0;\\n  const total = 3; // passport, contact info (email), contact info (phone)\\n\\n  if (profile.passport) score += 1;\\n  if (profile.contactInfo?.email) score += 1;\\n  if (profile.contactInfo?.phone) score += 1;\\n\\n  return Math.round((score / total) * 100);\\n};\\n\\n// Calculate checklist progress\\nconst calculateProgress = (\\n  items: ChecklistItem[],\\n): { completed: number; total: number } => {\\n  let completed = 0;\\n  let total = 0;\\n\\n  const countItems = (itemList: ChecklistItem[]) => {\\n    for (const item of itemList) {\\n      if (item.children && item.children.length > 0) {\\n        countItems(item.children);\\n      } else {\\n        total++;\\n        if (item.status === \\\"completed\\\") completed++;\\n      }\\n    }\\n  };\\n\\n  countItems(items);\\n  return { completed, total };\\n};\\n\\nexport const useCaseDetailStore = create<CaseDetailStore>()(\\n  devtools(\\n    (set, get) => ({\\n      ...initialState,\\n\\n      // Navigation\\n      setActiveNav: (nav: CaseDetailNavItem) => {\\n        set({ activeNav: nav }, false, \\\"setActiveNav\\\");\\n      },\\n\\n      navigateToDocumentGroup: (groupId: string) => {\\n        set(\\n          { activeNav: \\\"documents\\\", highlightedGroupId: groupId },\\n          false,\\n          \\\"navigateToDocumentGroup\\\"\\n        );\\n      },\\n\\n      clearHighlightedGroup: () => {\\n        set({ highlightedGroupId: null }, false, \\\"clearHighlightedGroup\\\");\\n      },\\n\\n      // Case\\n      setCaseId: (caseId: string) => {\\n        set({ caseId }, false, \\\"setCaseId\\\");\\n      },\\n\\n      setCaseReference: (reference: string) => {\\n        set({ caseReference: reference }, false, \\\"setCaseReference\\\");\\n      },\\n\\n      // Case Team\\n      setLawyer: (lawyer) => {\\n        set(\\n          (state) => ({\\n            caseTeam: { ...state.caseTeam, lawyer },\\n          }),\\n          false,\\n          \\\"setLawyer\\\"\\n        );\\n      },\\n\\n      setAssistant: (assistant) => {\\n        set(\\n          (state) => ({\\n            caseTeam: { ...state.caseTeam, assistant },\\n          }),\\n          false,\\n          \\\"setAssistant\\\"\\n        );\\n      },\\n\\n      // Case Notes Summary\\n      setCaseNotesSummary: (summary: CaseNotesSummary | null) => {\\n        set({ caseNotesSummary: summary }, false, \\\"setCaseNotesSummary\\\");\\n      },\\n\\n      // Client Profile\\n      updateClientProfile: (updates) => {\\n        set(\\n          (state) => {\\n            const newProfile = { ...state.clientProfile, ...updates };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n            return { clientProfile: newProfile };\\n          },\\n          false,\\n          \\\"updateClientProfile\\\",\\n        );\\n      },\\n\\n      setPassportInfo: (passport: PassportInfo) => {\\n        set(\\n          (state) => {\\n            const newProfile = { ...state.clientProfile, passport };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n            return { clientProfile: newProfile };\\n          },\\n          false,\\n          \\\"setPassportInfo\\\",\\n        );\\n      },\\n\\n      // Visa Type\\n      setVisaType: (type: VisaType | null) => {\\n        set({ selectedVisaType: type }, false, \\\"setVisaType\\\");\\n      },\\n\\n      // Checklist\\n      setChecklistStage: (stage: ChecklistStage) => {\\n        set(\\n          (state) => ({\\n            checklist: { ...state.checklist, stage },\\n          }),\\n          false,\\n          \\\"setChecklistStage\\\",\\n        );\\n      },\\n\\n      answerQuestion: (questionId: string, answer: unknown) => {\\n        set(\\n          (state) => {\\n            const questions = state.checklist.questions.map((q) =>\\n              q.id === questionId ? { ...q, answer } : q,\\n            );\\n            return {\\n              checklist: { ...state.checklist, questions },\\n            };\\n          },\\n          false,\\n          \\\"answerQuestion\\\",\\n        );\\n      },\\n\\n      updateChecklistItem: (itemId: string, status: ChecklistItemStatus) => {\\n        set(\\n          (state) => {\\n            const updateItemRecursive = (\\n              items: ChecklistItem[],\\n            ): ChecklistItem[] => {\\n              return items.map((item) => {\\n                if (item.id === itemId) {\\n                  return { ...item, status };\\n                }\\n                if (item.children) {\\n                  return {\\n                    ...item,\\n                    children: updateItemRecursive(item.children),\\n                  };\\n                }\\n                return item;\\n              });\\n            };\\n\\n            const newItems = updateItemRecursive(state.checklist.items);\\n            const progress = calculateProgress(newItems);\\n\\n            return {\\n              checklist: {\\n                ...state.checklist,\\n                items: newItems,\\n                progress,\\n              },\\n            };\\n          },\\n          false,\\n          \\\"updateChecklistItem\\\",\\n        );\\n      },\\n\\n      evolveChecklist: () => {\\n        const state = get();\\n        const { checklist, uploadedFilePreviews } = state;\\n        const fileCount = uploadedFilePreviews.length;\\n        const answeredQuestions = checklist.questions.filter(\\n          (q) => q.answer !== undefined,\\n        ).length;\\n        const totalQuestions = checklist.questions.length;\\n\\n        let newStage: ChecklistStage = checklist.stage;\\n\\n        // Evolution logic based on files and answers\\n        if (fileCount === 0) {\\n          newStage = \\\"empty\\\";\\n        } else if (fileCount >= 1 && checklist.stage === \\\"empty\\\") {\\n          newStage = \\\"questionnaire\\\";\\n        } else if (\\n          (answeredQuestions >= totalQuestions * 0.5 || fileCount >= 3) &&\\n          checklist.stage === \\\"questionnaire\\\"\\n        ) {\\n          newStage = \\\"partial\\\";\\n        } else if (\\n          (answeredQuestions === totalQuestions || state.selectedVisaType) &&\\n          checklist.stage === \\\"partial\\\"\\n        ) {\\n          newStage = \\\"detailed\\\";\\n        }\\n\\n        if (newStage !== checklist.stage) {\\n          set(\\n            (state) => ({\\n              checklist: {\\n                ...state.checklist,\\n                stage: newStage,\\n                progress: calculateProgress(state.checklist.items),\\n              },\\n            }),\\n            false,\\n            \\\"evolveChecklist\\\",\\n          );\\n        }\\n      },\\n\\n      // File Previews\\n      addFilePreview: (file: UploadedFilePreview) => {\\n        set(\\n          (state) => {\\n            const newPreviews = [...state.uploadedFilePreviews, file];\\n            return { uploadedFilePreviews: newPreviews };\\n          },\\n          false,\\n          \\\"addFilePreview\\\",\\n        );\\n        // Trigger checklist evolution\\n        get().evolveChecklist();\\n      },\\n\\n      removeFilePreview: (fileId: string) => {\\n        set(\\n          (state) => ({\\n            uploadedFilePreviews: state.uploadedFilePreviews.filter(\\n              (f) => f.id !== fileId,\\n            ),\\n          }),\\n          false,\\n          \\\"removeFilePreview\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      setFilePreviews: (files: UploadedFilePreview[]) => {\\n        set({ uploadedFilePreviews: files }, false, \\\"setFilePreviews\\\");\\n        get().evolveChecklist();\\n      },\\n\\n      // Demo Controls\\n      advanceDemoStage: () => {\\n        set(\\n          (state) => {\\n            const stages: ChecklistStage[] = [\\n              \\\"empty\\\",\\n              \\\"questionnaire\\\",\\n              \\\"partial\\\",\\n              \\\"detailed\\\",\\n            ];\\n            const currentIndex = stages.indexOf(state.checklist.stage);\\n            const nextIndex = Math.min(currentIndex + 1, stages.length - 1);\\n\\n            return {\\n              demoStage: state.demoStage + 1,\\n              checklist: {\\n                ...state.checklist,\\n                stage: stages[nextIndex],\\n                progress: calculateProgress(state.checklist.items),\\n              },\\n            };\\n          },\\n          false,\\n          \\\"advanceDemoStage\\\",\\n        );\\n      },\\n\\n      resetDemoStage: () => {\\n        set(\\n          {\\n            demoStage: 0,\\n            checklist: {\\n              ...initialState.checklist,\\n              stage: \\\"empty\\\",\\n            },\\n          },\\n          false,\\n          \\\"resetDemoStage\\\",\\n        );\\n      },\\n\\n      // Document Groups\\n      setDocumentGroups: (groups: DocumentGroup[]) => {\\n        const previews = syncFilePreviewsFromGroups(groups);\\n        set(\\n          { documentGroups: groups, uploadedFilePreviews: previews },\\n          false,\\n          \\\"setDocumentGroups\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      addDocumentGroup: (templateName: string) => {\\n        set(\\n          (state) => {\\n            const newGroup: DocumentGroup = {\\n              id: `group_${Date.now()}`,\\n              title: templateName,\\n              tag: templateName,\\n              mergedFileName: `${templateName}.pdf`,\\n              status: \\\"pending\\\",\\n              fileIds: [],\\n              files: [],\\n            };\\n            // Append new category to the end of the array\\n            // The grid filters out \\\"unclassified\\\" so new categories appear at the end\\n            return { documentGroups: [...state.documentGroups, newGroup] };\\n          },\\n          false,\\n          \\\"addDocumentGroup\\\",\\n        );\\n      },\\n\\n      deleteDocumentGroup: (groupId: string) => {\\n        set(\\n          (state) => {\\n            const newGroups = state.documentGroups.filter(\\n              (g) => g.id !== groupId,\\n            );\\n            const previews = syncFilePreviewsFromGroups(newGroups);\\n            return {\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"deleteDocumentGroup\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      renameDocumentGroup: (groupId: string, newTitle: string) => {\\n        set(\\n          (state) => ({\\n            documentGroups: state.documentGroups.map((g) =>\\n              g.id === groupId ? { ...g, mergedFileName: newTitle } : g,\\n            ),\\n          }),\\n          false,\\n          \\\"renameDocumentGroup\\\",\\n        );\\n      },\\n\\n      // ============================================\\n      // One-to-Many File-Container Actions\\n      // ============================================\\n\\n      // Add file to container (creates reference)\\n      addFileToContainer: (fileId: string, containerId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            const group = state.documentGroups.find(g => g.id === containerId);\\n\\n            if (!file || !group) return state;\\n\\n            // Idempotency: if already in container, do nothing\\n            if (file.containerIds.includes(containerId)) return state;\\n\\n            // Update file's containerIds\\n            const updatedFile = {\\n              ...file,\\n              containerIds: [...file.containerIds, containerId],\\n              isNew: true,\\n            };\\n\\n            // Update container's fileIds\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (g.id === containerId) {\\n                return {\\n                  ...g,\\n                  fileIds: [fileId, ...g.fileIds], // Add to beginning\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"addFileToContainer\\\",\\n        );\\n      },\\n\\n      // Remove file from container (removes reference only)\\n      removeFileFromContainer: (fileId: string, containerId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            const group = state.documentGroups.find(g => g.id === containerId);\\n\\n            if (!file || !group) return state;\\n\\n            // Update file's containerIds\\n            const updatedFile = {\\n              ...file,\\n              containerIds: file.containerIds.filter(id => id !== containerId),\\n            };\\n\\n            // Update container's fileIds\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (g.id === containerId) {\\n                return {\\n                  ...g,\\n                  fileIds: g.fileIds.filter(id => id !== fileId),\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"removeFileFromContainer\\\",\\n        );\\n      },\\n\\n      // Reuse file in another container (adds reference, keeps original)\\n      reuseFileInContainer: (fileId: string, targetContainerId: string) => {\\n        // Just call addFileToContainer - file will be in both containers\\n        get().addFileToContainer(fileId, targetContainerId);\\n      },\\n\\n      // Move file between containers (remove from source, add to target)\\n      moveFileBetweenContainers: (fileId: string, fromContainerId: string, toContainerId: string) => {\\n        get().removeFileFromContainer(fileId, fromContainerId);\\n        get().addFileToContainer(fileId, toContainerId);\\n      },\\n\\n      // Legacy moveFileToGroup - for Unclassified to Container moves\\n      // When moving from Unclassified (containerIds=[]), just add to target container\\n      // When moving between containers, use moveFileBetweenContainers\\n      moveFileToGroup: (fileId: string, targetGroupId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file || file.isRemoved) return state;\\n\\n            // Find source container (first container in list, or empty for unclassified)\\n            const sourceContainerId = file.containerIds.length > 0 ? file.containerIds[0] : null;\\n\\n            // If moving to same container, do nothing\\n            if (sourceContainerId === targetGroupId) return state;\\n\\n            // Update file's containerIds\\n            let newContainerIds: string[];\\n            if (sourceContainerId) {\\n              // Replace source with target\\n              newContainerIds = file.containerIds.filter(id => id !== sourceContainerId);\\n              if (!newContainerIds.includes(targetGroupId)) {\\n                newContainerIds = [targetGroupId, ...newContainerIds];\\n              }\\n            } else {\\n              // Unclassified: just add target\\n              newContainerIds = [targetGroupId];\\n            }\\n\\n            const updatedFile = {\\n              ...file,\\n              containerIds: newContainerIds,\\n              isNew: true,\\n            };\\n\\n            // Update groups\\n            const updatedGroups = state.documentGroups.map(g => {\\n              if (sourceContainerId && g.id === sourceContainerId) {\\n                // Remove from source\\n                return {\\n                  ...g,\\n                  fileIds: g.fileIds.filter(id => id !== fileId),\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              if (g.id === targetGroupId && !g.fileIds.includes(fileId)) {\\n                // Add to target\\n                return {\\n                  ...g,\\n                  fileIds: [fileId, ...g.fileIds],\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"moveFileToGroup\\\",\\n        );\\n      },\\n\\n      reorderFileInGroup: (\\n        groupId: string,\\n        fromIndex: number,\\n        toIndex: number,\\n      ) => {\\n        set(\\n          (state) => {\\n            const newGroups = state.documentGroups.map((group) => {\\n              if (group.id !== groupId) return group;\\n\\n              const newFileIds = [...group.fileIds];\\n              const [removed] = newFileIds.splice(fromIndex, 1);\\n              newFileIds.splice(toIndex, 0, removed);\\n\\n              return {\\n                ...group,\\n                fileIds: newFileIds,\\n                status: \\\"pending\\\" as const,\\n                hasChanges: true,\\n              };\\n            });\\n\\n            return { documentGroups: newGroups };\\n          },\\n          false,\\n          \\\"reorderFileInGroup\\\",\\n        );\\n      },\\n\\n      markFileForDeletion: (fileId: string, groupId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file) return state;\\n\\n            // Mark file as removed\\n            const updatedFile = { ...file, isRemoved: true, isNew: false };\\n            const newAllFiles = { ...state.allFiles, [fileId]: updatedFile };\\n\\n            // Update group status\\n            const newGroups = state.documentGroups.map((group) => {\\n              if (group.id !== groupId) return group;\\n              return {\\n                ...group,\\n                status: \\\"pending\\\" as const,\\n                hasChanges: true,\\n              };\\n            });\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"markFileForDeletion\\\",\\n        );\\n      },\\n\\n      clearFileNewStatus: (fileId: string) => {\\n        set(\\n          (state) => {\\n            const file = state.allFiles[fileId];\\n            if (!file) return state;\\n\\n            return {\\n              allFiles: {\\n                ...state.allFiles,\\n                [fileId]: { ...file, isNew: false },\\n              },\\n            };\\n          },\\n          false,\\n          \\\"clearFileNewStatus\\\",\\n        );\\n      },\\n\\n      clearGroupChangesFlag: (groupId: string) => {\\n        set(\\n          (state) => ({\\n            documentGroups: state.documentGroups.map((group) =>\\n              group.id === groupId ? { ...group, hasChanges: false } : group,\\n            ),\\n          }),\\n          false,\\n          \\\"clearGroupChangesFlag\\\",\\n        );\\n      },\\n\\n      confirmGroupReview: (groupId: string) => {\\n        set(\\n          (state) => {\\n            const group = state.documentGroups.find((g) => g.id === groupId);\\n            if (!group) return {};\\n\\n            // Update allFiles: remove isRemoved files, clear isNew flag for remaining\\n            const newAllFiles = { ...state.allFiles };\\n            const activeFileIds: string[] = [];\\n            for (const fileId of group.fileIds) {\\n              const file = newAllFiles[fileId];\\n              if (!file) continue;\\n              if (file.isRemoved) {\\n                // Remove the file from allFiles entirely\\n                delete newAllFiles[fileId];\\n              } else {\\n                // Clear isNew flag\\n                newAllFiles[fileId] = { ...file, isNew: false };\\n                activeFileIds.push(fileId);\\n              }\\n            }\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: state.documentGroups.map((g) =>\\n                g.id === groupId\\n                  ? {\\n                      ...g,\\n                      status: \\\"reviewed\\\" as const,\\n                      hasChanges: false,\\n                      fileIds: activeFileIds,\\n                    }\\n                  : g,\\n              ),\\n            };\\n          },\\n          false,\\n          \\\"confirmGroupReview\\\",\\n        );\\n      },\\n\\n      uploadDocuments: async () => {\\n        set({ isLoadingDocuments: true }, false, \\\"uploadDocuments:start\\\");\\n        // Simulate AI processing\\n        await new Promise((resolve) => setTimeout(resolve, 2000));\\n        // Convert legacy groups to new model\\n        const { allFiles, documentGroups } = convertLegacyGroupsToNewModel(INITIAL_DOCUMENT_GROUPS_LEGACY);\\n        const previews = syncFilePreviewsFromState(allFiles, documentGroups);\\n        set(\\n          {\\n            allFiles,\\n            documentGroups,\\n            uploadedFilePreviews: previews,\\n            isLoadingDocuments: false,\\n          },\\n          false,\\n          \\\"uploadDocuments:complete\\\",\\n        );\\n        get().evolveChecklist();\\n      },\\n\\n      uploadToGroup: (groupId: string, fileCount: number = 1) => {\\n        set(\\n          (state) => {\\n            const group = state.documentGroups.find(g => g.id === groupId);\\n            if (!group) return state;\\n\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n            const newFileIds: string[] = [];\\n\\n            for (let i = 0; i < fileCount; i++) {\\n              const fileId = `file_${timestamp}_${i}`;\\n              newAllFiles[fileId] = {\\n                id: fileId,\\n                name: `Uploaded_Page_${group.fileIds.length + i + 1}.pdf`,\\n                size: \\\"0.5 MB\\\",\\n                pages: 1,\\n                date: \\\"Just now\\\",\\n                type: \\\"pdf\\\",\\n                isNew: true,\\n                containerIds: [groupId],\\n              };\\n              newFileIds.push(fileId);\\n            }\\n\\n            const newGroups = state.documentGroups.map(g => {\\n              if (g.id === groupId) {\\n                return {\\n                  ...g,\\n                  fileIds: [...g.fileIds, ...newFileIds],\\n                  status: \\\"pending\\\" as const,\\n                  hasChanges: true,\\n                };\\n              }\\n              return g;\\n            });\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadToGroup\\\",\\n        );\\n      },\\n\\n      // Upload and auto-classify documents (simulates AI classification)\\n      uploadAndAutoClassify: (totalPages: number = 8) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Helper to normalize names for comparison (remove spaces, hyphens, lowercase)\\n            const normalize = (str: string) =>\\n              str.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n\\n            // Categories to potentially create (simulating AI classification results)\\n            const allPossibleCategories = [\\n              { category: \\\"Passport\\\", pages: 2 },\\n              { category: \\\"Bank Statement\\\", pages: 3 },\\n              { category: \\\"Employment Letter\\\", pages: 2 },\\n              { category: \\\"Utility Bill\\\", pages: 2 },\\n              { category: \\\"Tax Documents\\\", pages: 2 },\\n              { category: \\\"Education Certificate\\\", pages: 1 },\\n              { category: \\\"Travel History\\\", pages: 2 },\\n              { category: \\\"Medical Records\\\", pages: 2 },\\n              { category: \\\"Marriage Certificate\\\", pages: 1 },\\n              { category: \\\"Birth Certificate\\\", pages: 1 },\\n            ];\\n\\n            // Find categories that don't exist yet\\n            const existingNormalizedTitles = state.documentGroups\\n              .filter((g) => g.id !== \\\"unclassified\\\")\\n              .map((g) => normalize(g.title));\\n\\n            const newCategories = allPossibleCategories.filter(\\n              (c) => !existingNormalizedTitles.includes(normalize(c.category))\\n            );\\n\\n            // Select 1-2 NEW categories to create\\n            const numNewCategories = Math.min(\\n              Math.floor(Math.random() * 2) + 1,\\n              newCategories.length\\n            );\\n            const selectedNewCategories = newCategories\\n              .sort(() => Math.random() - 0.5)\\n              .slice(0, numNewCategories);\\n\\n            // Also add files to 0-1 existing categories (if any exist)\\n            const existingClassifiedGroups = state.documentGroups.filter(\\n              (g) => g.id !== \\\"unclassified\\\" && g.id !== \\\"case_notes\\\"\\n            );\\n            const selectedExistingGroup =\\n              existingClassifiedGroups.length > 0 && Math.random() > 0.3\\n                ? existingClassifiedGroups[\\n                    Math.floor(Math.random() * existingClassifiedGroups.length)\\n                  ]\\n                : null;\\n\\n            // Calculate pages distribution\\n            const newCategoryPages = selectedNewCategories.reduce(\\n              (sum, c) => sum + c.pages,\\n              0\\n            );\\n            const existingGroupPages = selectedExistingGroup ? 2 : 0;\\n            const classifiedPages = newCategoryPages + existingGroupPages;\\n            const unclassifiedPages = Math.max(2, totalPages - classifiedPages);\\n\\n            let newGroups = [...state.documentGroups];\\n\\n            // Create NEW category groups with files\\n            selectedNewCategories.forEach((result, catIndex) => {\\n              const groupId = `group_${timestamp}_${catIndex}`;\\n              const fileIds: string[] = [];\\n\\n              for (let i = 0; i < result.pages; i++) {\\n                const fileId = `classified_${timestamp}_${catIndex}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `${result.category.replace(/\\\\s+/g, \\\"_\\\")}_Page_${i + 1}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [groupId],\\n                };\\n                fileIds.push(fileId);\\n              }\\n\\n              newGroups.push({\\n                id: groupId,\\n                title: result.category,\\n                tag: result.category,\\n                mergedFileName: `${result.category.replace(/\\\\s+/g, \\\"_\\\")}.pdf`,\\n                status: \\\"pending\\\",\\n                hasChanges: true,\\n                fileIds,\\n                files: [],\\n              });\\n            });\\n\\n            // Add files to an existing group (if selected)\\n            if (selectedExistingGroup) {\\n              const existingFileIds: string[] = [];\\n              for (let i = 0; i < existingGroupPages; i++) {\\n                const fileId = `existing_${timestamp}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `${selectedExistingGroup.title.replace(/\\\\s+/g, \\\"_\\\")}_New_${i + 1}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [selectedExistingGroup.id],\\n                };\\n                existingFileIds.push(fileId);\\n              }\\n              newGroups = newGroups.map((g) =>\\n                g.id === selectedExistingGroup.id\\n                  ? {\\n                      ...g,\\n                      fileIds: [...g.fileIds, ...existingFileIds],\\n                      status: \\\"pending\\\" as const,\\n                      hasChanges: true,\\n                    }\\n                  : g\\n              );\\n            }\\n\\n            // Add remaining pages as unclassified (containerIds = [])\\n            if (unclassifiedPages > 0) {\\n              const existingUnclassifiedCount = getUnclassifiedFiles(state.allFiles).length;\\n              for (let i = 0; i < unclassifiedPages; i++) {\\n                const fileId = `unclassified_${timestamp}_${i}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: `Scan_Page_${String(existingUnclassifiedCount + i + 1).padStart(3, \\\"0\\\")}.pdf`,\\n                  size: \\\"0.5 MB\\\",\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\",\\n                  isNew: true,\\n                  containerIds: [], // Empty = unclassified\\n                };\\n              }\\n            }\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadAndAutoClassify\\\",\\n        );\\n      },\\n\\n      // Duplicate/Reuse a file to another group (one-to-many linking)\\n      // Now uses reference model - no physical duplication needed\\n      duplicateFileToGroup: (fileId: string, targetGroupId: string) => {\\n        // In the new 1:N model, this is the same as reuseFileInContainer\\n        get().addFileToContainer(fileId, targetGroupId);\\n      },\\n\\n      // Add multiple files to an existing container (moves files from their current containers)\\n      addFilesToGroup: (groupId: string, orderedFileIds: string[]) => {\\n        set(\\n          (state) => {\\n            const targetGroup = state.documentGroups.find((g) => g.id === groupId);\\n            if (!targetGroup) return state;\\n\\n            const newAllFiles = { ...state.allFiles };\\n            const affectedGroupIds = new Set<string>();\\n\\n            // Update each file's containerIds: remove from old, add to target\\n            for (const fileId of orderedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                // Track affected source groups\\n                for (const cid of file.containerIds) {\\n                  if (cid !== groupId) affectedGroupIds.add(cid);\\n                }\\n                // Update file to only be in the target container\\n                newAllFiles[fileId] = {\\n                  ...file,\\n                  containerIds: [groupId],\\n                  isNew: true,\\n                };\\n              }\\n            }\\n\\n            // Remove files from source groups' fileIds\\n            const movedFileIdSet = new Set(orderedFileIds);\\n            let updatedGroups = state.documentGroups.map((group) => {\\n              if (group.id === groupId) {\\n                // Add files to target group (preserve existing + add new in order)\\n                const existingFileIds = group.fileIds.filter((id) => !movedFileIdSet.has(id));\\n                return {\\n                  ...group,\\n                  fileIds: [...existingFileIds, ...orderedFileIds],\\n                  hasChanges: true,\\n                };\\n              }\\n              if (!affectedGroupIds.has(group.id)) return group;\\n              return {\\n                ...group,\\n                fileIds: group.fileIds.filter((fid) => !movedFileIdSet.has(fid)),\\n              };\\n            });\\n\\n            // Auto-delete source groups that became empty\\n            updatedGroups = updatedGroups.filter(\\n              (g) => g.fileIds.length > 0 || !affectedGroupIds.has(g.id)\\n            );\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"addFilesToGroup\\\"\\n        );\\n      },\\n\\n      // Merge (copy) multiple files into a new combined document group\\n      // Source files remain unchanged - this creates copies for the merged document\\n      mergeDocumentsIntoGroup: (\\n        name: string,\\n        orderedFileIds: string[]\\n      ) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newGroupId = `merged_${timestamp}_${Math.random().toString(36).substr(2, 9)}`;\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Create COPIES of selected files for the merged document\\n            // Original files remain unchanged in their source containers\\n            const copiedFileIds: string[] = [];\\n\\n            for (let i = 0; i < orderedFileIds.length; i++) {\\n              const originalFileId = orderedFileIds[i];\\n              const originalFile = newAllFiles[originalFileId];\\n              if (originalFile) {\\n                // Create a new file ID for the copy\\n                const newFileId = `${originalFileId}_copy_${timestamp}_${i}`;\\n\\n                // Create a copy of the file for the new merged group\\n                newAllFiles[newFileId] = {\\n                  ...originalFile,\\n                  id: newFileId,\\n                  containerIds: [newGroupId],\\n                  isNew: true,\\n                };\\n                copiedFileIds.push(newFileId);\\n              }\\n            }\\n\\n            // Source groups remain unchanged - no files are removed\\n\\n            // Create new merged group with copied files\\n            const newGroup: DocumentGroup = {\\n              id: newGroupId,\\n              title: name,\\n              tag: \\\"Other Documents\\\",\\n              mergedFileName: `${name.replace(/\\\\s+/g, \\\"_\\\")}_Merged.pdf`,\\n              status: \\\"pending\\\",\\n              fileIds: copiedFileIds,\\n              files: [],\\n              hasChanges: true,\\n            };\\n\\n            const updatedGroups = [...state.documentGroups, newGroup];\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"mergeDocumentsIntoGroup\\\",\\n        );\\n      },\\n\\n      // Upload folder with recursive path parsing\\n      uploadFolder: (files: Array<{ file: File; relativePath: string }>) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Separate files into recognized (known entity) and unrecognized (unknown entity)\\n            const recognizedFiles: Array<{ file: File; relativePath: string; parsed: ReturnType<typeof parseDocumentPath> }> = [];\\n            const unrecognizedFiles: Array<{ file: File; relativePath: string; parsed: ReturnType<typeof parseDocumentPath> }> = [];\\n\\n            for (const fileData of files) {\\n              const parsed = parseDocumentPath(fileData.relativePath, fileData.file.name);\\n              if (parsed.who === 'unknown') {\\n                unrecognizedFiles.push({ ...fileData, parsed });\\n              } else {\\n                recognizedFiles.push({ ...fileData, parsed });\\n              }\\n            }\\n\\n            // Group recognized files by their generated document name\\n            const groupedByName = new Map<string, {\\n              parsedDoc: ReturnType<typeof parseDocumentPath>;\\n              files: Array<{ file: File; relativePath: string }>;\\n            }>();\\n\\n            for (const fileData of recognizedFiles) {\\n              if (!groupedByName.has(fileData.parsed.generatedName)) {\\n                groupedByName.set(fileData.parsed.generatedName, {\\n                  parsedDoc: fileData.parsed,\\n                  files: [],\\n                });\\n              }\\n              groupedByName.get(fileData.parsed.generatedName)!.files.push(fileData);\\n            }\\n\\n            // Create DocumentGroups for each unique generated name\\n            const newGroups: DocumentGroup[] = [];\\n            let fileIndex = 0;\\n\\n            // Determine tag from document type\\n            const tagMap: Record<string, string> = {\\n              passport: \\\"Identity\\\",\\n              nationalId: \\\"Identity\\\",\\n              birthCertificate: \\\"Identity\\\",\\n              bankStatement: \\\"Financial\\\",\\n              payslip: \\\"Financial\\\",\\n              taxReturn: \\\"Financial\\\",\\n              employmentLetter: \\\"Employment\\\",\\n              employmentContract: \\\"Employment\\\",\\n              educationCertificate: \\\"Education\\\",\\n              transcript: \\\"Education\\\",\\n              schoolEnrollment: \\\"Education\\\",\\n              marriageCertificate: \\\"Relationship\\\",\\n              proofOfCohabitation: \\\"Relationship\\\",\\n              propertyTitle: \\\"Accommodation\\\",\\n              proofOfAccommodation: \\\"Accommodation\\\",\\n              utilityBill: \\\"Utility\\\",\\n              visa: \\\"Travel\\\",\\n              insurance: \\\"Insurance\\\",\\n              letterOfConsent: \\\"Other\\\",\\n              document: \\\"Other Documents\\\",\\n            };\\n\\n            for (const [generatedName, data] of groupedByName) {\\n              const groupId = `group_folder_${timestamp}_${newGroups.length}`;\\n              const fileIds: string[] = [];\\n\\n              for (const fileData of data.files) {\\n                const fileId = `folder_${timestamp}_${fileIndex++}`;\\n                newAllFiles[fileId] = {\\n                  id: fileId,\\n                  name: fileData.file.name,\\n                  size: `${(fileData.file.size / 1024).toFixed(1)} KB`,\\n                  pages: 1,\\n                  date: \\\"Just now\\\",\\n                  type: \\\"pdf\\\" as const,\\n                  isNew: true,\\n                  containerIds: [groupId],\\n                  relativePath: fileData.relativePath,\\n                  entityType: data.parsedDoc.who,\\n                };\\n                fileIds.push(fileId);\\n              }\\n\\n              const tag = tagMap[data.parsedDoc.documentType] || \\\"Other Documents\\\";\\n\\n              newGroups.push({\\n                id: groupId,\\n                title: generatedName,\\n                tag,\\n                mergedFileName: `${generatedName}.pdf`,\\n                status: \\\"pending\\\",\\n                fileIds,\\n                files: [],\\n                hasChanges: true,\\n                entityType: data.parsedDoc.who,\\n                generatedName,\\n              });\\n            }\\n\\n            // Add unrecognized files as unclassified (containerIds = [])\\n            for (const fileData of unrecognizedFiles) {\\n              const fileId = `folder_${timestamp}_${fileIndex++}`;\\n              newAllFiles[fileId] = {\\n                id: fileId,\\n                name: fileData.file.name,\\n                size: `${(fileData.file.size / 1024).toFixed(1)} KB`,\\n                pages: 1,\\n                date: \\\"Just now\\\",\\n                type: \\\"pdf\\\" as const,\\n                isNew: true,\\n                containerIds: [], // Empty = unclassified\\n                relativePath: fileData.relativePath,\\n                entityType: \\\"unknown\\\" as const,\\n              };\\n            }\\n\\n            // Add new classified groups\\n            const updatedGroups = [...state.documentGroups, ...newGroups];\\n            const previews = syncFilePreviewsFromState(newAllFiles, updatedGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: updatedGroups,\\n              uploadedFilePreviews: previews,\\n            };\\n          },\\n          false,\\n          \\\"uploadFolder\\\",\\n        );\\n      },\\n\\n      // Upload file for a specific evidence requirement\\n      uploadForEvidence: (evidenceId: string, evidenceName: string) => {\\n        set(\\n          (state) => {\\n            const timestamp = Date.now();\\n            const normalizedName = evidenceName.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n            const newAllFiles = { ...state.allFiles };\\n\\n            // Find existing group that matches the evidence name\\n            let targetGroupId: string | undefined;\\n            for (const g of state.documentGroups) {\\n              const normalizedGroupTitle = g.title.toLowerCase().replace(/[\\\\s\\\\-_]/g, \\\"\\\");\\n              if (normalizedGroupTitle.includes(normalizedName) || normalizedName.includes(normalizedGroupTitle)) {\\n                targetGroupId = g.id;\\n                break;\\n              }\\n            }\\n\\n            // If no matching group exists, create one\\n            if (!targetGroupId) {\\n              targetGroupId = `group_${timestamp}`;\\n            }\\n\\n            const fileId = `evidence_${timestamp}`;\\n            newAllFiles[fileId] = {\\n              id: fileId,\\n              name: `${evidenceName.replace(/\\\\s+/g, \\\"_\\\")}.pdf`,\\n              size: \\\"0.5 MB\\\",\\n              pages: 1,\\n              date: \\\"Just now\\\",\\n              type: \\\"pdf\\\",\\n              isNew: true,\\n              containerIds: [targetGroupId],\\n            };\\n\\n            let newGroups = [...state.documentGroups];\\n\\n            const existingGroup = newGroups.find(g => g.id === targetGroupId);\\n            if (existingGroup) {\\n              // Add file to existing group\\n              newGroups = newGroups.map((g) =>\\n                g.id === targetGroupId\\n                  ? {\\n                      ...g,\\n                      fileIds: [...g.fileIds, fileId],\\n                      status: \\\"pending\\\" as const,\\n                      hasChanges: true,\\n                    }\\n                  : g\\n              );\\n            } else {\\n              // Create new group for this evidence\\n              newGroups.push({\\n                id: targetGroupId,\\n                title: evidenceName,\\n                tag: evidenceName,\\n                mergedFileName: `${evidenceName}.pdf`,\\n                status: \\\"pending\\\",\\n                fileIds: [fileId],\\n                files: [],\\n                hasChanges: true,\\n              });\\n            }\\n\\n            // Update enhanced checklist items (requiredEvidence is only on EnhancedChecklistItem)\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: true,\\n                      linkedFileId: fileId,\\n                      linkedFileName: newAllFiles[fileId].name,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            // Mark related issue as resolved\\n            const issueIdToResolve = `issue_missing_evidence_${evidenceId}`;\\n            const updatedIssues = state.enhancedQualityIssues.map((issue) =>\\n              issue.id === issueIdToResolve\\n                ? {\\n                    ...issue,\\n                    status: \\\"resolved\\\" as IssueStatus,\\n                    resolvedAt: new Date().toISOString(),\\n                    updatedAt: new Date().toISOString(),\\n                  }\\n                : issue\\n            );\\n\\n            const previews = syncFilePreviewsFromState(newAllFiles, newGroups);\\n\\n            return {\\n              allFiles: newAllFiles,\\n              documentGroups: newGroups,\\n              uploadedFilePreviews: previews,\\n              enhancedChecklistItems: updatedEnhancedItems,\\n              enhancedQualityIssues: updatedIssues,\\n            };\\n          },\\n          false,\\n          \\\"uploadForEvidence\\\"\\n        );\\n      },\\n\\n      // Link evidence to an existing document group from File Hub\\n      linkEvidenceToGroup: (evidenceId: string, groupId: string) => {\\n        set(\\n          (state) => {\\n            const targetGroup = state.documentGroups.find((g) => g.id === groupId);\\n            if (!targetGroup) return state;\\n\\n            // Update enhanced checklist items\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: true,\\n                      linkedFileId: groupId, // Link to the group ID\\n                      linkedFileName: targetGroup.title,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            // Mark related issue as resolved\\n            const issueIdToResolve = `issue_missing_evidence_${evidenceId}`;\\n            const updatedIssues = state.enhancedQualityIssues.map((issue) =>\\n              issue.id === issueIdToResolve\\n                ? {\\n                    ...issue,\\n                    status: \\\"resolved\\\" as IssueStatus,\\n                    resolvedAt: new Date().toISOString(),\\n                    updatedAt: new Date().toISOString(),\\n                  }\\n                : issue\\n            );\\n\\n            return {\\n              enhancedChecklistItems: updatedEnhancedItems,\\n              enhancedQualityIssues: updatedIssues,\\n            };\\n          },\\n          false,\\n          \\\"linkEvidenceToGroup\\\"\\n        );\\n      },\\n\\n      // Unlink evidence from a document group\\n      unlinkEvidence: (evidenceId: string) => {\\n        set(\\n          (state) => {\\n            // Update enhanced checklist items - reset the evidence to unlinked state\\n            const updatedEnhancedItems = state.enhancedChecklistItems.map((item) => ({\\n              ...item,\\n              requiredEvidence: item.requiredEvidence?.map((ev) =>\\n                ev.id === evidenceId\\n                  ? {\\n                      ...ev,\\n                      isUploaded: false,\\n                      linkedFileId: undefined,\\n                      linkedFileName: undefined,\\n                    }\\n                  : ev\\n              ),\\n            }));\\n\\n            return {\\n              enhancedChecklistItems: updatedEnhancedItems,\\n            };\\n          },\\n          false,\\n          \\\"unlinkEvidence\\\"\\n        );\\n      },\\n\\n      // Demo: Review all documents and analyze to generate client profile\\n      reviewAllDocumentsAndAnalyze: async () => {\\n        const state = get();\\n\\n        // Step 1: Mark all document groups as reviewed\\n        set(\\n          (prev) => {\\n            const newAllFiles = { ...prev.allFiles };\\n            const newDocumentGroups = prev.documentGroups.map((g) => {\\n              const activeFileIds: string[] = [];\\n              for (const fileId of g.fileIds) {\\n                const file = newAllFiles[fileId];\\n                if (!file) continue;\\n                if (file.isRemoved) {\\n                  delete newAllFiles[fileId];\\n                } else {\\n                  newAllFiles[fileId] = { ...file, isNew: false };\\n                  activeFileIds.push(fileId);\\n                }\\n              }\\n              return {\\n                ...g,\\n                status: \\\"reviewed\\\" as const,\\n                hasChanges: false,\\n                fileIds: activeFileIds,\\n              };\\n            });\\n            return {\\n              isAnalyzingDocuments: true,\\n              analysisProgress: 0,\\n              allFiles: newAllFiles,\\n              documentGroups: newDocumentGroups,\\n            };\\n          },\\n          false,\\n          \\\"reviewAllDocuments\\\",\\n        );\\n\\n        // Step 2: Simulate document analysis with progress updates\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 600));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`,\\n          );\\n        }\\n\\n        // Step 3: Generate mock client profile from \\\"extracted\\\" document data\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        // Step 4: Update client profile and record analyzed files\\n        const currentState = get();\\n        const analyzedFileIds = currentState.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(currentState.allFiles, g).map((f) => f.id));\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            // Mark all analyzed files in allFiles\\n            const newAllFiles = { ...state.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of analyzedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n\\n            return {\\n              clientProfile: newProfile,\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\",\\n        );\\n\\n        // Evolve checklist based on new data\\n        get().evolveChecklist();\\n      },\\n\\n      // Run document analysis on ready (reviewed) documents only\\n      runDocumentAnalysis: async () => {\\n        const state = get();\\n\\n        // Get all ready files (from reviewed groups, excluding unclassified and removed)\\n        const readyFiles = state.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(state.allFiles, g));\\n\\n        if (readyFiles.length === 0) {\\n          return; // Nothing to analyze\\n        }\\n\\n        set(\\n          { isAnalyzingDocuments: true, analysisProgress: 0 },\\n          false,\\n          \\\"startAnalysis\\\",\\n        );\\n\\n        // Simulate analysis\\n        const totalSteps = 4;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 500));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`,\\n          );\\n        }\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        set(\\n          (state) => {\\n            // Mark analyzed files in allFiles\\n            const newAllFiles = { ...state.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of analyzedFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n            return {\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\",\\n        );\\n      },\\n\\n      // Application Phase Management\\n      setApplicationPhase: (phase: ApplicationPhase) => {\\n        set({ applicationPhase: phase }, false, \\\"setApplicationPhase\\\");\\n      },\\n\\n      // Initialize form schema based on visa type\\n      initFormSchema: (visaType: VisaType) => {\\n        const schemaConfigs: Record<VisaType, Omit<FormSchemaStatus, \\\"filledFields\\\" | \\\"completionPercentage\\\" | \\\"lastUpdatedAt\\\">> = {\\n          \\\"skilled-worker\\\": {\\n            schemaName: \\\"Skilled Worker Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 58,\\n            emptyRequiredFields: [\\n              \\\"Certificate of Sponsorship number\\\",\\n              \\\"Sponsor license number\\\",\\n              \\\"Job start date\\\",\\n              \\\"Annual salary\\\",\\n              \\\"SOC code\\\",\\n              \\\"Working hours per week\\\",\\n              \\\"Main work location\\\",\\n              \\\"Previous UK visas\\\",\\n              \\\"Criminal convictions\\\",\\n              \\\"TB test certificate\\\",\\n            ],\\n          },\\n          naturalisation: {\\n            schemaName: \\\"Naturalisation Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 55,\\n            emptyRequiredFields: [\\n              \\\"Current immigration status\\\",\\n              \\\"Date ILR granted\\\",\\n              \\\"Residency period details\\\",\\n              \\\"Life in the UK test pass date\\\",\\n              \\\"English language proof\\\",\\n              \\\"Good character declaration\\\",\\n              \\\"Referee details\\\",\\n            ],\\n          },\\n          visitor: {\\n            schemaName: \\\"Visitor Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 38,\\n            emptyRequiredFields: [\\n              \\\"Visit purpose\\\",\\n              \\\"Intended stay duration\\\",\\n              \\\"Accommodation address\\\",\\n              \\\"Return ticket booking\\\",\\n              \\\"Ties to home country\\\",\\n            ],\\n          },\\n          \\\"partner-spouse\\\": {\\n            schemaName: \\\"Partner/Spouse Visa Application\\\",\\n            schemaVersion: \\\"2024.1\\\",\\n            totalFields: 62,\\n            emptyRequiredFields: [\\n              \\\"Sponsor relationship\\\",\\n              \\\"Sponsor immigration status\\\",\\n              \\\"Accommodation details\\\",\\n              \\\"Financial evidence\\\",\\n              \\\"English language proof\\\",\\n              \\\"Relationship evidence\\\",\\n            ],\\n          },\\n        };\\n\\n        const config = schemaConfigs[visaType];\\n        const formSchema: FormSchemaStatus = {\\n          ...config,\\n          filledFields: 0,\\n          completionPercentage: 0,\\n          lastUpdatedAt: null,\\n        };\\n\\n        set({ formSchema }, false, \\\"initFormSchema\\\");\\n      },\\n\\n      // Start document analysis (Application workflow)\\n      startAnalysis: async () => {\\n        const state = get();\\n\\n        // Get ready files (from reviewed groups, excluding unclassified)\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const readyFiles = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g)\\n        );\\n\\n        if (readyFiles.length === 0) {\\n          return;\\n        }\\n\\n        // Set analyzing phase\\n        set(\\n          {\\n            applicationPhase: \\\"analyzing\\\",\\n            isAnalyzingDocuments: true,\\n            analysisProgress: 0,\\n          },\\n          false,\\n          \\\"startAnalysis\\\"\\n        );\\n\\n        // Simulate analysis with progress\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 800));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`\\n          );\\n        }\\n\\n        // Generate analyzed files summary\\n        const analyzedFiles: AnalyzedFileSummary[] = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => ({\\n            id: f.id,\\n            name: f.name,\\n            groupTitle: g.title,\\n            pages: f.pages || 1,\\n            analyzedAt: new Date().toISOString(),\\n          }))\\n        );\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        // Update form schema with mock extracted data\\n        const currentSchema = state.formSchema;\\n        const filledFields = currentSchema\\n          ? Math.round(currentSchema.totalFields * 0.73)\\n          : 0;\\n        const updatedSchema: FormSchemaStatus | null = currentSchema\\n          ? {\\n              ...currentSchema,\\n              filledFields,\\n              completionPercentage: Math.round(\\n                (filledFields / currentSchema.totalFields) * 100\\n              ),\\n              lastUpdatedAt: new Date().toISOString(),\\n            }\\n          : null;\\n\\n        // Mock passport extraction\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            return {\\n              applicationPhase: \\\"questionnaire\\\",\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: new Date().toISOString(),\\n              analyzedFileIds,\\n              analyzedFiles,\\n              formSchema: updatedSchema,\\n              clientProfile: newProfile,\\n              // Reset questionnaire answers to trigger questionnaire flow\\n              questionnaireAnswers: {},\\n              // Mark analyzed files in allFiles\\n              allFiles: (() => {\\n                const newAllFiles = { ...state.allFiles };\\n                const now = new Date().toISOString();\\n                for (const fileId of analyzedFileIds) {\\n                  const file = newAllFiles[fileId];\\n                  if (file) {\\n                    newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n                  }\\n                }\\n                return newAllFiles;\\n              })(),\\n            };\\n          },\\n          false,\\n          \\\"analysisComplete\\\"\\n        );\\n\\n        // Don't auto-generate checklist - wait for questionnaire to be completed\\n        // Checklist will be generated when user submits questionnaire answers\\n      },\\n\\n      // Re-analyze: only updates analyzed files without regenerating checklist\\n      // Used when new files are added after initial checklist generation\\n      reAnalyze: async () => {\\n        const state = get();\\n\\n        // Get all currently reviewed file IDs\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const allReadyFileIds = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => f.id)\\n        );\\n\\n        // Find new files that haven't been analyzed\\n        const newFileIds = allReadyFileIds.filter(\\n          (id) => !state.analyzedFileIds.includes(id)\\n        );\\n\\n        if (newFileIds.length === 0) {\\n          return;\\n        }\\n\\n        // Brief analyzing state\\n        set(\\n          { isAnalyzingDocuments: true, analysisProgress: 0 },\\n          false,\\n          \\\"reAnalyze:start\\\"\\n        );\\n\\n        // Simulate quick analysis\\n        await new Promise((resolve) => setTimeout(resolve, 500));\\n        set({ analysisProgress: 50 }, false, \\\"reAnalyze:progress\\\");\\n        await new Promise((resolve) => setTimeout(resolve, 500));\\n\\n        // Update analyzed file IDs to include new files\\n        const updatedAnalyzedFileIds = [...state.analyzedFileIds, ...newFileIds];\\n\\n        set(\\n          (currentState) => {\\n            // Mark new files as analyzed in allFiles\\n            const newAllFiles = { ...currentState.allFiles };\\n            const now = new Date().toISOString();\\n            for (const fileId of newFileIds) {\\n              const file = newAllFiles[fileId];\\n              if (file) {\\n                newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n              }\\n            }\\n            return {\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: now,\\n              analyzedFileIds: updatedAnalyzedFileIds,\\n              allFiles: newAllFiles,\\n            };\\n          },\\n          false,\\n          \\\"reAnalyze:complete\\\"\\n        );\\n      },\\n\\n      // Launch Form Pilot (opens mock form with auto-fill)\\n      launchFormPilot: () => {\\n        const state = get();\\n\\n        // Import and use the bridge dynamically to avoid SSR issues\\n        import(\\\"@/lib/form-pilot-bridge\\\").then(({ launchFormPilotDemo, listenForCompletion }) => {\\n          // Launch the form pilot demo\\n          const { cleanup } = launchFormPilotDemo();\\n\\n          // Listen for completion\\n          const removeListener = listenForCompletion((result) => {\\n            set(\\n              (currentState) => ({\\n                formPilotStatus: {\\n                  ...currentState.formPilotStatus,\\n                  totalSessions: currentState.formPilotStatus.totalSessions + 1,\\n                  lastRunAt: new Date().toISOString(),\\n                  lastRunStatus: result.status === \\\"success\\\" ? \\\"success\\\" : \\\"error\\\",\\n                },\\n              }),\\n              false,\\n              \\\"formPilotComplete\\\"\\n            );\\n\\n            // Cleanup\\n            removeListener();\\n            cleanup();\\n          });\\n        });\\n\\n        // Update status immediately to show \\\"running\\\"\\n        set(\\n          (currentState) => ({\\n            formPilotStatus: {\\n              ...currentState.formPilotStatus,\\n              lastRunAt: new Date().toISOString(),\\n              lastRunStatus: null, // null indicates running/in-progress\\n            },\\n          }),\\n          false,\\n          \\\"launchFormPilot\\\"\\n        );\\n      },\\n\\n      // Start analysis and generate questionnaire (Application workflow)\\n      startAnalysisAndGenerateQuestionnaire: async () => {\\n        const state = get();\\n\\n        // Get ready files (from reviewed groups, excluding unclassified)\\n        const reviewedGroups = state.documentGroups.filter(\\n          (g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\"\\n        );\\n        const readyFiles = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g)\\n        );\\n\\n        if (readyFiles.length === 0) {\\n          return;\\n        }\\n\\n        // Set analyzing phase\\n        set(\\n          {\\n            applicationPhase: \\\"analyzing\\\",\\n            isAnalyzingDocuments: true,\\n            analysisProgress: 0,\\n          },\\n          false,\\n          \\\"startAnalysisAndGenerateQuestionnaire\\\"\\n        );\\n\\n        // Simulate analysis with progress (includes Gap Analysis)\\n        const totalSteps = 5;\\n        for (let i = 1; i <= totalSteps; i++) {\\n          await new Promise((resolve) => setTimeout(resolve, 800));\\n          set(\\n            { analysisProgress: Math.round((i / totalSteps) * 100) },\\n            false,\\n            `analyzing:step${i}`\\n          );\\n        }\\n\\n        // Generate analyzed files summary\\n        const analyzedFiles: AnalyzedFileSummary[] = reviewedGroups.flatMap((g) =>\\n          getContainerFiles(state.allFiles, g).map((f) => ({\\n            id: f.id,\\n            name: f.name,\\n            groupTitle: g.title,\\n            pages: f.pages || 1,\\n            analyzedAt: new Date().toISOString(),\\n          }))\\n        );\\n\\n        const analyzedFileIds = readyFiles.map((f) => f.id);\\n\\n        // Mock passport extraction\\n        const mockPassportInfo: PassportInfo = {\\n          surname: \\\"HARTWELL\\\",\\n          givenNames: \\\"Oliver James\\\",\\n          nationality: \\\"British\\\",\\n          dateOfBirth: \\\"1988-11-23\\\",\\n          sex: \\\"M\\\",\\n          countryOfBirth: \\\"United Kingdom\\\",\\n          passportNumber: \\\"533284719\\\",\\n          dateOfIssue: \\\"2021-06-15\\\",\\n          dateOfExpiry: \\\"2031-06-14\\\",\\n        };\\n\\n        const mockContactInfo = {\\n          email: \\\"oliver.hartwell@gmail.com\\\",\\n          phone: \\\"+44 7911 234567\\\",\\n          address: \\\"42 Kensington Gardens, London W8 4PX\\\",\\n        };\\n\\n        set(\\n          (state) => {\\n            const newProfile = {\\n              ...state.clientProfile,\\n              passport: mockPassportInfo,\\n              contactInfo: mockContactInfo,\\n            };\\n            newProfile.completeness = calculateCompleteness(newProfile);\\n\\n            return {\\n              applicationPhase: \\\"questionnaire\\\",\\n              isAnalyzingDocuments: false,\\n              analysisProgress: 100,\\n              lastAnalysisAt: new Date().toISOString(),\\n              analyzedFileIds,\\n              analyzedFiles,\\n              clientProfile: newProfile,\\n              // Mark analyzed files in allFiles\\n              allFiles: (() => {\\n                const newAllFiles = { ...state.allFiles };\\n                const now = new Date().toISOString();\\n                for (const fileId of analyzedFileIds) {\\n                  const file = newAllFiles[fileId];\\n                  if (file) {\\n                    newAllFiles[fileId] = { ...file, isAnalyzed: true, analyzedAt: now };\\n                  }\\n                }\\n                return newAllFiles;\\n              })(),\\n            };\\n          },\\n          false,\\n          \\\"analysisAndQuestionnaireComplete\\\"\\n        );\\n      },\\n\\n      // Submit questionnaire answers and proceed to checklist\\n      submitQuestionnaireAnswers: (answers: Record<string, string>) => {\\n        const state = get();\\n\\n        // Get all currently reviewed file IDs to mark as analyzed\\n        const analyzedFileIds = state.documentGroups\\n          .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n          .flatMap((g) => getContainerFiles(state.allFiles, g).map((f) => f.id));\\n\\n        set(\\n          {\\n            questionnaireAnswers: answers,\\n            applicationPhase: \\\"checklist\\\",\\n            // Mark analysis as complete when questionnaire is submitted\\n            lastAnalysisAt: new Date().toISOString(),\\n            // Track which files were analyzed\\n            analyzedFileIds,\\n          },\\n          false,\\n          \\\"submitQuestionnaireAnswers\\\"\\n        );\\n        // First generate the base checklist items (mock data)\\n        get().generateChecklist();\\n        // Then convert to enhanced format with issues\\n        get().generateEnhancedChecklist();\\n      },\\n\\n      // Generate checklist with mock data and quality issues\\n      generateChecklist: () => {\\n        const state = get();\\n        const passport = state.clientProfile.passport;\\n\\n        // Get passport file ID from document groups\\n        const passportGroup = state.documentGroups.find(g => g.id === \\\"passport\\\");\\n        const passportFileId = passportGroup?.fileIds[0]\\n          ? (state.allFiles[passportGroup.fileIds[0]]?.id || \\\"pp_1\\\")\\n          : \\\"pp_1\\\";\\n\\n        // Mock checklist items based on UK Skilled Worker Visa requirements\\n        const mockChecklistItems: ApplicationChecklistItem[] = [\\n          // ==========================================\\n          // PERSONAL INFORMATION\\n          // ==========================================\\n          {\\n            id: \\\"given_names\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"givenNames\\\",\\n            label: \\\"Given Names\\\",\\n            value: passport?.givenNames || null,\\n            source: passport?.givenNames ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.givenNames ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"surname\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"surname\\\",\\n            label: \\\"Surname\\\",\\n            value: passport?.surname || null,\\n            source: passport?.surname ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.surname ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"dob\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"dateOfBirth\\\",\\n            label: \\\"Date of Birth\\\",\\n            value: passport?.dateOfBirth || null,\\n            source: passport?.dateOfBirth ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfBirth ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"place_of_birth\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"placeOfBirth\\\",\\n            label: \\\"Place of Birth\\\",\\n            value: passport?.countryOfBirth || \\\"Beijing, China\\\",\\n            source: passport?.countryOfBirth ? \\\"extracted\\\" : \\\"extracted\\\",\\n            linkedFileIds: [passportFileId],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"gender\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"gender\\\",\\n            label: \\\"Gender\\\",\\n            value: passport?.sex || null,\\n            source: passport?.sex ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.sex ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_number\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportNumber\\\",\\n            label: \\\"Passport Number\\\",\\n            value: passport?.passportNumber || null,\\n            source: passport?.passportNumber ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.passportNumber ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_issue_date\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportIssueDate\\\",\\n            label: \\\"Passport Issue Date\\\",\\n            value: passport?.dateOfIssue || null,\\n            source: passport?.dateOfIssue ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfIssue ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"passport_expiry_date\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"passportExpiryDate\\\",\\n            label: \\\"Passport Expiry Date\\\",\\n            value: passport?.dateOfExpiry || null,\\n            source: passport?.dateOfExpiry ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.dateOfExpiry ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"nationality\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"nationality\\\",\\n            label: \\\"Nationality\\\",\\n            value: passport?.nationality || null,\\n            source: passport?.nationality ? \\\"extracted\\\" : null,\\n            linkedFileIds: [passportFileId],\\n            status: passport?.nationality ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"current_address\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"currentAddress\\\",\\n            label: \\\"Current Residential Address\\\",\\n            value: \\\"15 Maple Street, London SW1A 1AA\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"phone_number\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"phoneNumber\\\",\\n            label: \\\"Contact Phone Number\\\",\\n            value: \\\"+44 7700 900123\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"email_address\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"emailAddress\\\",\\n            label: \\\"Email Address\\\",\\n            value: \\\"john.smith@email.com\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"national_insurance\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"nationalInsurance\\\",\\n            label: \\\"National Insurance Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"biometric_residence_permit\\\",\\n            section: \\\"personal\\\",\\n            field: \\\"biometricResidencePermit\\\",\\n            label: \\\"Previous BRP Number (if applicable)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // EMPLOYMENT DETAILS\\n          // ==========================================\\n          {\\n            id: \\\"cos_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosNumber\\\",\\n            label: \\\"Certificate of Sponsorship (CoS) Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_name\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorName\\\",\\n            label: \\\"Sponsor Name\\\",\\n            value: \\\"ACME Technology Ltd\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_license_number\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorLicenseNumber\\\",\\n            label: \\\"Sponsor License Number\\\",\\n            value: \\\"A1B2C3D4E5F6\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"sponsor_address\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"sponsorAddress\\\",\\n            label: \\\"Sponsor Address\\\",\\n            value: \\\"100 Tech Park, Cambridge CB1 2AB\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"job_title\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"jobTitle\\\",\\n            label: \\\"Job Title\\\",\\n            value: \\\"Senior Software Engineer\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"soc_code\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"socCode\\\",\\n            label: \\\"SOC Code\\\",\\n            value: \\\"2136\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"salary\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"annualSalary\\\",\\n            label: \\\"Annual Salary (GBP)\\\",\\n            value: \\\"£65,000\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"employment_start_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"employmentStartDate\\\",\\n            label: \\\"Employment Start Date\\\",\\n            value: \\\"2024-04-01\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"working_hours\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"workingHoursPerWeek\\\",\\n            label: \\\"Working Hours per Week\\\",\\n            value: \\\"37.5\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"work_address\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"workAddress\\\",\\n            label: \\\"Work Location Address\\\",\\n            value: \\\"100 Tech Park, Cambridge CB1 2AB\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cos_assigned_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosAssignedDate\\\",\\n            label: \\\"CoS Assigned Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cos_expiry_date\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"cosExpiryDate\\\",\\n            label: \\\"CoS Expiry Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"shortage_occupation\\\",\\n            section: \\\"employment\\\",\\n            field: \\\"shortageOccupation\\\",\\n            label: \\\"Is Role on Shortage Occupation List?\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n\\n          // ==========================================\\n          // FINANCIAL EVIDENCE\\n          // ==========================================\\n          {\\n            id: \\\"bank_account_holder\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankAccountHolder\\\",\\n            label: \\\"Bank Account Holder Name\\\",\\n            value: passport?.givenNames && passport?.surname ? `${passport.givenNames} ${passport.surname}` : null,\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: passport?.givenNames ? \\\"complete\\\" : \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"bank_name\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankName\\\",\\n            label: \\\"Bank Name\\\",\\n            value: \\\"HSBC UK\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"account_number\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"accountNumber\\\",\\n            label: \\\"Account Number (Last 4 digits)\\\",\\n            value: \\\"****4521\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"bank_balance\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"bankBalance\\\",\\n            label: \\\"Current Balance\\\",\\n            value: \\\"£28,450.00\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"funds_held_period\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"fundsHeldPeriod\\\",\\n            label: \\\"Funds Held for 28 Consecutive Days\\\",\\n            value: \\\"Yes - Verified\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"statement_date\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"statementDate\\\",\\n            label: \\\"Bank Statement Date\\\",\\n            value: \\\"2024-01-15\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"maintenance_requirement\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"maintenanceRequirement\\\",\\n            label: \\\"Maintenance Requirement Met (£1,270)\\\",\\n            value: \\\"Yes\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"additional_funds_source\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"additionalFundsSource\\\",\\n            label: \\\"Source of Additional Funds\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"sponsor_maintenance_cert\\\",\\n            section: \\\"financial\\\",\\n            field: \\\"sponsorMaintenanceCert\\\",\\n            label: \\\"Sponsor Maintenance Certification\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // TRAVEL HISTORY\\n          // ==========================================\\n          {\\n            id: \\\"previous_uk_visa\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"previousUKVisa\\\",\\n            label: \\\"Previous UK Visa History\\\",\\n            value: \\\"Tier 4 Student Visa (2015-2018)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [passportFileId],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"current_immigration_status\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"currentImmigrationStatus\\\",\\n            label: \\\"Current Immigration Status\\\",\\n            value: \\\"Outside UK\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"travel_history_10_years\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"travelHistory10Years\\\",\\n            label: \\\"Countries Visited (Last 10 Years)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"partial\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"visa_refusals\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"visaRefusals\\\",\\n            label: \\\"Previous Visa Refusals\\\",\\n            value: \\\"None\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"deportation_history\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"deportationHistory\\\",\\n            label: \\\"Deportation or Removal History\\\",\\n            value: \\\"None\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"criminal_convictions\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"criminalConvictions\\\",\\n            label: \\\"Criminal Convictions\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"uk_address_history\\\",\\n            section: \\\"travel\\\",\\n            field: \\\"ukAddressHistory\\\",\\n            label: \\\"UK Address History (Last 5 Years)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // EDUCATION & QUALIFICATIONS\\n          // ==========================================\\n          {\\n            id: \\\"highest_qualification\\\",\\n            section: \\\"education\\\",\\n            field: \\\"highestQualification\\\",\\n            label: \\\"Highest Qualification\\\",\\n            value: \\\"BSc Computer Science\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"institution_name\\\",\\n            section: \\\"education\\\",\\n            field: \\\"institutionName\\\",\\n            label: \\\"Institution Name\\\",\\n            value: \\\"University of Manchester\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"graduation_date\\\",\\n            section: \\\"education\\\",\\n            field: \\\"graduationDate\\\",\\n            label: \\\"Graduation Date\\\",\\n            value: \\\"July 2018\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"english_test_type\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestType\\\",\\n            label: \\\"English Language Test Type\\\",\\n            value: \\\"IELTS Academic\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_score\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestScore\\\",\\n            label: \\\"English Test Score\\\",\\n            value: \\\"Overall 7.5 (L:8.0, R:7.5, W:7.0, S:7.5)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_date\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestDate\\\",\\n            label: \\\"English Test Date\\\",\\n            value: \\\"2023-06-15\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"cefr_level\\\",\\n            section: \\\"education\\\",\\n            field: \\\"cefrLevel\\\",\\n            label: \\\"CEFR Level\\\",\\n            value: \\\"B1 (Minimum Required)\\\",\\n            source: \\\"extracted\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"english_test_reference\\\",\\n            section: \\\"education\\\",\\n            field: \\\"englishTestReference\\\",\\n            label: \\\"English Test Reference Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"atas_certificate\\\",\\n            section: \\\"education\\\",\\n            field: \\\"atasCertificate\\\",\\n            label: \\\"ATAS Certificate (if applicable)\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n\\n          // ==========================================\\n          // FAMILY INFORMATION\\n          // ==========================================\\n          {\\n            id: \\\"marital_status\\\",\\n            section: \\\"family\\\",\\n            field: \\\"maritalStatus\\\",\\n            label: \\\"Marital Status\\\",\\n            value: \\\"Married\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"spouse_name\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spouseName\\\",\\n            label: \\\"Spouse Full Name\\\",\\n            value: \\\"Jane Smith\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"spouse_nationality\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spouseNationality\\\",\\n            label: \\\"Spouse Nationality\\\",\\n            value: \\\"Chinese\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"dependants_count\\\",\\n            section: \\\"family\\\",\\n            field: \\\"dependantsCount\\\",\\n            label: \\\"Number of Dependants\\\",\\n            value: \\\"1 (Spouse applying separately)\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"children_count\\\",\\n            section: \\\"family\\\",\\n            field: \\\"childrenCount\\\",\\n            label: \\\"Number of Children\\\",\\n            value: \\\"0\\\",\\n            source: \\\"questionnaire\\\",\\n            linkedFileIds: [],\\n            status: \\\"complete\\\",\\n            isRequired: true,\\n          },\\n          {\\n            id: \\\"spouse_passport_number\\\",\\n            section: \\\"family\\\",\\n            field: \\\"spousePassportNumber\\\",\\n            label: \\\"Spouse Passport Number\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"marriage_certificate_date\\\",\\n            section: \\\"family\\\",\\n            field: \\\"marriageCertificateDate\\\",\\n            label: \\\"Marriage Certificate Date\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n          {\\n            id: \\\"family_members_in_uk\\\",\\n            section: \\\"family\\\",\\n            field: \\\"familyMembersInUK\\\",\\n            label: \\\"Other Family Members in UK\\\",\\n            value: null,\\n            source: null,\\n            linkedFileIds: [],\\n            status: \\\"missing\\\",\\n            isRequired: false,\\n          },\\n        ];\\n\\n        // Mock quality issues based on common Skilled Worker visa issues\\n        const mockQualityIssues: QualityIssue[] = [\\n          {\\n            id: \\\"issue_cos\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"CoS Number Required\\\",\\n            description: \\\"Certificate of Sponsorship number is missing. This is mandatory for Skilled Worker visa applications. Please obtain from your sponsor.\\\",\\n            linkedChecklistItemId: \\\"cos_number\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_cos_dates\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"CoS Dates Required\\\",\\n            description: \\\"CoS assigned date and expiry date are missing. These are required to verify the validity of your sponsorship.\\\",\\n            linkedChecklistItemId: \\\"cos_assigned_date\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_travel_history\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"warning\\\",\\n            title: \\\"Incomplete Travel History\\\",\\n            description: \\\"Travel history for the last 10 years is incomplete. UKVI requires full travel history including all countries visited.\\\",\\n            linkedChecklistItemId: \\\"travel_history_10_years\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_criminal_check\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"error\\\",\\n            title: \\\"Criminal Convictions Declaration Required\\\",\\n            description: \\\"You must declare any criminal convictions. This is a mandatory question on the visa application form.\\\",\\n            linkedChecklistItemId: \\\"criminal_convictions\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_english_ref\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"warning\\\",\\n            title: \\\"English Test Reference Number\\\",\\n            description: \\\"The reference number for your English language test is required for verification with the test provider.\\\",\\n            linkedChecklistItemId: \\\"english_test_reference\\\",\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_passport_validity\\\",\\n            type: \\\"validity\\\",\\n            severity: \\\"info\\\",\\n            title: \\\"Passport Validity Check\\\",\\n            description: \\\"Ensure passport is valid for the duration of intended stay. Recommended to have at least 6 months validity beyond visa end date.\\\",\\n            linkedChecklistItemId: \\\"passport_expiry_date\\\",\\n            linkedFileId: passportFileId,\\n            isResolved: false,\\n          },\\n          {\\n            id: \\\"issue_shortage\\\",\\n            type: \\\"missing\\\",\\n            severity: \\\"info\\\",\\n            title: \\\"Shortage Occupation Status\\\",\\n            description: \\\"Please confirm whether your role is on the Shortage Occupation List, as this affects salary threshold requirements.\\\",\\n            linkedChecklistItemId: \\\"shortage_occupation\\\",\\n            isResolved: false,\\n          },\\n        ];\\n\\n        set(\\n          {\\n            applicationPhase: \\\"checklist\\\",\\n            applicationChecklistItems: mockChecklistItems,\\n            qualityIssues: mockQualityIssues,\\n          },\\n          false,\\n          \\\"generateChecklist\\\"\\n        );\\n\\n        // Also generate enhanced checklist for the new workspace UI\\n        get().generateEnhancedChecklist();\\n      },\\n\\n      // Update a checklist field value\\n      updateChecklistField: (fieldId: string, value: string) => {\\n        set(\\n          (state) => ({\\n            applicationChecklistItems: state.applicationChecklistItems.map((item) =>\\n              item.id === fieldId\\n                ? {\\n                    ...item,\\n                    value,\\n                    source: \\\"manual\\\",\\n                    status: value ? \\\"complete\\\" : \\\"missing\\\",\\n                  }\\n                : item\\n            ),\\n          }),\\n          false,\\n          \\\"updateChecklistField\\\"\\n        );\\n      },\\n\\n      // Resolve a quality issue\\n      resolveIssue: (issueId: string) => {\\n        set(\\n          (state) => ({\\n            qualityIssues: state.qualityIssues.map((issue) =>\\n              issue.id === issueId ? { ...issue, isResolved: true } : issue\\n            ),\\n          }),\\n          false,\\n          \\\"resolveIssue\\\"\\n        );\\n      },\\n\\n      // Go back to a previous phase\\n      goBackToPhase: (phase: ApplicationPhase) => {\\n        set({ applicationPhase: phase }, false, \\\"goBackToPhase\\\");\\n      },\\n\\n      // Toggle checklist section expansion\\n      toggleChecklistSection: (sectionId: ChecklistSectionType) => {\\n        set(\\n          (state) => ({\\n            checklistSectionExpanded: {\\n              ...state.checklistSectionExpanded,\\n              [sectionId]: !state.checklistSectionExpanded[sectionId],\\n            },\\n          }),\\n          false,\\n          \\\"toggleChecklistSection\\\"\\n        );\\n      },\\n\\n      // ============================================\\n      // Enhanced Checklist Workspace Actions\\n      // ============================================\\n\\n      // Select a checklist item (for detail panel)\\n      selectChecklistItem: (itemId: string | null) => {\\n        set({ selectedChecklistItemId: itemId }, false, \\\"selectChecklistItem\\\");\\n      },\\n\\n      // Select an issue (for detail view)\\n      selectIssue: (issueId: string | null) => {\\n        set({ selectedIssueId: issueId }, false, \\\"selectIssue\\\");\\n      },\\n\\n      // Update enhanced checklist field value\\n      updateEnhancedChecklistField: (fieldId: string, value: string) => {\\n        set(\\n          (state) => ({\\n            enhancedChecklistItems: state.enhancedChecklistItems.map((item) =>\\n              item.id === fieldId\\n                ? {\\n                    ...item,\\n                    value,\\n                    source: \\\"manual\\\" as const,\\n                    status: value ? \\\"complete\\\" as const : \\\"missing\\\" as const,\\n                  }\\n                : item\\n            ),\\n          }),\\n          false,\\n          \\\"updateEnhancedChecklistField\\\"\\n        );\\n      },\\n\\n      // Update issue status\\n      updateIssueStatus: (issueId: string, status: IssueStatus) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"status_changed\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                previousStatus: issue.status,\\n                newStatus: status,\\n              };\\n              return {\\n                ...issue,\\n                status,\\n                updatedAt: new Date().toISOString(),\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"updateIssueStatus\\\"\\n        );\\n      },\\n\\n      // Add a note to an issue\\n      addIssueNote: (issueId: string, note: string) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"note_added\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: note,\\n              };\\n              return {\\n                ...issue,\\n                updatedAt: new Date().toISOString(),\\n                notes: [\\n                  ...issue.notes,\\n                  {\\n                    id: `note_${Date.now()}`,\\n                    content: note,\\n                    createdAt: new Date().toISOString(),\\n                    createdBy: { id: currentUser.id, name: currentUser.name },\\n                  },\\n                ],\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"addIssueNote\\\"\\n        );\\n      },\\n\\n      // Forward issue to client\\n      forwardIssueToClient: (issueId: string, data: ForwardToClientData) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"forwarded\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: data.method === \\\"email\\\"\\n                  ? `Forwarded via email to ${data.recipientEmail}`\\n                  : \\\"Shareable link generated\\\",\\n              };\\n              return {\\n                ...issue,\\n                status: \\\"forwarded\\\" as IssueStatus,\\n                updatedAt: new Date().toISOString(),\\n                forwardData: data,\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n            forwardModalOpen: false,\\n            forwardModalIssueId: null,\\n          }),\\n          false,\\n          \\\"forwardIssueToClient\\\"\\n        );\\n      },\\n\\n      // Mark issue as resolved\\n      markIssueResolved: (issueId: string, resolution?: string) => {\\n        const currentUser = SYSTEM_USERS[0]; // Mock current user\\n        set(\\n          (state) => ({\\n            enhancedQualityIssues: state.enhancedQualityIssues.map((issue) => {\\n              if (issue.id !== issueId) return issue;\\n              const historyEntry: IssueHistoryEntry = {\\n                id: `history_${Date.now()}`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"resolved\\\",\\n                performedBy: { id: currentUser.id, name: currentUser.name },\\n                details: resolution,\\n                previousStatus: issue.status,\\n                newStatus: \\\"resolved\\\",\\n              };\\n              return {\\n                ...issue,\\n                status: \\\"resolved\\\" as IssueStatus,\\n                updatedAt: new Date().toISOString(),\\n                resolvedAt: new Date().toISOString(),\\n                resolvedBy: { id: currentUser.id, name: currentUser.name },\\n                history: [...issue.history, historyEntry],\\n              };\\n            }),\\n          }),\\n          false,\\n          \\\"markIssueResolved\\\"\\n        );\\n      },\\n\\n      // Open forward modal\\n      openForwardModal: (issueId: string) => {\\n        set(\\n          { forwardModalOpen: true, forwardModalIssueId: issueId },\\n          false,\\n          \\\"openForwardModal\\\"\\n        );\\n      },\\n\\n      // Close forward modal\\n      closeForwardModal: () => {\\n        set(\\n          { forwardModalOpen: false, forwardModalIssueId: null },\\n          false,\\n          \\\"closeForwardModal\\\"\\n        );\\n      },\\n\\n      // Generate enhanced checklist with linked documents and issues\\n      generateEnhancedChecklist: () => {\\n        const state = get();\\n        const currentUser = SYSTEM_USERS[0];\\n\\n        // Create linked documents from analyzed files\\n        const createLinkedDocument = (fileId: string): LinkedDocument | null => {\\n          const file = state.allFiles[fileId];\\n          if (!file || file.isRemoved) return null;\\n          // Find the group this file belongs to\\n          const group = state.documentGroups.find((g) =>\\n            g.fileIds.includes(fileId)\\n          );\\n          return {\\n            fileId: file.id,\\n            fileName: file.name,\\n            groupTitle: group?.title || \\\"Unknown\\\",\\n            pageNumbers: [1], // Mock page number\\n            extractedText: `Extracted from ${file.name}`,\\n          };\\n        };\\n\\n        // Evidence ID → Document Group ID mapping for auto-linking\\n        const EVIDENCE_GROUP_MAP: Record<string, string> = {\\n          ev_passport: \\\"passport\\\",\\n          ev_bank_statements: \\\"bank_statement\\\",\\n          ev_payslip: \\\"bank_statement\\\", // payslip may be in same group\\n          ev_employment_contract: \\\"employment_letter\\\",\\n          ev_travel_history: \\\"travel_history\\\",\\n          ev_english_cert: \\\"education\\\",\\n          ev_degree_cert: \\\"education\\\",\\n        };\\n\\n        // Auto-link evidence to existing document groups\\n        const autoLinkEvidence = (ev: RequiredEvidence): RequiredEvidence => {\\n          const groupId = EVIDENCE_GROUP_MAP[ev.id];\\n          if (!groupId) return ev;\\n          const group = state.documentGroups.find(g => g.id === groupId);\\n          if (!group || group.fileIds.length === 0) return ev;\\n          return {\\n            ...ev,\\n            isUploaded: true,\\n            linkedFileId: group.id,\\n            linkedFileName: group.title,\\n          };\\n        };\\n\\n        // Required evidence configuration per section (UK Skilled Worker Visa)\\n        const SECTION_REQUIRED_EVIDENCE: Record<ChecklistSectionType, RequiredEvidence[]> = {\\n          personal: [\\n            {\\n              id: \\\"ev_passport\\\",\\n              name: \\\"Valid Passport\\\",\\n              description: \\\"Current passport with at least 1 blank page for visa vignette\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\", \\\"PNG\\\"],\\n              validityPeriod: \\\"Must be valid for duration of stay\\\",\\n            },\\n            {\\n              id: \\\"ev_photo\\\",\\n              name: \\\"Passport-sized Photograph\\\",\\n              description: \\\"Recent photo meeting UK visa photo requirements (45mm x 35mm)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"JPEG\\\", \\\"PNG\\\"],\\n            },\\n            {\\n              id: \\\"ev_previous_passport\\\",\\n              name: \\\"Previous Passports (if applicable)\\\",\\n              description: \\\"Any previous passports showing UK immigration history\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          employment: [\\n            {\\n              id: \\\"ev_cos\\\",\\n              name: \\\"Certificate of Sponsorship (CoS)\\\",\\n              description: \\\"CoS reference number from licensed UK sponsor\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n            },\\n            {\\n              id: \\\"ev_employment_contract\\\",\\n              name: \\\"Employment Contract / Job Offer Letter\\\",\\n              description: \\\"Signed contract showing job title, salary, and start date\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_sponsor_letter\\\",\\n              name: \\\"Sponsor Confirmation Letter\\\",\\n              description: \\\"Letter from sponsor confirming employment details\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          financial: [\\n            {\\n              id: \\\"ev_bank_statements\\\",\\n              name: \\\"Bank Statements (28 days)\\\",\\n              description: \\\"Showing funds held for 28 consecutive days ending within 31 days of application\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be dated within 31 days of application\\\",\\n            },\\n            {\\n              id: \\\"ev_payslip\\\",\\n              name: \\\"Payslip\\\",\\n              description: \\\"Recent payslips showing salary payments (last 3 months recommended)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          travel: [\\n            {\\n              id: \\\"ev_travel_history\\\",\\n              name: \\\"Travel History Documentation\\\",\\n              description: \\\"Evidence of travel history for last 10 years (passport stamps, boarding passes)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n            {\\n              id: \\\"ev_old_visas\\\",\\n              name: \\\"Previous UK Visas (if any)\\\",\\n              description: \\\"Copies of any previous UK visas or BRPs\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\", \\\"JPEG\\\"],\\n            },\\n          ],\\n          education: [\\n            {\\n              id: \\\"ev_english_cert\\\",\\n              name: \\\"English Language Test Certificate\\\",\\n              description: \\\"IELTS, TOEFL, or approved SELT certificate (CEFR B1 minimum)\\\",\\n              isUploaded: false,\\n              isMandatory: true,\\n              acceptedFormats: [\\\"PDF\\\"],\\n              validityPeriod: \\\"Must be within 2 years of application date\\\",\\n            },\\n            {\\n              id: \\\"ev_degree_cert\\\",\\n              name: \\\"Degree Certificate / Academic Qualification\\\",\\n              description: \\\"Original or certified copy of highest qualification\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_atas\\\",\\n              name: \\\"ATAS Certificate (if applicable)\\\",\\n              description: \\\"Academic Technology Approval Scheme certificate for certain fields\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          family: [\\n            {\\n              id: \\\"ev_marriage_cert\\\",\\n              name: \\\"Marriage Certificate (if applicable)\\\",\\n              description: \\\"Official marriage certificate if applying with spouse\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n            {\\n              id: \\\"ev_birth_cert\\\",\\n              name: \\\"Birth Certificates (if applicable)\\\",\\n              description: \\\"For any dependent children\\\",\\n              isUploaded: false,\\n              isMandatory: false,\\n              acceptedFormats: [\\\"PDF\\\"],\\n            },\\n          ],\\n          other: [],\\n        };\\n\\n        // Get required evidence for a section\\n        const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\\n          return SECTION_REQUIRED_EVIDENCE[section] || [];\\n        };\\n\\n        // Convert existing checklist items to enhanced format\\n        const enhancedItems: EnhancedChecklistItem[] = state.applicationChecklistItems.map((item) => ({\\n          id: item.id,\\n          section: item.section,\\n          field: item.field,\\n          label: item.label,\\n          value: item.value,\\n          source: item.source,\\n          linkedDocuments: item.linkedFileIds\\n            .map(createLinkedDocument)\\n            .filter((doc): doc is LinkedDocument => doc !== null),\\n          requiredEvidence: getRequiredEvidence(item.section),\\n          status: item.status,\\n          isRequired: item.isRequired,\\n          isEditable: true,\\n          confidenceScore: item.source === \\\"extracted\\\" ? 95 : undefined,\\n        }));\\n\\n        // Convert existing quality issues to enhanced format\\n        const existingEnhancedIssues: EnhancedQualityIssue[] = state.qualityIssues.map((issue) => ({\\n          id: issue.id,\\n          type: issue.type,\\n          severity: issue.severity,\\n          status: issue.isResolved ? \\\"resolved\\\" as IssueStatus : \\\"open\\\" as IssueStatus,\\n          title: issue.title,\\n          description: issue.description,\\n          linkedChecklistItemId: issue.linkedChecklistItemId,\\n          linkedFileIds: issue.linkedFileId ? [issue.linkedFileId] : [],\\n          history: [\\n            {\\n              id: `history_${issue.id}_created`,\\n              timestamp: new Date().toISOString(),\\n              action: \\\"created\\\" as const,\\n              performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n            },\\n          ],\\n          notes: [],\\n          createdAt: new Date().toISOString(),\\n          updatedAt: new Date().toISOString(),\\n        }));\\n\\n        // Generate issues for missing fields (checklist items with status \\\"missing\\\")\\n        const missingFieldIssues: EnhancedQualityIssue[] = enhancedItems\\n          .filter((item) => item.status === \\\"missing\\\" && item.isRequired)\\n          .map((item) => ({\\n            id: `issue_missing_field_${item.id}`,\\n            type: \\\"missing\\\" as QualityIssueType,\\n            severity: \\\"warning\\\" as QualityIssueSeverity,\\n            status: \\\"open\\\" as IssueStatus,\\n            title: `Missing: ${item.label}`,\\n            description: `The field \\\"${item.label}\\\" is required but has not been provided. Please fill in this information or upload supporting documents.`,\\n            linkedChecklistItemId: item.id,\\n            linkedFileIds: [],\\n            history: [\\n              {\\n                id: `history_missing_field_${item.id}_created`,\\n                timestamp: new Date().toISOString(),\\n                action: \\\"created\\\" as const,\\n                performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n              },\\n            ],\\n            notes: [],\\n            createdAt: new Date().toISOString(),\\n            updatedAt: new Date().toISOString(),\\n          }));\\n\\n        // Generate issues for missing required evidence\\n        const allRequiredEvidence = Object.values(SECTION_REQUIRED_EVIDENCE).flat();\\n        const missingEvidenceIssues: EnhancedQualityIssue[] = allRequiredEvidence\\n          .filter((ev) => ev.isMandatory && !ev.isUploaded)\\n          .map((ev) => {\\n            // Find a related checklist item in the same section\\n            const sectionType = Object.entries(SECTION_REQUIRED_EVIDENCE)\\n              .find(([, evidenceList]) => evidenceList.some((e) => e.id === ev.id))?.[0] as ChecklistSectionType | undefined;\\n            const relatedItem = enhancedItems.find((item) => item.section === sectionType);\\n\\n            return {\\n              id: `issue_missing_evidence_${ev.id}`,\\n              type: \\\"missing\\\" as QualityIssueType,\\n              severity: \\\"error\\\" as QualityIssueSeverity,\\n              status: \\\"open\\\" as IssueStatus,\\n              title: `Missing Document: ${ev.name}`,\\n              description: ev.description || `The document \\\"${ev.name}\\\" is required but has not been uploaded.`,\\n              suggestedAction: \\\"Upload the required document\\\",\\n              linkedChecklistItemId: relatedItem?.id || enhancedItems[0]?.id || \\\"\\\",\\n              linkedFileIds: [],\\n              history: [\\n                {\\n                  id: `history_missing_evidence_${ev.id}_created`,\\n                  timestamp: new Date().toISOString(),\\n                  action: \\\"created\\\" as const,\\n                  performedBy: { id: \\\"system\\\", name: \\\"System\\\" },\\n                },\\n              ],\\n              notes: [],\\n              createdAt: new Date().toISOString(),\\n              updatedAt: new Date().toISOString(),\\n            };\\n          });\\n\\n        // Combine all issues (filter out duplicates by checking if similar issue exists)\\n        const existingIssueIds = new Set(existingEnhancedIssues.map((i) => i.linkedChecklistItemId));\\n        const filteredMissingFieldIssues = missingFieldIssues.filter(\\n          (i) => !existingIssueIds.has(i.linkedChecklistItemId)\\n        );\\n\\n        const enhancedIssues: EnhancedQualityIssue[] = [\\n          ...existingEnhancedIssues,\\n          ...filteredMissingFieldIssues,\\n          ...missingEvidenceIssues,\\n        ];\\n\\n        set(\\n          {\\n            enhancedChecklistItems: enhancedItems,\\n            enhancedQualityIssues: enhancedIssues,\\n            // Auto-select first item if available\\n            selectedChecklistItemId: enhancedItems.length > 0 ? enhancedItems[0].id : null,\\n          },\\n          false,\\n          \\\"generateEnhancedChecklist\\\"\\n        );\\n      },\\n\\n      // Initialize case from CreateCaseModal data\\n      // Passport is parsed immediately at case creation (not dependent on analysis)\\n      // Case Notes is auto-confirmed, Passport requires confirm review\\n      initializeCaseFromCreation: (data: {\\n        visaType: VisaType;\\n        passport: PassportInfo;\\n        caseNotesFileName: string;\\n        passportFileName: string;\\n        referenceNumber?: string;\\n        advisorId?: string;\\n        assistantId?: string;\\n      }) => {\\n        // Mock case notes summary (would be extracted from uploaded case notes)\\n        const mockCaseNotesSummary: CaseNotesSummary = {\\n          summary: \\\"Client seeking Skilled Worker visa for a Senior Software Engineer position at ACME Technology Ltd. Has previous UK visa history (Tier 4 Student, 2015-2018). Strong financial background with verified savings. Main concern is ensuring CoS documentation is complete.\\\",\\n          clientBackground: \\\"British national currently residing in London. Has worked in tech industry for 8+ years.\\\",\\n          keyDates: [\\\"CoS expected: Feb 2024\\\", \\\"Target application: Mar 2024\\\"],\\n          extractedAt: new Date().toISOString(),\\n        };\\n\\n        // Create files for allFiles store\\n        const caseNotesFileId = `cn_${Date.now()}`;\\n        const passportFileId = `pp_${Date.now()}`;\\n\\n        const newAllFiles: Record<string, DocumentFile> = {\\n          [caseNotesFileId]: {\\n            id: caseNotesFileId,\\n            name: data.caseNotesFileName,\\n            size: \\\"1.2 MB\\\",\\n            pages: 5,\\n            date: \\\"Just now\\\",\\n            type: \\\"pdf\\\",\\n            isNew: false, // Not marked as new since it's auto-confirmed\\n            containerIds: [\\\"case_notes\\\"],\\n          },\\n          [passportFileId]: {\\n            id: passportFileId,\\n            name: data.passportFileName,\\n            size: \\\"0.8 MB\\\",\\n            pages: 1,\\n            date: \\\"Just now\\\",\\n            type: \\\"pdf\\\",\\n            isNew: true,\\n            containerIds: [\\\"passport\\\"],\\n          },\\n        };\\n\\n        // Create document groups - case notes is special (auto-confirmed), passport requires review\\n        const caseNotesGroup: DocumentGroup = {\\n          id: \\\"case_notes\\\",\\n          title: \\\"Case Notes\\\",\\n          tag: \\\"Case Notes\\\",\\n          mergedFileName: data.caseNotesFileName,\\n          status: \\\"reviewed\\\", // Auto-confirmed, no review needed\\n          isSpecial: true, // Special document - doesn't require manual review\\n          fileIds: [caseNotesFileId],\\n          files: [],\\n        };\\n\\n        // Passport document requires confirm review (not isSpecial)\\n        const passportGroup: DocumentGroup = {\\n          id: \\\"passport\\\",\\n          title: \\\"Passport\\\",\\n          tag: \\\"Passport\\\",\\n          mergedFileName: data.passportFileName,\\n          status: \\\"pending\\\", // Requires confirm review\\n          fileIds: [passportFileId],\\n          files: [],\\n        };\\n\\n        // Create empty unclassified group for future uploads\\n        const unclassifiedGroup: DocumentGroup = {\\n          id: \\\"unclassified\\\",\\n          title: \\\"Unclassified\\\",\\n          tag: \\\"unclassified\\\",\\n          status: \\\"pending\\\",\\n          fileIds: [],\\n          files: [],\\n        };\\n\\n        // Client profile includes passport data parsed at creation time\\n        // Passport parsing is immediate, not dependent on analysis\\n        const profileWithPassport = {\\n          passport: data.passport,\\n          completeness: 0,\\n        };\\n        profileWithPassport.completeness = calculateCompleteness(profileWithPassport);\\n\\n        const documentGroups = [unclassifiedGroup, caseNotesGroup, passportGroup];\\n        const previews = syncFilePreviewsFromState(newAllFiles, documentGroups);\\n\\n        set(\\n          {\\n            // Navigation - land on overview page\\n            activeNav: \\\"overview\\\",\\n            selectedVisaType: data.visaType,\\n            clientProfile: profileWithPassport,\\n            caseReference: data.referenceNumber || \\\"REF-2024-001\\\",\\n            caseNotesSummary: mockCaseNotesSummary,\\n            allFiles: newAllFiles,\\n            documentGroups,\\n            uploadedFilePreviews: previews,\\n            // Reset analysis state\\n            lastAnalysisAt: null,\\n            analyzedFileIds: [],\\n            analyzedFiles: [],\\n            isAnalyzingDocuments: false,\\n            analysisProgress: 0,\\n            // Reset questionnaire to trigger case assessment form\\n            questionnaireAnswers: {},\\n            // Reset application phase to analyzing (ready to start analysis)\\n            applicationPhase: \\\"analyzing\\\",\\n            formSchema: null,\\n          },\\n          false,\\n          \\\"initializeCaseFromCreation\\\"\\n        );\\n\\n        // Initialize form schema for the selected visa type\\n        get().initFormSchema(data.visaType);\\n\\n        // Evolve checklist based on new data\\n        get().evolveChecklist();\\n      },\\n\\n      // Reset\\n      reset: () => {\\n        set(initialState, false, \\\"reset\\\");\\n      },\\n    }),\\n    { name: \\\"case-detail-store\\\" },\\n  ),\\n);\\n\\n// Selector hooks for optimized re-renders\\nexport const useActiveNav = () =>\\n  useCaseDetailStore((state) => state.activeNav);\\nexport const useHighlightedGroupId = () =>\\n  useCaseDetailStore((state) => state.highlightedGroupId);\\nexport const useClientProfile = () =>\\n  useCaseDetailStore((state) => state.clientProfile);\\nexport const useCaseNotesSummary = () =>\\n  useCaseDetailStore((state) => state.caseNotesSummary);\\nexport const useSelectedVisaType = () =>\\n  useCaseDetailStore((state) => state.selectedVisaType);\\nexport const useChecklist = () =>\\n  useCaseDetailStore((state) => state.checklist);\\nexport const useChecklistStage = () =>\\n  useCaseDetailStore((state) => state.checklist.stage);\\n// Returns document groups with files resolved from allFiles (backward compatible)\\n// UI components can access group.files directly\\n// Uses separate subscriptions + useMemo to avoid infinite re-render loops\\nexport const useDocumentGroups = () => {\\n  const groups = useCaseDetailStore((state) => state.documentGroups);\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(\\n    () =>\\n      groups.map((group) => ({\\n        ...group,\\n        files: group.fileIds\\n          .map((id) => allFiles[id])\\n          .filter((f): f is DocumentFile => f !== undefined),\\n      })),\\n    [groups, allFiles]\\n  );\\n};\\nexport const useIsLoadingDocuments = () =>\\n  useCaseDetailStore((state) => state.isLoadingDocuments);\\nexport const useUploadedFilePreviews = () =>\\n  useCaseDetailStore((state) => state.uploadedFilePreviews);\\nexport const useApplicationPhase = () =>\\n  useCaseDetailStore((state) => state.applicationPhase);\\nexport const useFormSchema = () =>\\n  useCaseDetailStore((state) => state.formSchema);\\nexport const useFormPilotStatus = () =>\\n  useCaseDetailStore((state) => state.formPilotStatus);\\nexport const useAnalyzedFiles = () =>\\n  useCaseDetailStore((state) => state.analyzedFiles);\\nexport const useApplicationChecklistItems = () =>\\n  useCaseDetailStore((state) => state.applicationChecklistItems);\\nexport const useQualityIssues = () =>\\n  useCaseDetailStore((state) => state.qualityIssues);\\nexport const useQuestionnaireAnswers = () =>\\n  useCaseDetailStore((state) => state.questionnaireAnswers);\\nexport const useChecklistSectionExpanded = () =>\\n  useCaseDetailStore((state) => state.checklistSectionExpanded);\\n\\n// Enhanced Checklist Workspace Selectors\\nexport const useEnhancedChecklistItems = () =>\\n  useCaseDetailStore((state) => state.enhancedChecklistItems);\\nexport const useEnhancedQualityIssues = () =>\\n  useCaseDetailStore((state) => state.enhancedQualityIssues);\\nexport const useSelectedChecklistItemId = () =>\\n  useCaseDetailStore((state) => state.selectedChecklistItemId);\\nexport const useSelectedIssueId = () =>\\n  useCaseDetailStore((state) => state.selectedIssueId);\\nexport const useForwardModalOpen = () =>\\n  useCaseDetailStore((state) => state.forwardModalOpen);\\nexport const useForwardModalIssueId = () =>\\n  useCaseDetailStore((state) => state.forwardModalIssueId);\\n\\n// Get selected checklist item with its issues\\nexport const useSelectedChecklistItem = () =>\\n  useCaseDetailStore((state) => {\\n    if (!state.selectedChecklistItemId) return null;\\n    return state.enhancedChecklistItems.find(\\n      (item) => item.id === state.selectedChecklistItemId\\n    ) || null;\\n  });\\n\\n// Get issues for selected checklist item - memoized to prevent infinite loops\\nexport const useIssuesForSelectedItem = () => {\\n  const selectedChecklistItemId = useCaseDetailStore(\\n    (state) => state.selectedChecklistItemId\\n  );\\n  const enhancedQualityIssues = useCaseDetailStore(\\n    (state) => state.enhancedQualityIssues\\n  );\\n\\n  return useMemo(() => {\\n    if (!selectedChecklistItemId) return [];\\n    return enhancedQualityIssues.filter(\\n      (issue) => issue.linkedChecklistItemId === selectedChecklistItemId\\n    );\\n  }, [selectedChecklistItemId, enhancedQualityIssues]);\\n};\\n\\n// Get issue counts by severity - memoized to prevent infinite loops\\nexport const useIssueCounts = () => {\\n  const enhancedQualityIssues = useCaseDetailStore(\\n    (state) => state.enhancedQualityIssues\\n  );\\n\\n  return useMemo(() => {\\n    const issues = enhancedQualityIssues.filter(\\n      (issue) => issue.status !== \\\"resolved\\\"\\n    );\\n    return {\\n      errors: issues.filter((i) => i.severity === \\\"error\\\").length,\\n      warnings: issues.filter((i) => i.severity === \\\"warning\\\").length,\\n      info: issues.filter((i) => i.severity === \\\"info\\\").length,\\n      total: issues.length,\\n    };\\n  }, [enhancedQualityIssues]);\\n};\\n\\n// Selector to detect if there are new ready files since the last analysis\\n// Only triggers when NEW files are confirmed (ready), not when files become pending\\nexport const useHasNewFilesAfterAnalysis = () =>\\n  useCaseDetailStore((state) => {\\n    // Only check if analysis has been completed\\n    if (!state.lastAnalysisAt) return false;\\n\\n    // Get all file IDs from reviewed groups (excluding unclassified and removed)\\n    const currentReviewedFileIds = state.documentGroups\\n      .filter((g) => g.id !== \\\"unclassified\\\" && g.status === \\\"reviewed\\\")\\n      .flatMap((g) => getContainerFiles(state.allFiles, g).map((f) => f.id));\\n\\n    const analyzedFileIds = state.analyzedFileIds;\\n\\n    // Only check for NEW ready files - files that are reviewed but weren't analyzed\\n    // Don't trigger for removals (e.g., when a group goes from reviewed to pending)\\n    const hasNewReadyFiles = currentReviewedFileIds.some(\\n      (id) => !analyzedFileIds.includes(id)\\n    );\\n\\n    return hasNewReadyFiles;\\n  });\\n\\n// Returns the count of new ready document groups that have unanalyzed files\\nexport const useNewFilesCount = () =>\\n  useCaseDetailStore((state) => {\\n    if (!state.lastAnalysisAt) return 0;\\n\\n    const analyzedFileIds = state.analyzedFileIds;\\n\\n    // Count document groups that have at least one new unanalyzed file\\n    const groupsWithNewFiles = state.documentGroups.filter((g) => {\\n      if (g.id === \\\"unclassified\\\" || g.status !== \\\"reviewed\\\") return false;\\n\\n      // Check if this group has any files that weren't analyzed\\n      const activeFiles = getContainerFiles(state.allFiles, g);\\n      return activeFiles.some((f) => !analyzedFileIds.includes(f.id));\\n    });\\n\\n    return groupsWithNewFiles.length;\\n  });\\n\\n// ============================================================================\\n// One-to-Many Model Selectors\\n// ============================================================================\\n\\n// Get all files from the central store\\nexport const useAllFiles = () =>\\n  useCaseDetailStore((state) => state.allFiles);\\n\\n// Get unclassified files (files with no container associations)\\nexport const useUnclassifiedFiles = () => {\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(\\n    () =>\\n      Object.values(allFiles).filter(\\n        (f) => !f.isRemoved && f.containerIds.length === 0\\n      ),\\n    [allFiles]\\n  );\\n};\\n\\n// Get files for a specific container/group\\nexport const useContainerFiles = (containerId: string) => {\\n  const groups = useCaseDetailStore((state) => state.documentGroups);\\n  const allFiles = useCaseDetailStore((state) => state.allFiles);\\n  return useMemo(() => {\\n    const group = groups.find((g) => g.id === containerId);\\n    if (!group) return [];\\n    return group.fileIds\\n      .map((id) => allFiles[id])\\n      .filter((f): f is DocumentFile => f !== undefined && !f.isRemoved);\\n  }, [groups, allFiles, containerId]);\\n};\\n\\n// Get the number of containers a file is in (for showing linked badge)\\nexport const useFileContainerCount = (fileId: string) =>\\n  useCaseDetailStore((state) => {\\n    const file = state.allFiles[fileId];\\n    return file?.containerIds.length ?? 0;\\n  });\\n\\n// Check if a file is in multiple containers (shared/reused)\\nexport const useIsFileShared = (fileId: string) =>\\n  useCaseDetailStore((state) => {\\n    const file = state.allFiles[fileId];\\n    return (file?.containerIds.length ?? 0) > 1;\\n  });\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 4061,\n      \"oldLines\": 9,\n      \"newStart\": 4061,\n      \"newLines\": 9,\n      \"lines\": [\n        \"           other: [],\",\n        \"         };\",\n        \" \",\n        \"-        // Get required evidence for a section\",\n        \"+        // Get required evidence for a section (with auto-linking applied)\",\n        \"         const getRequiredEvidence = (section: ChecklistSectionType): RequiredEvidence[] => {\",\n        \"-          return SECTION_REQUIRED_EVIDENCE[section] || [];\",\n        \"+          return (SECTION_REQUIRED_EVIDENCE[section] || []).map(autoLinkEvidence);\",\n        \"         };\",\n        \" \",\n        \"         // Convert existing checklist items to enhanced format\"\n      ]\n    }\n  ],\n  \"userModified\": false,\n  \"replaceAll\": false\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Edit","category":"native"},"isError":false,"turnId":"msg_01HHPzMDKsJPo7c6VCQLJhdv"}
{"id":"msg-1769669188493-d650av","type":"tool","content":"{\n  \"oldTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ],\n  \"newTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ]\n}","timestamp":1769669188493,"toolName":"TodoWrite","toolUseId":"toolu_017F1JxbBd2BqLUNNyPNA4qb","toolInput":{"todos":[{"content":"Store: Add auto-mapping logic in generateEnhancedChecklist()","status":"completed","activeForm":"Adding auto-mapping logic in store"},{"content":"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard","status":"in_progress","activeForm":"Updating SummaryFieldsCard rendering"},{"content":"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection","status":"pending","activeForm":"Updating SummarySection rendering"}]},"toolResult":"{\n  \"oldTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ],\n  \"newTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ]\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Update Todos","category":"native"},"isError":false,"turnId":"msg_01MUnbKz8GqCnyU6qRsx5Vtg"}
{"id":"msg-1769669194954-85w08q","type":"tool","content":"Error: File has not been read yet. Read it first before writing to it.","timestamp":1769669194954,"toolName":"Edit","toolUseId":"toolu_01Jvy8KnDvjgujLCyJMKNxPo","toolInput":{"replace_all":false,"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","old_string":"            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\n            <div className=\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\">\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\n                  <button\n                    key={ev.id}\n                    onClick={() => onReferenceDocClick(ev)}\n                    className=\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\"\n                  >\n                    <FileText className=\"size-4 text-blue-500\" />\n                    <span className=\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\">\n                      {ev.linkedFileName || ev.name}\n                    </span>\n                  </button>\n                ))\n              ) : (\n                <span className=\"text-xs text-stone-400 leading-[30px]\">No documents uploaded</span>\n              )}\n            </div>","new_string":"            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\n            <div className=\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\">\n              {referenceEvidence.length > 0 ? (\n                referenceEvidence.map((ev) => (\n                  <button\n                    key={ev.id}\n                    onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\n                    className={cn(\n                      \"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\",\n                      ev.isUploaded\n                        ? \"border-stone-200 bg-white hover:border-blue-300\"\n                        : \"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\"\n                    )}\n                  >\n                    {ev.isUploaded ? (\n                      <FileText className=\"size-4 text-blue-500\" />\n                    ) : (\n                      <Upload className=\"size-3.5 text-stone-400\" />\n                    )}\n                    <span className={cn(\n                      \"text-xs font-medium truncate max-w-[120px]\",\n                      ev.isUploaded\n                        ? \"text-stone-700 group-hover:text-blue-700\"\n                        : \"text-stone-400\"\n                    )}>\n                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\n                    </span>\n                  </button>\n                ))\n              ) : (\n                <span className=\"text-xs text-stone-400 leading-[30px]\">No documents required</span>\n              )}\n            </div>"},"toolResult":"Error: File has not been read yet. Read it first before writing to it.","toolStatus":"completed","toolDisplayMeta":{"displayName":"Edit","category":"native"},"isError":true,"turnId":"msg_0129pCPbAvXjutp8DJDCQiMJ"}
{"id":"msg-1769669206031-hr61so","type":"assistant","content":"Now update the two rendering locations in OverviewTab. First, `SummaryFieldsCard` (line 308-325):","timestamp":1769669206031,"isIntermediate":true,"turnId":"msg_0129pCPbAvXjutp8DJDCQiMJ"}
{"id":"msg-1769669210658-hum657","type":"tool","content":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"\\\"use client\\\";\\n\\nimport { useMemo, useState, useEffect, useRef, Fragment } from \\\"react\\\";\\nimport {\\n  CheckCircle2,\\n  FileText,\\n  Paperclip,\\n  Check,\\n  AlertTriangle,\\n  Plus,\\n  Sparkles,\\n  Upload,\\n  PenLine,\\n  Loader2,\\n} from \\\"lucide-react\\\";\\nimport { cn } from \\\"@/lib/utils\\\";\\nimport {\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  RequiredEvidence,\\n  DocumentGroup,\\n} from \\\"@/types/case-detail\\\";\\nimport { DocumentUploadModal } from \\\"./DocumentUploadModal\\\";\\nimport { CategoryReviewModal } from \\\"@/components/case-detail/shared/CategoryReviewModal\\\";\\nimport type { DetailTabId } from \\\"./ItemDetailTabs\\\";\\n\\n// Assessment field interface\\ninterface AssessmentField {\\n  id: string;\\n  label: string;\",\n    \"numLines\": 30,\n    \"startLine\": 1,\n    \"totalLines\": 1292\n  }\n}","timestamp":1769669210658,"toolName":"Read","toolUseId":"toolu_012xpv14c6q89Gj8vjmuCM5Y","toolInput":{"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","offset":1,"limit":30},"toolResult":"{\n  \"type\": \"text\",\n  \"file\": {\n    \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n    \"content\": \"\\\"use client\\\";\\n\\nimport { useMemo, useState, useEffect, useRef, Fragment } from \\\"react\\\";\\nimport {\\n  CheckCircle2,\\n  FileText,\\n  Paperclip,\\n  Check,\\n  AlertTriangle,\\n  Plus,\\n  Sparkles,\\n  Upload,\\n  PenLine,\\n  Loader2,\\n} from \\\"lucide-react\\\";\\nimport { cn } from \\\"@/lib/utils\\\";\\nimport {\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  RequiredEvidence,\\n  DocumentGroup,\\n} from \\\"@/types/case-detail\\\";\\nimport { DocumentUploadModal } from \\\"./DocumentUploadModal\\\";\\nimport { CategoryReviewModal } from \\\"@/components/case-detail/shared/CategoryReviewModal\\\";\\nimport type { DetailTabId } from \\\"./ItemDetailTabs\\\";\\n\\n// Assessment field interface\\ninterface AssessmentField {\\n  id: string;\\n  label: string;\",\n    \"numLines\": 30,\n    \"startLine\": 1,\n    \"totalLines\": 1292\n  }\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Read","category":"native"},"isError":false,"turnId":"msg_014dLuLPB8Ny2tQzbS2cLXjY"}
{"id":"msg-1769669217745-hjb5ot","type":"tool","content":"{\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n  \"oldString\": \"            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => onReferenceDocClick(ev)}\\n                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\\n                  >\\n                    <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\\n              )}\\n            </div>\",\n  \"newString\": \"            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.length > 0 ? (\\n                referenceEvidence.map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\\n                    className={cn(\\n                      \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\\n                      ev.isUploaded\\n                        ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\\n                    )}\\n                  >\\n                    {ev.isUploaded ? (\\n                      <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    ) : (\\n                      <Upload className=\\\"size-3.5 text-stone-400\\\" />\\n                    )}\\n                    <span className={cn(\\n                      \\\"text-xs font-medium truncate max-w-[120px]\\\",\\n                      ev.isUploaded\\n                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\\n                        : \\\"text-stone-400\\\"\\n                    )}>\\n                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents required</span>\\n              )}\\n            </div>\",\n  \"originalFile\": \"\\\"use client\\\";\\n\\nimport { useMemo, useState, useEffect, useRef, Fragment } from \\\"react\\\";\\nimport {\\n  CheckCircle2,\\n  FileText,\\n  Paperclip,\\n  Check,\\n  AlertTriangle,\\n  Plus,\\n  Sparkles,\\n  Upload,\\n  PenLine,\\n  Loader2,\\n} from \\\"lucide-react\\\";\\nimport { cn } from \\\"@/lib/utils\\\";\\nimport {\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  RequiredEvidence,\\n  DocumentGroup,\\n} from \\\"@/types/case-detail\\\";\\nimport { DocumentUploadModal } from \\\"./DocumentUploadModal\\\";\\nimport { CategoryReviewModal } from \\\"@/components/case-detail/shared/CategoryReviewModal\\\";\\nimport type { DetailTabId } from \\\"./ItemDetailTabs\\\";\\n\\n// Assessment field interface\\ninterface AssessmentField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  type: \\\"text\\\" | \\\"select\\\" | \\\"radio\\\";\\n  options?: { value: string; label: string }[];\\n  isRequired: boolean;\\n  isConditional?: boolean;\\n  dependsOn?: { fieldId: string; value: string };\\n  description?: string;\\n}\\n\\n// Field for display (includes both completed and missing)\\ninterface DisplayField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  sourceDocumentName?: string; // Name of the reference document this was extracted from\\n  status: \\\"complete\\\" | \\\"missing\\\" | \\\"low_confidence\\\";\\n  fieldType?: \\\"text\\\" | \\\"select\\\" | \\\"date\\\";\\n  options?: { value: string; label: string }[];\\n  confidenceScore?: number;\\n}\\n\\n// Props types\\ninterface ChecklistOverviewProps {\\n  itemType: \\\"checklist\\\";\\n  items: EnhancedChecklistItem[];\\n  issues: EnhancedQualityIssue[];\\n  formValues: Record<string, string>;\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\ninterface AssessmentOverviewProps {\\n  itemType: \\\"assessment\\\";\\n  fields: AssessmentField[];\\n  formValues: Record<string, string>;\\n  requiredEvidence: RequiredEvidence[];\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\nexport type OverviewTabProps = ChecklistOverviewProps | AssessmentOverviewProps;\\n\\n// ============================================================================\\n// Circular Progress Ring Component\\n// ============================================================================\\nfunction ProgressRing({\\n  percent,\\n  isComplete,\\n  size = 56,\\n}: {\\n  percent: number;\\n  isComplete: boolean;\\n  size?: number;\\n}) {\\n  const strokeWidth = 5;\\n  const radius = (size - strokeWidth) / 2;\\n  const circumference = 2 * Math.PI * radius;\\n  const strokeDashoffset = circumference - (percent / 100) * circumference;\\n\\n  return (\\n    <div className=\\\"relative shrink-0\\\" style={{ width: size, height: size }}>\\n      <svg className=\\\"-rotate-90\\\" width={size} height={size}>\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          className=\\\"text-stone-200\\\"\\n        />\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          strokeLinecap=\\\"round\\\"\\n          strokeDasharray={circumference}\\n          strokeDashoffset={strokeDashoffset}\\n          className={isComplete ? \\\"text-emerald-500\\\" : \\\"text-amber-500\\\"}\\n        />\\n      </svg>\\n      <div className=\\\"absolute inset-0 flex items-center justify-center\\\">\\n        {isComplete ? (\\n          <CheckCircle2 className=\\\"size-6 text-emerald-500\\\" />\\n        ) : (\\n          <span className=\\\"text-sm font-bold text-stone-700 tabular-nums\\\">{percent}%</span>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Reference Document Item - Shows doc name and analysis time\\n// ============================================================================\\nfunction ReferenceDocItem({\\n  evidence,\\n  analyzedAt,\\n  onClick,\\n}: {\\n  evidence: RequiredEvidence;\\n  analyzedAt?: string;\\n  onClick: () => void;\\n}) {\\n  const displayName = evidence.name.length > 14 ? evidence.name.slice(0, 14) + \\\"...\\\" : evidence.name;\\n\\n  // Format time ago\\n  const getTimeAgo = (dateStr?: string) => {\\n    if (!dateStr) return null;\\n    // For demo, just show a static time\\n    return \\\"2h ago\\\";\\n  };\\n\\n  return (\\n    <button\\n      onClick={onClick}\\n      className=\\\"w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-left hover:bg-stone-100 transition-colors\\\"\\n    >\\n      <FileText className=\\\"size-3.5 text-blue-500 shrink-0\\\" />\\n      <span className=\\\"text-xs font-medium text-stone-700 truncate flex-1\\\">\\n        {displayName}\\n      </span>\\n      {analyzedAt && (\\n        <span className=\\\"text-[10px] text-stone-400 shrink-0\\\">\\n          {getTimeAgo(analyzedAt)}\\n        </span>\\n      )}\\n    </button>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Summary + Fields Card Component\\n// ============================================================================\\nfunction SummaryFieldsCard({\\n  status,\\n  totalFields,\\n  completedFields,\\n  fields,\\n  formValues,\\n  referenceEvidence,\\n  isAnalyzing,\\n  onFieldChange,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  referenceEvidence: RequiredEvidence[];\\n  isAnalyzing: boolean;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const [pendingChanges, setPendingChanges] = useState<Record<string, string>>({});\\n  const [manuallyEditedFields, setManuallyEditedFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\n\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  // Check if there are pending changes\\n  const pendingFieldIds = Object.keys(pendingChanges).filter(\\n    (id) => pendingChanges[id] && pendingChanges[id].trim() !== \\\"\\\"\\n  );\\n  const hasPendingChanges = pendingFieldIds.length > 0;\\n\\n  // Handle local field change (store in pending, don't submit yet)\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    setPendingChanges((prev) => ({ ...prev, [fieldId]: value }));\\n    setManuallyEditedFields((prev) => new Set(prev).add(fieldId));\\n  };\\n\\n  // Submit all pending changes\\n  const handleSubmit = async () => {\\n    if (!hasPendingChanges) return;\\n    setIsSubmitting(true);\\n\\n    // Submit each pending change\\n    for (const fieldId of pendingFieldIds) {\\n      onFieldChange(fieldId, pendingChanges[fieldId]);\\n    }\\n\\n    // Clear pending changes after a brief delay for animation\\n    setTimeout(() => {\\n      setPendingChanges({});\\n      setIsSubmitting(false);\\n    }, 500);\\n  };\\n\\n  // Cancel pending changes\\n  const handleCancel = () => {\\n    setPendingChanges({});\\n    setManuallyEditedFields(new Set());\\n  };\\n\\n  // Get source badge\\n  const getSourceBadge = (field: DisplayField) => {\\n    if (field.source === \\\"extracted\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center px-1.5 py-0.5 text-[9px] font-medium text-blue-700 bg-blue-50 rounded\\\">\\n          Extracted\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"manual\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n          <PenLine className=\\\"size-2\\\" />\\n          Manual\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"questionnaire\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-stone-600 bg-stone-100 rounded\\\">\\n          Questionnaire\\n        </span>\\n      );\\n    }\\n    return null;\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden flex flex-col flex-1 min-h-0\\\">\\n      {/* Header - Fixed height with Reference Documents */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-4\\\">\\n          {/* Left - Progress Summary */}\\n          <div className=\\\"shrink-0 flex items-center gap-3\\\">\\n            <ProgressRing percent={percent} isComplete={isComplete} size={48} />\\n            <div>\\n              <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Application Fields</h3>\\n              <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n                {completedFields} of {totalFields} completed\\n              </p>\\n            </div>\\n          </div>\\n\\n          {/* Divider */}\\n          <div className=\\\"w-px self-stretch bg-stone-200 shrink-0\\\" />\\n\\n          {/* Right - Reference Documents (vertical layout) */}\\n          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\\n                onClick={onUploadClick}\\n                className=\\\"shrink-0 inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-md transition-colors\\\"\\n              >\\n                <Plus className=\\\"size-3\\\" />\\n                Add\\n              </button>\\n            </div>\\n            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => onReferenceDocClick(ev)}\\n                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\\n                  >\\n                    <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\\n              )}\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n\\n      {/* Scrollable Content - min-h-0 is critical for flex overflow to work */}\\n      <div className=\\\"flex-1 min-h-0 p-4 overflow-y-auto\\\">\\n        {/* Fields Section Header */}\\n        <div className=\\\"flex items-center justify-between mb-3\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <h4 className=\\\"text-xs font-medium text-stone-600\\\">Fields</h4>\\n            {missingFields.length > 0 && !showAllFields && (\\n              <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n                {missingFields.length} missing\\n              </span>\\n            )}\\n          </div>\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? \\\"Show unanswered\\\" : \\\"Show all\\\"}\\n          </button>\\n        </div>\\n\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All fields have been filled</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2\\\">\\n            {displayFields.map((field) => {\\n              // Use pending value if exists, otherwise use stored value\\n              const storedValue = formValues[field.id] || field.value || \\\"\\\";\\n              const currentValue = pendingChanges[field.id] !== undefined ? pendingChanges[field.id] : storedValue;\\n              const hasPendingValue = pendingChanges[field.id] !== undefined && pendingChanges[field.id].trim() !== \\\"\\\";\\n              const isMissing = field.status === \\\"missing\\\" && !hasPendingValue;\\n              const isCompleted = !isMissing && (currentValue || hasPendingValue);\\n              // Check if user has manually entered/edited this field in this session\\n              const isManuallyEdited = manuallyEditedFields.has(field.id);\\n\\n              // Determine which badge to show\\n              const renderSourceBadge = () => {\\n                if (hasPendingValue) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-amber-700 bg-amber-100 rounded\\\">\\n                      Pending\\n                    </span>\\n                  );\\n                }\\n                if (isManuallyEdited) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n                      <PenLine className=\\\"size-2\\\" />\\n                      Manual\\n                    </span>\\n                  );\\n                }\\n                return getSourceBadge(field);\\n              };\\n\\n              return (\\n                <div\\n                  key={field.id}\\n                  className={cn(\\n                    \\\"p-2.5 rounded-lg border transition-colors\\\",\\n                    hasPendingValue\\n                      ? \\\"border-blue-200 bg-blue-50/30\\\"\\n                      : isMissing\\n                        ? \\\"border-amber-200 bg-amber-50/50\\\"\\n                        : \\\"border-stone-100 bg-stone-50/30\\\"\\n                  )}\\n                >\\n                  <div className=\\\"flex items-center gap-2 mb-1.5\\\">\\n                    {isCompleted ? (\\n                      <CheckCircle2 className={cn(\\n                        \\\"size-3.5 shrink-0\\\",\\n                        hasPendingValue ? \\\"text-blue-500\\\" : \\\"text-emerald-500\\\"\\n                      )} />\\n                    ) : (\\n                      <div className=\\\"size-3.5 rounded-full border-2 border-amber-400 shrink-0\\\" />\\n                    )}\\n                    <label className={cn(\\n                      \\\"text-xs font-medium truncate flex-1\\\",\\n                      isMissing ? \\\"text-stone-700\\\" : \\\"text-stone-500\\\"\\n                    )}>\\n                      {field.label}\\n                    </label>\\n                    {renderSourceBadge()}\\n                  </div>\\n\\n                  {/* All fields are editable */}\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Footer - shows when there are pending changes */}\\n      {hasPendingChanges && (\\n        <div className=\\\"shrink-0 px-4 py-3 border-t border-stone-100 flex items-center justify-between bg-stone-50/50\\\">\\n          <p className=\\\"text-xs text-stone-500 tabular-nums\\\">\\n            {pendingFieldIds.length} field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"} pending\\n          </p>\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <button\\n              onClick={handleCancel}\\n              disabled={isSubmitting}\\n              className=\\\"px-3 py-1.5 text-xs font-medium text-stone-600 hover:text-stone-800 hover:bg-stone-100 rounded-lg transition-colors disabled:opacity-50\\\"\\n            >\\n              Cancel\\n            </button>\\n            <button\\n              onClick={handleSubmit}\\n              disabled={isSubmitting}\\n              className=\\\"px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors flex items-center gap-1.5 disabled:opacity-50\\\"\\n            >\\n              {isSubmitting ? (\\n                <>\\n                  <Loader2 className=\\\"size-3.5 animate-spin\\\" />\\n                  Saving...\\n                </>\\n              ) : (\\n                <>\\n                  <Check className=\\\"size-3.5\\\" />\\n                  Save {pendingFieldIds.length} Field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"}\\n                </>\\n              )}\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Original Summary Section Component (for non-employment sections)\\n// ============================================================================\\nfunction SummarySection({\\n  status,\\n  totalFields,\\n  completedFields,\\n  referenceEvidence,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  referenceEvidence: RequiredEvidence[];\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden\\\">\\n      <div className=\\\"flex items-stretch\\\">\\n        {/* Left - Progress Summary */}\\n        <div className=\\\"shrink-0 p-4 flex items-center gap-4 border-r border-stone-100\\\">\\n          <ProgressRing percent={percent} isComplete={isComplete} size={56} />\\n          <div>\\n            <span\\n              className={cn(\\n                \\\"inline-flex items-center px-2 py-1 text-xs font-semibold rounded-md\\\",\\n                isComplete\\n                  ? \\\"bg-emerald-100 text-emerald-700\\\"\\n                  : \\\"bg-amber-100 text-amber-700\\\"\\n              )}\\n            >\\n              {isComplete ? \\\"Complete\\\" : \\\"In Progress\\\"}\\n            </span>\\n            <p className=\\\"text-sm font-medium text-stone-700 mt-1.5 tabular-nums\\\">\\n              {completedFields}/{totalFields} fields\\n            </p>\\n          </div>\\n        </div>\\n\\n        {/* Right - Reference Documents (flexible width) */}\\n        <div className=\\\"flex-1 p-4\\\">\\n          {/* Header */}\\n          <div className=\\\"flex items-center justify-between mb-3\\\">\\n            <div>\\n              <h4 className=\\\"text-xs font-semibold text-stone-700 text-balance\\\">Reference Documents</h4>\\n              <p className=\\\"text-[10px] text-stone-400 text-pretty\\\">Source files for data extraction</p>\\n            </div>\\n            <button\\n              onClick={onUploadClick}\\n              className=\\\"inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-lg transition-colors\\\"\\n            >\\n              <Plus className=\\\"size-3.5\\\" />\\n              Add\\n            </button>\\n          </div>\\n\\n          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Missing Information Card - Shows fields that still need to be completed\\n// ============================================================================\\nfunction MissingInformationCard({\\n  fields,\\n  formValues,\\n  onFieldChange,\\n  onViewMore,\\n}: {\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onViewMore?: () => void;\\n}) {\\n  const [savingFields, setSavingFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n\\n  // Filter to only show missing fields\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const completedCount = fields.length - missingFields.length;\\n\\n  // Fields to display based on toggle\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    onFieldChange(fieldId, value);\\n    setSavingFields((prev) => new Set(prev).add(fieldId));\\n    setTimeout(() => {\\n      setSavingFields((prev) => {\\n        const next = new Set(prev);\\n        next.delete(fieldId);\\n        return next;\\n      });\\n    }, 1000);\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      <div className=\\\"px-4 py-3 border-b border-stone-100 flex items-center justify-between\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Missing Information</h3>\\n          {missingFields.length > 0 && (\\n            <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n              {missingFields.length}\\n            </span>\\n          )}\\n        </div>\\n        {/* Toggle between showing missing only vs all fields */}\\n        {completedCount > 0 && (\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? (missingFields.length > 0 ? \\\"Show unanswered\\\" : \\\"Hide all\\\") : \\\"Show all\\\"}\\n          </button>\\n        )}\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All information has been provided</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2.5\\\">\\n            {displayFields.slice(0, showAllFields ? undefined : 6).map((field) => {\\n              const currentValue = formValues[field.id] || field.value || \\\"\\\";\\n              const isSaving = savingFields.has(field.id);\\n              const isCompleted = field.status !== \\\"missing\\\";\\n\\n              return (\\n                <div key={field.id} className=\\\"space-y-1.5\\\">\\n                  <div className=\\\"flex items-center gap-2\\\">\\n                    <div className={cn(\\n                      \\\"size-3.5 rounded-full border-2 shrink-0\\\",\\n                      isCompleted ? \\\"bg-emerald-500 border-emerald-500\\\" : \\\"border-amber-400\\\"\\n                    )} />\\n                    <label className=\\\"text-xs font-medium text-stone-600 truncate flex-1\\\">\\n                      {field.label}\\n                    </label>\\n                    {isSaving && (\\n                      <span className=\\\"inline-flex items-center gap-0.5 px-1 py-0.5 text-[9px] font-medium text-emerald-700 bg-emerald-100 rounded\\\">\\n                        <Check className=\\\"size-2\\\" />\\n                        Saved\\n                      </span>\\n                    )}\\n                  </div>\\n\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\"\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\"\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Evidence Slot - Shows grouped document requirements\\n// ============================================================================\\nfunction CombinedEvidenceSlotInline({\\n  title,\\n  relationship,\\n  documents,\\n  onAddClick,\\n}: {\\n  title: string;\\n  relationship: \\\"all\\\" | \\\"any\\\";\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n}) {\\n  const uploadedCount = documents.filter(d => d.isUploaded).length;\\n  const totalCount = documents.length;\\n  const isComplete = relationship === \\\"all\\\"\\n    ? uploadedCount === totalCount\\n    : uploadedCount >= 1;\\n\\n  return (\\n    <div className={cn(\\n      \\\"rounded-xl border-2 overflow-hidden transition-all\\\",\\n      isComplete\\n        ? \\\"border-emerald-300 bg-gradient-to-b from-emerald-50 to-white shadow-sm\\\"\\n        : \\\"border-stone-200 bg-white\\\"\\n    )}>\\n      {/* Header */}\\n      <div className={cn(\\n        \\\"px-3 py-2.5 border-b\\\",\\n        isComplete ? \\\"border-emerald-200 bg-emerald-50\\\" : \\\"border-stone-100 bg-stone-50\\\"\\n      )}>\\n        <div className=\\\"flex items-center justify-between\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            {isComplete && (\\n              <CheckCircle2 className=\\\"size-4 text-emerald-500\\\" />\\n            )}\\n            <span className={cn(\\n              \\\"text-xs font-semibold\\\",\\n              isComplete ? \\\"text-emerald-700\\\" : \\\"text-stone-700\\\"\\n            )}>\\n              {title}\\n            </span>\\n            {/* Relationship badge */}\\n            <span className={cn(\\n              \\\"px-1.5 py-0.5 text-[9px] font-bold uppercase rounded\\\",\\n              isComplete\\n                ? \\\"bg-emerald-200 text-emerald-700\\\"\\n                : relationship === \\\"all\\\"\\n                  ? \\\"bg-stone-200 text-stone-600\\\"\\n                  : \\\"bg-blue-100 text-blue-600\\\"\\n            )}>\\n              {isComplete ? \\\"Complete\\\" : relationship === \\\"all\\\" ? \\\"All required\\\" : \\\"Any one\\\"}\\n            </span>\\n          </div>\\n          <span className={cn(\\n            \\\"text-[10px] font-semibold tabular-nums\\\",\\n            isComplete ? \\\"text-emerald-600\\\" : \\\"text-stone-500\\\"\\n          )}>\\n            {uploadedCount}/{totalCount}\\n          </span>\\n        </div>\\n      </div>\\n\\n      {/* Document slots - horizontal flex layout */}\\n      <div className=\\\"p-3\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          {documents.map((doc, idx) => (\\n            <Fragment key={doc.id}>\\n              {/* Slot - flex-1 for equal width, fixed height */}\\n              <button\\n                onClick={() => onAddClick(doc)}\\n                className={cn(\\n                  \\\"flex-1 min-w-0 h-24 rounded-lg border-2 transition-all flex flex-col items-center justify-center gap-2 px-2\\\",\\n                  doc.isUploaded\\n                    ? \\\"border-emerald-300 bg-emerald-50 hover:border-emerald-400 hover:shadow-sm\\\"\\n                    : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100\\\"\\n                )}\\n              >\\n                {doc.isUploaded ? (\\n                  <>\\n                    {/* Uploaded state - document preview style */}\\n                    <div className=\\\"relative\\\">\\n                      <div className=\\\"w-10 h-12 rounded bg-white border border-emerald-200 shadow-sm flex flex-col p-1.5 gap-0.5\\\">\\n                        <div className=\\\"h-0.5 bg-emerald-300 rounded w-2/3\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-4/5\\\" />\\n                      </div>\\n                      <div className=\\\"absolute -top-1 -right-1 size-4 rounded-full bg-emerald-500 flex items-center justify-center\\\">\\n                        <Check className=\\\"size-2.5 text-white\\\" strokeWidth={3} />\\n                      </div>\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-emerald-700 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.linkedFileName || doc.name}\\n                    </span>\\n                  </>\\n                ) : (\\n                  <>\\n                    {/* Empty state */}\\n                    <div className=\\\"size-10 rounded-lg bg-white border-2 border-dashed border-stone-300 flex items-center justify-center\\\">\\n                      <Upload className=\\\"size-4 text-stone-400\\\" />\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-stone-500 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.name}\\n                    </span>\\n                  </>\\n                )}\\n              </button>\\n\\n              {/* Connector between slots */}\\n              {idx < documents.length - 1 && (\\n                <div className=\\\"shrink-0 flex items-center justify-center\\\">\\n                  <span className={cn(\\n                    \\\"px-2 py-1 text-[9px] font-bold rounded-full\\\",\\n                    isComplete\\n                      ? \\\"bg-emerald-100 text-emerald-600\\\"\\n                      : relationship === \\\"all\\\"\\n                        ? \\\"bg-stone-100 text-stone-500\\\"\\n                        : \\\"bg-blue-50 text-blue-500\\\"\\n                  )}>\\n                    {relationship === \\\"all\\\" ? \\\"+\\\" : \\\"or\\\"}\\n                  </span>\\n                </div>\\n              )}\\n            </Fragment>\\n          ))}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Supporting Documents Card - Shows all document slots as cards\\n// ============================================================================\\nfunction SupportingDocumentsCard({\\n  documents,\\n  onAddClick,\\n  onViewMore,\\n}: {\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n  onViewMore?: () => void;\\n}) {\\n  // Group documents by type for combined evidence slots\\n  const groupedDocs = useMemo(() => {\\n    // Check if we have bank statements and payslip - combine them as Financial Evidence\\n    const bankStatements = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"bank statement\\\")\\n    );\\n    const payslip = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"payslip\\\")\\n    );\\n\\n    // If we have both bank statements and payslip, group them\\n    if (bankStatements && payslip) {\\n      const financialGroup = {\\n        title: \\\"Financial Evidence\\\",\\n        relationship: \\\"all\\\" as const, // Both bank statements AND payslip required\\n        documents: [bankStatements, payslip],\\n      };\\n\\n      // Get remaining standalone documents\\n      const groupedIds = new Set([bankStatements.id, payslip.id]);\\n      const standalone = documents.filter(d => !groupedIds.has(d.id));\\n\\n      return { groups: [financialGroup], standalone };\\n    }\\n\\n    // No grouping needed\\n    return { groups: [], standalone: documents };\\n  }, [documents]);\\n\\n  // Calculate counts treating combined groups as single items\\n  const counts = useMemo(() => {\\n    // Total = number of groups + number of standalone docs\\n    const totalCount = groupedDocs.groups.length + groupedDocs.standalone.length;\\n\\n    // Uploaded count for groups (based on relationship)\\n    const uploadedGroups = groupedDocs.groups.filter(group => {\\n      const uploadedInGroup = group.documents.filter(d => d.isUploaded).length;\\n      if (group.relationship === \\\"all\\\") {\\n        return uploadedInGroup === group.documents.length;\\n      } else {\\n        return uploadedInGroup >= 1;\\n      }\\n    }).length;\\n\\n    // Uploaded count for standalone docs\\n    const uploadedStandalone = groupedDocs.standalone.filter(d => d.isUploaded).length;\\n\\n    const uploadedCount = uploadedGroups + uploadedStandalone;\\n\\n    return { totalCount, uploadedCount };\\n  }, [groupedDocs]);\\n\\n  const percent = counts.totalCount > 0 ? Math.round((counts.uploadedCount / counts.totalCount) * 100) : 0;\\n  const isComplete = counts.uploadedCount === counts.totalCount && counts.totalCount > 0;\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      {/* Header - matches Application Fields box structure */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-3\\\">\\n          <ProgressRing\\n            percent={percent}\\n            isComplete={isComplete}\\n            size={48}\\n          />\\n          <div className=\\\"flex-1\\\">\\n            <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Supporting Documents</h3>\\n            <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n              {counts.uploadedCount} of {counts.totalCount} uploaded\\n            </p>\\n          </div>\\n        </div>\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {documents.length === 0 ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center text-center py-6\\\">\\n            <div className=\\\"size-10 rounded-full bg-stone-100 flex items-center justify-center mb-3\\\">\\n              <Paperclip className=\\\"size-5 text-stone-400\\\" />\\n            </div>\\n            <p className=\\\"text-sm text-stone-500 text-pretty\\\">No supporting documents required</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-3\\\">\\n            {/* Combined Evidence Groups */}\\n            {groupedDocs.groups.map((group, idx) => (\\n              <CombinedEvidenceSlotInline\\n                key={`group-${idx}`}\\n                title={group.title}\\n                relationship={group.relationship}\\n                documents={group.documents}\\n                onAddClick={onAddClick}\\n              />\\n            ))}\\n\\n            {/* Standalone Documents */}\\n            {groupedDocs.standalone.length > 0 && (\\n              <div className=\\\"space-y-2\\\">\\n                {groupedDocs.standalone.map((doc) => (\\n                  <button\\n                    key={doc.id}\\n                    onClick={() => onAddClick(doc)}\\n                    className={cn(\\n                      \\\"w-full p-3 rounded-lg border-2 transition-colors text-left\\\",\\n                      doc.isUploaded\\n                        ? \\\"border-emerald-200 bg-emerald-50/50 hover:border-emerald-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100/50\\\"\\n                    )}\\n                  >\\n                    <div className=\\\"flex items-start gap-3\\\">\\n                      <div className={cn(\\n                        \\\"size-9 rounded-lg flex items-center justify-center shrink-0\\\",\\n                        doc.isUploaded\\n                          ? \\\"bg-emerald-100\\\"\\n                          : \\\"bg-stone-100 border border-dashed border-stone-300\\\"\\n                      )}>\\n                        {doc.isUploaded ? (\\n                          <FileText className=\\\"size-4 text-emerald-600\\\" />\\n                        ) : (\\n                          <Upload className=\\\"size-4 text-stone-400\\\" />\\n                        )}\\n                      </div>\\n                      <div className=\\\"flex-1 min-w-0\\\">\\n                        <div className=\\\"flex items-center gap-2\\\">\\n                          <span className={cn(\\n                            \\\"text-xs font-medium truncate\\\",\\n                            doc.isUploaded ? \\\"text-stone-700\\\" : \\\"text-stone-600\\\"\\n                          )}>\\n                            {doc.name}\\n                          </span>\\n                          {doc.isUploaded && (\\n                            <CheckCircle2 className=\\\"size-3.5 text-emerald-500 shrink-0\\\" />\\n                          )}\\n                        </div>\\n                        {doc.isUploaded && doc.linkedFileName && (\\n                          <p className=\\\"text-[11px] text-emerald-600 mt-0.5 truncate\\\">\\n                            {doc.linkedFileName}\\n                          </p>\\n                        )}\\n                        {!doc.isUploaded && doc.description && (\\n                          <p className=\\\"text-[10px] text-stone-400 mt-0.5 line-clamp-1 text-pretty\\\">\\n                            {doc.description}\\n                          </p>\\n                        )}\\n                      </div>\\n                      {!doc.isUploaded && (\\n                        <Plus className=\\\"size-4 text-stone-400 shrink-0\\\" />\\n                      )}\\n                    </div>\\n                  </button>\\n                ))}\\n              </div>\\n            )}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Mock extracted data for simulation\\n// ============================================================================\\nconst MOCK_EXTRACTED_DATA: Record<string, { value: string; sourceDoc: string }> = {\\n  \\\"emp-job-title\\\": { value: \\\"Senior Software Engineer\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-soc-code\\\": { value: \\\"2136\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-salary\\\": { value: \\\"£65,000\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-start-date\\\": { value: \\\"2024-03-01\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-name\\\": { value: \\\"Tech Solutions Ltd\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-number\\\": { value: \\\"ABC123456\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-cos-number\\\": { value: \\\"S1234567890\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-working-hours\\\": { value: \\\"37.5 hours per week\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n};\\n\\n// ============================================================================\\n// Main Overview Tab Component\\n// ============================================================================\\nexport function OverviewTab(props: OverviewTabProps) {\\n  const { itemType, formValues, documentGroups, onFieldChange, onNavigateToTab, onReanalyze } = props;\\n  const [selectedEvidence, setSelectedEvidence] = useState<RequiredEvidence | null>(null);\\n  const [previewGroup, setPreviewGroup] = useState<DocumentGroup | null>(null);\\n  const [needsReanalysis, setNeedsReanalysis] = useState(false);\\n\\n  // Analysis simulation state\\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\\n\\n  // Track reference document upload count to detect changes\\n  const prevRefUploadedRef = useRef<number | null>(null);\\n\\n  // Calculate stats\\n  const stats = useMemo(() => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      const completedFields = items.filter((i) => !!formValues[i.id] || !!i.value).length;\\n      const totalFields = items.length;\\n\\n      // Collect all evidence from items\\n      const evidenceMap = new Map<string, RequiredEvidence>();\\n      items.forEach((item) => {\\n        item.requiredEvidence?.forEach((ev) => {\\n          if (!evidenceMap.has(ev.id)) {\\n            evidenceMap.set(ev.id, ev);\\n          }\\n        });\\n      });\\n      const allEvidence = Array.from(evidenceMap.values());\\n\\n      // Reference docs: passport, CoS, etc. (used for data extraction)\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else (evidence for proof)\\n      const supportingEvidence = allEvidence.filter((ev) =>\\n        !referenceEvidence.includes(ev)\\n      );\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    } else {\\n      // Assessment type\\n      const fields = props.fields;\\n      const completedFields = fields.filter((f) => !!formValues[f.id]).length;\\n      const totalFields = fields.length;\\n      const allEvidence = props.requiredEvidence || [];\\n\\n      // Reference docs for assessment\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else\\n      const supportingEvidence = allEvidence.filter((ev) => !referenceEvidence.includes(ev));\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Prepare all fields for display\\n  const displayFields = useMemo((): DisplayField[] => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      return items.map((item) => {\\n        const hasValue = !!formValues[item.id] || !!item.value;\\n        const isLowConfidence = item.source === \\\"extracted\\\" &&\\n          item.confidenceScore !== undefined &&\\n          item.confidenceScore < 80;\\n\\n        // Get source document name from linkedDocuments\\n        const sourceDocName = item.source === \\\"extracted\\\" && item.linkedDocuments?.length > 0\\n          ? item.linkedDocuments[0].groupTitle || item.linkedDocuments[0].fileName\\n          : undefined;\\n\\n        return {\\n          id: item.id,\\n          label: item.label,\\n          value: formValues[item.id] || item.value,\\n          source: item.source,\\n          sourceDocumentName: sourceDocName,\\n          status: isLowConfidence ? \\\"low_confidence\\\" : (hasValue ? \\\"complete\\\" : \\\"missing\\\"),\\n          fieldType: \\\"text\\\",\\n          confidenceScore: item.confidenceScore,\\n        };\\n      });\\n    } else {\\n      const fields = props.fields;\\n      return fields.map((field) => ({\\n        id: field.id,\\n        label: field.label,\\n        value: formValues[field.id] || field.value,\\n        source: formValues[field.id] ? \\\"manual\\\" : null,\\n        status: formValues[field.id] ? \\\"complete\\\" : \\\"missing\\\",\\n        fieldType: field.type === \\\"select\\\" ? \\\"select\\\" : \\\"text\\\",\\n        options: field.options,\\n      }));\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Status helpers\\n  const getFieldStatus = () => {\\n    if (stats.completedFields === stats.totalFields) return \\\"complete\\\";\\n    if (stats.completedFields > 0) return \\\"partial\\\";\\n    return \\\"empty\\\";\\n  };\\n\\n  const refUploaded = stats.referenceEvidence.filter((e) => e.isUploaded).length;\\n\\n  // Handle reference doc click - find linked group and open preview\\n  const handleReferenceDocClick = (evidence: RequiredEvidence) => {\\n    if (evidence.linkedFileId) {\\n      // Find the group containing this file\\n      const group = documentGroups.find((g) =>\\n        g.files.some((f) => f.id === evidence.linkedFileId)\\n      );\\n      if (group) {\\n        setPreviewGroup(group);\\n        return;\\n      }\\n    }\\n    // Fallback: open upload modal\\n    setSelectedEvidence(evidence);\\n  };\\n\\n  const handleUploadClick = () => {\\n    const firstRef = stats.referenceEvidence.find((e) => !e.isUploaded);\\n    if (firstRef) {\\n      setSelectedEvidence(firstRef);\\n    } else if (stats.referenceEvidence.length > 0) {\\n      setSelectedEvidence(stats.referenceEvidence[0]);\\n    }\\n  };\\n\\n  // Simulate document analysis\\n  const handleAnalyze = () => {\\n    if (isAnalyzing) return;\\n\\n    setIsAnalyzing(true);\\n\\n    // Simulate analysis delay\\n    setTimeout(() => {\\n      // Find empty fields and populate them with mock data\\n      if (itemType === \\\"checklist\\\") {\\n        let filledCount = 0;\\n\\n        props.items.forEach((item) => {\\n          const hasValue = !!formValues[item.id] || !!item.value;\\n          if (!hasValue) {\\n            // Check if we have mock data for this field\\n            const mockData = MOCK_EXTRACTED_DATA[item.id];\\n            if (mockData) {\\n              onFieldChange(item.id, mockData.value);\\n              filledCount++;\\n            }\\n          }\\n        });\\n\\n        // If no specific mock data, fill first 3 empty fields with generic data\\n        if (filledCount === 0) {\\n          const emptyItems = props.items.filter(\\n            (item) => !formValues[item.id] && !item.value\\n          ).slice(0, 3);\\n\\n          emptyItems.forEach((item, index) => {\\n            const genericValues = [\\\"Sample Value 1\\\", \\\"Sample Value 2\\\", \\\"Sample Value 3\\\"];\\n            onFieldChange(item.id, genericValues[index] || \\\"Extracted Value\\\");\\n          });\\n        }\\n      }\\n\\n      setIsAnalyzing(false);\\n      setNeedsReanalysis(false);\\n    }, 1500); // 1.5 second analysis simulation\\n  };\\n\\n  // Auto-analyze when new reference documents are added\\n  useEffect(() => {\\n    if (prevRefUploadedRef.current !== null && refUploaded > prevRefUploadedRef.current) {\\n      // Auto-trigger analysis when new document is uploaded\\n      handleAnalyze();\\n    }\\n    prevRefUploadedRef.current = refUploaded;\\n  }, [refUploaded]); // eslint-disable-line react-hooks/exhaustive-deps\\n\\n  return (\\n    <>\\n      <div className=\\\"h-full flex flex-col min-h-0\\\">\\n        <div className=\\\"flex-1 p-6 min-h-0 h-full\\\">\\n          {/* Unified layout for all sections: 2:1 grid for Fields : Supporting Documents */}\\n          <div className=\\\"grid grid-cols-3 gap-4 h-full\\\">\\n            <div className=\\\"col-span-2 h-full min-h-0 flex flex-col\\\">\\n              <SummaryFieldsCard\\n                status={getFieldStatus()}\\n                totalFields={stats.totalFields}\\n                completedFields={stats.completedFields}\\n                fields={displayFields}\\n                formValues={formValues}\\n                referenceEvidence={stats.referenceEvidence}\\n                isAnalyzing={isAnalyzing}\\n                onFieldChange={onFieldChange}\\n                onReferenceDocClick={handleReferenceDocClick}\\n                onUploadClick={handleUploadClick}\\n              />\\n            </div>\\n            <SupportingDocumentsCard\\n              documents={stats.supportingEvidence}\\n              onAddClick={(evidence) => setSelectedEvidence(evidence)}\\n              onViewMore={() => onNavigateToTab?.(\\\"supporting-documents\\\")}\\n            />\\n          </div>\\n        </div>\\n\\n        {/* Footer with Analyze button */}\\n        {needsReanalysis && onReanalyze && (\\n          <div className=\\\"shrink-0 px-6 py-3 border-t border-stone-200 bg-stone-50\\\">\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <p className=\\\"text-sm text-stone-600 text-pretty\\\">\\n                Reference documents ready for analysis.\\n              </p>\\n              <button\\n                onClick={handleAnalyze}\\n                className=\\\"inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors\\\"\\n              >\\n                <Sparkles className=\\\"size-4\\\" />\\n                Analyze\\n              </button>\\n            </div>\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Document Upload Modal */}\\n      {selectedEvidence && (\\n        <DocumentUploadModal\\n          evidence={selectedEvidence}\\n          onClose={() => setSelectedEvidence(null)}\\n        />\\n      )}\\n\\n      {/* Document Preview Modal */}\\n      {previewGroup && (\\n        <CategoryReviewModal\\n          group={previewGroup}\\n          allGroups={documentGroups}\\n          onClose={() => setPreviewGroup(null)}\\n        />\\n      )}\\n    </>\\n  );\\n}\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 306,\n      \"oldLines\": 21,\n      \"newStart\": 306,\n      \"newLines\": 35,\n      \"lines\": [\n        \"             </div>\",\n        \"             {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\",\n        \"             <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\",\n        \"-              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\",\n        \"-                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\",\n        \"+              {referenceEvidence.length > 0 ? (\",\n        \"+                referenceEvidence.map((ev) => (\",\n        \"                   <button\",\n        \"                     key={ev.id}\",\n        \"-                    onClick={() => onReferenceDocClick(ev)}\",\n        \"-                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\",\n        \"+                    onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\",\n        \"+                    className={cn(\",\n        \"+                      \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\",\n        \"+                      ev.isUploaded\",\n        \"+                        ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\",\n        \"+                        : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\",\n        \"+                    )}\",\n        \"                   >\",\n        \"-                    <FileText className=\\\"size-4 text-blue-500\\\" />\",\n        \"-                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\",\n        \"-                      {ev.linkedFileName || ev.name}\",\n        \"+                    {ev.isUploaded ? (\",\n        \"+                      <FileText className=\\\"size-4 text-blue-500\\\" />\",\n        \"+                    ) : (\",\n        \"+                      <Upload className=\\\"size-3.5 text-stone-400\\\" />\",\n        \"+                    )}\",\n        \"+                    <span className={cn(\",\n        \"+                      \\\"text-xs font-medium truncate max-w-[120px]\\\",\",\n        \"+                      ev.isUploaded\",\n        \"+                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\",\n        \"+                        : \\\"text-stone-400\\\"\",\n        \"+                    )}>\",\n        \"+                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\",\n        \"                     </span>\",\n        \"                   </button>\",\n        \"                 ))\",\n        \"               ) : (\",\n        \"-                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\",\n        \"+                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents required</span>\",\n        \"               )}\",\n        \"             </div>\",\n        \"           </div>\"\n      ]\n    }\n  ],\n  \"userModified\": false,\n  \"replaceAll\": false\n}","timestamp":1769669217745,"toolName":"Edit","toolUseId":"toolu_01EdLbJeWaZBXurCq4ab2qnN","toolInput":{"replace_all":false,"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","old_string":"            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\n            <div className=\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\">\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\n                  <button\n                    key={ev.id}\n                    onClick={() => onReferenceDocClick(ev)}\n                    className=\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\"\n                  >\n                    <FileText className=\"size-4 text-blue-500\" />\n                    <span className=\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\">\n                      {ev.linkedFileName || ev.name}\n                    </span>\n                  </button>\n                ))\n              ) : (\n                <span className=\"text-xs text-stone-400 leading-[30px]\">No documents uploaded</span>\n              )}\n            </div>","new_string":"            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\n            <div className=\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\">\n              {referenceEvidence.length > 0 ? (\n                referenceEvidence.map((ev) => (\n                  <button\n                    key={ev.id}\n                    onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\n                    className={cn(\n                      \"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\",\n                      ev.isUploaded\n                        ? \"border-stone-200 bg-white hover:border-blue-300\"\n                        : \"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\"\n                    )}\n                  >\n                    {ev.isUploaded ? (\n                      <FileText className=\"size-4 text-blue-500\" />\n                    ) : (\n                      <Upload className=\"size-3.5 text-stone-400\" />\n                    )}\n                    <span className={cn(\n                      \"text-xs font-medium truncate max-w-[120px]\",\n                      ev.isUploaded\n                        ? \"text-stone-700 group-hover:text-blue-700\"\n                        : \"text-stone-400\"\n                    )}>\n                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\n                    </span>\n                  </button>\n                ))\n              ) : (\n                <span className=\"text-xs text-stone-400 leading-[30px]\">No documents required</span>\n              )}\n            </div>"},"toolResult":"{\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n  \"oldString\": \"            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => onReferenceDocClick(ev)}\\n                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\\n                  >\\n                    <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\\n              )}\\n            </div>\",\n  \"newString\": \"            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.length > 0 ? (\\n                referenceEvidence.map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\\n                    className={cn(\\n                      \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\\n                      ev.isUploaded\\n                        ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\\n                    )}\\n                  >\\n                    {ev.isUploaded ? (\\n                      <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    ) : (\\n                      <Upload className=\\\"size-3.5 text-stone-400\\\" />\\n                    )}\\n                    <span className={cn(\\n                      \\\"text-xs font-medium truncate max-w-[120px]\\\",\\n                      ev.isUploaded\\n                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\\n                        : \\\"text-stone-400\\\"\\n                    )}>\\n                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents required</span>\\n              )}\\n            </div>\",\n  \"originalFile\": \"\\\"use client\\\";\\n\\nimport { useMemo, useState, useEffect, useRef, Fragment } from \\\"react\\\";\\nimport {\\n  CheckCircle2,\\n  FileText,\\n  Paperclip,\\n  Check,\\n  AlertTriangle,\\n  Plus,\\n  Sparkles,\\n  Upload,\\n  PenLine,\\n  Loader2,\\n} from \\\"lucide-react\\\";\\nimport { cn } from \\\"@/lib/utils\\\";\\nimport {\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  RequiredEvidence,\\n  DocumentGroup,\\n} from \\\"@/types/case-detail\\\";\\nimport { DocumentUploadModal } from \\\"./DocumentUploadModal\\\";\\nimport { CategoryReviewModal } from \\\"@/components/case-detail/shared/CategoryReviewModal\\\";\\nimport type { DetailTabId } from \\\"./ItemDetailTabs\\\";\\n\\n// Assessment field interface\\ninterface AssessmentField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  type: \\\"text\\\" | \\\"select\\\" | \\\"radio\\\";\\n  options?: { value: string; label: string }[];\\n  isRequired: boolean;\\n  isConditional?: boolean;\\n  dependsOn?: { fieldId: string; value: string };\\n  description?: string;\\n}\\n\\n// Field for display (includes both completed and missing)\\ninterface DisplayField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  sourceDocumentName?: string; // Name of the reference document this was extracted from\\n  status: \\\"complete\\\" | \\\"missing\\\" | \\\"low_confidence\\\";\\n  fieldType?: \\\"text\\\" | \\\"select\\\" | \\\"date\\\";\\n  options?: { value: string; label: string }[];\\n  confidenceScore?: number;\\n}\\n\\n// Props types\\ninterface ChecklistOverviewProps {\\n  itemType: \\\"checklist\\\";\\n  items: EnhancedChecklistItem[];\\n  issues: EnhancedQualityIssue[];\\n  formValues: Record<string, string>;\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\ninterface AssessmentOverviewProps {\\n  itemType: \\\"assessment\\\";\\n  fields: AssessmentField[];\\n  formValues: Record<string, string>;\\n  requiredEvidence: RequiredEvidence[];\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\nexport type OverviewTabProps = ChecklistOverviewProps | AssessmentOverviewProps;\\n\\n// ============================================================================\\n// Circular Progress Ring Component\\n// ============================================================================\\nfunction ProgressRing({\\n  percent,\\n  isComplete,\\n  size = 56,\\n}: {\\n  percent: number;\\n  isComplete: boolean;\\n  size?: number;\\n}) {\\n  const strokeWidth = 5;\\n  const radius = (size - strokeWidth) / 2;\\n  const circumference = 2 * Math.PI * radius;\\n  const strokeDashoffset = circumference - (percent / 100) * circumference;\\n\\n  return (\\n    <div className=\\\"relative shrink-0\\\" style={{ width: size, height: size }}>\\n      <svg className=\\\"-rotate-90\\\" width={size} height={size}>\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          className=\\\"text-stone-200\\\"\\n        />\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          strokeLinecap=\\\"round\\\"\\n          strokeDasharray={circumference}\\n          strokeDashoffset={strokeDashoffset}\\n          className={isComplete ? \\\"text-emerald-500\\\" : \\\"text-amber-500\\\"}\\n        />\\n      </svg>\\n      <div className=\\\"absolute inset-0 flex items-center justify-center\\\">\\n        {isComplete ? (\\n          <CheckCircle2 className=\\\"size-6 text-emerald-500\\\" />\\n        ) : (\\n          <span className=\\\"text-sm font-bold text-stone-700 tabular-nums\\\">{percent}%</span>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Reference Document Item - Shows doc name and analysis time\\n// ============================================================================\\nfunction ReferenceDocItem({\\n  evidence,\\n  analyzedAt,\\n  onClick,\\n}: {\\n  evidence: RequiredEvidence;\\n  analyzedAt?: string;\\n  onClick: () => void;\\n}) {\\n  const displayName = evidence.name.length > 14 ? evidence.name.slice(0, 14) + \\\"...\\\" : evidence.name;\\n\\n  // Format time ago\\n  const getTimeAgo = (dateStr?: string) => {\\n    if (!dateStr) return null;\\n    // For demo, just show a static time\\n    return \\\"2h ago\\\";\\n  };\\n\\n  return (\\n    <button\\n      onClick={onClick}\\n      className=\\\"w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-left hover:bg-stone-100 transition-colors\\\"\\n    >\\n      <FileText className=\\\"size-3.5 text-blue-500 shrink-0\\\" />\\n      <span className=\\\"text-xs font-medium text-stone-700 truncate flex-1\\\">\\n        {displayName}\\n      </span>\\n      {analyzedAt && (\\n        <span className=\\\"text-[10px] text-stone-400 shrink-0\\\">\\n          {getTimeAgo(analyzedAt)}\\n        </span>\\n      )}\\n    </button>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Summary + Fields Card Component\\n// ============================================================================\\nfunction SummaryFieldsCard({\\n  status,\\n  totalFields,\\n  completedFields,\\n  fields,\\n  formValues,\\n  referenceEvidence,\\n  isAnalyzing,\\n  onFieldChange,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  referenceEvidence: RequiredEvidence[];\\n  isAnalyzing: boolean;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const [pendingChanges, setPendingChanges] = useState<Record<string, string>>({});\\n  const [manuallyEditedFields, setManuallyEditedFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\n\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  // Check if there are pending changes\\n  const pendingFieldIds = Object.keys(pendingChanges).filter(\\n    (id) => pendingChanges[id] && pendingChanges[id].trim() !== \\\"\\\"\\n  );\\n  const hasPendingChanges = pendingFieldIds.length > 0;\\n\\n  // Handle local field change (store in pending, don't submit yet)\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    setPendingChanges((prev) => ({ ...prev, [fieldId]: value }));\\n    setManuallyEditedFields((prev) => new Set(prev).add(fieldId));\\n  };\\n\\n  // Submit all pending changes\\n  const handleSubmit = async () => {\\n    if (!hasPendingChanges) return;\\n    setIsSubmitting(true);\\n\\n    // Submit each pending change\\n    for (const fieldId of pendingFieldIds) {\\n      onFieldChange(fieldId, pendingChanges[fieldId]);\\n    }\\n\\n    // Clear pending changes after a brief delay for animation\\n    setTimeout(() => {\\n      setPendingChanges({});\\n      setIsSubmitting(false);\\n    }, 500);\\n  };\\n\\n  // Cancel pending changes\\n  const handleCancel = () => {\\n    setPendingChanges({});\\n    setManuallyEditedFields(new Set());\\n  };\\n\\n  // Get source badge\\n  const getSourceBadge = (field: DisplayField) => {\\n    if (field.source === \\\"extracted\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center px-1.5 py-0.5 text-[9px] font-medium text-blue-700 bg-blue-50 rounded\\\">\\n          Extracted\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"manual\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n          <PenLine className=\\\"size-2\\\" />\\n          Manual\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"questionnaire\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-stone-600 bg-stone-100 rounded\\\">\\n          Questionnaire\\n        </span>\\n      );\\n    }\\n    return null;\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden flex flex-col flex-1 min-h-0\\\">\\n      {/* Header - Fixed height with Reference Documents */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-4\\\">\\n          {/* Left - Progress Summary */}\\n          <div className=\\\"shrink-0 flex items-center gap-3\\\">\\n            <ProgressRing percent={percent} isComplete={isComplete} size={48} />\\n            <div>\\n              <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Application Fields</h3>\\n              <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n                {completedFields} of {totalFields} completed\\n              </p>\\n            </div>\\n          </div>\\n\\n          {/* Divider */}\\n          <div className=\\\"w-px self-stretch bg-stone-200 shrink-0\\\" />\\n\\n          {/* Right - Reference Documents (vertical layout) */}\\n          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\\n                onClick={onUploadClick}\\n                className=\\\"shrink-0 inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-md transition-colors\\\"\\n              >\\n                <Plus className=\\\"size-3\\\" />\\n                Add\\n              </button>\\n            </div>\\n            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => onReferenceDocClick(ev)}\\n                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\\n                  >\\n                    <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\\n              )}\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n\\n      {/* Scrollable Content - min-h-0 is critical for flex overflow to work */}\\n      <div className=\\\"flex-1 min-h-0 p-4 overflow-y-auto\\\">\\n        {/* Fields Section Header */}\\n        <div className=\\\"flex items-center justify-between mb-3\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <h4 className=\\\"text-xs font-medium text-stone-600\\\">Fields</h4>\\n            {missingFields.length > 0 && !showAllFields && (\\n              <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n                {missingFields.length} missing\\n              </span>\\n            )}\\n          </div>\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? \\\"Show unanswered\\\" : \\\"Show all\\\"}\\n          </button>\\n        </div>\\n\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All fields have been filled</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2\\\">\\n            {displayFields.map((field) => {\\n              // Use pending value if exists, otherwise use stored value\\n              const storedValue = formValues[field.id] || field.value || \\\"\\\";\\n              const currentValue = pendingChanges[field.id] !== undefined ? pendingChanges[field.id] : storedValue;\\n              const hasPendingValue = pendingChanges[field.id] !== undefined && pendingChanges[field.id].trim() !== \\\"\\\";\\n              const isMissing = field.status === \\\"missing\\\" && !hasPendingValue;\\n              const isCompleted = !isMissing && (currentValue || hasPendingValue);\\n              // Check if user has manually entered/edited this field in this session\\n              const isManuallyEdited = manuallyEditedFields.has(field.id);\\n\\n              // Determine which badge to show\\n              const renderSourceBadge = () => {\\n                if (hasPendingValue) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-amber-700 bg-amber-100 rounded\\\">\\n                      Pending\\n                    </span>\\n                  );\\n                }\\n                if (isManuallyEdited) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n                      <PenLine className=\\\"size-2\\\" />\\n                      Manual\\n                    </span>\\n                  );\\n                }\\n                return getSourceBadge(field);\\n              };\\n\\n              return (\\n                <div\\n                  key={field.id}\\n                  className={cn(\\n                    \\\"p-2.5 rounded-lg border transition-colors\\\",\\n                    hasPendingValue\\n                      ? \\\"border-blue-200 bg-blue-50/30\\\"\\n                      : isMissing\\n                        ? \\\"border-amber-200 bg-amber-50/50\\\"\\n                        : \\\"border-stone-100 bg-stone-50/30\\\"\\n                  )}\\n                >\\n                  <div className=\\\"flex items-center gap-2 mb-1.5\\\">\\n                    {isCompleted ? (\\n                      <CheckCircle2 className={cn(\\n                        \\\"size-3.5 shrink-0\\\",\\n                        hasPendingValue ? \\\"text-blue-500\\\" : \\\"text-emerald-500\\\"\\n                      )} />\\n                    ) : (\\n                      <div className=\\\"size-3.5 rounded-full border-2 border-amber-400 shrink-0\\\" />\\n                    )}\\n                    <label className={cn(\\n                      \\\"text-xs font-medium truncate flex-1\\\",\\n                      isMissing ? \\\"text-stone-700\\\" : \\\"text-stone-500\\\"\\n                    )}>\\n                      {field.label}\\n                    </label>\\n                    {renderSourceBadge()}\\n                  </div>\\n\\n                  {/* All fields are editable */}\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Footer - shows when there are pending changes */}\\n      {hasPendingChanges && (\\n        <div className=\\\"shrink-0 px-4 py-3 border-t border-stone-100 flex items-center justify-between bg-stone-50/50\\\">\\n          <p className=\\\"text-xs text-stone-500 tabular-nums\\\">\\n            {pendingFieldIds.length} field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"} pending\\n          </p>\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <button\\n              onClick={handleCancel}\\n              disabled={isSubmitting}\\n              className=\\\"px-3 py-1.5 text-xs font-medium text-stone-600 hover:text-stone-800 hover:bg-stone-100 rounded-lg transition-colors disabled:opacity-50\\\"\\n            >\\n              Cancel\\n            </button>\\n            <button\\n              onClick={handleSubmit}\\n              disabled={isSubmitting}\\n              className=\\\"px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors flex items-center gap-1.5 disabled:opacity-50\\\"\\n            >\\n              {isSubmitting ? (\\n                <>\\n                  <Loader2 className=\\\"size-3.5 animate-spin\\\" />\\n                  Saving...\\n                </>\\n              ) : (\\n                <>\\n                  <Check className=\\\"size-3.5\\\" />\\n                  Save {pendingFieldIds.length} Field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"}\\n                </>\\n              )}\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Original Summary Section Component (for non-employment sections)\\n// ============================================================================\\nfunction SummarySection({\\n  status,\\n  totalFields,\\n  completedFields,\\n  referenceEvidence,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  referenceEvidence: RequiredEvidence[];\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden\\\">\\n      <div className=\\\"flex items-stretch\\\">\\n        {/* Left - Progress Summary */}\\n        <div className=\\\"shrink-0 p-4 flex items-center gap-4 border-r border-stone-100\\\">\\n          <ProgressRing percent={percent} isComplete={isComplete} size={56} />\\n          <div>\\n            <span\\n              className={cn(\\n                \\\"inline-flex items-center px-2 py-1 text-xs font-semibold rounded-md\\\",\\n                isComplete\\n                  ? \\\"bg-emerald-100 text-emerald-700\\\"\\n                  : \\\"bg-amber-100 text-amber-700\\\"\\n              )}\\n            >\\n              {isComplete ? \\\"Complete\\\" : \\\"In Progress\\\"}\\n            </span>\\n            <p className=\\\"text-sm font-medium text-stone-700 mt-1.5 tabular-nums\\\">\\n              {completedFields}/{totalFields} fields\\n            </p>\\n          </div>\\n        </div>\\n\\n        {/* Right - Reference Documents (flexible width) */}\\n        <div className=\\\"flex-1 p-4\\\">\\n          {/* Header */}\\n          <div className=\\\"flex items-center justify-between mb-3\\\">\\n            <div>\\n              <h4 className=\\\"text-xs font-semibold text-stone-700 text-balance\\\">Reference Documents</h4>\\n              <p className=\\\"text-[10px] text-stone-400 text-pretty\\\">Source files for data extraction</p>\\n            </div>\\n            <button\\n              onClick={onUploadClick}\\n              className=\\\"inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-lg transition-colors\\\"\\n            >\\n              <Plus className=\\\"size-3.5\\\" />\\n              Add\\n            </button>\\n          </div>\\n\\n          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Missing Information Card - Shows fields that still need to be completed\\n// ============================================================================\\nfunction MissingInformationCard({\\n  fields,\\n  formValues,\\n  onFieldChange,\\n  onViewMore,\\n}: {\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onViewMore?: () => void;\\n}) {\\n  const [savingFields, setSavingFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n\\n  // Filter to only show missing fields\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const completedCount = fields.length - missingFields.length;\\n\\n  // Fields to display based on toggle\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    onFieldChange(fieldId, value);\\n    setSavingFields((prev) => new Set(prev).add(fieldId));\\n    setTimeout(() => {\\n      setSavingFields((prev) => {\\n        const next = new Set(prev);\\n        next.delete(fieldId);\\n        return next;\\n      });\\n    }, 1000);\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      <div className=\\\"px-4 py-3 border-b border-stone-100 flex items-center justify-between\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Missing Information</h3>\\n          {missingFields.length > 0 && (\\n            <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n              {missingFields.length}\\n            </span>\\n          )}\\n        </div>\\n        {/* Toggle between showing missing only vs all fields */}\\n        {completedCount > 0 && (\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? (missingFields.length > 0 ? \\\"Show unanswered\\\" : \\\"Hide all\\\") : \\\"Show all\\\"}\\n          </button>\\n        )}\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All information has been provided</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2.5\\\">\\n            {displayFields.slice(0, showAllFields ? undefined : 6).map((field) => {\\n              const currentValue = formValues[field.id] || field.value || \\\"\\\";\\n              const isSaving = savingFields.has(field.id);\\n              const isCompleted = field.status !== \\\"missing\\\";\\n\\n              return (\\n                <div key={field.id} className=\\\"space-y-1.5\\\">\\n                  <div className=\\\"flex items-center gap-2\\\">\\n                    <div className={cn(\\n                      \\\"size-3.5 rounded-full border-2 shrink-0\\\",\\n                      isCompleted ? \\\"bg-emerald-500 border-emerald-500\\\" : \\\"border-amber-400\\\"\\n                    )} />\\n                    <label className=\\\"text-xs font-medium text-stone-600 truncate flex-1\\\">\\n                      {field.label}\\n                    </label>\\n                    {isSaving && (\\n                      <span className=\\\"inline-flex items-center gap-0.5 px-1 py-0.5 text-[9px] font-medium text-emerald-700 bg-emerald-100 rounded\\\">\\n                        <Check className=\\\"size-2\\\" />\\n                        Saved\\n                      </span>\\n                    )}\\n                  </div>\\n\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\"\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\"\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Evidence Slot - Shows grouped document requirements\\n// ============================================================================\\nfunction CombinedEvidenceSlotInline({\\n  title,\\n  relationship,\\n  documents,\\n  onAddClick,\\n}: {\\n  title: string;\\n  relationship: \\\"all\\\" | \\\"any\\\";\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n}) {\\n  const uploadedCount = documents.filter(d => d.isUploaded).length;\\n  const totalCount = documents.length;\\n  const isComplete = relationship === \\\"all\\\"\\n    ? uploadedCount === totalCount\\n    : uploadedCount >= 1;\\n\\n  return (\\n    <div className={cn(\\n      \\\"rounded-xl border-2 overflow-hidden transition-all\\\",\\n      isComplete\\n        ? \\\"border-emerald-300 bg-gradient-to-b from-emerald-50 to-white shadow-sm\\\"\\n        : \\\"border-stone-200 bg-white\\\"\\n    )}>\\n      {/* Header */}\\n      <div className={cn(\\n        \\\"px-3 py-2.5 border-b\\\",\\n        isComplete ? \\\"border-emerald-200 bg-emerald-50\\\" : \\\"border-stone-100 bg-stone-50\\\"\\n      )}>\\n        <div className=\\\"flex items-center justify-between\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            {isComplete && (\\n              <CheckCircle2 className=\\\"size-4 text-emerald-500\\\" />\\n            )}\\n            <span className={cn(\\n              \\\"text-xs font-semibold\\\",\\n              isComplete ? \\\"text-emerald-700\\\" : \\\"text-stone-700\\\"\\n            )}>\\n              {title}\\n            </span>\\n            {/* Relationship badge */}\\n            <span className={cn(\\n              \\\"px-1.5 py-0.5 text-[9px] font-bold uppercase rounded\\\",\\n              isComplete\\n                ? \\\"bg-emerald-200 text-emerald-700\\\"\\n                : relationship === \\\"all\\\"\\n                  ? \\\"bg-stone-200 text-stone-600\\\"\\n                  : \\\"bg-blue-100 text-blue-600\\\"\\n            )}>\\n              {isComplete ? \\\"Complete\\\" : relationship === \\\"all\\\" ? \\\"All required\\\" : \\\"Any one\\\"}\\n            </span>\\n          </div>\\n          <span className={cn(\\n            \\\"text-[10px] font-semibold tabular-nums\\\",\\n            isComplete ? \\\"text-emerald-600\\\" : \\\"text-stone-500\\\"\\n          )}>\\n            {uploadedCount}/{totalCount}\\n          </span>\\n        </div>\\n      </div>\\n\\n      {/* Document slots - horizontal flex layout */}\\n      <div className=\\\"p-3\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          {documents.map((doc, idx) => (\\n            <Fragment key={doc.id}>\\n              {/* Slot - flex-1 for equal width, fixed height */}\\n              <button\\n                onClick={() => onAddClick(doc)}\\n                className={cn(\\n                  \\\"flex-1 min-w-0 h-24 rounded-lg border-2 transition-all flex flex-col items-center justify-center gap-2 px-2\\\",\\n                  doc.isUploaded\\n                    ? \\\"border-emerald-300 bg-emerald-50 hover:border-emerald-400 hover:shadow-sm\\\"\\n                    : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100\\\"\\n                )}\\n              >\\n                {doc.isUploaded ? (\\n                  <>\\n                    {/* Uploaded state - document preview style */}\\n                    <div className=\\\"relative\\\">\\n                      <div className=\\\"w-10 h-12 rounded bg-white border border-emerald-200 shadow-sm flex flex-col p-1.5 gap-0.5\\\">\\n                        <div className=\\\"h-0.5 bg-emerald-300 rounded w-2/3\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-4/5\\\" />\\n                      </div>\\n                      <div className=\\\"absolute -top-1 -right-1 size-4 rounded-full bg-emerald-500 flex items-center justify-center\\\">\\n                        <Check className=\\\"size-2.5 text-white\\\" strokeWidth={3} />\\n                      </div>\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-emerald-700 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.linkedFileName || doc.name}\\n                    </span>\\n                  </>\\n                ) : (\\n                  <>\\n                    {/* Empty state */}\\n                    <div className=\\\"size-10 rounded-lg bg-white border-2 border-dashed border-stone-300 flex items-center justify-center\\\">\\n                      <Upload className=\\\"size-4 text-stone-400\\\" />\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-stone-500 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.name}\\n                    </span>\\n                  </>\\n                )}\\n              </button>\\n\\n              {/* Connector between slots */}\\n              {idx < documents.length - 1 && (\\n                <div className=\\\"shrink-0 flex items-center justify-center\\\">\\n                  <span className={cn(\\n                    \\\"px-2 py-1 text-[9px] font-bold rounded-full\\\",\\n                    isComplete\\n                      ? \\\"bg-emerald-100 text-emerald-600\\\"\\n                      : relationship === \\\"all\\\"\\n                        ? \\\"bg-stone-100 text-stone-500\\\"\\n                        : \\\"bg-blue-50 text-blue-500\\\"\\n                  )}>\\n                    {relationship === \\\"all\\\" ? \\\"+\\\" : \\\"or\\\"}\\n                  </span>\\n                </div>\\n              )}\\n            </Fragment>\\n          ))}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Supporting Documents Card - Shows all document slots as cards\\n// ============================================================================\\nfunction SupportingDocumentsCard({\\n  documents,\\n  onAddClick,\\n  onViewMore,\\n}: {\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n  onViewMore?: () => void;\\n}) {\\n  // Group documents by type for combined evidence slots\\n  const groupedDocs = useMemo(() => {\\n    // Check if we have bank statements and payslip - combine them as Financial Evidence\\n    const bankStatements = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"bank statement\\\")\\n    );\\n    const payslip = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"payslip\\\")\\n    );\\n\\n    // If we have both bank statements and payslip, group them\\n    if (bankStatements && payslip) {\\n      const financialGroup = {\\n        title: \\\"Financial Evidence\\\",\\n        relationship: \\\"all\\\" as const, // Both bank statements AND payslip required\\n        documents: [bankStatements, payslip],\\n      };\\n\\n      // Get remaining standalone documents\\n      const groupedIds = new Set([bankStatements.id, payslip.id]);\\n      const standalone = documents.filter(d => !groupedIds.has(d.id));\\n\\n      return { groups: [financialGroup], standalone };\\n    }\\n\\n    // No grouping needed\\n    return { groups: [], standalone: documents };\\n  }, [documents]);\\n\\n  // Calculate counts treating combined groups as single items\\n  const counts = useMemo(() => {\\n    // Total = number of groups + number of standalone docs\\n    const totalCount = groupedDocs.groups.length + groupedDocs.standalone.length;\\n\\n    // Uploaded count for groups (based on relationship)\\n    const uploadedGroups = groupedDocs.groups.filter(group => {\\n      const uploadedInGroup = group.documents.filter(d => d.isUploaded).length;\\n      if (group.relationship === \\\"all\\\") {\\n        return uploadedInGroup === group.documents.length;\\n      } else {\\n        return uploadedInGroup >= 1;\\n      }\\n    }).length;\\n\\n    // Uploaded count for standalone docs\\n    const uploadedStandalone = groupedDocs.standalone.filter(d => d.isUploaded).length;\\n\\n    const uploadedCount = uploadedGroups + uploadedStandalone;\\n\\n    return { totalCount, uploadedCount };\\n  }, [groupedDocs]);\\n\\n  const percent = counts.totalCount > 0 ? Math.round((counts.uploadedCount / counts.totalCount) * 100) : 0;\\n  const isComplete = counts.uploadedCount === counts.totalCount && counts.totalCount > 0;\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      {/* Header - matches Application Fields box structure */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-3\\\">\\n          <ProgressRing\\n            percent={percent}\\n            isComplete={isComplete}\\n            size={48}\\n          />\\n          <div className=\\\"flex-1\\\">\\n            <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Supporting Documents</h3>\\n            <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n              {counts.uploadedCount} of {counts.totalCount} uploaded\\n            </p>\\n          </div>\\n        </div>\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {documents.length === 0 ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center text-center py-6\\\">\\n            <div className=\\\"size-10 rounded-full bg-stone-100 flex items-center justify-center mb-3\\\">\\n              <Paperclip className=\\\"size-5 text-stone-400\\\" />\\n            </div>\\n            <p className=\\\"text-sm text-stone-500 text-pretty\\\">No supporting documents required</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-3\\\">\\n            {/* Combined Evidence Groups */}\\n            {groupedDocs.groups.map((group, idx) => (\\n              <CombinedEvidenceSlotInline\\n                key={`group-${idx}`}\\n                title={group.title}\\n                relationship={group.relationship}\\n                documents={group.documents}\\n                onAddClick={onAddClick}\\n              />\\n            ))}\\n\\n            {/* Standalone Documents */}\\n            {groupedDocs.standalone.length > 0 && (\\n              <div className=\\\"space-y-2\\\">\\n                {groupedDocs.standalone.map((doc) => (\\n                  <button\\n                    key={doc.id}\\n                    onClick={() => onAddClick(doc)}\\n                    className={cn(\\n                      \\\"w-full p-3 rounded-lg border-2 transition-colors text-left\\\",\\n                      doc.isUploaded\\n                        ? \\\"border-emerald-200 bg-emerald-50/50 hover:border-emerald-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100/50\\\"\\n                    )}\\n                  >\\n                    <div className=\\\"flex items-start gap-3\\\">\\n                      <div className={cn(\\n                        \\\"size-9 rounded-lg flex items-center justify-center shrink-0\\\",\\n                        doc.isUploaded\\n                          ? \\\"bg-emerald-100\\\"\\n                          : \\\"bg-stone-100 border border-dashed border-stone-300\\\"\\n                      )}>\\n                        {doc.isUploaded ? (\\n                          <FileText className=\\\"size-4 text-emerald-600\\\" />\\n                        ) : (\\n                          <Upload className=\\\"size-4 text-stone-400\\\" />\\n                        )}\\n                      </div>\\n                      <div className=\\\"flex-1 min-w-0\\\">\\n                        <div className=\\\"flex items-center gap-2\\\">\\n                          <span className={cn(\\n                            \\\"text-xs font-medium truncate\\\",\\n                            doc.isUploaded ? \\\"text-stone-700\\\" : \\\"text-stone-600\\\"\\n                          )}>\\n                            {doc.name}\\n                          </span>\\n                          {doc.isUploaded && (\\n                            <CheckCircle2 className=\\\"size-3.5 text-emerald-500 shrink-0\\\" />\\n                          )}\\n                        </div>\\n                        {doc.isUploaded && doc.linkedFileName && (\\n                          <p className=\\\"text-[11px] text-emerald-600 mt-0.5 truncate\\\">\\n                            {doc.linkedFileName}\\n                          </p>\\n                        )}\\n                        {!doc.isUploaded && doc.description && (\\n                          <p className=\\\"text-[10px] text-stone-400 mt-0.5 line-clamp-1 text-pretty\\\">\\n                            {doc.description}\\n                          </p>\\n                        )}\\n                      </div>\\n                      {!doc.isUploaded && (\\n                        <Plus className=\\\"size-4 text-stone-400 shrink-0\\\" />\\n                      )}\\n                    </div>\\n                  </button>\\n                ))}\\n              </div>\\n            )}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Mock extracted data for simulation\\n// ============================================================================\\nconst MOCK_EXTRACTED_DATA: Record<string, { value: string; sourceDoc: string }> = {\\n  \\\"emp-job-title\\\": { value: \\\"Senior Software Engineer\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-soc-code\\\": { value: \\\"2136\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-salary\\\": { value: \\\"£65,000\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-start-date\\\": { value: \\\"2024-03-01\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-name\\\": { value: \\\"Tech Solutions Ltd\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-number\\\": { value: \\\"ABC123456\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-cos-number\\\": { value: \\\"S1234567890\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-working-hours\\\": { value: \\\"37.5 hours per week\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n};\\n\\n// ============================================================================\\n// Main Overview Tab Component\\n// ============================================================================\\nexport function OverviewTab(props: OverviewTabProps) {\\n  const { itemType, formValues, documentGroups, onFieldChange, onNavigateToTab, onReanalyze } = props;\\n  const [selectedEvidence, setSelectedEvidence] = useState<RequiredEvidence | null>(null);\\n  const [previewGroup, setPreviewGroup] = useState<DocumentGroup | null>(null);\\n  const [needsReanalysis, setNeedsReanalysis] = useState(false);\\n\\n  // Analysis simulation state\\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\\n\\n  // Track reference document upload count to detect changes\\n  const prevRefUploadedRef = useRef<number | null>(null);\\n\\n  // Calculate stats\\n  const stats = useMemo(() => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      const completedFields = items.filter((i) => !!formValues[i.id] || !!i.value).length;\\n      const totalFields = items.length;\\n\\n      // Collect all evidence from items\\n      const evidenceMap = new Map<string, RequiredEvidence>();\\n      items.forEach((item) => {\\n        item.requiredEvidence?.forEach((ev) => {\\n          if (!evidenceMap.has(ev.id)) {\\n            evidenceMap.set(ev.id, ev);\\n          }\\n        });\\n      });\\n      const allEvidence = Array.from(evidenceMap.values());\\n\\n      // Reference docs: passport, CoS, etc. (used for data extraction)\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else (evidence for proof)\\n      const supportingEvidence = allEvidence.filter((ev) =>\\n        !referenceEvidence.includes(ev)\\n      );\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    } else {\\n      // Assessment type\\n      const fields = props.fields;\\n      const completedFields = fields.filter((f) => !!formValues[f.id]).length;\\n      const totalFields = fields.length;\\n      const allEvidence = props.requiredEvidence || [];\\n\\n      // Reference docs for assessment\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else\\n      const supportingEvidence = allEvidence.filter((ev) => !referenceEvidence.includes(ev));\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Prepare all fields for display\\n  const displayFields = useMemo((): DisplayField[] => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      return items.map((item) => {\\n        const hasValue = !!formValues[item.id] || !!item.value;\\n        const isLowConfidence = item.source === \\\"extracted\\\" &&\\n          item.confidenceScore !== undefined &&\\n          item.confidenceScore < 80;\\n\\n        // Get source document name from linkedDocuments\\n        const sourceDocName = item.source === \\\"extracted\\\" && item.linkedDocuments?.length > 0\\n          ? item.linkedDocuments[0].groupTitle || item.linkedDocuments[0].fileName\\n          : undefined;\\n\\n        return {\\n          id: item.id,\\n          label: item.label,\\n          value: formValues[item.id] || item.value,\\n          source: item.source,\\n          sourceDocumentName: sourceDocName,\\n          status: isLowConfidence ? \\\"low_confidence\\\" : (hasValue ? \\\"complete\\\" : \\\"missing\\\"),\\n          fieldType: \\\"text\\\",\\n          confidenceScore: item.confidenceScore,\\n        };\\n      });\\n    } else {\\n      const fields = props.fields;\\n      return fields.map((field) => ({\\n        id: field.id,\\n        label: field.label,\\n        value: formValues[field.id] || field.value,\\n        source: formValues[field.id] ? \\\"manual\\\" : null,\\n        status: formValues[field.id] ? \\\"complete\\\" : \\\"missing\\\",\\n        fieldType: field.type === \\\"select\\\" ? \\\"select\\\" : \\\"text\\\",\\n        options: field.options,\\n      }));\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Status helpers\\n  const getFieldStatus = () => {\\n    if (stats.completedFields === stats.totalFields) return \\\"complete\\\";\\n    if (stats.completedFields > 0) return \\\"partial\\\";\\n    return \\\"empty\\\";\\n  };\\n\\n  const refUploaded = stats.referenceEvidence.filter((e) => e.isUploaded).length;\\n\\n  // Handle reference doc click - find linked group and open preview\\n  const handleReferenceDocClick = (evidence: RequiredEvidence) => {\\n    if (evidence.linkedFileId) {\\n      // Find the group containing this file\\n      const group = documentGroups.find((g) =>\\n        g.files.some((f) => f.id === evidence.linkedFileId)\\n      );\\n      if (group) {\\n        setPreviewGroup(group);\\n        return;\\n      }\\n    }\\n    // Fallback: open upload modal\\n    setSelectedEvidence(evidence);\\n  };\\n\\n  const handleUploadClick = () => {\\n    const firstRef = stats.referenceEvidence.find((e) => !e.isUploaded);\\n    if (firstRef) {\\n      setSelectedEvidence(firstRef);\\n    } else if (stats.referenceEvidence.length > 0) {\\n      setSelectedEvidence(stats.referenceEvidence[0]);\\n    }\\n  };\\n\\n  // Simulate document analysis\\n  const handleAnalyze = () => {\\n    if (isAnalyzing) return;\\n\\n    setIsAnalyzing(true);\\n\\n    // Simulate analysis delay\\n    setTimeout(() => {\\n      // Find empty fields and populate them with mock data\\n      if (itemType === \\\"checklist\\\") {\\n        let filledCount = 0;\\n\\n        props.items.forEach((item) => {\\n          const hasValue = !!formValues[item.id] || !!item.value;\\n          if (!hasValue) {\\n            // Check if we have mock data for this field\\n            const mockData = MOCK_EXTRACTED_DATA[item.id];\\n            if (mockData) {\\n              onFieldChange(item.id, mockData.value);\\n              filledCount++;\\n            }\\n          }\\n        });\\n\\n        // If no specific mock data, fill first 3 empty fields with generic data\\n        if (filledCount === 0) {\\n          const emptyItems = props.items.filter(\\n            (item) => !formValues[item.id] && !item.value\\n          ).slice(0, 3);\\n\\n          emptyItems.forEach((item, index) => {\\n            const genericValues = [\\\"Sample Value 1\\\", \\\"Sample Value 2\\\", \\\"Sample Value 3\\\"];\\n            onFieldChange(item.id, genericValues[index] || \\\"Extracted Value\\\");\\n          });\\n        }\\n      }\\n\\n      setIsAnalyzing(false);\\n      setNeedsReanalysis(false);\\n    }, 1500); // 1.5 second analysis simulation\\n  };\\n\\n  // Auto-analyze when new reference documents are added\\n  useEffect(() => {\\n    if (prevRefUploadedRef.current !== null && refUploaded > prevRefUploadedRef.current) {\\n      // Auto-trigger analysis when new document is uploaded\\n      handleAnalyze();\\n    }\\n    prevRefUploadedRef.current = refUploaded;\\n  }, [refUploaded]); // eslint-disable-line react-hooks/exhaustive-deps\\n\\n  return (\\n    <>\\n      <div className=\\\"h-full flex flex-col min-h-0\\\">\\n        <div className=\\\"flex-1 p-6 min-h-0 h-full\\\">\\n          {/* Unified layout for all sections: 2:1 grid for Fields : Supporting Documents */}\\n          <div className=\\\"grid grid-cols-3 gap-4 h-full\\\">\\n            <div className=\\\"col-span-2 h-full min-h-0 flex flex-col\\\">\\n              <SummaryFieldsCard\\n                status={getFieldStatus()}\\n                totalFields={stats.totalFields}\\n                completedFields={stats.completedFields}\\n                fields={displayFields}\\n                formValues={formValues}\\n                referenceEvidence={stats.referenceEvidence}\\n                isAnalyzing={isAnalyzing}\\n                onFieldChange={onFieldChange}\\n                onReferenceDocClick={handleReferenceDocClick}\\n                onUploadClick={handleUploadClick}\\n              />\\n            </div>\\n            <SupportingDocumentsCard\\n              documents={stats.supportingEvidence}\\n              onAddClick={(evidence) => setSelectedEvidence(evidence)}\\n              onViewMore={() => onNavigateToTab?.(\\\"supporting-documents\\\")}\\n            />\\n          </div>\\n        </div>\\n\\n        {/* Footer with Analyze button */}\\n        {needsReanalysis && onReanalyze && (\\n          <div className=\\\"shrink-0 px-6 py-3 border-t border-stone-200 bg-stone-50\\\">\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <p className=\\\"text-sm text-stone-600 text-pretty\\\">\\n                Reference documents ready for analysis.\\n              </p>\\n              <button\\n                onClick={handleAnalyze}\\n                className=\\\"inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors\\\"\\n              >\\n                <Sparkles className=\\\"size-4\\\" />\\n                Analyze\\n              </button>\\n            </div>\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Document Upload Modal */}\\n      {selectedEvidence && (\\n        <DocumentUploadModal\\n          evidence={selectedEvidence}\\n          onClose={() => setSelectedEvidence(null)}\\n        />\\n      )}\\n\\n      {/* Document Preview Modal */}\\n      {previewGroup && (\\n        <CategoryReviewModal\\n          group={previewGroup}\\n          allGroups={documentGroups}\\n          onClose={() => setPreviewGroup(null)}\\n        />\\n      )}\\n    </>\\n  );\\n}\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 306,\n      \"oldLines\": 21,\n      \"newStart\": 306,\n      \"newLines\": 35,\n      \"lines\": [\n        \"             </div>\",\n        \"             {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\",\n        \"             <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\",\n        \"-              {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\",\n        \"-                referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\",\n        \"+              {referenceEvidence.length > 0 ? (\",\n        \"+                referenceEvidence.map((ev) => (\",\n        \"                   <button\",\n        \"                     key={ev.id}\",\n        \"-                    onClick={() => onReferenceDocClick(ev)}\",\n        \"-                    className=\\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border border-stone-200 bg-white hover:border-blue-300 transition-all\\\"\",\n        \"+                    onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\",\n        \"+                    className={cn(\",\n        \"+                      \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\",\n        \"+                      ev.isUploaded\",\n        \"+                        ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\",\n        \"+                        : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\",\n        \"+                    )}\",\n        \"                   >\",\n        \"-                    <FileText className=\\\"size-4 text-blue-500\\\" />\",\n        \"-                    <span className=\\\"text-xs font-medium text-stone-700 truncate max-w-[120px] group-hover:text-blue-700\\\">\",\n        \"-                      {ev.linkedFileName || ev.name}\",\n        \"+                    {ev.isUploaded ? (\",\n        \"+                      <FileText className=\\\"size-4 text-blue-500\\\" />\",\n        \"+                    ) : (\",\n        \"+                      <Upload className=\\\"size-3.5 text-stone-400\\\" />\",\n        \"+                    )}\",\n        \"+                    <span className={cn(\",\n        \"+                      \\\"text-xs font-medium truncate max-w-[120px]\\\",\",\n        \"+                      ev.isUploaded\",\n        \"+                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\",\n        \"+                        : \\\"text-stone-400\\\"\",\n        \"+                    )}>\",\n        \"+                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\",\n        \"                     </span>\",\n        \"                   </button>\",\n        \"                 ))\",\n        \"               ) : (\",\n        \"-                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents uploaded</span>\",\n        \"+                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents required</span>\",\n        \"               )}\",\n        \"             </div>\",\n        \"           </div>\"\n      ]\n    }\n  ],\n  \"userModified\": false,\n  \"replaceAll\": false\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Edit","category":"native"},"isError":false,"turnId":"msg_016LngzPhoZ9tHbVmZQcQ76A"}
{"id":"msg-1769669225698-m8j7on","type":"assistant","content":"Good, `Upload` is already imported. Now let me apply the edits:","timestamp":1769669225698,"isIntermediate":true,"turnId":"msg_016LngzPhoZ9tHbVmZQcQ76A"}
{"id":"msg-1769669229811-y0rn0n","type":"tool","content":"{\n  \"oldTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ],\n  \"newTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ]\n}","timestamp":1769669229811,"toolName":"TodoWrite","toolUseId":"toolu_011ffJQ5EtZSr7b6HRirtt9E","toolInput":{"todos":[{"content":"Store: Add auto-mapping logic in generateEnhancedChecklist()","status":"completed","activeForm":"Adding auto-mapping logic in store"},{"content":"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard","status":"completed","activeForm":"Updating SummaryFieldsCard rendering"},{"content":"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection","status":"in_progress","activeForm":"Updating SummarySection rendering"}]},"toolResult":"{\n  \"oldTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"pending\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ],\n  \"newTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ]\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Update Todos","category":"native"},"isError":false,"turnId":"msg_01CvnoqfFuJaTJCFFQSjAZAn"}
{"id":"msg-1769669237013-smpa95","type":"tool","content":"{\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n  \"oldString\": \"          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\",\n  \"newString\": \"          {/* Document List */}\\n          {referenceEvidence.length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\\n                  className={cn(\\n                    \\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border transition-all\\\",\\n                    ev.isUploaded\\n                      ? \\\"border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm\\\"\\n                      : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\\n                  )}\\n                >\\n                  <div className={cn(\\n                    \\\"size-8 rounded-md flex items-center justify-center shrink-0\\\",\\n                    ev.isUploaded ? \\\"bg-blue-100\\\" : \\\"bg-stone-100\\\"\\n                  )}>\\n                    {ev.isUploaded ? (\\n                      <FileText className=\\\"size-4 text-blue-600\\\" />\\n                    ) : (\\n                      <Upload className=\\\"size-4 text-stone-400\\\" />\\n                    )}\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className={cn(\\n                      \\\"text-xs font-medium truncate max-w-[140px] transition-colors\\\",\\n                      ev.isUploaded\\n                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\\n                        : \\\"text-stone-400\\\"\\n                    )}>\\n                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\\n                    </p>\\n                    {ev.isUploaded && (\\n                      <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                    )}\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents required</p>\\n          )}\",\n  \"originalFile\": \"\\\"use client\\\";\\n\\nimport { useMemo, useState, useEffect, useRef, Fragment } from \\\"react\\\";\\nimport {\\n  CheckCircle2,\\n  FileText,\\n  Paperclip,\\n  Check,\\n  AlertTriangle,\\n  Plus,\\n  Sparkles,\\n  Upload,\\n  PenLine,\\n  Loader2,\\n} from \\\"lucide-react\\\";\\nimport { cn } from \\\"@/lib/utils\\\";\\nimport {\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  RequiredEvidence,\\n  DocumentGroup,\\n} from \\\"@/types/case-detail\\\";\\nimport { DocumentUploadModal } from \\\"./DocumentUploadModal\\\";\\nimport { CategoryReviewModal } from \\\"@/components/case-detail/shared/CategoryReviewModal\\\";\\nimport type { DetailTabId } from \\\"./ItemDetailTabs\\\";\\n\\n// Assessment field interface\\ninterface AssessmentField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  type: \\\"text\\\" | \\\"select\\\" | \\\"radio\\\";\\n  options?: { value: string; label: string }[];\\n  isRequired: boolean;\\n  isConditional?: boolean;\\n  dependsOn?: { fieldId: string; value: string };\\n  description?: string;\\n}\\n\\n// Field for display (includes both completed and missing)\\ninterface DisplayField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  sourceDocumentName?: string; // Name of the reference document this was extracted from\\n  status: \\\"complete\\\" | \\\"missing\\\" | \\\"low_confidence\\\";\\n  fieldType?: \\\"text\\\" | \\\"select\\\" | \\\"date\\\";\\n  options?: { value: string; label: string }[];\\n  confidenceScore?: number;\\n}\\n\\n// Props types\\ninterface ChecklistOverviewProps {\\n  itemType: \\\"checklist\\\";\\n  items: EnhancedChecklistItem[];\\n  issues: EnhancedQualityIssue[];\\n  formValues: Record<string, string>;\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\ninterface AssessmentOverviewProps {\\n  itemType: \\\"assessment\\\";\\n  fields: AssessmentField[];\\n  formValues: Record<string, string>;\\n  requiredEvidence: RequiredEvidence[];\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\nexport type OverviewTabProps = ChecklistOverviewProps | AssessmentOverviewProps;\\n\\n// ============================================================================\\n// Circular Progress Ring Component\\n// ============================================================================\\nfunction ProgressRing({\\n  percent,\\n  isComplete,\\n  size = 56,\\n}: {\\n  percent: number;\\n  isComplete: boolean;\\n  size?: number;\\n}) {\\n  const strokeWidth = 5;\\n  const radius = (size - strokeWidth) / 2;\\n  const circumference = 2 * Math.PI * radius;\\n  const strokeDashoffset = circumference - (percent / 100) * circumference;\\n\\n  return (\\n    <div className=\\\"relative shrink-0\\\" style={{ width: size, height: size }}>\\n      <svg className=\\\"-rotate-90\\\" width={size} height={size}>\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          className=\\\"text-stone-200\\\"\\n        />\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          strokeLinecap=\\\"round\\\"\\n          strokeDasharray={circumference}\\n          strokeDashoffset={strokeDashoffset}\\n          className={isComplete ? \\\"text-emerald-500\\\" : \\\"text-amber-500\\\"}\\n        />\\n      </svg>\\n      <div className=\\\"absolute inset-0 flex items-center justify-center\\\">\\n        {isComplete ? (\\n          <CheckCircle2 className=\\\"size-6 text-emerald-500\\\" />\\n        ) : (\\n          <span className=\\\"text-sm font-bold text-stone-700 tabular-nums\\\">{percent}%</span>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Reference Document Item - Shows doc name and analysis time\\n// ============================================================================\\nfunction ReferenceDocItem({\\n  evidence,\\n  analyzedAt,\\n  onClick,\\n}: {\\n  evidence: RequiredEvidence;\\n  analyzedAt?: string;\\n  onClick: () => void;\\n}) {\\n  const displayName = evidence.name.length > 14 ? evidence.name.slice(0, 14) + \\\"...\\\" : evidence.name;\\n\\n  // Format time ago\\n  const getTimeAgo = (dateStr?: string) => {\\n    if (!dateStr) return null;\\n    // For demo, just show a static time\\n    return \\\"2h ago\\\";\\n  };\\n\\n  return (\\n    <button\\n      onClick={onClick}\\n      className=\\\"w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-left hover:bg-stone-100 transition-colors\\\"\\n    >\\n      <FileText className=\\\"size-3.5 text-blue-500 shrink-0\\\" />\\n      <span className=\\\"text-xs font-medium text-stone-700 truncate flex-1\\\">\\n        {displayName}\\n      </span>\\n      {analyzedAt && (\\n        <span className=\\\"text-[10px] text-stone-400 shrink-0\\\">\\n          {getTimeAgo(analyzedAt)}\\n        </span>\\n      )}\\n    </button>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Summary + Fields Card Component\\n// ============================================================================\\nfunction SummaryFieldsCard({\\n  status,\\n  totalFields,\\n  completedFields,\\n  fields,\\n  formValues,\\n  referenceEvidence,\\n  isAnalyzing,\\n  onFieldChange,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  referenceEvidence: RequiredEvidence[];\\n  isAnalyzing: boolean;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const [pendingChanges, setPendingChanges] = useState<Record<string, string>>({});\\n  const [manuallyEditedFields, setManuallyEditedFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\n\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  // Check if there are pending changes\\n  const pendingFieldIds = Object.keys(pendingChanges).filter(\\n    (id) => pendingChanges[id] && pendingChanges[id].trim() !== \\\"\\\"\\n  );\\n  const hasPendingChanges = pendingFieldIds.length > 0;\\n\\n  // Handle local field change (store in pending, don't submit yet)\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    setPendingChanges((prev) => ({ ...prev, [fieldId]: value }));\\n    setManuallyEditedFields((prev) => new Set(prev).add(fieldId));\\n  };\\n\\n  // Submit all pending changes\\n  const handleSubmit = async () => {\\n    if (!hasPendingChanges) return;\\n    setIsSubmitting(true);\\n\\n    // Submit each pending change\\n    for (const fieldId of pendingFieldIds) {\\n      onFieldChange(fieldId, pendingChanges[fieldId]);\\n    }\\n\\n    // Clear pending changes after a brief delay for animation\\n    setTimeout(() => {\\n      setPendingChanges({});\\n      setIsSubmitting(false);\\n    }, 500);\\n  };\\n\\n  // Cancel pending changes\\n  const handleCancel = () => {\\n    setPendingChanges({});\\n    setManuallyEditedFields(new Set());\\n  };\\n\\n  // Get source badge\\n  const getSourceBadge = (field: DisplayField) => {\\n    if (field.source === \\\"extracted\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center px-1.5 py-0.5 text-[9px] font-medium text-blue-700 bg-blue-50 rounded\\\">\\n          Extracted\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"manual\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n          <PenLine className=\\\"size-2\\\" />\\n          Manual\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"questionnaire\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-stone-600 bg-stone-100 rounded\\\">\\n          Questionnaire\\n        </span>\\n      );\\n    }\\n    return null;\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden flex flex-col flex-1 min-h-0\\\">\\n      {/* Header - Fixed height with Reference Documents */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-4\\\">\\n          {/* Left - Progress Summary */}\\n          <div className=\\\"shrink-0 flex items-center gap-3\\\">\\n            <ProgressRing percent={percent} isComplete={isComplete} size={48} />\\n            <div>\\n              <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Application Fields</h3>\\n              <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n                {completedFields} of {totalFields} completed\\n              </p>\\n            </div>\\n          </div>\\n\\n          {/* Divider */}\\n          <div className=\\\"w-px self-stretch bg-stone-200 shrink-0\\\" />\\n\\n          {/* Right - Reference Documents (vertical layout) */}\\n          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\\n                onClick={onUploadClick}\\n                className=\\\"shrink-0 inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-md transition-colors\\\"\\n              >\\n                <Plus className=\\\"size-3\\\" />\\n                Add\\n              </button>\\n            </div>\\n            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.length > 0 ? (\\n                referenceEvidence.map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\\n                    className={cn(\\n                      \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\\n                      ev.isUploaded\\n                        ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\\n                    )}\\n                  >\\n                    {ev.isUploaded ? (\\n                      <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    ) : (\\n                      <Upload className=\\\"size-3.5 text-stone-400\\\" />\\n                    )}\\n                    <span className={cn(\\n                      \\\"text-xs font-medium truncate max-w-[120px]\\\",\\n                      ev.isUploaded\\n                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\\n                        : \\\"text-stone-400\\\"\\n                    )}>\\n                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents required</span>\\n              )}\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n\\n      {/* Scrollable Content - min-h-0 is critical for flex overflow to work */}\\n      <div className=\\\"flex-1 min-h-0 p-4 overflow-y-auto\\\">\\n        {/* Fields Section Header */}\\n        <div className=\\\"flex items-center justify-between mb-3\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <h4 className=\\\"text-xs font-medium text-stone-600\\\">Fields</h4>\\n            {missingFields.length > 0 && !showAllFields && (\\n              <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n                {missingFields.length} missing\\n              </span>\\n            )}\\n          </div>\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? \\\"Show unanswered\\\" : \\\"Show all\\\"}\\n          </button>\\n        </div>\\n\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All fields have been filled</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2\\\">\\n            {displayFields.map((field) => {\\n              // Use pending value if exists, otherwise use stored value\\n              const storedValue = formValues[field.id] || field.value || \\\"\\\";\\n              const currentValue = pendingChanges[field.id] !== undefined ? pendingChanges[field.id] : storedValue;\\n              const hasPendingValue = pendingChanges[field.id] !== undefined && pendingChanges[field.id].trim() !== \\\"\\\";\\n              const isMissing = field.status === \\\"missing\\\" && !hasPendingValue;\\n              const isCompleted = !isMissing && (currentValue || hasPendingValue);\\n              // Check if user has manually entered/edited this field in this session\\n              const isManuallyEdited = manuallyEditedFields.has(field.id);\\n\\n              // Determine which badge to show\\n              const renderSourceBadge = () => {\\n                if (hasPendingValue) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-amber-700 bg-amber-100 rounded\\\">\\n                      Pending\\n                    </span>\\n                  );\\n                }\\n                if (isManuallyEdited) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n                      <PenLine className=\\\"size-2\\\" />\\n                      Manual\\n                    </span>\\n                  );\\n                }\\n                return getSourceBadge(field);\\n              };\\n\\n              return (\\n                <div\\n                  key={field.id}\\n                  className={cn(\\n                    \\\"p-2.5 rounded-lg border transition-colors\\\",\\n                    hasPendingValue\\n                      ? \\\"border-blue-200 bg-blue-50/30\\\"\\n                      : isMissing\\n                        ? \\\"border-amber-200 bg-amber-50/50\\\"\\n                        : \\\"border-stone-100 bg-stone-50/30\\\"\\n                  )}\\n                >\\n                  <div className=\\\"flex items-center gap-2 mb-1.5\\\">\\n                    {isCompleted ? (\\n                      <CheckCircle2 className={cn(\\n                        \\\"size-3.5 shrink-0\\\",\\n                        hasPendingValue ? \\\"text-blue-500\\\" : \\\"text-emerald-500\\\"\\n                      )} />\\n                    ) : (\\n                      <div className=\\\"size-3.5 rounded-full border-2 border-amber-400 shrink-0\\\" />\\n                    )}\\n                    <label className={cn(\\n                      \\\"text-xs font-medium truncate flex-1\\\",\\n                      isMissing ? \\\"text-stone-700\\\" : \\\"text-stone-500\\\"\\n                    )}>\\n                      {field.label}\\n                    </label>\\n                    {renderSourceBadge()}\\n                  </div>\\n\\n                  {/* All fields are editable */}\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Footer - shows when there are pending changes */}\\n      {hasPendingChanges && (\\n        <div className=\\\"shrink-0 px-4 py-3 border-t border-stone-100 flex items-center justify-between bg-stone-50/50\\\">\\n          <p className=\\\"text-xs text-stone-500 tabular-nums\\\">\\n            {pendingFieldIds.length} field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"} pending\\n          </p>\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <button\\n              onClick={handleCancel}\\n              disabled={isSubmitting}\\n              className=\\\"px-3 py-1.5 text-xs font-medium text-stone-600 hover:text-stone-800 hover:bg-stone-100 rounded-lg transition-colors disabled:opacity-50\\\"\\n            >\\n              Cancel\\n            </button>\\n            <button\\n              onClick={handleSubmit}\\n              disabled={isSubmitting}\\n              className=\\\"px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors flex items-center gap-1.5 disabled:opacity-50\\\"\\n            >\\n              {isSubmitting ? (\\n                <>\\n                  <Loader2 className=\\\"size-3.5 animate-spin\\\" />\\n                  Saving...\\n                </>\\n              ) : (\\n                <>\\n                  <Check className=\\\"size-3.5\\\" />\\n                  Save {pendingFieldIds.length} Field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"}\\n                </>\\n              )}\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Original Summary Section Component (for non-employment sections)\\n// ============================================================================\\nfunction SummarySection({\\n  status,\\n  totalFields,\\n  completedFields,\\n  referenceEvidence,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  referenceEvidence: RequiredEvidence[];\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden\\\">\\n      <div className=\\\"flex items-stretch\\\">\\n        {/* Left - Progress Summary */}\\n        <div className=\\\"shrink-0 p-4 flex items-center gap-4 border-r border-stone-100\\\">\\n          <ProgressRing percent={percent} isComplete={isComplete} size={56} />\\n          <div>\\n            <span\\n              className={cn(\\n                \\\"inline-flex items-center px-2 py-1 text-xs font-semibold rounded-md\\\",\\n                isComplete\\n                  ? \\\"bg-emerald-100 text-emerald-700\\\"\\n                  : \\\"bg-amber-100 text-amber-700\\\"\\n              )}\\n            >\\n              {isComplete ? \\\"Complete\\\" : \\\"In Progress\\\"}\\n            </span>\\n            <p className=\\\"text-sm font-medium text-stone-700 mt-1.5 tabular-nums\\\">\\n              {completedFields}/{totalFields} fields\\n            </p>\\n          </div>\\n        </div>\\n\\n        {/* Right - Reference Documents (flexible width) */}\\n        <div className=\\\"flex-1 p-4\\\">\\n          {/* Header */}\\n          <div className=\\\"flex items-center justify-between mb-3\\\">\\n            <div>\\n              <h4 className=\\\"text-xs font-semibold text-stone-700 text-balance\\\">Reference Documents</h4>\\n              <p className=\\\"text-[10px] text-stone-400 text-pretty\\\">Source files for data extraction</p>\\n            </div>\\n            <button\\n              onClick={onUploadClick}\\n              className=\\\"inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-lg transition-colors\\\"\\n            >\\n              <Plus className=\\\"size-3.5\\\" />\\n              Add\\n            </button>\\n          </div>\\n\\n          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Missing Information Card - Shows fields that still need to be completed\\n// ============================================================================\\nfunction MissingInformationCard({\\n  fields,\\n  formValues,\\n  onFieldChange,\\n  onViewMore,\\n}: {\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onViewMore?: () => void;\\n}) {\\n  const [savingFields, setSavingFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n\\n  // Filter to only show missing fields\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const completedCount = fields.length - missingFields.length;\\n\\n  // Fields to display based on toggle\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    onFieldChange(fieldId, value);\\n    setSavingFields((prev) => new Set(prev).add(fieldId));\\n    setTimeout(() => {\\n      setSavingFields((prev) => {\\n        const next = new Set(prev);\\n        next.delete(fieldId);\\n        return next;\\n      });\\n    }, 1000);\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      <div className=\\\"px-4 py-3 border-b border-stone-100 flex items-center justify-between\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Missing Information</h3>\\n          {missingFields.length > 0 && (\\n            <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n              {missingFields.length}\\n            </span>\\n          )}\\n        </div>\\n        {/* Toggle between showing missing only vs all fields */}\\n        {completedCount > 0 && (\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? (missingFields.length > 0 ? \\\"Show unanswered\\\" : \\\"Hide all\\\") : \\\"Show all\\\"}\\n          </button>\\n        )}\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All information has been provided</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2.5\\\">\\n            {displayFields.slice(0, showAllFields ? undefined : 6).map((field) => {\\n              const currentValue = formValues[field.id] || field.value || \\\"\\\";\\n              const isSaving = savingFields.has(field.id);\\n              const isCompleted = field.status !== \\\"missing\\\";\\n\\n              return (\\n                <div key={field.id} className=\\\"space-y-1.5\\\">\\n                  <div className=\\\"flex items-center gap-2\\\">\\n                    <div className={cn(\\n                      \\\"size-3.5 rounded-full border-2 shrink-0\\\",\\n                      isCompleted ? \\\"bg-emerald-500 border-emerald-500\\\" : \\\"border-amber-400\\\"\\n                    )} />\\n                    <label className=\\\"text-xs font-medium text-stone-600 truncate flex-1\\\">\\n                      {field.label}\\n                    </label>\\n                    {isSaving && (\\n                      <span className=\\\"inline-flex items-center gap-0.5 px-1 py-0.5 text-[9px] font-medium text-emerald-700 bg-emerald-100 rounded\\\">\\n                        <Check className=\\\"size-2\\\" />\\n                        Saved\\n                      </span>\\n                    )}\\n                  </div>\\n\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\"\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\"\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Evidence Slot - Shows grouped document requirements\\n// ============================================================================\\nfunction CombinedEvidenceSlotInline({\\n  title,\\n  relationship,\\n  documents,\\n  onAddClick,\\n}: {\\n  title: string;\\n  relationship: \\\"all\\\" | \\\"any\\\";\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n}) {\\n  const uploadedCount = documents.filter(d => d.isUploaded).length;\\n  const totalCount = documents.length;\\n  const isComplete = relationship === \\\"all\\\"\\n    ? uploadedCount === totalCount\\n    : uploadedCount >= 1;\\n\\n  return (\\n    <div className={cn(\\n      \\\"rounded-xl border-2 overflow-hidden transition-all\\\",\\n      isComplete\\n        ? \\\"border-emerald-300 bg-gradient-to-b from-emerald-50 to-white shadow-sm\\\"\\n        : \\\"border-stone-200 bg-white\\\"\\n    )}>\\n      {/* Header */}\\n      <div className={cn(\\n        \\\"px-3 py-2.5 border-b\\\",\\n        isComplete ? \\\"border-emerald-200 bg-emerald-50\\\" : \\\"border-stone-100 bg-stone-50\\\"\\n      )}>\\n        <div className=\\\"flex items-center justify-between\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            {isComplete && (\\n              <CheckCircle2 className=\\\"size-4 text-emerald-500\\\" />\\n            )}\\n            <span className={cn(\\n              \\\"text-xs font-semibold\\\",\\n              isComplete ? \\\"text-emerald-700\\\" : \\\"text-stone-700\\\"\\n            )}>\\n              {title}\\n            </span>\\n            {/* Relationship badge */}\\n            <span className={cn(\\n              \\\"px-1.5 py-0.5 text-[9px] font-bold uppercase rounded\\\",\\n              isComplete\\n                ? \\\"bg-emerald-200 text-emerald-700\\\"\\n                : relationship === \\\"all\\\"\\n                  ? \\\"bg-stone-200 text-stone-600\\\"\\n                  : \\\"bg-blue-100 text-blue-600\\\"\\n            )}>\\n              {isComplete ? \\\"Complete\\\" : relationship === \\\"all\\\" ? \\\"All required\\\" : \\\"Any one\\\"}\\n            </span>\\n          </div>\\n          <span className={cn(\\n            \\\"text-[10px] font-semibold tabular-nums\\\",\\n            isComplete ? \\\"text-emerald-600\\\" : \\\"text-stone-500\\\"\\n          )}>\\n            {uploadedCount}/{totalCount}\\n          </span>\\n        </div>\\n      </div>\\n\\n      {/* Document slots - horizontal flex layout */}\\n      <div className=\\\"p-3\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          {documents.map((doc, idx) => (\\n            <Fragment key={doc.id}>\\n              {/* Slot - flex-1 for equal width, fixed height */}\\n              <button\\n                onClick={() => onAddClick(doc)}\\n                className={cn(\\n                  \\\"flex-1 min-w-0 h-24 rounded-lg border-2 transition-all flex flex-col items-center justify-center gap-2 px-2\\\",\\n                  doc.isUploaded\\n                    ? \\\"border-emerald-300 bg-emerald-50 hover:border-emerald-400 hover:shadow-sm\\\"\\n                    : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100\\\"\\n                )}\\n              >\\n                {doc.isUploaded ? (\\n                  <>\\n                    {/* Uploaded state - document preview style */}\\n                    <div className=\\\"relative\\\">\\n                      <div className=\\\"w-10 h-12 rounded bg-white border border-emerald-200 shadow-sm flex flex-col p-1.5 gap-0.5\\\">\\n                        <div className=\\\"h-0.5 bg-emerald-300 rounded w-2/3\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-4/5\\\" />\\n                      </div>\\n                      <div className=\\\"absolute -top-1 -right-1 size-4 rounded-full bg-emerald-500 flex items-center justify-center\\\">\\n                        <Check className=\\\"size-2.5 text-white\\\" strokeWidth={3} />\\n                      </div>\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-emerald-700 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.linkedFileName || doc.name}\\n                    </span>\\n                  </>\\n                ) : (\\n                  <>\\n                    {/* Empty state */}\\n                    <div className=\\\"size-10 rounded-lg bg-white border-2 border-dashed border-stone-300 flex items-center justify-center\\\">\\n                      <Upload className=\\\"size-4 text-stone-400\\\" />\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-stone-500 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.name}\\n                    </span>\\n                  </>\\n                )}\\n              </button>\\n\\n              {/* Connector between slots */}\\n              {idx < documents.length - 1 && (\\n                <div className=\\\"shrink-0 flex items-center justify-center\\\">\\n                  <span className={cn(\\n                    \\\"px-2 py-1 text-[9px] font-bold rounded-full\\\",\\n                    isComplete\\n                      ? \\\"bg-emerald-100 text-emerald-600\\\"\\n                      : relationship === \\\"all\\\"\\n                        ? \\\"bg-stone-100 text-stone-500\\\"\\n                        : \\\"bg-blue-50 text-blue-500\\\"\\n                  )}>\\n                    {relationship === \\\"all\\\" ? \\\"+\\\" : \\\"or\\\"}\\n                  </span>\\n                </div>\\n              )}\\n            </Fragment>\\n          ))}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Supporting Documents Card - Shows all document slots as cards\\n// ============================================================================\\nfunction SupportingDocumentsCard({\\n  documents,\\n  onAddClick,\\n  onViewMore,\\n}: {\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n  onViewMore?: () => void;\\n}) {\\n  // Group documents by type for combined evidence slots\\n  const groupedDocs = useMemo(() => {\\n    // Check if we have bank statements and payslip - combine them as Financial Evidence\\n    const bankStatements = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"bank statement\\\")\\n    );\\n    const payslip = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"payslip\\\")\\n    );\\n\\n    // If we have both bank statements and payslip, group them\\n    if (bankStatements && payslip) {\\n      const financialGroup = {\\n        title: \\\"Financial Evidence\\\",\\n        relationship: \\\"all\\\" as const, // Both bank statements AND payslip required\\n        documents: [bankStatements, payslip],\\n      };\\n\\n      // Get remaining standalone documents\\n      const groupedIds = new Set([bankStatements.id, payslip.id]);\\n      const standalone = documents.filter(d => !groupedIds.has(d.id));\\n\\n      return { groups: [financialGroup], standalone };\\n    }\\n\\n    // No grouping needed\\n    return { groups: [], standalone: documents };\\n  }, [documents]);\\n\\n  // Calculate counts treating combined groups as single items\\n  const counts = useMemo(() => {\\n    // Total = number of groups + number of standalone docs\\n    const totalCount = groupedDocs.groups.length + groupedDocs.standalone.length;\\n\\n    // Uploaded count for groups (based on relationship)\\n    const uploadedGroups = groupedDocs.groups.filter(group => {\\n      const uploadedInGroup = group.documents.filter(d => d.isUploaded).length;\\n      if (group.relationship === \\\"all\\\") {\\n        return uploadedInGroup === group.documents.length;\\n      } else {\\n        return uploadedInGroup >= 1;\\n      }\\n    }).length;\\n\\n    // Uploaded count for standalone docs\\n    const uploadedStandalone = groupedDocs.standalone.filter(d => d.isUploaded).length;\\n\\n    const uploadedCount = uploadedGroups + uploadedStandalone;\\n\\n    return { totalCount, uploadedCount };\\n  }, [groupedDocs]);\\n\\n  const percent = counts.totalCount > 0 ? Math.round((counts.uploadedCount / counts.totalCount) * 100) : 0;\\n  const isComplete = counts.uploadedCount === counts.totalCount && counts.totalCount > 0;\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      {/* Header - matches Application Fields box structure */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-3\\\">\\n          <ProgressRing\\n            percent={percent}\\n            isComplete={isComplete}\\n            size={48}\\n          />\\n          <div className=\\\"flex-1\\\">\\n            <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Supporting Documents</h3>\\n            <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n              {counts.uploadedCount} of {counts.totalCount} uploaded\\n            </p>\\n          </div>\\n        </div>\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {documents.length === 0 ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center text-center py-6\\\">\\n            <div className=\\\"size-10 rounded-full bg-stone-100 flex items-center justify-center mb-3\\\">\\n              <Paperclip className=\\\"size-5 text-stone-400\\\" />\\n            </div>\\n            <p className=\\\"text-sm text-stone-500 text-pretty\\\">No supporting documents required</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-3\\\">\\n            {/* Combined Evidence Groups */}\\n            {groupedDocs.groups.map((group, idx) => (\\n              <CombinedEvidenceSlotInline\\n                key={`group-${idx}`}\\n                title={group.title}\\n                relationship={group.relationship}\\n                documents={group.documents}\\n                onAddClick={onAddClick}\\n              />\\n            ))}\\n\\n            {/* Standalone Documents */}\\n            {groupedDocs.standalone.length > 0 && (\\n              <div className=\\\"space-y-2\\\">\\n                {groupedDocs.standalone.map((doc) => (\\n                  <button\\n                    key={doc.id}\\n                    onClick={() => onAddClick(doc)}\\n                    className={cn(\\n                      \\\"w-full p-3 rounded-lg border-2 transition-colors text-left\\\",\\n                      doc.isUploaded\\n                        ? \\\"border-emerald-200 bg-emerald-50/50 hover:border-emerald-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100/50\\\"\\n                    )}\\n                  >\\n                    <div className=\\\"flex items-start gap-3\\\">\\n                      <div className={cn(\\n                        \\\"size-9 rounded-lg flex items-center justify-center shrink-0\\\",\\n                        doc.isUploaded\\n                          ? \\\"bg-emerald-100\\\"\\n                          : \\\"bg-stone-100 border border-dashed border-stone-300\\\"\\n                      )}>\\n                        {doc.isUploaded ? (\\n                          <FileText className=\\\"size-4 text-emerald-600\\\" />\\n                        ) : (\\n                          <Upload className=\\\"size-4 text-stone-400\\\" />\\n                        )}\\n                      </div>\\n                      <div className=\\\"flex-1 min-w-0\\\">\\n                        <div className=\\\"flex items-center gap-2\\\">\\n                          <span className={cn(\\n                            \\\"text-xs font-medium truncate\\\",\\n                            doc.isUploaded ? \\\"text-stone-700\\\" : \\\"text-stone-600\\\"\\n                          )}>\\n                            {doc.name}\\n                          </span>\\n                          {doc.isUploaded && (\\n                            <CheckCircle2 className=\\\"size-3.5 text-emerald-500 shrink-0\\\" />\\n                          )}\\n                        </div>\\n                        {doc.isUploaded && doc.linkedFileName && (\\n                          <p className=\\\"text-[11px] text-emerald-600 mt-0.5 truncate\\\">\\n                            {doc.linkedFileName}\\n                          </p>\\n                        )}\\n                        {!doc.isUploaded && doc.description && (\\n                          <p className=\\\"text-[10px] text-stone-400 mt-0.5 line-clamp-1 text-pretty\\\">\\n                            {doc.description}\\n                          </p>\\n                        )}\\n                      </div>\\n                      {!doc.isUploaded && (\\n                        <Plus className=\\\"size-4 text-stone-400 shrink-0\\\" />\\n                      )}\\n                    </div>\\n                  </button>\\n                ))}\\n              </div>\\n            )}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Mock extracted data for simulation\\n// ============================================================================\\nconst MOCK_EXTRACTED_DATA: Record<string, { value: string; sourceDoc: string }> = {\\n  \\\"emp-job-title\\\": { value: \\\"Senior Software Engineer\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-soc-code\\\": { value: \\\"2136\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-salary\\\": { value: \\\"£65,000\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-start-date\\\": { value: \\\"2024-03-01\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-name\\\": { value: \\\"Tech Solutions Ltd\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-number\\\": { value: \\\"ABC123456\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-cos-number\\\": { value: \\\"S1234567890\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-working-hours\\\": { value: \\\"37.5 hours per week\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n};\\n\\n// ============================================================================\\n// Main Overview Tab Component\\n// ============================================================================\\nexport function OverviewTab(props: OverviewTabProps) {\\n  const { itemType, formValues, documentGroups, onFieldChange, onNavigateToTab, onReanalyze } = props;\\n  const [selectedEvidence, setSelectedEvidence] = useState<RequiredEvidence | null>(null);\\n  const [previewGroup, setPreviewGroup] = useState<DocumentGroup | null>(null);\\n  const [needsReanalysis, setNeedsReanalysis] = useState(false);\\n\\n  // Analysis simulation state\\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\\n\\n  // Track reference document upload count to detect changes\\n  const prevRefUploadedRef = useRef<number | null>(null);\\n\\n  // Calculate stats\\n  const stats = useMemo(() => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      const completedFields = items.filter((i) => !!formValues[i.id] || !!i.value).length;\\n      const totalFields = items.length;\\n\\n      // Collect all evidence from items\\n      const evidenceMap = new Map<string, RequiredEvidence>();\\n      items.forEach((item) => {\\n        item.requiredEvidence?.forEach((ev) => {\\n          if (!evidenceMap.has(ev.id)) {\\n            evidenceMap.set(ev.id, ev);\\n          }\\n        });\\n      });\\n      const allEvidence = Array.from(evidenceMap.values());\\n\\n      // Reference docs: passport, CoS, etc. (used for data extraction)\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else (evidence for proof)\\n      const supportingEvidence = allEvidence.filter((ev) =>\\n        !referenceEvidence.includes(ev)\\n      );\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    } else {\\n      // Assessment type\\n      const fields = props.fields;\\n      const completedFields = fields.filter((f) => !!formValues[f.id]).length;\\n      const totalFields = fields.length;\\n      const allEvidence = props.requiredEvidence || [];\\n\\n      // Reference docs for assessment\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else\\n      const supportingEvidence = allEvidence.filter((ev) => !referenceEvidence.includes(ev));\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Prepare all fields for display\\n  const displayFields = useMemo((): DisplayField[] => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      return items.map((item) => {\\n        const hasValue = !!formValues[item.id] || !!item.value;\\n        const isLowConfidence = item.source === \\\"extracted\\\" &&\\n          item.confidenceScore !== undefined &&\\n          item.confidenceScore < 80;\\n\\n        // Get source document name from linkedDocuments\\n        const sourceDocName = item.source === \\\"extracted\\\" && item.linkedDocuments?.length > 0\\n          ? item.linkedDocuments[0].groupTitle || item.linkedDocuments[0].fileName\\n          : undefined;\\n\\n        return {\\n          id: item.id,\\n          label: item.label,\\n          value: formValues[item.id] || item.value,\\n          source: item.source,\\n          sourceDocumentName: sourceDocName,\\n          status: isLowConfidence ? \\\"low_confidence\\\" : (hasValue ? \\\"complete\\\" : \\\"missing\\\"),\\n          fieldType: \\\"text\\\",\\n          confidenceScore: item.confidenceScore,\\n        };\\n      });\\n    } else {\\n      const fields = props.fields;\\n      return fields.map((field) => ({\\n        id: field.id,\\n        label: field.label,\\n        value: formValues[field.id] || field.value,\\n        source: formValues[field.id] ? \\\"manual\\\" : null,\\n        status: formValues[field.id] ? \\\"complete\\\" : \\\"missing\\\",\\n        fieldType: field.type === \\\"select\\\" ? \\\"select\\\" : \\\"text\\\",\\n        options: field.options,\\n      }));\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Status helpers\\n  const getFieldStatus = () => {\\n    if (stats.completedFields === stats.totalFields) return \\\"complete\\\";\\n    if (stats.completedFields > 0) return \\\"partial\\\";\\n    return \\\"empty\\\";\\n  };\\n\\n  const refUploaded = stats.referenceEvidence.filter((e) => e.isUploaded).length;\\n\\n  // Handle reference doc click - find linked group and open preview\\n  const handleReferenceDocClick = (evidence: RequiredEvidence) => {\\n    if (evidence.linkedFileId) {\\n      // Find the group containing this file\\n      const group = documentGroups.find((g) =>\\n        g.files.some((f) => f.id === evidence.linkedFileId)\\n      );\\n      if (group) {\\n        setPreviewGroup(group);\\n        return;\\n      }\\n    }\\n    // Fallback: open upload modal\\n    setSelectedEvidence(evidence);\\n  };\\n\\n  const handleUploadClick = () => {\\n    const firstRef = stats.referenceEvidence.find((e) => !e.isUploaded);\\n    if (firstRef) {\\n      setSelectedEvidence(firstRef);\\n    } else if (stats.referenceEvidence.length > 0) {\\n      setSelectedEvidence(stats.referenceEvidence[0]);\\n    }\\n  };\\n\\n  // Simulate document analysis\\n  const handleAnalyze = () => {\\n    if (isAnalyzing) return;\\n\\n    setIsAnalyzing(true);\\n\\n    // Simulate analysis delay\\n    setTimeout(() => {\\n      // Find empty fields and populate them with mock data\\n      if (itemType === \\\"checklist\\\") {\\n        let filledCount = 0;\\n\\n        props.items.forEach((item) => {\\n          const hasValue = !!formValues[item.id] || !!item.value;\\n          if (!hasValue) {\\n            // Check if we have mock data for this field\\n            const mockData = MOCK_EXTRACTED_DATA[item.id];\\n            if (mockData) {\\n              onFieldChange(item.id, mockData.value);\\n              filledCount++;\\n            }\\n          }\\n        });\\n\\n        // If no specific mock data, fill first 3 empty fields with generic data\\n        if (filledCount === 0) {\\n          const emptyItems = props.items.filter(\\n            (item) => !formValues[item.id] && !item.value\\n          ).slice(0, 3);\\n\\n          emptyItems.forEach((item, index) => {\\n            const genericValues = [\\\"Sample Value 1\\\", \\\"Sample Value 2\\\", \\\"Sample Value 3\\\"];\\n            onFieldChange(item.id, genericValues[index] || \\\"Extracted Value\\\");\\n          });\\n        }\\n      }\\n\\n      setIsAnalyzing(false);\\n      setNeedsReanalysis(false);\\n    }, 1500); // 1.5 second analysis simulation\\n  };\\n\\n  // Auto-analyze when new reference documents are added\\n  useEffect(() => {\\n    if (prevRefUploadedRef.current !== null && refUploaded > prevRefUploadedRef.current) {\\n      // Auto-trigger analysis when new document is uploaded\\n      handleAnalyze();\\n    }\\n    prevRefUploadedRef.current = refUploaded;\\n  }, [refUploaded]); // eslint-disable-line react-hooks/exhaustive-deps\\n\\n  return (\\n    <>\\n      <div className=\\\"h-full flex flex-col min-h-0\\\">\\n        <div className=\\\"flex-1 p-6 min-h-0 h-full\\\">\\n          {/* Unified layout for all sections: 2:1 grid for Fields : Supporting Documents */}\\n          <div className=\\\"grid grid-cols-3 gap-4 h-full\\\">\\n            <div className=\\\"col-span-2 h-full min-h-0 flex flex-col\\\">\\n              <SummaryFieldsCard\\n                status={getFieldStatus()}\\n                totalFields={stats.totalFields}\\n                completedFields={stats.completedFields}\\n                fields={displayFields}\\n                formValues={formValues}\\n                referenceEvidence={stats.referenceEvidence}\\n                isAnalyzing={isAnalyzing}\\n                onFieldChange={onFieldChange}\\n                onReferenceDocClick={handleReferenceDocClick}\\n                onUploadClick={handleUploadClick}\\n              />\\n            </div>\\n            <SupportingDocumentsCard\\n              documents={stats.supportingEvidence}\\n              onAddClick={(evidence) => setSelectedEvidence(evidence)}\\n              onViewMore={() => onNavigateToTab?.(\\\"supporting-documents\\\")}\\n            />\\n          </div>\\n        </div>\\n\\n        {/* Footer with Analyze button */}\\n        {needsReanalysis && onReanalyze && (\\n          <div className=\\\"shrink-0 px-6 py-3 border-t border-stone-200 bg-stone-50\\\">\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <p className=\\\"text-sm text-stone-600 text-pretty\\\">\\n                Reference documents ready for analysis.\\n              </p>\\n              <button\\n                onClick={handleAnalyze}\\n                className=\\\"inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors\\\"\\n              >\\n                <Sparkles className=\\\"size-4\\\" />\\n                Analyze\\n              </button>\\n            </div>\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Document Upload Modal */}\\n      {selectedEvidence && (\\n        <DocumentUploadModal\\n          evidence={selectedEvidence}\\n          onClose={() => setSelectedEvidence(null)}\\n        />\\n      )}\\n\\n      {/* Document Preview Modal */}\\n      {previewGroup && (\\n        <CategoryReviewModal\\n          group={previewGroup}\\n          allGroups={documentGroups}\\n          onClose={() => setPreviewGroup(null)}\\n        />\\n      )}\\n    </>\\n  );\\n}\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 565,\n      \"oldLines\": 28,\n      \"newStart\": 565,\n      \"newLines\": 47,\n      \"lines\": [\n        \"           </div>\",\n        \" \",\n        \"           {/* Document List */}\",\n        \"-          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\",\n        \"+          {referenceEvidence.length > 0 ? (\",\n        \"             <div className=\\\"flex flex-wrap gap-2\\\">\",\n        \"-              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\",\n        \"+              {referenceEvidence.map((ev) => (\",\n        \"                 <button\",\n        \"                   key={ev.id}\",\n        \"-                  onClick={() => onReferenceDocClick(ev)}\",\n        \"-                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\",\n        \"+                  onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\",\n        \"+                  className={cn(\",\n        \"+                    \\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border transition-all\\\",\",\n        \"+                    ev.isUploaded\",\n        \"+                      ? \\\"border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm\\\"\",\n        \"+                      : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\",\n        \"+                  )}\",\n        \"                 >\",\n        \"-                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\",\n        \"-                    <FileText className=\\\"size-4 text-blue-600\\\" />\",\n        \"+                  <div className={cn(\",\n        \"+                    \\\"size-8 rounded-md flex items-center justify-center shrink-0\\\",\",\n        \"+                    ev.isUploaded ? \\\"bg-blue-100\\\" : \\\"bg-stone-100\\\"\",\n        \"+                  )}>\",\n        \"+                    {ev.isUploaded ? (\",\n        \"+                      <FileText className=\\\"size-4 text-blue-600\\\" />\",\n        \"+                    ) : (\",\n        \"+                      <Upload className=\\\"size-4 text-stone-400\\\" />\",\n        \"+                    )}\",\n        \"                   </div>\",\n        \"                   <div className=\\\"text-left min-w-0\\\">\",\n        \"-                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\",\n        \"-                      {ev.linkedFileName || ev.name}\",\n        \"+                    <p className={cn(\",\n        \"+                      \\\"text-xs font-medium truncate max-w-[140px] transition-colors\\\",\",\n        \"+                      ev.isUploaded\",\n        \"+                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\",\n        \"+                        : \\\"text-stone-400\\\"\",\n        \"+                    )}>\",\n        \"+                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\",\n        \"                     </p>\",\n        \"-                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\",\n        \"+                    {ev.isUploaded && (\",\n        \"+                      <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\",\n        \"+                    )}\",\n        \"                   </div>\",\n        \"                 </button>\",\n        \"               ))}\",\n        \"             </div>\",\n        \"           ) : (\",\n        \"-            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\",\n        \"+            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents required</p>\",\n        \"           )}\",\n        \"         </div>\",\n        \"       </div>\"\n      ]\n    }\n  ],\n  \"userModified\": false,\n  \"replaceAll\": false\n}","timestamp":1769669237013,"toolName":"Edit","toolUseId":"toolu_01XH9zgFvRcvqSjwGkqYdsVa","toolInput":{"replace_all":false,"file_path":"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx","old_string":"          {/* Document List */}\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\n            <div className=\"flex flex-wrap gap-2\">\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\n                <button\n                  key={ev.id}\n                  onClick={() => onReferenceDocClick(ev)}\n                  className=\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\"\n                >\n                  <div className=\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\">\n                    <FileText className=\"size-4 text-blue-600\" />\n                  </div>\n                  <div className=\"text-left min-w-0\">\n                    <p className=\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\">\n                      {ev.linkedFileName || ev.name}\n                    </p>\n                    <p className=\"text-[10px] text-stone-400\">{ev.name}</p>\n                  </div>\n                </button>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-xs text-stone-400 text-pretty\">No documents uploaded yet</p>\n          )}","new_string":"          {/* Document List */}\n          {referenceEvidence.length > 0 ? (\n            <div className=\"flex flex-wrap gap-2\">\n              {referenceEvidence.map((ev) => (\n                <button\n                  key={ev.id}\n                  onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\n                  className={cn(\n                    \"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border transition-all\",\n                    ev.isUploaded\n                      ? \"border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm\"\n                      : \"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\"\n                  )}\n                >\n                  <div className={cn(\n                    \"size-8 rounded-md flex items-center justify-center shrink-0\",\n                    ev.isUploaded ? \"bg-blue-100\" : \"bg-stone-100\"\n                  )}>\n                    {ev.isUploaded ? (\n                      <FileText className=\"size-4 text-blue-600\" />\n                    ) : (\n                      <Upload className=\"size-4 text-stone-400\" />\n                    )}\n                  </div>\n                  <div className=\"text-left min-w-0\">\n                    <p className={cn(\n                      \"text-xs font-medium truncate max-w-[140px] transition-colors\",\n                      ev.isUploaded\n                        ? \"text-stone-700 group-hover:text-blue-700\"\n                        : \"text-stone-400\"\n                    )}>\n                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\n                    </p>\n                    {ev.isUploaded && (\n                      <p className=\"text-[10px] text-stone-400\">{ev.name}</p>\n                    )}\n                  </div>\n                </button>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-xs text-stone-400 text-pretty\">No documents required</p>\n          )}"},"toolResult":"{\n  \"filePath\": \"./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/components/case-detail/application/checklist/detail-panel/OverviewTab.tsx\",\n  \"oldString\": \"          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\",\n  \"newString\": \"          {/* Document List */}\\n          {referenceEvidence.length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\\n                  className={cn(\\n                    \\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border transition-all\\\",\\n                    ev.isUploaded\\n                      ? \\\"border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm\\\"\\n                      : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\\n                  )}\\n                >\\n                  <div className={cn(\\n                    \\\"size-8 rounded-md flex items-center justify-center shrink-0\\\",\\n                    ev.isUploaded ? \\\"bg-blue-100\\\" : \\\"bg-stone-100\\\"\\n                  )}>\\n                    {ev.isUploaded ? (\\n                      <FileText className=\\\"size-4 text-blue-600\\\" />\\n                    ) : (\\n                      <Upload className=\\\"size-4 text-stone-400\\\" />\\n                    )}\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className={cn(\\n                      \\\"text-xs font-medium truncate max-w-[140px] transition-colors\\\",\\n                      ev.isUploaded\\n                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\\n                        : \\\"text-stone-400\\\"\\n                    )}>\\n                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\\n                    </p>\\n                    {ev.isUploaded && (\\n                      <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                    )}\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents required</p>\\n          )}\",\n  \"originalFile\": \"\\\"use client\\\";\\n\\nimport { useMemo, useState, useEffect, useRef, Fragment } from \\\"react\\\";\\nimport {\\n  CheckCircle2,\\n  FileText,\\n  Paperclip,\\n  Check,\\n  AlertTriangle,\\n  Plus,\\n  Sparkles,\\n  Upload,\\n  PenLine,\\n  Loader2,\\n} from \\\"lucide-react\\\";\\nimport { cn } from \\\"@/lib/utils\\\";\\nimport {\\n  EnhancedChecklistItem,\\n  EnhancedQualityIssue,\\n  RequiredEvidence,\\n  DocumentGroup,\\n} from \\\"@/types/case-detail\\\";\\nimport { DocumentUploadModal } from \\\"./DocumentUploadModal\\\";\\nimport { CategoryReviewModal } from \\\"@/components/case-detail/shared/CategoryReviewModal\\\";\\nimport type { DetailTabId } from \\\"./ItemDetailTabs\\\";\\n\\n// Assessment field interface\\ninterface AssessmentField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  type: \\\"text\\\" | \\\"select\\\" | \\\"radio\\\";\\n  options?: { value: string; label: string }[];\\n  isRequired: boolean;\\n  isConditional?: boolean;\\n  dependsOn?: { fieldId: string; value: string };\\n  description?: string;\\n}\\n\\n// Field for display (includes both completed and missing)\\ninterface DisplayField {\\n  id: string;\\n  label: string;\\n  value: string | null;\\n  source: \\\"extracted\\\" | \\\"questionnaire\\\" | \\\"manual\\\" | null;\\n  sourceDocumentName?: string; // Name of the reference document this was extracted from\\n  status: \\\"complete\\\" | \\\"missing\\\" | \\\"low_confidence\\\";\\n  fieldType?: \\\"text\\\" | \\\"select\\\" | \\\"date\\\";\\n  options?: { value: string; label: string }[];\\n  confidenceScore?: number;\\n}\\n\\n// Props types\\ninterface ChecklistOverviewProps {\\n  itemType: \\\"checklist\\\";\\n  items: EnhancedChecklistItem[];\\n  issues: EnhancedQualityIssue[];\\n  formValues: Record<string, string>;\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\ninterface AssessmentOverviewProps {\\n  itemType: \\\"assessment\\\";\\n  fields: AssessmentField[];\\n  formValues: Record<string, string>;\\n  requiredEvidence: RequiredEvidence[];\\n  documentGroups: DocumentGroup[];\\n  onEditField: (fieldId: string) => void;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onNavigateToTab?: (tabId: DetailTabId) => void;\\n  onReanalyze?: () => void;\\n}\\n\\nexport type OverviewTabProps = ChecklistOverviewProps | AssessmentOverviewProps;\\n\\n// ============================================================================\\n// Circular Progress Ring Component\\n// ============================================================================\\nfunction ProgressRing({\\n  percent,\\n  isComplete,\\n  size = 56,\\n}: {\\n  percent: number;\\n  isComplete: boolean;\\n  size?: number;\\n}) {\\n  const strokeWidth = 5;\\n  const radius = (size - strokeWidth) / 2;\\n  const circumference = 2 * Math.PI * radius;\\n  const strokeDashoffset = circumference - (percent / 100) * circumference;\\n\\n  return (\\n    <div className=\\\"relative shrink-0\\\" style={{ width: size, height: size }}>\\n      <svg className=\\\"-rotate-90\\\" width={size} height={size}>\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          className=\\\"text-stone-200\\\"\\n        />\\n        <circle\\n          cx={size / 2}\\n          cy={size / 2}\\n          r={radius}\\n          fill=\\\"none\\\"\\n          stroke=\\\"currentColor\\\"\\n          strokeWidth={strokeWidth}\\n          strokeLinecap=\\\"round\\\"\\n          strokeDasharray={circumference}\\n          strokeDashoffset={strokeDashoffset}\\n          className={isComplete ? \\\"text-emerald-500\\\" : \\\"text-amber-500\\\"}\\n        />\\n      </svg>\\n      <div className=\\\"absolute inset-0 flex items-center justify-center\\\">\\n        {isComplete ? (\\n          <CheckCircle2 className=\\\"size-6 text-emerald-500\\\" />\\n        ) : (\\n          <span className=\\\"text-sm font-bold text-stone-700 tabular-nums\\\">{percent}%</span>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Reference Document Item - Shows doc name and analysis time\\n// ============================================================================\\nfunction ReferenceDocItem({\\n  evidence,\\n  analyzedAt,\\n  onClick,\\n}: {\\n  evidence: RequiredEvidence;\\n  analyzedAt?: string;\\n  onClick: () => void;\\n}) {\\n  const displayName = evidence.name.length > 14 ? evidence.name.slice(0, 14) + \\\"...\\\" : evidence.name;\\n\\n  // Format time ago\\n  const getTimeAgo = (dateStr?: string) => {\\n    if (!dateStr) return null;\\n    // For demo, just show a static time\\n    return \\\"2h ago\\\";\\n  };\\n\\n  return (\\n    <button\\n      onClick={onClick}\\n      className=\\\"w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-left hover:bg-stone-100 transition-colors\\\"\\n    >\\n      <FileText className=\\\"size-3.5 text-blue-500 shrink-0\\\" />\\n      <span className=\\\"text-xs font-medium text-stone-700 truncate flex-1\\\">\\n        {displayName}\\n      </span>\\n      {analyzedAt && (\\n        <span className=\\\"text-[10px] text-stone-400 shrink-0\\\">\\n          {getTimeAgo(analyzedAt)}\\n        </span>\\n      )}\\n    </button>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Summary + Fields Card Component\\n// ============================================================================\\nfunction SummaryFieldsCard({\\n  status,\\n  totalFields,\\n  completedFields,\\n  fields,\\n  formValues,\\n  referenceEvidence,\\n  isAnalyzing,\\n  onFieldChange,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  referenceEvidence: RequiredEvidence[];\\n  isAnalyzing: boolean;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const [pendingChanges, setPendingChanges] = useState<Record<string, string>>({});\\n  const [manuallyEditedFields, setManuallyEditedFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\n\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  // Check if there are pending changes\\n  const pendingFieldIds = Object.keys(pendingChanges).filter(\\n    (id) => pendingChanges[id] && pendingChanges[id].trim() !== \\\"\\\"\\n  );\\n  const hasPendingChanges = pendingFieldIds.length > 0;\\n\\n  // Handle local field change (store in pending, don't submit yet)\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    setPendingChanges((prev) => ({ ...prev, [fieldId]: value }));\\n    setManuallyEditedFields((prev) => new Set(prev).add(fieldId));\\n  };\\n\\n  // Submit all pending changes\\n  const handleSubmit = async () => {\\n    if (!hasPendingChanges) return;\\n    setIsSubmitting(true);\\n\\n    // Submit each pending change\\n    for (const fieldId of pendingFieldIds) {\\n      onFieldChange(fieldId, pendingChanges[fieldId]);\\n    }\\n\\n    // Clear pending changes after a brief delay for animation\\n    setTimeout(() => {\\n      setPendingChanges({});\\n      setIsSubmitting(false);\\n    }, 500);\\n  };\\n\\n  // Cancel pending changes\\n  const handleCancel = () => {\\n    setPendingChanges({});\\n    setManuallyEditedFields(new Set());\\n  };\\n\\n  // Get source badge\\n  const getSourceBadge = (field: DisplayField) => {\\n    if (field.source === \\\"extracted\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center px-1.5 py-0.5 text-[9px] font-medium text-blue-700 bg-blue-50 rounded\\\">\\n          Extracted\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"manual\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n          <PenLine className=\\\"size-2\\\" />\\n          Manual\\n        </span>\\n      );\\n    }\\n    if (field.source === \\\"questionnaire\\\") {\\n      return (\\n        <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-stone-600 bg-stone-100 rounded\\\">\\n          Questionnaire\\n        </span>\\n      );\\n    }\\n    return null;\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden flex flex-col flex-1 min-h-0\\\">\\n      {/* Header - Fixed height with Reference Documents */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-4\\\">\\n          {/* Left - Progress Summary */}\\n          <div className=\\\"shrink-0 flex items-center gap-3\\\">\\n            <ProgressRing percent={percent} isComplete={isComplete} size={48} />\\n            <div>\\n              <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Application Fields</h3>\\n              <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n                {completedFields} of {totalFields} completed\\n              </p>\\n            </div>\\n          </div>\\n\\n          {/* Divider */}\\n          <div className=\\\"w-px self-stretch bg-stone-200 shrink-0\\\" />\\n\\n          {/* Right - Reference Documents (vertical layout) */}\\n          <div className=\\\"flex-1 min-w-0 flex flex-col gap-2\\\">\\n            {/* Header row */}\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <div className=\\\"flex items-center gap-2\\\">\\n                <h4 className=\\\"text-xs font-semibold text-stone-700\\\">Reference Documents</h4>\\n                {isAnalyzing && (\\n                  <Loader2 className=\\\"size-3 text-blue-600 animate-spin\\\" />\\n                )}\\n              </div>\\n              <button\\n                onClick={onUploadClick}\\n                className=\\\"shrink-0 inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-md transition-colors\\\"\\n              >\\n                <Plus className=\\\"size-3\\\" />\\n                Add\\n              </button>\\n            </div>\\n            {/* Document cards row (horizontal scroll) - fixed min-height to prevent layout shift */}\\n            <div className=\\\"flex items-center gap-2 overflow-x-auto scrollbar-none min-h-[30px]\\\">\\n              {referenceEvidence.length > 0 ? (\\n                referenceEvidence.map((ev) => (\\n                  <button\\n                    key={ev.id}\\n                    onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\\n                    className={cn(\\n                      \\\"group shrink-0 inline-flex items-center gap-2 px-2 py-1.5 rounded-lg border transition-all\\\",\\n                      ev.isUploaded\\n                        ? \\\"border-stone-200 bg-white hover:border-blue-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\\n                    )}\\n                  >\\n                    {ev.isUploaded ? (\\n                      <FileText className=\\\"size-4 text-blue-500\\\" />\\n                    ) : (\\n                      <Upload className=\\\"size-3.5 text-stone-400\\\" />\\n                    )}\\n                    <span className={cn(\\n                      \\\"text-xs font-medium truncate max-w-[120px]\\\",\\n                      ev.isUploaded\\n                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\\n                        : \\\"text-stone-400\\\"\\n                    )}>\\n                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\\n                    </span>\\n                  </button>\\n                ))\\n              ) : (\\n                <span className=\\\"text-xs text-stone-400 leading-[30px]\\\">No documents required</span>\\n              )}\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n\\n      {/* Scrollable Content - min-h-0 is critical for flex overflow to work */}\\n      <div className=\\\"flex-1 min-h-0 p-4 overflow-y-auto\\\">\\n        {/* Fields Section Header */}\\n        <div className=\\\"flex items-center justify-between mb-3\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <h4 className=\\\"text-xs font-medium text-stone-600\\\">Fields</h4>\\n            {missingFields.length > 0 && !showAllFields && (\\n              <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n                {missingFields.length} missing\\n              </span>\\n            )}\\n          </div>\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? \\\"Show unanswered\\\" : \\\"Show all\\\"}\\n          </button>\\n        </div>\\n\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All fields have been filled</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2\\\">\\n            {displayFields.map((field) => {\\n              // Use pending value if exists, otherwise use stored value\\n              const storedValue = formValues[field.id] || field.value || \\\"\\\";\\n              const currentValue = pendingChanges[field.id] !== undefined ? pendingChanges[field.id] : storedValue;\\n              const hasPendingValue = pendingChanges[field.id] !== undefined && pendingChanges[field.id].trim() !== \\\"\\\";\\n              const isMissing = field.status === \\\"missing\\\" && !hasPendingValue;\\n              const isCompleted = !isMissing && (currentValue || hasPendingValue);\\n              // Check if user has manually entered/edited this field in this session\\n              const isManuallyEdited = manuallyEditedFields.has(field.id);\\n\\n              // Determine which badge to show\\n              const renderSourceBadge = () => {\\n                if (hasPendingValue) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-amber-700 bg-amber-100 rounded\\\">\\n                      Pending\\n                    </span>\\n                  );\\n                }\\n                if (isManuallyEdited) {\\n                  return (\\n                    <span className=\\\"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[9px] font-medium text-violet-700 bg-violet-50 rounded\\\">\\n                      <PenLine className=\\\"size-2\\\" />\\n                      Manual\\n                    </span>\\n                  );\\n                }\\n                return getSourceBadge(field);\\n              };\\n\\n              return (\\n                <div\\n                  key={field.id}\\n                  className={cn(\\n                    \\\"p-2.5 rounded-lg border transition-colors\\\",\\n                    hasPendingValue\\n                      ? \\\"border-blue-200 bg-blue-50/30\\\"\\n                      : isMissing\\n                        ? \\\"border-amber-200 bg-amber-50/50\\\"\\n                        : \\\"border-stone-100 bg-stone-50/30\\\"\\n                  )}\\n                >\\n                  <div className=\\\"flex items-center gap-2 mb-1.5\\\">\\n                    {isCompleted ? (\\n                      <CheckCircle2 className={cn(\\n                        \\\"size-3.5 shrink-0\\\",\\n                        hasPendingValue ? \\\"text-blue-500\\\" : \\\"text-emerald-500\\\"\\n                      )} />\\n                    ) : (\\n                      <div className=\\\"size-3.5 rounded-full border-2 border-amber-400 shrink-0\\\" />\\n                    )}\\n                    <label className={cn(\\n                      \\\"text-xs font-medium truncate flex-1\\\",\\n                      isMissing ? \\\"text-stone-700\\\" : \\\"text-stone-500\\\"\\n                    )}>\\n                      {field.label}\\n                    </label>\\n                    {renderSourceBadge()}\\n                  </div>\\n\\n                  {/* All fields are editable */}\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className={cn(\\n                        \\\"w-full px-2.5 py-1.5 text-xs rounded-md border bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\",\\n                        hasPendingValue ? \\\"border-blue-300\\\" : isMissing ? \\\"border-stone-200\\\" : \\\"border-stone-100\\\"\\n                      )}\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Footer - shows when there are pending changes */}\\n      {hasPendingChanges && (\\n        <div className=\\\"shrink-0 px-4 py-3 border-t border-stone-100 flex items-center justify-between bg-stone-50/50\\\">\\n          <p className=\\\"text-xs text-stone-500 tabular-nums\\\">\\n            {pendingFieldIds.length} field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"} pending\\n          </p>\\n          <div className=\\\"flex items-center gap-2\\\">\\n            <button\\n              onClick={handleCancel}\\n              disabled={isSubmitting}\\n              className=\\\"px-3 py-1.5 text-xs font-medium text-stone-600 hover:text-stone-800 hover:bg-stone-100 rounded-lg transition-colors disabled:opacity-50\\\"\\n            >\\n              Cancel\\n            </button>\\n            <button\\n              onClick={handleSubmit}\\n              disabled={isSubmitting}\\n              className=\\\"px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors flex items-center gap-1.5 disabled:opacity-50\\\"\\n            >\\n              {isSubmitting ? (\\n                <>\\n                  <Loader2 className=\\\"size-3.5 animate-spin\\\" />\\n                  Saving...\\n                </>\\n              ) : (\\n                <>\\n                  <Check className=\\\"size-3.5\\\" />\\n                  Save {pendingFieldIds.length} Field{pendingFieldIds.length !== 1 ? \\\"s\\\" : \\\"\\\"}\\n                </>\\n              )}\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Original Summary Section Component (for non-employment sections)\\n// ============================================================================\\nfunction SummarySection({\\n  status,\\n  totalFields,\\n  completedFields,\\n  referenceEvidence,\\n  onReferenceDocClick,\\n  onUploadClick,\\n}: {\\n  status: \\\"complete\\\" | \\\"partial\\\" | \\\"empty\\\";\\n  totalFields: number;\\n  completedFields: number;\\n  referenceEvidence: RequiredEvidence[];\\n  onReferenceDocClick: (evidence: RequiredEvidence) => void;\\n  onUploadClick: () => void;\\n}) {\\n  const percent = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;\\n  const isComplete = status === \\\"complete\\\";\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden\\\">\\n      <div className=\\\"flex items-stretch\\\">\\n        {/* Left - Progress Summary */}\\n        <div className=\\\"shrink-0 p-4 flex items-center gap-4 border-r border-stone-100\\\">\\n          <ProgressRing percent={percent} isComplete={isComplete} size={56} />\\n          <div>\\n            <span\\n              className={cn(\\n                \\\"inline-flex items-center px-2 py-1 text-xs font-semibold rounded-md\\\",\\n                isComplete\\n                  ? \\\"bg-emerald-100 text-emerald-700\\\"\\n                  : \\\"bg-amber-100 text-amber-700\\\"\\n              )}\\n            >\\n              {isComplete ? \\\"Complete\\\" : \\\"In Progress\\\"}\\n            </span>\\n            <p className=\\\"text-sm font-medium text-stone-700 mt-1.5 tabular-nums\\\">\\n              {completedFields}/{totalFields} fields\\n            </p>\\n          </div>\\n        </div>\\n\\n        {/* Right - Reference Documents (flexible width) */}\\n        <div className=\\\"flex-1 p-4\\\">\\n          {/* Header */}\\n          <div className=\\\"flex items-center justify-between mb-3\\\">\\n            <div>\\n              <h4 className=\\\"text-xs font-semibold text-stone-700 text-balance\\\">Reference Documents</h4>\\n              <p className=\\\"text-[10px] text-stone-400 text-pretty\\\">Source files for data extraction</p>\\n            </div>\\n            <button\\n              onClick={onUploadClick}\\n              className=\\\"inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-[#0E4268] bg-[#0E4268]/5 hover:bg-[#0E4268]/10 rounded-lg transition-colors\\\"\\n            >\\n              <Plus className=\\\"size-3.5\\\" />\\n              Add\\n            </button>\\n          </div>\\n\\n          {/* Document List */}\\n          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\\n            <div className=\\\"flex flex-wrap gap-2\\\">\\n              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\\n                <button\\n                  key={ev.id}\\n                  onClick={() => onReferenceDocClick(ev)}\\n                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\\n                >\\n                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\\n                    <FileText className=\\\"size-4 text-blue-600\\\" />\\n                  </div>\\n                  <div className=\\\"text-left min-w-0\\\">\\n                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\\n                      {ev.linkedFileName || ev.name}\\n                    </p>\\n                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\\n                  </div>\\n                </button>\\n              ))}\\n            </div>\\n          ) : (\\n            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\\n          )}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Missing Information Card - Shows fields that still need to be completed\\n// ============================================================================\\nfunction MissingInformationCard({\\n  fields,\\n  formValues,\\n  onFieldChange,\\n  onViewMore,\\n}: {\\n  fields: DisplayField[];\\n  formValues: Record<string, string>;\\n  onFieldChange: (fieldId: string, value: string) => void;\\n  onViewMore?: () => void;\\n}) {\\n  const [savingFields, setSavingFields] = useState<Set<string>>(new Set());\\n  const [showAllFields, setShowAllFields] = useState(false);\\n\\n  // Filter to only show missing fields\\n  const missingFields = fields.filter(f => f.status === \\\"missing\\\");\\n  const completedCount = fields.length - missingFields.length;\\n\\n  // Fields to display based on toggle\\n  const displayFields = showAllFields ? fields : missingFields;\\n\\n  const handleFieldChange = (fieldId: string, value: string) => {\\n    onFieldChange(fieldId, value);\\n    setSavingFields((prev) => new Set(prev).add(fieldId));\\n    setTimeout(() => {\\n      setSavingFields((prev) => {\\n        const next = new Set(prev);\\n        next.delete(fieldId);\\n        return next;\\n      });\\n    }, 1000);\\n  };\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      <div className=\\\"px-4 py-3 border-b border-stone-100 flex items-center justify-between\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Missing Information</h3>\\n          {missingFields.length > 0 && (\\n            <span className=\\\"px-1.5 py-0.5 text-[10px] font-medium text-amber-700 bg-amber-100 rounded tabular-nums\\\">\\n              {missingFields.length}\\n            </span>\\n          )}\\n        </div>\\n        {/* Toggle between showing missing only vs all fields */}\\n        {completedCount > 0 && (\\n          <button\\n            onClick={() => setShowAllFields(!showAllFields)}\\n            className=\\\"text-xs font-medium text-stone-500 hover:text-stone-700 transition-colors\\\"\\n          >\\n            {showAllFields ? (missingFields.length > 0 ? \\\"Show unanswered\\\" : \\\"Hide all\\\") : \\\"Show all\\\"}\\n          </button>\\n        )}\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {missingFields.length === 0 && !showAllFields ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center py-6 text-center\\\">\\n            <div className=\\\"size-10 rounded-full bg-emerald-100 flex items-center justify-center mb-2\\\">\\n              <CheckCircle2 className=\\\"size-5 text-emerald-500\\\" />\\n            </div>\\n            <p className=\\\"text-sm font-medium text-stone-700\\\">All complete</p>\\n            <p className=\\\"text-xs text-stone-400 mt-0.5 text-pretty\\\">All information has been provided</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-2.5\\\">\\n            {displayFields.slice(0, showAllFields ? undefined : 6).map((field) => {\\n              const currentValue = formValues[field.id] || field.value || \\\"\\\";\\n              const isSaving = savingFields.has(field.id);\\n              const isCompleted = field.status !== \\\"missing\\\";\\n\\n              return (\\n                <div key={field.id} className=\\\"space-y-1.5\\\">\\n                  <div className=\\\"flex items-center gap-2\\\">\\n                    <div className={cn(\\n                      \\\"size-3.5 rounded-full border-2 shrink-0\\\",\\n                      isCompleted ? \\\"bg-emerald-500 border-emerald-500\\\" : \\\"border-amber-400\\\"\\n                    )} />\\n                    <label className=\\\"text-xs font-medium text-stone-600 truncate flex-1\\\">\\n                      {field.label}\\n                    </label>\\n                    {isSaving && (\\n                      <span className=\\\"inline-flex items-center gap-0.5 px-1 py-0.5 text-[9px] font-medium text-emerald-700 bg-emerald-100 rounded\\\">\\n                        <Check className=\\\"size-2\\\" />\\n                        Saved\\n                      </span>\\n                    )}\\n                  </div>\\n\\n                  {field.fieldType === \\\"select\\\" && field.options ? (\\n                    <select\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors\\\"\\n                    >\\n                      <option value=\\\"\\\">Select...<./option>\\n                      {field.options.map((opt) => (\\n                        <option key={opt.value} value={opt.value}>{opt.label}<./option>\\n                      ))}\\n                    </select>\\n                  ) : (\\n                    <input\\n                      type={field.fieldType === \\\"date\\\" ? \\\"date\\\" : \\\"text\\\"}\\n                      value={currentValue}\\n                      onChange={(e) => handleFieldChange(field.id, e.target.value)}\\n                      placeholder={`Enter ${field.label.toLowerCase()}...`}\\n                      className=\\\"w-full px-2.5 py-1.5 text-xs rounded-md border border-stone-200 bg-white focus:border-[#0E4268] focus:ring-[#0E4268]/10 focus:outline-none focus:ring-2 transition-colors placeholder:text-stone-400\\\"\\n                    />\\n                  )}\\n                </div>\\n              );\\n            })}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Combined Evidence Slot - Shows grouped document requirements\\n// ============================================================================\\nfunction CombinedEvidenceSlotInline({\\n  title,\\n  relationship,\\n  documents,\\n  onAddClick,\\n}: {\\n  title: string;\\n  relationship: \\\"all\\\" | \\\"any\\\";\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n}) {\\n  const uploadedCount = documents.filter(d => d.isUploaded).length;\\n  const totalCount = documents.length;\\n  const isComplete = relationship === \\\"all\\\"\\n    ? uploadedCount === totalCount\\n    : uploadedCount >= 1;\\n\\n  return (\\n    <div className={cn(\\n      \\\"rounded-xl border-2 overflow-hidden transition-all\\\",\\n      isComplete\\n        ? \\\"border-emerald-300 bg-gradient-to-b from-emerald-50 to-white shadow-sm\\\"\\n        : \\\"border-stone-200 bg-white\\\"\\n    )}>\\n      {/* Header */}\\n      <div className={cn(\\n        \\\"px-3 py-2.5 border-b\\\",\\n        isComplete ? \\\"border-emerald-200 bg-emerald-50\\\" : \\\"border-stone-100 bg-stone-50\\\"\\n      )}>\\n        <div className=\\\"flex items-center justify-between\\\">\\n          <div className=\\\"flex items-center gap-2\\\">\\n            {isComplete && (\\n              <CheckCircle2 className=\\\"size-4 text-emerald-500\\\" />\\n            )}\\n            <span className={cn(\\n              \\\"text-xs font-semibold\\\",\\n              isComplete ? \\\"text-emerald-700\\\" : \\\"text-stone-700\\\"\\n            )}>\\n              {title}\\n            </span>\\n            {/* Relationship badge */}\\n            <span className={cn(\\n              \\\"px-1.5 py-0.5 text-[9px] font-bold uppercase rounded\\\",\\n              isComplete\\n                ? \\\"bg-emerald-200 text-emerald-700\\\"\\n                : relationship === \\\"all\\\"\\n                  ? \\\"bg-stone-200 text-stone-600\\\"\\n                  : \\\"bg-blue-100 text-blue-600\\\"\\n            )}>\\n              {isComplete ? \\\"Complete\\\" : relationship === \\\"all\\\" ? \\\"All required\\\" : \\\"Any one\\\"}\\n            </span>\\n          </div>\\n          <span className={cn(\\n            \\\"text-[10px] font-semibold tabular-nums\\\",\\n            isComplete ? \\\"text-emerald-600\\\" : \\\"text-stone-500\\\"\\n          )}>\\n            {uploadedCount}/{totalCount}\\n          </span>\\n        </div>\\n      </div>\\n\\n      {/* Document slots - horizontal flex layout */}\\n      <div className=\\\"p-3\\\">\\n        <div className=\\\"flex items-center gap-2\\\">\\n          {documents.map((doc, idx) => (\\n            <Fragment key={doc.id}>\\n              {/* Slot - flex-1 for equal width, fixed height */}\\n              <button\\n                onClick={() => onAddClick(doc)}\\n                className={cn(\\n                  \\\"flex-1 min-w-0 h-24 rounded-lg border-2 transition-all flex flex-col items-center justify-center gap-2 px-2\\\",\\n                  doc.isUploaded\\n                    ? \\\"border-emerald-300 bg-emerald-50 hover:border-emerald-400 hover:shadow-sm\\\"\\n                    : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100\\\"\\n                )}\\n              >\\n                {doc.isUploaded ? (\\n                  <>\\n                    {/* Uploaded state - document preview style */}\\n                    <div className=\\\"relative\\\">\\n                      <div className=\\\"w-10 h-12 rounded bg-white border border-emerald-200 shadow-sm flex flex-col p-1.5 gap-0.5\\\">\\n                        <div className=\\\"h-0.5 bg-emerald-300 rounded w-2/3\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-full\\\" />\\n                        <div className=\\\"h-0.5 bg-emerald-200 rounded w-4/5\\\" />\\n                      </div>\\n                      <div className=\\\"absolute -top-1 -right-1 size-4 rounded-full bg-emerald-500 flex items-center justify-center\\\">\\n                        <Check className=\\\"size-2.5 text-white\\\" strokeWidth={3} />\\n                      </div>\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-emerald-700 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.linkedFileName || doc.name}\\n                    </span>\\n                  </>\\n                ) : (\\n                  <>\\n                    {/* Empty state */}\\n                    <div className=\\\"size-10 rounded-lg bg-white border-2 border-dashed border-stone-300 flex items-center justify-center\\\">\\n                      <Upload className=\\\"size-4 text-stone-400\\\" />\\n                    </div>\\n                    <span className=\\\"text-[10px] font-medium text-stone-500 text-center line-clamp-1 max-w-full\\\">\\n                      {doc.name}\\n                    </span>\\n                  </>\\n                )}\\n              </button>\\n\\n              {/* Connector between slots */}\\n              {idx < documents.length - 1 && (\\n                <div className=\\\"shrink-0 flex items-center justify-center\\\">\\n                  <span className={cn(\\n                    \\\"px-2 py-1 text-[9px] font-bold rounded-full\\\",\\n                    isComplete\\n                      ? \\\"bg-emerald-100 text-emerald-600\\\"\\n                      : relationship === \\\"all\\\"\\n                        ? \\\"bg-stone-100 text-stone-500\\\"\\n                        : \\\"bg-blue-50 text-blue-500\\\"\\n                  )}>\\n                    {relationship === \\\"all\\\" ? \\\"+\\\" : \\\"or\\\"}\\n                  </span>\\n                </div>\\n              )}\\n            </Fragment>\\n          ))}\\n        </div>\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Supporting Documents Card - Shows all document slots as cards\\n// ============================================================================\\nfunction SupportingDocumentsCard({\\n  documents,\\n  onAddClick,\\n  onViewMore,\\n}: {\\n  documents: RequiredEvidence[];\\n  onAddClick: (evidence: RequiredEvidence) => void;\\n  onViewMore?: () => void;\\n}) {\\n  // Group documents by type for combined evidence slots\\n  const groupedDocs = useMemo(() => {\\n    // Check if we have bank statements and payslip - combine them as Financial Evidence\\n    const bankStatements = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"bank statement\\\")\\n    );\\n    const payslip = documents.find(d =>\\n      d.name.toLowerCase().includes(\\\"payslip\\\")\\n    );\\n\\n    // If we have both bank statements and payslip, group them\\n    if (bankStatements && payslip) {\\n      const financialGroup = {\\n        title: \\\"Financial Evidence\\\",\\n        relationship: \\\"all\\\" as const, // Both bank statements AND payslip required\\n        documents: [bankStatements, payslip],\\n      };\\n\\n      // Get remaining standalone documents\\n      const groupedIds = new Set([bankStatements.id, payslip.id]);\\n      const standalone = documents.filter(d => !groupedIds.has(d.id));\\n\\n      return { groups: [financialGroup], standalone };\\n    }\\n\\n    // No grouping needed\\n    return { groups: [], standalone: documents };\\n  }, [documents]);\\n\\n  // Calculate counts treating combined groups as single items\\n  const counts = useMemo(() => {\\n    // Total = number of groups + number of standalone docs\\n    const totalCount = groupedDocs.groups.length + groupedDocs.standalone.length;\\n\\n    // Uploaded count for groups (based on relationship)\\n    const uploadedGroups = groupedDocs.groups.filter(group => {\\n      const uploadedInGroup = group.documents.filter(d => d.isUploaded).length;\\n      if (group.relationship === \\\"all\\\") {\\n        return uploadedInGroup === group.documents.length;\\n      } else {\\n        return uploadedInGroup >= 1;\\n      }\\n    }).length;\\n\\n    // Uploaded count for standalone docs\\n    const uploadedStandalone = groupedDocs.standalone.filter(d => d.isUploaded).length;\\n\\n    const uploadedCount = uploadedGroups + uploadedStandalone;\\n\\n    return { totalCount, uploadedCount };\\n  }, [groupedDocs]);\\n\\n  const percent = counts.totalCount > 0 ? Math.round((counts.uploadedCount / counts.totalCount) * 100) : 0;\\n  const isComplete = counts.uploadedCount === counts.totalCount && counts.totalCount > 0;\\n\\n  return (\\n    <div className=\\\"rounded-xl border border-stone-200 bg-white overflow-hidden h-full flex flex-col\\\">\\n      {/* Header - matches Application Fields box structure */}\\n      <div className=\\\"shrink-0 p-4 border-b border-stone-100\\\">\\n        <div className=\\\"flex items-center gap-3\\\">\\n          <ProgressRing\\n            percent={percent}\\n            isComplete={isComplete}\\n            size={48}\\n          />\\n          <div className=\\\"flex-1\\\">\\n            <h3 className=\\\"text-sm font-semibold text-stone-700 text-balance\\\">Supporting Documents</h3>\\n            <p className=\\\"text-[11px] text-stone-400 tabular-nums\\\">\\n              {counts.uploadedCount} of {counts.totalCount} uploaded\\n            </p>\\n          </div>\\n        </div>\\n      </div>\\n\\n      <div className=\\\"flex-1 p-4 overflow-y-auto\\\">\\n        {documents.length === 0 ? (\\n          <div className=\\\"h-full flex flex-col items-center justify-center text-center py-6\\\">\\n            <div className=\\\"size-10 rounded-full bg-stone-100 flex items-center justify-center mb-3\\\">\\n              <Paperclip className=\\\"size-5 text-stone-400\\\" />\\n            </div>\\n            <p className=\\\"text-sm text-stone-500 text-pretty\\\">No supporting documents required</p>\\n          </div>\\n        ) : (\\n          <div className=\\\"space-y-3\\\">\\n            {/* Combined Evidence Groups */}\\n            {groupedDocs.groups.map((group, idx) => (\\n              <CombinedEvidenceSlotInline\\n                key={`group-${idx}`}\\n                title={group.title}\\n                relationship={group.relationship}\\n                documents={group.documents}\\n                onAddClick={onAddClick}\\n              />\\n            ))}\\n\\n            {/* Standalone Documents */}\\n            {groupedDocs.standalone.length > 0 && (\\n              <div className=\\\"space-y-2\\\">\\n                {groupedDocs.standalone.map((doc) => (\\n                  <button\\n                    key={doc.id}\\n                    onClick={() => onAddClick(doc)}\\n                    className={cn(\\n                      \\\"w-full p-3 rounded-lg border-2 transition-colors text-left\\\",\\n                      doc.isUploaded\\n                        ? \\\"border-emerald-200 bg-emerald-50/50 hover:border-emerald-300\\\"\\n                        : \\\"border-dashed border-stone-300 bg-stone-50/50 hover:border-stone-400 hover:bg-stone-100/50\\\"\\n                    )}\\n                  >\\n                    <div className=\\\"flex items-start gap-3\\\">\\n                      <div className={cn(\\n                        \\\"size-9 rounded-lg flex items-center justify-center shrink-0\\\",\\n                        doc.isUploaded\\n                          ? \\\"bg-emerald-100\\\"\\n                          : \\\"bg-stone-100 border border-dashed border-stone-300\\\"\\n                      )}>\\n                        {doc.isUploaded ? (\\n                          <FileText className=\\\"size-4 text-emerald-600\\\" />\\n                        ) : (\\n                          <Upload className=\\\"size-4 text-stone-400\\\" />\\n                        )}\\n                      </div>\\n                      <div className=\\\"flex-1 min-w-0\\\">\\n                        <div className=\\\"flex items-center gap-2\\\">\\n                          <span className={cn(\\n                            \\\"text-xs font-medium truncate\\\",\\n                            doc.isUploaded ? \\\"text-stone-700\\\" : \\\"text-stone-600\\\"\\n                          )}>\\n                            {doc.name}\\n                          </span>\\n                          {doc.isUploaded && (\\n                            <CheckCircle2 className=\\\"size-3.5 text-emerald-500 shrink-0\\\" />\\n                          )}\\n                        </div>\\n                        {doc.isUploaded && doc.linkedFileName && (\\n                          <p className=\\\"text-[11px] text-emerald-600 mt-0.5 truncate\\\">\\n                            {doc.linkedFileName}\\n                          </p>\\n                        )}\\n                        {!doc.isUploaded && doc.description && (\\n                          <p className=\\\"text-[10px] text-stone-400 mt-0.5 line-clamp-1 text-pretty\\\">\\n                            {doc.description}\\n                          </p>\\n                        )}\\n                      </div>\\n                      {!doc.isUploaded && (\\n                        <Plus className=\\\"size-4 text-stone-400 shrink-0\\\" />\\n                      )}\\n                    </div>\\n                  </button>\\n                ))}\\n              </div>\\n            )}\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\\n// ============================================================================\\n// Mock extracted data for simulation\\n// ============================================================================\\nconst MOCK_EXTRACTED_DATA: Record<string, { value: string; sourceDoc: string }> = {\\n  \\\"emp-job-title\\\": { value: \\\"Senior Software Engineer\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-soc-code\\\": { value: \\\"2136\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-salary\\\": { value: \\\"£65,000\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-start-date\\\": { value: \\\"2024-03-01\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-name\\\": { value: \\\"Tech Solutions Ltd\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-sponsor-number\\\": { value: \\\"ABC123456\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-cos-number\\\": { value: \\\"S1234567890\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n  \\\"emp-working-hours\\\": { value: \\\"37.5 hours per week\\\", sourceDoc: \\\"Certificate of Sponsorship\\\" },\\n};\\n\\n// ============================================================================\\n// Main Overview Tab Component\\n// ============================================================================\\nexport function OverviewTab(props: OverviewTabProps) {\\n  const { itemType, formValues, documentGroups, onFieldChange, onNavigateToTab, onReanalyze } = props;\\n  const [selectedEvidence, setSelectedEvidence] = useState<RequiredEvidence | null>(null);\\n  const [previewGroup, setPreviewGroup] = useState<DocumentGroup | null>(null);\\n  const [needsReanalysis, setNeedsReanalysis] = useState(false);\\n\\n  // Analysis simulation state\\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\\n\\n  // Track reference document upload count to detect changes\\n  const prevRefUploadedRef = useRef<number | null>(null);\\n\\n  // Calculate stats\\n  const stats = useMemo(() => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      const completedFields = items.filter((i) => !!formValues[i.id] || !!i.value).length;\\n      const totalFields = items.length;\\n\\n      // Collect all evidence from items\\n      const evidenceMap = new Map<string, RequiredEvidence>();\\n      items.forEach((item) => {\\n        item.requiredEvidence?.forEach((ev) => {\\n          if (!evidenceMap.has(ev.id)) {\\n            evidenceMap.set(ev.id, ev);\\n          }\\n        });\\n      });\\n      const allEvidence = Array.from(evidenceMap.values());\\n\\n      // Reference docs: passport, CoS, etc. (used for data extraction)\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else (evidence for proof)\\n      const supportingEvidence = allEvidence.filter((ev) =>\\n        !referenceEvidence.includes(ev)\\n      );\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    } else {\\n      // Assessment type\\n      const fields = props.fields;\\n      const completedFields = fields.filter((f) => !!formValues[f.id]).length;\\n      const totalFields = fields.length;\\n      const allEvidence = props.requiredEvidence || [];\\n\\n      // Reference docs for assessment\\n      const referenceKeywords = [\\\"passport\\\", \\\"cos\\\", \\\"certificate of sponsorship\\\", \\\"biometric\\\"];\\n      const referenceEvidence = allEvidence.filter((ev) =>\\n        referenceKeywords.some((kw) => ev.name.toLowerCase().includes(kw))\\n      );\\n\\n      // Supporting docs: everything else\\n      const supportingEvidence = allEvidence.filter((ev) => !referenceEvidence.includes(ev));\\n\\n      return {\\n        completedFields,\\n        totalFields,\\n        referenceEvidence,\\n        supportingEvidence,\\n        allEvidence,\\n      };\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Prepare all fields for display\\n  const displayFields = useMemo((): DisplayField[] => {\\n    if (itemType === \\\"checklist\\\") {\\n      const items = props.items;\\n      return items.map((item) => {\\n        const hasValue = !!formValues[item.id] || !!item.value;\\n        const isLowConfidence = item.source === \\\"extracted\\\" &&\\n          item.confidenceScore !== undefined &&\\n          item.confidenceScore < 80;\\n\\n        // Get source document name from linkedDocuments\\n        const sourceDocName = item.source === \\\"extracted\\\" && item.linkedDocuments?.length > 0\\n          ? item.linkedDocuments[0].groupTitle || item.linkedDocuments[0].fileName\\n          : undefined;\\n\\n        return {\\n          id: item.id,\\n          label: item.label,\\n          value: formValues[item.id] || item.value,\\n          source: item.source,\\n          sourceDocumentName: sourceDocName,\\n          status: isLowConfidence ? \\\"low_confidence\\\" : (hasValue ? \\\"complete\\\" : \\\"missing\\\"),\\n          fieldType: \\\"text\\\",\\n          confidenceScore: item.confidenceScore,\\n        };\\n      });\\n    } else {\\n      const fields = props.fields;\\n      return fields.map((field) => ({\\n        id: field.id,\\n        label: field.label,\\n        value: formValues[field.id] || field.value,\\n        source: formValues[field.id] ? \\\"manual\\\" : null,\\n        status: formValues[field.id] ? \\\"complete\\\" : \\\"missing\\\",\\n        fieldType: field.type === \\\"select\\\" ? \\\"select\\\" : \\\"text\\\",\\n        options: field.options,\\n      }));\\n    }\\n  }, [itemType, formValues, props]);\\n\\n  // Status helpers\\n  const getFieldStatus = () => {\\n    if (stats.completedFields === stats.totalFields) return \\\"complete\\\";\\n    if (stats.completedFields > 0) return \\\"partial\\\";\\n    return \\\"empty\\\";\\n  };\\n\\n  const refUploaded = stats.referenceEvidence.filter((e) => e.isUploaded).length;\\n\\n  // Handle reference doc click - find linked group and open preview\\n  const handleReferenceDocClick = (evidence: RequiredEvidence) => {\\n    if (evidence.linkedFileId) {\\n      // Find the group containing this file\\n      const group = documentGroups.find((g) =>\\n        g.files.some((f) => f.id === evidence.linkedFileId)\\n      );\\n      if (group) {\\n        setPreviewGroup(group);\\n        return;\\n      }\\n    }\\n    // Fallback: open upload modal\\n    setSelectedEvidence(evidence);\\n  };\\n\\n  const handleUploadClick = () => {\\n    const firstRef = stats.referenceEvidence.find((e) => !e.isUploaded);\\n    if (firstRef) {\\n      setSelectedEvidence(firstRef);\\n    } else if (stats.referenceEvidence.length > 0) {\\n      setSelectedEvidence(stats.referenceEvidence[0]);\\n    }\\n  };\\n\\n  // Simulate document analysis\\n  const handleAnalyze = () => {\\n    if (isAnalyzing) return;\\n\\n    setIsAnalyzing(true);\\n\\n    // Simulate analysis delay\\n    setTimeout(() => {\\n      // Find empty fields and populate them with mock data\\n      if (itemType === \\\"checklist\\\") {\\n        let filledCount = 0;\\n\\n        props.items.forEach((item) => {\\n          const hasValue = !!formValues[item.id] || !!item.value;\\n          if (!hasValue) {\\n            // Check if we have mock data for this field\\n            const mockData = MOCK_EXTRACTED_DATA[item.id];\\n            if (mockData) {\\n              onFieldChange(item.id, mockData.value);\\n              filledCount++;\\n            }\\n          }\\n        });\\n\\n        // If no specific mock data, fill first 3 empty fields with generic data\\n        if (filledCount === 0) {\\n          const emptyItems = props.items.filter(\\n            (item) => !formValues[item.id] && !item.value\\n          ).slice(0, 3);\\n\\n          emptyItems.forEach((item, index) => {\\n            const genericValues = [\\\"Sample Value 1\\\", \\\"Sample Value 2\\\", \\\"Sample Value 3\\\"];\\n            onFieldChange(item.id, genericValues[index] || \\\"Extracted Value\\\");\\n          });\\n        }\\n      }\\n\\n      setIsAnalyzing(false);\\n      setNeedsReanalysis(false);\\n    }, 1500); // 1.5 second analysis simulation\\n  };\\n\\n  // Auto-analyze when new reference documents are added\\n  useEffect(() => {\\n    if (prevRefUploadedRef.current !== null && refUploaded > prevRefUploadedRef.current) {\\n      // Auto-trigger analysis when new document is uploaded\\n      handleAnalyze();\\n    }\\n    prevRefUploadedRef.current = refUploaded;\\n  }, [refUploaded]); // eslint-disable-line react-hooks/exhaustive-deps\\n\\n  return (\\n    <>\\n      <div className=\\\"h-full flex flex-col min-h-0\\\">\\n        <div className=\\\"flex-1 p-6 min-h-0 h-full\\\">\\n          {/* Unified layout for all sections: 2:1 grid for Fields : Supporting Documents */}\\n          <div className=\\\"grid grid-cols-3 gap-4 h-full\\\">\\n            <div className=\\\"col-span-2 h-full min-h-0 flex flex-col\\\">\\n              <SummaryFieldsCard\\n                status={getFieldStatus()}\\n                totalFields={stats.totalFields}\\n                completedFields={stats.completedFields}\\n                fields={displayFields}\\n                formValues={formValues}\\n                referenceEvidence={stats.referenceEvidence}\\n                isAnalyzing={isAnalyzing}\\n                onFieldChange={onFieldChange}\\n                onReferenceDocClick={handleReferenceDocClick}\\n                onUploadClick={handleUploadClick}\\n              />\\n            </div>\\n            <SupportingDocumentsCard\\n              documents={stats.supportingEvidence}\\n              onAddClick={(evidence) => setSelectedEvidence(evidence)}\\n              onViewMore={() => onNavigateToTab?.(\\\"supporting-documents\\\")}\\n            />\\n          </div>\\n        </div>\\n\\n        {/* Footer with Analyze button */}\\n        {needsReanalysis && onReanalyze && (\\n          <div className=\\\"shrink-0 px-6 py-3 border-t border-stone-200 bg-stone-50\\\">\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <p className=\\\"text-sm text-stone-600 text-pretty\\\">\\n                Reference documents ready for analysis.\\n              </p>\\n              <button\\n                onClick={handleAnalyze}\\n                className=\\\"inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-[#0E4268] hover:bg-[#0a3555] rounded-lg transition-colors\\\"\\n              >\\n                <Sparkles className=\\\"size-4\\\" />\\n                Analyze\\n              </button>\\n            </div>\\n          </div>\\n        )}\\n      </div>\\n\\n      {/* Document Upload Modal */}\\n      {selectedEvidence && (\\n        <DocumentUploadModal\\n          evidence={selectedEvidence}\\n          onClose={() => setSelectedEvidence(null)}\\n        />\\n      )}\\n\\n      {/* Document Preview Modal */}\\n      {previewGroup && (\\n        <CategoryReviewModal\\n          group={previewGroup}\\n          allGroups={documentGroups}\\n          onClose={() => setPreviewGroup(null)}\\n        />\\n      )}\\n    </>\\n  );\\n}\\n\",\n  \"structuredPatch\": [\n    {\n      \"oldStart\": 565,\n      \"oldLines\": 28,\n      \"newStart\": 565,\n      \"newLines\": 47,\n      \"lines\": [\n        \"           </div>\",\n        \" \",\n        \"           {/* Document List */}\",\n        \"-          {referenceEvidence.filter((e) => e.isUploaded).length > 0 ? (\",\n        \"+          {referenceEvidence.length > 0 ? (\",\n        \"             <div className=\\\"flex flex-wrap gap-2\\\">\",\n        \"-              {referenceEvidence.filter((e) => e.isUploaded).map((ev) => (\",\n        \"+              {referenceEvidence.map((ev) => (\",\n        \"                 <button\",\n        \"                   key={ev.id}\",\n        \"-                  onClick={() => onReferenceDocClick(ev)}\",\n        \"-                  className=\\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm transition-all\\\"\",\n        \"+                  onClick={() => ev.isUploaded ? onReferenceDocClick(ev) : onUploadClick()}\",\n        \"+                  className={cn(\",\n        \"+                    \\\"group inline-flex items-center gap-2.5 pl-2 pr-3 py-2 rounded-lg border transition-all\\\",\",\n        \"+                    ev.isUploaded\",\n        \"+                      ? \\\"border-stone-200 bg-white hover:border-blue-300 hover:shadow-sm\\\"\",\n        \"+                      : \\\"border-dashed border-stone-300 bg-stone-50 hover:border-stone-400\\\"\",\n        \"+                  )}\",\n        \"                 >\",\n        \"-                  <div className=\\\"size-8 rounded-md bg-blue-100 flex items-center justify-center shrink-0\\\">\",\n        \"-                    <FileText className=\\\"size-4 text-blue-600\\\" />\",\n        \"+                  <div className={cn(\",\n        \"+                    \\\"size-8 rounded-md flex items-center justify-center shrink-0\\\",\",\n        \"+                    ev.isUploaded ? \\\"bg-blue-100\\\" : \\\"bg-stone-100\\\"\",\n        \"+                  )}>\",\n        \"+                    {ev.isUploaded ? (\",\n        \"+                      <FileText className=\\\"size-4 text-blue-600\\\" />\",\n        \"+                    ) : (\",\n        \"+                      <Upload className=\\\"size-4 text-stone-400\\\" />\",\n        \"+                    )}\",\n        \"                   </div>\",\n        \"                   <div className=\\\"text-left min-w-0\\\">\",\n        \"-                    <p className=\\\"text-xs font-medium text-stone-700 truncate max-w-[140px] group-hover:text-blue-700 transition-colors\\\">\",\n        \"-                      {ev.linkedFileName || ev.name}\",\n        \"+                    <p className={cn(\",\n        \"+                      \\\"text-xs font-medium truncate max-w-[140px] transition-colors\\\",\",\n        \"+                      ev.isUploaded\",\n        \"+                        ? \\\"text-stone-700 group-hover:text-blue-700\\\"\",\n        \"+                        : \\\"text-stone-400\\\"\",\n        \"+                    )}>\",\n        \"+                      {ev.isUploaded ? (ev.linkedFileName || ev.name) : ev.name}\",\n        \"                     </p>\",\n        \"-                    <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\",\n        \"+                    {ev.isUploaded && (\",\n        \"+                      <p className=\\\"text-[10px] text-stone-400\\\">{ev.name}</p>\",\n        \"+                    )}\",\n        \"                   </div>\",\n        \"                 </button>\",\n        \"               ))}\",\n        \"             </div>\",\n        \"           ) : (\",\n        \"-            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents uploaded yet</p>\",\n        \"+            <p className=\\\"text-xs text-stone-400 text-pretty\\\">No documents required</p>\",\n        \"           )}\",\n        \"         </div>\",\n        \"       </div>\"\n      ]\n    }\n  ],\n  \"userModified\": false,\n  \"replaceAll\": false\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Edit","category":"native"},"isError":false,"turnId":"msg_01JACyZr195z2GajZg5NAGJL"}
{"id":"msg-1769669246830-xa0fla","type":"assistant","content":"Now update `SummarySection` (the non-employment variant):","timestamp":1769669246830,"isIntermediate":true,"turnId":"msg_01JACyZr195z2GajZg5NAGJL"}
{"id":"msg-1769669250161-jhqeqi","type":"tool","content":"{\n  \"oldTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ],\n  \"newTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ]\n}","timestamp":1769669250161,"toolName":"TodoWrite","toolUseId":"toolu_01MdD4uRvVUwrHTNs6p64y2C","toolInput":{"todos":[{"content":"Store: Add auto-mapping logic in generateEnhancedChecklist()","status":"completed","activeForm":"Adding auto-mapping logic in store"},{"content":"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard","status":"completed","activeForm":"Updating SummaryFieldsCard rendering"},{"content":"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection","status":"completed","activeForm":"Updating SummarySection rendering"}]},"toolResult":"{\n  \"oldTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"in_progress\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ],\n  \"newTodos\": [\n    {\n      \"content\": \"Store: Add auto-mapping logic in generateEnhancedChecklist()\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Adding auto-mapping logic in store\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummaryFieldsCard\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Updating SummaryFieldsCard rendering\"\n    },\n    {\n      \"content\": \"OverviewTab: Show all evidence items (filled + empty slots) in SummarySection\",\n      \"status\": \"completed\",\n      \"activeForm\": \"Updating SummarySection rendering\"\n    }\n  ]\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Update Todos","category":"native"},"isError":false,"turnId":"msg_016sXCvweGNex69UZapcWktx"}
{"id":"msg-1769669256990-beke1p","type":"tool","content":"{\n  \"stdout\": \"\",\n  \"stderr\": \"Shell cwd was reset to ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill\",\n  \"interrupted\": false,\n  \"isImage\": false\n}","timestamp":1769669256990,"toolName":"Bash","toolUseId":"toolu_01Nz2tSyRonbo4dsxHQuVjWG","toolInput":{"command":"cd ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2 && npx tsc --noEmit --pretty 2>&1 | head -40","description":"Type-check the project","timeout":60000},"toolResult":"{\n  \"stdout\": \"\",\n  \"stderr\": \"Shell cwd was reset to ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill\",\n  \"interrupted\": false,\n  \"isImage\": false\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Terminal","category":"native"},"isError":false,"turnId":"msg_01RSuGwayRJqc9mG2ZrEKixj"}
{"id":"msg-1769669258925-dvbvyq","type":"assistant","content":"Let me verify the build compiles.","timestamp":1769669258925,"isIntermediate":true,"turnId":"msg_01RSuGwayRJqc9mG2ZrEKixj"}
{"id":"msg-1769669264273-cixe8w","type":"tool","content":"{\n  \"stdout\": \"`next lint` is deprecated and will be removed in Next.js 16.\\nFor new projects, use create-next-app to choose your preferred linter.\\nFor existing projects, migrate to the ESLint CLI:\\nnpx @next/codemod@canary next-lint-to-eslint-cli .\\n\\n? How would you like to configure ESLint? https://nextjs.org/docs/app/api-reference/config/eslint\\n\\u001b[?25l❯  Strict (recommended)\\n   Base\\n   Cancel ⚠ If you set up ESLint yourself, we recommend adding the Next.js ESLint plugin. See https://nextjs.org/docs/app/api-reference/config/eslint#migrating-existing-config\",\n  \"stderr\": \"Shell cwd was reset to ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill\",\n  \"interrupted\": false,\n  \"isImage\": false\n}","timestamp":1769669264273,"toolName":"Bash","toolUseId":"toolu_01CpAjp9LdsUzQGFye1hrb3K","toolInput":{"command":"cd ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2 && npx next lint --quiet 2>&1 | tail -10","description":"Run linter","timeout":60000},"toolResult":"{\n  \"stdout\": \"`next lint` is deprecated and will be removed in Next.js 16.\\nFor new projects, use create-next-app to choose your preferred linter.\\nFor existing projects, migrate to the ESLint CLI:\\nnpx @next/codemod@canary next-lint-to-eslint-cli .\\n\\n? How would you like to configure ESLint? https://nextjs.org/docs/app/api-reference/config/eslint\\n\\u001b[?25l❯  Strict (recommended)\\n   Base\\n   Cancel ⚠ If you set up ESLint yourself, we recommend adding the Next.js ESLint plugin. See https://nextjs.org/docs/app/api-reference/config/eslint#migrating-existing-config\",\n  \"stderr\": \"Shell cwd was reset to ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill\",\n  \"interrupted\": false,\n  \"isImage\": false\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Terminal","category":"native"},"isError":false,"turnId":"msg_01NTnmdq15z4wFYp7hd1QBvD"}
{"id":"msg-1769669271095-fqbpaq","type":"tool","content":"{\n  \"stdout\": \"\",\n  \"stderr\": \"Shell cwd was reset to ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill\",\n  \"interrupted\": false,\n  \"isImage\": false\n}","timestamp":1769669271095,"toolName":"Bash","toolUseId":"toolu_014np62L7rSvPCV3f6c87J5M","toolInput":{"command":"cd ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2 && npx tsc --noEmit 2>&1 | head -30","description":"Type-check the project","timeout":120000},"toolResult":"{\n  \"stdout\": \"\",\n  \"stderr\": \"Shell cwd was reset to ./Users/zhongxin/Documents/CosX/Xeni/Prototype/xeni-phase2/sessions/260129-fair-hill\",\n  \"interrupted\": false,\n  \"isImage\": false\n}","toolStatus":"completed","toolDisplayMeta":{"displayName":"Terminal","category":"native"},"isError":false,"turnId":"msg_01VEVBrD3aiPTuTWNr5FQtMQ"}
{"id":"msg-1769669284118-uybnzj","type":"assistant","content":"No type errors. All three changes are complete:\n\n**改动总结：**\n\n1. **`store/case-detail-store.ts`** — 在 `generateEnhancedChecklist()` 中：\n   - 新增 `EVIDENCE_GROUP_MAP` 映射表，将 evidence ID 对应到 document group ID（passport, bank_statement, employment_letter, travel_history, education）\n   - 新增 `autoLinkEvidence()` helper，自动检查 group 是否存在且有文件，若有则设置 `isUploaded: true`\n   - 在 `getRequiredEvidence()` 中对每个 evidence 调用 `.map(autoLinkEvidence)`\n   - 移除了 passport 的特殊硬编码逻辑，统一走映射表\n\n2. **`OverviewTab.tsx` — `SummaryFieldsCard`**（employment section）：\n   - 渲染全部 `referenceEvidence`，不再 `filter(e => e.isUploaded)`\n   - 已上传：实线边框 + FileText 图标 + 文件名\n   - 未上传：虚线边框 + Upload 图标 + evidence 名称（slot）\n\n3. **`OverviewTab.tsx` — `SummarySection`**（非 employment section）：\n   - 同样的逻辑，适配该组件更大的卡片样式","timestamp":1769669284118,"isIntermediate":false,"turnId":"msg_01HxgWEGAShoE8JKvCdRuF78"}
